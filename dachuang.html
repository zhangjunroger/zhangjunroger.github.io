<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯ä¸“ä¸šå¯¼å¸ˆåˆ†é…ç³»ç»Ÿ</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>  
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>  
</head>  
<body class="bg-gray-100 min-h-screen">  
    <!-- ç™»å½•é¡µé¢ -->  
    <div id="loginPage" class="container mx-auto px-4 py-8">  
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8 mt-20">  
            <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯ä¸“ä¸šå¯¼å¸ˆåˆ†é…ç³»ç»Ÿ</h1>  
            <div class="mb-4">  
                <label class="block text-gray-700 mb-2">é€‰æ‹©èº«ä»½</label>  
                <select id="roleSelect" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">  
                    <option value="admin">ç®¡ç†å‘˜</option>  
                    <option value="student">å­¦ç”Ÿ</option>  
                    <option value="teacher">ä¸“ä¸šå¯¼å¸ˆ</option>  
                </select>  
            </div>  
            <div class="mb-4">  
                <label class="block text-gray-700 mb-2">è´¦å·(å­¦å·æˆ–å·¥å·)</label>  
                <input type="text" id="username" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥è´¦å·">  
            </div>  
            <div class="mb-6">  
                <label class="block text-gray-700 mb-2">å¯†ç (åˆå§‹å¯†ç ä¸ºå­¦å·æˆ–å·¥å·)</label>  
                <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥å¯†ç ">  
            </div>  
            <button onclick="login()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">ç™»å½•</button>  
        </div>  
    </div>  

    <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->  
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">  
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">  
            <h2 class="text-xl font-bold mb-4">é¦–æ¬¡ç™»å½•ï¼Œè¯·ä¿®æ”¹å¯†ç </h2>  
            <div class="mb-4">  
                <label class="block text-gray-700 mb-2">æ–°å¯†ç </label>  
                <input type="password" id="newPassword" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">  
            </div>  
            <div class="mb-6">  
                <label class="block text-gray-700 mb-2">ç¡®è®¤æ–°å¯†ç </label>  
                <input type="password" id="confirmPassword" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">  
            </div>  
            <button onclick="changePassword()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">ç¡®è®¤ä¿®æ”¹</button>  
        </div>  
    </div>  

    <!-- ç¼–è¾‘å¯¼å¸ˆä¸»é¡µå¼¹çª— -->  
    <div id="editHomepageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">  
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">  
            <h2 class="text-xl font-bold mb-4">ç¼–è¾‘å¯¼å¸ˆä¸»é¡µ</h2>  
            <div class="mb-4">  
                <label class="block text-gray-700 mb-2">å¯¼å¸ˆå§“å</label>  
                <input type="text" id="editTeacherName" class="w-full px-4 py-2 border rounded-lg bg-gray-100" readonly>  
            </div>  
            <div class="mb-6">  
                <label class="block text-gray-700 mb-2">ä¸»é¡µé“¾æ¥</label>  
                <input type="text" id="editTeacherHomepage" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥å®Œæ•´çš„ç½‘å€ï¼Œå¦‚ï¼šhttps://example.com">  
                <p class="text-sm text-gray-500 mt-1">ç•™ç©ºè¡¨ç¤ºæ— ä¸»é¡µ</p>  
            </div>  
            <div class="flex gap-2">  
                <button onclick="saveTeacherHomepage()" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">ä¿å­˜</button>  
                <button onclick="closeHomepageModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">å–æ¶ˆ</button>  
            </div>  
        </div>  
    </div>  

    <!-- ç®¡ç†å‘˜é¡µé¢ -->  
    <div id="adminPage" class="hidden container mx-auto px-4 py-8">  
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">  
            <div class="flex justify-between items-center mb-4">  
                <h1 class="text-2xl font-bold text-blue-600">ç®¡ç†å‘˜æ§åˆ¶å°</h1>  
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">é€€å‡ºç™»å½•</button>  
            </div>  
        </div>  

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">  
            <button onclick="showSection('studentManage')" class="bg-blue-500 text-white py-4 rounded-lg hover:bg-blue-600 transition text-lg font-semibold">å­¦ç”Ÿä¿¡æ¯ç®¡ç†</button>  
            <button onclick="showSection('teacherManage')" class="bg-green-500 text-white py-4 rounded-lg hover:bg-green-600 transition text-lg font-semibold">å¯¼å¸ˆä¿¡æ¯ç®¡ç†</button>  
            <button onclick="showSection('selectionView')" class="bg-purple-500 text-white py-4 rounded-lg hover:bg-purple-600 transition text-lg font-semibold">å­¦ç”Ÿé€‰é¢˜æŸ¥çœ‹</button>  
            <button onclick="showSection('assignmentManage')" class="bg-orange-500 text-white py-4 rounded-lg hover:bg-orange-600 transition text-lg font-semibold">å¯¼å¸ˆåˆ†é…ç®¡ç†</button>  
        </div>  

        <!-- å­¦ç”Ÿä¿¡æ¯ç®¡ç† -->  
        <div id="studentManage" class="hidden bg-white rounded-lg shadow-lg p-6">  
            <h2 class="text-xl font-bold mb-4">å­¦ç”Ÿä¿¡æ¯ç®¡ç†</h2>  
            <div class="mb-4">  
                <label class="block text-gray-700 mb-2">æ‰¹é‡å½•å…¥å­¦ç”Ÿï¼ˆæ¯è¡Œæ ¼å¼ï¼šå­¦å· å§“å ç­çº§ï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼‰</label>  
                <textarea id="studentBatchInput" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 h-32" placeholder="ä¾‹å¦‚ï¼š&#10;241301100 å¼ ä¸‰ æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2401ç­&#10;241301200 å¼ ä¸‰ æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2402ç­"></textarea>  
            </div>  
            <button onclick="batchAddStudents()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition mb-4">æ‰¹é‡æ·»åŠ </button>  
            <div class="overflow-x-auto">  
                <table class="w-full border-collapse border">  
                    <thead class="bg-gray-200">  
                        <tr>  
                            <th class="border px-4 py-2">å­¦å·</th>  
                            <th class="border px-4 py-2">å§“å</th>  
                            <th class="border px-4 py-2">ç­çº§</th>  
                            <th class="border px-4 py-2">å¹´çº§</th>  
                            <th class="border px-4 py-2">æ“ä½œ</th>  
                        </tr>  
                    </thead>  
                    <tbody id="studentTableBody"></tbody>  
                </table>  
            </div>  
        </div>  

        <!-- å¯¼å¸ˆä¿¡æ¯ç®¡ç† -->  
        <div id="teacherManage" class="hidden bg-white rounded-lg shadow-lg p-6">  
            <h2 class="text-xl font-bold mb-4">å¯¼å¸ˆä¿¡æ¯ç®¡ç†</h2>  
            <div class="mb-4">  
                <label class="block text-gray-700 mb-2">æ‰¹é‡å½•å…¥å¯¼å¸ˆï¼ˆæ¯è¡Œæ ¼å¼ï¼šå·¥å· å§“åï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼‰</label>  
                <textarea id="teacherBatchInput" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 h-32" placeholder="ä¾‹å¦‚ï¼š&#10;12000 å¼ ä¸‰&#10;12001 æå››"></textarea>  
            </div>  
            <button onclick="batchAddTeachers()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition mb-4">æ‰¹é‡æ·»åŠ </button>  
            <div class="overflow-x-auto">  
                <table class="w-full border-collapse border">  
                    <thead class="bg-gray-200">  
                        <tr>  
                            <th class="border px-4 py-2">å·¥å·</th>  
                            <th class="border px-4 py-2">å§“å</th>  
                            <th class="border px-4 py-2">é¢˜ç›®æ•°é‡</th>  
                            <th class="border px-4 py-2">ä¸»é¡µ</th>  
                            <th class="border px-4 py-2">æ“ä½œ</th>  
                        </tr>  
                    </thead>  
                    <tbody id="teacherTableBody"></tbody>  
                </table>  
            </div>  
        </div>  

        <!-- å­¦ç”Ÿé€‰é¢˜æŸ¥çœ‹ -->  
        <div id="selectionView" class="hidden bg-white rounded-lg shadow-lg p-6">  
            <h2 class="text-xl font-bold mb-4">å­¦ç”Ÿé€‰é¢˜ä¿¡æ¯</h2>  
            <div class="overflow-x-auto">  
                <table class="w-full border-collapse border">  
                    <thead class="bg-gray-200">  
                        <tr>  
                            <th class="border px-4 py-2">å­¦å·</th>  
                            <th class="border px-4 py-2">å§“å</th>  
                            <th class="border px-4 py-2">ç¬¬ä¸€å¿—æ„¿</th>  
                            <th class="border px-4 py-2">ç¬¬äºŒå¿—æ„¿</th>  
                            <th class="border px-4 py-2">ç¬¬ä¸‰å¿—æ„¿</th>  
                        </tr>  
                    </thead>  
                    <tbody id="selectionTableBody"></tbody>  
                </table>  
            </div>  
        </div>  

        <!-- å¯¼å¸ˆåˆ†é…ç®¡ç† -->  
        <div id="assignmentManage" class="hidden bg-white rounded-lg shadow-lg p-6">  
            <h2 class="text-xl font-bold mb-4">å¯¼å¸ˆåˆ†é…ç®¡ç†</h2>  
            
            <!-- æœç´¢æ¡ä»¶ -->  
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">  
                <h3 class="font-bold mb-3">æœç´¢æ¡ä»¶</h3>  
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">  
                    <div>  
                        <label class="block text-gray-700 mb-2 text-sm">å­¦å·</label>  
                        <input type="text" id="searchStudentId" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¾“å…¥å­¦å·">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-2 text-sm">å§“å</label>  
                        <input type="text" id="searchStudentName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¾“å…¥å§“å">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-2 text-sm">å¹´çº§</label>  
                        <select id="searchGrade" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">  
                            <option value="">å…¨éƒ¨å¹´çº§</option>  
                            <option value="24">2024çº§</option>  
                            <option value="25">2025çº§</option>  
                            <option value="26">2026çº§</option>  
                            <option value="27">2027çº§</option>  
                            <option value="28">2028çº§</option>  
                        </select>  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-2 text-sm">åˆ†é…çŠ¶æ€</label>  
                        <select id="searchAssignStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">  
                            <option value="">å…¨éƒ¨</option>  
                            <option value="assigned">å·²åˆ†é…</option>  
                            <option value="unassigned">æœªåˆ†é…</option>  
                            <option value="fromChoice">ä»å¿—æ„¿åˆ†é…</option>  
                            <option value="notFromChoice">éå¿—æ„¿åˆ†é…</option>  
                        </select>  
                    </div>  
                </div>  
                <div class="mt-4 flex gap-2">  
                    <button onclick="searchStudents()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">æœç´¢</button>  
                    <button onclick="resetSearch()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition">é‡ç½®</button>  
                </div>  
            </div>  

            <div class="mb-4 flex gap-4">  
                <button onclick="autoAssignment()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">ä¸€é”®åˆ†é…å¯¼å¸ˆ</button>  
                <button onclick="saveAssignment()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition">ä¿å­˜åˆ†é…æ–¹æ¡ˆ</button>  
                <button onclick="exportToExcel()" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition">å¯¼å‡ºExcel</button>  
            </div>  
            
            <!-- åˆ†é…ç»Ÿè®¡ -->  
            <div id="assignmentStats" class="mb-4 p-4 bg-blue-50 rounded-lg hidden">  
                <h3 class="font-bold mb-2">åˆ†é…ç»Ÿè®¡</h3>  
                <p id="statsText"></p>  
            </div>  

            <!-- æœªåˆ†é…å­¦ç”Ÿåˆ—è¡¨ -->  
            <div id="unassignedList" class="mb-4 p-4 bg-red-50 rounded-lg hidden">  
                <h3 class="font-bold mb-2 text-red-600">æœªèƒ½ä»ä¸‰å¿—æ„¿ä¸­åˆ†é…çš„å­¦ç”Ÿ</h3>  
                <div id="unassignedStudents"></div>  
            </div>  

            <div class="overflow-x-auto">  
                <table class="w-full border-collapse border">  
                    <thead class="bg-gray-200">  
                        <tr>  
                            <th class="border px-4 py-2">å­¦å·</th>  
                            <th class="border px-4 py-2">å§“å</th>  
                            <th class="border px-4 py-2">ç­çº§</th>  
                            <th class="border px-4 py-2">åˆ†é…é¢˜ç›®</th>  
                            <th class="border px-4 py-2">åˆ†é…å¯¼å¸ˆ</th>  
                            <th class="border px-4 py-2">æ˜¯å¦å¿—æ„¿</th>  
                        </tr>  
                    </thead>  
                    <tbody id="assignmentTableBody"></tbody>  
                </table>  
            </div>  
        </div>  
    </div>  

    <!-- å­¦ç”Ÿé¡µé¢ -->  
    <div id="studentPage" class="hidden container mx-auto px-4 py-8">  
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">  
            <div class="flex justify-between items-center mb-4">  
                <div>  
                    <h1 class="text-2xl font-bold text-blue-600">å­¦ç”Ÿé€‰é¢˜ç³»ç»Ÿï¼ˆç‚¹å‡»æ•™å¸ˆå§“åé“¾æ¥ï¼Œå¯ç›´è¾¾æ•™å¸ˆä¸»é¡µï¼ï¼‰</h1>  
                    <p class="text-gray-600" id="studentInfo"></p>  
                </div>  
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">é€€å‡ºç™»å½•</button>  
            </div>  
        </div>  

        <!-- åˆ†é…ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->  
        <div id="assignmentResultSection" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6 border-2 border-green-500">  
            <h2 class="text-xl font-bold mb-4 text-green-600">âœ“ å¯¼å¸ˆåˆ†é…ç»“æœï¼ˆç‚¹å‡»æ•™å¸ˆå§“åé“¾æ¥ï¼Œå¯ç›´è¾¾æ•™å¸ˆä¸»é¡µï¼ï¼‰</h2>  
            <div class="bg-green-50 p-6 rounded-lg">  
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">  
                    <div>  
                        <p class="text-sm text-gray-600 mb-1">åˆ†é…é¢˜ç›®</p>  
                        <p class="text-lg font-bold text-gray-800" id="assignedTopicTitle">-</p>  
                    </div>  
                    <div>  
                        <p class="text-sm text-gray-600 mb-1">æŒ‡å¯¼æ•™å¸ˆ</p>  
                        <p class="text-lg font-bold text-gray-800" id="assignedTeacherNameLink">-</p>  
                    </div>  
                    <div class="md:col-span-2">  
                        <p class="text-sm text-gray-600 mb-1">åˆ†é…è¯´æ˜</p>  
                        <p class="text-base text-gray-700" id="assignmentNote">-</p>  
                    </div>  
                </div>  
            </div>  
            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">  
                <p class="text-sm text-yellow-700">ğŸ“Œ å¯¼å¸ˆå·²åˆ†é…ï¼Œå¿—æ„¿å¡«æŠ¥åŠŸèƒ½å·²é”å®šã€‚å¦‚æœ‰ç–‘é—®è¯·è”ç³»ç®¡ç†å‘˜ã€‚</p>  
            </div>  
        </div>  

        <div id="topicListSection" class="bg-white rounded-lg shadow-lg p-6 mb-6">  
            <h2 class="text-xl font-bold mb-4">å¯é€‰é¢˜ç›®åˆ—è¡¨</h2>  
            <div id="topicList" class="space-y-4"></div>  
        </div>  

        <div class="bg-white rounded-lg shadow-lg p-6">  
            <h2 class="text-xl font-bold mb-4">æˆ‘çš„å¿—æ„¿</h2>  
            <div id="submittedNotice" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">  
                <p class="text-green-700 font-semibold">âœ“ æ‚¨å·²æˆåŠŸæäº¤å¿—æ„¿ï¼Œå¿—æ„¿ä¸å¯ä¿®æ”¹</p>  
            </div>  
            <div id="assignedNotice" class="hidden mb-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">  
                <p class="text-orange-700 font-semibold">âš ï¸ å¯¼å¸ˆå·²åˆ†é…ï¼Œæ— æ³•å†æäº¤å¿—æ„¿</p>  
            </div>  
            <div class="space-y-2">  
                <div class="flex items-center justify-between">  
                    <div class="flex items-center flex-1">  
                        <span class="font-semibold mr-4 w-24">ç¬¬ä¸€å¿—æ„¿ï¼š</span>  
                        <span id="choice1" class="text-gray-600">æœªé€‰æ‹©</span>  
                    </div>  
                    <button id="removeBtn1" onclick="removeChoice(0)" class="hidden ml-4 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">åˆ é™¤</button>  
                </div>  
                <div class="flex items-center justify-between">  
                    <div class="flex items-center flex-1">  
                        <span class="font-semibold mr-4 w-24">ç¬¬äºŒå¿—æ„¿ï¼š</span>  
                        <span id="choice2" class="text-gray-600">æœªé€‰æ‹©</span>  
                    </div>  
                    <button id="removeBtn2" onclick="removeChoice(1)" class="hidden ml-4 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">åˆ é™¤</button>  
                </div>  
                <div class="flex items-center justify-between">  
                    <div class="flex items-center flex-1">  
                        <span class="font-semibold mr-4 w-24">ç¬¬ä¸‰å¿—æ„¿ï¼š</span>  
                        <span id="choice3" class="text-gray-600">æœªé€‰æ‹©</span>  
                    </div>  
                    <button id="removeBtn3" onclick="removeChoice(2)" class="hidden ml-4 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">åˆ é™¤</button>  
                </div>  
            </div>  
            <button id="submitBtn" onclick="submitSelection()" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">æäº¤å¿—æ„¿</button>  
        </div>  
    </div>  

    <!-- æ•™å¸ˆé¡µé¢ -->  
    <div id="teacherPage" class="hidden container mx-auto px-4 py-8">  
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">  
            <div class="flex justify-between items-center mb-4">  
                <div>  
                    <h1 class="text-2xl font-bold text-blue-600">å¯¼å¸ˆé¢˜ç›®ç®¡ç†</h1>  
                    <p class="text-gray-600" id="teacherInfo"></p>  
                </div>  
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">é€€å‡ºç™»å½•</button>  
            </div>  
        </div>  

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">  
            <h2 class="text-xl font-bold mb-4">æ·»åŠ æ–°é¢˜ç›®ï¼ˆæœ€å¤š5ä¸ªï¼‰</h2>  
            <div class="mb-4">  
                <label class="block text-gray-700 mb-2">é¢˜ç›®åç§°</label>  
                <input type="text" id="topicTitle" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥é¢˜ç›®åç§°">  
            </div>  
            <div class="mb-4">  
                <label class="block text-gray-700 mb-2">é¢˜ç›®æè¿°</label>  
                <textarea id="topicDescription" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 h-32" placeholder="è¯·è¾“å…¥é¢˜ç›®æè¿°"></textarea>  
            </div>  
            <div class="mb-4">  
                <label class="block text-gray-700 mb-2">é€‚ç”¨å¹´çº§</label>  
                <select id="topicGrade" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">  
                    <option value="24">2024çº§</option>  
                    <option value="25">2025çº§</option>  
                    <option value="26">2026çº§</option>  
                    <option value="27">2027çº§</option>  
                    <option value="28">2028çº§</option>  
                </select>  
            </div>  
            <button onclick="addTopic()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition">æ·»åŠ é¢˜ç›®</button>  
        </div>  

        <div class="bg-white rounded-lg shadow-lg p-6">  
            <h2 class="text-xl font-bold mb-4">æˆ‘çš„é¢˜ç›®åˆ—è¡¨</h2>  
            <div id="myTopicList" class="space-y-4"></div>  
        </div>  
    </div>  

    <script>  
        // LeanCloudåˆå§‹åŒ–  
        AV.init({  
            appId: "i5dgesLUGwTIlWX5VCA8eqF3-gzGzoHsz",  
            appKey: "X2ZTE6mo0VlPr6ZQQ0DSj4aM",  
            serverURL: "https://i5dgeslu.lc-cn-n1-shared.com"  
        });  

        let currentUser = null;  
        let selectedTopics = [];  
        let currentAssignments = []; // å½“å‰åˆ†é…æ–¹æ¡ˆ  
        let filteredAssignments = []; // è¿‡æ»¤åçš„åˆ†é…æ–¹æ¡ˆï¼ˆç”¨äºæ˜¾ç¤ºå’Œæ“ä½œï¼‰  
        let hasSubmitted = false; // æ˜¯å¦å·²æäº¤å¿—æ„¿  
        let hasAssigned = false; // æ˜¯å¦å·²è¢«åˆ†é…å¯¼å¸ˆ  
        let editingTeacherId = null; // æ­£åœ¨ç¼–è¾‘çš„æ•™å¸ˆID  
        let teacherHomepageMap = {}; // å¯¼å¸ˆä¸»é¡µæ˜ å°„è¡¨  

        // ç™»å½•  
        async function login() {  
            const username = document.getElementById('username').value.trim();  
            const password = document.getElementById('password').value.trim();  
            const role = document.getElementById('roleSelect').value;  

            if (!username || !password) {  
                alert('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ');  
                return;  
            }  

            try {  
                const query = new AV.Query('SystemUser');  
                query.equalTo('username', username);  
                query.equalTo('role', role);  
                const user = await query.first();  

                if (!user) {  
                    alert('è´¦å·ä¸å­˜åœ¨æˆ–èº«ä»½é€‰æ‹©é”™è¯¯');  
                    return;  
                }  

                if (user.get('password') !== password) {  
                    alert('å¯†ç é”™è¯¯');  
                    return;  
                }  

                currentUser = user;  

                // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®æ”¹å¯†ç   
                if (user.get('needPasswordChange')) {  
                    document.getElementById('changePasswordModal').classList.remove('hidden');  
                    return;  
                }  

                enterSystem(role);  
            } catch (error) {  
                alert('ç™»å½•å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // è¿›å…¥ç³»ç»Ÿ  
        function enterSystem(role) {  
            document.getElementById('loginPage').classList.add('hidden');  
            if (role === 'admin') {  
                document.getElementById('adminPage').classList.remove('hidden');  
                loadAdminData();  
            } else if (role === 'student') {  
                document.getElementById('studentPage').classList.remove('hidden');  
                loadStudentData();  
            } else if (role === 'teacher') {  
                document.getElementById('teacherPage').classList.remove('hidden');  
                loadTeacherData();  
            }  
        }  

        // ä¿®æ”¹å¯†ç   
        async function changePassword() {  
            const newPassword = document.getElementById('newPassword').value.trim();  
            const confirmPassword = document.getElementById('confirmPassword').value.trim();  

            if (!newPassword || !confirmPassword) {  
                alert('è¯·è¾“å…¥æ–°å¯†ç ');  
                return;  
            }  

            if (newPassword !== confirmPassword) {  
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');  
                return;  
            }  

            if (newPassword.length < 6) {  
                alert('å¯†ç é•¿åº¦è‡³å°‘6ä½');  
                return;  
            }  

            try {  
                currentUser.set('password', newPassword);  
                currentUser.set('needPasswordChange', false);  
                await currentUser.save();  
                
                document.getElementById('changePasswordModal').classList.add('hidden');  
                document.getElementById('newPassword').value = '';  
                document.getElementById('confirmPassword').value = '';  
                
                alert('å¯†ç ä¿®æ”¹æˆåŠŸ');  
                enterSystem(currentUser.get('role'));  
            } catch (error) {  
                alert('å¯†ç ä¿®æ”¹å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // é€€å‡ºç™»å½•  
        function logout() {  
            currentUser = null;  
            selectedTopics = [];  
            currentAssignments = [];  
            filteredAssignments = [];  
            hasSubmitted = false;  
            hasAssigned = false;  
            teacherHomepageMap = {};  
            document.getElementById('adminPage').classList.add('hidden');  
            document.getElementById('studentPage').classList.add('hidden');  
            document.getElementById('teacherPage').classList.add('hidden');  
            document.getElementById('loginPage').classList.remove('hidden');  
            document.getElementById('username').value = '';  
            document.getElementById('password').value = '';  
        }  

        // æ˜¾ç¤ºç®¡ç†å‘˜é¡µé¢çš„ä¸åŒéƒ¨åˆ†  
        function showSection(section) {  
            document.getElementById('studentManage').classList.add('hidden');  
            document.getElementById('teacherManage').classList.add('hidden');  
            document.getElementById('selectionView').classList.add('hidden');  
            document.getElementById('assignmentManage').classList.add('hidden');  
            document.getElementById(section).classList.remove('hidden');  

            if (section === 'studentManage') {  
                loadStudentList();  
            } else if (section === 'teacherManage') {  
                loadTeacherList();  
            } else if (section === 'selectionView') {  
                loadSelectionList();  
            } else if (section === 'assignmentManage') {  
                loadAssignmentView();  
            }  
        }  

        // æ‰¹é‡æ·»åŠ å­¦ç”Ÿ  
        async function batchAddStudents() {  
            const input = document.getElementById('studentBatchInput').value.trim();  
            if (!input) {  
                alert('è¯·è¾“å…¥å­¦ç”Ÿä¿¡æ¯');  
                return;  
            }  

            const lines = input.split('\n');  
            let successCount = 0;  

            for (let line of lines) {  
                const parts = line.trim().split(/\s+/);  
                if (parts.length !== 3) continue;  

                const [studentId, name, className] = parts;  
                const grade = studentId.substring(0, 2);  

                try {  
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨  
                    const checkQuery = new AV.Query('SystemUser');  
                    checkQuery.equalTo('username', studentId);  
                    const existing = await checkQuery.first();  
                    
                    if (existing) continue;  

                    const student = new AV.Object('SystemUser');  
                    student.set('username', studentId);  
                    student.set('password', studentId);  
                    student.set('role', 'student');  
                    student.set('name', name);  
                    student.set('class', className);  
                    student.set('grade', grade);  
                    student.set('needPasswordChange', true);  
                    await student.save();  
                    successCount++;  
                } catch (error) {  
                    console.error('æ·»åŠ å­¦ç”Ÿå¤±è´¥ï¼š', error);  
                }  
            }  

            alert(`æˆåŠŸæ·»åŠ  ${successCount} åå­¦ç”Ÿ`);  
            document.getElementById('studentBatchInput').value = '';  
            loadStudentList();  
        }  

        // åŠ è½½å­¦ç”Ÿåˆ—è¡¨  
        async function loadStudentList() {  
            try {  
                const query = new AV.Query('SystemUser');  
                query.equalTo('role', 'student');  
                query.limit(1000);  
                const students = await query.find();  

                const tbody = document.getElementById('studentTableBody');  
                tbody.innerHTML = '';  

                for (let student of students) {  
                    const tr = document.createElement('tr');  
                    tr.innerHTML = `  
                        <td class="border px-4 py-2">${student.get('username')}</td>  
                        <td class="border px-4 py-2">${student.get('name')}</td>  
                        <td class="border px-4 py-2">${student.get('class')}</td>  
                        <td class="border px-4 py-2">${student.get('grade')}</td>  
                        <td class="border px-4 py-2">  
                            <button onclick="deleteUser('${student.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">åˆ é™¤</button>  
                        </td>  
                    `;  
                    tbody.appendChild(tr);  
                }  
            } catch (error) {  
                alert('åŠ è½½å­¦ç”Ÿåˆ—è¡¨å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // æ‰¹é‡æ·»åŠ æ•™å¸ˆ  
        async function batchAddTeachers() {  
            const input = document.getElementById('teacherBatchInput').value.trim();  
            if (!input) {  
                alert('è¯·è¾“å…¥æ•™å¸ˆä¿¡æ¯');  
                return;  
            }  

            const lines = input.split('\n');  
            let successCount = 0;  

            for (let line of lines) {  
                const parts = line.trim().split(/\s+/);  
                if (parts.length !== 2) continue;  

                const [teacherId, name] = parts;  

                try {  
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨  
                    const checkQuery = new AV.Query('SystemUser');  
                    checkQuery.equalTo('username', teacherId);  
                    const existing = await checkQuery.first();  
                    
                    if (existing) continue;  

                    const teacher = new AV.Object('SystemUser');  
                    teacher.set('username', teacherId);  
                    teacher.set('password', teacherId);  
                    teacher.set('role', 'teacher');  
                    teacher.set('name', name);  
                    teacher.set('homepage', ''); // åˆå§‹åŒ–ä¸»é¡µå­—æ®µä¸ºç©º  
                    teacher.set('needPasswordChange', true);  
                    await teacher.save();  
                    successCount++;  
                } catch (error) {  
                    console.error('æ·»åŠ æ•™å¸ˆå¤±è´¥ï¼š', error);  
                }  
            }  

            alert(`æˆåŠŸæ·»åŠ  ${successCount} åæ•™å¸ˆ`);  
            document.getElementById('teacherBatchInput').value = '';  
            loadTeacherList();  
        }  

        // åŠ è½½æ•™å¸ˆåˆ—è¡¨  
        async function loadTeacherList() {  
            try {  
                const query = new AV.Query('SystemUser');  
                query.equalTo('role', 'teacher');  
                query.limit(1000);  
                const teachers = await query.find();  

                // æ„å»ºä¸»é¡µæ˜ å°„è¡¨  
                teacherHomepageMap = {};  
                for (let teacher of teachers) {  
                    teacherHomepageMap[teacher.get('username')] = teacher.get('homepage') || '';  
                }  

                const tbody = document.getElementById('teacherTableBody');  
                tbody.innerHTML = '';  

                for (let teacher of teachers) {  
                    // ç»Ÿè®¡é¢˜ç›®æ•°é‡  
                    const topicQuery = new AV.Query('Topic');  
                    topicQuery.equalTo('teacherId', teacher.get('username'));  
                    const topicCount = await topicQuery.count();  

                    const homepage = teacher.get('homepage') || '';  
                    const homepageDisplay = homepage ? `<a href="${homepage}" target="_blank" class="text-blue-600 hover:underline text-sm">ğŸ”— ${homepage.substring(0, 30)}${homepage.length > 30 ? '...' : ''}</a>` : '<span class="text-gray-400 text-sm">æœªè®¾ç½®</span>';  

                    const tr = document.createElement('tr');  
                    tr.innerHTML = `  
                        <td class="border px-4 py-2">${teacher.get('username')}</td>  
                        <td class="border px-4 py-2">${teacher.get('name')}</td>  
                        <td class="border px-4 py-2">${topicCount}</td>  
                        <td class="border px-4 py-2">${homepageDisplay}</td>  
                        <td class="border px-4 py-2">  
                            <button onclick="openEditHomepage('${teacher.id}', '${teacher.get('name')}', '${homepage}')" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm mr-2">ç¼–è¾‘ä¸»é¡µ</button>  
                            <button onclick="deleteUser('${teacher.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">åˆ é™¤</button>  
                        </td>  
                    `;  
                    tbody.appendChild(tr);  
                }  
            } catch (error) {  
                alert('åŠ è½½æ•™å¸ˆåˆ—è¡¨å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // æ‰“å¼€ç¼–è¾‘ä¸»é¡µå¼¹çª—  
        function openEditHomepage(teacherId, teacherName, homepage) {  
            editingTeacherId = teacherId;  
            document.getElementById('editTeacherName').value = teacherName;  
            document.getElementById('editTeacherHomepage').value = homepage || '';  
            document.getElementById('editHomepageModal').classList.remove('hidden');  
        }  

        // å…³é—­ç¼–è¾‘ä¸»é¡µå¼¹çª—  
        function closeHomepageModal() {  
            editingTeacherId = null;  
            document.getElementById('editTeacherName').value = '';  
            document.getElementById('editTeacherHomepage').value = '';  
            document.getElementById('editHomepageModal').classList.add('hidden');  
        }  

        // ä¿å­˜æ•™å¸ˆä¸»é¡µ  
        async function saveTeacherHomepage() {  
            if (!editingTeacherId) return;  

            const homepage = document.getElementById('editTeacherHomepage').value.trim();  

            // éªŒè¯URLæ ¼å¼ï¼ˆå¦‚æœä¸ä¸ºç©ºï¼‰  
            if (homepage && !homepage.match(/^https?:\/\/.+/)) {  
                alert('è¯·è¾“å…¥å®Œæ•´çš„ç½‘å€ï¼Œæ ¼å¼å¦‚ï¼šhttps://example.com');  
                return;  
            }  

            try {  
                const teacher = AV.Object.createWithoutData('SystemUser', editingTeacherId);  
                teacher.set('homepage', homepage);  
                await teacher.save();  

                alert('ä¿å­˜æˆåŠŸ');  
                closeHomepageModal();  
                loadTeacherList();  
            } catch (error) {  
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // åˆ é™¤ç”¨æˆ·  
        async function deleteUser(userId) {  
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;  

            try {  
                const user = AV.Object.createWithoutData('SystemUser', userId);  
                await user.destroy();  
                alert('åˆ é™¤æˆåŠŸ');  
                loadStudentList();  
                loadTeacherList();  
            } catch (error) {  
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // åŠ è½½é€‰é¢˜åˆ—è¡¨  
        async function loadSelectionList() {  
            try {  
                const query = new AV.Query('Selection');  
                query.limit(1000);  
                const selections = await query.find();  

                const tbody = document.getElementById('selectionTableBody');  
                tbody.innerHTML = '';  

                for (let selection of selections) {  
                    const topic1 = await getTopic(selection.get('topic1Id'));  
                    const topic2 = await getTopic(selection.get('topic2Id'));  
                    const topic3 = await getTopic(selection.get('topic3Id'));  

                    const tr = document.createElement('tr');  
                    tr.innerHTML = `  
                        <td class="border px-4 py-2">${selection.get('studentId')}</td>  
                        <td class="border px-4 py-2">${selection.get('studentName')}</td>  
                        <td class="border px-4 py-2">${topic1 ? topic1.get('title') + '<br><span class="text-sm text-gray-500">ï¼ˆ' + topic1.get('teacherName') + 'ï¼‰</span>' : 'æœªé€‰æ‹©'}</td>  
                        <td class="border px-4 py-2">${topic2 ? topic2.get('title') + '<br><span class="text-sm text-gray-500">ï¼ˆ' + topic2.get('teacherName') + 'ï¼‰</span>' : 'æœªé€‰æ‹©'}</td>  
                        <td class="border px-4 py-2">${topic3 ? topic3.get('title') + '<br><span class="text-sm text-gray-500">ï¼ˆ' + topic3.get('teacherName') + 'ï¼‰</span>' : 'æœªé€‰æ‹©'}</td>  
                    `;  
                    tbody.appendChild(tr);  
                }  

                if (selections.length === 0) {  
                    tbody.innerHTML = '<tr><td colspan="5" class="border px-4 py-2 text-center text-gray-500">æš‚æ— é€‰é¢˜ä¿¡æ¯</td></tr>';  
                }  
            } catch (error) {  
                alert('åŠ è½½é€‰é¢˜åˆ—è¡¨å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // è·å–é¢˜ç›®  
        async function getTopic(topicId) {  
            if (!topicId) return null;  
            try {  
                const query = new AV.Query('Topic');  
                return await query.get(topicId);  
            } catch (error) {  
                return null;  
            }  
        }  

        // åŠ è½½ç®¡ç†å‘˜æ•°æ®  
        async function loadAdminData() {  
            // åŠ è½½æ•™å¸ˆä¸»é¡µæ˜ å°„è¡¨  
            await loadTeacherHomepageMap();  
            // é»˜è®¤æ˜¾ç¤ºå­¦ç”Ÿç®¡ç†  
            showSection('studentManage');  
        }  

        // åŠ è½½æ•™å¸ˆä¸»é¡µæ˜ å°„è¡¨  
        async function loadTeacherHomepageMap() {  
            try {  
                const query = new AV.Query('SystemUser');  
                query.equalTo('role', 'teacher');  
                query.limit(1000);  
                const teachers = await query.find();  

                teacherHomepageMap = {};  
                for (let teacher of teachers) {  
                    teacherHomepageMap[teacher.get('username')] = teacher.get('homepage') || '';  
                }  
            } catch (error) {  
                console.error('åŠ è½½æ•™å¸ˆä¸»é¡µæ˜ å°„å¤±è´¥ï¼š', error);  
            }  
        }  

        // åˆ›å»ºæ•™å¸ˆåå­—é“¾æ¥  
        function createTeacherLink(teacherName, teacherId) {  
            const homepage = teacherHomepageMap[teacherId] || '';  
            if (homepage) {  
                return `<a href="${homepage}" target="_blank" class="text-blue-600 hover:underline cursor-pointer" title="ç‚¹å‡»è®¿é—®${teacherName}çš„ä¸»é¡µ">${teacherName}</a>`;  
            } else {  
                return teacherName;  
            }  
        }  

        // åŠ è½½å­¦ç”Ÿæ•°æ®  
        async function loadStudentData() {  
            document.getElementById('studentInfo').textContent = `æ¬¢è¿ï¼Œ${currentUser.get('name')}ï¼ˆ${currentUser.get('username')}ï¼‰`;  
            
            // åŠ è½½æ•™å¸ˆä¸»é¡µæ˜ å°„è¡¨  
            await loadTeacherHomepageMap();  
            
            // å…ˆæ£€æŸ¥æ˜¯å¦å·²è¢«åˆ†é…å¯¼å¸ˆ  
            await checkAssignmentStatus();  
            
            // å¦‚æœå·²åˆ†é…ï¼Œä¸å†æ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨å’Œå¿—æ„¿é€‰æ‹©  
            if (hasAssigned) {  
                return;  
            }  
            
            // æ£€æŸ¥æ˜¯å¦å·²æäº¤å¿—æ„¿  
            await checkSubmissionStatus();  
            
            // åŠ è½½æ‰€æœ‰é¢˜ç›®  
            await loadAllTopics();  
            
            // åŠ è½½å·²é€‰æ‹©çš„é¢˜ç›®  
            await loadMySelection();  
        }  

        // æ£€æŸ¥åˆ†é…çŠ¶æ€  
        async function checkAssignmentStatus() {  
            try {  
                const query = new AV.Query('Assignment');  
                query.equalTo('studentId', currentUser.get('username'));  
                const assignment = await query.first();  

                if (assignment && assignment.get('assignedTopicId')) {  
                    hasAssigned = true;  
                    // æ˜¾ç¤ºåˆ†é…ç»“æœ  
                    displayAssignmentResult(assignment);  
                    // é”å®šå¿—æ„¿åŠŸèƒ½  
                    lockSelectionForAssignment();  
                }  
            } catch (error) {  
                console.error('æ£€æŸ¥åˆ†é…çŠ¶æ€å¤±è´¥ï¼š', error);  
            }  
        }  

        // æ˜¾ç¤ºåˆ†é…ç»“æœ  
        function displayAssignmentResult(assignment) {  
            document.getElementById('assignmentResultSection').classList.remove('hidden');  
            document.getElementById('assignedTopicTitle').textContent = assignment.get('assignedTopicTitle');  
            
            // è·å–å¯¼å¸ˆä¿¡æ¯å’Œä¸»é¡µ  
            const teacherName = assignment.get('assignedTeacherName');  
            const teacherId = assignment.get('assignedTeacherId') || '';  
            const homepage = teacherHomepageMap[teacherId] || '';  
            
            const teacherLinkElement = document.getElementById('assignedTeacherNameLink');  
            if (homepage) {  
                teacherLinkElement.innerHTML = `<a href="${homepage}" target="_blank" class="text-blue-600 hover:underline cursor-pointer" title="ç‚¹å‡»è®¿é—®${teacherName}çš„ä¸»é¡µ">${teacherName}</a>`;  
            } else {  
                teacherLinkElement.textContent = teacherName;  
            }  
            
            const isFromChoice = assignment.get('isFromChoice');  
            let note = '';  
            if (isFromChoice) {  
                note = 'âœ“ æ­å–œï¼ç³»ç»Ÿå·²ä»æ‚¨çš„ä¸‰ä¸ªå¿—æ„¿ä¸­ä¸ºæ‚¨åˆ†é…å¯¼å¸ˆå’Œé¢˜ç›®ã€‚';  
            } else {  
                note = 'âš ï¸ æ‚¨å¡«æŠ¥çš„ä¸‰ä¸ªå¿—æ„¿é¢˜ç›®å‡å·²è¢«å…¶ä»–åŒå­¦é€‰èµ°ï¼Œç³»ç»Ÿæœªèƒ½ä»å¿—æ„¿ä¸­ä¸ºæ‚¨åˆ†é…ã€‚è¯·è”ç³»ç®¡ç†å‘˜æˆ–å¯¼å¸ˆè¿›è¡Œè°ƒæ•´ã€‚';  
            }  
            document.getElementById('assignmentNote').textContent = note;  
        }  

        // å› å·²åˆ†é…è€Œé”å®šé€‰æ‹©åŠŸèƒ½  
        function lockSelectionForAssignment() {  
            // éšè—é¢˜ç›®åˆ—è¡¨  
            document.getElementById('topicListSection').classList.add('hidden');  
            
            // æ˜¾ç¤ºå·²åˆ†é…æç¤º  
            document.getElementById('assignedNotice').classList.remove('hidden');  
            
            // ç¦ç”¨æäº¤æŒ‰é’®  
            const submitBtn = document.getElementById('submitBtn');  
            submitBtn.disabled = true;  
            submitBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');  
            submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');  
            submitBtn.textContent = 'å¯¼å¸ˆå·²åˆ†é…';  
            
            // éšè—åˆ é™¤æŒ‰é’®  
            for (let i = 1; i <= 3; i++) {  
                document.getElementById(`removeBtn${i}`).classList.add('hidden');  
            }  
        }  

        // æ£€æŸ¥æäº¤çŠ¶æ€  
        async function checkSubmissionStatus() {  
            try {  
                const query = new AV.Query('Selection');  
                query.equalTo('studentId', currentUser.get('username'));  
                const selection = await query.first();  

                if (selection && selection.get('submitted')) {  
                    hasSubmitted = true;  
                    lockSelection();  
                }  
            } catch (error) {  
                console.error('æ£€æŸ¥æäº¤çŠ¶æ€å¤±è´¥ï¼š', error);  
            }  
        }  

        // é”å®šé€‰æ‹©åŠŸèƒ½  
        function lockSelection() {  
            // æ˜¾ç¤ºå·²æäº¤æç¤º  
            document.getElementById('submittedNotice').classList.remove('hidden');  
            
            // ç¦ç”¨æäº¤æŒ‰é’®  
            const submitBtn = document.getElementById('submitBtn');  
            submitBtn.disabled = true;  
            submitBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');  
            submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');  
            submitBtn.textContent = 'å·²æäº¤å¿—æ„¿';  
            
            // éšè—åˆ é™¤æŒ‰é’®  
            for (let i = 1; i <= 3; i++) {  
                document.getElementById(`removeBtn${i}`).classList.add('hidden');  
            }  
            
            // éšè—é¢˜ç›®åˆ—è¡¨çš„é€‰æ‹©æŒ‰é’®  
            document.getElementById('topicListSection').classList.add('hidden');  
        }  

        // åŠ è½½æ‰€æœ‰é¢˜ç›®  
        async function loadAllTopics() {  
            try {  
                const query = new AV.Query('Topic');  
                // åªæ˜¾ç¤ºå­¦ç”Ÿæ‰€åœ¨å¹´çº§çš„é¢˜ç›®  
                query.equalTo('grade', currentUser.get('grade'));  
                query.limit(1000);  
                const topics = await query.find();  

                const topicList = document.getElementById('topicList');  
                topicList.innerHTML = '';  

                if (topics.length === 0) {  
                    topicList.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— å¯é€‰é¢˜ç›®</p>';  
                    return;  
                }  

                for (let topic of topics) {  
                    const teacherName = topic.get('teacherName');  
                    const teacherId = topic.get('teacherId');  
                    const teacherDisplay = createTeacherLink(teacherName, teacherId);  

                    const div = document.createElement('div');  
                    div.className = 'border rounded-lg p-4 hover:border-blue-500 transition';  
                    div.innerHTML = `  
                        <div class="flex justify-between items-start mb-2">  
                            <h3 class="font-bold text-lg">${topic.get('title')}</h3>  
                            <button onclick="selectTopic('${topic.id}', '${topic.get('title')}', '${teacherName}', '${teacherId}')" class="topic-select-btn bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 text-sm">é€‰æ‹©</button>  
                        </div>  
                        <p class="text-gray-600 mb-2">${topic.get('description') || 'æ— æè¿°'}</p>  
                        <p class="text-sm text-gray-500">æŒ‡å¯¼æ•™å¸ˆï¼š${teacherDisplay} | é€‚ç”¨å¹´çº§ï¼š20${topic.get('grade')}çº§</p>  
                    `;  
                    topicList.appendChild(div);  
                }  
            } catch (error) {  
                alert('åŠ è½½é¢˜ç›®å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // é€‰æ‹©é¢˜ç›®  
        function selectTopic(topicId, title, teacherName, teacherId) {  
            if (hasAssigned) {  
                alert('å¯¼å¸ˆå·²åˆ†é…ï¼Œæ— æ³•ä¿®æ”¹å¿—æ„¿');  
                return;  
            }  

            if (hasSubmitted) {  
                alert('æ‚¨å·²æäº¤å¿—æ„¿ï¼Œæ— æ³•ä¿®æ”¹');  
                return;  
            }  

            if (selectedTopics.length >= 3) {  
                alert('æœ€å¤šåªèƒ½é€‰æ‹©3ä¸ªé¢˜ç›®');  
                return;  
            }  

            if (selectedTopics.some(t => t.id === topicId)) {  
                alert('è¯¥é¢˜ç›®å·²é€‰æ‹©');  
                return;  
            }  

            selectedTopics.push({ id: topicId, title: title, teacherName: teacherName, teacherId: teacherId });  
            updateSelectionDisplay();  
        }  

        // åˆ é™¤é€‰æ‹©  
        function removeChoice(index) {  
            if (hasAssigned) {  
                alert('å¯¼å¸ˆå·²åˆ†é…ï¼Œæ— æ³•ä¿®æ”¹å¿—æ„¿');  
                return;  
            }  

            if (hasSubmitted) {  
                alert('æ‚¨å·²æäº¤å¿—æ„¿ï¼Œæ— æ³•ä¿®æ”¹');  
                return;  
            }  

            if (selectedTopics[index]) {  
                selectedTopics.splice(index, 1);  
                updateSelectionDisplay();  
            }  
        }  

        // æ›´æ–°é€‰æ‹©æ˜¾ç¤º  
        function updateSelectionDisplay() {  
            for (let i = 1; i <= 3; i++) {  
                const elem = document.getElementById(`choice${i}`);  
                const removeBtn = document.getElementById(`removeBtn${i}`);  
                
                if (selectedTopics[i - 1]) {  
                    const topic = selectedTopics[i - 1];  
                    const teacherDisplay = createTeacherLink(topic.teacherName, topic.teacherId);  
                    elem.innerHTML = `${topic.title}ï¼ˆ${teacherDisplay}ï¼‰`;  
                    elem.className = 'text-blue-600';  
                    if (!hasSubmitted && !hasAssigned) {  
                        removeBtn.classList.remove('hidden');  
                    }  
                } else {  
                    elem.textContent = 'æœªé€‰æ‹©';  
                    elem.className = 'text-gray-600';  
                    removeBtn.classList.add('hidden');  
                }  
            }  
        }  

        // æäº¤é€‰é¢˜  
        async function submitSelection() {  
            if (hasAssigned) {  
                alert('å¯¼å¸ˆå·²åˆ†é…ï¼Œæ— æ³•æäº¤å¿—æ„¿');  
                return;  
            }  

            if (hasSubmitted) {  
                alert('æ‚¨å·²æäº¤å¿—æ„¿ï¼Œæ— æ³•é‡å¤æäº¤');  
                return;  
            }  

            if (selectedTopics.length === 0) {  
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¢˜ç›®');  
                return;  
            }  

            if (!confirm('ç¡®å®šæäº¤å¿—æ„¿å—ï¼Ÿæäº¤åå°†æ— æ³•ä¿®æ”¹')) {  
                return;  
            }  

            try {  
                // æ£€æŸ¥æ˜¯å¦å·²ç»æäº¤è¿‡  
                const checkQuery = new AV.Query('Selection');  
                checkQuery.equalTo('studentId', currentUser.get('username'));  
                const existing = await checkQuery.first();  

                let selection;  
                if (existing) {  
                    selection = existing;  
                } else {  
                    selection = new AV.Object('Selection');  
                    selection.set('studentId', currentUser.get('username'));  
                    selection.set('studentName', currentUser.get('name'));  
                }  

                selection.set('topic1Id', selectedTopics[0]?.id || '');  
                selection.set('topic2Id', selectedTopics[1]?.id || '');  
                selection.set('topic3Id', selectedTopics[2]?.id || '');  
                selection.set('submitted', true); // æ ‡è®°ä¸ºå·²æäº¤  
                selection.set('submitTime', new Date()); // è®°å½•æäº¤æ—¶é—´  
                
                await selection.save();  
                
                hasSubmitted = true;  
                lockSelection();  
                
                alert('æäº¤æˆåŠŸï¼');  
            } catch (error) {  
                alert('æäº¤å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // åŠ è½½æˆ‘çš„é€‰é¢˜  
        async function loadMySelection() {  
            try {  
                const query = new AV.Query('Selection');  
                query.equalTo('studentId', currentUser.get('username'));  
                const selection = await query.first();  

                if (selection) {  
                    selectedTopics = [];  
                    const topic1Id = selection.get('topic1Id');  
                    const topic2Id = selection.get('topic2Id');  
                    const topic3Id = selection.get('topic3Id');  

                    if (topic1Id) {  
                        const topic1 = await getTopic(topic1Id);  
                        if (topic1) selectedTopics.push({   
                            id: topic1Id,   
                            title: topic1.get('title'),   
                            teacherName: topic1.get('teacherName'),  
                            teacherId: topic1.get('teacherId')  
                        });  
                    }  
                    if (topic2Id) {  
                        const topic2 = await getTopic(topic2Id);  
                        if (topic2) selectedTopics.push({   
                            id: topic2Id,   
                            title: topic2.get('title'),   
                            teacherName: topic2.get('teacherName'),  
                            teacherId: topic2.get('teacherId')  
                        });  
                    }  
                    if (topic3Id) {  
                        const topic3 = await getTopic(topic3Id);  
                        if (topic3) selectedTopics.push({   
                            id: topic3Id,   
                            title: topic3.get('title'),   
                            teacherName: topic3.get('teacherName'),  
                            teacherId: topic3.get('teacherId')  
                        });  
                    }  

                    updateSelectionDisplay();  
                }  
            } catch (error) {  
                console.error('åŠ è½½æˆ‘çš„é€‰é¢˜å¤±è´¥ï¼š', error);  
            }  
        }  

        // åŠ è½½æ•™å¸ˆæ•°æ®  
        async function loadTeacherData() {  
            document.getElementById('teacherInfo').textContent = `æ¬¢è¿ï¼Œ${currentUser.get('name')}ï¼ˆ${currentUser.get('username')}ï¼‰`;  
            await loadMyTopics();  
        }  

        // æ·»åŠ é¢˜ç›®  
        async function addTopic() {  
            const title = document.getElementById('topicTitle').value.trim();  
            const description = document.getElementById('topicDescription').value.trim();  
            const grade = document.getElementById('topicGrade').value;  

            if (!title) {  
                alert('è¯·è¾“å…¥é¢˜ç›®åç§°');  
                return;  
            }  

            try {  
                // æ£€æŸ¥é¢˜ç›®æ•°é‡  
                const countQuery = new AV.Query('Topic');  
                countQuery.equalTo('teacherId', currentUser.get('username'));  
                const count = await countQuery.count();  

                if (count >= 5) {  
                    alert('æœ€å¤šåªèƒ½æ·»åŠ 5ä¸ªé¢˜ç›®');  
                    return;  
                }  

                const topic = new AV.Object('Topic');  
                topic.set('teacherId', currentUser.get('username'));  
                topic.set('teacherName', currentUser.get('name'));  
                topic.set('title', title);  
                topic.set('description', description);  
                topic.set('grade', grade);  
                await topic.save();  

                alert('æ·»åŠ æˆåŠŸ');  
                document.getElementById('topicTitle').value = '';  
                document.getElementById('topicDescription').value = '';  
                loadMyTopics();  
            } catch (error) {  
                alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // åŠ è½½æˆ‘çš„é¢˜ç›®  
        async function loadMyTopics() {  
            try {  
                const query = new AV.Query('Topic');  
                query.equalTo('teacherId', currentUser.get('username'));  
                query.limit(5);  
                const topics = await query.find();  

                const topicList = document.getElementById('myTopicList');  
                topicList.innerHTML = '';  

                if (topics.length === 0) {  
                    topicList.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— é¢˜ç›®</p>';  
                    return;  
                }  

                for (let topic of topics) {  
                    const div = document.createElement('div');  
                    div.className = 'border rounded-lg p-4';  
                    div.innerHTML = `  
                        <div class="flex justify-between items-start mb-2">  
                            <h3 class="font-bold text-lg">${topic.get('title')}</h3>  
                            <button onclick="deleteTopic('${topic.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">åˆ é™¤</button>  
                        </div>  
                        <p class="text-gray-600 mb-2">${topic.get('description') || 'æ— æè¿°'}</p>  
                        <p class="text-sm text-gray-500">é€‚ç”¨å¹´çº§ï¼š20${topic.get('grade')}çº§</p>  
                    `;  
                    topicList.appendChild(div);  
                }  

                topicList.innerHTML += `<p class="text-sm text-gray-500 text-center mt-4">å·²æ·»åŠ  ${topics.length}/5 ä¸ªé¢˜ç›®</p>`;  
            } catch (error) {  
                alert('åŠ è½½é¢˜ç›®å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // åˆ é™¤é¢˜ç›®  
        async function deleteTopic(topicId) {  
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥é¢˜ç›®å—ï¼Ÿ')) return;  

            try {
                const topic = AV.Object.createWithoutData('Topic', topicId);
                await topic.destroy();
                alert('åˆ é™¤æˆåŠŸ');
                loadMyTopics();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // åŠ è½½åˆ†é…è§†å›¾
        async function loadAssignmentView() {
            try {
                // åŠ è½½æ•™å¸ˆä¸»é¡µæ˜ å°„è¡¨
                await loadTeacherHomepageMap();

                // è·å–æ‰€æœ‰å­¦ç”Ÿ
                const studentQuery = new AV.Query('SystemUser');
                studentQuery.equalTo('role', 'student');
                studentQuery.limit(1000);
                const students = await studentQuery.find();

                // è·å–å·²ä¿å­˜çš„åˆ†é…æ–¹æ¡ˆ
                const assignmentQuery = new AV.Query('Assignment');
                assignmentQuery.limit(1000);
                const savedAssignments = await assignmentQuery.find();

                // æ„å»ºåˆ†é…æ˜ å°„
                const assignmentMap = {};
                for (let a of savedAssignments) {
                    assignmentMap[a.get('studentId')] = {
                        assignedTopicId: a.get('assignedTopicId'),
                        assignedTopicTitle: a.get('assignedTopicTitle'),
                        assignedTeacherId: a.get('assignedTeacherId'),
                        assignedTeacherName: a.get('assignedTeacherName'),
                        isFromChoice: a.get('isFromChoice'),
                        choice1: a.get('choice1'),
                        choice1Teacher: a.get('choice1Teacher'),
                        choice2: a.get('choice2'),
                        choice2Teacher: a.get('choice2Teacher'),
                        choice3: a.get('choice3'),
                        choice3Teacher: a.get('choice3Teacher')
                    };
                }

                // ä¸ºæ‰€æœ‰å­¦ç”Ÿæ„å»ºåˆ†é…ä¿¡æ¯
                currentAssignments = [];
                for (let student of students) {
                    const studentId = student.get('username');
                    const assignment = assignmentMap[studentId];
                    
                    if (assignment) {
                        currentAssignments.push({
                            studentId: studentId,
                            studentName: student.get('name'),
                            className: student.get('class'),
                            grade: student.get('grade'),
                            ...assignment
                        });
                    } else {
                        // æ²¡æœ‰åˆ†é…æ–¹æ¡ˆçš„å­¦ç”Ÿ
                        currentAssignments.push({
                            studentId: studentId,
                            studentName: student.get('name'),
                            className: student.get('class'),
                            grade: student.get('grade'),
                            assignedTopicId: '',
                            assignedTopicTitle: '',
                            assignedTeacherId: '',
                            assignedTeacherName: '',
                            isFromChoice: false,
                            choice1: '',
                            choice1Teacher: '',
                            choice2: '',
                            choice2Teacher: '',
                            choice3: '',
                            choice3Teacher: ''
                        });
                    }
                }

                // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿ
                filteredAssignments = [...currentAssignments];
                displayAssignments();
            } catch (error) {
                console.error('åŠ è½½åˆ†é…è§†å›¾å¤±è´¥ï¼š', error);
            }
        }

        // æœç´¢å­¦ç”Ÿ
        function searchStudents() {
            const searchStudentId = document.getElementById('searchStudentId').value.trim().toLowerCase();
            const searchStudentName = document.getElementById('searchStudentName').value.trim().toLowerCase();
            const searchGrade = document.getElementById('searchGrade').value;
            const searchAssignStatus = document.getElementById('searchAssignStatus').value;

            filteredAssignments = currentAssignments.filter(assignment => {
                // å­¦å·ç­›é€‰
                if (searchStudentId && !assignment.studentId.toLowerCase().includes(searchStudentId)) {
                    return false;
                }

                // å§“åç­›é€‰
                if (searchStudentName && !assignment.studentName.toLowerCase().includes(searchStudentName)) {
                    return false;
                }

                // å¹´çº§ç­›é€‰
                if (searchGrade && assignment.grade !== searchGrade) {
                    return false;
                }

                // åˆ†é…çŠ¶æ€ç­›é€‰
                if (searchAssignStatus) {
                    if (searchAssignStatus === 'assigned' && !assignment.assignedTopicId) {
                        return false;
                    }
                    if (searchAssignStatus === 'unassigned' && assignment.assignedTopicId) {
                        return false;
                    }
                    if (searchAssignStatus === 'fromChoice' && !assignment.isFromChoice) {
                        return false;
                    }
                    if (searchAssignStatus === 'notFromChoice' && (assignment.isFromChoice || !assignment.assignedTopicId)) {
                        return false;
                    }
                }

                return true;
            });

            displayAssignments();
            
            // æ˜¾ç¤ºæœç´¢ç»“æœç»Ÿè®¡
            alert(`æ‰¾åˆ° ${filteredAssignments.length} æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•`);
        }

        // é‡ç½®æœç´¢
        function resetSearch() {
            document.getElementById('searchStudentId').value = '';
            document.getElementById('searchStudentName').value = '';
            document.getElementById('searchGrade').value = '';
            document.getElementById('searchAssignStatus').value = '';
            
            filteredAssignments = [...currentAssignments];
            displayAssignments();
        }

        // è‡ªåŠ¨åˆ†é…å¯¼å¸ˆï¼ˆåªå¯¹æœç´¢æ¡ä»¶ä¸‹çš„å­¦ç”Ÿï¼‰
        async function autoAssignment() {
            if (filteredAssignments.length === 0) {
                alert('å½“å‰æœç´¢æ¡ä»¶ä¸‹æ²¡æœ‰å­¦ç”Ÿï¼Œè¯·è°ƒæ•´æœç´¢æ¡ä»¶');
                return;
            }

            if (!confirm(`å°†å¯¹å½“å‰æœç´¢æ¡ä»¶ä¸‹çš„ ${filteredAssignments.length} åå­¦ç”Ÿè¿›è¡Œåˆ†é…ï¼Œç¡®å®šå—ï¼Ÿ`)) {
                return;
            }

            try {
                // è·å–æ‰€æœ‰é€‰é¢˜
                const selectionQuery = new AV.Query('Selection');
                selectionQuery.limit(1000);
                const selections = await selectionQuery.find();

                // æ„å»ºå­¦ç”Ÿ-é€‰é¢˜æ˜ å°„
                const selectionMap = {};
                for (let sel of selections) {
                    selectionMap[sel.get('studentId')] = sel;
                }

                // è®°å½•å·²åˆ†é…çš„é¢˜ç›®ï¼ˆæ¯ä¸ªé¢˜ç›®åªèƒ½åˆ†é…ç»™1ä¸ªå­¦ç”Ÿï¼‰
                const assignedTopics = new Set();
                
                const unassignedStudents = [];

                // éšæœºæ‰“ä¹±å­¦ç”Ÿé¡ºåºï¼Œå¢åŠ å…¬å¹³æ€§
                const shuffledStudents = [...filteredAssignments].sort(() => Math.random() - 0.5);

                // ä¸ºæ¯ä¸ªå­¦ç”Ÿåˆ†é…å¯¼å¸ˆ
                for (let i = 0; i < shuffledStudents.length; i++) {
                    const student = shuffledStudents[i];
                    const studentId = student.studentId;
                    const selection = selectionMap[studentId];
                    
                    if (!selection) {
                        // æ²¡æœ‰å¡«å†™å¿—æ„¿çš„å­¦ç”Ÿ
                        student.assignedTopicId = '';
                        student.assignedTopicTitle = 'æœªå¡«å†™å¿—æ„¿';
                        student.assignedTeacherId = '';
                        student.assignedTeacherName = '';
                        student.isFromChoice = false;
                        student.choice1 = '';
                        student.choice1Teacher = '';
                        student.choice2 = '';
                        student.choice2Teacher = '';
                        student.choice3 = '';
                        student.choice3Teacher = '';
                        continue;
                    }

                    // è·å–å­¦ç”Ÿçš„ä¸‰ä¸ªå¿—æ„¿
                    const choices = [
                        selection.get('topic1Id'),
                        selection.get('topic2Id'),
                        selection.get('topic3Id')
                    ].filter(id => id);

                    // è·å–å¿—æ„¿é¢˜ç›®ä¿¡æ¯ç”¨äºæ˜¾ç¤º
                    const topic1 = await getTopic(selection.get('topic1Id'));
                    const topic2 = await getTopic(selection.get('topic2Id'));
                    const topic3 = await getTopic(selection.get('topic3Id'));

                    // æ›´æ–°å¿—æ„¿ä¿¡æ¯
                    student.choice1 = topic1 ? topic1.get('title') : '';
                    student.choice1Teacher = topic1 ? topic1.get('teacherName') : '';
                    student.choice2 = topic2 ? topic2.get('title') : '';
                    student.choice2Teacher = topic2 ? topic2.get('teacherName') : '';
                    student.choice3 = topic3 ? topic3.get('title') : '';
                    student.choice3Teacher = topic3 ? topic3.get('teacherName') : '';

                    // éšæœºæ‰“ä¹±å¿—æ„¿é¡ºåº
                    const shuffledChoices = choices.sort(() => Math.random() - 0.5);
                    
                    let assigned = false;
                    let assignedTopic = null;

                    // å°è¯•åˆ†é…å¿—æ„¿
                    for (let topicId of shuffledChoices) {
                        const topic = await getTopic(topicId);
                        if (!topic) continue;

                        // æ£€æŸ¥è¯¥é¢˜ç›®æ˜¯å¦å·²è¢«åˆ†é…
                        if (!assignedTopics.has(topicId)) {
                            assignedTopics.add(topicId); // æ ‡è®°ä¸ºå·²åˆ†é…
                            assigned = true;
                            assignedTopic = topic;
                            break;
                        }
                    }

                    if (assigned && assignedTopic) {
                        // æˆåŠŸä»å¿—æ„¿ä¸­åˆ†é…
                        student.assignedTopicId = assignedTopic.id;
                        student.assignedTopicTitle = assignedTopic.get('title');
                        student.assignedTeacherId = assignedTopic.get('teacherId');
                        student.assignedTeacherName = assignedTopic.get('teacherName');
                        student.isFromChoice = true;
                    } else {
                        // æ— æ³•ä»å¿—æ„¿ä¸­åˆ†é…
                        student.assignedTopicId = '';
                        student.assignedTopicTitle = 'æœªèƒ½åˆ†é…';
                        student.assignedTeacherId = '';
                        student.assignedTeacherName = '';
                        student.isFromChoice = false;
                        unassignedStudents.push({
                            studentId: studentId,
                            studentName: student.studentName,
                            choice1: student.choice1 ? student.choice1 + 'ï¼ˆ' + student.choice1Teacher + 'ï¼‰' : '',
                            choice2: student.choice2 ? student.choice2 + 'ï¼ˆ' + student.choice2Teacher + 'ï¼‰' : '',
                            choice3: student.choice3 ? student.choice3 + 'ï¼ˆ' + student.choice3Teacher + 'ï¼‰' : ''
                        });
                    }

                    // æ›´æ–°currentAssignmentsä¸­å¯¹åº”çš„å­¦ç”Ÿ
                    const index = currentAssignments.findIndex(a => a.studentId === studentId);
                    if (index !== -1) {
                        currentAssignments[index] = {...student};
                    }
                }

                // æ˜¾ç¤ºåˆ†é…ç»“æœ
                displayAssignments();

                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                const assignedCount = filteredAssignments.filter(a => a.isFromChoice).length;
                const unassignedCount = unassignedStudents.length;
                document.getElementById('assignmentStats').classList.remove('hidden');
                document.getElementById('statsText').innerHTML = 
                    `æœ¬æ¬¡åˆ†é…å­¦ç”Ÿæ•°ï¼š${filteredAssignments.length}ï¼ŒæˆåŠŸä»å¿—æ„¿ä¸­åˆ†é…ï¼š<span class="text-green-600 font-bold">${assignedCount}</span>ï¼Œæœªèƒ½ä»å¿—æ„¿ä¸­åˆ†é…ï¼š<span class="text-red-600 font-bold">${unassignedCount}</span>`;

                // æ˜¾ç¤ºæœªåˆ†é…å­¦ç”Ÿ
                if (unassignedStudents.length > 0) {
                    document.getElementById('unassignedList').classList.remove('hidden');
                    const unassignedDiv = document.getElementById('unassignedStudents');
                    unassignedDiv.innerHTML = unassignedStudents.map(s => `
                        <div class="border-b py-2">
                            <p class="font-semibold">${s.studentName}ï¼ˆ${s.studentId}ï¼‰</p>
                            <p class="text-sm">ç¬¬ä¸€å¿—æ„¿ï¼š${s.choice1 || 'æœªé€‰æ‹©'}</p>
                            <p class="text-sm">ç¬¬äºŒå¿—æ„¿ï¼š${s.choice2 || 'æœªé€‰æ‹©'}</p>
                            <p class="text-sm">ç¬¬ä¸‰å¿—æ„¿ï¼š${s.choice3 || 'æœªé€‰æ‹©'}</p>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('unassignedList').classList.add('hidden');
                    alert('âœ… æœç´¢æ¡ä»¶ä¸‹çš„æ‰€æœ‰å­¦ç”Ÿéƒ½æˆåŠŸä»å¿—æ„¿ä¸­åˆ†é…åˆ°å¯¼å¸ˆï¼');
                }

            } catch (error) {
                alert('åˆ†é…å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ˜¾ç¤ºåˆ†é…ç»“æœ
        function displayAssignments() {
            const tbody = document.getElementById('assignmentTableBody');
            tbody.innerHTML = '';

            for (let assignment of filteredAssignments) {
                const tr = document.createElement('tr');
                const bgColor = assignment.isFromChoice ? '' : 'bg-yellow-50';
                tr.className = bgColor;
                tr.innerHTML = `
                    <td class="border px-4 py-2">${assignment.studentId}</td>
                    <td class="border px-4 py-2">${assignment.studentName}</td>
                    <td class="border px-4 py-2">${assignment.className}</td>
                    <td class="border px-4 py-2">${assignment.assignedTopicTitle || 'æœªåˆ†é…'}</td>
                    <td class="border px-4 py-2">${assignment.assignedTeacherName || '-'}</td>
                    <td class="border px-4 py-2">${assignment.assignedTopicId ? (assignment.isFromChoice ? '<span class="text-green-600 font-semibold">æ˜¯</span>' : '<span class="text-red-600 font-semibold">å¦</span>') : '-'}</td>
                `;
                tbody.appendChild(tr);
            }

            if (filteredAssignments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="border px-4 py-2 text-center text-gray-500">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿ</td></tr>';
            }
        }

        // ä¿å­˜åˆ†é…æ–¹æ¡ˆï¼ˆåªä¿å­˜å·²åˆ†é…çš„å­¦ç”Ÿï¼‰
        async function saveAssignment() {
            const assignedStudents = filteredAssignments.filter(a => a.assignedTopicId);
            
            if (assignedStudents.length === 0) {
                alert('å½“å‰æœç´¢æ¡ä»¶ä¸‹æ²¡æœ‰å·²åˆ†é…çš„å­¦ç”Ÿ');
                return;
            }

            if (!confirm(`ç¡®å®šä¿å­˜å½“å‰æœç´¢æ¡ä»¶ä¸‹ ${assignedStudents.length} åå­¦ç”Ÿçš„åˆ†é…æ–¹æ¡ˆå—ï¼Ÿ\næ³¨æ„ï¼šè¿™å°†è¦†ç›–è¿™äº›å­¦ç”Ÿä¹‹å‰çš„åˆ†é…è®°å½•`)) {
                return;
            }

            try {
                // åªåˆ é™¤å½“å‰è¦ä¿å­˜çš„å­¦ç”Ÿçš„æ—§åˆ†é…è®°å½•
                const studentIds = assignedStudents.map(a => a.studentId);
                const oldQuery = new AV.Query('Assignment');
                oldQuery.containedIn('studentId', studentIds);
                oldQuery.limit(1000);
                const oldAssignments = await oldQuery.find();
                if (oldAssignments.length > 0) {
                    await AV.Object.destroyAll(oldAssignments);
                }

                // ä¿å­˜æ–°çš„åˆ†é…æ–¹æ¡ˆ
                for (let assignment of assignedStudents) {
                    const assignmentObj = new AV.Object('Assignment');
                    assignmentObj.set('studentId', assignment.studentId);
                    assignmentObj.set('studentName', assignment.studentName);
                    assignmentObj.set('className', assignment.className);
                    assignmentObj.set('assignedTopicId', assignment.assignedTopicId);
                    assignmentObj.set('assignedTopicTitle', assignment.assignedTopicTitle);
                    assignmentObj.set('assignedTeacherId', assignment.assignedTeacherId);
                    assignmentObj.set('assignedTeacherName', assignment.assignedTeacherName);
                    assignmentObj.set('isFromChoice', assignment.isFromChoice);
                    assignmentObj.set('choice1', assignment.choice1);
                    assignmentObj.set('choice1Teacher', assignment.choice1Teacher);
                    assignmentObj.set('choice2', assignment.choice2);
                    assignmentObj.set('choice2Teacher', assignment.choice2Teacher);
                    assignmentObj.set('choice3', assignment.choice3);
                    assignmentObj.set('choice3Teacher', assignment.choice3Teacher);
                    await assignmentObj.save();
                }

                alert(`æˆåŠŸä¿å­˜ ${assignedStudents.length} åå­¦ç”Ÿçš„åˆ†é…æ–¹æ¡ˆï¼`);
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        // å¯¼å‡ºExcelï¼ˆåªå¯¼å‡ºå½“å‰æ˜¾ç¤ºçš„å­¦ç”Ÿï¼‰
        function exportToExcel() {
            if (filteredAssignments.length === 0) {
                alert('å½“å‰æœç´¢æ¡ä»¶ä¸‹æ²¡æœ‰å­¦ç”Ÿæ•°æ®');
                return;
            }

            // å‡†å¤‡æ•°æ®
            const data = filteredAssignments.map(a => ({
                'å­¦ç”Ÿå§“å': a.studentName,
                'å­¦å·': a.studentId,
                'ç­çº§': a.className,
                'å¹´çº§': '20' + a.grade + 'çº§',
                'ç¬¬ä¸€å¿—æ„¿é¢˜ç›®': a.choice1 || '-',
                'ç¬¬ä¸€å¿—æ„¿æŒ‡å¯¼æ•™å¸ˆ': a.choice1Teacher || '-',
                'ç¬¬äºŒå¿—æ„¿é¢˜ç›®': a.choice2 || '-',
                'ç¬¬äºŒå¿—æ„¿æŒ‡å¯¼æ•™å¸ˆ': a.choice2Teacher || '-',
                'ç¬¬ä¸‰å¿—æ„¿é¢˜ç›®': a.choice3 || '-',
                'ç¬¬ä¸‰å¿—æ„¿æŒ‡å¯¼æ•™å¸ˆ': a.choice3Teacher || '-',
                'ç³»ç»Ÿåˆ†é…é¢˜ç›®': a.assignedTopicTitle || 'æœªåˆ†é…',
                'ç³»ç»Ÿåˆ†é…æŒ‡å¯¼æ•™å¸ˆ': a.assignedTeacherName || '-',
                'æ˜¯å¦ä¸‰å¿—æ„¿ä¹‹ä¸€': a.assignedTopicId ? (a.isFromChoice ? 'æ˜¯' : 'å¦') : '-'
            }));

            // åˆ›å»ºå·¥ä½œç°¿
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å¯¼å¸ˆåˆ†é…ç»“æœ");

            // å¯¼å‡ºæ–‡ä»¶
            const date = new Date();
            const dateStr = `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}`;
            const fileName = `å¯¼å¸ˆåˆ†é…ç»“æœ_${dateStr}_å…±${filteredAssignments.length}äºº.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`å·²å¯¼å‡º ${filteredAssignments.length} åå­¦ç”Ÿçš„åˆ†é…ä¿¡æ¯`);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç®¡ç†å‘˜è´¦å·
        window.onload = async function() {
            try {
                const query = new AV.Query('SystemUser');
                query.equalTo('username', '080907');
                query.equalTo('role', 'admin');
                const admin = await query.first();

                if (!admin) {
                    const newAdmin = new AV.Object('SystemUser');
                    newAdmin.set('username', '080907');
                    newAdmin.set('password', '080907T');
                    newAdmin.set('role', 'admin');
                    newAdmin.set('name', 'ç®¡ç†å‘˜');
                    newAdmin.set('needPasswordChange', false);
                    await newAdmin.save();
                    console.log('ç®¡ç†å‘˜è´¦å·åˆå§‹åŒ–æˆåŠŸ');
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥ï¼š', error);
            }
        };
    </script>
</body>
</html>