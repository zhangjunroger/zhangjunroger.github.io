<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>大学生课堂签到系统</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <!-- LeanCloud SDK -->  
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>  
    <!-- Face-api.js for face recognition -->  
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>  
    <!-- xlsx library for Excel export -->  
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- ECharts 词云库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>

    <style>  
        .word-cloud {  
            display: flex;  
            flex-wrap: wrap;  
            gap: 8px;  
            padding: 20px;  
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
            border-radius: 12px;  
            min-height: 200px;  
        }  
        .cloud-name {  
            padding: 8px 16px;  
            background: white;  
            border-radius: 20px;  
            font-size: 14px;  
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);  
            transition: all 0.3s ease;  
            animation: float 3s ease-in-out infinite;  
        }  
        .cloud-name.checked {  
            opacity: 0;  
            transform: scale(0);  
        }  
        @keyframes float {  
            0%, 100% { transform: translateY(0px); }  
            50% { transform: translateY(-10px); }  
        }  
        .tab-active {  
            background: #4f46e5;  
            color: white;  
        }  
        #faceCanvas {  
            position: absolute;  
            top: 0;  
            left: 0;  
        }  
        .video-container {  
            position: relative;  
            width: 100%;  
            max-width: 640px;  
            margin: 0 auto;  
        }  
        .requirement-item {  
            display: flex;  
            align-items: center;  
            gap: 8px;  
            padding: 8px;  
            background: #f0fdf4;  
            border-left: 3px solid #22c55e;  
            margin-bottom: 8px;  
            border-radius: 4px;  
        }  
        .warning-item {  
            display: flex;  
            align-items: center;  
            gap: 8px;  
            padding: 8px;  
            background: #fef2f2;  
            border-left: 3px solid #ef4444;  
            margin-bottom: 8px;  
            border-radius: 4px;  
        } 
        
        /* 词云相关动画 */
        @keyframes pulse-slow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* 进度条闪烁效果 */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        #wordCloudProgressBar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* 通知淡入淡出 */
        .notification-enter {
            animation: slideInRight 0.3s ease-out;
        }

        .notification-exit {
            animation: slideOutRight 0.3s ease-in;
        }

        @media (max-width: 768px) {
            #wordCloudContainer {
                height: 350px !important;
            }
            
            .check-in-notification {
                right: 1rem !important;
                top: 5rem !important;
                font-size: 0.9rem;
            }
        }   

    </style>  
</head>  
<body class="bg-gray-100">  
    <div class="container mx-auto p-4 max-w-6xl">  
        <!-- Header -->  
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">  
            <h1 class="text-3xl font-bold text-center text-indigo-600">📚 大学生课堂签到系统</h1>  
            <div class="flex justify-center gap-4 mt-4">  
                <button onclick="switchRole('teacher')" id="teacherTab" class="px-6 py-2 rounded-lg tab-active">教师端</button>  
                <button onclick="switchRole('student')" id="studentTab" class="px-6 py-2 rounded-lg bg-gray-200">学生端</button>  
            </div>  
        </div>  

        <!-- Teacher Panel -->  
        <div id="teacherPanel" class="space-y-6">  
            <!-- Photo Requirements Guide -->  
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">  
                <h2 class="text-xl font-bold mb-3 text-indigo-800 flex items-center gap-2">  
                    📸 照片录入要求（重要！）  
                    <button onclick="toggleGuide()" class="text-sm bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">查看详情</button>  
                </h2>  
                <div id="photoGuide" class="hidden">  
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">  
                        <div>  
                            <h3 class="font-bold text-green-700 mb-2">✅ 正确示例</h3>  
                            <div class="requirement-item">  
                                <span class="text-green-600">✓</span>  
                                <span class="text-sm">正面拍摄，面部完整清晰</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">✓</span>  
                                <span class="text-sm">光线充足均匀，无强烈阴影</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">✓</span>  
                                <span class="text-sm">表情自然，双眼睁开</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">✓</span>  
                                <span class="text-sm">不戴眼镜、帽子、口罩</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">✓</span>  
                                <span class="text-sm">背景简洁，无遮挡</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">✓</span>  
                                <span class="text-sm">照片清晰度高，文件大于100KB</span>  
                            </div>  
                        </div>  
                        <div>  
                            <h3 class="font-bold text-red-700 mb-2">❌ 错误示例</h3>  
                            <div class="warning-item">  
                                <span class="text-red-600">✗</span>  
                                <span class="text-sm">侧脸、低头、仰头</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">✗</span>  
                                <span class="text-sm">光线太暗或逆光</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">✗</span>  
                                <span class="text-sm">照片模糊不清</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">✗</span>  
                                <span class="text-sm">戴墨镜、口罩、帽子</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">✗</span>  
                                <span class="text-sm">多人合影或远距离拍摄</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">✗</span>  
                                <span class="text-sm">过度美颜或滤镜</span>  
                            </div>  
                        </div>  
                    </div>  
                    <div class="bg-yellow-50 border border-yellow-300 rounded p-3 text-sm">  
                        <p class="font-bold text-yellow-800 mb-1">💡 最佳实践：</p>  
                        <ul class="list-disc ml-5 text-yellow-800 space-y-1">  
                            <li>建议使用证件照或清晰的生活照</li>  
                            <li>人脸占照片的30-50%为最佳</li>  
                            <li>照片格式：JPG/PNG，分辨率建议800x1000以上</li>  
                            <li>批量导入时确保文件名格式：<code class="bg-yellow-100 px-1">学号-姓名-班级.jpg</code></li>  
                        </ul>  
                    </div>  
                </div>  
            </div>  

            <!-- Student Management -->  
            <div class="bg-white rounded-lg shadow-lg p-6">  
                <h2 class="text-2xl font-bold mb-4 text-gray-800">👥 学生信息管理</h2>  
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">  
                    <input type="text" id="studentClass" placeholder="班级" class="border rounded px-4 py-2">  
                    <input type="text" id="studentId" placeholder="学号" class="border rounded px-4 py-2">  
                    <input type="text" id="studentName" placeholder="姓名" class="border rounded px-4 py-2">  
                </div>  
                
                <div class="mb-4">  
                    <label class="block mb-2 font-semibold">学生照片（单张）</label>  
                    <input type="file" id="singlePhoto" accept="image/*" onchange="previewPhoto(this, 'singlePreview')" class="border rounded px-4 py-2 w-full">  
                    <div id="singlePreview" class="mt-2"></div>  
                    <canvas id="photoCanvas" style="display:none;"></canvas>  
                </div>  

                <div class="mb-4">  
                    <label class="block mb-2 font-semibold">批量导入照片（文件名格式：学号-姓名-班级.jpg）</label>  
                    <input type="file" id="batchPhotos" accept="image/*" multiple class="border rounded px-4 py-2 w-full">  
                    <p class="text-sm text-gray-500 mt-1">示例：202301001-张三-计算机2023级1班.jpg</p>  
                </div>  

                <button onclick="addStudent()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 mr-2">➕ 添加学生</button>  
                <button onclick="batchImport()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">📦 批量导入</button>  

                <div class="mt-6">  
                    <h3 class="font-bold mb-2">已添加学生列表（共 <span id="studentCount">0</span> 人）</h3>  
                    <div id="studentList" class="max-h-60 overflow-y-auto border rounded p-4 bg-gray-50"></div>  
                </div>  
            </div>  

            <!-- Create Check-in Session -->  
            <div class="bg-white rounded-lg shadow-lg p-6">  
                <h2 class="text-2xl font-bold mb-4 text-gray-800">📝 发布签到</h2>  
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">  
                    <input type="text" id="courseName" placeholder="课程名称" class="border rounded px-4 py-2">  
                    <input type="text" id="courseSession" placeholder="课程节次（如：第3-4节）" class="border rounded px-4 py-2">  
                    <div class="md:col-span-2">  
                        <select id="selectClass" class="border rounded px-4 py-2 w-full">  
                            <option value="" disabled>请选择一个或多个班级（按住Ctrl/Cmd可多选）</option>  
                        </select>  
                    </div>  
                    <input type="number" id="checkInDuration" placeholder="签到时长（分钟）" class="border rounded px-4 py-2" value="10">  
                </div>  

                <button onclick="startCheckIn()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 w-full">🚀 开始签到</button>  
            </div>  

            <!-- History Records Quick Entry -->  
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg shadow-lg p-6 border-2 border-purple-200">  
                <div class="flex items-center justify-between mb-4">  
                    <div>  
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">  
                            📚 签到记录管理  
                        </h2>  
                        <p class="text-sm text-gray-600 mt-1">查看、导出或删除历史签到记录</p>  
                    </div>  
                    <div class="text-right">  
                        <p class="text-sm text-gray-600">共有</p>  
                        <p class="text-3xl font-bold text-purple-600" id="historyCount">0</p>  
                        <p class="text-sm text-gray-600">条记录</p>  
                    </div>  
                </div>  
                <button onclick="viewHistory()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 w-full font-semibold text-lg">  
                    📖 查看所有历史记录  
                </button>  
            </div>  

            <!-- Real-time Check-in Status -->
            <div id="checkInStatus" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <!-- 当前签到信息 -->
                <div class="mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">
                                📚 <span id="currentCourse">-</span>
                            </h3>
                            <p class="text-gray-600 mt-1">
                                👥 班级: <span id="currentClass">-</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p id="countdown" class="text-lg font-bold text-green-600">⏱️ 准备中...</p>
                        </div>
                    </div>
                </div>

                <!-- Word Cloud with Progress Bar -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-gray-800">
                            ⏳ 待签到学生词云
                            <span class="text-xs font-normal text-gray-500 ml-2">(实时更新)</span>
                        </h3>
                        <span id="wordCloudCount" class="text-sm font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full">
                            待签到: 0 人
                        </span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span class="font-medium">签到进度</span>
                            <span id="wordCloudProgress" class="font-bold text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                            <div id="wordCloudProgressBar" 
                                 class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-full rounded-full transition-all duration-500 ease-out relative overflow-hidden" 
                                 style="width: 0%">
                                <div class="absolute inset-0 bg-white opacity-30 animate-pulse"></div>
                            </div>
                        </div>
            </div>
                    </div>
                    
                    <!-- Word Cloud Container -->
                    <div id="wordCloudContainer" style="width: 100%; height: 400px; position: relative;"></div>
                    
                    <!-- Tips -->
                    <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-gray-700">
                            💡 <strong>提示：</strong>学生签到后将从词云中消失，全部签到完成后显示祝贺动画
                        </p>
                    </div>
                </div>

                <div class="mt-4 flex flex-wrap gap-4">  
                    <button onclick="endCheckIn()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">✅ 结束签到</button>  
                    <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">📥 导出当前Excel</button>  
                    <button onclick="refreshCheckInData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">🔄 刷新数据</button>  
                    <button onclick="viewHistory()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">📚 查看历史记录</button>  
                </div>  

            <!-- 已签到列表 -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    ✅ 已签到学生 (<span id="checkedCount">0</span>)
                </h3>
                <div id="checkedInList" class="max-h-96 overflow-y-auto">
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">📝</p>
                        <p class="text-sm">暂无签到记录</p>
                    </div>
                </div>
            </div>

            <!-- 未签到列表 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    ⏰ 未签到学生 (<span id="uncheckedCount">0</span>)
                </h3>
                <div id="uncheckedList" class="max-h-96 overflow-y-auto">
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">👥</p>
                        <p class="text-sm">暂无学生信息</p>
                    </div>
                </div>


            </div>  

            <!-- History Records -->  
            <div id="historyPanel" class="bg-white rounded-lg shadow-lg p-6 hidden">  
                <div class="flex justify-between items-center mb-4">  
                    <h2 class="text-2xl font-bold text-gray-800">📚 历史签到记录</h2>  
                    <button onclick="hideHistory()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 flex items-center gap-2">  
                        ← 返回  
                    </button>  
                </div>  
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">  
                    <p class="text-sm text-gray-700">  
                        💡 <strong>提示：</strong>点击"导出Excel"可下载签到记录，点击"删除"可永久删除该记录（建议先导出）  
                    </p>  
                </div>  
                <div id="historyList" class="space-y-4"></div>  
            </div>  
        </div>  

        <!-- Student Panel -->  
        <div id="studentPanel" class="hidden">  
            <div class="bg-white rounded-lg shadow-lg p-6">  
                <h2 class="text-2xl font-bold mb-4 text-gray-800">🎓 学生签到</h2>  

                <!-- Video for face recognition -->  
                <div class="mb-4 video-container">  
                    <video id="video" width="640" height="480" autoplay class="border rounded-lg bg-black hidden"></video>  
                    <canvas id="faceCanvas" width="640" height="480" class="hidden"></canvas>  
                    <div id="videoPlaceholder" class="bg-gray-200 rounded-lg h-80 flex items-center justify-center">  
                        <p class="text-gray-500 text-center px-4">点击"打开相机"开始人脸识别<br/><small class="text-xs">请确保光线充足，正对摄像头</small></p>  
                    </div>  
                </div>  

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">  
                    <button onclick="openCamera()" id="cameraBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700">📷 打开相机（人脸识别）</button>  
                    <button onclick="getLocation()" id="locationBtn" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700">📍 获取定位</button>  
                </div>  

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">  
                    <input type="text" id="stuClass" placeholder="班级（自动识别）" class="border rounded px-4 py-2">  
                    <input type="text" id="stuId" placeholder="学号（自动识别）" class="border rounded px-4 py-2">  
                    <input type="text" id="stuName" placeholder="姓名（自动识别）" class="border rounded px-4 py-2">  
                </div>  

                <div class="mb-4">  
                    <input type="text" id="location" placeholder="定位信息（自动获取）" class="border rounded px-4 py-2 w-full" readonly>  
                </div>  

                <div id="recognitionStatus" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">  
                    <p class="text-blue-800 font-semibold">🔍 正在识别...</p>  
                </div>  

                <button onclick="submitCheckIn()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 w-full text-lg font-bold">✅ 提交签到</button>  

                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">  
                    <p class="text-sm text-yellow-800 font-bold mb-2">💡 签到提示：</p>  
                    <ul class="text-sm text-yellow-800 list-disc ml-5 space-y-1">  
                        <li>人脸识别需要正对摄像头，保持光线充足</li>  
                        <li>如识别失败，请手动填写信息后提交</li>  
                        <li>定位功能为可选项，定位失败不影响签到</li>  
                        <li>建议先获取定位，但非必需</li>  
                        <li>请确保在签到时间范围内提交</li>  
                    </ul>  
                </div>  
            </div>  
        </div>  
    </div>  

    <script> 
    
        // ==================== 响应式处理 ====================
        
        // 监听窗口大小变化
        window.addEventListener('resize', function() {
            if (wordCloudChart) {
                wordCloudChart.resize();
                console.log('📱 词云已适配屏幕尺寸');
            }
        });

        // 页面可见性变化时刷新
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && wordCloudChart) {
                setTimeout(() => {
                    wordCloudChart.resize();
                }, 300);
            }
        });    

        // LeanCloud 初始化 - 请替换为你的应用凭证  
        AV.init({
            appId: "i1PwXfBx9ZVMkIYzZdUUiysn-gzGzoHsz",
            appKey: "gFXLEuRbVBEVBZiLiZrknLxE",
            serverURL: "https://avoscloud.com"
        });

        // Global variables  
        let students = [];  
        let currentCheckInSession = null;  
        let checkedInStudents = [];  
        let faceModelsLoaded = false;  
        let videoStream = null;  
        let faceDetectionRunning = false;  
        let labeledDescriptors = [];  
        let recognitionSuccess = false; // 识别成功标志  


        // Load Face-api models with better error handling  
        async function loadFaceModels() {  
            try {  
                console.log('开始加载人脸识别模型...');  
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';  
                
                await Promise.all([  
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),  
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),  
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)  
                ]);  
                
                faceModelsLoaded = true;  
                console.log('✅ 人脸识别模型加载完成');  
            } catch (error) {  
                console.error('❌ 模型加载失败:', error);  
                alert('人脸识别模型加载失败，请刷新页面重试');  
            }  
        }  

        // Initialize on page load  
        window.onload = async function() {  
            console.log('🚀 系统初始化中...');  
            loadFaceModels(); // 异步加载人脸模型  
            await loadStudentsFromCloud(); // 等待学生数据加载  
            loadClassList(); // 加载班级列表  
            updateHistoryCount(); // 更新历史记录计数  
            await checkActiveSession(); // 检查活动会话  
            console.log('✅ 系统初始化完成');  
        };  

        // Toggle photo guide  
        function toggleGuide() {  
            const guide = document.getElementById('photoGuide');  
            guide.classList.toggle('hidden');  
        }  

        // Switch between teacher and student roles  
        function switchRole(role) {  
            // Stop camera if switching away from student panel  
            if (role === 'teacher' && videoStream) {  
                stopCamera();  
            }  

            if (role === 'teacher') {  
                document.getElementById('teacherPanel').classList.remove('hidden');  
                document.getElementById('studentPanel').classList.add('hidden');  
                document.getElementById('teacherTab').classList.add('tab-active');  
                document.getElementById('studentTab').classList.remove('tab-active');  
            } else {  
                document.getElementById('teacherPanel').classList.add('hidden');  
                document.getElementById('studentPanel').classList.remove('hidden');  
                document.getElementById('teacherTab').classList.remove('tab-active');  
                document.getElementById('studentTab').classList.add('tab-active');  
            }  
        }  

        // Preview photo before upload  
        function previewPhoto(input, previewId) {  
            const preview = document.getElementById(previewId);  
            preview.innerHTML = '';  
            
            if (input.files && input.files[0]) {  
                const reader = new FileReader();  
                reader.onload = function(e) {  
                    preview.innerHTML = `  
                        <div class="flex items-center gap-4 mt-2">  
                            <img src="${e.target.result}" class="w-32 h-32 object-cover rounded border">  
                            <div class="text-sm text-gray-600">  
                                <p>文件名: ${input.files[0].name}</p>  
                                <p>大小: ${(input.files[0].size / 1024).toFixed(2)} KB</p>  
                                <p class="text-green-600">✓ 照片已选择</p>  
                            </div>  
                        </div>  
                    `;  
                };  
                reader.readAsDataURL(input.files[0]);  
            }  
        }  

        // Add single student with improved face extraction  
        async function addStudent() {  
            const className = document.getElementById('studentClass').value;  
            const studentId = document.getElementById('studentId').value;  
            const name = document.getElementById('studentName').value;  
            const photoInput = document.getElementById('singlePhoto');  

            if (!className || !studentId || !name) {  
                alert('请填写完整的学生信息');  
                return;  
            }  

            if (!photoInput.files[0]) {  
                alert('请上传学生照片');  
                return;  
            }  

            // Check file size  
            if (photoInput.files[0].size < 50000) {  
                if (!confirm('照片文件较小（<50KB），可能影响识别效果，是否继续？')) {  
                    return;  
                }  
            }  

            try {  
                // Extract face descriptor from photo  
                const descriptor = await extractFaceFromFile(photoInput.files[0]);  
                
                if (!descriptor) {  
                    alert('❌ 未能从照片中检测到人脸！\n\n请确保：\n✓ 照片清晰，正面拍摄\n✓ 光线充足，无遮挡\n✓ 不戴墨镜、口罩\n\n建议参考上方"照片录入要求"');  
                    return;  
                }  

                // Upload photo to LeanCloud  
                const file = new AV.File(photoInput.files[0].name, photoInput.files[0]);  
                await file.save();  

                const student = {  
                    className: className,  
                    studentId: studentId,  
                    name: name,  
                    photoUrl: file.url(),  
                    faceDescriptor: Array.from(descriptor)  
                };  

                // Save to LeanCloud  
                const Student = AV.Object.extend('Student');  
                const studentObj = new Student();  
                Object.keys(student).forEach(key => studentObj.set(key, student[key]));  
                await studentObj.save();  

                students.push(student);  
                updateStudentList();  
                loadClassList();  
                updateLabeledDescriptors();  

                // Clear inputs  
                document.getElementById('studentClass').value = '';  
                document.getElementById('studentId').value = '';  
                document.getElementById('studentName').value = '';  
                document.getElementById('singlePhoto').value = '';  
                document.getElementById('singlePreview').innerHTML = '';  

                alert('✅ 学生添加成功！人脸特征已提取');  
            } catch (error) {  
                console.error('添加学生失败:', error);  
                alert('添加失败：' + error.message);  
            }  
        }  

        // Extract face descriptor from file  
        async function extractFaceFromFile(file) {  
            return new Promise((resolve, reject) => {  
                const img = document.createElement('img');  
                const canvas = document.getElementById('photoCanvas');  
                const ctx = canvas.getContext('2d');  
                
                img.onload = async () => {  
                    canvas.width = img.width;  
                    canvas.height = img.height;  
                    ctx.drawImage(img, 0, 0);  
                    
                    try {  
                        // Use tinyFaceDetector for better performance  
                        const detection = await faceapi  
                            .detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions({  
                                inputSize: 416,  
                                scoreThreshold: 0.5  
                            }))  
                            .withFaceLandmarks()  
                            .withFaceDescriptor();  
                        
                        if (detection) {  
                            console.log('✅ 成功提取人脸特征, 置信度:', detection.detection.score.toFixed(3));  
                            resolve(detection.descriptor);  
                        } else {  
                            console.warn('❌ 未检测到人脸');  
                            resolve(null);  
                        }  
                    } catch (error) {  
                        console.error('人脸提取错误:', error);  
                        reject(error);  
                    }  
                };  
                
                img.onerror = () => reject(new Error('图片加载失败'));  
                img.src = URL.createObjectURL(file);  
            });  
        }  

        // Batch import students from photos  
        async function batchImport() {  
            const photoInput = document.getElementById('batchPhotos');  
            if (!photoInput.files.length) {  
                alert('请选择照片文件');  
                return;  
            }  

            let successCount = 0;  
            let failedCount = 0;  
            const totalFiles = photoInput.files.length;  
            const failedFiles = [];  

            for (let i = 0; i < totalFiles; i++) {  
                const file = photoInput.files[i];  
                try {  
                    // Parse filename: 学号-姓名-班级.jpg  
                    const filename = file.name.split('.')[0];  
                    const parts = filename.split('-');  
                    
                    if (parts.length !== 3) {  
                        console.warn(`⚠️ 文件名格式错误: ${file.name}`);  
                        failedFiles.push(`${file.name} (格式错误)`);  
                        failedCount++;  
                        continue;  
                    }  

                    const [studentId, name, className] = parts;  

                    // Extract face descriptor  
                    const descriptor = await extractFaceFromFile(file);  
                    
                    if (!descriptor) {  
                        console.warn(`⚠️ 未能从 ${file.name} 中检测到人脸`);  
                        failedFiles.push(`${file.name} (无人脸)`);  
                        failedCount++;  
                        continue;  
                    }  

                    // Upload to LeanCloud  
                    const avFile = new AV.File(file.name, file);  
                    await avFile.save();  

                    const student = {  
                        className: className,  
                        studentId: studentId,  
                        name: name,  
                        photoUrl: avFile.url(),  
                        faceDescriptor: Array.from(descriptor)  
                    };  

                    // Save to LeanCloud  
                    const Student = AV.Object.extend('Student');  
                    const studentObj = new Student();  
                    Object.keys(student).forEach(key => studentObj.set(key, student[key]));  
                    await studentObj.save();  

                    students.push(student);  
                    successCount++;  
                    
                    console.log(`✅ 成功导入: ${name} (${i+1}/${totalFiles})`);  
                } catch (error) {  
                    console.error(`❌ 处理文件失败 ${file.name}:`, error);  
                    failedFiles.push(`${file.name} (系统错误)`);  
                    failedCount++;  
                }  
            }  

            updateStudentList();  
            loadClassList();  
            updateLabeledDescriptors();  
            photoInput.value = '';  
            
            let message = `批量导入完成！\n\n成功：${successCount} 人\n失败：${failedCount} 人`;  
            if (failedFiles.length > 0 && failedFiles.length <= 10) {  
                message += '\n\n失败文件：\n' + failedFiles.join('\n');  
            }  
            alert(message);  
        }  

        // Update labeled descriptors for face matching  
        function updateLabeledDescriptors() {  
            labeledDescriptors = students  
                .filter(s => s.faceDescriptor && s.faceDescriptor.length > 0)  
                .map(s => new faceapi.LabeledFaceDescriptors(  
                    `${s.studentId}|${s.name}|${s.className}`,  
                    [new Float32Array(s.faceDescriptor)]  
                ));  
            console.log(`已加载 ${labeledDescriptors.length} 个学生的人脸数据`);  
        }  

        // Update student list display  
        function updateStudentList() {  
            const list = document.getElementById('studentList');  
            const count = document.getElementById('studentCount');  
            count.textContent = students.length;  
            
            if (students.length === 0) {  
                list.innerHTML = '<p class="text-gray-500 text-center py-4">暂无学生数据</p>';  
                return;  
            }  
            
            list.innerHTML = students.map((s, i) => `  
                <div class="flex justify-between items-center p-2 border-b hover:bg-gray-100">  
                    <div class="flex items-center gap-3">  
                        ${s.photoUrl ? `<img src="${s.photoUrl}" class="w-10 h-10 rounded-full object-cover"/>` : '<div class="w-10 h-10 rounded-full bg-gray-300"></div>'}  
                        <span>${s.className} - ${s.studentId} - ${s.name}</span>  
                        ${s.faceDescriptor ? '<span class="text-green-600 text-xs bg-green-50 px-2 py-1 rounded">✓ 已录入人脸</span>' : '<span class="text-red-600 text-xs bg-red-50 px-2 py-1 rounded">✗ 无人脸数据</span>'}  
                    </div>  
                    <button onclick="deleteStudent(${i})" class="text-red-600 hover:text-red-800 px-3 py-1 rounded hover:bg-red-50">删除</button>  
                </div>  
            `).join('');  
        }  

        // Delete student (解码 key 后查询)
        async function deleteStudent(index) {
            if (!confirm('确定删除该学生？')) {
                return;
            }

            const student = students[index];
            
            try {
                let fileDeleteCount = 0;
                const query = new AV.Query('Student');
                query.equalTo('studentId', student.studentId);
                const result = await query.first();
                
                if (result) {
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('🗑️ 开始删除学生:', student.name, student.studentId);

                    // 删除 photoUrl 对应的文件
                    const photoUrl = result.get('photoUrl');
                    
                    if (photoUrl && typeof photoUrl === 'string') {
                        console.log('📷 photoUrl:', photoUrl);
                        
                        try {
                            // 从 URL 提取 key（已编码）
                            const urlParts = photoUrl.split('.com/');
                            const encodedKey = urlParts[1];
                            console.log('  提取到的 key (编码):', encodedKey);
                            
                            // 解码 key（转换为中文）
                            const decodedKey = decodeURIComponent(encodedKey);
                            console.log('  解码后的 key (中文):', decodedKey);
                            
                            // 使用解码后的 key 查询 _File 表
                            console.log('  🔍 查询 _File 表...');
                            const fileQuery = new AV.Query('_File');
                            fileQuery.equalTo('key', decodedKey);
                            const fileObj = await fileQuery.first();
                            
                            if (fileObj) {
                                console.log('  ✅ 找到文件记录:');
                                console.log('     objectId:', fileObj.id);
                                console.log('     key:', fileObj.get('key'));
                                console.log('     name:', fileObj.get('name'));
                                
                                await fileObj.destroy();
                                console.log('  ✅ 文件已删除');
                                fileDeleteCount++;
                            } else {
                                console.log('  ⚠️ 未找到文件记录');
                                console.log('  查询的 key:', decodedKey);
                            }
                        } catch (fileError) {
                            console.error('  ❌ 删除文件失败:', fileError.message);
                            
                            if (fileError.code === 403) {
                                console.log('  💡 需要设置 _File 表的 find 和 delete 权限');
                            }
                        }
                    }

                    // 删除学生记录
                    console.log('\n🗑️ 删除学生记录...');
                    await result.destroy();
                    console.log('✅ 学生记录已删除');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
                }

                // 更新本地数据
                students.splice(index, 1);
                updateStudentList();
                loadClassList();
                updateLabeledDescriptors();
                
                alert(fileDeleteCount > 0 
                    ? `删除成功！\n已删除学生：${student.name}\n已删除照片：${fileDeleteCount} 个`
                    : `删除成功！\n已删除学生：${student.name}`);
                
            } catch (error) {
                console.error('❌ 删除失败:', error);
                alert('删除失败：' + error.message);
            }
        }

        // Load students from LeanCloud  
        async function loadStudentsFromCloud() {  
            try {  
                console.log('📥 正在从云端加载学生数据...');  
                const query = new AV.Query('Student');  
                query.limit(1000);  
                const results = await query.find();  
                students = results.map(obj => ({  
                    className: obj.get('className'),  
                    studentId: obj.get('studentId'),  
                    name: obj.get('name'),  
                    photoUrl: obj.get('photoUrl'),  
                    faceDescriptor: obj.get('faceDescriptor')  
                }));  
                updateStudentList();  
                updateLabeledDescriptors();  
                loadClassList(); // 加载完学生后更新班级列表  
                console.log(`✅ 从云端加载了 ${students.length} 个学生`);  
            } catch (error) {  
                console.error('❌ 加载学生数据失败:', error);  
                alert('加载学生数据失败：' + error.message + '\n\n请检查网络连接和LeanCloud配置');  
            }  
        }  

        // Load class list for dropdown - 改为多选支持  
        function loadClassList() {  
            const select = document.getElementById('selectClass');  
            
            if (!select) {  
                console.error('❌ 找不到班级选择器元素');  
                return;  
            }  
            
            if (students.length === 0) {  
                console.warn('⚠️ 暂无学生数据，班级列表为空');  
                select.innerHTML = '<option value="" disabled>暂无班级（请先添加学生）</option>';  
                select.removeAttribute('multiple');  
                return;  
            }  
            
            const classes = [...new Set(students.map(s => s.className).filter(c => c))].sort();  
            
            if (classes.length === 0) {  
                console.warn('⚠️ 学生数据中没有班级信息');  
                select.innerHTML = '<option value="" disabled>暂无班级（学生数据缺少班级）</option>';  
                select.removeAttribute('multiple');  
                return;  
            }  
            
            // 设置为多选模式  
            select.setAttribute('multiple', 'multiple');  
            select.setAttribute('size', Math.min(classes.length + 1, 5)); // 显示最多5行  
            select.style.height = 'auto';  
            
            select.innerHTML = '<option value="" disabled>请选择一个或多个班级（按住Ctrl/Cmd可多选）</option>' +   
                classes.map(c => `<option value="${c}">${c}</option>`).join('');  
            
            console.log(`✅ 加载了 ${classes.length} 个班级:`, classes);  
        }  

        // ==================== 开始签到（完整版）====================
        async function startCheckIn() {
            try {
                console.log('🚀 准备开始签到...');

                // 获取表单数据（使用正确的ID）
                const courseName = document.getElementById('courseName').value.trim();
                const courseSession = document.getElementById('courseSession').value.trim();
                const selectClass = document.getElementById('selectClass');  // ✅ 正确的ID
                const duration = parseInt(document.getElementById('checkInDuration').value);  // ✅ 正确的ID

                console.log('📋 表单数据:', { courseName, courseSession, duration });

                // 验证必填字段
                if (!courseName) {
                    alert('❌ 请输入课程名称');
                    return;
                }

                if (!courseSession) {
                    alert('❌ 请输入课程节次');
                    return;
                }

                // 获取选中的班级
                const selectedOptions = Array.from(selectClass.selectedOptions);
                if (selectedOptions.length === 0) {
                    alert('❌ 请至少选择一个班级');
                    return;
                }
                const classNames = selectedOptions.map(opt => opt.value);
                console.log('👥 选中班级:', classNames);

                if (!duration || duration <= 0 || isNaN(duration)) {
                    alert('❌ 请输入有效的签到时长');
                    return;
                }

                // 获取选中班级的所有学生
                const selectedStudents = students.filter(s => 
                    classNames.includes(s.className)
                );

                if (selectedStudents.length === 0) {
                    alert('❌ 所选班级没有学生，请先导入学生名单');
                    return;
                }

                console.log('🎓 找到学生:', selectedStudents.length, '人');

                // 确认开始
                if (!confirm(`📋 确认签到信息：\n\n课程：${courseName}\n节次：${courseSession}\n班级：${classNames.join('、')}\n人数：${selectedStudents.length}人\n时长：${duration}分钟\n\n确定开始签到吗？`)) {
                    return;
                }

                console.log('💾 创建签到会话...');

                // 创建签到会话
                const CheckInSession = AV.Object.extend('CheckInSession');
                const session = new CheckInSession();

                session.set('courseName', courseName);
                session.set('courseSession', courseSession);
                session.set('className', classNames.join('、'));
                session.set('classNames', classNames);
                session.set('duration', duration);
                session.set('status', 'active');
                session.set('startTime', new Date());
                session.set('totalStudents', selectedStudents.length);
                session.set('checkedInCount', 0);

                const studentData = selectedStudents.map(s => ({
                    className: s.className,
                    studentId: s.studentId,
                    name: s.name
                }));
                session.set('students', studentData);

                await session.save();
                console.log('✅ 签到会话已保存，ID:', session.id);

                // 保存到全局变量
                currentCheckInSession = {
                    id: session.id,
                    courseName: courseName,
                    courseSession: courseSession,
                    classNames: classNames,
                    className: classNames.join('、'),
                    duration: duration,
                    startTime: new Date(),
                    students: studentData
                };

                checkedInStudents = [];
                previousUncheckedCount = selectedStudents.length;

                // 更新UI
                const setupPanel = document.getElementById('setupPanel');
                const checkInStatus = document.getElementById('checkInStatus');
                
                if (setupPanel) setupPanel.classList.add('hidden');
                if (checkInStatus) checkInStatus.classList.remove('hidden');

                // 更新课程信息（这些元素在你的HTML中不存在，需要添加）
                const currentCourse = document.getElementById('currentCourse');
                const currentClass = document.getElementById('currentClass');
                
                if (currentCourse) currentCourse.textContent = `${courseName} - ${courseSession}`;
                if (currentClass) currentClass.textContent = classNames.join('、');

                // 初始化功能
                updateWordCloud();
                updateProgress();
                updateCheckedInList();     // ✅ 显式初始化已签到列表
                updateUncheckedList();     // ✅ 显式初始化未签到列表
                startPolling();
                setupCountdown(duration);

                console.log('✅ 签到已开始');
                alert(`✅ 签到已开始！\n\n📚 课程：${courseName}\n📖 节次：${courseSession}\n👥 班级：${classNames.join('、')}\n🎯 人数：${selectedStudents.length}人\n⏱️ 时长：${duration}分钟\n\n学生现在可以开始签到了！`);

            } catch (error) {
                console.error('❌ 开始签到失败:', error);
                alert('开始签到失败：' + error.message);
            }
        }



        // ==================== 自动刷新控制 ====================
        let pollingInterval = null;

        function startPolling() {
            // 清除之前的轮询
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            // 每3秒刷新一次
            pollingInterval = setInterval(() => {
                if (currentCheckInSession && currentCheckInSession.id) {
                    refreshCheckInData();
                } else {
                    console.warn('⚠️ 没有活动会话，停止轮询');
                    stopPolling();
                }
            }, 3000);

            console.log('🔄 自动刷新已启动（每3秒）');
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('🛑 自动刷新已停止');
            }
        }

        // Refresh check-in data - 刷新签到数据
        // ==================== 刷新签到数据（带会话检查）====================
        async function refreshCheckInData() {
            try {
                console.log('🔄 开始刷新数据...');

                // ========== 第一步：检查云端是否有活动会话 ==========
                console.log('🔍 检查云端活动会话...');
                const query = new AV.Query('CheckInSession');
                query.equalTo('status', 'active');
                query.descending('createdAt');
                query.limit(1);
                
                const activeSession = await query.first();

                // 如果云端没有活动会话
                if (!activeSession) {
                    console.log('⚠️ 云端没有活动的签到会话');
                    
                    // 清空本地会话
                    currentCheckInSession = null;
                    checkedInStudents = [];
                    previousUncheckedCount = 0;
                    
                    // 停止轮询
                    if (typeof stopPolling === 'function') {
                        stopPolling();
                    }
                    
                    // 停止倒计时
                    if (typeof countdownInterval !== 'undefined' && countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                    
                    // 清理词云
                    if (typeof wordCloudChart !== 'undefined' && wordCloudChart) {
                        try {
                            wordCloudChart.dispose();
                            wordCloudChart = null;
                        } catch (err) {
                            console.warn('⚠️ 清理词云失败:', err);
                        }
                    }
                    
                    // 初始化页面：隐藏签到面板，显示设置面板
                    const setupPanel = document.getElementById('setupPanel');
                    const checkInStatus = document.getElementById('checkInStatus');
                    
                    if (checkInStatus) {
                        checkInStatus.classList.add('hidden');
                        console.log('✅ 已隐藏签到状态面板');
                    }
                    
                    if (setupPanel) {
                        setupPanel.classList.remove('hidden');
                        console.log('✅ 已显示设置面板');
                    }
                    
                    // 提示用户
                    alert('ℹ️ 当前没有进行中的签到会话\n\n页面已初始化，可以开始新的签到。');
                    console.log('✅ 页面已初始化');
                    return;
                }

                // ========== 第二步：云端有活动会话 ==========
                console.log('✅ 找到活动会话:', activeSession.id);

                // 检查本地会话是否与云端一致
                if (currentCheckInSession && currentCheckInSession.id !== activeSession.id) {
                    console.warn('⚠️ 本地会话与云端不一致，重新加载...');
                    
                    // 重新加载会话（调用 checkActiveSession）
                    if (typeof checkActiveSession === 'function') {
                        await checkActiveSession();
                        console.log('✅ 已重新加载会话');
                        return;
                    }
                }

                // 如果本地没有会话，加载云端会话
                if (!currentCheckInSession || !currentCheckInSession.id) {
                    console.log('⚠️ 本地没有会话，加载云端会话...');
                    
                    if (typeof checkActiveSession === 'function') {
                        await checkActiveSession();
                        console.log('✅ 已加载云端会话');
                        return;
                    }
                }

                // ========== 第三步：刷新签到记录 ==========
                console.log('🔄 刷新签到记录...');
                
                // 记录刷新前的人数
                const previousCount = checkedInStudents.length;

                // 查询签到记录
                const recordQuery = new AV.Query('CheckInRecord');
                recordQuery.equalTo('sessionId', currentCheckInSession.id);
                recordQuery.descending('checkInTime');
                recordQuery.limit(1000);
                
                const records = await recordQuery.find();
                console.log(`✅ 查询到 ${records.length} 条签到记录`);

                // 转换为普通对象数组
                checkedInStudents = records.map(obj => ({
                    className: obj.get('className'),
                    studentId: obj.get('studentId'),
                    name: obj.get('name'),
                    location: obj.get('location'),
                    checkInTime: obj.get('checkInTime')
                }));

                const newCount = checkedInStudents.length;
                const newCheckedIn = newCount - previousCount;

                if (newCheckedIn > 0) {
                    console.log(`✅ 新增 ${newCheckedIn} 人签到，总计 ${newCount} 人`);
                }

                // ========== 第四步：更新所有显示 ==========
                console.log('🎨 更新显示界面...');
                
                // 1. 更新词云
                try {
                    if (typeof updateWordCloud === 'function') {
                        updateWordCloud();
                        console.log('✅ 词云已更新');
                    }
                } catch (err) {
                    console.error('❌ 词云更新失败:', err);
                }

                // 2. 更新进度条
                try {
                    if (typeof updateProgress === 'function') {
                        updateProgress();
                        console.log('✅ 进度已更新');
                    }
                } catch (err) {
                    console.error('❌ 进度更新失败:', err);
                }

                // 3. 更新已签到列表
                try {
                    if (typeof updateCheckedInList === 'function') {
                        updateCheckedInList();
                        console.log('✅ 已签到列表已更新');
                    }
                } catch (err) {
                    console.error('❌ 已签到列表更新失败:', err);
                }

                // 4. 更新未签到列表
                try {
                    if (typeof updateUncheckedList === 'function') {
                        updateUncheckedList();
                        console.log('✅ 未签到列表已更新');
                    }
                } catch (err) {
                    console.error('❌ 未签到列表更新失败:', err);
                }

                // ========== 第五步：更新云端会话数据 ==========
                try {
                    const sessionQuery = new AV.Query('CheckInSession');
                    const session = await sessionQuery.get(currentCheckInSession.id);
                    session.set('checkedInCount', newCount);
                    await session.save();
                    console.log('✅ 云端会话数据已更新');
                } catch (error) {
                    console.warn('⚠️ 更新云端会话失败:', error);
                }

                // ========== 完成 ==========
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('✅ 数据刷新完成');
                console.log(`📊 签到情况: ${newCount}/${currentCheckInSession.students.length} 人已签到`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');

                // 显示刷新成功提示（短暂提示，不打断用户）
                showNotification(
                    '🔄 数据已刷新',
                    `已签到 ${newCount}/${currentCheckInSession.students.length} 人`
                );

            } catch (error) {
                console.error('❌ 刷新数据失败:', error);
                
                // 详细的错误提示
                let errorMessage = '刷新数据失败：\n\n';
                if (error.code === 101) {
                    errorMessage += '❌ 签到会话不存在或已被删除';
                } else if (error.code === 403) {
                    errorMessage += '❌ 权限不足，无法访问数据';
                } else if (error.code === 1) {
                    errorMessage += '❌ 网络连接失败，请检查网络';
                } else {
                    errorMessage += `❌ ${error.message || '未知错误'}`;
                }
                
                alert(errorMessage);
            }
        }

        // ==================== 更新已签到列表 ====================
        function updateCheckedInList() {
            const container = document.getElementById('checkedInList');
            if (!container) {
                console.warn('⚠️ 找不到已签到列表容器 (id="checkedInList")');
                return;
            }

            if (!currentCheckInSession || checkedInStudents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">📝</p>
                        <p class="text-sm">暂无签到记录</p>
                    </div>
                `;
                return;
            }

            // 按签到时间降序排列（最新的在前面）
            const sorted = [...checkedInStudents].sort((a, b) => 
                new Date(b.checkInTime) - new Date(a.checkInTime)
            );

            let html = '<div class="space-y-2">';
            
            sorted.forEach((student, index) => {
                const checkInTime = new Date(student.checkInTime);
                const timeStr = checkInTime.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                ${index + 1}
                            </span>
                            <div>
                                <p class="font-bold text-gray-800">${student.name}</p>
                                <p class="text-xs text-gray-600">
                                    ${student.className} | ${student.studentId}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">签到时间</p>
                            <p class="text-sm font-bold text-green-600">${timeStr}</p>
                            ${student.location ? `<p class="text-xs text-gray-400 mt-1">📍 ${student.location}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            console.log(`✅ 已签到列表已更新，显示 ${sorted.length} 人`);
        }


        // ==================== 更新未签到列表 ====================
        function updateUncheckedList() {
            const container = document.getElementById('uncheckedList');
            if (!container) {
                console.warn('⚠️ 找不到未签到列表容器 (id="uncheckedList")');
                return;
            }

            if (!currentCheckInSession || !currentCheckInSession.students) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">👥</p>
                        <p class="text-sm">暂无学生信息</p>
                    </div>
                `;
                return;
            }

            // 获取未签到的学生
            const checkedInIds = new Set(checkedInStudents.map(s => s.studentId));
            const uncheckedStudents = currentCheckInSession.students.filter(s => 
                !checkedInIds.has(s.studentId)
            );

            if (uncheckedStudents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-green-500">
                        <p class="text-6xl mb-3">🎉</p>
                        <p class="text-lg font-bold">全员已签到！</p>
                        <p class="text-sm mt-2">出勤率 100%</p>
                    </div>
                `;
                return;
            }

            // 按姓名排序
            const sorted = [...uncheckedStudents].sort((a, b) => 
                a.name.localeCompare(b.name, 'zh-CN')
            );

            let html = '<div class="space-y-2">';
            
            sorted.forEach((student, index) => {
                html += `
                    <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                ${index + 1}
                            </span>
                            <div>
                                <p class="font-bold text-gray-800">${student.name}</p>
                                <p class="text-xs text-gray-600">
                                    ${student.className} | ${student.studentId}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">
                                未签到
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            console.log(`✅ 未签到列表已更新，显示 ${sorted.length} 人`);
        }




        // ==================== 倒计时词云模块（完整版）====================
        
        let wordCloudChart = null; // ECharts实例
        let previousUncheckedCount = 0; // 用于检测变化

        function updateWordCloud() {
            const container = document.getElementById('wordCloudContainer');
            
            if (!container) {
                console.warn('⚠️ 词云容器不存在');
                return;
            }

            // 检查是否有签到会话
            if (!currentCheckInSession || !currentCheckInSession.students) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <p class="text-6xl mb-4">📊</p>
                            <p class="text-lg font-semibold">未开始签到</p>
                            <p class="text-sm mt-2">发布签到后将显示待签到学生</p>
                        </div>
                    </div>
                `;
                
                // 重置进度显示
                updateProgressBar(0, 0, 0);
                return;
            }

            // 获取所有应签到的学生
            const allStudents = currentCheckInSession.students || [];
            
            // 获取已签到的学生ID列表
            const checkedInIds = new Set(checkedInStudents.map(s => s.studentId));
            
            // 过滤出未签到的学生
            const uncheckedStudents = allStudents.filter(s => !checkedInIds.has(s.studentId));

            const totalCount = allStudents.length;
            const checkedCount = checkedInStudents.length;
            const uncheckedCount = uncheckedStudents.length;

            console.log(`📊 词云更新: 应到${totalCount}人, 已到${checkedCount}人, 未到${uncheckedCount}人`);

            // 更新进度条
            updateProgressBar(totalCount, checkedCount, uncheckedCount);

            // 如果全部签到完成
            if (uncheckedCount === 0 && totalCount > 0) {
                showCompletionAnimation(container);
                return;
            }

            // 转换为词云数据格式
            const wordCloudData = uncheckedStudents.map((student, index) => ({
                name: student.name || '未知',
                value: 10 + Math.random() * 5, // 随机权重，增加视觉变化
                studentId: student.studentId,
                className: student.className,
                index: index
            }));

            // 初始化或获取图表实例
            if (!wordCloudChart) {
                wordCloudChart = echarts.init(container);
                
                // 监听窗口大小变化
                window.addEventListener('resize', function() {
                    if (wordCloudChart) {
                        wordCloudChart.resize();
                    }
                });
            }

            // 计算颜色（根据剩余人数比例）
            const remainingRatio = uncheckedCount / totalCount;
            
            // 配置词云选项
            const option = {
                backgroundColor: {
                    type: 'linear',
                    x: 0, y: 0, x2: 1, y2: 1,
                    colorStops: [
                        { offset: 0, color: '#fff5f5' },
                        { offset: 1, color: '#fee2e2' }
                    ]
                },
                title: {
                    text: `还有 ${uncheckedCount} 人未签到`,
                    subtext: `点击查看学生详情`,
                    left: 'center',
                    top: 15,
                    textStyle: {
                        fontSize: 20,
                        fontWeight: 'bold',
                        color: remainingRatio > 0.5 ? '#f59e0b' : remainingRatio > 0.2 ? '#ef4444' : '#dc2626'
                    },
                    subtextStyle: {
                        fontSize: 12,
                        color: '#9ca3af'
                    }
                },
                tooltip: {
                    show: true,
                    formatter: function(params) {
                        return `
                            <div style="padding: 8px; min-width: 150px;">
                                <div style="font-size:18px; font-weight:bold; color:#dc2626; margin-bottom:8px; border-bottom: 2px solid #dc2626; padding-bottom:4px;">
                                    ${params.data.name}
                                </div>
                                <div style="color:#666; line-height:1.8;">
                                    <div>📚 班级: <strong>${params.data.className}</strong></div>
                                    <div>🎓 学号: <strong>${params.data.studentId}</strong></div>
                                    <div style="margin-top:8px; padding:4px 8px; background:#fee2e2; border-radius:4px; color:#dc2626; font-weight:bold; text-align:center;">
                                        ⚠️ 未签到
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#dc2626',
                    borderWidth: 2,
                    borderRadius: 8,
                    padding: 0,
                    textStyle: {
                        color: '#333'
                    },
                    extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.15);'
                },
                series: [{
                    type: 'wordCloud',
                    shape: 'circle',
                    
                    // 位置和大小
                    left: 'center',
                    top: 'center',
                    width: '90%',
                    height: '75%',
                    
                    // 文字大小范围（根据剩余人数动态调整）
                    sizeRange: uncheckedCount > 20 ? [16, 48] : uncheckedCount > 10 ? [20, 55] : [24, 65],
                    
                    // 旋转角度
                    rotationRange: [-30, 30],
                    rotationStep: 15,
                    
                    // 间距
                    gridSize: 12,
                    
                    drawOutOfBound: false,
                    
                    // 布局动画
                    layoutAnimation: true,
                    animationDuration: 1000,
                    animationEasing: 'cubicOut',
                    animationDelay: function(idx) {
                        return idx * 30;
                    },
                    
                    // 文字样式
                    textStyle: {
                        fontFamily: 'Microsoft YaHei, PingFang SC, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif',
                        fontWeight: 'bold',
                        color: function() {
                            // 根据剩余比例选择颜色方案
                            let colors;
                            if (remainingRatio > 0.5) {
                                // 剩余超过50% - 橙色系
                                colors = ['#f97316', '#fb923c', '#fdba74', '#fed7aa', '#ea580c', '#c2410c'];
                            } else if (remainingRatio > 0.2) {
                                // 剩余20%-50% - 红橙色系
                                colors = ['#ef4444', '#f87171', '#fca5a5', '#fb923c', '#dc2626', '#b91c1c'];
                            } else {
                                // 剩余少于20% - 深红色系
                                colors = ['#dc2626', '#b91c1c', '#991b1b', '#ef4444', '#7f1d1d', '#450a0a'];
                            }
                            return colors[Math.floor(Math.random() * colors.length)];
                        },
                        shadowBlur: 4,
                        shadowColor: 'rgba(220, 38, 38, 0.3)',
                        shadowOffsetX: 1,
                        shadowOffsetY: 1
                    },
                    
                    // 悬停效果
                    emphasis: {
                        focus: 'self',
                        textStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(220, 38, 38, 0.8)',
                            color: '#dc2626',
                            fontWeight: 'bolder',
                            textBorderColor: '#fff',
                            textBorderWidth: 2
                        }
                    },
                    
                    data: wordCloudData
                }]
            };

            // 设置配置项并触发动画
            wordCloudChart.setOption(option, true);

            // 检测是否有学生签到（词云减少）
            if (previousUncheckedCount > uncheckedCount && previousUncheckedCount > 0) {
                const newCheckedCount = previousUncheckedCount - uncheckedCount;
                console.log(`✅ ${newCheckedCount} 名学生签到`);
                playCheckInSound();
                showCheckInNotification(newCheckedCount, checkedCount);
            }

            previousUncheckedCount = uncheckedCount;

            console.log(`✅ 词云已更新，显示 ${uncheckedCount} 个未签到学生`);
        }

        // 更新进度条
        function updateProgressBar(total, checked, unchecked) {
            const progress = total > 0 ? Math.round((checked / total) * 100) : 0;
            
            // 更新待签到人数标签
            const countElement = document.getElementById('wordCloudCount');
            if (countElement) {
                countElement.textContent = `待签到: ${unchecked} 人`;
                // 根据人数变化颜色
                if (unchecked === 0) {
                    countElement.className = 'text-sm font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full';
                } else if (unchecked < total * 0.2) {
                    countElement.className = 'text-sm font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full';
                } else {
                    countElement.className = 'text-sm font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full';
                }
            }

            // 更新进度百分比
            const progressElement = document.getElementById('wordCloudProgress');
            if (progressElement) {
                progressElement.textContent = `${progress}%`;
            }

            // 更新进度条宽度
            const progressBar = document.getElementById('wordCloudProgressBar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }

            // 更新计数显示
            const checkedCountElement = document.getElementById('checkedCount');
            const uncheckedCountElement = document.getElementById('uncheckedCount');
            if (checkedCountElement) {
                checkedCountElement.textContent = `已签到: ${checked}`;
            }
            if (uncheckedCountElement) {
                uncheckedCountElement.textContent = `未签到: ${unchecked}`;
            }
        }

        // 显示完成动画
        function showCompletionAnimation(container) {
            // 销毁图表
            if (wordCloudChart) {
                wordCloudChart.dispose();
                wordCloudChart = null;
            }
            
            const total = currentCheckInSession.students.length;
            
            container.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center animate-scale-in">
                        <div class="text-8xl mb-4 animate-bounce" style="animation-duration: 0.6s;">🎉</div>
                        <h2 class="text-3xl font-bold text-green-600 mb-3 animate-fade-in">全员签到完成！</h2>
                        <p class="text-xl text-gray-700 mb-4 animate-fade-in" style="animation-delay: 0.2s;">
                            已签到 <span class="font-bold text-green-600">${total}</span> / ${total} 人
                        </p>
                        <div class="text-6xl animate-fade-in" style="animation-delay: 0.4s;">✅</div>
                        <p class="text-sm text-gray-500 mt-4 animate-fade-in" style="animation-delay: 0.6s;">
                            出勤率: <span class="font-bold text-green-600">100%</span>
                        </p>
                    </div>
                </div>
                
                <style>
                    @keyframes scale-in {
                        from {
                            transform: scale(0.5);
                            opacity: 0;
                        }
                        to {
                            transform: scale(1);
                            opacity: 1;
                        }
                    }
                    @keyframes fade-in {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    .animate-scale-in {
                        animation: scale-in 0.5s ease-out;
                    }
                    .animate-fade-in {
                        animation: fade-in 0.5s ease-out forwards;
                        opacity: 0;
                    }
                </style>
            `;
            
            // 播放完成音效
            playCompletionSound();
        }

        // 播放签到提示音
        function playCheckInSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
                console.log('🔔 播放签到提示音');
            } catch (error) {
                console.warn('⚠️ 音效播放失败:', error);
            }
        }

        // 播放完成音效
        function playCompletionSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 播放三个音符
                const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
                
                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    const startTime = audioContext.currentTime + index * 0.15;
                    gainNode.gain.setValueAtTime(0.2, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.3);
                });
                
                console.log('🎵 播放完成音效');
            } catch (error) {
                console.warn('⚠️ 音效播放失败:', error);
            }
        }

        // 显示签到通知
        function showCheckInNotification(newCount, totalChecked) {
            // 移除旧通知
            const oldNotification = document.querySelector('.check-in-notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'check-in-notification fixed top-20 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 transform transition-all duration-300';
            notification.style.animation = 'slideInRight 0.3s ease-out';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-3xl animate-bounce">✅</span>
                    <div>
                        <p class="font-bold text-lg">新签到 +${newCount}</p>
                        <p class="text-sm opacity-90">总计: ${totalChecked} 人已签到</p>
                    </div>
                </div>
                
                <style>
                    @keyframes slideInRight {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                </style>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后移除
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            console.log(`📢 显示通知: +${newCount} 人签到`);
        }

        // Update progress - 更新签到进度
        function updateProgress() {
            if (!currentCheckInSession || !currentCheckInSession.students) {
                return;
            }

            const total = currentCheckInSession.students.length;
            const checked = checkedInStudents.length;
            const unchecked = total - checked;
            const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;

            console.log(`📊 更新进度: ${checked}/${total} (${percentage}%)`);

            // 更新进度文本
            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = `${checked} / ${total} (${percentage}%)`;
            }

            // 更新进度条
            const progressBarFill = document.getElementById('progressBarFill');
            if (progressBarFill) {
                progressBarFill.style.width = `${percentage}%`;
            }

            // 更新统计数字
            const checkedCountElement = document.getElementById('checkedCount');
            if (checkedCountElement) {
                checkedCountElement.textContent = checked;
            }

            const uncheckedCountElement = document.getElementById('uncheckedCount');
            if (uncheckedCountElement) {
                uncheckedCountElement.textContent = unchecked;
            }

            // ✅ 同时更新列表显示
            updateCheckedInList();
            updateUncheckedList();
        }

        // ==================== 结束签到（带元素检查）====================
        async function endCheckIn() {
            // 检查是否有活动会话
            if (!currentCheckInSession || !currentCheckInSession.id) {
                alert('❌ 没有进行中的签到');
                return;
            }

            try {
                const total = currentCheckInSession.students ? currentCheckInSession.students.length : 0;
                const checked = checkedInStudents.length;
                const unchecked = total - checked;
                const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;

                // 确认结束
                if (!confirm(`🔚 确定要结束签到吗？\n\n应到：${total}人\n实到：${checked}人\n缺勤：${unchecked}人\n出勤率：${percentage}%\n\n结束后学生将无法继续签到！`)) {
                    console.log('❌ 用户取消结束签到');
                    return;
                }

                console.log('🛑 开始结束签到...');

                // ========== 第一步：最后刷新一次数据 ==========
                console.log('🔄 最后刷新数据...');
                try {
                    if (typeof refreshCheckInData === 'function') {
                        await refreshCheckInData();
                        console.log('✅ 数据刷新完成');
                    }
                } catch (err) {
                    console.warn('⚠️ 最后刷新失败:', err);
                }

                // 重新统计（刷新后可能有新的签到）
                const finalChecked = checkedInStudents.length;
                const finalUnchecked = total - finalChecked;
                const finalPercentage = total > 0 ? Math.round((finalChecked / total) * 100) : 0;

                // ========== 第二步：更新云端会话状态 ==========
                console.log('💾 更新会话状态...');
                try {
                    const query = new AV.Query('CheckInSession');
                    const session = await query.get(currentCheckInSession.id);

                    session.set('status', 'completed');
                    session.set('endTime', new Date());
                    session.set('checkedInCount', finalChecked);
                    session.set('absentCount', finalUnchecked);

                    // 保存完整签到结果
                    const results = currentCheckInSession.students.map(student => {
                        const checkedIn = checkedInStudents.find(c => c.studentId === student.studentId);
                        return {
                            studentId: student.studentId,
                            name: student.name,
                            className: student.className,
                            status: checkedIn ? 'present' : 'absent',
                            checkInTime: checkedIn ? checkedIn.checkInTime : null,
                            location: checkedIn ? checkedIn.location : null
                        };
                    });
                    session.set('results', results);

                    await session.save();
                    console.log('✅ 会话状态已更新为 completed');

                } catch (error) {
                    console.error('❌ 更新会话失败:', error);
                    throw new Error('保存签到结果失败：' + error.message);
                }

                // ========== 第三步：停止所有定时器 ==========
                console.log('🛑 停止定时器...');
                
                // 停止轮询
                if (typeof stopPolling === 'function') {
                    stopPolling();
                    console.log('✅ 自动刷新已停止');
                } else if (typeof pollingInterval !== 'undefined' && pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.log('✅ 轮询已停止');
                }

                // 停止倒计时
                if (typeof countdownInterval !== 'undefined' && countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    console.log('✅ 倒计时已停止');
                }

                // ========== 第四步：显示完成动画（可选）==========
                if (finalUnchecked === 0 && total > 0) {
                    console.log('🎉 全员签到完成！');
                    try {
                        if (typeof updateWordCloud === 'function') {
                            updateWordCloud();
                        }
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } catch (err) {
                        console.warn('⚠️ 完成动画失败:', err);
                    }
                }

                // ========== 第五步：清理UI（带元素检查）==========
                console.log('🧹 清理UI...');

                // 隐藏签到状态面板
                const checkInStatus = document.getElementById('checkInStatus');
                if (checkInStatus) {
                    checkInStatus.classList.add('hidden');
                    console.log('✅ 签到状态面板已隐藏');
                } else {
                    console.warn('⚠️ 找不到签到状态面板 (id="checkInStatus")');
                }

                // 显示设置面板
                const setupPanel = document.getElementById('setupPanel');
                if (setupPanel) {
                    setupPanel.classList.remove('hidden');
                    console.log('✅ 设置面板已显示');
                } else {
                    console.warn('⚠️ 找不到设置面板 (id="setupPanel")');
                }

                // ========== 第六步：清空全局变量 ==========
                console.log('🧹 清空全局变量...');
                currentCheckInSession = null;
                checkedInStudents = [];
                
                if (typeof previousUncheckedCount !== 'undefined') {
                    previousUncheckedCount = 0;
                }

                // ========== 第七步：清理词云 ==========
                console.log('🧹 清理词云...');
                if (typeof wordCloudChart !== 'undefined' && wordCloudChart) {
                    try {
                        wordCloudChart.dispose();
                        wordCloudChart = null;
                        console.log('✅ 词云已清理');
                    } catch (err) {
                        console.warn('⚠️ 清理词云失败:', err);
                    }
                }

                // 清空词云容器
                const wordCloudContainer = document.getElementById('wordCloudContainer');
                if (wordCloudContainer) {
                    wordCloudContainer.innerHTML = '';
                    console.log('✅ 词云容器已清空');
                }

                // ========== 第八步：清空列表显示 ==========
                console.log('🧹 清空列表...');
                
                const checkedInList = document.getElementById('checkedInList');
                if (checkedInList) {
                    checkedInList.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-4xl mb-2">📝</p>
                            <p class="text-sm">暂无签到记录</p>
                        </div>
                    `;
                }

                const uncheckedList = document.getElementById('uncheckedList');
                if (uncheckedList) {
                    uncheckedList.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-4xl mb-2">👥</p>
                            <p class="text-sm">暂无学生信息</p>
                        </div>
                    `;
                }

                // 重置计数显示
                const checkedCount = document.getElementById('checkedCount');
                if (checkedCount) checkedCount.textContent = '0';

                const uncheckedCount = document.getElementById('uncheckedCount');
                if (uncheckedCount) uncheckedCount.textContent = '0';

                // 重置进度条
                const progressBarFill = document.getElementById('progressBarFill');
                if (progressBarFill) progressBarFill.style.width = '0%';

                const progressText = document.getElementById('progressText');
                if (progressText) progressText.textContent = '0 / 0 (0%)';

                // 重置倒计时显示
                const countdown = document.getElementById('countdown');
                if (countdown) {
                    countdown.textContent = '⏱️ 准备中...';
                    countdown.className = 'text-lg font-bold text-green-600';
                }

                // ========== 完成 ==========
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('✅ 签到已结束');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');

                // 显示结果
                alert(`✅ 签到已结束！\n\n` +
                    `应到：${total}人\n` +
                    `实到：${finalChecked}人\n` +
                    `缺勤：${finalUnchecked}人\n` +
                    `出勤率：${finalPercentage}%\n\n` +
                    `签到结果已保存到云端。`);

                // 显示通知
                if (typeof showNotification === 'function') {
                    showNotification(
                        '✅ 签到已结束',
                        `出勤率 ${finalPercentage}% | ${finalChecked}/${total} 人已签到`
                    );
                }

            } catch (error) {
                console.error('❌ 结束签到失败:', error);
                
                // 详细的错误提示
                let errorMessage = '结束签到失败：\n\n';
                if (error.code === 101) {
                    errorMessage += '❌ 签到会话不存在或已被删除';
                } else if (error.code === 403) {
                    errorMessage += '❌ 权限不足，无法更新数据';
                } else if (error.code === 1) {
                    errorMessage += '❌ 网络连接失败，请检查网络';
                } else if (error.message) {
                    errorMessage += `❌ ${error.message}`;
                } else {
                    errorMessage += '❌ 未知错误';
                }
                
                if (error.code) {
                    errorMessage += `\n\n错误代码：${error.code}`;
                }
                
                alert(errorMessage);
            }
        }

        // Export to Excel - Enhanced version  
        async function exportToExcel() {  
            if (!currentCheckInSession || !currentCheckInSession.id) {  
                alert('❌ 当前没有签到任务');  
                return;  
            }  

            try {  
                // Force refresh data before export  
                await refreshCheckInData();  

                const total = currentCheckInSession.students.length;  
                const checked = checkedInStudents.length;  
                const absent = total - checked;  

                // Main data sheet  
                const data = currentCheckInSession.students.map((s, index) => {  
                    const checkedIn = checkedInStudents.find(c => c.studentId === s.studentId);  
                    return {  
                        '序号': index + 1,  
                        '班级': s.className,  
                        '学号': s.studentId,  
                        '姓名': s.name,  
                        '签到状态': checkedIn ? '✓ 已签到' : '✗ 未签到',  
                        '签到时间': checkedIn ? new Date(checkedIn.checkInTime).toLocaleString('zh-CN', {  
                            year: 'numeric',  
                            month: '2-digit',  
                            day: '2-digit',  
                            hour: '2-digit',  
                            minute: '2-digit',  
                            second: '2-digit'  
                        }) : '',  
                        '定位信息': checkedIn ? checkedIn.location : ''  
                    };  
                });  

                const ws = XLSX.utils.json_to_sheet(data);  
                
                // Set column widths  
                ws['!cols'] = [  
                    { wch: 6 },  // 序号  
                    { wch: 20 }, // 班级  
                    { wch: 12 }, // 学号  
                    { wch: 10 }, // 姓名  
                    { wch: 12 }, // 签到状态  
                    { wch: 20 }, // 签到时间  
                    { wch: 40 }  // 定位信息  
                ];  

                const wb = XLSX.utils.book_new();  
                XLSX.utils.book_append_sheet(wb, ws, '签到记录');  

                // Summary sheet  
                const summary = [  
                    ['签到统计报表'],  
                    [''],  
                    ['课程名称', currentCheckInSession.courseName],  
                    ['课程节次', currentCheckInSession.courseSession],  
                    ['班级', currentCheckInSession.className],  
                    ['开始时间', new Date(currentCheckInSession.startTime).toLocaleString('zh-CN')],  
                    ['结束时间', currentCheckInSession.status === 'completed' ? new Date().toLocaleString('zh-CN') : '进行中'],  
                    [''],  
                    ['应到人数', total],  
                    ['实到人数', checked],  
                    ['缺勤人数', absent],  
                    ['出勤率', `${(checked/total*100).toFixed(2)}%`],  
                    [''],  
                    ['导出时间', new Date().toLocaleString('zh-CN')]  
                ];  
                
                const ws2 = XLSX.utils.aoa_to_sheet(summary);  
                ws2['!cols'] = [{ wch: 15 }, { wch: 30 }];  
                XLSX.utils.book_append_sheet(wb, ws2, '统计摘要');  

                // Absent students sheet  
                const absentStudents = currentCheckInSession.students.filter(  
                    s => !checkedInStudents.find(c => c.studentId === s.studentId)  
                );  
                
                if (absentStudents.length > 0) {  
                    const absentData = absentStudents.map((s, index) => ({  
                        '序号': index + 1,  
                        '班级': s.className,  
                        '学号': s.studentId,  
                        '姓名': s.name  
                    }));  
                    const ws3 = XLSX.utils.json_to_sheet(absentData);  
                    ws3['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 12 }, { wch: 10 }];  
                    XLSX.utils.book_append_sheet(wb, ws3, '缺勤名单');  
                }  

                // Generate filename  
                const now = new Date();  
                const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;  
                const timeStr = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;  
                const filename = `${currentCheckInSession.courseName}_${dateStr}_${timeStr}.xlsx`;  
                
                XLSX.writeFile(wb, filename);  
                
                alert(`✅ Excel导出成功！\n\n文件名：${filename}\n\n包含内容：\n✓ 签到记录（全部学生）\n✓ 统计摘要\n${absentStudents.length > 0 ? '✓ 缺勤名单' : ''}\n\n共 ${total} 人，已签到 ${checked} 人`);  
            } catch (error) {  
                console.error('导出失败:', error);  
                alert('❌ 导出失败：' + error.message);  
            }  
        }  

        // View history sessions - 修复版
        async function viewHistory() {
            try {
                const query = new AV.Query('CheckInSession');
                query.descending('createdAt');
                query.limit(50);
                const sessions = await query.find();

                if (sessions.length === 0) {
                    alert('暂无历史记录');
                    return;
                }

                const historyList = document.getElementById('historyList');
                historyList.innerHTML = sessions.map((session, index) => {
                    const courseName = session.get('courseName') || '未命名课程';
                    const courseSession = session.get('courseSession') || '未知节次';
                    const className = session.get('className') || '未知班级';
                    const startTime = session.get('startTime') || session.createdAt;
                    const status = session.get('status') || 'unknown';
                    const totalStudents = session.get('totalStudents') || 0;
                    const checkedInCount = session.get('checkedInCount') || 0;
                    
                    // 验证数据完整性
                    const isValid = courseName !== '未命名课程' && startTime;
                    
                    // 计算出勤率
                    const attendanceRate = totalStudents > 0 ? (checkedInCount / totalStudents * 100).toFixed(1) : 0;

                    // 格式化时间
                    let formattedTime = 'Invalid Date';
                    try {
                        if (startTime) {
                            formattedTime = new Date(startTime).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    } catch (e) {
                        console.error('时间格式化错误:', e);
                    }

                    // 如果是无效数据，显示警告样式
                    const invalidStyle = !isValid ? 'bg-red-50 border-red-300' : '';
                    const invalidBadge = !isValid ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded ml-2">⚠️ 数据异常</span>' : '';

                    return `
                        <div class="border rounded-lg p-4 hover:bg-gray-50 ${status === 'active' ? 'border-green-500 bg-green-50' : 'border-gray-300'} ${invalidStyle}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-lg">${courseName} - ${courseSession}${invalidBadge}</h3>
                                    <p class="text-gray-600 text-sm">班级：${className}</p>
                                    <p class="text-gray-600 text-sm">时间：${formattedTime}</p>
                                    ${!isValid ? '<p class="text-red-600 text-xs mt-1">⚠️ 该记录可能是学生误操作创建，建议删除</p>' : ''}
                                </div>
                                <span class="px-3 py-1 rounded text-sm ${status === 'active' ? 'bg-green-600 text-white' : 'bg-gray-500 text-white'}">
                                    ${status === 'active' ? '进行中' : '已结束'}
                                </span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-sm mb-3">
                                <div class="bg-blue-50 p-2 rounded text-center">
                                    <p class="text-gray-600">应到</p>
                                    <p class="font-bold text-blue-600">${totalStudents}</p>
                                </div>
                                <div class="bg-green-50 p-2 rounded text-center">
                                    <p class="text-gray-600">实到</p>
                                    <p class="font-bold text-green-600">${checkedInCount}</p>
                                </div>
                                <div class="bg-red-50 p-2 rounded text-center">
                                    <p class="text-gray-600">缺勤</p>
                                    <p class="font-bold text-red-600">${totalStudents - checkedInCount}</p>
                                </div>
                                <div class="bg-purple-50 p-2 rounded text-center">
                                    <p class="text-gray-600">出勤率</p>
                                    <p class="font-bold text-purple-600">${attendanceRate}%</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${isValid && status === 'completed' ? `
                                    <button onclick="exportHistorySession('${session.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex-1">
                                        📥 导出Excel
                                    </button>
                                ` : ''}
                                <button onclick="deleteHistorySession('${session.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 ${!isValid ? 'flex-1' : ''}">
                                    🗑️ 删除${!isValid ? '异常记录' : ''}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // 更新历史记录计数
                updateHistoryCount();

                document.getElementById('checkInStatus').classList.add('hidden');
                document.getElementById('historyPanel').classList.remove('hidden');
                
                console.log(`✅ 显示 ${sessions.length} 条历史记录`);
                
            } catch (error) {
                console.error('❌ 加载历史记录失败:', error);
                alert(`❌ 加载历史记录失败：${error.message}`);
            }
        }
        // Hide history panel  
        function hideHistory() {  
            document.getElementById('historyPanel').classList.add('hidden');  
            if (currentCheckInSession) {  
                document.getElementById('checkInStatus').classList.remove('hidden');  
            }  
        }  

        // Delete history session  
        async function deleteHistorySession(sessionId) {  
            if (!confirm('⚠️ 确定删除此签到记录吗？\n\n删除后将无法恢复，包括：\n• 签到会话信息\n• 所有签到记录\n\n建议先导出Excel再删除！')) {  
                return;  
            }  

            try {  
                // Delete check-in records first  
                const recordQuery = new AV.Query('CheckInRecord');  
                recordQuery.equalTo('sessionId', sessionId);  
                recordQuery.limit(1000);  
                const records = await recordQuery.find();  
                
                if (records.length > 0) {  
                    await AV.Object.destroyAll(records);  
                    console.log(`✅ 删除了 ${records.length} 条签到记录`);  
                }  

                // Delete session  
                const sessionQuery = new AV.Query('CheckInSession');  
                const session = await sessionQuery.get(sessionId);  
                await session.destroy();  

                alert(`✅ 删除成功！\n\n已删除签到会话及其 ${records.length} 条签到记录`);  
                
                // Refresh history list  
                viewHistory();  
            } catch (error) {  
                console.error('删除失败:', error);  
                alert('❌ 删除失败：' + error.message);  
            }  
        }  

        // Export history session  
        async function exportHistorySession(sessionId) {  
            try {  
                // Get session info  
                const query = new AV.Query('CheckInSession');  
                const session = await query.get(sessionId);  

                const courseName = session.get('courseName');  
                const courseSession = session.get('courseSession');  
                const className = session.get('className');  
                const startTime = session.get('startTime');  
                const endTime = session.get('endTime');  
                const results = session.get('results') || [];  

                if (results.length === 0) {  
                    alert('❌ 该签到记录无详细数据');  
                    return;  
                }  

                // Main data sheet  
                const data = results.map((r, index) => ({  
                    '序号': index + 1,
                    '班级': r.className,
                    '学号': r.studentId,
                    '姓名': r.name,
                    '签到状态': r.status === 'present' ? '✓ 已签到' : '✗ 未签到',
                    '签到时间': r.checkInTime ? new Date(r.checkInTime).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }) : '',
                    '定位信息': r.location || ''
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 6 },  // 序号
                    { wch: 20 }, // 班级
                    { wch: 12 }, // 学号
                    { wch: 10 }, // 姓名
                    { wch: 12 }, // 签到状态
                    { wch: 20 }, // 签到时间
                    { wch: 40 }  // 定位信息
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '签到记录');

                // Summary sheet
                const totalStudents = results.length;
                const checkedInCount = results.filter(r => r.status === 'present').length;
                const absentCount = totalStudents - checkedInCount;

                const summary = [
                    ['签到统计报表'],
                    [''],
                    ['课程名称', courseName],
                    ['课程节次', courseSession],
                    ['班级', className],
                    ['开始时间', new Date(startTime).toLocaleString('zh-CN')],
                    ['结束时间', endTime ? new Date(endTime).toLocaleString('zh-CN') : '未记录'],
                    [''],
                    ['应到人数', totalStudents],
                    ['实到人数', checkedInCount],
                    ['缺勤人数', absentCount],
                    ['出勤率', `${(checkedInCount/totalStudents*100).toFixed(2)}%`],
                    [''],
                    ['导出时间', new Date().toLocaleString('zh-CN')]
                ];
                
                const ws2 = XLSX.utils.aoa_to_sheet(summary);
                ws2['!cols'] = [{ wch: 15 }, { wch: 30 }];
                XLSX.utils.book_append_sheet(wb, ws2, '统计摘要');

                // Absent students sheet
                const absentStudents = results.filter(r => r.status === 'absent');
                
                if (absentStudents.length > 0) {
                    const absentData = absentStudents.map((s, index) => ({
                        '序号': index + 1,
                        '班级': s.className,
                        '学号': s.studentId,
                        '姓名': s.name
                    }));
                    const ws3 = XLSX.utils.json_to_sheet(absentData);
                    ws3['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 12 }, { wch: 10 }];
                    XLSX.utils.book_append_sheet(wb, ws3, '缺勤名单');
                }

                // Generate filename
                const now = new Date();
                const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
                const timeStr = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
                const filename = `${courseName}_${dateStr}_${timeStr}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                alert(`✅ 历史记录导出成功！\n\n文件名：${filename}\n\n包含内容：\n✓ 签到记录（全部学生）\n✓ 统计摘要\n${absentStudents.length > 0 ? '✓ 缺勤名单' : ''}\n\n共 ${totalStudents} 人，已签到 ${checkedInCount} 人`);
            } catch (error) {
                console.error('导出历史记录失败:', error);
                alert('❌ 导出失败：' + error.message);
            }
        }

        // 更新历史记录计数
        async function updateHistoryCount() {
            try {
                const query = new AV.Query('CheckInSession');
                const count = await query.count();
                const countElement = document.getElementById('historyCount');
                if (countElement) {
                    countElement.textContent = count;
                }
                console.log(`✅ 历史记录数量: ${count}`);
            } catch (error) {
                console.error('获取历史记录数量失败:', error);
            }
        }

        // ==================== 检查活动会话（完整版）====================
        async function checkActiveSession() {
            try {
                console.log('🔍 检查活动签到会话...');

                // 查询活动的签到会话
                const query = new AV.Query('CheckInSession');
                query.equalTo('status', 'active');
                query.descending('createdAt');
                query.limit(1);
                
                const activeSession = await query.first();

                if (!activeSession) {
                    console.log('ℹ️ 未发现活动的签到会话');
                    
                    // 确保显示设置面板
                    const setupPanel = document.getElementById('setupPanel');
                    const checkInStatus = document.getElementById('checkInStatus');
                    if (setupPanel) setupPanel.classList.remove('hidden');
                    if (checkInStatus) checkInStatus.classList.add('hidden');
                    
                    return;
                }

                console.log('✅ 发现活动会话:', activeSession.id);

                // 恢复会话信息
                const classNames = activeSession.get('classNames') || [activeSession.get('className')];
                const students = activeSession.get('students') || [];
                
                currentCheckInSession = {
                    id: activeSession.id,
                    courseName: activeSession.get('courseName') || '未知课程',
                    courseSession: activeSession.get('courseSession') || '未知节次',
                    classNames: classNames,
                    className: classNames.join('、'),
                    duration: activeSession.get('duration') || 30,
                    requireLocation: activeSession.get('requireLocation') || false,
                    startTime: activeSession.get('startTime') || new Date(),
                    status: 'active',
                    students: students,
                    totalStudents: students.length
                };

                console.log('✅ 会话信息已恢复:', currentCheckInSession);

                // 加载签到记录
                console.log('📥 加载签到记录...');
                try {
                    const recordQuery = new AV.Query('CheckInRecord');
                    recordQuery.equalTo('sessionId', activeSession.id);
                    recordQuery.descending('checkInTime');
                    recordQuery.limit(1000);
                    
                    const records = await recordQuery.find();
                    console.log(`✅ 找到 ${records.length} 条签到记录`);
                    
                    // 转换为普通对象数组
                    checkedInStudents = records.map(obj => ({
                        className: obj.get('className'),
                        studentId: obj.get('studentId'),
                        name: obj.get('name'),
                        location: obj.get('location'),
                        checkInTime: obj.get('checkInTime')
                    }));
                    
                    console.log('✅ 签到记录已加载:', checkedInStudents.length, '人');
                    
                } catch (recordError) {
                    console.error('❌ 加载签到记录失败:', recordError);
                    checkedInStudents = [];
                }

                // 恢复UI状态
                console.log('🎨 恢复UI状态...');
                
                const setupPanel = document.getElementById('setupPanel');
                const checkInStatus = document.getElementById('checkInStatus');
                
                if (setupPanel) setupPanel.classList.add('hidden');
                if (checkInStatus) checkInStatus.classList.remove('hidden');

                // 更新课程信息显示
                const currentCourse = document.getElementById('currentCourse');
                const currentClass = document.getElementById('currentClass');
                
                if (currentCourse) {
                    currentCourse.textContent = `${currentCheckInSession.courseName} - ${currentCheckInSession.courseSession}`;
                    console.log('✅ 课程信息已显示');
                }

                if (currentClass) {
                    currentClass.textContent = currentCheckInSession.className;
                    console.log('✅ 班级信息已显示');
                }

                // 初始化词云计数器
                if (typeof previousUncheckedCount !== 'undefined') {
                    previousUncheckedCount = students.length;
                    console.log('✅ 词云计数器已初始化:', previousUncheckedCount);
                }

                // ========== 初始化所有显示功能 ==========
                console.log('📊 初始化显示功能...');
                
                // 1. 更新词云
                try {
                    if (typeof updateWordCloud === 'function') {
                        updateWordCloud();
                        console.log('✅ 词云已初始化');
                    }
                } catch (error) {
                    console.error('❌ 词云初始化失败:', error);
                }

                // 2. 更新进度条
                try {
                    if (typeof updateProgress === 'function') {
                        updateProgress();
                        console.log('✅ 进度显示已初始化');
                    }
                } catch (error) {
                    console.error('❌ 进度显示初始化失败:', error);
                }

                // 3. ✅ 更新已签到列表
                try {
                    if (typeof updateCheckedInList === 'function') {
                        updateCheckedInList();
                        console.log('✅ 已签到列表已初始化');
                    } else {
                        console.warn('⚠️ updateCheckedInList 函数不存在');
                    }
                } catch (error) {
                    console.error('❌ 已签到列表初始化失败:', error);
                }

                // 4. ✅ 更新未签到列表
                try {
                    if (typeof updateUncheckedList === 'function') {
                        updateUncheckedList();
                        console.log('✅ 未签到列表已初始化');
                    } else {
                        console.warn('⚠️ updateUncheckedList 函数不存在');
                    }
                } catch (error) {
                    console.error('❌ 未签到列表初始化失败:', error);
                }

                // 5. 开始定时刷新
                console.log('🔄 启动自动刷新...');
                if (typeof startPolling === 'function') {
                    startPolling();
                } else {
                    console.warn('⚠️ startPolling 函数不存在');
                }

                // 6. 恢复倒计时
                console.log('⏱️ 恢复倒计时...');
                try {
                    const startTime = new Date(currentCheckInSession.startTime);
                    const now = new Date();
                    const elapsed = Math.floor((now - startTime) / 1000); // 已过秒数
                    const totalSeconds = currentCheckInSession.duration * 60; // 总秒数
                    const remainingSeconds = Math.max(0, totalSeconds - elapsed); // 剩余秒数
                    const remainingMinutes = Math.ceil(remainingSeconds / 60); // 剩余分钟

                    console.log('⏱️ 时间计算:', {
                        开始时间: startTime.toLocaleString('zh-CN'),
                        当前时间: now.toLocaleString('zh-CN'),
                        已过秒数: elapsed,
                        剩余秒数: remainingSeconds,
                        剩余分钟: remainingMinutes
                    });

                    if (remainingSeconds > 0) {
                        if (typeof setupCountdown === 'function') {
                            setupCountdown(remainingMinutes);
                            console.log(`✅ 倒计时已恢复，剩余 ${remainingMinutes} 分钟`);
                        }
                    } else {
                        console.warn('⚠️ 签到时间已到');
                        const countdownElement = document.getElementById('countdown');
                        if (countdownElement) {
                            countdownElement.textContent = '⏰ 签到时间已到';
                            countdownElement.className = 'text-red-600 font-bold';
                        }
                    }
                } catch (error) {
                    console.error('❌ 倒计时恢复失败:', error);
                }

                // 显示恢复成功通知
                console.log('✅ 签到会话已成功恢复');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('📊 当前状态:');
                console.log('  课程:', currentCheckInSession.courseName);
                console.log('  节次:', currentCheckInSession.courseSession);
                console.log('  班级:', currentCheckInSession.className);
                console.log('  应到:', currentCheckInSession.totalStudents, '人');
                console.log('  实到:', checkedInStudents.length, '人');
                console.log('  未到:', currentCheckInSession.totalStudents - checkedInStudents.length, '人');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');

                // 显示轻提示（不打断用户）
                showNotification(
                    '✅ 签到会话已恢复',
                    `${currentCheckInSession.courseName} - 已签到 ${checkedInStudents.length}/${currentCheckInSession.totalStudents} 人`
                );

            } catch (error) {
                console.error('❌ 检查活动会话失败:', error);
                
                // 详细的错误信息
                if (error.code === 101) {
                    console.warn('⚠️ CheckInSession 表不存在');
                } else if (error.code === 403) {
                    console.error('❌ 权限不足，无法查询签到会话');
                } else if (error.code === 1) {
                    console.error('❌ 网络连接失败');
                } else {
                    console.error('❌ 未知错误:', error.message);
                }

                // 确保显示设置面板（失败时的默认状态）
                const setupPanel = document.getElementById('setupPanel');
                const checkInStatus = document.getElementById('checkInStatus');
                if (setupPanel) setupPanel.classList.remove('hidden');
                if (checkInStatus) checkInStatus.classList.add('hidden');
            }
        }

        // ==================== 辅助函数：显示通知 ====================
        function showNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-xl">✅</span>
                    <div>
                        <p class="font-bold">${title}</p>
                        <p class="text-sm opacity-90">${message}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s, transform 0.3s';
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== 页面加载时自动执行 ====================
        window.addEventListener('load', function() {
            console.log('📄 页面已加载');
            console.log('🔍 自动检查活动会话...');
            
            // 延迟100ms执行，确保DOM完全就绪
            setTimeout(() => {
                checkActiveSession();
            }, 100);
        });

        // ==================== 页面可见时刷新 ====================
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('👀 页面已可见');
                
                // 如果有活动会话，刷新数据
                if (currentCheckInSession && currentCheckInSession.id) {
                    console.log('🔄 刷新签到数据...');
                    if (typeof refreshCheckInData === 'function') {
                        refreshCheckInData();
                    }
                }
            }
        });

        // ==================== 手机端定位（简洁版）====================
        
        function getLocation() {
            const locationBtn = document.getElementById('locationBtn');
            const locationInput = document.getElementById('location');
            
            locationBtn.disabled = true;
            locationBtn.textContent = '🔄 定位中...';
            locationInput.value = '📍 正在获取手机定位，请稍候...';

            // 检查浏览器是否支持定位
            if (!navigator.geolocation) {
                locationInput.value = '您的设备不支持定位（可继续签到）';
                locationBtn.disabled = false;
                locationBtn.textContent = '❌ 不支持定位';
                alert('⚠️ 您的设备不支持定位功能\n\n您仍可继续签到');
                return;
            }

            // 使用手机GPS定位
            navigator.geolocation.getCurrentPosition(
                // 定位成功
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);
                    
                    console.log('✅ 定位成功:', { lat, lng, accuracy });
                    
                    // 先显示基础信息
                    locationInput.value = `📍 定位成功！精度±${accuracy}米\n正在解析地址...`;
                    
                    // 解析详细地址
                    try {
                        const response = await fetch(
                            `https://restapi.amap.com/v3/geocode/regeo?key=b6941653e924ebda799872dd5f5e4f29&location=${lng},${lat}&extensions=all`
                        );
                        const data = await response.json();
                        
                        if (data.status === '1' && data.regeocode) {
                            let address = data.regeocode.formatted_address || '未知地址';
                            
                            // 添加附近地标
                            if (data.regeocode.pois && data.regeocode.pois.length > 0) {
                                const poi = data.regeocode.pois[0];
                                address += `\n📍 ${poi.name}`;
                            }
                            
                            locationInput.value = `${address}\n坐标: ${lat.toFixed(6)}, ${lng.toFixed(6)}\n精度: ±${accuracy}米`;
                            console.log('✅ 地址解析成功:', address);
                        } else {
                            // 地址解析失败，只显示坐标
                            locationInput.value = `坐标: ${lat.toFixed(6)}, ${lng.toFixed(6)}\n精度: ±${accuracy}米`;
                            console.warn('⚠️ 地址解析失败，仅显示坐标');
                        }
                    } catch (error) {
                        // 网络错误，只显示坐标
                        console.error('❌ 地址解析出错:', error);
                        locationInput.value = `坐标: ${lat.toFixed(6)}, ${lng.toFixed(6)}\n精度: ±${accuracy}米`;
                    }
                    
                    // 更新按钮状态
                    locationBtn.disabled = false;
                    locationBtn.textContent = '✅ 定位成功';
                    locationBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                    locationBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    
                    // 震动反馈
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                },
                
                // 定位失败
                (error) => {
                    console.error('❌ 定位失败:', error);
                    
                    let errorMsg = '';
                    let suggestion = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '定位权限被拒绝';
                            suggestion = '请在手机设置中允许浏览器使用定位';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'GPS信号不可用';
                            suggestion = '请移动到室外或窗边，确保GPS已开启';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '定位超时';
                            suggestion = '请确保GPS已开启，或移动到信号较好的地方';
                            break;
                        default:
                            errorMsg = '定位失败';
                            suggestion = '请检查定位权限和GPS是否开启';
                    }
                    
                    locationInput.value = `${errorMsg}（可继续签到）`;
                    
                    locationBtn.disabled = false;
                    locationBtn.textContent = '📍 重新定位';
                    locationBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    locationBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
                    
                    // 友好的错误提示
                    alert(`⚠️ ${errorMsg}\n\n💡 ${suggestion}\n\n您仍可继续签到，系统将记录"${errorMsg}"`);
                    
                    // 震动提示
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }
                },
                
                // 定位选项
                {
                    enableHighAccuracy: true,    // 使用GPS高精度
                    timeout: 20000,              // 20秒超时（手机GPS一般够用）
                    maximumAge: 10000            // 允许使用10秒内的缓存
                }
            );
        }



        // Open camera for face recognition
        async function openCamera() {
            if (!faceModelsLoaded) {
                alert('人脸识别模型加载中，请稍候...');
                return;
            }

            if (labeledDescriptors.length === 0) {
                alert('❌ 系统中还没有学生人脸数据！\n\n请先在教师端添加学生照片信息');
                return;
            }

            try {
                recognitionSuccess = false; // 重置识别成功标志
                document.getElementById('cameraBtn').disabled = true;
                document.getElementById('cameraBtn').textContent = '正在打开相机...';

                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                
                const video = document.getElementById('video');
                const canvas = document.getElementById('faceCanvas');
                video.srcObject = videoStream;
                video.classList.remove('hidden');
                canvas.classList.remove('hidden');
                document.getElementById('videoPlaceholder').classList.add('hidden');
                document.getElementById('recognitionStatus').classList.remove('hidden');
                document.getElementById('recognitionStatus').innerHTML = 
                    '<p class="text-blue-800 font-semibold">🔍 正在识别人脸，请正对摄像头保持2-3秒...</p>';

                document.getElementById('cameraBtn').textContent = '🔴 关闭相机';
                document.getElementById('cameraBtn').onclick = stopCamera;
                document.getElementById('cameraBtn').disabled = false;

                // Start face detection after video loaded
                video.addEventListener('loadeddata', () => {
                    faceDetectionRunning = true;
                    detectFaceLoop();
                });
            } catch (error) {
                console.error('相机错误:', error);
                alert('❌ 无法打开相机：' + error.message + '\n\n请确保：\n✓ 已授予摄像头权限\n✓ 没有其他程序占用摄像头\n✓ 使用HTTPS访问（localhost除外）');
                document.getElementById('cameraBtn').disabled = false;
                document.getElementById('cameraBtn').textContent = '📷 打开相机（人脸识别）';
            }
        }


        // ==================== 人脸检测循环（完整优化版）====================
        async function detectFaceLoop() {
            // 如果检测已停止，退出循环
            if (!faceDetectionRunning) {
                console.log('🛑 人脸检测循环已停止');
                return;
            }

            const video = document.getElementById('video');
            const canvas = document.getElementById('faceCanvas');
            const statusElement = document.getElementById('recognitionStatus');
            
            // 检查视频流是否有效
            if (!video || !video.srcObject) {
                console.error('❌ 视频流无效，停止检测');
                faceDetectionRunning = false;
                if (statusElement) {
                    statusElement.innerHTML = '<p class="text-red-600 font-semibold">❌ 摄像头连接失败</p>';
                }
                return;
            }

            const ctx = canvas.getContext('2d');

            try {
                // ========== 第一步：检测人脸 ==========
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ 
                        inputSize: 416, 
                        scoreThreshold: 0.5 
                    }))
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                // 清空画布
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // ========== 第二步：处理检测结果 ==========
                if (detections.length > 0) {
                    console.log(`✅ 检测到 ${detections.length} 个人脸`);

                    // 调整Canvas尺寸以匹配视频
                    const displaySize = { width: video.videoWidth, height: video.videoHeight };
                    canvas.width = displaySize.width;
                    canvas.height = displaySize.height;

                    // 调整检测结果尺寸
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);

                    // 绘制检测框和关键点
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

                    // ========== 第三步：人脸识别匹配 ==========
                    if (!labeledDescriptors || labeledDescriptors.length === 0) {
                        // 没有加载人脸库
                        if (statusElement && !recognitionSuccess) {
                            statusElement.innerHTML = 
                                '<p class="text-red-600 font-semibold">❌ 人脸库未加载，无法识别<br/><small>请刷新页面重试</small></p>';
                        }
                    } else {
                        // 创建人脸匹配器（阈值0.65，距离小于此值视为匹配）
                        const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.65);
                        const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                        // 调试输出
                        console.log('━━━━━━━━━━━━━━━━━━━━');
                        results.forEach((r, idx) => {
                            console.log(`人脸${idx + 1}: ${r.label} | 距离: ${r.distance.toFixed(3)} | ${r.label !== 'unknown' ? '✅匹配' : '❌未匹配'}`);
                        });
                        console.log('━━━━━━━━━━━━━━━━━━━━');

                        // ========== 第四步：处理识别结果 ==========
                        let hasMatched = false; // 本轮是否有匹配成功
                        let minDistance = Infinity; // 最小距离

                        results.forEach((result, i) => {
                            const box = resizedDetections[i].detection.box;
                            const distance = result.distance;
                            minDistance = Math.min(minDistance, distance);

                            if (result.label !== 'unknown') {
                                // ========== 识别成功 ==========
                                hasMatched = true;

                                // 解析学生信息
                                const parts = result.label.split('|');
                                const studentId = parts[0] || '';
                                const name = parts[1] || '未知';
                                const className = parts[2] || '';

                                const confidence = ((1 - distance) * 100).toFixed(1);

                                // 绘制绿色识别框
                                const drawBox = new faceapi.draw.DrawBox(box, { 
                                    label: `${name} (${confidence}%)`,
                                    boxColor: '#00ff00',
                                    lineWidth: 3
                                });
                                drawBox.draw(canvas);

                                // 自动填充表单
                                const classInput = document.getElementById('stuClass');
                                const idInput = document.getElementById('stuId');
                                const nameInput = document.getElementById('stuName');

                                if (classInput) classInput.value = className;
                                if (idInput) idInput.value = studentId;
                                if (nameInput) nameInput.value = name;

                                // 显示成功提示
                                if (statusElement) {
                                    statusElement.innerHTML = 
                                        `<p class="text-green-600 font-bold text-lg animate-pulse">
                                            ✅ 识别成功：${name}
                                            <br/>📊 置信度: ${confidence}% | 📚 班级: ${className}
                                            <br/>📷 相机将在2秒后自动关闭
                                        </p>`;
                                }

                                // 标记识别成功（防止后续覆盖状态）
                                if (!recognitionSuccess) {
                                    recognitionSuccess = true;
                                    console.log(`✅ 识别成功: ${name} (${studentId}) - ${className}`);

                                    // 2秒后自动关闭相机
                                    setTimeout(() => {
                                        if (recognitionSuccess) { // 再次检查，防止重复关闭
                                            console.log('📷 自动关闭相机...');
                                            stopCamera();
                                            recognitionSuccess = false; // 重置标记
                                        }
                                    }, 2000);
                                }

                            } else {
                                // ========== 未识别（unknown）==========
                                // 只有在尚未识别成功时才绘制红色框
                                if (!recognitionSuccess) {
                                    const drawBox = new faceapi.draw.DrawBox(box, { 
                                        label: `未知 (${distance.toFixed(3)})`,
                                        boxColor: '#ff6b6b',
                                        lineWidth: 2
                                    });
                                    drawBox.draw(canvas);
                                }
                            }
                        });

                        // ========== 第五步：更新状态提示 ==========
                        if (statusElement && !recognitionSuccess) {
                            if (hasMatched) {
                                // 有匹配成功的（状态已在上面更新）
                                // 不需要额外操作
                            } else {
                                // 检测到人脸但全部未匹配
                                if (minDistance < 0.7) {
                                    // 相似度接近阈值
                                    statusElement.innerHTML = 
                                        `<p class="text-orange-600 font-semibold">
                                            ⚠️ 检测到人脸但相似度略低
                                            <br/>📏 相似度距离: <span class="text-red-600 font-bold">${minDistance.toFixed(3)}</span> (阈值: <span class="text-green-600 font-bold">0.65</span>)
                                            <br/>💡 建议：调整角度、光线，或手动填写信息
                                        </p>`;
                                } else if (minDistance < 1.0) {
                                    // 相似度较低
                                    statusElement.innerHTML = 
                                        `<p class="text-orange-600 font-semibold">
                                            ⚠️ 检测到人脸但未找到匹配
                                            <br/>📏 相似度距离: <span class="text-red-600 font-bold">${minDistance.toFixed(3)}</span> (阈值: <span class="text-green-600 font-bold">0.65</span>)
                                            <br/>✓ 确保已录入照片 ✓ 正对摄像头 ✓ 光线充足
                                        </p>`;
                                } else {
                                    // 完全不匹配
                                    statusElement.innerHTML = 
                                        `<p class="text-red-600 font-semibold">
                                            ❌ 检测到人脸但差异过大，无法匹配
                                            <br/>📏 相似度距离: <span class="text-red-600 font-bold">${minDistance.toFixed(3)}</span>
                                            <br/>💡 请手动填写信息，或联系管理员录入照片
                                        </p>`;
                                }
                            }
                        }
                    }

                } else {
                    // ========== 未检测到人脸 ==========
                    console.log('👤 未检测到人脸');

                    // 只有在未识别成功时才显示提示
                    if (statusElement && !recognitionSuccess) {
                        statusElement.innerHTML = 
                            `<p class="text-blue-600 font-semibold">
                                🔍 未检测到人脸，请调整位置...
                                <br/>✓ 面部正对摄像头 ✓ 保持适当距离 ✓ 光线充足
                            </p>`;
                    }
                }

                // ========== 第六步：继续检测循环 ==========
                if (faceDetectionRunning) {
                    requestAnimationFrame(detectFaceLoop);
                }

            } catch (error) {
                console.error('❌ 人脸检测错误:', error);
                
                // 显示错误信息
                const statusElement = document.getElementById('recognitionStatus');
                if (statusElement && !recognitionSuccess) {
                    statusElement.innerHTML = 
                        `<p class="text-red-600 font-semibold">
                            ❌ 检测出错: ${error.message}
                            <br/><small>继续尝试中...</small>
                        </p>`;
                }

                // 即使出错也继续循环（避免因临时错误而停止）
                if (faceDetectionRunning) {
                    requestAnimationFrame(detectFaceLoop);
                }
            }
        }


        // Stop camera
        function stopCamera() {
            faceDetectionRunning = false;
            recognitionSuccess = false; // 重置识别成功标志
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('faceCanvas');
            const ctx = canvas.getContext('2d');
            
            video.classList.add('hidden');
            canvas.classList.add('hidden');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            
            document.getElementById('cameraBtn').textContent = '📷 打开相机（人脸识别）';
            document.getElementById('cameraBtn').onclick = openCamera;
        }

        // Submit check-in - 支持多班级签到
        // Submit check-in - 学生签到（修复版）
        async function submitCheckIn() {
            const className = document.getElementById('stuClass').value;
            const studentId = document.getElementById('stuId').value;
            const name = document.getElementById('stuName').value;
            const location = document.getElementById('location').value;

            // 验证必填字段
            if (!className || !studentId || !name) {
                alert('❌ 请填写完整信息：\n\n✓ 班级\n✓ 学号\n✓ 姓名');
                return;
            }

            // 处理定位信息（可选）
            let finalLocation = location;
            if (!location || location.includes('正在获取')) {
                finalLocation = '未获取定位';
                if (!confirm('⚠️ 您还未获取定位信息\n\n是否继续签到？')) {
                    return;
                }
            } else if (location.includes('定位失败') || location.includes('不支持定位')) {
                finalLocation = location;
            }

            try {
                console.log('🔍 开始签到流程...');
                console.log('学生信息:', { className, studentId, name });

                // Step 1: 查找进行中的签到会话
                const sessionQuery = new AV.Query('CheckInSession');
                sessionQuery.equalTo('status', 'active');
                sessionQuery.descending('createdAt');
                sessionQuery.limit(100); // 获取更多会话以便匹配
                const sessions = await sessionQuery.find();

                console.log(`✅ 找到 ${sessions.length} 个活动签到会话`);

                // Step 2: 查找包含该班级的签到会话
                let matchedSession = null;
                for (let session of sessions) {
                    const classNames = session.get('classNames') || [session.get('className')];
                    console.log('检查会话班级:', classNames);
                    
                    if (classNames.includes(className)) {
                        matchedSession = session;
                        console.log('✅ 找到匹配的签到会话:', session.id);
                        break;
                    }
                }

                if (!matchedSession) {
                    console.error('❌ 未找到匹配的签到会话');
                    alert(`❌ 当前没有【${className}】的签到任务\n\n可能原因：\n✓ 教师还未开始签到\n✓ 签到已结束\n✓ 班级名称不匹配\n\n请联系教师确认`);
                    return;
                }

                const sessionId = matchedSession.id;
                const courseName = matchedSession.get('courseName');
                const courseSession = matchedSession.get('courseSession');

                // Step 3: 检查是否已签到
                const recordQuery = new AV.Query('CheckInRecord');
                recordQuery.equalTo('sessionId', sessionId);
                recordQuery.equalTo('studentId', studentId);
                const existing = await recordQuery.first();

                if (existing) {
                    const existingTime = existing.get('checkInTime');
                    console.warn('⚠️ 学生已签到过');
                    alert(`⚠️ 您已签到过，无需重复签到！\n\n课程：${courseName}\n时间：${new Date(existingTime).toLocaleString()}`);
                    return;
                }

                // Step 4: 创建签到记录（仅创建 CheckInRecord，不创建 Session！）
                const CheckInRecord = AV.Object.extend('CheckInRecord');
                const record = new CheckInRecord();
                record.set('sessionId', sessionId);
                record.set('className', className);
                record.set('studentId', studentId);
                record.set('name', name);
                record.set('location', finalLocation);
                record.set('checkInTime', new Date());
                await record.save();

                console.log('✅ 签到记录创建成功:', record.id);

                // 成功提示
                alert(`✅ 签到成功！\n\n课程：${courseName}\n节次：${courseSession}\n姓名：${name}\n学号：${studentId}\n班级：${className}\n时间：${new Date().toLocaleString()}\n位置：${finalLocation}`);

                // 清空表单
                document.getElementById('stuClass').value = '';
                document.getElementById('stuId').value = '';
                document.getElementById('stuName').value = '';
                document.getElementById('location').value = '';
                document.getElementById('recognitionStatus').classList.add('hidden');
                
                // 关闭相机
                if (videoStream) {
                    stopCamera();
                }

            } catch (error) {
                console.error('❌ 签到失败:', error);
                
                // 友好的错误提示
                let errorMsg = '签到失败';
                let suggestion = '';
                
                if (error.code === 101) {
                    errorMsg = '签到系统尚未初始化';
                    suggestion = '请联系教师确认签到是否已开始';
                } else if (error.code === 401 || error.code === 403) {
                    errorMsg = '权限验证失败';
                    suggestion = '请检查网络连接，或联系管理员';
                } else if (error.message.includes('timeout')) {
                    errorMsg = '网络超时';
                    suggestion = '请检查网络连接后重试';
                } else {
                    errorMsg = error.message;
                    suggestion = '请稍后重试';
                }
                
                alert(`❌ ${errorMsg}\n\n${suggestion}\n\n技术信息：${error.code || '未知'}`);
            }
        }


        // ==================== 倒计时功能 ====================
        let countdownInterval = null;

        function setupCountdown(minutes) {
            // 清除之前的倒计时
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            const countdownElement = document.getElementById('countdown');
            if (!countdownElement) {
                console.warn('⚠️ 倒计时元素不存在');
                return;
            }

            let remainingSeconds = minutes * 60;

            // 立即更新一次
            updateCountdownDisplay(remainingSeconds, countdownElement);

            // 每秒更新
            countdownInterval = setInterval(() => {
                remainingSeconds--;

                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    countdownElement.textContent = '⏰ 签到时间已到';
                    countdownElement.className = 'text-red-600 font-bold animate-pulse';
                    
                    // 播放提示音
                    if (typeof playCheckInSound === 'function') {
                        playCheckInSound();
                    }
                    
                    console.log('⏰ 签到时间已到');
                    return;
                }

                updateCountdownDisplay(remainingSeconds, countdownElement);
            }, 1000);

            console.log(`⏱️ 倒计时已设置: ${minutes} 分钟`);
        }

        function updateCountdownDisplay(seconds, element) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timeString = `${minutes}:${secs.toString().padStart(2, '0')}`;
            
            element.textContent = `⏱️ 剩余时间: ${timeString}`;
            
            // 根据剩余时间改变颜色
            if (seconds <= 60) {
                element.className = 'text-red-600 font-bold animate-pulse';
            } else if (seconds <= 300) {
                element.className = 'text-orange-600 font-bold';
            } else {
                element.className = 'text-green-600 font-bold';
            }
        }


    </script>
</body>
</html>                    