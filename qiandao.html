<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>å¤§å­¦ç”Ÿè¯¾å ‚ç­¾åˆ°ç³»ç»Ÿ</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <!-- LeanCloud SDK -->  
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>  
    <!-- Face-api.js for face recognition -->  
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>  
    <!-- xlsx library for Excel export -->  
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- ECharts è¯äº‘åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>

    <style>  
        .word-cloud {  
            display: flex;  
            flex-wrap: wrap;  
            gap: 8px;  
            padding: 20px;  
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
            border-radius: 12px;  
            min-height: 200px;  
        }  
        .cloud-name {  
            padding: 8px 16px;  
            background: white;  
            border-radius: 20px;  
            font-size: 14px;  
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);  
            transition: all 0.3s ease;  
            animation: float 3s ease-in-out infinite;  
        }  
        .cloud-name.checked {  
            opacity: 0;  
            transform: scale(0);  
        }  
        @keyframes float {  
            0%, 100% { transform: translateY(0px); }  
            50% { transform: translateY(-10px); }  
        }  
        .tab-active {  
            background: #4f46e5;  
            color: white;  
        }  
        #faceCanvas {  
            position: absolute;  
            top: 0;  
            left: 0;  
        }  
        .video-container {  
            position: relative;  
            width: 100%;  
            max-width: 640px;  
            margin: 0 auto;  
        }  
        .requirement-item {  
            display: flex;  
            align-items: center;  
            gap: 8px;  
            padding: 8px;  
            background: #f0fdf4;  
            border-left: 3px solid #22c55e;  
            margin-bottom: 8px;  
            border-radius: 4px;  
        }  
        .warning-item {  
            display: flex;  
            align-items: center;  
            gap: 8px;  
            padding: 8px;  
            background: #fef2f2;  
            border-left: 3px solid #ef4444;  
            margin-bottom: 8px;  
            border-radius: 4px;  
        } 
        
        /* è¯äº‘ç›¸å…³åŠ¨ç”» */
        @keyframes pulse-slow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* è¿›åº¦æ¡é—ªçƒæ•ˆæœ */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        #wordCloudProgressBar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* é€šçŸ¥æ·¡å…¥æ·¡å‡º */
        .notification-enter {
            animation: slideInRight 0.3s ease-out;
        }

        .notification-exit {
            animation: slideOutRight 0.3s ease-in;
        }

        @media (max-width: 768px) {
            #wordCloudContainer {
                height: 350px !important;
            }
            
            .check-in-notification {
                right: 1rem !important;
                top: 5rem !important;
                font-size: 0.9rem;
            }
        } 
        
    /* è§†é¢‘å’Œ canvas å®¹å™¨ */
    .video-container {
        position: relative;
        display: inline-block;
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
    }

    /* è§†é¢‘å…ƒç´  */
    #video {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 8px;
    }

    /* Canvas å åŠ å±‚ */
    #faceCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€ */
    }

    /* éšè—ç±» */
    .hidden {
        display: none !important;
    }        

/* ç­çº§æŠ˜å æ ·å¼ */
.class-group {
    margin-bottom: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    background: white;
}

.class-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: linear-gradient(to right, #f3f4f6, #e5e7eb);
    cursor: pointer;
    transition: all 0.2s;
}

.class-header:hover {
    background: linear-gradient(to right, #e5e7eb, #d1d5db);
}

.class-header.collapsed {
    border-bottom: none;
}

.class-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 16px;
}

.class-arrow {
    transition: transform 0.3s;
    font-size: 12px;
}

.class-arrow.collapsed {
    transform: rotate(-90deg);
}

.class-actions {
    display: flex;
    gap: 8px;
}

.class-students {
    max-height: 400px;
    overflow-y: auto;
    transition: all 0.3s;
}

.class-students.collapsed {
    max-height: 0;
    overflow: hidden;
}

.student-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-top: 1px solid #f3f4f6;
    transition: background 0.2s;
}

.student-item:hover {
    background: #fef3c7;
}

.student-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.student-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e5e7eb;
}

.student-details {
    display: flex;
    flex-direction: column;
}

.student-name {
    font-weight: 600;
    color: #1f2937;
}

.student-id {
    font-size: 12px;
    color: #6b7280;
}

.badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.badge-success {
    background: #d1fae5;
    color: #059669;
}

.badge-error {
    background: #fee2e2;
    color: #dc2626;
}

.btn-sm {
    padding: 4px 12px;
    font-size: 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-warning {
    background: #f59e0b;
    color: white;
}

.btn-warning:hover {
    background: #d97706;
}

/* ğŸ”¥ ç­çº§é€‰æ‹©å¡ç‰‡æ ·å¼ */
.class-checkbox-card {
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
}

.class-checkbox-card input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.class-checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    transition: all 0.2s ease;
    user-select: none;
}

.class-checkbox-label:hover {
    border-color: #3b82f6;
    background: #eff6ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);
}

.class-checkbox-card input[type="checkbox"]:checked + .class-checkbox-label {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.class-checkbox-icon {
    width: 20px;
    height: 20px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.class-checkbox-card input[type="checkbox"]:checked + .class-checkbox-label .class-checkbox-icon {
    background: white;
    border-color: white;
}

.class-checkbox-card input[type="checkbox"]:checked + .class-checkbox-label .class-checkbox-icon::after {
    content: 'âœ“';
    color: #3b82f6;
    font-size: 14px;
    font-weight: bold;
}

/* å·²é€‰æ ‡ç­¾æ ·å¼ */
.selected-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    animation: tagAppear 0.3s ease;
}

.selected-tag .remove-tag {
    cursor: pointer;
    font-weight: bold;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.selected-tag .remove-tag:hover {
    opacity: 1;
}

@keyframes tagAppear {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}


/* å®šæ—¶ä»»åŠ¡åŠ¨ç”» */
.scheduled-task {
    animation: pulse-border 2s infinite;
}

@keyframes pulse-border {
    0%, 100% {
        border-color: #3b82f6;
    }
    50% {
        border-color: #60a5fa;
    }
}

    </style>  
</head>  
<body class="bg-gray-100">  
    <div class="container mx-auto p-4 max-w-6xl">  
        <!-- Header -->  
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">  
            <h1 class="text-3xl font-bold text-center text-indigo-600">ğŸ“š è¯¾å ‚ç­¾åˆ°ç³»ç»Ÿ</h1>  
            <div class="flex justify-center gap-4 mt-4">  
                <button onclick="switchRole('teacher')" id="teacherTab" class="px-6 py-2 rounded-lg tab-active">æ•™å¸ˆç«¯</button>  
                <button onclick="switchRole('student')" id="studentTab" class="px-6 py-2 rounded-lg bg-gray-200">å­¦ç”Ÿç«¯</button>  
            </div>  
        </div>  

        <!-- Teacher Panel -->  
        <div id="teacherPanel" class="space-y-6">  
            <!-- Photo Requirements Guide -->  
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">  
                <h2 class="text-xl font-bold mb-3 text-indigo-800 flex items-center gap-2">  
                    ğŸ“¸ ç…§ç‰‡å½•å…¥è¦æ±‚ï¼ˆé‡è¦ï¼ï¼‰  
                    <button onclick="toggleGuide()" class="text-sm bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">æŸ¥çœ‹è¯¦æƒ…</button>  
                </h2>  
                <div id="photoGuide" class="hidden">  
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">  
                        <div>  
                            <h3 class="font-bold text-green-700 mb-2">âœ… æ­£ç¡®ç¤ºä¾‹</h3>  
                            <div class="requirement-item">  
                                <span class="text-green-600">âœ“</span>  
                                <span class="text-sm">æ­£é¢æ‹æ‘„ï¼Œé¢éƒ¨å®Œæ•´æ¸…æ™°</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">âœ“</span>  
                                <span class="text-sm">å…‰çº¿å……è¶³å‡åŒ€ï¼Œæ— å¼ºçƒˆé˜´å½±</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">âœ“</span>  
                                <span class="text-sm">è¡¨æƒ…è‡ªç„¶ï¼ŒåŒçœ¼çå¼€</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">âœ“</span>  
                                <span class="text-sm">ä¸æˆ´çœ¼é•œã€å¸½å­ã€å£ç½©</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">âœ“</span>  
                                <span class="text-sm">èƒŒæ™¯ç®€æ´ï¼Œæ— é®æŒ¡</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">âœ“</span>  
                                <span class="text-sm">ç…§ç‰‡æ¸…æ™°åº¦é«˜ï¼Œæ–‡ä»¶å¤§äº100KB</span>  
                            </div>  
                        </div>  
                        <div>  
                            <h3 class="font-bold text-red-700 mb-2">âŒ é”™è¯¯ç¤ºä¾‹</h3>  
                            <div class="warning-item">  
                                <span class="text-red-600">âœ—</span>  
                                <span class="text-sm">ä¾§è„¸ã€ä½å¤´ã€ä»°å¤´</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">âœ—</span>  
                                <span class="text-sm">å…‰çº¿å¤ªæš—æˆ–é€†å…‰</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">âœ—</span>  
                                <span class="text-sm">ç…§ç‰‡æ¨¡ç³Šä¸æ¸…</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">âœ—</span>  
                                <span class="text-sm">æˆ´å¢¨é•œã€å£ç½©ã€å¸½å­</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">âœ—</span>  
                                <span class="text-sm">å¤šäººåˆå½±æˆ–è¿œè·ç¦»æ‹æ‘„</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">âœ—</span>  
                                <span class="text-sm">è¿‡åº¦ç¾é¢œæˆ–æ»¤é•œ</span>  
                            </div>  
                        </div>  
                    </div>  
                    <div class="bg-yellow-50 border border-yellow-300 rounded p-3 text-sm">  
                        <p class="font-bold text-yellow-800 mb-1">ğŸ’¡ æœ€ä½³å®è·µï¼š</p>  
                        <ul class="list-disc ml-5 text-yellow-800 space-y-1">  
                            <li>å»ºè®®ä½¿ç”¨è¯ä»¶ç…§æˆ–æ¸…æ™°çš„ç”Ÿæ´»ç…§</li>  
                            <li>äººè„¸å ç…§ç‰‡çš„30-50%ä¸ºæœ€ä½³</li>  
                            <li>ç…§ç‰‡æ ¼å¼ï¼šJPG/PNGï¼Œåˆ†è¾¨ç‡å»ºè®®800x1000ä»¥ä¸Š</li>  
                            <li>æ‰¹é‡å¯¼å…¥æ—¶ç¡®ä¿æ–‡ä»¶åæ ¼å¼ï¼š<code class="bg-yellow-100 px-1">å­¦å·-å§“å-ç­çº§.jpg</code></li>  
                        </ul>  
                    </div>  
                </div>  
            </div>  

            <!-- Student Management -->  
            <div class="bg-white rounded-lg shadow-lg p-6">  
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ‘¥ å­¦ç”Ÿä¿¡æ¯ç®¡ç†</h2>  
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">  
                    <!-- ğŸ”¥ æ—¢å¯ä»¥ä¸‹æ‹‰é€‰æ‹©ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨è¾“å…¥ -->
                    <input 
                    type="text" 
                    id="studentClass" 
                    list="classDatalist" 
                    placeholder="è¾“å…¥æˆ–é€‰æ‹©ç­çº§" 
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    autocomplete="off"
                    >
                    <datalist id="classDatalist">
                        <!-- JavaScript åŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
                    </datalist>
                    <input type="text" id="studentId" placeholder="å­¦å·" class="border rounded px-4 py-2">  
                    <input type="text" id="studentName" placeholder="å§“å" class="border rounded px-4 py-2">  
                </div>  
                
                <div class="mb-4">  
                    <label class="block mb-2 font-semibold">å­¦ç”Ÿç…§ç‰‡ï¼ˆå•å¼ ï¼‰</label>  
                    <input type="file" id="singlePhoto" accept="image/*" onchange="previewPhoto(this, 'singlePreview')" class="border rounded px-4 py-2 w-full">  
                    <div id="singlePreview" class="mt-2"></div>  
                    <canvas id="photoCanvas" style="display:none;"></canvas>  
                </div>  

                <div class="mb-4">  
                    <label class="block mb-2 font-semibold">æ‰¹é‡å¯¼å…¥ç…§ç‰‡ï¼ˆæ–‡ä»¶åæ ¼å¼ï¼šå­¦å·-å§“å-ç­çº§.jpgï¼‰</label>  
                    <input type="file" id="batchPhotos" accept="image/*" multiple class="border rounded px-4 py-2 w-full">  
                    <p class="text-sm text-gray-500 mt-1">ç¤ºä¾‹ï¼š251301100-å¼ ä¸‰-æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2501ç­.jpg</p>  
                </div>  

                <button onclick="addStudent()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 mr-2">â• æ·»åŠ å­¦ç”Ÿ</button>  
                <button onclick="batchImport()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">ğŸ“¦ æ‰¹é‡å¯¼å…¥</button>  

                <div class="mt-6">
                    <h3 class="font-bold mb-2">å·²æ·»åŠ å­¦ç”Ÿåˆ—è¡¨ï¼ˆå…±<span id="studentCount">0</span> äººï¼‰</h3>
                    <div id="studentList" class="max-h-96 overflow-y-auto border rounded p-4 bg-gray-50"></div>
                </div> 
            </div>  

            <!-- Create Check-in Session -->  
            <div class="bg-white rounded-lg shadow-lg p-6">  
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“ å‘å¸ƒç­¾åˆ°</h2>  
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">  
                    <input type="text" id="courseName" placeholder="è¯¾ç¨‹åç§°" class="border rounded px-4 py-2">  
                    <input type="text" id="courseSession" placeholder="è¯¾ç¨‹æ—¶é—´ä¸èŠ‚æ¬¡ï¼ˆå¦‚ï¼š20251014-56ï¼‰" class="border rounded px-4 py-2">  
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">é€‰æ‹©ç­çº§ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        
                        <!-- ğŸ”¥ æ‰‹åŠ¨è¾“å…¥ç­çº§ -->
                        <div class="flex gap-2 mb-3">
                            <input 
                                type="text" 
                                id="customClassInput" 
                                placeholder="è¾“å…¥è‡ªå®šä¹‰ç­çº§åç§°"
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                onkeypress="if(event.key==='Enter') addCustomClass()"
                            >
                            <button 
                                type="button"
                                onclick="addCustomClass()" 
                                class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-200 shadow-md hover:shadow-lg"
                            >
                                â• æ·»åŠ 
                            </button>
                        </div>
                        
                        <!-- ğŸ”¥ å¤é€‰æ¡†å¡ç‰‡å¼å¤šé€‰ -->
                        <div id="selectClass" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-80 overflow-y-auto p-2 border border-gray-200 rounded-lg bg-gray-50">
                            <!-- JavaScript åŠ¨æ€ç”Ÿæˆç­çº§å¤é€‰æ¡† -->
                        </div>
                        
                        <!-- å·²é€‰æ‹©çš„ç­çº§æ ‡ç­¾æ˜¾ç¤º -->
                        <div id="selectedClassesTags" class="mt-3 flex flex-wrap gap-2 hidden">
                            <!-- JavaScript åŠ¨æ€ç”Ÿæˆå·²é€‰æ ‡ç­¾ -->
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2">
                            ğŸ’¡ å¯ä»åˆ—è¡¨å‹¾é€‰æˆ–æ‰‹åŠ¨è¾“å…¥ï¼Œå·²é€‰ <span id="selectedCount" class="font-bold text-blue-600">0</span> ä¸ªç­çº§
                        </p>
                    </div>

                    <input type="number" id="checkInDuration" placeholder="ç­¾åˆ°æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰" class="border rounded px-4 py-2" value="3"> 
                    
                    <!-- ğŸ”¥ æ–°å¢ï¼šå‘å¸ƒæ—¶é—´é€‰æ‹© -->
                    <div class="md:col-span-2 border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">ğŸ“… å‘å¸ƒæ—¶é—´è®¾ç½®</label>
                        
                        <div class="flex gap-2 items-center mb-2">
                            <input type="radio" id="publishNow" name="publishTime" value="now" checked onchange="togglePublishTimeInput()">
                            <label for="publishNow" class="text-sm">ç«‹å³å‘å¸ƒ</label>
                            
                            <input type="radio" id="publishScheduled" name="publishTime" value="scheduled" onchange="togglePublishTimeInput()">
                            <label for="publishScheduled" class="text-sm">å®šæ—¶å‘å¸ƒ</label>
                        </div>
                        
                        <div id="scheduledTimeInput" class="hidden">
                            <input 
                                type="datetime-local" 
                                id="publishDateTime" 
                                class="border rounded px-4 py-2 w-full"
                            >
                            <p class="text-xs text-gray-500 mt-1">ğŸ’¡ åˆ°è®¾å®šæ—¶é—´åå°†è‡ªåŠ¨å¼€å§‹ç­¾åˆ°</p>
                        </div>
                    </div>                    

                </div>  

                <button onclick="startCheckIn()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 w-full">ğŸš€ å¼€å§‹ç­¾åˆ°</button>  
            </div>  

            <!-- History Records Quick Entry -->  
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg shadow-lg p-6 border-2 border-purple-200">  
                <div class="flex items-center justify-between mb-4">  
                    <div>  
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">  
                            ğŸ“š ç­¾åˆ°è®°å½•ç®¡ç†  
                        </h2>  
                        <p class="text-sm text-gray-600 mt-1">æŸ¥çœ‹ã€å¯¼å‡ºæˆ–åˆ é™¤å†å²ç­¾åˆ°è®°å½•</p>  
                    </div>  
                    <div class="text-right">  
                        <p class="text-sm text-gray-600">å…±æœ‰</p>  
                        <p class="text-3xl font-bold text-purple-600" id="historyCount">0</p>  
                        <p class="text-sm text-gray-600">æ¡è®°å½•</p>  
                    </div>  
                </div>  
                <button onclick="viewHistory()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 w-full font-semibold text-lg">  
                    ğŸ“– æŸ¥çœ‹æ‰€æœ‰å†å²è®°å½•  
                </button>  
            </div>  

            <!-- Real-time Check-in Status -->
            <div id="checkInStatus" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <!-- å½“å‰ç­¾åˆ°ä¿¡æ¯ -->
                <div class="mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">
                                ğŸ“š <span id="currentCourse">-</span>
                            </h3>
                            <p class="text-gray-600 mt-1">
                                ğŸ‘¥ ç­çº§: <span id="currentClass">-</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p id="countdown" class="text-lg font-bold text-green-600">â±ï¸ å‡†å¤‡ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- Word Cloud with Progress Bar -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-gray-800">
                            â³ å¾…ç­¾åˆ°å­¦ç”Ÿè¯äº‘
                            <span class="text-xs font-normal text-gray-500 ml-2">(å®æ—¶æ›´æ–°)</span>
                        </h3>
                        <span id="wordCloudCount" class="text-sm font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full">
                            å¾…ç­¾åˆ°: 0 äºº
                        </span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span class="font-medium">ç­¾åˆ°è¿›åº¦</span>
                            <span id="wordCloudProgress" class="font-bold text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                            <div id="wordCloudProgressBar" 
                                 class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-full rounded-full transition-all duration-500 ease-out relative overflow-hidden" 
                                 style="width: 0%">
                                <div class="absolute inset-0 bg-white opacity-30 animate-pulse"></div>
                            </div>
                        </div>
            </div>
                    </div>
                    
                    <!-- Word Cloud Container -->
                    <div id="wordCloudContainer" style="width: 100%; height: 400px; position: relative;"></div>
                    
                    <!-- Tips -->
                    <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-gray-700">
                            ğŸ’¡ <strong>æç¤ºï¼š</strong>å­¦ç”Ÿç­¾åˆ°åå°†ä»è¯äº‘ä¸­æ¶ˆå¤±ï¼Œå…¨éƒ¨ç­¾åˆ°å®Œæˆåæ˜¾ç¤ºç¥è´ºåŠ¨ç”»
                        </p>
                    </div>
                </div>

                <div class="mt-4 flex flex-wrap gap-4">  
                    <button onclick="endCheckIn()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">âœ… ç»“æŸç­¾åˆ°</button>  
                    <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">ğŸ“¥ å¯¼å‡ºå½“å‰Excel</button>  
                    <button onclick="refreshCheckInData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">ğŸ”„ åˆ·æ–°æ•°æ®</button>  
                    <button onclick="viewHistory()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">ğŸ“š æŸ¥çœ‹å†å²è®°å½•</button>  
                </div>  

            <!-- å·²ç­¾åˆ°åˆ—è¡¨ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    âœ… å·²ç­¾åˆ°å­¦ç”Ÿ (<span id="checkedCount">0</span>)
                </h3>
                <div id="checkedInList" class="max-h-96 overflow-y-auto">
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">ğŸ“</p>
                        <p class="text-sm">æš‚æ— ç­¾åˆ°è®°å½•</p>
                    </div>
                </div>
            </div>

            <!-- æœªç­¾åˆ°åˆ—è¡¨ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    â° æœªç­¾åˆ°å­¦ç”Ÿ (<span id="uncheckedCount">0</span>)
                </h3>
                <div id="uncheckedList" class="max-h-96 overflow-y-auto">
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">ğŸ‘¥</p>
                        <p class="text-sm">æš‚æ— å­¦ç”Ÿä¿¡æ¯</p>
                    </div>
                </div>


            </div>  

            <!-- History Records -->  
            <div id="historyPanel" class="bg-white rounded-lg shadow-lg p-6 hidden">  
                <div class="flex justify-between items-center mb-4">  
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ“š å†å²ç­¾åˆ°è®°å½•</h2>  
                    <button onclick="hideHistory()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 flex items-center gap-2">  
                        â† è¿”å›  
                    </button>  
                </div>  
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">  
                    <p class="text-sm text-gray-700">  
                        ğŸ’¡ <strong>æç¤ºï¼š</strong>ç‚¹å‡»"å¯¼å‡ºExcel"å¯ä¸‹è½½ç­¾åˆ°è®°å½•ï¼Œç‚¹å‡»"åˆ é™¤"å¯æ°¸ä¹…åˆ é™¤è¯¥è®°å½•ï¼ˆå»ºè®®å…ˆå¯¼å‡ºï¼‰  
                    </p>  
                </div>  
                <div id="historyList" class="space-y-4"></div>  
            </div>  
        </div>  

        <!-- Student Panel -->  
        <div id="studentPanel" class="hidden">  
            <div class="bg-white rounded-lg shadow-lg p-6">  
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“ å­¦ç”Ÿç­¾åˆ°</h2>  

                <!-- Video for face recognition -->  
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">ğŸ“· äººè„¸è¯†åˆ«ç­¾åˆ°</h3>
                    
                    <!-- è§†é¢‘å®¹å™¨ -->
                    <div class="video-container flex justify-center items-center" >
                        <video 
                        id="video" 
                        autoplay 
                        playsinline 
                        muted
                        class="hidden mx-auto block w-full max-w-2xl rounded-lg shadow-lg"
                    ></video>
                        
                        <canvas 
                            id="faceCanvas" 
                            class="hidden"
                        ></canvas>
                    </div>
                    
                    <!-- å ä½ç¬¦ -->
                    <div id="videoPlaceholder" class="bg-gray-200 rounded-lg p-8 text-center">
                        <p class="text-gray-600">ğŸ“· ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ç›¸æœº</p>
                    </div>
                    
                    <!-- è¯†åˆ«çŠ¶æ€ -->
                    <div id="recognitionStatus" class="hidden mt-4 p-4 bg-blue-50 rounded-lg text-center"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">  
                    <button onclick="openCamera()" id="cameraBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700">ğŸ“· æ‰“å¼€ç›¸æœºï¼ˆäººè„¸è¯†åˆ«ï¼‰</button>  
                    <button onclick="getLocation()" id="locationBtn" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700">ğŸ“ è·å–å®šä½</button>  
                </div>  

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">  
                    <input type="text" id="stuClass" placeholder="ç­çº§ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰" class="border rounded px-4 py-2">  
                    <input type="text" id="stuId" placeholder="å­¦å·ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰" class="border rounded px-4 py-2">  
                    <input type="text" id="stuName" placeholder="å§“åï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰" class="border rounded px-4 py-2">  
                </div>  

                <div class="mb-4">  
                    <input type="text" id="location" placeholder="å®šä½ä¿¡æ¯ï¼ˆè‡ªåŠ¨è·å–ï¼‰" class="border rounded px-4 py-2 w-full" readonly>  
                </div>  

                <div id="recognitionStatus" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">  
                    <p class="text-blue-800 font-semibold">ğŸ” æ­£åœ¨è¯†åˆ«...</p>  
                </div>  

                <button onclick="submitCheckIn()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 w-full text-lg font-bold">âœ… æäº¤ç­¾åˆ°</button>  

                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">  
                    <p class="text-sm text-yellow-800 font-bold mb-2">ğŸ’¡ ç­¾åˆ°æç¤ºï¼š</p>  
                    <ul class="text-sm text-yellow-800 list-disc ml-5 space-y-1">  
                        <li>äººè„¸è¯†åˆ«éœ€è¦æ­£å¯¹æ‘„åƒå¤´ï¼Œä¿æŒå…‰çº¿å……è¶³</li>  
                        <li>å¦‚è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™ä¿¡æ¯åæäº¤</li>  
                        <li>å®šä½åŠŸèƒ½ä¸ºå¯é€‰é¡¹ï¼Œå®šä½å¤±è´¥ä¸å½±å“ç­¾åˆ°</li>  
                        <li>å»ºè®®å…ˆè·å–å®šä½ï¼Œä½†éå¿…éœ€</li>  
                        <li>è¯·ç¡®ä¿åœ¨ç­¾åˆ°æ—¶é—´èŒƒå›´å†…æäº¤</li>  
                    </ul>  
                </div>  
            </div>  
        </div>  
    </div>  

    <script> 
    
        // ==================== å“åº”å¼å¤„ç† ====================
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', function() {
            if (wordCloudChart) {
                wordCloudChart.resize();
                console.log('ğŸ“± è¯äº‘å·²é€‚é…å±å¹•å°ºå¯¸');
            }
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åˆ·æ–°
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && wordCloudChart) {
                setTimeout(() => {
                    wordCloudChart.resize();
                }, 300);
            }
        });    

        // LeanCloud åˆå§‹åŒ– - è¯·æ›¿æ¢ä¸ºä½ çš„åº”ç”¨å‡­è¯  
        AV.init({
            appId: "i1PwXfBx9ZVMkIYzZdUUiysn-gzGzoHsz",
            appKey: "gFXLEuRbVBEVBZiLiZrknLxE",
            serverURL: "https://avoscloud.com"
        });

        // Global variables  
        let students = [];  
        let currentCheckInSession = null;  
        let checkedInStudents = [];  
        let faceModelsLoaded = false;  
        let videoStream = null;
        let activeSessions = [];  
        let faceDetectionRunning = false;  
        let labeledDescriptors = [];  
        let recognitionSuccess = false; // è¯†åˆ«æˆåŠŸæ ‡å¿—  


        // ğŸ”¥ æ–°å¢ï¼šå¤šå¸§éªŒè¯æœºåˆ¶
        let recentMatches = [];  // è®°å½•æœ€è¿‘çš„åŒ¹é…ç»“æœ
        const CONSECUTIVE_FRAMES = 3;  // éœ€è¦è¿ç»­åŒ¹é…çš„å¸§æ•°
        const MIN_CONFIDENCE = 0.5;  // æœ€ä½ç½®ä¿¡åº¦ï¼ˆ55%ï¼‰

        // ğŸ”¥æ´»ä½“æ£€æµ‹ç›¸å…³å˜é‡
        let livenessActions = [];          // éœ€è¦å®Œæˆçš„åŠ¨ä½œ['blink', 'mouth', 'nod']
        let livenessProgress = {};         // å„åŠ¨ä½œå®Œæˆæƒ…å†µ
        let livenessCheckPassed = false;   // æ´»ä½“æ£€æµ‹æ˜¯å¦å…¨éƒ¨é€šè¿‡

        // çœ¨çœ¼æ£€æµ‹
        let blinkCount = 0;
        let lastEyeState = 'open';
        let eyeClosedFrames = 0;

        // çœ¨çœ¼æ£€æµ‹ï¼ˆåŠ¨æ€é˜ˆå€¼ç‰ˆï¼‰
        let baselineEAR = null;        // ççœ¼åŸºå‡†å€¼
        let earSamples = [];           // EARé‡‡æ ·å€¼
        const SAMPLE_SIZE = 10;        // é‡‡æ ·æ•°é‡

        // å¼ å˜´æ£€æµ‹
        let mouthOpenCount = 0;
        let lastMouthState = 'closed';

        // ç‚¹å¤´æ£€æµ‹
        let headPositions = [];
        let nodCount = 0;


        // ğŸ”¥ æ–°å¢ï¼šå›ºå®šçš„ç­çº§åˆ—è¡¨
        let FIXED_CLASSES = [
            'æ™ºèƒ½ç§‘å­¦2501ç­',
            'æ™ºèƒ½ç§‘å­¦2502ç­',
            'æ™ºèƒ½ç§‘å­¦2401ç­',
            'æ™ºèƒ½ç§‘å­¦2402ç­',
            'æ™ºèƒ½ç§‘å­¦2301ç­',
            'æ™ºèƒ½ç§‘å­¦2302ç­',
            'æ™ºèƒ½ç§‘å­¦2303ç­',
            'æ™ºèƒ½ç§‘å­¦2201ç­',
            'æ™ºèƒ½ç§‘å­¦2202ç­',
            'æ™ºèƒ½ç§‘å­¦2203ç­'
        ];


// ==================== åˆ‡æ¢å‘å¸ƒæ—¶é—´è¾“å…¥æ¡† ====================
function togglePublishTimeInput() {
    const publishNow = document.getElementById('publishNow').checked;
    const scheduledInput = document.getElementById('scheduledTimeInput');
    
    if (publishNow) {
        scheduledInput.classList.add('hidden');
    } else {
        scheduledInput.classList.remove('hidden');
        
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨æœ¬åœ°æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    const now = new Date();
    now.setMinutes(now.getMinutes() + 5);

    // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼ (YYYY-MM-DDTHH:mm)
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');

    const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    document.getElementById('publishDateTime').value = localDateTime;
    }
}

        // Load Face-api models with better error handling  
        async function loadFaceModels() {  
            try {  
                console.log('å¼€å§‹åŠ è½½äººè„¸è¯†åˆ«æ¨¡å‹...');  
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';  
                
                await Promise.all([  
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),  
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),  
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)  
                ]);  
                
                faceModelsLoaded = true;  
                console.log('âœ… äººè„¸è¯†åˆ«æ¨¡å‹åŠ è½½å®Œæˆ');  
            } catch (error) {  
                console.error('âŒ æ¨¡å‹åŠ è½½å¤±è´¥:', error);  
                alert('äººè„¸è¯†åˆ«æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');  
            }  
        }  

        // Initialize on page load  
        window.onload = async function() {  
            console.log('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–ä¸­...');  
            loadFaceModels(); // å¼‚æ­¥åŠ è½½äººè„¸æ¨¡å‹
            await loadStudentsFromCloud(); // ç­‰å¾…å­¦ç”Ÿæ•°æ®åŠ è½½  
            loadClassList(); // åŠ è½½ç­çº§åˆ—è¡¨
            // ğŸ”¥ æ–°å¢ï¼šåˆå§‹åŒ–ç­çº§ä¸‹æ‹‰åˆ—è¡¨
            initClassSelect();    
            updateHistoryCount(); // æ›´æ–°å†å²è®°å½•è®¡æ•°  
            await checkActiveSession(); // æ£€æŸ¥æ´»åŠ¨ä¼šè¯  
            console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');  
        };  

        // Toggle photo guide  
        function toggleGuide() {  
            const guide = document.getElementById('photoGuide');  
            guide.classList.toggle('hidden');  
        }  

        // Switch between teacher and student roles  
        function switchRole(role) {  
            // Stop camera if switching away from student panel  
            if (role === 'teacher' && videoStream) {  
                stopCamera();  
            }  

            if (role === 'teacher') {  
                document.getElementById('teacherPanel').classList.remove('hidden');  
                document.getElementById('studentPanel').classList.add('hidden');  
                document.getElementById('teacherTab').classList.add('tab-active');  
                document.getElementById('studentTab').classList.remove('tab-active');  
            } else {  
                document.getElementById('teacherPanel').classList.add('hidden');  
                document.getElementById('studentPanel').classList.remove('hidden');  
                document.getElementById('teacherTab').classList.remove('tab-active');  
                document.getElementById('studentTab').classList.add('tab-active');  
            }  
        }  

        // Preview photo before upload  
        function previewPhoto(input, previewId) {  
            const preview = document.getElementById(previewId);  
            preview.innerHTML = '';  
            
            if (input.files && input.files[0]) {  
                const reader = new FileReader();  
                reader.onload = function(e) {  
                    preview.innerHTML = `  
                        <div class="flex items-center gap-4 mt-2">  
                            <img src="${e.target.result}" class="w-32 h-32 object-cover rounded border">  
                            <div class="text-sm text-gray-600">  
                                <p>æ–‡ä»¶å: ${input.files[0].name}</p>  
                                <p>å¤§å°: ${(input.files[0].size / 1024).toFixed(2)} KB</p>  
                                <p class="text-green-600">âœ“ ç…§ç‰‡å·²é€‰æ‹©</p>  
                            </div>  
                        </div>  
                    `;  
                };  
                reader.readAsDataURL(input.files[0]);  
            }  
        }  

        // Add single student with improved face extraction  
        async function addStudent() {  
            const className = document.getElementById('studentClass').value;  
            const studentId = document.getElementById('studentId').value;  
            const name = document.getElementById('studentName').value;  
            const photoInput = document.getElementById('singlePhoto');  

            if (!className || !studentId || !name) {  
                alert('è¯·å¡«å†™å®Œæ•´çš„å­¦ç”Ÿä¿¡æ¯');  
                return;  
            }  

            if (!photoInput.files[0]) {  
                alert('è¯·ä¸Šä¼ å­¦ç”Ÿç…§ç‰‡');  
                return;  
            }  

            // Check file size  
            if (photoInput.files[0].size < 50000) {  
                if (!confirm('ç…§ç‰‡æ–‡ä»¶è¾ƒå°ï¼ˆ<50KBï¼‰ï¼Œå¯èƒ½å½±å“è¯†åˆ«æ•ˆæœï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {  
                    return;  
                }  
            }  

            try {  
                // Extract face descriptor from photo  
                const descriptor = await extractFaceFromFile(photoInput.files[0]);  
                
                if (!descriptor) {  
                    alert('âŒ æœªèƒ½ä»ç…§ç‰‡ä¸­æ£€æµ‹åˆ°äººè„¸ï¼\n\nè¯·ç¡®ä¿ï¼š\nâœ“ ç…§ç‰‡æ¸…æ™°ï¼Œæ­£é¢æ‹æ‘„\nâœ“ å…‰çº¿å……è¶³ï¼Œæ— é®æŒ¡\nâœ“ ä¸æˆ´å¢¨é•œã€å£ç½©\n\nå»ºè®®å‚è€ƒä¸Šæ–¹"ç…§ç‰‡å½•å…¥è¦æ±‚"');  
                    return;  
                }  

                // Upload photo to LeanCloud  
                const file = new AV.File(photoInput.files[0].name, photoInput.files[0]);  
                await file.save();  

                const student = {  
                    className: className,  
                    studentId: studentId,  
                    name: name,  
                    photoUrl: file.url(),  
                    faceDescriptor: Array.from(descriptor)  
                };  

                // Save to LeanCloud  
                const Student = AV.Object.extend('Student');  
                const studentObj = new Student();  
                Object.keys(student).forEach(key => studentObj.set(key, student[key]));  
                await studentObj.save();  

                students.push(student);  
                updateStudentList();  
                loadClassList();  
                updateLabeledDescriptors();  

                // Clear inputs  
                document.getElementById('studentClass').value = '';  
                document.getElementById('studentId').value = '';  
                document.getElementById('studentName').value = '';  
                document.getElementById('singlePhoto').value = '';  
                document.getElementById('singlePreview').innerHTML = '';  

                alert('âœ… å­¦ç”Ÿæ·»åŠ æˆåŠŸï¼äººè„¸ç‰¹å¾å·²æå–');  
            } catch (error) {  
                console.error('æ·»åŠ å­¦ç”Ÿå¤±è´¥:', error);  
                alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // Extract face descriptor from file  
        async function extractFaceFromFile(file) {  
            return new Promise((resolve, reject) => {  
                const img = document.createElement('img');  
                const canvas = document.getElementById('photoCanvas');  
                const ctx = canvas.getContext('2d');  
                
                img.onload = async () => {  
                    canvas.width = img.width;  
                    canvas.height = img.height;  
                    ctx.drawImage(img, 0, 0);  
                    
                    try {  
                        // Use tinyFaceDetector for better performance  
                        const detection = await faceapi  
                            .detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions({  
                                inputSize: 416,  
                                scoreThreshold: 0.5  
                            }))  
                            .withFaceLandmarks()  
                            .withFaceDescriptor();  
                        
                        if (detection) {  
                            console.log('âœ… æˆåŠŸæå–äººè„¸ç‰¹å¾, ç½®ä¿¡åº¦:', detection.detection.score.toFixed(3));  
                            resolve(detection.descriptor);  
                        } else {  
                            console.warn('âŒ æœªæ£€æµ‹åˆ°äººè„¸');  
                            resolve(null);  
                        }  
                    } catch (error) {  
                        console.error('äººè„¸æå–é”™è¯¯:', error);  
                        reject(error);  
                    }  
                };  
                
                img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));  
                img.src = URL.createObjectURL(file);  
            });  
        }  

        // Batch import students from photos  
        async function batchImport() {  
            const photoInput = document.getElementById('batchPhotos');  
            if (!photoInput.files.length) {  
                alert('è¯·é€‰æ‹©ç…§ç‰‡æ–‡ä»¶');  
                return;  
            }  

            let successCount = 0;  
            let failedCount = 0;  
            const totalFiles = photoInput.files.length;  
            const failedFiles = [];  

            for (let i = 0; i < totalFiles; i++) {  
                const file = photoInput.files[i];  
                try {  
                    // Parse filename: å­¦å·-å§“å-ç­çº§.jpg  
                    const filename = file.name.split('.')[0];  
                    const parts = filename.split('-');  
                    
                    if (parts.length !== 3) {  
                        console.warn(`âš ï¸ æ–‡ä»¶åæ ¼å¼é”™è¯¯: ${file.name}`);  
                        failedFiles.push(`${file.name} (æ ¼å¼é”™è¯¯)`);  
                        failedCount++;  
                        continue;  
                    }  

                    const [studentId, name, className] = parts;  

                    // Extract face descriptor  
                    const descriptor = await extractFaceFromFile(file);  
                    
                    if (!descriptor) {  
                        console.warn(`âš ï¸ æœªèƒ½ä» ${file.name} ä¸­æ£€æµ‹åˆ°äººè„¸`);  
                        failedFiles.push(`${file.name} (æ— äººè„¸)`);  
                        failedCount++;  
                        continue;  
                    }  

                    // Upload to LeanCloud  
                    const avFile = new AV.File(file.name, file);  
                    await avFile.save();  

                    const student = {  
                        className: className,  
                        studentId: studentId,  
                        name: name,  
                        photoUrl: avFile.url(),  
                        faceDescriptor: Array.from(descriptor)  
                    };  

                    // Save to LeanCloud  
                    const Student = AV.Object.extend('Student');  
                    const studentObj = new Student();  
                    Object.keys(student).forEach(key => studentObj.set(key, student[key]));  
                    await studentObj.save();  

                    students.push(student);  
                    successCount++;  
                    
                    console.log(`âœ… æˆåŠŸå¯¼å…¥: ${name} (${i+1}/${totalFiles})`);  
                } catch (error) {  
                    console.error(`âŒ å¤„ç†æ–‡ä»¶å¤±è´¥ ${file.name}:`, error);  
                    failedFiles.push(`${file.name} (ç³»ç»Ÿé”™è¯¯)`);  
                    failedCount++;  
                }  
            }  

            updateStudentList();  
            loadClassList();  
            updateLabeledDescriptors();  
            photoInput.value = '';  
            
            let message = `æ‰¹é‡å¯¼å…¥å®Œæˆï¼\n\næˆåŠŸï¼š${successCount} äºº\nå¤±è´¥ï¼š${failedCount} äºº`;  
            if (failedFiles.length > 0 && failedFiles.length <= 10) {  
                message += '\n\nå¤±è´¥æ–‡ä»¶ï¼š\n' + failedFiles.join('\n');  
            }  
            alert(message);  
        }  

        // Update labeled descriptors for face matching  
        function updateLabeledDescriptors() {  
            labeledDescriptors = students  
                .filter(s => s.faceDescriptor && s.faceDescriptor.length > 0)  
                .map(s => new faceapi.LabeledFaceDescriptors(  
                    `${s.studentId}|${s.name}|${s.className}`,  
                    [new Float32Array(s.faceDescriptor)]  
                ));  
            console.log(`å·²åŠ è½½ ${labeledDescriptors.length} ä¸ªå­¦ç”Ÿçš„äººè„¸æ•°æ®`);  
        }  

// Update student list display - æŒ‰ç­çº§åˆ†ç»„æ˜¾ç¤º
function updateStudentList() {
    const list = document.getElementById('studentList');
    const count = document.getElementById('studentCount');
    
    count.textContent = students.length;
    
    if (students.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-center py-4">æš‚æ— å­¦ç”Ÿæ•°æ®</p>';
        return;
    }
    
    // æŒ‰ç­çº§åˆ†ç»„
    const groupedByClass = {};
    students.forEach((student, index) => {
        const className = student.className || 'æœªåˆ†ç±»';
        if (!groupedByClass[className]) {
            groupedByClass[className] = [];
        }
        groupedByClass[className].push({ ...student, originalIndex: index });
    });
    
    // æŒ‰ç­çº§åç§°æ’åº
    const sortedClasses = Object.keys(groupedByClass).sort((a, b) => 
        a.localeCompare(b, 'zh-CN')
    );
    
    let html = '';
    
    sortedClasses.forEach(className => {
        const classStudents = groupedByClass[className];
        const studentCount = classStudents.length;
        const hasPhotoCount = classStudents.filter(s => s.faceDescriptor).length;
        
        html += `
            <div class="class-group">
                <!-- ç­çº§å¤´éƒ¨ -->
                <div class="class-header" onclick="toggleClass('${className}')">
                    <div class="class-title">
                        <span class="class-arrow" id="arrow-${className}">â–¼</span>
                        <span>ğŸ“š ${className}</span>
                        <span class="text-sm text-gray-600">(${studentCount} äºº)</span>
                    </div>
                    <div class="class-actions" onclick="event.stopPropagation()">
                        <span class="text-xs text-green-600">âœ“${hasPhotoCount} äººå·²å½•å…¥</span>
                        <button 
                            onclick="deleteClass('${className}')" 
                            class="btn-sm btn-warning"
                            title="åˆ é™¤æ•´ä¸ªç­çº§"
                        >
                            ğŸ—‘ï¸ åˆ é™¤ç­çº§
                        </button>
                    </div>
                </div>
                
                <!-- å­¦ç”Ÿåˆ—è¡¨ -->
                <div class="class-students" id="students-${className}">
                    ${classStudents.map(student => `
                        <div class="student-item">
                            <div class="student-info">
                                ${student.photoUrl 
                                    ? `<img src="${student.photoUrl}" class="student-avatar" alt="${student.name}"/>` 
                                    : '<div class="student-avatar" style="background: #e5e7eb; display: flex; align-items: center; justify-content: center;">ğŸ‘¤</div>'
                                }
                                <div class="student-details">
                                    <span class="student-name">${student.name}</span>
                                    <span class="student-id">å­¦å·ï¼š${student.studentId}</span>
                                </div>
                                ${student.faceDescriptor 
                                    ? '<span class="badge badge-success">âœ“ å·²å½•å…¥äººè„¸</span>' 
                                    : '<span class="badge badge-error">âœ— æ— äººè„¸æ•°æ®</span>'
                                }
                            </div>
                            <button 
                                onclick="deleteStudent(${student.originalIndex})" 
                                class="btn-sm btn-danger"
                                title="åˆ é™¤è¯¥å­¦ç”Ÿ"
                            >
                                åˆ é™¤
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
    console.log(`âœ…å­¦ç”Ÿåˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${sortedClasses.length} ä¸ªç­çº§ï¼Œ${students.length} åå­¦ç”Ÿ`);
}

// Toggle class expansion
function toggleClass(className) {
    const studentsDiv = document.getElementById(`students-${className}`);
    const arrow = document.getElementById(`arrow-${className}`);
    
    if (!studentsDiv || !arrow) return;
    
    if (studentsDiv.classList.contains('collapsed')) {
        // å±•å¼€
        studentsDiv.classList.remove('collapsed');
        arrow.classList.remove('collapsed');
        console.log(`ğŸ“‚ å±•å¼€ç­çº§: ${className}`);
    } else {
        // æŠ˜å 
        studentsDiv.classList.add('collapsed');
        arrow.classList.add('collapsed');
        console.log(`ğŸ“ æŠ˜å ç­çº§: ${className}`);
    }
}

// Delete entire class (åˆ é™¤æ•´ä¸ªç­çº§)
async function deleteClass(className) {
    // æ‰¾åˆ°è¯¥ç­çº§çš„æ‰€æœ‰å­¦ç”Ÿ
    const classStudents = students.filter(s => s.className === className);
    
    if (classStudents.length === 0) {
        alert('è¯¥ç­çº§æ²¡æœ‰å­¦ç”Ÿ');
        return;
    }
    
    if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤æ•´ä¸ªç­çº§å—ï¼Ÿ\n\nç­çº§ï¼š${className}\nå­¦ç”Ÿæ•°ï¼š${classStudents.length} äºº\n\næ­¤æ“ä½œå°†ï¼š\nâœ“ åˆ é™¤æ‰€æœ‰å­¦ç”Ÿè®°å½•\nâœ“ åˆ é™¤æ‰€æœ‰å­¦ç”Ÿç…§ç‰‡\nâœ“ æ— æ³•æ¢å¤\n\nå»ºè®®å…ˆå¯¼å‡ºæ•°æ®å¤‡ä»½ï¼`)) {
        return;
    }
    
    try {
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log(`ğŸ—‘ï¸ å¼€å§‹åˆ é™¤ç­çº§: ${className}`);
        console.log(`ğŸ“Š å­¦ç”Ÿæ•°é‡: ${classStudents.length}`);
        
        let successCount = 0;
        let failedCount = 0;
        let fileDeleteCount = 0;
        
        // é€ä¸ªåˆ é™¤å­¦ç”Ÿ
        for (const student of classStudents) {
            try {
                console.log(`\nå¤„ç†å­¦ç”Ÿ: ${student.name} (${student.studentId})`);
                
                // 1. æŸ¥è¯¢å­¦ç”Ÿè®°å½•
                const query = new AV.Query('Student');
                query.equalTo('studentId', student.studentId);
                const result = await query.first();
                
                if (result) {
                    // 2. åˆ é™¤ç…§ç‰‡æ–‡ä»¶
                    const photoUrl = result.get('photoUrl');
                    if (photoUrl && typeof photoUrl === 'string') {
                        try {
                            const urlParts = photoUrl.split('.com/');
                            const encodedKey = urlParts[1];
                            const decodedKey = decodeURIComponent(encodedKey);
                            
                            const fileQuery = new AV.Query('_File');
                            fileQuery.equalTo('key', decodedKey);
                            const fileObj = await fileQuery.first();
                            
                            if (fileObj) {
                                await fileObj.destroy();
                                fileDeleteCount++;
                                console.log(`  âœ… ç…§ç‰‡å·²åˆ é™¤`);
                            }
                        } catch (fileError) {
                            console.warn(`  âš ï¸ ç…§ç‰‡åˆ é™¤å¤±è´¥:`, fileError.message);
                        }
                    }
                    
                    // 3. åˆ é™¤å­¦ç”Ÿè®°å½•
                    await result.destroy();
                    successCount++;
                    console.log(`  âœ… å­¦ç”Ÿè®°å½•å·²åˆ é™¤`);
                }
                
            } catch (error) {
                console.error(`  âŒ åˆ é™¤å¤±è´¥:`, error);
                failedCount++;
            }
        }
        
        // 4. æ›´æ–°æœ¬åœ°æ•°æ®
        students = students.filter(s => s.className !== className);
        updateStudentList();
        loadClassList();
        updateLabeledDescriptors();
        
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('âœ… ç­çº§åˆ é™¤å®Œæˆ');
        console.log(`æˆåŠŸ: ${successCount} äºº`);
        console.log(`å¤±è´¥: ${failedCount} äºº`);
        console.log(`ç…§ç‰‡: ${fileDeleteCount} ä¸ª`);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        alert(`âœ… ç­çº§åˆ é™¤å®Œæˆï¼\n\nç­çº§ï¼š${className}\næˆåŠŸåˆ é™¤ï¼š${successCount} äºº\nåˆ é™¤ç…§ç‰‡ï¼š${fileDeleteCount} ä¸ª${failedCount > 0 ? `\nå¤±è´¥ï¼š${failedCount} äºº` : ''}`);
        
    } catch (error) {
        console.error('âŒ åˆ é™¤ç­çº§å¤±è´¥:', error);
        alert('åˆ é™¤ç­çº§å¤±è´¥ï¼š' + error.message);
    }
}




        // Delete student (è§£ç  key åæŸ¥è¯¢)
        async function deleteStudent(index) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥å­¦ç”Ÿï¼Ÿ')) {
                return;
            }

            const student = students[index];
            
            try {
                let fileDeleteCount = 0;
                const query = new AV.Query('Student');
                query.equalTo('studentId', student.studentId);
                const result = await query.first();
                
                if (result) {
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤å­¦ç”Ÿ:', student.name, student.studentId);

                    // åˆ é™¤ photoUrl å¯¹åº”çš„æ–‡ä»¶
                    const photoUrl = result.get('photoUrl');
                    
                    if (photoUrl && typeof photoUrl === 'string') {
                        console.log('ğŸ“· photoUrl:', photoUrl);
                        
                        try {
                            // ä» URL æå– keyï¼ˆå·²ç¼–ç ï¼‰
                            const urlParts = photoUrl.split('.com/');
                            const encodedKey = urlParts[1];
                            console.log('  æå–åˆ°çš„ key (ç¼–ç ):', encodedKey);
                            
                            // è§£ç  keyï¼ˆè½¬æ¢ä¸ºä¸­æ–‡ï¼‰
                            const decodedKey = decodeURIComponent(encodedKey);
                            console.log('  è§£ç åçš„ key (ä¸­æ–‡):', decodedKey);
                            
                            // ä½¿ç”¨è§£ç åçš„ key æŸ¥è¯¢ _File è¡¨
                            console.log('  ğŸ” æŸ¥è¯¢ _File è¡¨...');
                            const fileQuery = new AV.Query('_File');
                            fileQuery.equalTo('key', decodedKey);
                            const fileObj = await fileQuery.first();
                            
                            if (fileObj) {
                                console.log('  âœ… æ‰¾åˆ°æ–‡ä»¶è®°å½•:');
                                console.log('     objectId:', fileObj.id);
                                console.log('     key:', fileObj.get('key'));
                                console.log('     name:', fileObj.get('name'));
                                
                                await fileObj.destroy();
                                console.log('  âœ… æ–‡ä»¶å·²åˆ é™¤');
                                fileDeleteCount++;
                            } else {
                                console.log('  âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶è®°å½•');
                                console.log('  æŸ¥è¯¢çš„ key:', decodedKey);
                            }
                        } catch (fileError) {
                            console.error('  âŒ åˆ é™¤æ–‡ä»¶å¤±è´¥:', fileError.message);
                            
                            if (fileError.code === 403) {
                                console.log('  ğŸ’¡ éœ€è¦è®¾ç½® _File è¡¨çš„ find å’Œ delete æƒé™');
                            }
                        }
                    }

                    // åˆ é™¤å­¦ç”Ÿè®°å½•
                    console.log('\nğŸ—‘ï¸ åˆ é™¤å­¦ç”Ÿè®°å½•...');
                    await result.destroy();
                    console.log('âœ… å­¦ç”Ÿè®°å½•å·²åˆ é™¤');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                }

                // æ›´æ–°æœ¬åœ°æ•°æ®
                students.splice(index, 1);
                updateStudentList();
                loadClassList();
                updateLabeledDescriptors();
                
                alert(fileDeleteCount > 0 
                    ? `åˆ é™¤æˆåŠŸï¼\nå·²åˆ é™¤å­¦ç”Ÿï¼š${student.name}\nå·²åˆ é™¤ç…§ç‰‡ï¼š${fileDeleteCount} ä¸ª`
                    : `åˆ é™¤æˆåŠŸï¼\nå·²åˆ é™¤å­¦ç”Ÿï¼š${student.name}`);
                
            } catch (error) {
                console.error('âŒ åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // Load students from LeanCloud  
        async function loadStudentsFromCloud() {  
            try {  
                console.log('ğŸ“¥ æ­£åœ¨ä»äº‘ç«¯åŠ è½½å­¦ç”Ÿæ•°æ®...');  
                const query = new AV.Query('Student');  
                query.limit(1000);  
                const results = await query.find();  
                students = results.map(obj => ({  
                    className: obj.get('className'),  
                    studentId: obj.get('studentId'),  
                    name: obj.get('name'),  
                    photoUrl: obj.get('photoUrl'),  
                    faceDescriptor: obj.get('faceDescriptor')  
                }));  
                updateStudentList();  
                updateLabeledDescriptors();  
                loadClassList(); // åŠ è½½å®Œå­¦ç”Ÿåæ›´æ–°ç­çº§åˆ—è¡¨  
                console.log(`âœ… ä»äº‘ç«¯åŠ è½½äº† ${students.length} ä¸ªå­¦ç”Ÿ`);  
            } catch (error) {  
                console.error('âŒ åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);  
                alert('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥ï¼š' + error.message + '\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒLeanCloudé…ç½®');  
            }  
        }  

        // Load class list for dropdown - æ”¹ä¸ºå¤šé€‰æ”¯æŒ  
// ==================== åŠ è½½ç­çº§åˆ—è¡¨ï¼ˆå¡ç‰‡å¼å¤é€‰æ¡†ï¼‰====================
function loadClassList() {
    const classSelection = document.getElementById('selectClass') || document.getElementById('classSelection');
    
    if (!classSelection) {
        console.error('âŒ æ‰¾ä¸åˆ°ç­çº§é€‰æ‹©å™¨å…ƒç´ ');
        return;
    }
    
    // ğŸ”¥ ä½¿ç”¨å›ºå®šçš„ç­çº§åˆ—è¡¨
    if (!FIXED_CLASSES || FIXED_CLASSES.length === 0) {
        console.warn('âš ï¸ æœªå®šä¹‰ç­çº§åˆ—è¡¨');
        classSelection.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— ç­çº§ï¼ˆè¯·åœ¨ä»£ç ä¸­è®¾ç½® FIXED_CLASSESï¼‰</div>';
        return;
    }
    
    // ğŸ”¥ æ¸…ç©ºå¹¶ç”Ÿæˆå¤é€‰æ¡†å¡ç‰‡
    classSelection.innerHTML = '';
    
    FIXED_CLASSES.forEach((className, index) => {
        const checkboxCard = document.createElement('div');
        checkboxCard.className = 'class-checkbox-card';
        
        const checkboxId = `class-checkbox-${index}`;
        
        checkboxCard.innerHTML = `
            <input 
                type="checkbox" 
                id="${checkboxId}" 
                value="${className}"
                onchange="updateSelectedClasses()"
            >
            <label for="${checkboxId}" class="class-checkbox-label">
                <span class="class-checkbox-icon"></span>
                <span class="flex-1">${className}</span>
            </label>
        `;
        
        classSelection.appendChild(checkboxCard);
    });
    
    console.log(`âœ… åŠ è½½äº† ${FIXED_CLASSES.length} ä¸ªç­çº§ï¼ˆå¡ç‰‡å¼é€‰æ‹©ï¼‰:`, FIXED_CLASSES);
}

// ==================== æ›´æ–°å·²é€‰ç­çº§æ˜¾ç¤º ====================
function updateSelectedClasses() {
    const checkboxes = document.querySelectorAll('#selectClass input[type="checkbox"], #classSelection input[type="checkbox"]');
    const selectedClasses = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    const tagsContainer = document.getElementById('selectedClassesTags');
    if (!tagsContainer) return;
    
    // è·å–ç°æœ‰çš„è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆä¸åœ¨å¤é€‰æ¡†ä¸­çš„ï¼‰
    const existingTags = Array.from(tagsContainer.querySelectorAll('.selected-tag'));
    const customClasses = existingTags
        .map(tag => tag.getAttribute('data-class'))
        .filter(className => {
            // ä¿ç•™ä¸åœ¨å¤é€‰æ¡†åˆ—è¡¨ä¸­çš„è‡ªå®šä¹‰ç­çº§
            return !Array.from(checkboxes).some(cb => cb.value === className);
        });
    
    // åˆå¹¶å¤é€‰æ¡†é€‰ä¸­çš„å’Œè‡ªå®šä¹‰çš„ç­çº§
    const allClasses = [...selectedClasses, ...customClasses];
    
    if (allClasses.length === 0) {
        tagsContainer.classList.add('hidden');
        tagsContainer.innerHTML = '';
        updateClassCount();
        return;
    }
    
    tagsContainer.classList.remove('hidden');
    tagsContainer.innerHTML = allClasses.map(className => {
        const isFromCheckbox = selectedClasses.includes(className);
        return `
            <span class="selected-tag" data-class="${className}">
                ${className}
                <span class="remove-tag" onclick="${isFromCheckbox ? `removeClassSelection('${className}')` : 'removeCustomClassTag(this)'}">Ã—</span>
            </span>
        `;
    }).join('');
    
    updateClassCount();
}

// ==================== æ·»åŠ è‡ªå®šä¹‰ç­çº§ ====================
function addCustomClass() {
    const input = document.getElementById('customClassInput');
    const className = input.value.trim();
    
    if (!className) {
        alert('âš ï¸ è¯·è¾“å…¥ç­çº§åç§°');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å·²é€‰åˆ—è¡¨ä¸­
    const existingTags = Array.from(document.querySelectorAll('#selectedClassesTags .selected-tag'))
        .map(tag => tag.textContent.replace('Ã—', '').trim());
    
    if (existingTags.includes(className)) {
        alert('âš ï¸ è¯¥ç­çº§å·²ç»é€‰æ‹©');
        input.value = '';
        return;
    }
    
    // æ·»åŠ åˆ°å·²é€‰æ ‡ç­¾
    const tagsContainer = document.getElementById('selectedClassesTags');
    if (!tagsContainer) return;
    
    tagsContainer.classList.remove('hidden');
    
    const tag = document.createElement('span');
    tag.className = 'selected-tag';
    tag.setAttribute('data-class', className);
    tag.innerHTML = `
        ${className}
        <span class="remove-tag" onclick="removeCustomClassTag(this)">Ã—</span>
    `;
    
    tagsContainer.appendChild(tag);
    
    // æ›´æ–°è®¡æ•°
    updateClassCount();
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    
    console.log(`âœ… æ·»åŠ è‡ªå®šä¹‰ç­çº§: ${className}`);
}

// ==================== ç§»é™¤è‡ªå®šä¹‰ç­çº§æ ‡ç­¾ ====================
function removeCustomClassTag(element) {
    const tag = element.parentElement;
    const className = tag.getAttribute('data-class');
    
    // å¦‚æœæ˜¯ä»å›ºå®šåˆ—è¡¨é€‰çš„ï¼Œå–æ¶ˆå‹¾é€‰
    const checkbox = Array.from(document.querySelectorAll('#selectClass input[type="checkbox"]'))
        .find(cb => cb.value === className);
    
    if (checkbox) {
        checkbox.checked = false;
    }
    
    // ç§»é™¤æ ‡ç­¾
    tag.remove();
    
    // æ›´æ–°è®¡æ•°
    updateClassCount();
}

// ==================== æ›´æ–°ç­çº§è®¡æ•° ====================
function updateClassCount() {
    const tagsContainer = document.getElementById('selectedClassesTags');
    const tags = tagsContainer.querySelectorAll('.selected-tag');
    const count = tags.length;
    
    const countSpan = document.getElementById('selectedCount');
    if (countSpan) {
        countSpan.textContent = count;
    }
    
    // å¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œéšè—æ ‡ç­¾å®¹å™¨
    if (count === 0) {
        tagsContainer.classList.add('hidden');
    }
}



// ==================== ç§»é™¤ç­çº§é€‰æ‹© ====================
function removeClassSelection(className) {
    const checkboxes = document.querySelectorAll('#selectClass input[type="checkbox"], #classSelection input[type="checkbox"]');
    const checkbox = Array.from(checkboxes).find(cb => cb.value === className);
    
    if (checkbox) {
        checkbox.checked = false;
        updateSelectedClasses();
    }
}

// ==================== å¼€å§‹ç­¾åˆ°ï¼ˆæ”¯æŒå®šæ—¶å‘å¸ƒï¼‰====================
async function startCheckIn() {
    try {
        console.log('ğŸš€ å‡†å¤‡å‘å¸ƒç­¾åˆ°...');
        
        // è·å–è¡¨å•æ•°æ®
        const courseName = document.getElementById('courseName').value.trim();
        const courseSession = document.getElementById('courseSession').value.trim();
        const duration = parseInt(document.getElementById('checkInDuration').value);
        
        // è·å–é€‰ä¸­çš„ç­çº§

        // ğŸ”¥ ä»å¤é€‰æ¡†å’Œè‡ªå®šä¹‰æ ‡ç­¾è·å–æ‰€æœ‰é€‰ä¸­çš„ç­çº§
        const checkbox2 = document.querySelectorAll('#selectClass input[type="checkbox"]:checked');
        const checkboxClasses = Array.from(checkbox2).map(cb => cb.value);

        // è·å–æ‰€æœ‰å·²é€‰æ ‡ç­¾ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰çš„ï¼‰
        const tags = document.querySelectorAll('#selectedClassesTags .selected-tag');
        const tagClasses = Array.from(tags).map(tag => tag.getAttribute('data-class'));

        // åˆå¹¶å»é‡
        const classNames = [...new Set([...checkboxClasses, ...tagClasses])];

        console.log("é€‰æ‹©çš„ç­çº§æ˜¯ï¼š", classNames);




        const selectedClasses = classNames;
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!courseName) {
            alert('âŒ è¯·è¾“å…¥è¯¾ç¨‹åç§°');
            return;
        }
        if (!courseSession) {
            alert('âŒ è¯·è¾“å…¥è¯¾ç¨‹èŠ‚æ¬¡');
            return;
        }
        if (selectedClasses.length === 0) {
            alert('âŒ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­çº§');
            return;
        }
        if (!duration || duration <= 0) {
            alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ç­¾åˆ°æ—¶é•¿');
            return;
        }
        
        // è·å–é€‰ä¸­ç­çº§çš„å­¦ç”Ÿ
        const selectedStudents = students.filter(s => selectedClasses.includes(s.className));
        if (selectedStudents.length === 0) {
            alert('âŒ æ‰€é€‰ç­çº§æ²¡æœ‰å­¦ç”Ÿï¼Œè¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•');
            return;
        }
        
        // ğŸ”¥ æ£€æŸ¥å‘å¸ƒæ—¶é—´é€‰æ‹©
        const publishNow = document.getElementById('publishNow').checked;
        const publishScheduled = document.getElementById('publishScheduled').checked;
        
        let scheduledTime = null;
        let confirmMessage = `ğŸ“‹ ç¡®è®¤ç­¾åˆ°ä¿¡æ¯ï¼š\n\nè¯¾ç¨‹ï¼š${courseName}\nèŠ‚æ¬¡ï¼š${courseSession}\nç­çº§ï¼š${selectedClasses.join('ã€')}\näººæ•°ï¼š${selectedStudents.length}äºº\næ—¶é•¿ï¼š${duration}åˆ†é’Ÿ\n`;
        
        if (publishScheduled) {
            // å®šæ—¶å‘å¸ƒ
            const dateTimeInput = document.getElementById('publishDateTime').value;
            if (!dateTimeInput) {
                alert('âŒ è¯·é€‰æ‹©å‘å¸ƒæ—¶é—´');
                return;
            }
            
            scheduledTime = new Date(dateTimeInput);
            const now = new Date();
            
            if (scheduledTime <= now) {
                alert('âŒ å‘å¸ƒæ—¶é—´å¿…é¡»æ™šäºå½“å‰æ—¶é—´');
                return;
            }
            
            const diffMinutes = Math.round((scheduledTime - now) / 60000);
            confirmMessage += `\nâ° å‘å¸ƒæ–¹å¼ï¼šå®šæ—¶å‘å¸ƒ\nğŸ“… å‘å¸ƒæ—¶é—´ï¼š${scheduledTime.toLocaleString('zh-CN')}\nâ±ï¸  è·ç¦»å‘å¸ƒï¼š${diffMinutes} åˆ†é’Ÿ\n\nç­¾åˆ°ä»»åŠ¡å°†åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨å¼€å§‹ï¼`;
        } else {
            // ç«‹å³å‘å¸ƒ
            confirmMessage += `\nâ° å‘å¸ƒæ–¹å¼ï¼šç«‹å³å‘å¸ƒ\n\nç¡®å®šç«‹å³å¼€å§‹ç­¾åˆ°å—ï¼Ÿ`;
        }
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        console.log('ğŸ’¾ åˆ›å»ºç­¾åˆ°ä¼šè¯...');
        
        // åˆ›å»ºç­¾åˆ°ä¼šè¯
        const CheckInSession = AV.Object.extend('CheckInSession');
        const session = new CheckInSession();
        
        session.set('courseName', courseName);
        session.set('courseSession', courseSession);
        session.set('className', selectedClasses.join('ã€'));
        session.set('classNames', selectedClasses);
        session.set('duration', duration);
        session.set('totalStudents', selectedStudents.length);
        session.set('checkedInCount', 0);
        
        const studentData = selectedStudents.map(s => ({
            className: s.className,
            studentId: s.studentId,
            name: s.name
        }));
        session.set('students', studentData);
        
        if (publishScheduled && scheduledTime) {
            // ğŸ”¥ å®šæ—¶å‘å¸ƒï¼šè®¾ç½®ä¸º scheduled çŠ¶æ€
            session.set('status', 'scheduled');
            session.set('scheduledTime', scheduledTime);
            session.set('startTime', scheduledTime); // ç­¾åˆ°å¼€å§‹æ—¶é—´ä¸ºå®šæ—¶æ—¶é—´
        } else {
            // ç«‹å³å‘å¸ƒï¼šè®¾ç½®ä¸º active çŠ¶æ€
            session.set('status', 'active');
            session.set('startTime', new Date());
        }
        
        await session.save();
        console.log('âœ… ç­¾åˆ°ä¼šè¯å·²ä¿å­˜ï¼ŒID:', session.id);
        
        if (publishScheduled && scheduledTime) {
            // ğŸ”¥ å®šæ—¶å‘å¸ƒï¼šæ˜¾ç¤ºå€’è®¡æ—¶ç­‰å¾…ç•Œé¢
            showScheduledTaskUI(session.id, scheduledTime, courseName, courseSession, selectedClasses, selectedStudents.length, duration);
            
            alert(`âœ… ç­¾åˆ°ä»»åŠ¡å·²åˆ›å»ºï¼\n\nğŸ“š è¯¾ç¨‹ï¼š${courseName}\nğŸ“– èŠ‚æ¬¡ï¼š${courseSession}\nğŸ‘¥ ç­çº§ï¼š${selectedClasses.join('ã€')}\nğŸ¯ äººæ•°ï¼š${selectedStudents.length}äºº\nâ±ï¸  æ—¶é•¿ï¼š${duration}åˆ†é’Ÿ\n\nâ° å°†åœ¨ ${scheduledTime.toLocaleString('zh-CN')} è‡ªåŠ¨å¼€å§‹ï¼`);
        } else {
            // ç«‹å³å‘å¸ƒï¼šç›´æ¥å¯åŠ¨ç­¾åˆ°
            currentCheckInSession = {
                id: session.id,
                courseName: courseName,
                courseSession: courseSession,
                classNames: selectedClasses,
                className: selectedClasses.join('ã€'),
                duration: duration,
                startTime: new Date(),
                students: studentData
            };
            
            checkedInStudents = [];
            previousUncheckedCount = selectedStudents.length;
            
            // æ˜¾ç¤ºç­¾åˆ°ç•Œé¢
            document.getElementById('checkInStatus').classList.remove('hidden');
            
            // æ›´æ–°è¯¾ç¨‹ä¿¡æ¯
            const currentCourse = document.getElementById('currentCourse');
            const currentClass = document.getElementById('currentClass');
            if (currentCourse) currentCourse.textContent = `${courseName} - ${courseSession}`;
            if (currentClass) currentClass.textContent = selectedClasses.join('ã€');
            
            // åˆå§‹åŒ–åŠŸèƒ½
            updateWordCloud();
            updateProgress();
            updateCheckedInList();
            updateUncheckedList();
            startPolling();
            setupCountdown(duration);
            
            alert(`âœ… ç­¾åˆ°å·²å¼€å§‹ï¼\n\nğŸ“š è¯¾ç¨‹ï¼š${courseName}\nğŸ“– èŠ‚æ¬¡ï¼š${courseSession}\nğŸ‘¥ ç­çº§ï¼š${selectedClasses.join('ã€')}\nğŸ¯ äººæ•°ï¼š${selectedStudents.length}äºº\nâ±ï¸  æ—¶é•¿ï¼š${duration}åˆ†é’Ÿ\n\nå­¦ç”Ÿç°åœ¨å¯ä»¥å¼€å§‹ç­¾åˆ°äº†ï¼`);
        }
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('courseName').value = '';
        document.getElementById('courseSession').value = '';
        document.getElementById('checkInDuration').value = '10';
        document.getElementById('customClassInput').value = '';
        
        const checkboxes = document.querySelectorAll('#selectClass input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        const tagsContainer = document.getElementById('selectedClassesTags');
        if (tagsContainer) {
            tagsContainer.innerHTML = '';
            tagsContainer.classList.add('hidden');
        }
        
        updateClassCount();
        
        // é‡ç½®å‘å¸ƒæ—¶é—´é€‰æ‹©
        document.getElementById('publishNow').checked = true;
        togglePublishTimeInput();
        
    } catch (error) {
        console.error('âŒ å‘å¸ƒç­¾åˆ°å¤±è´¥:', error);
        alert('å‘å¸ƒç­¾åˆ°å¤±è´¥ï¼š' + error.message);
    }
}

// ==================== æ˜¾ç¤ºå®šæ—¶ä»»åŠ¡ç­‰å¾…ç•Œé¢ ====================
let scheduledCheckInterval = null;

function showScheduledTaskUI(sessionId, scheduledTime, courseName, courseSession, classNames, studentCount, duration) {
    // æ˜¾ç¤ºå®šæ—¶ä»»åŠ¡é¢æ¿
    const checkInStatus = document.getElementById('checkInStatus');
    checkInStatus.classList.remove('hidden');
    
    // åˆ›å»ºå®šæ—¶ä»»åŠ¡UI
    const currentCourse = document.getElementById('currentCourse');
    const currentClass = document.getElementById('currentClass');
    const countdown = document.getElementById('countdown');
    
    if (currentCourse) currentCourse.textContent = `${courseName} - ${courseSession} ã€å®šæ—¶ä»»åŠ¡ã€‘`;
    if (currentClass) currentClass.textContent = classNames.join('ã€');
    
    // éšè—å…¶ä»–é¢æ¿
    const wordCloudContainer = document.getElementById('wordCloudContainer');
    if (wordCloudContainer) {
        wordCloudContainer.innerHTML = `
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <div class="text-8xl mb-4 animate-bounce">â°</div>
                    <h2 class="text-3xl font-bold text-blue-600 mb-3">å®šæ—¶ç­¾åˆ°å·²è®¾ç½®</h2>
                    <p class="text-xl text-gray-700 mb-4">
                        å°†åœ¨ <span class="font-bold text-blue-600" id="scheduledTimeDisplay">${scheduledTime.toLocaleString('zh-CN')}</span> å¼€å§‹
                    </p>
                    <div class="text-6xl font-bold text-green-600" id="scheduledCountdown">--:--:--</div>
                    <p class="text-sm text-gray-500 mt-4">ç­¾åˆ°å°†è‡ªåŠ¨å¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
                </div>
            </div>
        `;
    }
    
    // å¯åŠ¨å€’è®¡æ—¶
    updateScheduledCountdown(scheduledTime, sessionId);
    scheduledCheckInterval = setInterval(() => {
        updateScheduledCountdown(scheduledTime, sessionId);
    }, 1000);
}

function updateScheduledCountdown(scheduledTime, sessionId) {
    const now = new Date();
    const diff = scheduledTime - now;
    
    const countdownElement = document.getElementById('scheduledCountdown');
    const mainCountdown = document.getElementById('countdown');
    
    if (diff <= 0) {
        // æ—¶é—´åˆ°ï¼Œå¯åŠ¨ç­¾åˆ°
        clearInterval(scheduledCheckInterval);
        scheduledCheckInterval = null;
        
        if (countdownElement) {
            countdownElement.textContent = 'ğŸš€ æ­£åœ¨å¯åŠ¨...';
        }
        
        // æ¿€æ´»ç­¾åˆ°ä¼šè¯
        activateScheduledSession(sessionId);
        return;
    }
    
    // è®¡ç®—æ—¶åˆ†ç§’
    const hours = Math.floor(diff / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    
    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (countdownElement) {
        countdownElement.textContent = timeString;
    }
    
    if (mainCountdown) {
        mainCountdown.textContent = `â° è·ç¦»å¼€å§‹ï¼š${timeString}`;
        mainCountdown.className = 'text-lg font-bold text-blue-600';
    }
}

// ==================== æ¿€æ´»å®šæ—¶ç­¾åˆ°ä¼šè¯ ====================
async function activateScheduledSession(sessionId) {
    try {
        console.log('ğŸš€ æ¿€æ´»å®šæ—¶ç­¾åˆ°ä¼šè¯:', sessionId);
        
        // æ›´æ–°ä¼šè¯çŠ¶æ€ä¸º active
        const query = new AV.Query('CheckInSession');
        const session = await query.get(sessionId);
        
        session.set('status', 'active');
        session.set('startTime', new Date()); // æ›´æ–°å®é™…å¼€å§‹æ—¶é—´
        await session.save();
        
        console.log('âœ… ä¼šè¯å·²æ¿€æ´»');
        
        // é‡æ–°åŠ è½½ä¼šè¯ï¼ˆä½¿ç”¨ç°æœ‰çš„ checkActiveSession å‡½æ•°ï¼‰
        await checkActiveSession();
        
        alert('ğŸ‰ ç­¾åˆ°å·²è‡ªåŠ¨å¼€å§‹ï¼\n\nå­¦ç”Ÿç°åœ¨å¯ä»¥å¼€å§‹ç­¾åˆ°äº†ã€‚');
        
    } catch (error) {
        console.error('âŒ æ¿€æ´»å®šæ—¶ä¼šè¯å¤±è´¥:', error);
        alert('æ¿€æ´»å®šæ—¶ç­¾åˆ°å¤±è´¥ï¼š' + error.message);
    }
}

        // ==================== è‡ªåŠ¨åˆ·æ–°æ§åˆ¶ ====================
        let pollingInterval = null;

        function startPolling() {
            // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡
            pollingInterval = setInterval(() => {
                if (currentCheckInSession && currentCheckInSession.id) {
                    refreshCheckInData();
                } else {
                    console.warn('âš ï¸ æ²¡æœ‰æ´»åŠ¨ä¼šè¯ï¼Œåœæ­¢è½®è¯¢');
                    stopPolling();
                }
            }, 3000);

            console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼ˆæ¯3ç§’ï¼‰');
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('ğŸ›‘ è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
            }
        }

// ==================== åˆå§‹åŒ–ç­çº§ä¸‹æ‹‰åˆ—è¡¨ ====================
function initClassSelect() {
    console.log('ğŸ”„ åˆå§‹åŒ–å­¦ç”Ÿè¡¨å•ç­çº§ä¸‹æ‹‰åˆ—è¡¨...');
    
    const classDatalist = document.getElementById('classDatalist');
    if (!classDatalist) {
        console.warn('âš ï¸ æœªæ‰¾åˆ°ç­çº§åˆ—è¡¨å…ƒç´  #classDatalist');
        return;
    }
    
    // ğŸ”¥ æ¸…ç©ºç°æœ‰é€‰é¡¹
    classDatalist.innerHTML = '';
    
    // ğŸ”¥ æ·»åŠ å›ºå®šç­çº§é€‰é¡¹åˆ° datalist
    FIXED_CLASSES.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        classDatalist.appendChild(option);
    });
    
    console.log(`âœ… å·²åŠ è½½ ${FIXED_CLASSES.length} ä¸ªç­çº§åˆ°å­¦ç”Ÿè¡¨å•ï¼ˆæ”¯æŒæ‰‹åŠ¨è¾“å…¥ï¼‰`);
}


        // Refresh check-in data - åˆ·æ–°ç­¾åˆ°æ•°æ®
        // ==================== åˆ·æ–°ç­¾åˆ°æ•°æ®ï¼ˆå¸¦ä¼šè¯æ£€æŸ¥ï¼‰====================
        async function refreshCheckInData() {
            try {
                console.log('ğŸ”„ å¼€å§‹åˆ·æ–°æ•°æ®...');

                // ========== ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰æ´»åŠ¨ä¼šè¯ ==========
                console.log('ğŸ” æ£€æŸ¥äº‘ç«¯æ´»åŠ¨ä¼šè¯...');
                const query = new AV.Query('CheckInSession');
                query.equalTo('status', 'active');
                query.descending('createdAt');
                query.limit(1);
                
                const activeSession = await query.first();

                // å¦‚æœäº‘ç«¯æ²¡æœ‰æ´»åŠ¨ä¼šè¯
                if (!activeSession) {
                    console.log('âš ï¸ äº‘ç«¯æ²¡æœ‰æ´»åŠ¨çš„ç­¾åˆ°ä¼šè¯');
                    
                    // æ¸…ç©ºæœ¬åœ°ä¼šè¯
                    currentCheckInSession = null;
                    checkedInStudents = [];
                    previousUncheckedCount = 0;
                    
                    // åœæ­¢è½®è¯¢
                    if (typeof stopPolling === 'function') {
                        stopPolling();
                    }
                    
                    // åœæ­¢å€’è®¡æ—¶
                    if (typeof countdownInterval !== 'undefined' && countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                    
                    // æ¸…ç†è¯äº‘
                    if (typeof wordCloudChart !== 'undefined' && wordCloudChart) {
                        try {
                            wordCloudChart.dispose();
                            wordCloudChart = null;
                        } catch (err) {
                            console.warn('âš ï¸ æ¸…ç†è¯äº‘å¤±è´¥:', err);
                        }
                    }
                    
                    // åˆå§‹åŒ–é¡µé¢ï¼šéšè—ç­¾åˆ°é¢æ¿ï¼Œæ˜¾ç¤ºè®¾ç½®é¢æ¿
                    const setupPanel = document.getElementById('setupPanel');
                    const checkInStatus = document.getElementById('checkInStatus');
                    
                    if (checkInStatus) {
                        checkInStatus.classList.add('hidden');
                        console.log('âœ… å·²éšè—ç­¾åˆ°çŠ¶æ€é¢æ¿');
                    }
                    
                    if (setupPanel) {
                        setupPanel.classList.remove('hidden');
                        console.log('âœ… å·²æ˜¾ç¤ºè®¾ç½®é¢æ¿');
                    }
                    
                    // æç¤ºç”¨æˆ·
                    alert('â„¹ï¸ å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„ç­¾åˆ°ä¼šè¯\n\né¡µé¢å·²åˆå§‹åŒ–ï¼Œå¯ä»¥å¼€å§‹æ–°çš„ç­¾åˆ°ã€‚');
                    console.log('âœ… é¡µé¢å·²åˆå§‹åŒ–');
                    return;
                }

                // ========== ç¬¬äºŒæ­¥ï¼šäº‘ç«¯æœ‰æ´»åŠ¨ä¼šè¯ ==========
                console.log('âœ… æ‰¾åˆ°æ´»åŠ¨ä¼šè¯:', activeSession.id);

                // æ£€æŸ¥æœ¬åœ°ä¼šè¯æ˜¯å¦ä¸äº‘ç«¯ä¸€è‡´
                if (currentCheckInSession && currentCheckInSession.id !== activeSession.id) {
                    console.warn('âš ï¸ æœ¬åœ°ä¼šè¯ä¸äº‘ç«¯ä¸ä¸€è‡´ï¼Œé‡æ–°åŠ è½½...');
                    
                    // é‡æ–°åŠ è½½ä¼šè¯ï¼ˆè°ƒç”¨ checkActiveSessionï¼‰
                    if (typeof checkActiveSession === 'function') {
                        await checkActiveSession();
                        console.log('âœ… å·²é‡æ–°åŠ è½½ä¼šè¯');
                        return;
                    }
                }

                // å¦‚æœæœ¬åœ°æ²¡æœ‰ä¼šè¯ï¼ŒåŠ è½½äº‘ç«¯ä¼šè¯
                if (!currentCheckInSession || !currentCheckInSession.id) {
                    console.log('âš ï¸ æœ¬åœ°æ²¡æœ‰ä¼šè¯ï¼ŒåŠ è½½äº‘ç«¯ä¼šè¯...');
                    
                    if (typeof checkActiveSession === 'function') {
                        await checkActiveSession();
                        console.log('âœ… å·²åŠ è½½äº‘ç«¯ä¼šè¯');
                        return;
                    }
                }

                // ========== ç¬¬ä¸‰æ­¥ï¼šåˆ·æ–°ç­¾åˆ°è®°å½• ==========
                console.log('ğŸ”„ åˆ·æ–°ç­¾åˆ°è®°å½•...');
                
                // è®°å½•åˆ·æ–°å‰çš„äººæ•°
                const previousCount = checkedInStudents.length;

                // æŸ¥è¯¢ç­¾åˆ°è®°å½•
                const recordQuery = new AV.Query('CheckInRecord');
                recordQuery.equalTo('sessionId', currentCheckInSession.id);
                recordQuery.descending('checkInTime');
                recordQuery.limit(1000);
                
                const records = await recordQuery.find();
                console.log(`âœ… æŸ¥è¯¢åˆ° ${records.length} æ¡ç­¾åˆ°è®°å½•`);

                // è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡æ•°ç»„
                checkedInStudents = records.map(obj => ({
                    className: obj.get('className'),
                    studentId: obj.get('studentId'),
                    name: obj.get('studentName'),
                    location: obj.get('location'),
                    checkInTime: obj.get('checkInTime')
                }));

                const newCount = checkedInStudents.length;
                const newCheckedIn = newCount - previousCount;

                if (newCheckedIn > 0) {
                    console.log(`âœ… æ–°å¢ ${newCheckedIn} äººç­¾åˆ°ï¼Œæ€»è®¡ ${newCount} äºº`);
                }

                // ========== ç¬¬å››æ­¥ï¼šæ›´æ–°æ‰€æœ‰æ˜¾ç¤º ==========
                console.log('ğŸ¨ æ›´æ–°æ˜¾ç¤ºç•Œé¢...');
                
                // 1. æ›´æ–°è¯äº‘
                try {
                    if (typeof updateWordCloud === 'function') {
                        updateWordCloud();
                        console.log('âœ… è¯äº‘å·²æ›´æ–°');
                    }
                } catch (err) {
                    console.error('âŒ è¯äº‘æ›´æ–°å¤±è´¥:', err);
                }

                // 2. æ›´æ–°è¿›åº¦æ¡
                try {
                    if (typeof updateProgress === 'function') {
                        updateProgress();
                        console.log('âœ… è¿›åº¦å·²æ›´æ–°');
                    }
                } catch (err) {
                    console.error('âŒ è¿›åº¦æ›´æ–°å¤±è´¥:', err);
                }

                // 3. æ›´æ–°å·²ç­¾åˆ°åˆ—è¡¨
                try {
                    if (typeof updateCheckedInList === 'function') {
                        updateCheckedInList();
                        console.log('âœ… å·²ç­¾åˆ°åˆ—è¡¨å·²æ›´æ–°');
                    }
                } catch (err) {
                    console.error('âŒ å·²ç­¾åˆ°åˆ—è¡¨æ›´æ–°å¤±è´¥:', err);
                }

                // 4. æ›´æ–°æœªç­¾åˆ°åˆ—è¡¨
                try {
                    if (typeof updateUncheckedList === 'function') {
                        updateUncheckedList();
                        console.log('âœ… æœªç­¾åˆ°åˆ—è¡¨å·²æ›´æ–°');
                    }
                } catch (err) {
                    console.error('âŒ æœªç­¾åˆ°åˆ—è¡¨æ›´æ–°å¤±è´¥:', err);
                }

                // ========== ç¬¬äº”æ­¥ï¼šæ›´æ–°äº‘ç«¯ä¼šè¯æ•°æ® ==========
                try {
                    const sessionQuery = new AV.Query('CheckInSession');
                    const session = await sessionQuery.get(currentCheckInSession.id);
                    session.set('checkedInCount', newCount);
                    await session.save();
                    console.log('âœ… äº‘ç«¯ä¼šè¯æ•°æ®å·²æ›´æ–°');
                } catch (error) {
                    console.warn('âš ï¸ æ›´æ–°äº‘ç«¯ä¼šè¯å¤±è´¥:', error);
                }

                // ========== å®Œæˆ ==========
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('âœ… æ•°æ®åˆ·æ–°å®Œæˆ');
                console.log(`ğŸ“Š ç­¾åˆ°æƒ…å†µ: ${newCount}/${currentCheckInSession.students.length} äººå·²ç­¾åˆ°`);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                // æ˜¾ç¤ºåˆ·æ–°æˆåŠŸæç¤ºï¼ˆçŸ­æš‚æç¤ºï¼Œä¸æ‰“æ–­ç”¨æˆ·ï¼‰
                showNotification(
                    'ğŸ”„ æ•°æ®å·²åˆ·æ–°',
                    `å·²ç­¾åˆ° ${newCount}/${currentCheckInSession.students.length} äºº`
                );

            } catch (error) {
                console.error('âŒ åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                
                // è¯¦ç»†çš„é”™è¯¯æç¤º
                let errorMessage = 'åˆ·æ–°æ•°æ®å¤±è´¥ï¼š\n\n';
                if (error.code === 101) {
                    errorMessage += 'âŒ ç­¾åˆ°ä¼šè¯ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤';
                } else if (error.code === 403) {
                    errorMessage += 'âŒ æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®æ•°æ®';
                } else if (error.code === 1) {
                    errorMessage += 'âŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                } else {
                    errorMessage += `âŒ ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                }
                
                alert(errorMessage);
            }
        }

        // ==================== æ›´æ–°å·²ç­¾åˆ°åˆ—è¡¨ ====================
        function updateCheckedInList() {
            const container = document.getElementById('checkedInList');
            if (!container) {
                console.warn('âš ï¸ æ‰¾ä¸åˆ°å·²ç­¾åˆ°åˆ—è¡¨å®¹å™¨ (id="checkedInList")');
                return;
            }

            if (!currentCheckInSession || checkedInStudents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">ğŸ“</p>
                        <p class="text-sm">æš‚æ— ç­¾åˆ°è®°å½•</p>
                    </div>
                `;
                return;
            }

            // æŒ‰ç­¾åˆ°æ—¶é—´é™åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const sorted = [...checkedInStudents].sort((a, b) => 
                new Date(b.checkInTime) - new Date(a.checkInTime)
            );

            let html = '<div class="space-y-2">';
            
            sorted.forEach((student, index) => {
                const checkInTime = new Date(student.checkInTime);
                const timeStr = checkInTime.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                ${index + 1}
                            </span>
                            <div>
                                <p class="font-bold text-gray-800">${student.name}</p>
                                <p class="text-xs text-gray-600">
                                    ${student.className} | ${student.studentId}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">ç­¾åˆ°æ—¶é—´</p>
                            <p class="text-sm font-bold text-green-600">${timeStr}</p>
                            ${student.location ? `<p class="text-xs text-gray-400 mt-1">ğŸ“ ${student.location}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            console.log(`âœ… å·²ç­¾åˆ°åˆ—è¡¨å·²æ›´æ–°ï¼Œæ˜¾ç¤º ${sorted.length} äºº`);
        }


        // ==================== æ›´æ–°æœªç­¾åˆ°åˆ—è¡¨ ====================
        function updateUncheckedList() {
            const container = document.getElementById('uncheckedList');
            if (!container) {
                console.warn('âš ï¸ æ‰¾ä¸åˆ°æœªç­¾åˆ°åˆ—è¡¨å®¹å™¨ (id="uncheckedList")');
                return;
            }

            if (!currentCheckInSession || !currentCheckInSession.students) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">ğŸ‘¥</p>
                        <p class="text-sm">æš‚æ— å­¦ç”Ÿä¿¡æ¯</p>
                    </div>
                `;
                return;
            }

            // è·å–æœªç­¾åˆ°çš„å­¦ç”Ÿ
            const checkedInIds = new Set(checkedInStudents.map(s => s.studentId));
            const uncheckedStudents = currentCheckInSession.students.filter(s => 
                !checkedInIds.has(s.studentId)
            );

            if (uncheckedStudents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-green-500">
                        <p class="text-6xl mb-3">ğŸ‰</p>
                        <p class="text-lg font-bold">å…¨å‘˜å·²ç­¾åˆ°ï¼</p>
                        <p class="text-sm mt-2">å‡ºå‹¤ç‡ 100%</p>
                    </div>
                `;
                return;
            }

            // æŒ‰å§“åæ’åº
            const sorted = [...uncheckedStudents].sort((a, b) => 
                a.name.localeCompare(b.name, 'zh-CN')
            );

            let html = '<div class="space-y-2">';
            
            sorted.forEach((student, index) => {
                html += `
                    <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                ${index + 1}
                            </span>
                            <div>
                                <p class="font-bold text-gray-800">${student.name}</p>
                                <p class="text-xs text-gray-600">
                                    ${student.className} | ${student.studentId}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">
                                æœªç­¾åˆ°
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            console.log(`âœ… æœªç­¾åˆ°åˆ—è¡¨å·²æ›´æ–°ï¼Œæ˜¾ç¤º ${sorted.length} äºº`);
        }




        // ==================== å€’è®¡æ—¶è¯äº‘æ¨¡å—ï¼ˆå®Œæ•´ç‰ˆï¼‰====================
        
        let wordCloudChart = null; // EChartså®ä¾‹
        let previousUncheckedCount = 0; // ç”¨äºæ£€æµ‹å˜åŒ–

        function updateWordCloud() {
            const container = document.getElementById('wordCloudContainer');
            
            if (!container) {
                console.warn('âš ï¸ è¯äº‘å®¹å™¨ä¸å­˜åœ¨');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰ç­¾åˆ°ä¼šè¯
            if (!currentCheckInSession || !currentCheckInSession.students) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <p class="text-6xl mb-4">ğŸ“Š</p>
                            <p class="text-lg font-semibold">æœªå¼€å§‹ç­¾åˆ°</p>
                            <p class="text-sm mt-2">å‘å¸ƒç­¾åˆ°åå°†æ˜¾ç¤ºå¾…ç­¾åˆ°å­¦ç”Ÿ</p>
                        </div>
                    </div>
                `;
                
                // é‡ç½®è¿›åº¦æ˜¾ç¤º
                updateProgressBar(0, 0, 0);
                return;
            }

            // è·å–æ‰€æœ‰åº”ç­¾åˆ°çš„å­¦ç”Ÿ
            const allStudents = currentCheckInSession.students || [];
            
            // è·å–å·²ç­¾åˆ°çš„å­¦ç”ŸIDåˆ—è¡¨
            const checkedInIds = new Set(checkedInStudents.map(s => s.studentId));
            
            // è¿‡æ»¤å‡ºæœªç­¾åˆ°çš„å­¦ç”Ÿ
            const uncheckedStudents = allStudents.filter(s => !checkedInIds.has(s.studentId));

            const totalCount = allStudents.length;
            const checkedCount = checkedInStudents.length;
            const uncheckedCount = uncheckedStudents.length;

            console.log(`ğŸ“Š è¯äº‘æ›´æ–°: åº”åˆ°${totalCount}äºº, å·²åˆ°${checkedCount}äºº, æœªåˆ°${uncheckedCount}äºº`);

            // æ›´æ–°è¿›åº¦æ¡
            updateProgressBar(totalCount, checkedCount, uncheckedCount);

            // å¦‚æœå…¨éƒ¨ç­¾åˆ°å®Œæˆ
            if (uncheckedCount === 0 && totalCount > 0) {
                showCompletionAnimation(container);
                return;
            }

            // è½¬æ¢ä¸ºè¯äº‘æ•°æ®æ ¼å¼
            const wordCloudData = uncheckedStudents.map((student, index) => ({
                name: student.name || 'æœªçŸ¥',
                value: 10 + Math.random() * 5, // éšæœºæƒé‡ï¼Œå¢åŠ è§†è§‰å˜åŒ–
                studentId: student.studentId,
                className: student.className,
                index: index
            }));

            // åˆå§‹åŒ–æˆ–è·å–å›¾è¡¨å®ä¾‹
            if (!wordCloudChart) {
                wordCloudChart = echarts.init(container);
                
                // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', function() {
                    if (wordCloudChart) {
                        wordCloudChart.resize();
                    }
                });
            }

            // è®¡ç®—é¢œè‰²ï¼ˆæ ¹æ®å‰©ä½™äººæ•°æ¯”ä¾‹ï¼‰
            const remainingRatio = uncheckedCount / totalCount;
            
            // é…ç½®è¯äº‘é€‰é¡¹
            const option = {
                backgroundColor: {
                    type: 'linear',
                    x: 0, y: 0, x2: 1, y2: 1,
                    colorStops: [
                        { offset: 0, color: '#fff5f5' },
                        { offset: 1, color: '#fee2e2' }
                    ]
                },
                title: {
                    text: `è¿˜æœ‰ ${uncheckedCount} äººæœªç­¾åˆ°`,
                    subtext: `ç‚¹å‡»æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…`,
                    left: 'center',
                    top: 15,
                    textStyle: {
                        fontSize: 20,
                        fontWeight: 'bold',
                        color: remainingRatio > 0.5 ? '#f59e0b' : remainingRatio > 0.2 ? '#ef4444' : '#dc2626'
                    },
                    subtextStyle: {
                        fontSize: 12,
                        color: '#9ca3af'
                    }
                },
                tooltip: {
                    show: true,
                    formatter: function(params) {
                        return `
                            <div style="padding: 8px; min-width: 150px;">
                                <div style="font-size:18px; font-weight:bold; color:#dc2626; margin-bottom:8px; border-bottom: 2px solid #dc2626; padding-bottom:4px;">
                                    ${params.data.name}
                                </div>
                                <div style="color:#666; line-height:1.8;">
                                    <div>ğŸ“š ç­çº§: <strong>${params.data.className}</strong></div>
                                    <div>ğŸ“ å­¦å·: <strong>${params.data.studentId}</strong></div>
                                    <div style="margin-top:8px; padding:4px 8px; background:#fee2e2; border-radius:4px; color:#dc2626; font-weight:bold; text-align:center;">
                                        âš ï¸ æœªç­¾åˆ°
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#dc2626',
                    borderWidth: 2,
                    borderRadius: 8,
                    padding: 0,
                    textStyle: {
                        color: '#333'
                    },
                    extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.15);'
                },
                series: [{
                    type: 'wordCloud',
                    shape: 'circle',
                    
                    // ä½ç½®å’Œå¤§å°
                    left: 'center',
                    top: 'center',
                    width: '90%',
                    height: '75%',
                    
                    // æ–‡å­—å¤§å°èŒƒå›´ï¼ˆæ ¹æ®å‰©ä½™äººæ•°åŠ¨æ€è°ƒæ•´ï¼‰
                    sizeRange: uncheckedCount > 20 ? [16, 48] : uncheckedCount > 10 ? [20, 55] : [24, 65],
                    
                    // æ—‹è½¬è§’åº¦
                    rotationRange: [-30, 30],
                    rotationStep: 15,
                    
                    // é—´è·
                    gridSize: 12,
                    
                    drawOutOfBound: false,
                    
                    // å¸ƒå±€åŠ¨ç”»
                    layoutAnimation: true,
                    animationDuration: 1000,
                    animationEasing: 'cubicOut',
                    animationDelay: function(idx) {
                        return idx * 30;
                    },
                    
                    // æ–‡å­—æ ·å¼
                    textStyle: {
                        fontFamily: 'Microsoft YaHei, PingFang SC, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif',
                        fontWeight: 'bold',
                        color: function() {
                            // æ ¹æ®å‰©ä½™æ¯”ä¾‹é€‰æ‹©é¢œè‰²æ–¹æ¡ˆ
                            let colors;
                            if (remainingRatio > 0.5) {
                                // å‰©ä½™è¶…è¿‡50% - æ©™è‰²ç³»
                                colors = ['#f97316', '#fb923c', '#fdba74', '#fed7aa', '#ea580c', '#c2410c'];
                            } else if (remainingRatio > 0.2) {
                                // å‰©ä½™20%-50% - çº¢æ©™è‰²ç³»
                                colors = ['#ef4444', '#f87171', '#fca5a5', '#fb923c', '#dc2626', '#b91c1c'];
                            } else {
                                // å‰©ä½™å°‘äº20% - æ·±çº¢è‰²ç³»
                                colors = ['#dc2626', '#b91c1c', '#991b1b', '#ef4444', '#7f1d1d', '#450a0a'];
                            }
                            return colors[Math.floor(Math.random() * colors.length)];
                        },
                        shadowBlur: 4,
                        shadowColor: 'rgba(220, 38, 38, 0.3)',
                        shadowOffsetX: 1,
                        shadowOffsetY: 1
                    },
                    
                    // æ‚¬åœæ•ˆæœ
                    emphasis: {
                        focus: 'self',
                        textStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(220, 38, 38, 0.8)',
                            color: '#dc2626',
                            fontWeight: 'bolder',
                            textBorderColor: '#fff',
                            textBorderWidth: 2
                        }
                    },
                    
                    data: wordCloudData
                }]
            };

            // è®¾ç½®é…ç½®é¡¹å¹¶è§¦å‘åŠ¨ç”»
            wordCloudChart.setOption(option, true);

            // æ£€æµ‹æ˜¯å¦æœ‰å­¦ç”Ÿç­¾åˆ°ï¼ˆè¯äº‘å‡å°‘ï¼‰
            if (previousUncheckedCount > uncheckedCount && previousUncheckedCount > 0) {
                const newCheckedCount = previousUncheckedCount - uncheckedCount;
                console.log(`âœ… ${newCheckedCount} åå­¦ç”Ÿç­¾åˆ°`);
                playCheckInSound();
                showCheckInNotification(newCheckedCount, checkedCount);
            }

            previousUncheckedCount = uncheckedCount;

            console.log(`âœ… è¯äº‘å·²æ›´æ–°ï¼Œæ˜¾ç¤º ${uncheckedCount} ä¸ªæœªç­¾åˆ°å­¦ç”Ÿ`);
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar(total, checked, unchecked) {
            const progress = total > 0 ? Math.round((checked / total) * 100) : 0;
            
            // æ›´æ–°å¾…ç­¾åˆ°äººæ•°æ ‡ç­¾
            const countElement = document.getElementById('wordCloudCount');
            if (countElement) {
                countElement.textContent = `å¾…ç­¾åˆ°: ${unchecked} äºº`;
                // æ ¹æ®äººæ•°å˜åŒ–é¢œè‰²
                if (unchecked === 0) {
                    countElement.className = 'text-sm font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full';
                } else if (unchecked < total * 0.2) {
                    countElement.className = 'text-sm font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full';
                } else {
                    countElement.className = 'text-sm font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full';
                }
            }

            // æ›´æ–°è¿›åº¦ç™¾åˆ†æ¯”
            const progressElement = document.getElementById('wordCloudProgress');
            if (progressElement) {
                progressElement.textContent = `${progress}%`;
            }

            // æ›´æ–°è¿›åº¦æ¡å®½åº¦
            const progressBar = document.getElementById('wordCloudProgressBar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }

            // æ›´æ–°è®¡æ•°æ˜¾ç¤º
            const checkedCountElement = document.getElementById('checkedCount');
            const uncheckedCountElement = document.getElementById('uncheckedCount');
            if (checkedCountElement) {
                checkedCountElement.textContent = `å·²ç­¾åˆ°: ${checked}`;
            }
            if (uncheckedCountElement) {
                uncheckedCountElement.textContent = `æœªç­¾åˆ°: ${unchecked}`;
            }
        }

        // æ˜¾ç¤ºå®ŒæˆåŠ¨ç”»
        function showCompletionAnimation(container) {
            // é”€æ¯å›¾è¡¨
            if (wordCloudChart) {
                wordCloudChart.dispose();
                wordCloudChart = null;
            }
            
            const total = currentCheckInSession.students.length;
            
            container.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center animate-scale-in">
                        <div class="text-8xl mb-4 animate-bounce" style="animation-duration: 0.6s;">ğŸ‰</div>
                        <h2 class="text-3xl font-bold text-green-600 mb-3 animate-fade-in">å…¨å‘˜ç­¾åˆ°å®Œæˆï¼</h2>
                        <p class="text-xl text-gray-700 mb-4 animate-fade-in" style="animation-delay: 0.2s;">
                            å·²ç­¾åˆ° <span class="font-bold text-green-600">${total}</span> / ${total} äºº
                        </p>
                        <div class="text-6xl animate-fade-in" style="animation-delay: 0.4s;">âœ…</div>
                        <p class="text-sm text-gray-500 mt-4 animate-fade-in" style="animation-delay: 0.6s;">
                            å‡ºå‹¤ç‡: <span class="font-bold text-green-600">100%</span>
                        </p>
                    </div>
                </div>
                
                <style>
                    @keyframes scale-in {
                        from {
                            transform: scale(0.5);
                            opacity: 0;
                        }
                        to {
                            transform: scale(1);
                            opacity: 1;
                        }
                    }
                    @keyframes fade-in {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    .animate-scale-in {
                        animation: scale-in 0.5s ease-out;
                    }
                    .animate-fade-in {
                        animation: fade-in 0.5s ease-out forwards;
                        opacity: 0;
                    }
                </style>
            `;
            
            // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
            playCompletionSound();
        }

        // æ’­æ”¾ç­¾åˆ°æç¤ºéŸ³
        function playCheckInSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
                console.log('ğŸ”” æ’­æ”¾ç­¾åˆ°æç¤ºéŸ³');
            } catch (error) {
                console.warn('âš ï¸ éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
            }
        }

        // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
        function playCompletionSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // æ’­æ”¾ä¸‰ä¸ªéŸ³ç¬¦
                const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
                
                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    const startTime = audioContext.currentTime + index * 0.15;
                    gainNode.gain.setValueAtTime(0.2, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.3);
                });
                
                console.log('ğŸµ æ’­æ”¾å®ŒæˆéŸ³æ•ˆ');
            } catch (error) {
                console.warn('âš ï¸ éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºç­¾åˆ°é€šçŸ¥
        function showCheckInNotification(newCount, totalChecked) {
            // ç§»é™¤æ—§é€šçŸ¥
            const oldNotification = document.querySelector('.check-in-notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'check-in-notification fixed top-20 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 transform transition-all duration-300';
            notification.style.animation = 'slideInRight 0.3s ease-out';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-3xl animate-bounce">âœ…</span>
                    <div>
                        <p class="font-bold text-lg">æ–°ç­¾åˆ° +${newCount}</p>
                        <p class="text-sm opacity-90">æ€»è®¡: ${totalChecked} äººå·²ç­¾åˆ°</p>
                    </div>
                </div>
                
                <style>
                    @keyframes slideInRight {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                </style>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            console.log(`ğŸ“¢ æ˜¾ç¤ºé€šçŸ¥: +${newCount} äººç­¾åˆ°`);
        }

        // Update progress - æ›´æ–°ç­¾åˆ°è¿›åº¦
        function updateProgress() {
            if (!currentCheckInSession || !currentCheckInSession.students) {
                return;
            }

            const total = currentCheckInSession.students.length;
            const checked = checkedInStudents.length;
            const unchecked = total - checked;
            const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;

            console.log(`ğŸ“Š æ›´æ–°è¿›åº¦: ${checked}/${total} (${percentage}%)`);

            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = `${checked} / ${total} (${percentage}%)`;
            }

            // æ›´æ–°è¿›åº¦æ¡
            const progressBarFill = document.getElementById('progressBarFill');
            if (progressBarFill) {
                progressBarFill.style.width = `${percentage}%`;
            }

            // æ›´æ–°ç»Ÿè®¡æ•°å­—
            const checkedCountElement = document.getElementById('checkedCount');
            if (checkedCountElement) {
                checkedCountElement.textContent = checked;
            }

            const uncheckedCountElement = document.getElementById('uncheckedCount');
            if (uncheckedCountElement) {
                uncheckedCountElement.textContent = unchecked;
            }

            // âœ… åŒæ—¶æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
            updateCheckedInList();
            updateUncheckedList();
        }

        // ==================== ç»“æŸç­¾åˆ°ï¼ˆå¸¦å…ƒç´ æ£€æŸ¥ï¼‰====================
        async function endCheckIn() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨ä¼šè¯
            if (!currentCheckInSession || !currentCheckInSession.id) {
                alert('âŒ æ²¡æœ‰è¿›è¡Œä¸­çš„ç­¾åˆ°');
                return;
            }

            try {
                const total = currentCheckInSession.students ? currentCheckInSession.students.length : 0;
                const checked = checkedInStudents.length;
                const unchecked = total - checked;
                const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;

                // ç¡®è®¤ç»“æŸ
                if (!confirm(`ğŸ”š ç¡®å®šè¦ç»“æŸç­¾åˆ°å—ï¼Ÿ\n\nåº”åˆ°ï¼š${total}äºº\nå®åˆ°ï¼š${checked}äºº\nç¼ºå‹¤ï¼š${unchecked}äºº\nå‡ºå‹¤ç‡ï¼š${percentage}%\n\nç»“æŸåå­¦ç”Ÿå°†æ— æ³•ç»§ç»­ç­¾åˆ°ï¼`)) {
                    console.log('âŒ ç”¨æˆ·å–æ¶ˆç»“æŸç­¾åˆ°');
                    return;
                }

                console.log('ğŸ›‘ å¼€å§‹ç»“æŸç­¾åˆ°...');

                // ========== ç¬¬ä¸€æ­¥ï¼šæœ€ååˆ·æ–°ä¸€æ¬¡æ•°æ® ==========
                console.log('ğŸ”„ æœ€ååˆ·æ–°æ•°æ®...');
                try {
                    if (typeof refreshCheckInData === 'function') {
                        await refreshCheckInData();
                        console.log('âœ… æ•°æ®åˆ·æ–°å®Œæˆ');
                    }
                } catch (err) {
                    console.warn('âš ï¸ æœ€ååˆ·æ–°å¤±è´¥:', err);
                }

                // é‡æ–°ç»Ÿè®¡ï¼ˆåˆ·æ–°åå¯èƒ½æœ‰æ–°çš„ç­¾åˆ°ï¼‰
                const finalChecked = checkedInStudents.length;
                const finalUnchecked = total - finalChecked;
                const finalPercentage = total > 0 ? Math.round((finalChecked / total) * 100) : 0;

                // ========== ç¬¬äºŒæ­¥ï¼šæ›´æ–°äº‘ç«¯ä¼šè¯çŠ¶æ€ ==========
                console.log('ğŸ’¾ æ›´æ–°ä¼šè¯çŠ¶æ€...');
                try {
                    const query = new AV.Query('CheckInSession');
                    const session = await query.get(currentCheckInSession.id);

                    session.set('status', 'completed');
                    session.set('endTime', new Date());
                    session.set('checkedInCount', finalChecked);
                    session.set('absentCount', finalUnchecked);

                    // ä¿å­˜å®Œæ•´ç­¾åˆ°ç»“æœ
                    const results = currentCheckInSession.students.map(student => {
                        const checkedIn = checkedInStudents.find(c => c.studentId === student.studentId);
                        return {
                            studentId: student.studentId,
                            name: student.name,
                            className: student.className,
                            status: checkedIn ? 'present' : 'absent',
                            checkInTime: checkedIn ? checkedIn.checkInTime : null,
                            location: checkedIn ? checkedIn.location : null
                        };
                    });
                    session.set('results', results);

                    await session.save();
                    console.log('âœ… ä¼šè¯çŠ¶æ€å·²æ›´æ–°ä¸º completed');

                } catch (error) {
                    console.error('âŒ æ›´æ–°ä¼šè¯å¤±è´¥:', error);
                    throw new Error('ä¿å­˜ç­¾åˆ°ç»“æœå¤±è´¥ï¼š' + error.message);
                }

                // ========== ç¬¬ä¸‰æ­¥ï¼šåœæ­¢æ‰€æœ‰å®šæ—¶å™¨ ==========
                console.log('ğŸ›‘ åœæ­¢å®šæ—¶å™¨...');
                
                // åœæ­¢è½®è¯¢
                if (typeof stopPolling === 'function') {
                    stopPolling();
                    console.log('âœ… è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
                } else if (typeof pollingInterval !== 'undefined' && pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.log('âœ… è½®è¯¢å·²åœæ­¢');
                }

                // åœæ­¢å€’è®¡æ—¶
                if (typeof countdownInterval !== 'undefined' && countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    console.log('âœ… å€’è®¡æ—¶å·²åœæ­¢');
                }

                // ========== ç¬¬å››æ­¥ï¼šæ˜¾ç¤ºå®ŒæˆåŠ¨ç”»ï¼ˆå¯é€‰ï¼‰==========
                if (finalUnchecked === 0 && total > 0) {
                    console.log('ğŸ‰ å…¨å‘˜ç­¾åˆ°å®Œæˆï¼');
                    try {
                        if (typeof updateWordCloud === 'function') {
                            updateWordCloud();
                        }
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } catch (err) {
                        console.warn('âš ï¸ å®ŒæˆåŠ¨ç”»å¤±è´¥:', err);
                    }
                }

                // ========== ç¬¬äº”æ­¥ï¼šæ¸…ç†UIï¼ˆå¸¦å…ƒç´ æ£€æŸ¥ï¼‰==========
                console.log('ğŸ§¹ æ¸…ç†UI...');

                // éšè—ç­¾åˆ°çŠ¶æ€é¢æ¿
                const checkInStatus = document.getElementById('checkInStatus');
                if (checkInStatus) {
                    checkInStatus.classList.add('hidden');
                    console.log('âœ… ç­¾åˆ°çŠ¶æ€é¢æ¿å·²éšè—');
                } else {
                    console.warn('âš ï¸ æ‰¾ä¸åˆ°ç­¾åˆ°çŠ¶æ€é¢æ¿ (id="checkInStatus")');
                }

                // æ˜¾ç¤ºè®¾ç½®é¢æ¿
                const setupPanel = document.getElementById('setupPanel');
                if (setupPanel) {
                    setupPanel.classList.remove('hidden');
                    console.log('âœ… è®¾ç½®é¢æ¿å·²æ˜¾ç¤º');
                } else {
                    console.warn('âš ï¸ æ‰¾ä¸åˆ°è®¾ç½®é¢æ¿ (id="setupPanel")');
                }

                // ========== ç¬¬å…­æ­¥ï¼šæ¸…ç©ºå…¨å±€å˜é‡ ==========
                console.log('ğŸ§¹ æ¸…ç©ºå…¨å±€å˜é‡...');
                currentCheckInSession = null;
                checkedInStudents = [];
                
                if (typeof previousUncheckedCount !== 'undefined') {
                    previousUncheckedCount = 0;
                }

                // ========== ç¬¬ä¸ƒæ­¥ï¼šæ¸…ç†è¯äº‘ ==========
                console.log('ğŸ§¹ æ¸…ç†è¯äº‘...');
                if (typeof wordCloudChart !== 'undefined' && wordCloudChart) {
                    try {
                        wordCloudChart.dispose();
                        wordCloudChart = null;
                        console.log('âœ… è¯äº‘å·²æ¸…ç†');
                    } catch (err) {
                        console.warn('âš ï¸ æ¸…ç†è¯äº‘å¤±è´¥:', err);
                    }
                }

                // æ¸…ç©ºè¯äº‘å®¹å™¨
                const wordCloudContainer = document.getElementById('wordCloudContainer');
                if (wordCloudContainer) {
                    wordCloudContainer.innerHTML = '';
                    console.log('âœ… è¯äº‘å®¹å™¨å·²æ¸…ç©º');
                }

                // ========== ç¬¬å…«æ­¥ï¼šæ¸…ç©ºåˆ—è¡¨æ˜¾ç¤º ==========
                console.log('ğŸ§¹ æ¸…ç©ºåˆ—è¡¨...');
                
                const checkedInList = document.getElementById('checkedInList');
                if (checkedInList) {
                    checkedInList.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-4xl mb-2">ğŸ“</p>
                            <p class="text-sm">æš‚æ— ç­¾åˆ°è®°å½•</p>
                        </div>
                    `;
                }

                const uncheckedList = document.getElementById('uncheckedList');
                if (uncheckedList) {
                    uncheckedList.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-4xl mb-2">ğŸ‘¥</p>
                            <p class="text-sm">æš‚æ— å­¦ç”Ÿä¿¡æ¯</p>
                        </div>
                    `;
                }

                // é‡ç½®è®¡æ•°æ˜¾ç¤º
                const checkedCount = document.getElementById('checkedCount');
                if (checkedCount) checkedCount.textContent = '0';

                const uncheckedCount = document.getElementById('uncheckedCount');
                if (uncheckedCount) uncheckedCount.textContent = '0';

                // é‡ç½®è¿›åº¦æ¡
                const progressBarFill = document.getElementById('progressBarFill');
                if (progressBarFill) progressBarFill.style.width = '0%';

                const progressText = document.getElementById('progressText');
                if (progressText) progressText.textContent = '0 / 0 (0%)';

                // é‡ç½®å€’è®¡æ—¶æ˜¾ç¤º
                const countdown = document.getElementById('countdown');
                if (countdown) {
                    countdown.textContent = 'â±ï¸ å‡†å¤‡ä¸­...';
                    countdown.className = 'text-lg font-bold text-green-600';
                }


                // ğŸ”¥ æ¸…ç©ºç­çº§é€‰æ‹©
                const checkboxes = document.querySelectorAll('#selectClass input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);

                // æ¸…ç©ºè‡ªå®šä¹‰è¾“å…¥æ¡†
                document.getElementById('customClassInput').value = '';

                // æ¸…ç©ºæ‰€æœ‰å·²é€‰æ ‡ç­¾
                const tagsContainer = document.getElementById('selectedClassesTags');
                if (tagsContainer) {
                    tagsContainer.innerHTML = '';
                    tagsContainer.classList.add('hidden');
                }
                updateClassCount();
                updateSelectedClasses();
                // ========== å®Œæˆ ==========
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('âœ… ç­¾åˆ°å·²ç»“æŸ');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                // æ˜¾ç¤ºç»“æœ
                alert(`âœ… ç­¾åˆ°å·²ç»“æŸï¼\n\n` +
                    `åº”åˆ°ï¼š${total}äºº\n` +
                    `å®åˆ°ï¼š${finalChecked}äºº\n` +
                    `ç¼ºå‹¤ï¼š${finalUnchecked}äºº\n` +
                    `å‡ºå‹¤ç‡ï¼š${finalPercentage}%\n\n` +
                    `ç­¾åˆ°ç»“æœå·²ä¿å­˜åˆ°äº‘ç«¯ã€‚`);

                // æ˜¾ç¤ºé€šçŸ¥
                if (typeof showNotification === 'function') {
                    showNotification(
                        'âœ… ç­¾åˆ°å·²ç»“æŸ',
                        `å‡ºå‹¤ç‡ ${finalPercentage}% | ${finalChecked}/${total} äººå·²ç­¾åˆ°`
                    );
                }

            } catch (error) {
                console.error('âŒ ç»“æŸç­¾åˆ°å¤±è´¥:', error);
                
                // è¯¦ç»†çš„é”™è¯¯æç¤º
                let errorMessage = 'ç»“æŸç­¾åˆ°å¤±è´¥ï¼š\n\n';
                if (error.code === 101) {
                    errorMessage += 'âŒ ç­¾åˆ°ä¼šè¯ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤';
                } else if (error.code === 403) {
                    errorMessage += 'âŒ æƒé™ä¸è¶³ï¼Œæ— æ³•æ›´æ–°æ•°æ®';
                } else if (error.code === 1) {
                    errorMessage += 'âŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                } else if (error.message) {
                    errorMessage += `âŒ ${error.message}`;
                } else {
                    errorMessage += 'âŒ æœªçŸ¥é”™è¯¯';
                }
                
                if (error.code) {
                    errorMessage += `\n\né”™è¯¯ä»£ç ï¼š${error.code}`;
                }
                
                alert(errorMessage);
            }
        }

        // Export to Excel - Enhanced version  
        async function exportToExcel() {  
            if (!currentCheckInSession || !currentCheckInSession.id) {  
                alert('âŒ å½“å‰æ²¡æœ‰ç­¾åˆ°ä»»åŠ¡');  
                return;  
            }  

            try {  
                // Force refresh data before export  
                await refreshCheckInData();  

                const total = currentCheckInSession.students.length;  
                const checked = checkedInStudents.length;  
                const absent = total - checked;  

                // Main data sheet  
                const data = currentCheckInSession.students.map((s, index) => {  
                    const checkedIn = checkedInStudents.find(c => c.studentId === s.studentId);  
                    return {  
                        'åºå·': index + 1,  
                        'ç­çº§': s.className,  
                        'å­¦å·': s.studentId,  
                        'å§“å': s.name,  
                        'ç­¾åˆ°çŠ¶æ€': checkedIn ? 'âœ“ å·²ç­¾åˆ°' : 'âœ— æœªç­¾åˆ°',  
                        'ç­¾åˆ°æ—¶é—´': checkedIn ? new Date(checkedIn.checkInTime).toLocaleString('zh-CN', {  
                            year: 'numeric',  
                            month: '2-digit',  
                            day: '2-digit',  
                            hour: '2-digit',  
                            minute: '2-digit',  
                            second: '2-digit'  
                        }) : '',  
                        'å®šä½ä¿¡æ¯': checkedIn ? checkedIn.location : ''  
                    };  
                });  

                const ws = XLSX.utils.json_to_sheet(data);  
                
                // Set column widths  
                ws['!cols'] = [  
                    { wch: 6 },  // åºå·  
                    { wch: 20 }, // ç­çº§  
                    { wch: 12 }, // å­¦å·  
                    { wch: 10 }, // å§“å  
                    { wch: 12 }, // ç­¾åˆ°çŠ¶æ€  
                    { wch: 20 }, // ç­¾åˆ°æ—¶é—´  
                    { wch: 40 }  // å®šä½ä¿¡æ¯  
                ];  

                const wb = XLSX.utils.book_new();  
                XLSX.utils.book_append_sheet(wb, ws, 'ç­¾åˆ°è®°å½•');  

                // Summary sheet  
                const summary = [  
                    ['ç­¾åˆ°ç»Ÿè®¡æŠ¥è¡¨'],  
                    [''],  
                    ['è¯¾ç¨‹åç§°', currentCheckInSession.courseName],  
                    ['è¯¾ç¨‹èŠ‚æ¬¡', currentCheckInSession.courseSession],  
                    ['ç­çº§', currentCheckInSession.className],  
                    ['å¼€å§‹æ—¶é—´', new Date(currentCheckInSession.startTime).toLocaleString('zh-CN')],  
                    ['ç»“æŸæ—¶é—´', currentCheckInSession.status === 'completed' ? new Date().toLocaleString('zh-CN') : 'è¿›è¡Œä¸­'],  
                    [''],  
                    ['åº”åˆ°äººæ•°', total],  
                    ['å®åˆ°äººæ•°', checked],  
                    ['ç¼ºå‹¤äººæ•°', absent],  
                    ['å‡ºå‹¤ç‡', `${(checked/total*100).toFixed(2)}%`],  
                    [''],  
                    ['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]  
                ];  
                
                const ws2 = XLSX.utils.aoa_to_sheet(summary);  
                ws2['!cols'] = [{ wch: 15 }, { wch: 30 }];  
                XLSX.utils.book_append_sheet(wb, ws2, 'ç»Ÿè®¡æ‘˜è¦');  

                // Absent students sheet  
                const absentStudents = currentCheckInSession.students.filter(  
                    s => !checkedInStudents.find(c => c.studentId === s.studentId)  
                );  
                
                if (absentStudents.length > 0) {  
                    const absentData = absentStudents.map((s, index) => ({  
                        'åºå·': index + 1,  
                        'ç­çº§': s.className,  
                        'å­¦å·': s.studentId,  
                        'å§“å': s.name  
                    }));  
                    const ws3 = XLSX.utils.json_to_sheet(absentData);  
                    ws3['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 12 }, { wch: 10 }];  
                    XLSX.utils.book_append_sheet(wb, ws3, 'ç¼ºå‹¤åå•');  
                }  

                // Generate filename  
                const now = new Date();  
                const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;  
                const timeStr = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;  
                const filename = `${currentCheckInSession.courseName}_${dateStr}_${timeStr}.xlsx`;  
                
                XLSX.writeFile(wb, filename);  
                
                alert(`âœ… Excelå¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶åï¼š${filename}\n\nåŒ…å«å†…å®¹ï¼š\nâœ“ ç­¾åˆ°è®°å½•ï¼ˆå…¨éƒ¨å­¦ç”Ÿï¼‰\nâœ“ ç»Ÿè®¡æ‘˜è¦\n${absentStudents.length > 0 ? 'âœ“ ç¼ºå‹¤åå•' : ''}\n\nå…± ${total} äººï¼Œå·²ç­¾åˆ° ${checked} äºº`);  
            } catch (error) {  
                console.error('å¯¼å‡ºå¤±è´¥:', error);  
                alert('âŒ å¯¼å‡ºå¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // View history sessions - ä¿®å¤ç‰ˆ
        async function viewHistory() {
            try {
                const query = new AV.Query('CheckInSession');
                query.descending('createdAt');
                query.limit(50);
                const sessions = await query.find();

                if (sessions.length === 0) {
                    alert('æš‚æ— å†å²è®°å½•');
                    return;
                }

                const historyList = document.getElementById('historyList');
                historyList.innerHTML = sessions.map((session, index) => {
                    const courseName = session.get('courseName') || 'æœªå‘½åè¯¾ç¨‹';
                    const courseSession = session.get('courseSession') || 'æœªçŸ¥èŠ‚æ¬¡';
                    const className = session.get('className') || 'æœªçŸ¥ç­çº§';
                    const startTime = session.get('startTime') || session.createdAt;
                    const status = session.get('status') || 'unknown';
                    const totalStudents = session.get('totalStudents') || 0;
                    const checkedInCount = session.get('checkedInCount') || 0;
                    
                    // éªŒè¯æ•°æ®å®Œæ•´æ€§
                    const isValid = courseName !== 'æœªå‘½åè¯¾ç¨‹' && startTime;
                    
                    // è®¡ç®—å‡ºå‹¤ç‡
                    const attendanceRate = totalStudents > 0 ? (checkedInCount / totalStudents * 100).toFixed(1) : 0;

                    // æ ¼å¼åŒ–æ—¶é—´
                    let formattedTime = 'Invalid Date';
                    try {
                        if (startTime) {
                            formattedTime = new Date(startTime).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    } catch (e) {
                        console.error('æ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', e);
                    }

                    // å¦‚æœæ˜¯æ— æ•ˆæ•°æ®ï¼Œæ˜¾ç¤ºè­¦å‘Šæ ·å¼
                    const invalidStyle = !isValid ? 'bg-red-50 border-red-300' : '';
                    const invalidBadge = !isValid ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded ml-2">âš ï¸ æ•°æ®å¼‚å¸¸</span>' : '';

                    return `
                        <div class="border rounded-lg p-4 hover:bg-gray-50 ${status === 'active' ? 'border-green-500 bg-green-50' : 'border-gray-300'} ${invalidStyle}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-lg">${courseName} - ${courseSession}${invalidBadge}</h3>
                                    <p class="text-gray-600 text-sm">ç­çº§ï¼š${className}</p>
                                    <p class="text-gray-600 text-sm">æ—¶é—´ï¼š${formattedTime}</p>
                                    ${!isValid ? '<p class="text-red-600 text-xs mt-1">âš ï¸ è¯¥è®°å½•å¯èƒ½æ˜¯å­¦ç”Ÿè¯¯æ“ä½œåˆ›å»ºï¼Œå»ºè®®åˆ é™¤</p>' : ''}
                                </div>
                                <span class="px-3 py-1 rounded text-sm ${status === 'active' ? 'bg-green-600 text-white' : 'bg-gray-500 text-white'}">
                                    ${status === 'active' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}
                                </span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-sm mb-3">
                                <div class="bg-blue-50 p-2 rounded text-center">
                                    <p class="text-gray-600">åº”åˆ°</p>
                                    <p class="font-bold text-blue-600">${totalStudents}</p>
                                </div>
                                <div class="bg-green-50 p-2 rounded text-center">
                                    <p class="text-gray-600">å®åˆ°</p>
                                    <p class="font-bold text-green-600">${checkedInCount}</p>
                                </div>
                                <div class="bg-red-50 p-2 rounded text-center">
                                    <p class="text-gray-600">ç¼ºå‹¤</p>
                                    <p class="font-bold text-red-600">${totalStudents - checkedInCount}</p>
                                </div>
                                <div class="bg-purple-50 p-2 rounded text-center">
                                    <p class="text-gray-600">å‡ºå‹¤ç‡</p>
                                    <p class="font-bold text-purple-600">${attendanceRate}%</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${isValid && status === 'completed' ? `
                                    <button onclick="exportHistorySession('${session.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex-1">
                                        ğŸ“¥ å¯¼å‡ºExcel
                                    </button>
                                ` : ''}
                                <button onclick="deleteHistorySession('${session.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 ${!isValid ? 'flex-1' : ''}">
                                    ğŸ—‘ï¸ åˆ é™¤${!isValid ? 'å¼‚å¸¸è®°å½•' : ''}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // æ›´æ–°å†å²è®°å½•è®¡æ•°
                updateHistoryCount();

                document.getElementById('checkInStatus').classList.add('hidden');
                document.getElementById('historyPanel').classList.remove('hidden');
                
                console.log(`âœ… æ˜¾ç¤º ${sessions.length} æ¡å†å²è®°å½•`);
                
            } catch (error) {
                console.error('âŒ åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                alert(`âŒ åŠ è½½å†å²è®°å½•å¤±è´¥ï¼š${error.message}`);
            }
        }
        // Hide history panel  
        function hideHistory() {  
            document.getElementById('historyPanel').classList.add('hidden');  
            if (currentCheckInSession) {  
                document.getElementById('checkInStatus').classList.remove('hidden');  
            }  
        }  

        // Delete history session  
        async function deleteHistorySession(sessionId) {  
            if (!confirm('âš ï¸ ç¡®å®šåˆ é™¤æ­¤ç­¾åˆ°è®°å½•å—ï¼Ÿ\n\nåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼ŒåŒ…æ‹¬ï¼š\nâ€¢ ç­¾åˆ°ä¼šè¯ä¿¡æ¯\nâ€¢ æ‰€æœ‰ç­¾åˆ°è®°å½•\n\nå»ºè®®å…ˆå¯¼å‡ºExcelå†åˆ é™¤ï¼')) {  
                return;  
            }  

            try {  
                // Delete check-in records first  
                const recordQuery = new AV.Query('CheckInRecord');  
                recordQuery.equalTo('sessionId', sessionId);  
                recordQuery.limit(1000);  
                const records = await recordQuery.find();  
                
                if (records.length > 0) {  
                    await AV.Object.destroyAll(records);  
                    console.log(`âœ… åˆ é™¤äº† ${records.length} æ¡ç­¾åˆ°è®°å½•`);  
                }  

                // Delete session  
                const sessionQuery = new AV.Query('CheckInSession');  
                const session = await sessionQuery.get(sessionId);  
                await session.destroy();  

                alert(`âœ… åˆ é™¤æˆåŠŸï¼\n\nå·²åˆ é™¤ç­¾åˆ°ä¼šè¯åŠå…¶ ${records.length} æ¡ç­¾åˆ°è®°å½•`);  
                
                // Refresh history list  
                viewHistory();  
            } catch (error) {  
                console.error('åˆ é™¤å¤±è´¥:', error);  
                alert('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message);  
            }  
        }  

        // Export history session  
        async function exportHistorySession(sessionId) {  
            try {  
                // Get session info  
                const query = new AV.Query('CheckInSession');  
                const session = await query.get(sessionId);  

                const courseName = session.get('courseName');  
                const courseSession = session.get('courseSession');  
                const className = session.get('className');  
                const startTime = session.get('startTime');  
                const endTime = session.get('endTime');  
                const results = session.get('results') || [];  

                if (results.length === 0) {  
                    alert('âŒ è¯¥ç­¾åˆ°è®°å½•æ— è¯¦ç»†æ•°æ®');  
                    return;  
                }  

                // Main data sheet  
                const data = results.map((r, index) => ({  
                    'åºå·': index + 1,
                    'ç­çº§': r.className,
                    'å­¦å·': r.studentId,
                    'å§“å': r.name,
                    'ç­¾åˆ°çŠ¶æ€': r.status === 'present' ? 'âœ“ å·²ç­¾åˆ°' : 'âœ— æœªç­¾åˆ°',
                    'ç­¾åˆ°æ—¶é—´': r.checkInTime ? new Date(r.checkInTime).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }) : '',
                    'å®šä½ä¿¡æ¯': r.location || ''
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 6 },  // åºå·
                    { wch: 20 }, // ç­çº§
                    { wch: 12 }, // å­¦å·
                    { wch: 10 }, // å§“å
                    { wch: 12 }, // ç­¾åˆ°çŠ¶æ€
                    { wch: 20 }, // ç­¾åˆ°æ—¶é—´
                    { wch: 40 }  // å®šä½ä¿¡æ¯
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ç­¾åˆ°è®°å½•');

                // Summary sheet
                const totalStudents = results.length;
                const checkedInCount = results.filter(r => r.status === 'present').length;
                const absentCount = totalStudents - checkedInCount;

                const summary = [
                    ['ç­¾åˆ°ç»Ÿè®¡æŠ¥è¡¨'],
                    [''],
                    ['è¯¾ç¨‹åç§°', courseName],
                    ['è¯¾ç¨‹èŠ‚æ¬¡', courseSession],
                    ['ç­çº§', className],
                    ['å¼€å§‹æ—¶é—´', new Date(startTime).toLocaleString('zh-CN')],
                    ['ç»“æŸæ—¶é—´', endTime ? new Date(endTime).toLocaleString('zh-CN') : 'æœªè®°å½•'],
                    [''],
                    ['åº”åˆ°äººæ•°', totalStudents],
                    ['å®åˆ°äººæ•°', checkedInCount],
                    ['ç¼ºå‹¤äººæ•°', absentCount],
                    ['å‡ºå‹¤ç‡', `${(checkedInCount/totalStudents*100).toFixed(2)}%`],
                    [''],
                    ['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]
                ];
                
                const ws2 = XLSX.utils.aoa_to_sheet(summary);
                ws2['!cols'] = [{ wch: 15 }, { wch: 30 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'ç»Ÿè®¡æ‘˜è¦');

                // Absent students sheet
                const absentStudents = results.filter(r => r.status === 'absent');
                
                if (absentStudents.length > 0) {
                    const absentData = absentStudents.map((s, index) => ({
                        'åºå·': index + 1,
                        'ç­çº§': s.className,
                        'å­¦å·': s.studentId,
                        'å§“å': s.name
                    }));
                    const ws3 = XLSX.utils.json_to_sheet(absentData);
                    ws3['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 12 }, { wch: 10 }];
                    XLSX.utils.book_append_sheet(wb, ws3, 'ç¼ºå‹¤åå•');
                }

                // Generate filename
                const now = new Date();
                const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
                const timeStr = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
                const filename = `${courseName}_${dateStr}_${timeStr}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                alert(`âœ… å†å²è®°å½•å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶åï¼š${filename}\n\nåŒ…å«å†…å®¹ï¼š\nâœ“ ç­¾åˆ°è®°å½•ï¼ˆå…¨éƒ¨å­¦ç”Ÿï¼‰\nâœ“ ç»Ÿè®¡æ‘˜è¦\n${absentStudents.length > 0 ? 'âœ“ ç¼ºå‹¤åå•' : ''}\n\nå…± ${totalStudents} äººï¼Œå·²ç­¾åˆ° ${checkedInCount} äºº`);
            } catch (error) {
                console.error('å¯¼å‡ºå†å²è®°å½•å¤±è´¥:', error);
                alert('âŒ å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // æ›´æ–°å†å²è®°å½•è®¡æ•°
        async function updateHistoryCount() {
            try {
                const query = new AV.Query('CheckInSession');
                const count = await query.count();
                const countElement = document.getElementById('historyCount');
                if (countElement) {
                    countElement.textContent = count;
                }
                console.log(`âœ… å†å²è®°å½•æ•°é‡: ${count}`);
            } catch (error) {
                console.error('è·å–å†å²è®°å½•æ•°é‡å¤±è´¥:', error);
            }
        }

        // ==================== æ£€æŸ¥æ´»åŠ¨ä¼šè¯ï¼ˆå®Œæ•´ç‰ˆï¼‰====================
// ==================== æ£€æŸ¥æ´»åŠ¨ä¼šè¯ï¼ˆæ”¯æŒå®šæ—¶ä»»åŠ¡ï¼‰====================
async function checkActiveSession() {
    try {
        console.log('ğŸ”æ£€æŸ¥æ´»åŠ¨ç­¾åˆ°ä¼šè¯...');
        
        // ğŸ”¥ ç¬¬ä¸€æ­¥ï¼šå…ˆæ£€æŸ¥æ˜¯å¦æœ‰å®šæ—¶ä»»åŠ¡
        console.log('ğŸ”æ£€æŸ¥å®šæ—¶ä»»åŠ¡...');
        const scheduledQuery = new AV.Query('CheckInSession');
        scheduledQuery.equalTo('status', 'scheduled');
        scheduledQuery.descending('createdAt');
        const scheduledSession = await scheduledQuery.first();
        
        if (scheduledSession) {
            const scheduledTime = scheduledSession.get('scheduledTime');
            const courseName = scheduledSession.get('courseName');
            const courseSession = scheduledSession.get('courseSession');
            const classNames = scheduledSession.get('classNames') || [scheduledSession.get('className')];
            const students = scheduledSession.get('students') || [];
            const duration = scheduledSession.get('duration');
            
            console.log('âœ… å‘ç°å®šæ—¶ä»»åŠ¡:', scheduledSession.id);
            console.log('ğŸ“… å‘å¸ƒæ—¶é—´:', new Date(scheduledTime).toLocaleString('zh-CN'));
            
            // æ˜¾ç¤ºå®šæ—¶ä»»åŠ¡å€’è®¡æ—¶ç•Œé¢
            showScheduledTaskUI(
                scheduledSession.id,
                new Date(scheduledTime),
                courseName,
                courseSession,
                classNames,
                students.length,
                duration
            );
            return;
        }
        
        // ç¬¬äºŒæ­¥ï¼šæŸ¥è¯¢æ´»åŠ¨çš„ç­¾åˆ°ä¼šè¯ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
        const query = new AV.Query('CheckInSession');
        query.equalTo('status', 'active');
        query.descending('createdAt');
        query.limit(1);
        const activeSession = await query.first();

        if (!activeSession) {
            console.log('â„¹ï¸æœªå‘ç°æ´»åŠ¨çš„ç­¾åˆ°ä¼šè¯');
            // ç¡®ä¿æ˜¾ç¤ºè®¾ç½®é¢æ¿
            const setupPanel = document.getElementById('setupPanel');
            const checkInStatus = document.getElementById('checkInStatus');
            if (setupPanel) setupPanel.classList.remove('hidden');
            if (checkInStatus) checkInStatus.classList.add('hidden');
            return;
        }

        console.log('âœ…å‘ç°æ´»åŠ¨ä¼šè¯:', activeSession.id);

        // æ¢å¤ä¼šè¯ä¿¡æ¯
        const classNames = activeSession.get('classNames') || [activeSession.get('className')];
        const students = activeSession.get('students') || [];

        currentCheckInSession = {
            id: activeSession.id,
            courseName: activeSession.get('courseName') || 'æœªçŸ¥è¯¾ç¨‹',
            courseSession: activeSession.get('courseSession') || 'æœªçŸ¥èŠ‚æ¬¡',
            classNames: classNames,
            className: classNames.join('ã€'),
            duration: activeSession.get('duration') || 30,
            requireLocation: activeSession.get('requireLocation') || false,
            startTime: activeSession.get('startTime') || new Date(),
            status: 'active',
            students: students,
            totalStudents: students.length
        };

        console.log('âœ…ä¼šè¯ä¿¡æ¯å·²æ¢å¤:', currentCheckInSession);

        // åŠ è½½ç­¾åˆ°è®°å½•
        console.log('ğŸ“¥åŠ è½½ç­¾åˆ°è®°å½•...');
        try {
            const recordQuery = new AV.Query('CheckInRecord');
            recordQuery.equalTo('sessionId', activeSession.id);
            recordQuery.descending('checkInTime');
            recordQuery.limit(1000);
            const records = await recordQuery.find();

            console.log(`âœ…æ‰¾åˆ°${records.length} æ¡ç­¾åˆ°è®°å½•`);

            // è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡æ•°ç»„
            checkedInStudents = records.map(obj => ({
                className: obj.get('className'),
                studentId: obj.get('studentId'),
                name: obj.get('studentName'),
                location: obj.get('location'),
                checkInTime: obj.get('checkInTime')
            }));

            console.log('âœ…ç­¾åˆ°è®°å½•å·²åŠ è½½:', checkedInStudents.length, 'äºº');
        } catch (recordError) {
            console.error('âŒåŠ è½½ç­¾åˆ°è®°å½•å¤±è´¥:', recordError);
            checkedInStudents = [];
        }

        // æ¢å¤UIçŠ¶æ€
        console.log('ğŸ¨æ¢å¤UIçŠ¶æ€...');
        const setupPanel = document.getElementById('setupPanel');
        const checkInStatus = document.getElementById('checkInStatus');

        if (setupPanel) setupPanel.classList.add('hidden');
        if (checkInStatus) checkInStatus.classList.remove('hidden');

        // æ›´æ–°è¯¾ç¨‹ä¿¡æ¯æ˜¾ç¤º
        const currentCourse = document.getElementById('currentCourse');
        const currentClass = document.getElementById('currentClass');
        
        if (currentCourse) {
            currentCourse.textContent = `${currentCheckInSession.courseName} - ${currentCheckInSession.courseSession}`;
            console.log('âœ…è¯¾ç¨‹ä¿¡æ¯å·²æ˜¾ç¤º');
        }
        
        if (currentClass) {
            currentClass.textContent = currentCheckInSession.className;
            console.log('âœ…ç­çº§ä¿¡æ¯å·²æ˜¾ç¤º');
        }

        // åˆå§‹åŒ–è¯äº‘è®¡æ•°å™¨
        if (typeof previousUncheckedCount !== 'undefined') {
            previousUncheckedCount = students.length;
            console.log('âœ…è¯äº‘è®¡æ•°å™¨å·²åˆå§‹åŒ–:', previousUncheckedCount);
        }

        // ========== åˆå§‹åŒ–æ‰€æœ‰æ˜¾ç¤ºåŠŸèƒ½ ==========
        console.log('ğŸ“Šåˆå§‹åŒ–æ˜¾ç¤ºåŠŸèƒ½...');

        // 1. æ›´æ–°è¯äº‘
        try {
            if (typeof updateWordCloud === 'function') {
                updateWordCloud();
                console.log('âœ…è¯äº‘å·²åˆå§‹åŒ–');
            }
        } catch (error) {
            console.error('âŒè¯äº‘åˆå§‹åŒ–å¤±è´¥:', error);
        }

        // 2. æ›´æ–°è¿›åº¦æ¡
        try {
            if (typeof updateProgress === 'function') {
                updateProgress();
                console.log('âœ…è¿›åº¦æ˜¾ç¤ºå·²åˆå§‹åŒ–');
            }
        } catch (error) {
            console.error('âŒè¿›åº¦æ˜¾ç¤ºåˆå§‹åŒ–å¤±è´¥:', error);
        }

        // 3. âœ…æ›´æ–°å·²ç­¾åˆ°åˆ—è¡¨
        try {
            if (typeof updateCheckedInList === 'function') {
                updateCheckedInList();
                console.log('âœ…å·²ç­¾åˆ°åˆ—è¡¨å·²åˆå§‹åŒ–');
            } else {
                console.warn('âš ï¸updateCheckedInList å‡½æ•°ä¸å­˜åœ¨');
            }
        } catch (error) {
            console.error('âŒå·²ç­¾åˆ°åˆ—è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
        }

        // 4. âœ…æ›´æ–°æœªç­¾åˆ°åˆ—è¡¨
        try {
            if (typeof updateUncheckedList === 'function') {
                updateUncheckedList();
                console.log('âœ…æœªç­¾åˆ°åˆ—è¡¨å·²åˆå§‹åŒ–');
            } else {
                console.warn('âš ï¸updateUncheckedList å‡½æ•°ä¸å­˜åœ¨');
            }
        } catch (error) {
            console.error('âŒæœªç­¾åˆ°åˆ—è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
        }

        // 5. å¼€å§‹å®šæ—¶åˆ·æ–°
        console.log('ğŸ”„å¯åŠ¨è‡ªåŠ¨åˆ·æ–°...');
        if (typeof startPolling === 'function') {
            startPolling();
        } else {
            console.warn('âš ï¸startPolling å‡½æ•°ä¸å­˜åœ¨');
        }

        // 6. æ¢å¤å€’è®¡æ—¶
        console.log('â±ï¸æ¢å¤å€’è®¡æ—¶...');
        try {
            const startTime = new Date(currentCheckInSession.startTime);
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000); // å·²è¿‡ç§’æ•°
            const totalSeconds = currentCheckInSession.duration * 60; // æ€»ç§’æ•°
            const remainingSeconds = Math.max(0, totalSeconds - elapsed); // å‰©ä½™ç§’æ•°
            const remainingMinutes = Math.ceil(remainingSeconds / 60); // å‰©ä½™åˆ†é’Ÿ

            console.log('â±ï¸æ—¶é—´è®¡ç®—:', {
                å¼€å§‹æ—¶é—´: startTime.toLocaleString('zh-CN'),
                å½“å‰æ—¶é—´: now.toLocaleString('zh-CN'),
                å·²è¿‡ç§’æ•°: elapsed,
                å‰©ä½™ç§’æ•°: remainingSeconds,
                å‰©ä½™åˆ†é’Ÿ: remainingMinutes
            });

            if (remainingSeconds > 0) {
                if (typeof setupCountdown === 'function') {
                    setupCountdown(remainingMinutes);
                    console.log(`âœ…å€’è®¡æ—¶å·²æ¢å¤ï¼Œå‰©ä½™ ${remainingMinutes} åˆ†é’Ÿ`);
                }
            } else {
                console.warn('âš ï¸ç­¾åˆ°æ—¶é—´å·²åˆ°');
                const countdownElement = document.getElementById('countdown');
                if (countdownElement) {
                    countdownElement.textContent = 'â°ç­¾åˆ°æ—¶é—´å·²åˆ°';
                    countdownElement.className = 'text-red-600 font-bold';
                }
            }
        } catch (error) {
            console.error('âŒå€’è®¡æ—¶æ¢å¤å¤±è´¥:', error);
        }

        // æ˜¾ç¤ºæ¢å¤æˆåŠŸé€šçŸ¥
        console.log('âœ…ç­¾åˆ°ä¼šè¯å·²æˆåŠŸæ¢å¤');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ“Šå½“å‰çŠ¶æ€:');
        console.log('  è¯¾ç¨‹:', currentCheckInSession.courseName);
        console.log('  èŠ‚æ¬¡:', currentCheckInSession.courseSession);
        console.log('  ç­çº§:', currentCheckInSession.className);
        console.log('  åº”åˆ°:', currentCheckInSession.totalStudents, 'äºº');
        console.log('  å®åˆ°:', checkedInStudents.length, 'äºº');
        console.log('  æœªåˆ°:', currentCheckInSession.totalStudents - checkedInStudents.length, 'äºº');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

        // æ˜¾ç¤ºè½»æç¤ºï¼ˆä¸æ‰“æ–­ç”¨æˆ·ï¼‰
        showNotification(
            'âœ…ç­¾åˆ°ä¼šè¯å·²æ¢å¤',
            `${currentCheckInSession.courseName} - å·²ç­¾åˆ° ${checkedInStudents.length}/${currentCheckInSession.totalStudents} äºº`
        );

    } catch (error) {
        console.error('âŒæ£€æŸ¥æ´»åŠ¨ä¼šè¯å¤±è´¥:', error);
        
        // è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        if (error.code === 101) {
            console.warn('âš ï¸CheckInSession è¡¨ä¸å­˜åœ¨');
        } else if (error.code === 403) {
            console.error('âŒæƒé™ä¸è¶³ï¼Œæ— æ³•æŸ¥è¯¢ç­¾åˆ°ä¼šè¯');
        } else if (error.code === 1) {
            console.error('âŒç½‘ç»œè¿æ¥å¤±è´¥');
        } else {
            console.error('âŒæœªçŸ¥é”™è¯¯:', error.message);
        }

        // ç¡®ä¿æ˜¾ç¤ºè®¾ç½®é¢æ¿ï¼ˆå¤±è´¥æ—¶çš„é»˜è®¤çŠ¶æ€ï¼‰
        const setupPanel = document.getElementById('setupPanel');
        const checkInStatus = document.getElementById('checkInStatus');
        if (setupPanel) setupPanel.classList.remove('hidden');
        if (checkInStatus) checkInStatus.classList.add('hidden');
    }
}

        // ==================== è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé€šçŸ¥ ====================
        function showNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-xl">âœ…</span>
                    <div>
                        <p class="font-bold">${title}</p>
                        <p class="text-sm opacity-90">${message}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s, transform 0.3s';
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ ====================
        window.addEventListener('load', function() {
            console.log('ğŸ“„ é¡µé¢å·²åŠ è½½');
            console.log('ğŸ” è‡ªåŠ¨æ£€æŸ¥æ´»åŠ¨ä¼šè¯...');
            
            // å»¶è¿Ÿ100msæ‰§è¡Œï¼Œç¡®ä¿DOMå®Œå…¨å°±ç»ª
            setTimeout(() => {
                checkActiveSession();
            }, 100);
        });

        // ==================== é¡µé¢å¯è§æ—¶åˆ·æ–° ====================
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('ğŸ‘€ é¡µé¢å·²å¯è§');
                
                // å¦‚æœæœ‰æ´»åŠ¨ä¼šè¯ï¼Œåˆ·æ–°æ•°æ®
                if (currentCheckInSession && currentCheckInSession.id) {
                    console.log('ğŸ”„ åˆ·æ–°ç­¾åˆ°æ•°æ®...');
                    if (typeof refreshCheckInData === 'function') {
                        refreshCheckInData();
                    }
                }
            }
        });

        // ==================== æ‰‹æœºç«¯å®šä½ï¼ˆç®€æ´ç‰ˆï¼‰====================
        
        function getLocation() {
    const locationBtn = document.getElementById('locationBtn');
    const locationInput = document.getElementById('location');
    locationBtn.disabled = true;
    locationBtn.textContent = 'ğŸ”„å®šä½ä¸­...';
    locationInput.value = 'ğŸ“æ­£åœ¨è·å–æ‰‹æœºå®šä½ï¼Œè¯·ç¨å€™...';
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ“å¼€å§‹è·å–å®šä½');
    if (!navigator.geolocation) {
        console.error('âŒè®¾å¤‡ä¸æ”¯æŒå®šä½');
        locationInput.value = 'æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒå®šä½ï¼ˆå¯ç»§ç»­ç­¾åˆ°ï¼‰';
        locationBtn.disabled = false;
        locationBtn.textContent = 'âŒä¸æ”¯æŒå®šä½';
        alert('âš ï¸æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒå®šä½åŠŸèƒ½\n\næ‚¨ä»å¯ç»§ç»­ç­¾åˆ°');
        return;
    }
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = Math.round(position.coords.accuracy);
            console.log('âœ…GPSå®šä½æˆåŠŸ:', {
                çº¬åº¦: lat,
                ç»åº¦: lng,
                ç²¾åº¦: accuracy + 'ç±³'
            });
            locationInput.value = `ğŸ“GPSå®šä½æˆåŠŸï¼ç²¾åº¦Â±${accuracy}ç±³\næ­£åœ¨è§£æåœ°å€...`;
            // ğŸ”¥ è°ƒç”¨é«˜å¾·åœ°å›¾APIè¿›è¡Œé€†åœ°ç†ç¼–ç   
            try {
                console.log('ğŸ—ºï¸ å¼€å§‹è°ƒç”¨é«˜å¾·åœ°å›¾API...');
                const AMAP_KEY = 'c476073c665a756538af618d0007ab72';
                const response = await fetch(
                    `https://restapi.amap.com/v3/geocode/regeo?key=${AMAP_KEY}&location=${lng},${lat}&extensions=all&output=json`,
                    {
                        method: 'GET',
                        mode: 'cors'
                    }
                );
                const data = await response.json();
                console.log('ğŸ—ºï¸ é«˜å¾·APIå“åº”:', data);
                if (data.status === '1' && data.regeocode) {
                    // ========== è§£æåœ°å€ä¿¡æ¯ ==========  
                    const addressComponent = data.regeocode.addressComponent;
                    const formattedAddress = data.regeocode.formatted_address || '';
                    // æå–è¯¦ç»†ä¿¡æ¯  
                    const province = addressComponent.province || '';
                    const city = addressComponent.city || addressComponent.province || '';
                    const district = addressComponent.district || '';
                    const township = addressComponent.township || '';
                    const street = addressComponent.streetNumber?.street || '';
                    const streetNumber = addressComponent.streetNumber?.number || '';
                    // è·å–é™„è¿‘POIï¼ˆå…´è¶£ç‚¹ï¼‰  
                    let poiName = '';
                    let poiType = '';
                    let poiDistance = '';
                    if (data.regeocode.pois && data.regeocode.pois.length > 0) {
                        const nearestPOI = data.regeocode.pois[0];
                        poiName = nearestPOI.name || '';
                        poiType = nearestPOI.type || '';
                        poiDistance = nearestPOI.distance ? `çº¦${nearestPOI.distance}ç±³` : '';
                    }
                    // ğŸ”¥ å°†è¯¦ç»†ä¿¡æ¯å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼ˆæ–¹ä¾¿æäº¤æ—¶ä½¿ç”¨ï¼‰  
                    window.locationData = {
                        latitude: lat,
                        longitude: lng,
                        accuracy: accuracy,
                        province: province,
                        city: city,
                        district: district,
                        township: township,
                        street: street,
                        streetNumber: streetNumber,
                        formattedAddress: formattedAddress,
                        poiName: poiName,
                        poiType: poiType,
                        poiDistance: poiDistance,
                        rawData: data.regeocode
                    };
                    
                    // ğŸ”¥ğŸ”¥ æ„å»ºæ˜¾ç¤ºæ–‡æœ¬ï¼ˆåªæ˜¾ç¤ºåœ°å€ï¼Œä¸æ˜¾ç¤ºåæ ‡ï¼‰ğŸ”¥ğŸ”¥
                    let displayText = '';

                    // ä¼˜å…ˆæ˜¾ç¤ºPOIåç§°ï¼ˆå¦‚ï¼šæ²ˆé˜³å·¥ä¸šå¤§å­¦æ•™å­¦æ¥¼Aåº§ï¼‰
                    if (poiName) {
                        displayText = `ğŸ“ ${poiName}`;
                        // å¦‚æœPOIè·ç¦»è¾ƒè¿‘ï¼ˆå°äº50ç±³ï¼‰ï¼Œè¯´æ˜å°±åœ¨è¿™ä¸ªä½ç½®
                        if (poiDistance && parseInt(poiDistance) < 50) {
                            displayText += `\nğŸ¢ ${formattedAddress}`;
                        } else if (poiDistance) {
                            displayText += ` (${poiDistance})`;
                            displayText += `\nğŸ¢ ${formattedAddress}`;
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰POIï¼Œæ˜¾ç¤ºè¯¦ç»†åœ°å€
                        displayText = `ğŸ“ ${formattedAddress}`;
                    }

                    // æ˜¾ç¤ºç²¾åº¦ä¿¡æ¯
                    displayText += `\nğŸ“Š å®šä½ç²¾åº¦ï¼šÂ±${accuracy}ç±³`;

                    locationInput.value = displayText;
                    
                    console.log('âœ… åœ°å€è§£ææˆåŠŸ');
                    console.log('è¯¦ç»†åœ°å€:', formattedAddress);
                    console.log('é™„è¿‘POI:', poiName);
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
                } else {
                    // APIè°ƒç”¨å¤±è´¥ï¼Œåªæ˜¾ç¤ºæç¤º  
                    console.warn('âš ï¸ é«˜å¾·APIè¿”å›é”™è¯¯:', data.info);
                    window.locationData = {
                        latitude: lat,
                        longitude: lng,
                        accuracy: accuracy,
                        formattedAddress: `å®šä½æˆåŠŸï¼Œåœ°å€è§£æå¤±è´¥`,
                        province: '',
                        city: '',
                        district: ''
                    };
                    locationInput.value =
                        `âš ï¸ åœ°å€è§£æå¤±è´¥\n` +
                        `ğŸ“Š å®šä½ç²¾åº¦: Â±${accuracy}ç±³\n` +
                        `ğŸ’¡ ${data.info || 'è¯·ç¨åé‡è¯•'}`;
                }
            } catch (error) {
                console.error('âŒ åœ°å€è§£æå¤±è´¥:', error);
                // è§£æå¤±è´¥ï¼Œåªä¿å­˜æç¤º  
                window.locationData = {
                    latitude: lat,
                    longitude: lng,
                    accuracy: accuracy,
                    formattedAddress: `å®šä½æˆåŠŸï¼Œåœ°å€è§£æå¤±è´¥`,
                    province: '',
                    city: '',
                    district: ''
                };
                locationInput.value =
                    `âš ï¸ åœ°å€è§£ææœåŠ¡æš‚æ—¶ä¸å¯ç”¨\n` +
                    `ğŸ“Š å®šä½ç²¾åº¦: Â±${accuracy}ç±³\n` +
                    `ğŸ’¡ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•`;
            }
            // æ›´æ–°æŒ‰é’®çŠ¶æ€  
            locationBtn.disabled = false;
            locationBtn.textContent = 'âœ…å®šä½æˆåŠŸ';
            locationBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            locationBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            // éœ‡åŠ¨åé¦ˆ  
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
        },
        (error) => {
            console.error('âŒå®šä½å¤±è´¥:', error);
            let errorMsg = '';
            let suggestion = '';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'å®šä½æƒé™è¢«æ‹’ç»';
                    suggestion = 'è¯·åœ¨æ‰‹æœºè®¾ç½®ä¸­å…è®¸æµè§ˆå™¨ä½¿ç”¨å®šä½';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'GPSä¿¡å·ä¸å¯ç”¨';
                    suggestion = 'è¯·ç§»åŠ¨åˆ°å®¤å¤–æˆ–çª—è¾¹ï¼Œç¡®ä¿GPSå·²å¼€å¯';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'å®šä½è¶…æ—¶';
                    suggestion = 'è¯·ç¡®ä¿GPSå·²å¼€å¯ï¼Œæˆ–ç§»åŠ¨åˆ°ä¿¡å·è¾ƒå¥½çš„åœ°æ–¹';
                    break;
                default:
                    errorMsg = 'å®šä½å¤±è´¥';
                    suggestion = 'è¯·æ£€æŸ¥å®šä½æƒé™å’ŒGPSæ˜¯å¦å¼€å¯';
            }
            window.locationData = {
                latitude: 0,
                longitude: 0,
                accuracy: 0,
                formattedAddress: errorMsg,
                province: '',
                city: '',
                district: ''
            };
            locationInput.value = `âŒ ${errorMsg}ï¼ˆå¯ç»§ç»­ç­¾åˆ°ï¼‰`;
            locationBtn.disabled = false;
            locationBtn.textContent = 'ğŸ“é‡æ–°å®šä½';
            alert(`âš ï¸${errorMsg}\n\nğŸ’¡${suggestion}\n\næ‚¨ä»å¯ç»§ç»­ç­¾åˆ°ï¼Œç³»ç»Ÿå°†è®°å½•"${errorMsg}"`);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 30000,
            maximumAge: 0
        }
    );
}



        // Open camera for face recognition (ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆ)
        async function openCamera() {
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“± æ‰“å¼€ç›¸æœº - ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆ');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            // 1. æ£€æŸ¥æ¨¡å‹åŠ è½½
            if (!faceModelsLoaded) {
                alert('äººè„¸è¯†åˆ«æ¨¡å‹åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            // 2. æ£€æŸ¥äººè„¸æ•°æ®
            if (labeledDescriptors.length === 0) {
                alert('âŒ ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰å­¦ç”Ÿäººè„¸æ•°æ®ï¼\n\nè¯·å…ˆåœ¨æ•™å¸ˆç«¯æ·»åŠ å­¦ç”Ÿç…§ç‰‡ä¿¡æ¯');
                return;
            }

            try {
                recognitionSuccess = false;
                document.getElementById('cameraBtn').disabled = true;
                document.getElementById('cameraBtn').textContent = 'æ­£åœ¨æ‰“å¼€ç›¸æœº...';

                // 3. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                console.log('æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ...');
                console.log('  User Agent:', navigator.userAgent);
                console.log('  Protocol:', location.protocol);
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç›¸æœºåŠŸèƒ½\n\nè¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Safari æˆ– Firefox');
                }

                // 4. æ£€æŸ¥ HTTPSï¼ˆé‡è¦ï¼ï¼‰
                const isLocalhost = ['localhost', '127.0.0.1', ''].includes(location.hostname);
                if (location.protocol === 'http:' && !isLocalhost) {
                    throw new Error('ç›¸æœºåŠŸèƒ½éœ€è¦ HTTPS è¿æ¥\n\nè¯·ä½¿ç”¨ HTTPS è®¿é—®é¡µé¢');
                }

                // 5. è¯·æ±‚ç›¸æœºæƒé™ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–çš„çº¦æŸæ¡ä»¶ï¼‰
                console.log('è¯·æ±‚ç›¸æœºæƒé™...');
                const constraints = {
                    video: {
                        facingMode: 'user', // å‰ç½®æ‘„åƒå¤´
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    },
                    audio: false
                };
                
                console.log('çº¦æŸæ¡ä»¶:', constraints);
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('âœ… ç›¸æœºæƒé™å·²æˆäºˆ');
                console.log('è§†é¢‘è½¨é“:', videoStream.getVideoTracks().length);

                // 6. é…ç½® video å…ƒç´ ï¼ˆç§»åŠ¨ç«¯å…³é”®ï¼ï¼‰
                const video = document.getElementById('video');
                const canvas = document.getElementById('faceCanvas');
                
                // ğŸ”¥ ç§»åŠ¨ç«¯å¿…é¡»è®¾ç½®è¿™äº›å±æ€§ï¼
                video.setAttribute('autoplay', '');
                video.setAttribute('playsinline', ''); // iOS Safari å¿…éœ€
                video.setAttribute('muted', '');
                video.muted = true; // é™éŸ³ï¼ˆé¿å…è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
                
                video.srcObject = videoStream;
                
                // 7. ç­‰å¾…è§†é¢‘åŠ è½½
                console.log('ç­‰å¾…è§†é¢‘åŠ è½½...');
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        console.log('âœ… è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½');
                        console.log('è§†é¢‘å°ºå¯¸:', video.videoWidth, 'x', video.videoHeight);
                        resolve();
                    };
                    
                    video.onerror = (e) => {
                        console.error('âŒ è§†é¢‘åŠ è½½é”™è¯¯:', e);
                        reject(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));
                    };
                    
                    // è¶…æ—¶å¤„ç†
                    setTimeout(() => {
                        reject(new Error('è§†é¢‘åŠ è½½è¶…æ—¶'));
                    }, 10000);
                });

                // 8. æ’­æ”¾è§†é¢‘ï¼ˆç§»åŠ¨ç«¯å¯èƒ½éœ€è¦æ‰‹åŠ¨æ’­æ”¾ï¼‰
                console.log('æ’­æ”¾è§†é¢‘...');
                try {
                    await video.play();
                    console.log('âœ… è§†é¢‘æ’­æ”¾æˆåŠŸ');
                } catch (playError) {
                    console.warn('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œå°è¯•ç”¨æˆ·äº¤äº’æ’­æ”¾:', playError);
                    // ç§»åŠ¨ç«¯å¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾
                    video.play().catch(e => {
                        console.error('æ’­æ”¾å¤±è´¥:', e);
                    });
                }

                // 9. æ˜¾ç¤ºç•Œé¢
                video.classList.remove('hidden');
                canvas.classList.remove('hidden');
                document.getElementById('videoPlaceholder').classList.add('hidden');
                document.getElementById('recognitionStatus').classList.remove('hidden');
                document.getElementById('recognitionStatus').innerHTML = 
                    '<p class="text-blue-800 font-semibold">ğŸ” æ­£åœ¨è¯†åˆ«äººè„¸ï¼Œè¯·æ­£å¯¹æ‘„åƒå¤´ä¿æŒ2-3ç§’...</p>';

                document.getElementById('cameraBtn').textContent = 'ğŸ”´ å…³é—­ç›¸æœº';
                document.getElementById('cameraBtn').onclick = stopCamera;
                document.getElementById('cameraBtn').disabled = false;

                // 10. å¼€å§‹äººè„¸æ£€æµ‹ï¼ˆç¡®ä¿è§†é¢‘æ­£åœ¨æ’­æ”¾ï¼‰
                const startDetection = () => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        console.log('âœ…å¼€å§‹äººè„¸æ£€æµ‹');
                        initLivenessCheck(); // ğŸ”¥åˆå§‹åŒ–æ´»ä½“æ£€æµ‹
                        faceDetectionRunning = true;
                        detectFaceLoop();
                    } else {
                        console.log('ç­‰å¾…è§†é¢‘æ•°æ®...');
                        setTimeout(startDetection, 100);
                    }
                };
                startDetection();
                
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('âœ… ç›¸æœºå¯åŠ¨æˆåŠŸ');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            } catch (error) {
                console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.error('âŒ ç›¸æœºå¯åŠ¨å¤±è´¥:', error);
                console.error('é”™è¯¯åç§°:', error.name);
                console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                
                // è¯¦ç»†çš„é”™è¯¯æç¤º
                let errorMessage = 'âŒ æ— æ³•æ‰“å¼€ç›¸æœº\n\n';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'åŸå› ï¼šç›¸æœºæƒé™è¢«æ‹’ç»\n\n';
                    errorMessage += 'ğŸ“± è§£å†³æ–¹æ³•ï¼š\n';
                    errorMessage += '1. ç‚¹å‡»åœ°å€æ çš„ ğŸ”’ æˆ– â“˜ å›¾æ ‡\n';
                    errorMessage += '2. æ‰¾åˆ°"ç›¸æœº"æƒé™\n';
                    errorMessage += '3. æ”¹ä¸º"å…è®¸"\n';
                    errorMessage += '4. åˆ·æ–°é¡µé¢é‡è¯•\n\n';
                    errorMessage += 'ğŸ’¡ æˆ–åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸æµè§ˆå™¨è®¿é—®ç›¸æœº';
                    
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'åŸå› ï¼šæœªæ‰¾åˆ°ç›¸æœºè®¾å¤‡\n\n';
                    errorMessage += 'ğŸ“± è¯·æ£€æŸ¥ï¼š\n';
                    errorMessage += '1. è®¾å¤‡æ˜¯å¦æœ‰å‰ç½®æ‘„åƒå¤´\n';
                    errorMessage += '2. æ‘„åƒå¤´æ˜¯å¦æ­£å¸¸å·¥ä½œ';
                    
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'åŸå› ï¼šç›¸æœºè¢«å ç”¨\n\n';
                    errorMessage += 'ğŸ“± è¯·å°è¯•ï¼š\n';
                    errorMessage += '1. å…³é—­å…¶ä»–ä½¿ç”¨ç›¸æœºçš„åº”ç”¨\n';
                    errorMessage += '2. åˆ·æ–°é¡µé¢é‡è¯•\n';
                    errorMessage += '3. é‡å¯æµè§ˆå™¨';
                    
                } else if (error.name === 'SecurityError' || error.message.includes('HTTPS')) {
                    errorMessage += 'åŸå› ï¼šå®‰å…¨é™åˆ¶\n\n';
                    errorMessage += 'ğŸ“± ç›¸æœºåŠŸèƒ½éœ€è¦ HTTPS è¿æ¥\n\n';
                    errorMessage += 'å½“å‰è¿æ¥ï¼š' + location.protocol + '\n';
                    errorMessage += 'è¯·ä½¿ç”¨ HTTPS è®¿é—®é¡µé¢';
                    
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += 'åŸå› ï¼šç›¸æœºä¸æ”¯æŒè¯·æ±‚çš„å‚æ•°\n\n';
                    errorMessage += 'ğŸ“± è¯·å°è¯•åˆ·æ–°é¡µé¢é‡è¯•';
                    
                } else {
                    errorMessage += 'é”™è¯¯è¯¦æƒ…ï¼š\n' + error.message + '\n\n';
                    errorMessage += 'ğŸ“± è¯·å°è¯•ï¼š\n';
                    errorMessage += '1. åˆ·æ–°é¡µé¢\n';
                    errorMessage += '2. é‡å¯æµè§ˆå™¨\n';
                    errorMessage += '3. æ£€æŸ¥ç³»ç»Ÿç›¸æœºæƒé™';
                }
                
                // æ£€æµ‹ç‰¹æ®Šæµè§ˆå™¨
                const ua = navigator.userAgent.toLowerCase();
                if (ua.includes('micromessenger')) {
                    errorMessage += '\n\nâš ï¸ æ£€æµ‹åˆ°å¾®ä¿¡æµè§ˆå™¨\n';
                    errorMessage += 'å»ºè®®ï¼šç‚¹å‡»å³ä¸Šè§’"..."é€‰æ‹©"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€"';
                } else if (ua.includes('qq/') || ua.includes('mqqbrowser')) {
                    errorMessage += '\n\nâš ï¸ æ£€æµ‹åˆ°QQæµè§ˆå™¨\n';
                    errorMessage += 'å»ºè®®ï¼šç‚¹å‡»å³ä¸Šè§’é€‰æ‹©"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€"';
                }
                
                alert(errorMessage);
                
                document.getElementById('cameraBtn').disabled = false;
                document.getElementById('cameraBtn').textContent = 'ğŸ“· æ‰“å¼€ç›¸æœºï¼ˆäººè„¸è¯†åˆ«ï¼‰';
            }
        }


// ==================== æ´»ä½“æ£€æµ‹åŠŸèƒ½ ====================

// åˆå§‹åŒ–æ´»ä½“æ£€æµ‹ï¼ˆéšæœºé€‰æ‹©2ä¸ªåŠ¨ä½œï¼‰
function initLivenessCheck() {
    const allActions = ['blink', 'mouth', 'nod'];
    
    const shuffled = allActions.sort(() => Math.random() - 0.5);
    livenessActions = shuffled.slice(0, 2);
    
    livenessProgress = {};
    livenessActions.forEach(action => {
        livenessProgress[action] = { completed: false, count: 0, required: action === 'nod' ? 1 : 2 };
    });
    
    livenessCheckPassed = false;
    
    // é‡ç½®æ‰€æœ‰æ£€æµ‹çŠ¶æ€
    blinkCount = 0;
    lastEyeState = 'open';
    eyeClosedFrames = 0;
    mouthOpenCount = 0;
    lastMouthState = 'closed';
    headPositions = [];
    nodCount = 0;
    
    // ğŸ”¥é‡ç½®åŠ¨æ€é˜ˆå€¼ç›¸å…³å˜é‡
    baselineEAR = null;
    earSamples = [];
    
    console.log('ğŸ² æ´»ä½“æ£€æµ‹å·²åˆå§‹åŒ–ï¼Œéœ€è¦å®Œæˆ:', livenessActions);
}

// çœ¨çœ¼æ£€æµ‹
function detectBlink(landmarks) {
    if (!livenessActions.includes('blink') || livenessProgress['blink'].completed) {
        return false;
    }
    
    function getEAR(eye) {
        const vertical1 = Math.hypot(eye[1].x - eye[5].x, eye[1].y - eye[5].y);
        const vertical2 = Math.hypot(eye[2].x - eye[4].x, eye[2].y - eye[4].y);
        const horizontal = Math.hypot(eye[0].x - eye[3].x, eye[0].y - eye[3].y);
        return (vertical1 + vertical2) / (2.0 * horizontal);
    }
    
    const leftEye = [
        landmarks.getLeftEye()[0], landmarks.getLeftEye()[1], landmarks.getLeftEye()[2],
        landmarks.getLeftEye()[3], landmarks.getLeftEye()[4], landmarks.getLeftEye()[5]
    ];
    
    const rightEye = [
        landmarks.getRightEye()[0], landmarks.getRightEye()[1], landmarks.getRightEye()[2],
        landmarks.getRightEye()[3], landmarks.getRightEye()[4], landmarks.getRightEye()[5]
    ];
    
    const leftEAR = getEAR(leftEye);
    const rightEAR = getEAR(rightEye);
    const avgEAR = (leftEAR + rightEAR) / 2.0;
    
    // ğŸ”¥åŠ¨æ€å»ºç«‹ççœ¼åŸºå‡†å€¼ï¼ˆé‡‡é›†å‰10å¸§çš„å¹³å‡å€¼ï¼‰
    if (earSamples.length < SAMPLE_SIZE) {
        earSamples.push(avgEAR);
        if (earSamples.length === SAMPLE_SIZE) {
            baselineEAR = earSamples.reduce((a, b) => a + b, 0) / SAMPLE_SIZE;
            console.log(`ğŸ‘ï¸ ççœ¼åŸºå‡†å€¼å·²å»ºç«‹: ${baselineEAR.toFixed(3)}`);
        }
        return false;
    }
    
    // ğŸ”¥åŠ¨æ€é˜ˆå€¼ï¼šåŸºå‡†å€¼çš„85%ï¼ˆå³EARä¸‹é™15%æ—¶åˆ¤å®šä¸ºé—­çœ¼ï¼‰
    const dynamicThreshold = baselineEAR * 0.85;
    const currentState = avgEAR < dynamicThreshold ? 'closed' : 'open';
    
    // è°ƒè¯•ä¿¡æ¯ï¼ˆæ¯10å¸§æ‰“å°ä¸€æ¬¡ï¼‰
    if (Math.random() < 0.1) {
        console.log(`ğŸ‘ï¸ EAR: ${avgEAR.toFixed(3)} | åŠ¨æ€é˜ˆå€¼: ${dynamicThreshold.toFixed(3)} | çŠ¶æ€: ${currentState}`);
    }
    
    if (currentState === 'closed') {
        eyeClosedFrames++;
    } else {
        if (eyeClosedFrames >= 1 && lastEyeState === 'closed') {
            blinkCount++;
            livenessProgress['blink'].count = blinkCount;
            console.log(`âœ… çœ¨çœ¼æ£€æµ‹æˆåŠŸï¼å½“å‰: ${blinkCount}/${livenessProgress['blink'].required}`);
            
            if (blinkCount >= livenessProgress['blink'].required) {
                livenessProgress['blink'].completed = true;
                console.log('âœ…âœ… çœ¨çœ¼ä»»åŠ¡å®Œæˆï¼');
            }
            
            eyeClosedFrames = 0;
            lastEyeState = 'open';
            return true;
        }
        eyeClosedFrames = 0;
        lastEyeState = 'open';
    }
    
    if (eyeClosedFrames >= 1 && lastEyeState === 'open') {
        lastEyeState = 'closed';
        console.log('ğŸ‘ï¸ æ£€æµ‹åˆ°é—­çœ¼');
    }
    
    return false;
}

// å¼ å˜´æ£€æµ‹
function detectMouthOpen(landmarks) {
    if (!livenessActions.includes('mouth') || livenessProgress['mouth'].completed) {
        return false;
    }
    
    const mouth = landmarks.getMouth();
    
    const vertical1 = Math.hypot(mouth[13].x - mouth[19].x, mouth[13].y - mouth[19].y);
    const vertical2 = Math.hypot(mouth[14].x - mouth[18].x, mouth[14].y - mouth[18].y);
    const vertical3 = Math.hypot(mouth[15].x - mouth[17].x, mouth[15].y - mouth[17].y);
    const horizontal = Math.hypot(mouth[0].x - mouth[6].x, mouth[0].y - mouth[6].y);
    
    const MAR = (vertical1 + vertical2 + vertical3) / (3.0 * horizontal);
    const MAR_THRESHOLD = 0.5;
    const currentState = MAR > MAR_THRESHOLD ? 'open' : 'closed';
    
    if (lastMouthState === 'closed' && currentState === 'open') {
        lastMouthState = 'open';
    } else if (lastMouthState === 'open' && currentState === 'closed') {
        mouthOpenCount++;
        lastMouthState = 'closed';
        livenessProgress['mouth'].count = mouthOpenCount;
        console.log(`ğŸ‘„ å¼ å˜´æ£€æµ‹: ${mouthOpenCount}/${livenessProgress['mouth'].required}`);
        
        if (mouthOpenCount >= livenessProgress['mouth'].required) {
            livenessProgress['mouth'].completed = true;
            console.log('âœ… å¼ å˜´æ£€æµ‹å®Œæˆï¼');
        }
        
        return true;
    }
    
    return false;
}

// ç‚¹å¤´æ£€æµ‹
function detectNod(detection) {
    if (!livenessActions.includes('nod') || livenessProgress['nod'].completed) {
        return false;
    }
    
    const box = detection.detection.box;
    const currentY = box.y + box.height / 2;
    
    headPositions.push(currentY);
    if (headPositions.length > 30) {
        headPositions.shift();
    }
    
    if (headPositions.length < 30) {
        return false;
    }
    
    const maxY = Math.max(...headPositions);
    const minY = Math.min(...headPositions);
    const movement = maxY - minY;
    
    if (movement > 30) {
        nodCount++;
        headPositions = [];
        livenessProgress['nod'].count = nodCount;
        console.log(`ğŸ”½ ç‚¹å¤´æ£€æµ‹: ${nodCount}/${livenessProgress['nod'].required}`);
        
        if (nodCount >= livenessProgress['nod'].required) {
            livenessProgress['nod'].completed = true;
            console.log('âœ… ç‚¹å¤´æ£€æµ‹å®Œæˆï¼');
        }
        
        return true;
    }
    
    return false;
}

// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åŠ¨ä½œéƒ½å®Œæˆ
function checkLivenessComplete() {
    const allCompleted = livenessActions.every(action => livenessProgress[action].completed);
    if (allCompleted && !livenessCheckPassed) {
        livenessCheckPassed = true;
        console.log('âœ… æ´»ä½“æ£€æµ‹å…¨éƒ¨é€šè¿‡ï¼');
        return true;
    }
    return false;
}

// è·å–æ´»ä½“æ£€æµ‹æç¤ºæ–‡æœ¬
function getLivenessHintHTML() {
    const actionNames = {
        'blink': 'ğŸ‘ï¸ çœ¨çœ¼',
        'mouth': 'ğŸ‘„ å¼ å˜´',
        'nod': 'ğŸ”½ ç‚¹å¤´'
    };
    
    let html = '<p class="text-blue-600 font-bold text-lg">æ´»ä½“æ£€æµ‹</p><div class="mt-2 space-y-1">';
    
    livenessActions.forEach(action => {
        const progress = livenessProgress[action];
        const completed = progress.completed;
        const color = completed ? 'text-green-600' : 'text-blue-600';
        const icon = completed ? 'âœ…' : 'â³';
        
        html += `
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <span class="${color} font-semibold">${icon} ${actionNames[action]}</span>
                <span class="${color} font-bold">${progress.count}/${progress.required}</span>
            </div>
        `;
    });
    
    html += '</div><p class="text-gray-600 mt-2 text-xs">ğŸ’¡ è‡ªç„¶å®ŒæˆåŠ¨ä½œå³å¯ï¼Œä¸è¦åˆ»æ„å¿«é€Ÿæ“ä½œ</p>';
    
    return html;
}


// ==================== äººè„¸æ£€æµ‹å¾ªç¯ï¼ˆå¤šå¸§éªŒè¯ + è¯†åˆ«é”å®šï¼‰ ====================
async function detectFaceLoop() {
    // ğŸ”¥ ä¿®å¤1ï¼šå¦‚æœå·²ç»è¯†åˆ«æˆåŠŸï¼Œç›´æ¥é€€å‡ºå¾ªç¯
    if (recognitionSuccess) {
        console.log('âœ… å·²è¯†åˆ«æˆåŠŸï¼Œåœæ­¢æ£€æµ‹');
        return;
    }

    // å¦‚æœæ£€æµ‹å·²åœæ­¢ï¼Œé€€å‡ºå¾ªç¯
    if (!faceDetectionRunning) {
        console.log('ğŸ›‘ äººè„¸æ£€æµ‹å¾ªç¯å·²åœæ­¢');
        return;
    }

    const video = document.getElementById('video');
    const canvas = document.getElementById('faceCanvas');
    const statusElement = document.getElementById('recognitionStatus');

    // æ£€æŸ¥è§†é¢‘æµæ˜¯å¦æœ‰æ•ˆ
    if (!video || !video.srcObject) {
        console.error('âŒ è§†é¢‘æµæ— æ•ˆï¼Œåœæ­¢æ£€æµ‹');
        faceDetectionRunning = false;
        if (statusElement) {
            statusElement.innerHTML = '<p class="text-red-600 font-semibold">âŒ æ‘„åƒå¤´è¿æ¥å¤±è´¥</p>';
        }
        return;
    }

    const ctx = canvas.getContext('2d');

    try {
        // ========== ç¬¬ä¸€æ­¥ï¼šæ£€æµ‹äººè„¸ ==========
        const detections = await faceapi
            .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                inputSize: 416,
                scoreThreshold: 0.5
            }))
            .withFaceLandmarks()
            .withFaceDescriptors();

        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ========== ç¬¬äºŒæ­¥ï¼šå¤„ç†æ£€æµ‹ç»“æœ ==========
        if (detections.length > 0) {
            // è°ƒæ•´ Canvas å°ºå¯¸ä»¥åŒ¹é…è§†é¢‘
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            canvas.width = displaySize.width;
            canvas.height = displaySize.height;

            // è°ƒæ•´æ£€æµ‹ç»“æœå°ºå¯¸
            const resizedDetections = faceapi.resizeResults(detections, displaySize);

            // ç»˜åˆ¶æ£€æµ‹æ¡†å’Œå…³é”®ç‚¹
            faceapi.draw.drawDetections(canvas, resizedDetections);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);


            // ========== ç¬¬ä¸‰æ­¥ï¼šæ´»ä½“æ£€æµ‹ï¼ˆåœ¨äººè„¸è¯†åˆ«ä¹‹å‰ï¼‰==========
            if (!livenessCheckPassed && resizedDetections.length > 0) {
                const firstDetection = resizedDetections[0];
                const landmarks = firstDetection.landmarks;
                
                // æ‰§è¡Œå„é¡¹æ£€æµ‹
                if (livenessActions.includes('blink')) {
                    detectBlink(landmarks);
                }
                if (livenessActions.includes('mouth')) {
                    detectMouthOpen(landmarks);
                }
                if (livenessActions.includes('nod')) {
                    detectNod(firstDetection);
                }
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                checkLivenessComplete();
                
                // æ›´æ–°æç¤º
                if (statusElement) {
                    statusElement.innerHTML = getLivenessHintHTML();
                }
            }

            // å¦‚æœæ´»ä½“æ£€æµ‹æœªé€šè¿‡ï¼Œä¸è¿›è¡Œäººè„¸è¯†åˆ«
            if (!livenessCheckPassed) {
                if (faceDetectionRunning) {
                    requestAnimationFrame(detectFaceLoop);
                }
                return;
            }

            // ========== ç¬¬å››æ­¥ï¼šäººè„¸è¯†åˆ«åŒ¹é…ï¼ˆæ´»ä½“æ£€æµ‹é€šè¿‡åæ‰æ‰§è¡Œï¼‰==========

            if (!labeledDescriptors || labeledDescriptors.length === 0) {
                // æ²¡æœ‰åŠ è½½äººè„¸åº“
                if (statusElement) {
                    statusElement.innerHTML =
                        '<p class="text-red-600 font-semibold">âŒ äººè„¸åº“æœªåŠ è½½ï¼Œæ— æ³•è¯†åˆ«<br/><small>è¯·åˆ·æ–°é¡µé¢é‡è¯•</small></p>';
                }
            } else {
                // ä½¿ç”¨è¾ƒä½çš„åŒ¹é…é˜ˆå€¼ï¼Œå…ˆè·å–æ‰€æœ‰å¯èƒ½çš„åŒ¹é…
                const MATCH_THRESHOLD = 0.50;
                const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, MATCH_THRESHOLD);
                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                // ========== ç¬¬å››æ­¥ï¼šå¤„ç†è¯†åˆ«ç»“æœ ==========
                let currentBestMatch = null;
                let currentBestConfidence = 0;
                let minDistance = Infinity;

                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    const distance = result.distance;
                    const confidence = (1 - distance) * 100;
                    
                    minDistance = Math.min(minDistance, distance);

                    if (result.label !== 'unknown' && confidence >= MIN_CONFIDENCE * 100) {
                        // è§£æå­¦ç”Ÿä¿¡æ¯
                        const parts = result.label.split('|');
                        const studentId = parts[0] || '';
                        const name = parts[1] || 'æœªçŸ¥';
                        const studentClass = parts[2] || '';

                        console.log(`ğŸ¯ æ£€æµ‹åˆ°: ${name} (${studentId}) | ç½®ä¿¡åº¦: ${confidence.toFixed(1)}% | è·ç¦»: ${distance.toFixed(3)}`);

                        // è®°å½•åˆ°å¤šå¸§éªŒè¯é˜Ÿåˆ—
                        if (!currentBestMatch || confidence > currentBestConfidence) {
                            currentBestMatch = {
                                studentId: studentId,
                                name: name,
                                studentClass: studentClass,
                                confidence: confidence,
                                distance: distance,
                                box: box,
                                label: result.label
                            };
                            currentBestConfidence = confidence;
                        }
                    } else if (result.label !== 'unknown') {
                        const parts = result.label.split('|');
                        const name = parts[1] || 'æœªçŸ¥';
                        console.log(`âš ï¸ ä½ç½®ä¿¡åº¦: ${name} | ${confidence.toFixed(1)}% (éœ€è¦ â‰¥${MIN_CONFIDENCE * 100}%)`);
                    }
                });

                // ========== ç¬¬äº”æ­¥ï¼šå¤šå¸§éªŒè¯ ==========
                if (currentBestMatch) {
                    // æ·»åŠ åˆ°æœ€è¿‘åŒ¹é…é˜Ÿåˆ—
                    recentMatches.push({
                        studentId: currentBestMatch.studentId,
                        name: currentBestMatch.name,
                        studentClass: currentBestMatch.studentClass,
                        confidence: currentBestMatch.confidence,
                        timestamp: Date.now()
                    });

                    // åªä¿ç•™æœ€è¿‘çš„å¸§æ•°
                    if (recentMatches.length > CONSECUTIVE_FRAMES) {
                        recentMatches.shift();
                    }

                    // æ£€æŸ¥æ˜¯å¦è¿ç»­åŒ¹é…
                    if (recentMatches.length >= CONSECUTIVE_FRAMES) {
                        // æ£€æŸ¥æœ€è¿‘Nå¸§æ˜¯å¦éƒ½æ˜¯åŒä¸€ä¸ªäºº
                        const firstMatch = recentMatches[0];
                        const allSamePerson = recentMatches.every(m => 
                            m.studentId === firstMatch.studentId && 
                            m.confidence >= MIN_CONFIDENCE * 100
                        );

                        if (allSamePerson) {
                            // ========== è¿ç»­å¸§éªŒè¯é€šè¿‡ï¼==========
                            const avgConfidence = (recentMatches.reduce((sum, m) => sum + m.confidence, 0) / recentMatches.length).toFixed(1);
                            
                            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                            console.log(`âœ… è¿ç»­ ${CONSECUTIVE_FRAMES} å¸§éªŒè¯é€šè¿‡ï¼`);
                            console.log(`   å­¦ç”Ÿ: ${firstMatch.name} (${firstMatch.studentId})`);
                            console.log(`   å¹³å‡ç½®ä¿¡åº¦: ${avgConfidence}%`);
                            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                            // éªŒè¯ç­çº§
                            let isInActiveClass = false;
                            let activeClassNames = [];

                            if (activeSessions.length > 0) {
                                activeSessions.forEach(session => {
                                    const classNames = session.get('classNames') || [session.get('className')];
                                    activeClassNames = activeClassNames.concat(classNames);
                                });
                                isInActiveClass = activeClassNames.includes(firstMatch.studentClass);
                            }

                            if (!isInActiveClass && activeSessions.length > 0) {
                                // ========== ä¸å±äºå½“å‰ç­¾åˆ°ç­çº§ ==========
                                console.warn(`âš ï¸ ${firstMatch.name} ä¸å±äºå½“å‰ç­¾åˆ°ç­çº§`);

                                // ç»˜åˆ¶æ©™è‰²è­¦å‘Šæ¡†
                                const drawBox = new faceapi.draw.DrawBox(currentBestMatch.box, {
                                    label: `${firstMatch.name} - éå½“å‰ç­çº§`,
                                    boxColor: '#ff9800',
                                    lineWidth: 3
                                });
                                drawBox.draw(canvas);

                                // æ˜¾ç¤ºè­¦å‘Šæç¤º
                                if (statusElement) {
                                    statusElement.innerHTML =
                                        `<p class="text-orange-600 font-bold text-lg">
                                            âš ï¸ è¯†åˆ«æˆåŠŸï¼Œä½†ä¸å±äºå½“å‰ç­¾åˆ°ç­çº§
                                        </p>
                                        <p class="text-gray-700 mt-2">
                                            è¯†åˆ«å§“åï¼š<span class="font-bold">${firstMatch.name}</span><br/>
                                            å­¦ç”Ÿç­çº§ï¼š<span class="font-bold text-orange-600">${firstMatch.studentClass}</span><br/>
                                            å¹³å‡ç½®ä¿¡åº¦ï¼š<span class="font-bold text-orange-600">${avgConfidence}%</span>
                                        </p>
                                        <p class="text-red-600 mt-2 font-semibold">
                                            âŒ å½“å‰ç­¾åˆ°ç­çº§ï¼š${activeClassNames.join('ã€')}
                                        </p>
                                        <p class="text-gray-600 mt-2 text-sm">
                                            ğŸ’¡ å¦‚æœä¿¡æ¯æ­£ç¡®ï¼Œè¯·è”ç³»æ•™å¸ˆç¡®è®¤ï¼›<br/>
                                            å¦‚æœè¯†åˆ«é”™è¯¯ï¼Œè¯·æ‰‹åŠ¨å¡«å†™æ­£ç¡®ä¿¡æ¯
                                        </p>`;
                                }

                                // æ¸…ç©ºåŒ¹é…é˜Ÿåˆ—ï¼Œç»§ç»­æ£€æµ‹
                                recentMatches = [];

                            } else {
                                // ========== å±äºå½“å‰ç­¾åˆ°ç­çº§ï¼Œè¯†åˆ«æˆåŠŸï¼==========
                                // ğŸ”¥ ä¿®å¤2ï¼šç«‹å³åœæ­¢æ£€æµ‹
                                recognitionSuccess = true;
                                faceDetectionRunning = false;

                                // ğŸ”¥é‡ç½®æ´»ä½“æ£€æµ‹
                                livenessCheckPassed = false;
                                livenessActions = [];
                                livenessProgress = {};

                                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                                console.log('âœ… è¯†åˆ«æˆåŠŸï¼åœæ­¢æ£€æµ‹å¾ªç¯');
                                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                                // ç»˜åˆ¶ç»¿è‰²è¯†åˆ«æ¡†
                                const drawBox = new faceapi.draw.DrawBox(currentBestMatch.box, {
                                    label: `${firstMatch.name} (${avgConfidence}%)`,
                                    boxColor: '#00ff00',
                                    lineWidth: 4
                                });
                                drawBox.draw(canvas);

                                // è‡ªåŠ¨å¡«å……è¡¨å•
                                const classInput = document.getElementById('stuClass');
                                const idInput = document.getElementById('stuId');
                                const nameInput = document.getElementById('stuName');

                                if (classInput) classInput.value = firstMatch.studentClass;
                                if (idInput) idInput.value = firstMatch.studentId;
                                if (nameInput) nameInput.value = firstMatch.name;

                                // æ˜¾ç¤ºæˆåŠŸæç¤º
                                if (statusElement) {
                                    statusElement.innerHTML =
                                        `<p class="text-green-600 font-bold text-xl animate-pulse">
                                            âœ… è¯†åˆ«æˆåŠŸï¼š${firstMatch.name}
                                        </p>
                                        <p class="text-gray-700 mt-2">
                                            ğŸ“Š å¹³å‡ç½®ä¿¡åº¦: <span class="font-bold text-green-600">${avgConfidence}%</span><br/>
                                            ğŸ“š ç­çº§: ${firstMatch.studentClass}<br/>
                                            âœ… è¿ç»­ ${CONSECUTIVE_FRAMES} å¸§éªŒè¯é€šè¿‡
                                        </p>
                                        <p class="text-blue-600 mt-2 text-sm">
                                            ğŸ“· ç›¸æœºå°†åœ¨ 2 ç§’åè‡ªåŠ¨å…³é—­
                                        </p>`;
                                }

                                // 2ç§’åè‡ªåŠ¨å…³é—­ç›¸æœº
                                setTimeout(() => {
                                    console.log('ğŸ“· 2ç§’åè‡ªåŠ¨å…³é—­ç›¸æœº...');
                                    stopCamera();
                                    recognitionSuccess = false;  // é‡ç½®æ ‡å¿—
                                    recentMatches = [];
                                }, 2000);
                                
                                // ğŸ”¥ ä¿®å¤3ï¼šç«‹å³è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­ä»£ç 
                                return;
                            }
                        } else {
                            // ä¸æ˜¯åŒä¸€ä¸ªäººï¼Œæˆ–è€…ç½®ä¿¡åº¦ä¸ç¨³å®š
                            const uniquePeople = [...new Set(recentMatches.map(m => m.name))];
                            console.log(`âš ï¸ æœ€è¿‘ ${recentMatches.length} å¸§æ£€æµ‹åˆ°å¤šäºº: ${uniquePeople.join(', ')}`);
                            
                            // æ¸…ç©ºé˜Ÿåˆ—ï¼Œé‡æ–°å¼€å§‹
                            recentMatches = [];
                        }
                    }

                    // ========== æ˜¾ç¤ºå®æ—¶è¿›åº¦ ==========
                    if (statusElement) {
                        const progress = recentMatches.length;
                        const needed = CONSECUTIVE_FRAMES;
                        const progressPercent = Math.round((progress / needed) * 100);

                        statusElement.innerHTML =
                            `<p class="text-blue-600 font-bold text-lg">
                                ğŸ” æ­£åœ¨è¯†åˆ«ï¼š${currentBestMatch.name}
                            </p>
                            <p class="text-gray-700 mt-2">
                                å½“å‰ç½®ä¿¡åº¦: <span class="font-bold ${currentBestMatch.confidence >= MIN_CONFIDENCE * 100 ? 'text-green-600' : 'text-orange-600'}">${currentBestMatch.confidence.toFixed(1)}%</span><br/>
                                éªŒè¯è¿›åº¦: <span class="font-bold text-blue-600">${progress}/${needed} å¸§</span>
                            </p>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                            </div>
                            <p class="text-gray-600 mt-2 text-xs">
                                ğŸ’¡ ä¿æŒå§¿åŠ¿ä¸åŠ¨ ${needed - progress} å¸§...
                            </p>`;
                    }

                } else {
                    // å½“å‰å¸§æ²¡æœ‰é«˜ç½®ä¿¡åº¦åŒ¹é…ï¼Œæ¸…ç©ºé˜Ÿåˆ—
                    if (recentMatches.length > 0) {
                        console.log('âš ï¸ å½“å‰å¸§æ— åŒ¹é…ï¼Œæ¸…ç©ºéªŒè¯é˜Ÿåˆ—');
                        recentMatches = [];
                    }

                    // æ˜¾ç¤ºå½“å‰çŠ¶æ€
                    if (statusElement) {
                        const confidence = ((1 - minDistance) * 100).toFixed(1);
                        
                        if (minDistance < 0.50) {
                            statusElement.innerHTML =
                                `<p class="text-orange-600 font-semibold text-lg">
                                    âš ï¸ æ£€æµ‹åˆ°äººè„¸ä½†ç½®ä¿¡åº¦ä¸ç¨³å®š
                                </p>
                                <p class="text-gray-700 mt-2">
                                    å½“å‰ç½®ä¿¡åº¦: <span class="text-orange-600 font-bold">${confidence}%</span><br/>
                                    éœ€è¦ç½®ä¿¡åº¦: <span class="text-green-600 font-bold">â‰¥ ${MIN_CONFIDENCE * 100}%</span>
                                </p>
                                <p class="text-gray-600 mt-2 text-sm">
                                    ğŸ’¡ å»ºè®®ï¼š<br/>
                                    âœ“ ä¿æŒå§¿åŠ¿ä¸åŠ¨<br/>
                                    âœ“ æ­£å¯¹æ‘„åƒå¤´<br/>
                                    âœ“ è°ƒæ•´å…‰çº¿
                                </p>`;
                        } else if (minDistance < 0.7) {
                            statusElement.innerHTML =
                                `<p class="text-orange-600 font-semibold">
                                    âš ï¸ æ£€æµ‹åˆ°äººè„¸ä½†æœªæ‰¾åˆ°åŒ¹é…
                                </p>
                                <p class="text-gray-700 mt-2">
                                    ç›¸ä¼¼åº¦: <span class="text-red-600 font-bold">${confidence}%</span>ï¼ˆè¿‡ä½ï¼‰
                                </p>
                                <p class="text-gray-600 mt-2 text-sm">
                                    âœ“ ç¡®ä¿å·²å½•å…¥ç…§ç‰‡<br/>
                                    âœ“ æ­£å¯¹æ‘„åƒå¤´<br/>
                                    âœ“ å…‰çº¿å……è¶³
                                </p>`;
                        } else {
                            statusElement.innerHTML =
                                `<p class="text-red-600 font-semibold">
                                    âŒ æ£€æµ‹åˆ°äººè„¸ä½†å·®å¼‚è¿‡å¤§
                                </p>
                                <p class="text-gray-700 mt-2">
                                    ç›¸ä¼¼åº¦: <span class="text-red-600 font-bold">${confidence}%</span>
                                </p>
                                <p class="text-gray-600 mt-2 text-sm">
                                    ğŸ’¡ è¯·æ‰‹åŠ¨å¡«å†™ä¿¡æ¯ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜å½•å…¥ç…§ç‰‡
                                </p>`;
                        }
                    }
                }
            }

        } else {
            // ========== æœªæ£€æµ‹åˆ°äººè„¸ ==========
            if (recentMatches.length > 0) {
                recentMatches = [];
            }

            if (statusElement) {
                statusElement.innerHTML =
                    `<p class="text-blue-600 font-semibold">
                        ğŸ” æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·è°ƒæ•´ä½ç½®...
                    </p>
                    <p class="text-gray-600 mt-2 text-sm">
                        âœ“ é¢éƒ¨æ­£å¯¹æ‘„åƒå¤´<br/>
                        âœ“ ä¿æŒé€‚å½“è·ç¦»<br/>
                        âœ“ å…‰çº¿å……è¶³
                    </p>`;
            }
        }

        // ========== ç¬¬å…­æ­¥ï¼šç»§ç»­æ£€æµ‹å¾ªç¯ ==========
        if (faceDetectionRunning) {
            requestAnimationFrame(detectFaceLoop);
        }

    } catch (error) {
        console.error('âŒ äººè„¸æ£€æµ‹é”™è¯¯:', error);

        const statusElement = document.getElementById('recognitionStatus');
        if (statusElement) {
            statusElement.innerHTML =
                `<p class="text-red-600 font-semibold">
                    âŒ æ£€æµ‹å‡ºé”™: ${error.message}
                    <br/><small>ç»§ç»­å°è¯•ä¸­...</small>
                </p>`;
        }

        if (faceDetectionRunning) {
            requestAnimationFrame(detectFaceLoop);
        }
    }
}


        // Stop camera
        function stopCamera() {
            faceDetectionRunning = false;
            recognitionSuccess = false; // é‡ç½®è¯†åˆ«æˆåŠŸæ ‡å¿—

            // ğŸ”¥é‡ç½®æ´»ä½“æ£€æµ‹
            livenessCheckPassed = false;
            livenessActions = [];
            livenessProgress = {};
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('faceCanvas');
            const ctx = canvas.getContext('2d');
            
            video.classList.add('hidden');
            canvas.classList.add('hidden');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            
            document.getElementById('cameraBtn').textContent = 'ğŸ“· æ‰“å¼€ç›¸æœºï¼ˆäººè„¸è¯†åˆ«ï¼‰';
            document.getElementById('cameraBtn').onclick = openCamera;
        }

        // Submit check-in - æ”¯æŒå¤šç­çº§ç­¾åˆ°
        // Submit check-in - å­¦ç”Ÿç­¾åˆ°ï¼ˆä¿®å¤ç‰ˆï¼‰
        async function submitCheckIn() {
            const className = document.getElementById('stuClass').value;
            const studentId = document.getElementById('stuId').value;
            const name = document.getElementById('stuName').value;
            const location = document.getElementById('location').value;

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!className || !studentId || !name) {
                alert('âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼š\n\nâœ“ ç­çº§\nâœ“ å­¦å·\nâœ“ å§“å');
                return;
            }

            // å¤„ç†å®šä½ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
            let finalLocation = location;
            if (!location || location.includes('æ­£åœ¨è·å–')) {
                finalLocation = 'æœªè·å–å®šä½';
                if (!confirm('âš ï¸ æ‚¨è¿˜æœªè·å–å®šä½ä¿¡æ¯\n\næ˜¯å¦ç»§ç»­ç­¾åˆ°ï¼Ÿ')) {
                    return;
                }
            } else if (location.includes('å®šä½å¤±è´¥') || location.includes('ä¸æ”¯æŒå®šä½')) {
                finalLocation = location;
            }

            try {
                console.log('ğŸ” å¼€å§‹ç­¾åˆ°æµç¨‹...');
                console.log('å­¦ç”Ÿä¿¡æ¯:', { className, studentId, name });

                // Step 1: æŸ¥æ‰¾è¿›è¡Œä¸­çš„ç­¾åˆ°ä¼šè¯
                const sessionQuery = new AV.Query('CheckInSession');
                sessionQuery.equalTo('status', 'active');
                sessionQuery.descending('createdAt');
                sessionQuery.limit(100); // è·å–æ›´å¤šä¼šè¯ä»¥ä¾¿åŒ¹é…
                const sessions = await sessionQuery.find();

                console.log(`âœ… æ‰¾åˆ° ${sessions.length} ä¸ªæ´»åŠ¨ç­¾åˆ°ä¼šè¯`);

                // Step 2: æŸ¥æ‰¾åŒ…å«è¯¥ç­çº§çš„ç­¾åˆ°ä¼šè¯
                let matchedSession = null;
                for (let session of sessions) {
                    const classNames = session.get('classNames') || [session.get('className')];
                    console.log('æ£€æŸ¥ä¼šè¯ç­çº§:', classNames);
                    
                    if (classNames.includes(className)) {
                        matchedSession = session;
                        console.log('âœ… æ‰¾åˆ°åŒ¹é…çš„ç­¾åˆ°ä¼šè¯:', session.id);
                        break;
                    }
                }

                if (!matchedSession) {
                    console.error('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ç­¾åˆ°ä¼šè¯');
                    alert(`âŒ å½“å‰æ²¡æœ‰ã€${className}ã€‘çš„ç­¾åˆ°ä»»åŠ¡\n\nå¯èƒ½åŸå› ï¼š\nâœ“ æ•™å¸ˆè¿˜æœªå¼€å§‹ç­¾åˆ°\nâœ“ ç­¾åˆ°å·²ç»“æŸ\nâœ“ ç­çº§åç§°ä¸åŒ¹é…\n\nè¯·è”ç³»æ•™å¸ˆç¡®è®¤`);
                    return;
                }

                const sessionId = matchedSession.id;
                const courseName = matchedSession.get('courseName');
                const courseSession = matchedSession.get('courseSession');

                // Step 3: æ£€æŸ¥æ˜¯å¦å·²ç­¾åˆ°
                const recordQuery = new AV.Query('CheckInRecord');
                recordQuery.equalTo('sessionId', sessionId);
                recordQuery.equalTo('studentId', studentId);
                const existing = await recordQuery.first();

                if (existing) {
                    const existingTime = existing.get('checkInTime');
                    console.warn('âš ï¸ å­¦ç”Ÿå·²ç­¾åˆ°è¿‡');
                    alert(`âš ï¸ æ‚¨å·²ç­¾åˆ°è¿‡ï¼Œæ— éœ€é‡å¤ç­¾åˆ°ï¼\n\nè¯¾ç¨‹ï¼š${courseName}\næ—¶é—´ï¼š${new Date(existingTime).toLocaleString()}`);
                    return;
                }

                // Step 4: åˆ›å»ºç­¾åˆ°è®°å½•ï¼ˆä»…åˆ›å»º CheckInRecordï¼Œä¸åˆ›å»º Sessionï¼ï¼‰
                const CheckInRecord = AV.Object.extend('CheckInRecord');
                const record = new CheckInRecord();
                record.set('sessionId', sessionId);
                record.set('className', className);
                record.set('studentId', studentId);
                record.set('studentName', name);
                record.set('location', finalLocation);
                record.set('checkInTime', new Date());
                await record.save();

                console.log('âœ… ç­¾åˆ°è®°å½•åˆ›å»ºæˆåŠŸ:', record.id);

                // æˆåŠŸæç¤º
                alert(`âœ… ç­¾åˆ°æˆåŠŸï¼\n\nè¯¾ç¨‹ï¼š${courseName}\nèŠ‚æ¬¡ï¼š${courseSession}\nå§“åï¼š${name}\nå­¦å·ï¼š${studentId}\nç­çº§ï¼š${className}\næ—¶é—´ï¼š${new Date().toLocaleString()}\nä½ç½®ï¼š${finalLocation}`);

                // æ¸…ç©ºè¡¨å•
                document.getElementById('stuClass').value = '';
                document.getElementById('stuId').value = '';
                document.getElementById('stuName').value = '';
                document.getElementById('location').value = '';
                document.getElementById('recognitionStatus').classList.add('hidden');
                
                // å…³é—­ç›¸æœº
                if (videoStream) {
                    stopCamera();
                }

            } catch (error) {
                console.error('âŒ ç­¾åˆ°å¤±è´¥:', error);
                
                // å‹å¥½çš„é”™è¯¯æç¤º
                let errorMsg = 'ç­¾åˆ°å¤±è´¥';
                let suggestion = '';
                
                if (error.code === 101) {
                    errorMsg = 'ç­¾åˆ°ç³»ç»Ÿå°šæœªåˆå§‹åŒ–';
                    suggestion = 'è¯·è”ç³»æ•™å¸ˆç¡®è®¤ç­¾åˆ°æ˜¯å¦å·²å¼€å§‹';
                } else if (error.code === 401 || error.code === 403) {
                    errorMsg = 'æƒé™éªŒè¯å¤±è´¥';
                    suggestion = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜';
                } else if (error.message.includes('timeout')) {
                    errorMsg = 'ç½‘ç»œè¶…æ—¶';
                    suggestion = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                } else {
                    errorMsg = error.message;
                    suggestion = 'è¯·ç¨åé‡è¯•';
                }
                
                alert(`âŒ ${errorMsg}\n\n${suggestion}\n\næŠ€æœ¯ä¿¡æ¯ï¼š${error.code || 'æœªçŸ¥'}`);
            }
        }


        // ==================== å€’è®¡æ—¶åŠŸèƒ½ ====================
        let countdownInterval = null;

        function setupCountdown(minutes) {
            // æ¸…é™¤ä¹‹å‰çš„å€’è®¡æ—¶
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            const countdownElement = document.getElementById('countdown');
            if (!countdownElement) {
                console.warn('âš ï¸ å€’è®¡æ—¶å…ƒç´ ä¸å­˜åœ¨');
                return;
            }

            let remainingSeconds = minutes * 60;

            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateCountdownDisplay(remainingSeconds, countdownElement);

            // æ¯ç§’æ›´æ–°
            countdownInterval = setInterval(() => {
                remainingSeconds--;

                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    countdownElement.textContent = 'â° ç­¾åˆ°æ—¶é—´å·²åˆ°';
                    countdownElement.className = 'text-red-600 font-bold animate-pulse';
                    
                    // æ’­æ”¾æç¤ºéŸ³
                    if (typeof playCheckInSound === 'function') {
                        playCheckInSound();
                    }
                    
                    console.log('â° ç­¾åˆ°æ—¶é—´å·²åˆ°');
                    return;
                }

                updateCountdownDisplay(remainingSeconds, countdownElement);
            }, 1000);

            console.log(`â±ï¸ å€’è®¡æ—¶å·²è®¾ç½®: ${minutes} åˆ†é’Ÿ`);
        }

        function updateCountdownDisplay(seconds, element) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timeString = `${minutes}:${secs.toString().padStart(2, '0')}`;
            
            element.textContent = `â±ï¸ å‰©ä½™æ—¶é—´: ${timeString}`;
            
            // æ ¹æ®å‰©ä½™æ—¶é—´æ”¹å˜é¢œè‰²
            if (seconds <= 60) {
                element.className = 'text-red-600 font-bold animate-pulse';
            } else if (seconds <= 300) {
                element.className = 'text-orange-600 font-bold';
            } else {
                element.className = 'text-green-600 font-bold';
            }
        }


    </script>
</body>
</html>                    