<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Â§ßÂ≠¶ÁîüËØæÂ†ÇÁ≠æÂà∞Á≥ªÁªü</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <!-- LeanCloud SDK -->  
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>  
    <!-- Face-api.js for face recognition -->  
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>  
    <!-- xlsx library for Excel export -->  
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- ECharts ËØç‰∫ëÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>

    <style>  
        .word-cloud {  
            display: flex;  
            flex-wrap: wrap;  
            gap: 8px;  
            padding: 20px;  
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
            border-radius: 12px;  
            min-height: 200px;  
        }  
        .cloud-name {  
            padding: 8px 16px;  
            background: white;  
            border-radius: 20px;  
            font-size: 14px;  
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);  
            transition: all 0.3s ease;  
            animation: float 3s ease-in-out infinite;  
        }  
        .cloud-name.checked {  
            opacity: 0;  
            transform: scale(0);  
        }  
        @keyframes float {  
            0%, 100% { transform: translateY(0px); }  
            50% { transform: translateY(-10px); }  
        }  
        .tab-active {  
            background: #4f46e5;  
            color: white;  
        }  
        #faceCanvas {  
            position: absolute;  
            top: 0;  
            left: 0;  
        }  
        .video-container {  
            position: relative;  
            width: 100%;  
            max-width: 640px;  
            margin: 0 auto;  
        }  
        .requirement-item {  
            display: flex;  
            align-items: center;  
            gap: 8px;  
            padding: 8px;  
            background: #f0fdf4;  
            border-left: 3px solid #22c55e;  
            margin-bottom: 8px;  
            border-radius: 4px;  
        }  
        .warning-item {  
            display: flex;  
            align-items: center;  
            gap: 8px;  
            padding: 8px;  
            background: #fef2f2;  
            border-left: 3px solid #ef4444;  
            margin-bottom: 8px;  
            border-radius: 4px;  
        } 
        
        /* ËØç‰∫ëÁõ∏ÂÖ≥Âä®Áîª */
        @keyframes pulse-slow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* ËøõÂ∫¶Êù°Èó™ÁÉÅÊïàÊûú */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        #wordCloudProgressBar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* ÈÄöÁü•Ê∑°ÂÖ•Ê∑°Âá∫ */
        .notification-enter {
            animation: slideInRight 0.3s ease-out;
        }

        .notification-exit {
            animation: slideOutRight 0.3s ease-in;
        }

        @media (max-width: 768px) {
            #wordCloudContainer {
                height: 350px !important;
            }
            
            .check-in-notification {
                right: 1rem !important;
                top: 5rem !important;
                font-size: 0.9rem;
            }
        } 
        
    /* ËßÜÈ¢ëÂíå canvas ÂÆπÂô® */
    .video-container {
        position: relative;
        display: inline-block;
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
    }

    /* ËßÜÈ¢ëÂÖÉÁ¥† */
    #video {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 8px;
    }

    /* Canvas Âè†Âä†Â±Ç */
    #faceCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* ÂÖÅËÆ∏ÁÇπÂáªÁ©øÈÄè */
    }

    /* ÈöêËóèÁ±ª */
    .hidden {
        display: none !important;
    }        

/* Áè≠Á∫ßÊäòÂè†Ê†∑Âºè */
.class-group {
    margin-bottom: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    background: white;
}

.class-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: linear-gradient(to right, #f3f4f6, #e5e7eb);
    cursor: pointer;
    transition: all 0.2s;
}

.class-header:hover {
    background: linear-gradient(to right, #e5e7eb, #d1d5db);
}

.class-header.collapsed {
    border-bottom: none;
}

.class-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 16px;
}

.class-arrow {
    transition: transform 0.3s;
    font-size: 12px;
}

.class-arrow.collapsed {
    transform: rotate(-90deg);
}

.class-actions {
    display: flex;
    gap: 8px;
}

.class-students {
    max-height: 400px;
    overflow-y: auto;
    transition: all 0.3s;
}

.class-students.collapsed {
    max-height: 0;
    overflow: hidden;
}

.student-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-top: 1px solid #f3f4f6;
    transition: background 0.2s;
}

.student-item:hover {
    background: #fef3c7;
}

.student-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.student-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e5e7eb;
}

.student-details {
    display: flex;
    flex-direction: column;
}

.student-name {
    font-weight: 600;
    color: #1f2937;
}

.student-id {
    font-size: 12px;
    color: #6b7280;
}

.badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.badge-success {
    background: #d1fae5;
    color: #059669;
}

.badge-error {
    background: #fee2e2;
    color: #dc2626;
}

.btn-sm {
    padding: 4px 12px;
    font-size: 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-warning {
    background: #f59e0b;
    color: white;
}

.btn-warning:hover {
    background: #d97706;
}

/* üî• Áè≠Á∫ßÈÄâÊã©Âç°ÁâáÊ†∑Âºè */
.class-checkbox-card {
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
}

.class-checkbox-card input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.class-checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    transition: all 0.2s ease;
    user-select: none;
}

.class-checkbox-label:hover {
    border-color: #3b82f6;
    background: #eff6ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);
}

.class-checkbox-card input[type="checkbox"]:checked + .class-checkbox-label {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.class-checkbox-icon {
    width: 20px;
    height: 20px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.class-checkbox-card input[type="checkbox"]:checked + .class-checkbox-label .class-checkbox-icon {
    background: white;
    border-color: white;
}

.class-checkbox-card input[type="checkbox"]:checked + .class-checkbox-label .class-checkbox-icon::after {
    content: '‚úì';
    color: #3b82f6;
    font-size: 14px;
    font-weight: bold;
}

/* Â∑≤ÈÄâÊ†áÁ≠æÊ†∑Âºè */
.selected-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    animation: tagAppear 0.3s ease;
}

.selected-tag .remove-tag {
    cursor: pointer;
    font-weight: bold;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.selected-tag .remove-tag:hover {
    opacity: 1;
}

@keyframes tagAppear {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}


/* ÂÆöÊó∂‰ªªÂä°Âä®Áîª */
.scheduled-task {
    animation: pulse-border 2s infinite;
}

@keyframes pulse-border {
    0%, 100% {
        border-color: #3b82f6;
    }
    50% {
        border-color: #60a5fa;
    }
}

    </style>  
</head>  
<body class="bg-gray-100">  
    <div class="container mx-auto p-4 max-w-6xl">  
        <!-- Header -->  
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">  
            <h1 class="text-3xl font-bold text-center text-indigo-600">üìö ËØæÂ†ÇÁ≠æÂà∞Á≥ªÁªü</h1>  
            <div class="flex justify-center gap-4 mt-4">  
                <button onclick="switchRole('teacher')" id="teacherTab" class="px-6 py-2 rounded-lg tab-active">ÊïôÂ∏àÁ´Ø</button>  
                <button onclick="switchRole('student')" id="studentTab" class="px-6 py-2 rounded-lg bg-gray-200">Â≠¶ÁîüÁ´Ø</button>  
            </div>  
        </div>  

        <!-- Teacher Panel -->  
        <div id="teacherPanel" class="space-y-6">  
            <!-- Photo Requirements Guide -->  
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">  
                <h2 class="text-xl font-bold mb-3 text-indigo-800 flex items-center gap-2">  
                    üì∏ ÁÖßÁâáÂΩïÂÖ•Ë¶ÅÊ±ÇÔºàÈáçË¶ÅÔºÅÔºâ  
                    <button onclick="toggleGuide()" class="text-sm bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">Êü•ÁúãËØ¶ÊÉÖ</button>  
                </h2>  
                <div id="photoGuide" class="hidden">  
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">  
                        <div>  
                            <h3 class="font-bold text-green-700 mb-2">‚úÖ Ê≠£Á°ÆÁ§∫‰æã</h3>  
                            <div class="requirement-item">  
                                <span class="text-green-600">‚úì</span>  
                                <span class="text-sm">Ê≠£Èù¢ÊãçÊëÑÔºåÈù¢ÈÉ®ÂÆåÊï¥Ê∏ÖÊô∞</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">‚úì</span>  
                                <span class="text-sm">ÂÖâÁ∫øÂÖÖË∂≥ÂùáÂåÄÔºåÊó†Âº∫ÁÉàÈò¥ÂΩ±</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">‚úì</span>  
                                <span class="text-sm">Ë°®ÊÉÖËá™ÁÑ∂ÔºåÂèåÁúºÁùÅÂºÄ</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">‚úì</span>  
                                <span class="text-sm">‰∏çÊà¥ÁúºÈïú„ÄÅÂ∏ΩÂ≠ê„ÄÅÂè£ÁΩ©</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">‚úì</span>  
                                <span class="text-sm">ËÉåÊôØÁÆÄÊ¥ÅÔºåÊó†ÈÅÆÊå°</span>  
                            </div>  
                            <div class="requirement-item">  
                                <span class="text-green-600">‚úì</span>  
                                <span class="text-sm">ÁÖßÁâáÊ∏ÖÊô∞Â∫¶È´òÔºåÊñá‰ª∂Â§ß‰∫é100KB</span>  
                            </div>  
                        </div>  
                        <div>  
                            <h3 class="font-bold text-red-700 mb-2">‚ùå ÈîôËØØÁ§∫‰æã</h3>  
                            <div class="warning-item">  
                                <span class="text-red-600">‚úó</span>  
                                <span class="text-sm">‰æßËÑ∏„ÄÅ‰ΩéÂ§¥„ÄÅ‰ª∞Â§¥</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">‚úó</span>  
                                <span class="text-sm">ÂÖâÁ∫øÂ§™ÊöóÊàñÈÄÜÂÖâ</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">‚úó</span>  
                                <span class="text-sm">ÁÖßÁâáÊ®°Á≥ä‰∏çÊ∏Ö</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">‚úó</span>  
                                <span class="text-sm">Êà¥Â¢®Èïú„ÄÅÂè£ÁΩ©„ÄÅÂ∏ΩÂ≠ê</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">‚úó</span>  
                                <span class="text-sm">Â§ö‰∫∫ÂêàÂΩ±ÊàñËøúË∑ùÁ¶ªÊãçÊëÑ</span>  
                            </div>  
                            <div class="warning-item">  
                                <span class="text-red-600">‚úó</span>  
                                <span class="text-sm">ËøáÂ∫¶ÁæéÈ¢úÊàñÊª§Èïú</span>  
                            </div>  
                        </div>  
                    </div>  
                    <div class="bg-yellow-50 border border-yellow-300 rounded p-3 text-sm">  
                        <p class="font-bold text-yellow-800 mb-1">üí° ÊúÄ‰Ω≥ÂÆûË∑µÔºö</p>  
                        <ul class="list-disc ml-5 text-yellow-800 space-y-1">  
                            <li>Âª∫ËÆÆ‰ΩøÁî®ËØÅ‰ª∂ÁÖßÊàñÊ∏ÖÊô∞ÁöÑÁîüÊ¥ªÁÖß</li>  
                            <li>‰∫∫ËÑ∏Âç†ÁÖßÁâáÁöÑ30-50%‰∏∫ÊúÄ‰Ω≥</li>  
                            <li>ÁÖßÁâáÊ†ºÂºèÔºöJPG/PNGÔºåÂàÜËæ®ÁéáÂª∫ËÆÆ800x1000‰ª•‰∏ä</li>  
                            <li>ÊâπÈáèÂØºÂÖ•Êó∂Á°Æ‰øùÊñá‰ª∂ÂêçÊ†ºÂºèÔºö<code class="bg-yellow-100 px-1">Â≠¶Âè∑-ÂßìÂêç-Áè≠Á∫ß.jpg</code></li>  
                        </ul>  
                    </div>  
                </div>  
            </div>  

            <!-- Student Management -->  
            <div class="bg-white rounded-lg shadow-lg p-6">  
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üë• Â≠¶Áîü‰ø°ÊÅØÁÆ°ÁêÜ</h2>  
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">  
                    <!-- üî• Êó¢ÂèØ‰ª•‰∏ãÊãâÈÄâÊã©Ôºå‰πüÂèØ‰ª•ÊâãÂä®ËæìÂÖ• -->
                    <input 
                    type="text" 
                    id="studentClass" 
                    list="classDatalist" 
                    placeholder="ËæìÂÖ•ÊàñÈÄâÊã©Áè≠Á∫ß" 
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    autocomplete="off"
                    >
                    <datalist id="classDatalist">
                        <!-- JavaScript Âä®ÊÄÅÁîüÊàêÈÄâÈ°π -->
                    </datalist>
                    <input type="text" id="studentId" placeholder="Â≠¶Âè∑" class="border rounded px-4 py-2">  
                    <input type="text" id="studentName" placeholder="ÂßìÂêç" class="border rounded px-4 py-2">  
                </div>  
                
                <div class="mb-4">  
                    <label class="block mb-2 font-semibold">Â≠¶ÁîüÁÖßÁâáÔºàÂçïÂº†Ôºâ</label>  
                    <input type="file" id="singlePhoto" accept="image/*" onchange="previewPhoto(this, 'singlePreview')" class="border rounded px-4 py-2 w-full">  
                    <div id="singlePreview" class="mt-2"></div>  
                    <canvas id="photoCanvas" style="display:none;"></canvas>  
                </div>  

                <div class="mb-4">  
                    <label class="block mb-2 font-semibold">ÊâπÈáèÂØºÂÖ•ÁÖßÁâáÔºàÊñá‰ª∂ÂêçÊ†ºÂºèÔºöÂ≠¶Âè∑-ÂßìÂêç-Áè≠Á∫ß.jpgÔºâ</label>  
                    <input type="file" id="batchPhotos" accept="image/*" multiple class="border rounded px-4 py-2 w-full">  
                    <p class="text-sm text-gray-500 mt-1">Á§∫‰æãÔºö251301100-Âº†‰∏â-Êô∫ËÉΩÁßëÂ≠¶‰∏éÊäÄÊúØ2501Áè≠.jpg</p>  
                </div>  

                <button onclick="addStudent()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 mr-2">‚ûï Ê∑ªÂä†Â≠¶Áîü</button>  
                <button onclick="batchImport()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">üì¶ ÊâπÈáèÂØºÂÖ•</button>  

                <div class="mt-6">
                    <h3 class="font-bold mb-2">Â∑≤Ê∑ªÂä†Â≠¶ÁîüÂàóË°®ÔºàÂÖ±<span id="studentCount">0</span> ‰∫∫Ôºâ</h3>
                    <div id="studentList" class="max-h-96 overflow-y-auto border rounded p-4 bg-gray-50"></div>
                </div> 
            </div>  

            <!-- Create Check-in Session -->  
            <div class="bg-white rounded-lg shadow-lg p-6">  
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üìù ÂèëÂ∏ÉÁ≠æÂà∞</h2>  
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">  
                    <input type="text" id="courseName" placeholder="ËØæÁ®ãÂêçÁß∞" class="border rounded px-4 py-2">  
                    <input type="text" id="courseSession" placeholder="ËØæÁ®ãÊó∂Èó¥‰∏éËäÇÊ¨°ÔºàÂ¶ÇÔºö20251014-56Ôºâ" class="border rounded px-4 py-2">  
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">ÈÄâÊã©Áè≠Á∫ßÔºàÂèØÂ§öÈÄâÔºâ</label>
                        
                        <!-- üî• ÊâãÂä®ËæìÂÖ•Áè≠Á∫ß -->
                        <div class="flex gap-2 mb-3">
                            <input 
                                type="text" 
                                id="customClassInput" 
                                placeholder="ËæìÂÖ•Ëá™ÂÆö‰πâÁè≠Á∫ßÂêçÁß∞"
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                onkeypress="if(event.key==='Enter') addCustomClass()"
                            >
                            <button 
                                type="button"
                                onclick="addCustomClass()" 
                                class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-200 shadow-md hover:shadow-lg"
                            >
                                ‚ûï Ê∑ªÂä†
                            </button>
                        </div>
                        
                        <!-- üî• Â§çÈÄâÊ°ÜÂç°ÁâáÂºèÂ§öÈÄâ -->
                        <div id="selectClass" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-80 overflow-y-auto p-2 border border-gray-200 rounded-lg bg-gray-50">
                            <!-- JavaScript Âä®ÊÄÅÁîüÊàêÁè≠Á∫ßÂ§çÈÄâÊ°Ü -->
                        </div>
                        
                        <!-- Â∑≤ÈÄâÊã©ÁöÑÁè≠Á∫ßÊ†áÁ≠æÊòæÁ§∫ -->
                        <div id="selectedClassesTags" class="mt-3 flex flex-wrap gap-2 hidden">
                            <!-- JavaScript Âä®ÊÄÅÁîüÊàêÂ∑≤ÈÄâÊ†áÁ≠æ -->
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2">
                            üí° ÂèØ‰ªéÂàóË°®ÂãæÈÄâÊàñÊâãÂä®ËæìÂÖ•ÔºåÂ∑≤ÈÄâ <span id="selectedCount" class="font-bold text-blue-600">0</span> ‰∏™Áè≠Á∫ß
                        </p>
                    </div>

                    <input type="number" id="checkInDuration" placeholder="Á≠æÂà∞Êó∂ÈïøÔºàÂàÜÈíüÔºâ" class="border rounded px-4 py-2" value="3"> 
                    
                    <!-- üî• Êñ∞Â¢ûÔºöÂèëÂ∏ÉÊó∂Èó¥ÈÄâÊã© -->
                    <div class="md:col-span-2 border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">üìÖ ÂèëÂ∏ÉÊó∂Èó¥ËÆæÁΩÆ</label>
                        
                        <div class="flex gap-2 items-center mb-2">
                            <input type="radio" id="publishNow" name="publishTime" value="now" checked onchange="togglePublishTimeInput()">
                            <label for="publishNow" class="text-sm">Á´ãÂç≥ÂèëÂ∏É</label>
                            
                            <input type="radio" id="publishScheduled" name="publishTime" value="scheduled" onchange="togglePublishTimeInput()">
                            <label for="publishScheduled" class="text-sm">ÂÆöÊó∂ÂèëÂ∏É</label>
                        </div>
                        
                        <div id="scheduledTimeInput" class="hidden">
                            <input 
                                type="datetime-local" 
                                id="publishDateTime" 
                                class="border rounded px-4 py-2 w-full"
                            >
                            <p class="text-xs text-gray-500 mt-1">üí° Âà∞ËÆæÂÆöÊó∂Èó¥ÂêéÂ∞ÜËá™Âä®ÂºÄÂßãÁ≠æÂà∞</p>
                        </div>
                    </div>                    

                </div>  

                <button onclick="startCheckIn()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 w-full">üöÄ ÂºÄÂßãÁ≠æÂà∞</button>  
            </div>  

            <!-- History Records Quick Entry -->  
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg shadow-lg p-6 border-2 border-purple-200">  
                <div class="flex items-center justify-between mb-4">  
                    <div>  
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">  
                            üìö Á≠æÂà∞ËÆ∞ÂΩïÁÆ°ÁêÜ  
                        </h2>  
                        <p class="text-sm text-gray-600 mt-1">Êü•Áúã„ÄÅÂØºÂá∫ÊàñÂà†Èô§ÂéÜÂè≤Á≠æÂà∞ËÆ∞ÂΩï</p>  
                    </div>  
                    <div class="text-right">  
                        <p class="text-sm text-gray-600">ÂÖ±Êúâ</p>  
                        <p class="text-3xl font-bold text-purple-600" id="historyCount">0</p>  
                        <p class="text-sm text-gray-600">Êù°ËÆ∞ÂΩï</p>  
                    </div>  
                </div>  
                <button onclick="viewHistory()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 w-full font-semibold text-lg">  
                    üìñ Êü•ÁúãÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩï  
                </button>  
            </div>  

            <!-- Real-time Check-in Status -->
            <div id="checkInStatus" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <!-- ÂΩìÂâçÁ≠æÂà∞‰ø°ÊÅØ -->
                <div class="mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">
                                üìö <span id="currentCourse">-</span>
                            </h3>
                            <p class="text-gray-600 mt-1">
                                üë• Áè≠Á∫ß: <span id="currentClass">-</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p id="countdown" class="text-lg font-bold text-green-600">‚è±Ô∏è ÂáÜÂ§á‰∏≠...</p>
                        </div>
                    </div>
                </div>

                <!-- Word Cloud with Progress Bar -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-gray-800">
                            ‚è≥ ÂæÖÁ≠æÂà∞Â≠¶ÁîüËØç‰∫ë
                            <span class="text-xs font-normal text-gray-500 ml-2">(ÂÆûÊó∂Êõ¥Êñ∞)</span>
                        </h3>
                        <span id="wordCloudCount" class="text-sm font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full">
                            ÂæÖÁ≠æÂà∞: 0 ‰∫∫
                        </span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span class="font-medium">Á≠æÂà∞ËøõÂ∫¶</span>
                            <span id="wordCloudProgress" class="font-bold text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                            <div id="wordCloudProgressBar" 
                                 class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-full rounded-full transition-all duration-500 ease-out relative overflow-hidden" 
                                 style="width: 0%">
                                <div class="absolute inset-0 bg-white opacity-30 animate-pulse"></div>
                            </div>
                        </div>
            </div>
                    </div>
                    
                    <!-- Word Cloud Container -->
                    <div id="wordCloudContainer" style="width: 100%; height: 400px; position: relative;"></div>
                    
                    <!-- Tips -->
                    <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-gray-700">
                            üí° <strong>ÊèêÁ§∫Ôºö</strong>Â≠¶ÁîüÁ≠æÂà∞ÂêéÂ∞Ü‰ªéËØç‰∫ë‰∏≠Ê∂àÂ§±ÔºåÂÖ®ÈÉ®Á≠æÂà∞ÂÆåÊàêÂêéÊòæÁ§∫Á•ùË¥∫Âä®Áîª
                        </p>
                    </div>
                </div>

                <div class="mt-4 flex flex-wrap gap-4">  
                    <button onclick="endCheckIn()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">‚úÖ ÁªìÊùüÁ≠æÂà∞</button>  
                    <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">üì• ÂØºÂá∫ÂΩìÂâçExcel</button>  
                    <button onclick="refreshCheckInData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">üîÑ Âà∑Êñ∞Êï∞ÊçÆ</button>  
                    <button onclick="viewHistory()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">üìö Êü•ÁúãÂéÜÂè≤ËÆ∞ÂΩï</button>  
                </div>  

            <!-- Â∑≤Á≠æÂà∞ÂàóË°® -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    ‚úÖ Â∑≤Á≠æÂà∞Â≠¶Áîü (<span id="checkedCount">0</span>)
                </h3>
                <div id="checkedInList" class="max-h-96 overflow-y-auto">
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">üìù</p>
                        <p class="text-sm">ÊöÇÊó†Á≠æÂà∞ËÆ∞ÂΩï</p>
                    </div>
                </div>
            </div>

            <!-- Êú™Á≠æÂà∞ÂàóË°® -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    ‚è∞ Êú™Á≠æÂà∞Â≠¶Áîü (<span id="uncheckedCount">0</span>)
                </h3>
                <div id="uncheckedList" class="max-h-96 overflow-y-auto">
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">üë•</p>
                        <p class="text-sm">ÊöÇÊó†Â≠¶Áîü‰ø°ÊÅØ</p>
                    </div>
                </div>


            </div>  

            <!-- History Records -->  
            <div id="historyPanel" class="bg-white rounded-lg shadow-lg p-6 hidden">  
                <div class="flex justify-between items-center mb-4">  
                    <h2 class="text-2xl font-bold text-gray-800">üìö ÂéÜÂè≤Á≠æÂà∞ËÆ∞ÂΩï</h2>  
                    <button onclick="hideHistory()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 flex items-center gap-2">  
                        ‚Üê ËøîÂõû  
                    </button>  
                </div>  
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">  
                    <p class="text-sm text-gray-700">  
                        üí° <strong>ÊèêÁ§∫Ôºö</strong>ÁÇπÂáª"ÂØºÂá∫Excel"ÂèØ‰∏ãËΩΩÁ≠æÂà∞ËÆ∞ÂΩïÔºåÁÇπÂáª"Âà†Èô§"ÂèØÊ∞∏‰πÖÂà†Èô§ËØ•ËÆ∞ÂΩïÔºàÂª∫ËÆÆÂÖàÂØºÂá∫Ôºâ  
                    </p>  
                </div>  
                <div id="historyList" class="space-y-4"></div>  
            </div>  
        </div>  

        <!-- Student Panel -->  
        <div id="studentPanel" class="hidden">  
            <div class="bg-white rounded-lg shadow-lg p-6">  
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üéì Â≠¶ÁîüÁ≠æÂà∞</h2>  

                <!-- Video for face recognition -->  
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">üì∑ ‰∫∫ËÑ∏ËØÜÂà´Á≠æÂà∞</h3>
                    
                    <!-- ËßÜÈ¢ëÂÆπÂô® -->
                    <div class="video-container flex justify-center items-center" >
                        <video 
                        id="video" 
                        autoplay 
                        playsinline 
                        muted
                        class="hidden mx-auto block w-full max-w-2xl rounded-lg shadow-lg"
                    ></video>
                        
                        <canvas 
                            id="faceCanvas" 
                            class="hidden"
                        ></canvas>
                    </div>
                    
                    <!-- Âç†‰ΩçÁ¨¶ -->
                    <div id="videoPlaceholder" class="bg-gray-200 rounded-lg p-8 text-center">
                        <p class="text-gray-600">üì∑ ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊâìÂºÄÁõ∏Êú∫</p>
                    </div>
                    
                    <!-- ËØÜÂà´Áä∂ÊÄÅ -->
                    <div id="recognitionStatus" class="hidden mt-4 p-4 bg-blue-50 rounded-lg text-center"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">  
                    <button onclick="openCamera()" id="cameraBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700">üì∑ ÊâìÂºÄÁõ∏Êú∫Ôºà‰∫∫ËÑ∏ËØÜÂà´Ôºâ</button>  
                    <button onclick="getLocation()" id="locationBtn" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700">üìç Ëé∑ÂèñÂÆö‰Ωç</button>  
                </div>  

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">  
                    <input type="text" id="stuClass" placeholder="Áè≠Á∫ßÔºàËá™Âä®ËØÜÂà´Ôºâ" class="border rounded px-4 py-2">  
                    <input type="text" id="stuId" placeholder="Â≠¶Âè∑ÔºàËá™Âä®ËØÜÂà´Ôºâ" class="border rounded px-4 py-2">  
                    <input type="text" id="stuName" placeholder="ÂßìÂêçÔºàËá™Âä®ËØÜÂà´Ôºâ" class="border rounded px-4 py-2">  
                </div>  

                <div class="mb-4">  
                    <input type="text" id="location" placeholder="ÂÆö‰Ωç‰ø°ÊÅØÔºàËá™Âä®Ëé∑ÂèñÔºâ" class="border rounded px-4 py-2 w-full" readonly>  
                </div>  

                <div id="recognitionStatus" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">  
                    <p class="text-blue-800 font-semibold">üîç Ê≠£Âú®ËØÜÂà´...</p>  
                </div>  

                <button onclick="submitCheckIn()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 w-full text-lg font-bold">‚úÖ Êèê‰∫§Á≠æÂà∞</button>  

                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">  
                    <p class="text-sm text-yellow-800 font-bold mb-2">üí° Á≠æÂà∞ÊèêÁ§∫Ôºö</p>  
                    <ul class="text-sm text-yellow-800 list-disc ml-5 space-y-1">  
                        <li>‰∫∫ËÑ∏ËØÜÂà´ÈúÄË¶ÅÊ≠£ÂØπÊëÑÂÉèÂ§¥Ôºå‰øùÊåÅÂÖâÁ∫øÂÖÖË∂≥</li>  
                        <li>Â¶ÇËØÜÂà´Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â°´ÂÜô‰ø°ÊÅØÂêéÊèê‰∫§</li>  
                        <li>ÂÆö‰ΩçÂäüËÉΩ‰∏∫ÂèØÈÄâÈ°πÔºåÂÆö‰ΩçÂ§±Ë¥•‰∏çÂΩ±ÂìçÁ≠æÂà∞</li>  
                        <li>Âª∫ËÆÆÂÖàËé∑ÂèñÂÆö‰ΩçÔºå‰ΩÜÈùûÂøÖÈúÄ</li>  
                        <li>ËØ∑Á°Æ‰øùÂú®Á≠æÂà∞Êó∂Èó¥ËåÉÂõ¥ÂÜÖÊèê‰∫§</li>  
                    </ul>  
                </div>  
            </div>  
        </div>  
    </div>  

    <script> 
    
        // ==================== ÂìçÂ∫îÂºèÂ§ÑÁêÜ ====================
        
        // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
        window.addEventListener('resize', function() {
            if (wordCloudChart) {
                wordCloudChart.resize();
                console.log('üì± ËØç‰∫ëÂ∑≤ÈÄÇÈÖçÂ±èÂπïÂ∞∫ÂØ∏');
            }
        });

        // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂Âà∑Êñ∞
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && wordCloudChart) {
                setTimeout(() => {
                    wordCloudChart.resize();
                }, 300);
            }
        });    

        // LeanCloud ÂàùÂßãÂåñ - ËØ∑ÊõøÊç¢‰∏∫‰Ω†ÁöÑÂ∫îÁî®Âá≠ËØÅ  
        AV.init({
            appId: "i1PwXfBx9ZVMkIYzZdUUiysn-gzGzoHsz",
            appKey: "gFXLEuRbVBEVBZiLiZrknLxE",
            serverURL: "https://avoscloud.com"
        });

        // Global variables  
        let students = [];  
        let currentCheckInSession = null;  
        let checkedInStudents = [];  
        let faceModelsLoaded = false;  
        let videoStream = null;
        let activeSessions = [];  
        let faceDetectionRunning = false;  
        let labeledDescriptors = [];  
        let recognitionSuccess = false; // ËØÜÂà´ÊàêÂäüÊ†áÂøó  


        // üî• Êñ∞Â¢ûÔºöÂ§öÂ∏ßÈ™åËØÅÊú∫Âà∂
        let recentMatches = [];  // ËÆ∞ÂΩïÊúÄËøëÁöÑÂåπÈÖçÁªìÊûú
        const CONSECUTIVE_FRAMES = 3;  // ÈúÄË¶ÅËøûÁª≠ÂåπÈÖçÁöÑÂ∏ßÊï∞
        const MIN_CONFIDENCE = 0.5;  // ÊúÄ‰ΩéÁΩÆ‰ø°Â∫¶Ôºà55%Ôºâ

        // üî•Ê¥ª‰ΩìÊ£ÄÊµãÁõ∏ÂÖ≥ÂèòÈáè
        let livenessActions = [];          // ÈúÄË¶ÅÂÆåÊàêÁöÑÂä®‰Ωú['blink', 'mouth', 'nod']
        let livenessProgress = {};         // ÂêÑÂä®‰ΩúÂÆåÊàêÊÉÖÂÜµ
        let livenessCheckPassed = false;   // Ê¥ª‰ΩìÊ£ÄÊµãÊòØÂê¶ÂÖ®ÈÉ®ÈÄöËøá

        // Áú®ÁúºÊ£ÄÊµã
        let blinkCount = 0;
        let lastEyeState = 'open';
        let eyeClosedFrames = 0;

        // Áú®ÁúºÊ£ÄÊµãÔºàÂä®ÊÄÅÈòàÂÄºÁâàÔºâ
        let baselineEAR = null;        // ÁùÅÁúºÂü∫ÂáÜÂÄº
        let earSamples = [];           // EARÈááÊ†∑ÂÄº
        const SAMPLE_SIZE = 10;        // ÈááÊ†∑Êï∞Èáè

        // Âº†Âò¥Ê£ÄÊµã
        let mouthOpenCount = 0;
        let lastMouthState = 'closed';

        // ÁÇπÂ§¥Ê£ÄÊµã
        let headPositions = [];
        let nodCount = 0;


        // üî• Êñ∞Â¢ûÔºöÂõ∫ÂÆöÁöÑÁè≠Á∫ßÂàóË°®
        let FIXED_CLASSES = [
            'Êô∫ËÉΩÁßëÂ≠¶2501Áè≠',
            'Êô∫ËÉΩÁßëÂ≠¶2502Áè≠',
            'Êô∫ËÉΩÁßëÂ≠¶2401Áè≠',
            'Êô∫ËÉΩÁßëÂ≠¶2402Áè≠',
            'Êô∫ËÉΩÁßëÂ≠¶2301Áè≠',
            'Êô∫ËÉΩÁßëÂ≠¶2302Áè≠',
            'Êô∫ËÉΩÁßëÂ≠¶2303Áè≠',
            'Êô∫ËÉΩÁßëÂ≠¶2201Áè≠',
            'Êô∫ËÉΩÁßëÂ≠¶2202Áè≠',
            'Êô∫ËÉΩÁßëÂ≠¶2203Áè≠'
        ];


// ==================== ÂàáÊç¢ÂèëÂ∏ÉÊó∂Èó¥ËæìÂÖ•Ê°Ü ====================
function togglePublishTimeInput() {
    const publishNow = document.getElementById('publishNow').checked;
    const scheduledInput = document.getElementById('scheduledTimeInput');
    
    if (publishNow) {
        scheduledInput.classList.add('hidden');
    } else {
        scheduledInput.classList.remove('hidden');
        
    // ‚úÖ Ê≠£Á°ÆÔºö‰ΩøÁî®Êú¨Âú∞Êó∂Èó¥ÔºàÂåó‰∫¨Êó∂Èó¥Ôºâ
    const now = new Date();
    now.setMinutes(now.getMinutes() + 5);

    // ËΩ¨Êç¢‰∏∫Êú¨Âú∞Êó∂Èó¥Â≠óÁ¨¶‰∏≤Ê†ºÂºè (YYYY-MM-DDTHH:mm)
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');

    const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    document.getElementById('publishDateTime').value = localDateTime;
    }
}

        // Load Face-api models with better error handling  
        async function loadFaceModels() {  
            try {  
                console.log('ÂºÄÂßãÂä†ËΩΩ‰∫∫ËÑ∏ËØÜÂà´Ê®°Âûã...');  
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';  
                
                await Promise.all([  
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),  
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),  
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)  
                ]);  
                
                faceModelsLoaded = true;  
                console.log('‚úÖ ‰∫∫ËÑ∏ËØÜÂà´Ê®°ÂûãÂä†ËΩΩÂÆåÊàê');  
            } catch (error) {  
                console.error('‚ùå Ê®°ÂûãÂä†ËΩΩÂ§±Ë¥•:', error);  
                alert('‰∫∫ËÑ∏ËØÜÂà´Ê®°ÂûãÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');  
            }  
        }  

        // Initialize on page load  
        window.onload = async function() {  
            console.log('üöÄ Á≥ªÁªüÂàùÂßãÂåñ‰∏≠...');  
            loadFaceModels(); // ÂºÇÊ≠•Âä†ËΩΩ‰∫∫ËÑ∏Ê®°Âûã
            await loadStudentsFromCloud(); // Á≠âÂæÖÂ≠¶ÁîüÊï∞ÊçÆÂä†ËΩΩ  
            loadClassList(); // Âä†ËΩΩÁè≠Á∫ßÂàóË°®
            // üî• Êñ∞Â¢ûÔºöÂàùÂßãÂåñÁè≠Á∫ß‰∏ãÊãâÂàóË°®
            initClassSelect();    
            updateHistoryCount(); // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïËÆ°Êï∞  
            await checkActiveSession(); // Ê£ÄÊü•Ê¥ªÂä®‰ºöËØù  
            console.log('‚úÖ Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê');  
        };  

        // Toggle photo guide  
        function toggleGuide() {  
            const guide = document.getElementById('photoGuide');  
            guide.classList.toggle('hidden');  
        }  

        // Switch between teacher and student roles  
        function switchRole(role) {  
            // Stop camera if switching away from student panel  
            if (role === 'teacher' && videoStream) {  
                stopCamera();  
            }  

            if (role === 'teacher') {  
                document.getElementById('teacherPanel').classList.remove('hidden');  
                document.getElementById('studentPanel').classList.add('hidden');  
                document.getElementById('teacherTab').classList.add('tab-active');  
                document.getElementById('studentTab').classList.remove('tab-active');  
            } else {  
                document.getElementById('teacherPanel').classList.add('hidden');  
                document.getElementById('studentPanel').classList.remove('hidden');  
                document.getElementById('teacherTab').classList.remove('tab-active');  
                document.getElementById('studentTab').classList.add('tab-active');  
            }  
        }  

        // Preview photo before upload  
        function previewPhoto(input, previewId) {  
            const preview = document.getElementById(previewId);  
            preview.innerHTML = '';  
            
            if (input.files && input.files[0]) {  
                const reader = new FileReader();  
                reader.onload = function(e) {  
                    preview.innerHTML = `  
                        <div class="flex items-center gap-4 mt-2">  
                            <img src="${e.target.result}" class="w-32 h-32 object-cover rounded border">  
                            <div class="text-sm text-gray-600">  
                                <p>Êñá‰ª∂Âêç: ${input.files[0].name}</p>  
                                <p>Â§ßÂ∞è: ${(input.files[0].size / 1024).toFixed(2)} KB</p>  
                                <p class="text-green-600">‚úì ÁÖßÁâáÂ∑≤ÈÄâÊã©</p>  
                            </div>  
                        </div>  
                    `;  
                };  
                reader.readAsDataURL(input.files[0]);  
            }  
        }  

        // Add single student with improved face extraction  
        async function addStudent() {  
            const className = document.getElementById('studentClass').value;  
            const studentId = document.getElementById('studentId').value;  
            const name = document.getElementById('studentName').value;  
            const photoInput = document.getElementById('singlePhoto');  

            if (!className || !studentId || !name) {  
                alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÂ≠¶Áîü‰ø°ÊÅØ');  
                return;  
            }  

            if (!photoInput.files[0]) {  
                alert('ËØ∑‰∏ä‰º†Â≠¶ÁîüÁÖßÁâá');  
                return;  
            }  

            // Check file size  
            if (photoInput.files[0].size < 50000) {  
                if (!confirm('ÁÖßÁâáÊñá‰ª∂ËæÉÂ∞èÔºà<50KBÔºâÔºåÂèØËÉΩÂΩ±ÂìçËØÜÂà´ÊïàÊûúÔºåÊòØÂê¶ÁªßÁª≠Ôºü')) {  
                    return;  
                }  
            }  

            try {  
                // Extract face descriptor from photo  
                const descriptor = await extractFaceFromFile(photoInput.files[0]);  
                
                if (!descriptor) {  
                    alert('‚ùå Êú™ËÉΩ‰ªéÁÖßÁâá‰∏≠Ê£ÄÊµãÂà∞‰∫∫ËÑ∏ÔºÅ\n\nËØ∑Á°Æ‰øùÔºö\n‚úì ÁÖßÁâáÊ∏ÖÊô∞ÔºåÊ≠£Èù¢ÊãçÊëÑ\n‚úì ÂÖâÁ∫øÂÖÖË∂≥ÔºåÊó†ÈÅÆÊå°\n‚úì ‰∏çÊà¥Â¢®Èïú„ÄÅÂè£ÁΩ©\n\nÂª∫ËÆÆÂèÇËÄÉ‰∏äÊñπ"ÁÖßÁâáÂΩïÂÖ•Ë¶ÅÊ±Ç"');  
                    return;  
                }  

                // Upload photo to LeanCloud  
                const file = new AV.File(photoInput.files[0].name, photoInput.files[0]);  
                await file.save();  

                const student = {  
                    className: className,  
                    studentId: studentId,  
                    name: name,  
                    photoUrl: file.url(),  
                    faceDescriptor: Array.from(descriptor)  
                };  

                // Save to LeanCloud  
                const Student = AV.Object.extend('Student');  
                const studentObj = new Student();  
                Object.keys(student).forEach(key => studentObj.set(key, student[key]));  
                await studentObj.save();  

                students.push(student);  
                updateStudentList();  
                loadClassList();  
                updateLabeledDescriptors();  

                // Clear inputs  
                document.getElementById('studentClass').value = '';  
                document.getElementById('studentId').value = '';  
                document.getElementById('studentName').value = '';  
                document.getElementById('singlePhoto').value = '';  
                document.getElementById('singlePreview').innerHTML = '';  

                alert('‚úÖ Â≠¶ÁîüÊ∑ªÂä†ÊàêÂäüÔºÅ‰∫∫ËÑ∏ÁâπÂæÅÂ∑≤ÊèêÂèñ');  
            } catch (error) {  
                console.error('Ê∑ªÂä†Â≠¶ÁîüÂ§±Ë¥•:', error);  
                alert('Ê∑ªÂä†Â§±Ë¥•Ôºö' + error.message);  
            }  
        }  

        // Extract face descriptor from file  
        async function extractFaceFromFile(file) {  
            return new Promise((resolve, reject) => {  
                const img = document.createElement('img');  
                const canvas = document.getElementById('photoCanvas');  
                const ctx = canvas.getContext('2d');  
                
                img.onload = async () => {  
                    canvas.width = img.width;  
                    canvas.height = img.height;  
                    ctx.drawImage(img, 0, 0);  
                    
                    try {  
                        // Use tinyFaceDetector for better performance  
                        const detection = await faceapi  
                            .detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions({  
                                inputSize: 416,  
                                scoreThreshold: 0.5  
                            }))  
                            .withFaceLandmarks()  
                            .withFaceDescriptor();  
                        
                        if (detection) {  
                            console.log('‚úÖ ÊàêÂäüÊèêÂèñ‰∫∫ËÑ∏ÁâπÂæÅ, ÁΩÆ‰ø°Â∫¶:', detection.detection.score.toFixed(3));  
                            resolve(detection.descriptor);  
                        } else {  
                            console.warn('‚ùå Êú™Ê£ÄÊµãÂà∞‰∫∫ËÑ∏');  
                            resolve(null);  
                        }  
                    } catch (error) {  
                        console.error('‰∫∫ËÑ∏ÊèêÂèñÈîôËØØ:', error);  
                        reject(error);  
                    }  
                };  
                
                img.onerror = () => reject(new Error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•'));  
                img.src = URL.createObjectURL(file);  
            });  
        }  

        // Batch import students from photos  
        async function batchImport() {  
            const photoInput = document.getElementById('batchPhotos');  
            if (!photoInput.files.length) {  
                alert('ËØ∑ÈÄâÊã©ÁÖßÁâáÊñá‰ª∂');  
                return;  
            }  

            let successCount = 0;  
            let failedCount = 0;  
            const totalFiles = photoInput.files.length;  
            const failedFiles = [];  

            for (let i = 0; i < totalFiles; i++) {  
                const file = photoInput.files[i];  
                try {  
                    // Parse filename: Â≠¶Âè∑-ÂßìÂêç-Áè≠Á∫ß.jpg  
                    const filename = file.name.split('.')[0];  
                    const parts = filename.split('-');  
                    
                    if (parts.length !== 3) {  
                        console.warn(`‚ö†Ô∏è Êñá‰ª∂ÂêçÊ†ºÂºèÈîôËØØ: ${file.name}`);  
                        failedFiles.push(`${file.name} (Ê†ºÂºèÈîôËØØ)`);  
                        failedCount++;  
                        continue;  
                    }  

                    const [studentId, name, className] = parts;  

                    // Extract face descriptor  
                    const descriptor = await extractFaceFromFile(file);  
                    
                    if (!descriptor) {  
                        console.warn(`‚ö†Ô∏è Êú™ËÉΩ‰ªé ${file.name} ‰∏≠Ê£ÄÊµãÂà∞‰∫∫ËÑ∏`);  
                        failedFiles.push(`${file.name} (Êó†‰∫∫ËÑ∏)`);  
                        failedCount++;  
                        continue;  
                    }  

                    // Upload to LeanCloud  
                    const avFile = new AV.File(file.name, file);  
                    await avFile.save();  

                    const student = {  
                        className: className,  
                        studentId: studentId,  
                        name: name,  
                        photoUrl: avFile.url(),  
                        faceDescriptor: Array.from(descriptor)  
                    };  

                    // Save to LeanCloud  
                    const Student = AV.Object.extend('Student');  
                    const studentObj = new Student();  
                    Object.keys(student).forEach(key => studentObj.set(key, student[key]));  
                    await studentObj.save();  

                    students.push(student);  
                    successCount++;  
                    
                    console.log(`‚úÖ ÊàêÂäüÂØºÂÖ•: ${name} (${i+1}/${totalFiles})`);  
                } catch (error) {  
                    console.error(`‚ùå Â§ÑÁêÜÊñá‰ª∂Â§±Ë¥• ${file.name}:`, error);  
                    failedFiles.push(`${file.name} (Á≥ªÁªüÈîôËØØ)`);  
                    failedCount++;  
                }  
            }  

            updateStudentList();  
            loadClassList();  
            updateLabeledDescriptors();  
            photoInput.value = '';  
            
            let message = `ÊâπÈáèÂØºÂÖ•ÂÆåÊàêÔºÅ\n\nÊàêÂäüÔºö${successCount} ‰∫∫\nÂ§±Ë¥•Ôºö${failedCount} ‰∫∫`;  
            if (failedFiles.length > 0 && failedFiles.length <= 10) {  
                message += '\n\nÂ§±Ë¥•Êñá‰ª∂Ôºö\n' + failedFiles.join('\n');  
            }  
            alert(message);  
        }  

        // Update labeled descriptors for face matching  
        function updateLabeledDescriptors() {  
            labeledDescriptors = students  
                .filter(s => s.faceDescriptor && s.faceDescriptor.length > 0)  
                .map(s => new faceapi.LabeledFaceDescriptors(  
                    `${s.studentId}|${s.name}|${s.className}`,  
                    [new Float32Array(s.faceDescriptor)]  
                ));  
            console.log(`Â∑≤Âä†ËΩΩ ${labeledDescriptors.length} ‰∏™Â≠¶ÁîüÁöÑ‰∫∫ËÑ∏Êï∞ÊçÆ`);  
        }  

// Update student list display - ÊåâÁè≠Á∫ßÂàÜÁªÑÊòæÁ§∫
function updateStudentList() {
    const list = document.getElementById('studentList');
    const count = document.getElementById('studentCount');
    
    count.textContent = students.length;
    
    if (students.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-center py-4">ÊöÇÊó†Â≠¶ÁîüÊï∞ÊçÆ</p>';
        return;
    }
    
    // ÊåâÁè≠Á∫ßÂàÜÁªÑ
    const groupedByClass = {};
    students.forEach((student, index) => {
        const className = student.className || 'Êú™ÂàÜÁ±ª';
        if (!groupedByClass[className]) {
            groupedByClass[className] = [];
        }
        groupedByClass[className].push({ ...student, originalIndex: index });
    });
    
    // ÊåâÁè≠Á∫ßÂêçÁß∞ÊéíÂ∫è
    const sortedClasses = Object.keys(groupedByClass).sort((a, b) => 
        a.localeCompare(b, 'zh-CN')
    );
    
    let html = '';
    
    sortedClasses.forEach(className => {
        const classStudents = groupedByClass[className];
        const studentCount = classStudents.length;
        const hasPhotoCount = classStudents.filter(s => s.faceDescriptor).length;
        
        html += `
            <div class="class-group">
                <!-- Áè≠Á∫ßÂ§¥ÈÉ® -->
                <div class="class-header" onclick="toggleClass('${className}')">
                    <div class="class-title">
                        <span class="class-arrow" id="arrow-${className}">‚ñº</span>
                        <span>üìö ${className}</span>
                        <span class="text-sm text-gray-600">(${studentCount} ‰∫∫)</span>
                    </div>
                    <div class="class-actions" onclick="event.stopPropagation()">
                        <span class="text-xs text-green-600">‚úì${hasPhotoCount} ‰∫∫Â∑≤ÂΩïÂÖ•</span>
                        <button 
                            onclick="deleteClass('${className}')" 
                            class="btn-sm btn-warning"
                            title="Âà†Èô§Êï¥‰∏™Áè≠Á∫ß"
                        >
                            üóëÔ∏è Âà†Èô§Áè≠Á∫ß
                        </button>
                    </div>
                </div>
                
                <!-- Â≠¶ÁîüÂàóË°® -->
                <div class="class-students" id="students-${className}">
                    ${classStudents.map(student => `
                        <div class="student-item">
                            <div class="student-info">
                                ${student.photoUrl 
                                    ? `<img src="${student.photoUrl}" class="student-avatar" alt="${student.name}"/>` 
                                    : '<div class="student-avatar" style="background: #e5e7eb; display: flex; align-items: center; justify-content: center;">üë§</div>'
                                }
                                <div class="student-details">
                                    <span class="student-name">${student.name}</span>
                                    <span class="student-id">Â≠¶Âè∑Ôºö${student.studentId}</span>
                                </div>
                                ${student.faceDescriptor 
                                    ? '<span class="badge badge-success">‚úì Â∑≤ÂΩïÂÖ•‰∫∫ËÑ∏</span>' 
                                    : '<span class="badge badge-error">‚úó Êó†‰∫∫ËÑ∏Êï∞ÊçÆ</span>'
                                }
                            </div>
                            <button 
                                onclick="deleteStudent(${student.originalIndex})" 
                                class="btn-sm btn-danger"
                                title="Âà†Èô§ËØ•Â≠¶Áîü"
                            >
                                Âà†Èô§
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
    console.log(`‚úÖÂ≠¶ÁîüÂàóË°®Â∑≤Êõ¥Êñ∞ÔºåÂÖ± ${sortedClasses.length} ‰∏™Áè≠Á∫ßÔºå${students.length} ÂêçÂ≠¶Áîü`);
}

// Toggle class expansion
function toggleClass(className) {
    const studentsDiv = document.getElementById(`students-${className}`);
    const arrow = document.getElementById(`arrow-${className}`);
    
    if (!studentsDiv || !arrow) return;
    
    if (studentsDiv.classList.contains('collapsed')) {
        // Â±ïÂºÄ
        studentsDiv.classList.remove('collapsed');
        arrow.classList.remove('collapsed');
        console.log(`üìÇ Â±ïÂºÄÁè≠Á∫ß: ${className}`);
    } else {
        // ÊäòÂè†
        studentsDiv.classList.add('collapsed');
        arrow.classList.add('collapsed');
        console.log(`üìÅ ÊäòÂè†Áè≠Á∫ß: ${className}`);
    }
}

// Delete entire class (Âà†Èô§Êï¥‰∏™Áè≠Á∫ß)
async function deleteClass(className) {
    // ÊâæÂà∞ËØ•Áè≠Á∫ßÁöÑÊâÄÊúâÂ≠¶Áîü
    const classStudents = students.filter(s => s.className === className);
    
    if (classStudents.length === 0) {
        alert('ËØ•Áè≠Á∫ßÊ≤°ÊúâÂ≠¶Áîü');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è Á°ÆÂÆöË¶ÅÂà†Èô§Êï¥‰∏™Áè≠Á∫ßÂêóÔºü\n\nÁè≠Á∫ßÔºö${className}\nÂ≠¶ÁîüÊï∞Ôºö${classStudents.length} ‰∫∫\n\nÊ≠§Êìç‰ΩúÂ∞ÜÔºö\n‚úì Âà†Èô§ÊâÄÊúâÂ≠¶ÁîüËÆ∞ÂΩï\n‚úì Âà†Èô§ÊâÄÊúâÂ≠¶ÁîüÁÖßÁâá\n‚úì Êó†Ê≥ïÊÅ¢Â§ç\n\nÂª∫ËÆÆÂÖàÂØºÂá∫Êï∞ÊçÆÂ§á‰ªΩÔºÅ`)) {
        return;
    }
    
    try {
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log(`üóëÔ∏è ÂºÄÂßãÂà†Èô§Áè≠Á∫ß: ${className}`);
        console.log(`üìä Â≠¶ÁîüÊï∞Èáè: ${classStudents.length}`);
        
        let successCount = 0;
        let failedCount = 0;
        let fileDeleteCount = 0;
        
        // ÈÄê‰∏™Âà†Èô§Â≠¶Áîü
        for (const student of classStudents) {
            try {
                console.log(`\nÂ§ÑÁêÜÂ≠¶Áîü: ${student.name} (${student.studentId})`);
                
                // 1. Êü•ËØ¢Â≠¶ÁîüËÆ∞ÂΩï
                const query = new AV.Query('Student');
                query.equalTo('studentId', student.studentId);
                const result = await query.first();
                
                if (result) {
                    // 2. Âà†Èô§ÁÖßÁâáÊñá‰ª∂
                    const photoUrl = result.get('photoUrl');
                    if (photoUrl && typeof photoUrl === 'string') {
                        try {
                            const urlParts = photoUrl.split('.com/');
                            const encodedKey = urlParts[1];
                            const decodedKey = decodeURIComponent(encodedKey);
                            
                            const fileQuery = new AV.Query('_File');
                            fileQuery.equalTo('key', decodedKey);
                            const fileObj = await fileQuery.first();
                            
                            if (fileObj) {
                                await fileObj.destroy();
                                fileDeleteCount++;
                                console.log(`  ‚úÖ ÁÖßÁâáÂ∑≤Âà†Èô§`);
                            }
                        } catch (fileError) {
                            console.warn(`  ‚ö†Ô∏è ÁÖßÁâáÂà†Èô§Â§±Ë¥•:`, fileError.message);
                        }
                    }
                    
                    // 3. Âà†Èô§Â≠¶ÁîüËÆ∞ÂΩï
                    await result.destroy();
                    successCount++;
                    console.log(`  ‚úÖ Â≠¶ÁîüËÆ∞ÂΩïÂ∑≤Âà†Èô§`);
                }
                
            } catch (error) {
                console.error(`  ‚ùå Âà†Èô§Â§±Ë¥•:`, error);
                failedCount++;
            }
        }
        
        // 4. Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
        students = students.filter(s => s.className !== className);
        updateStudentList();
        loadClassList();
        updateLabeledDescriptors();
        
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('‚úÖ Áè≠Á∫ßÂà†Èô§ÂÆåÊàê');
        console.log(`ÊàêÂäü: ${successCount} ‰∫∫`);
        console.log(`Â§±Ë¥•: ${failedCount} ‰∫∫`);
        console.log(`ÁÖßÁâá: ${fileDeleteCount} ‰∏™`);
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        
        alert(`‚úÖ Áè≠Á∫ßÂà†Èô§ÂÆåÊàêÔºÅ\n\nÁè≠Á∫ßÔºö${className}\nÊàêÂäüÂà†Èô§Ôºö${successCount} ‰∫∫\nÂà†Èô§ÁÖßÁâáÔºö${fileDeleteCount} ‰∏™${failedCount > 0 ? `\nÂ§±Ë¥•Ôºö${failedCount} ‰∫∫` : ''}`);
        
    } catch (error) {
        console.error('‚ùå Âà†Èô§Áè≠Á∫ßÂ§±Ë¥•:', error);
        alert('Âà†Èô§Áè≠Á∫ßÂ§±Ë¥•Ôºö' + error.message);
    }
}




        // Delete student (Ëß£Á†Å key ÂêéÊü•ËØ¢)
        async function deleteStudent(index) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§ËØ•Â≠¶ÁîüÔºü')) {
                return;
            }

            const student = students[index];
            
            try {
                let fileDeleteCount = 0;
                const query = new AV.Query('Student');
                query.equalTo('studentId', student.studentId);
                const result = await query.first();
                
                if (result) {
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('üóëÔ∏è ÂºÄÂßãÂà†Èô§Â≠¶Áîü:', student.name, student.studentId);

                    // Âà†Èô§ photoUrl ÂØπÂ∫îÁöÑÊñá‰ª∂
                    const photoUrl = result.get('photoUrl');
                    
                    if (photoUrl && typeof photoUrl === 'string') {
                        console.log('üì∑ photoUrl:', photoUrl);
                        
                        try {
                            // ‰ªé URL ÊèêÂèñ keyÔºàÂ∑≤ÁºñÁ†ÅÔºâ
                            const urlParts = photoUrl.split('.com/');
                            const encodedKey = urlParts[1];
                            console.log('  ÊèêÂèñÂà∞ÁöÑ key (ÁºñÁ†Å):', encodedKey);
                            
                            // Ëß£Á†Å keyÔºàËΩ¨Êç¢‰∏∫‰∏≠ÊñáÔºâ
                            const decodedKey = decodeURIComponent(encodedKey);
                            console.log('  Ëß£Á†ÅÂêéÁöÑ key (‰∏≠Êñá):', decodedKey);
                            
                            // ‰ΩøÁî®Ëß£Á†ÅÂêéÁöÑ key Êü•ËØ¢ _File Ë°®
                            console.log('  üîç Êü•ËØ¢ _File Ë°®...');
                            const fileQuery = new AV.Query('_File');
                            fileQuery.equalTo('key', decodedKey);
                            const fileObj = await fileQuery.first();
                            
                            if (fileObj) {
                                console.log('  ‚úÖ ÊâæÂà∞Êñá‰ª∂ËÆ∞ÂΩï:');
                                console.log('     objectId:', fileObj.id);
                                console.log('     key:', fileObj.get('key'));
                                console.log('     name:', fileObj.get('name'));
                                
                                await fileObj.destroy();
                                console.log('  ‚úÖ Êñá‰ª∂Â∑≤Âà†Èô§');
                                fileDeleteCount++;
                            } else {
                                console.log('  ‚ö†Ô∏è Êú™ÊâæÂà∞Êñá‰ª∂ËÆ∞ÂΩï');
                                console.log('  Êü•ËØ¢ÁöÑ key:', decodedKey);
                            }
                        } catch (fileError) {
                            console.error('  ‚ùå Âà†Èô§Êñá‰ª∂Â§±Ë¥•:', fileError.message);
                            
                            if (fileError.code === 403) {
                                console.log('  üí° ÈúÄË¶ÅËÆæÁΩÆ _File Ë°®ÁöÑ find Âíå delete ÊùÉÈôê');
                            }
                        }
                    }

                    // Âà†Èô§Â≠¶ÁîüËÆ∞ÂΩï
                    console.log('\nüóëÔ∏è Âà†Èô§Â≠¶ÁîüËÆ∞ÂΩï...');
                    await result.destroy();
                    console.log('‚úÖ Â≠¶ÁîüËÆ∞ÂΩïÂ∑≤Âà†Èô§');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                }

                // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                students.splice(index, 1);
                updateStudentList();
                loadClassList();
                updateLabeledDescriptors();
                
                alert(fileDeleteCount > 0 
                    ? `Âà†Èô§ÊàêÂäüÔºÅ\nÂ∑≤Âà†Èô§Â≠¶ÁîüÔºö${student.name}\nÂ∑≤Âà†Èô§ÁÖßÁâáÔºö${fileDeleteCount} ‰∏™`
                    : `Âà†Èô§ÊàêÂäüÔºÅ\nÂ∑≤Âà†Èô§Â≠¶ÁîüÔºö${student.name}`);
                
            } catch (error) {
                console.error('‚ùå Âà†Èô§Â§±Ë¥•:', error);
                alert('Âà†Èô§Â§±Ë¥•Ôºö' + error.message);
            }
        }

        // Load students from LeanCloud  
        async function loadStudentsFromCloud() {  
            try {  
                console.log('üì• Ê≠£Âú®‰ªé‰∫ëÁ´ØÂä†ËΩΩÂ≠¶ÁîüÊï∞ÊçÆ...');  
                const query = new AV.Query('Student');  
                query.limit(1000);  
                const results = await query.find();  
                students = results.map(obj => ({  
                    className: obj.get('className'),  
                    studentId: obj.get('studentId'),  
                    name: obj.get('name'),  
                    photoUrl: obj.get('photoUrl'),  
                    faceDescriptor: obj.get('faceDescriptor')  
                }));  
                updateStudentList();  
                updateLabeledDescriptors();  
                loadClassList(); // Âä†ËΩΩÂÆåÂ≠¶ÁîüÂêéÊõ¥Êñ∞Áè≠Á∫ßÂàóË°®  
                console.log(`‚úÖ ‰ªé‰∫ëÁ´ØÂä†ËΩΩ‰∫Ü ${students.length} ‰∏™Â≠¶Áîü`);  
            } catch (error) {  
                console.error('‚ùå Âä†ËΩΩÂ≠¶ÁîüÊï∞ÊçÆÂ§±Ë¥•:', error);  
                alert('Âä†ËΩΩÂ≠¶ÁîüÊï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message + '\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåLeanCloudÈÖçÁΩÆ');  
            }  
        }  

        // Load class list for dropdown - Êîπ‰∏∫Â§öÈÄâÊîØÊåÅ  
// ==================== Âä†ËΩΩÁè≠Á∫ßÂàóË°®ÔºàÂç°ÁâáÂºèÂ§çÈÄâÊ°ÜÔºâ====================
function loadClassList() {
    const classSelection = document.getElementById('selectClass') || document.getElementById('classSelection');
    
    if (!classSelection) {
        console.error('‚ùå Êâæ‰∏çÂà∞Áè≠Á∫ßÈÄâÊã©Âô®ÂÖÉÁ¥†');
        return;
    }
    
    // üî• ‰ΩøÁî®Âõ∫ÂÆöÁöÑÁè≠Á∫ßÂàóË°®
    if (!FIXED_CLASSES || FIXED_CLASSES.length === 0) {
        console.warn('‚ö†Ô∏è Êú™ÂÆö‰πâÁè≠Á∫ßÂàóË°®');
        classSelection.innerHTML = '<div class="text-center text-gray-500 py-4">ÊöÇÊó†Áè≠Á∫ßÔºàËØ∑Âú®‰ª£Á†Å‰∏≠ËÆæÁΩÆ FIXED_CLASSESÔºâ</div>';
        return;
    }
    
    // üî• Ê∏ÖÁ©∫Âπ∂ÁîüÊàêÂ§çÈÄâÊ°ÜÂç°Áâá
    classSelection.innerHTML = '';
    
    FIXED_CLASSES.forEach((className, index) => {
        const checkboxCard = document.createElement('div');
        checkboxCard.className = 'class-checkbox-card';
        
        const checkboxId = `class-checkbox-${index}`;
        
        checkboxCard.innerHTML = `
            <input 
                type="checkbox" 
                id="${checkboxId}" 
                value="${className}"
                onchange="updateSelectedClasses()"
            >
            <label for="${checkboxId}" class="class-checkbox-label">
                <span class="class-checkbox-icon"></span>
                <span class="flex-1">${className}</span>
            </label>
        `;
        
        classSelection.appendChild(checkboxCard);
    });
    
    console.log(`‚úÖ Âä†ËΩΩ‰∫Ü ${FIXED_CLASSES.length} ‰∏™Áè≠Á∫ßÔºàÂç°ÁâáÂºèÈÄâÊã©Ôºâ:`, FIXED_CLASSES);
}

// ==================== Êõ¥Êñ∞Â∑≤ÈÄâÁè≠Á∫ßÊòæÁ§∫ ====================
function updateSelectedClasses() {
    const checkboxes = document.querySelectorAll('#selectClass input[type="checkbox"], #classSelection input[type="checkbox"]');
    const selectedClasses = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    const tagsContainer = document.getElementById('selectedClassesTags');
    if (!tagsContainer) return;
    
    // Ëé∑ÂèñÁé∞ÊúâÁöÑËá™ÂÆö‰πâÊ†áÁ≠æÔºà‰∏çÂú®Â§çÈÄâÊ°Ü‰∏≠ÁöÑÔºâ
    const existingTags = Array.from(tagsContainer.querySelectorAll('.selected-tag'));
    const customClasses = existingTags
        .map(tag => tag.getAttribute('data-class'))
        .filter(className => {
            // ‰øùÁïô‰∏çÂú®Â§çÈÄâÊ°ÜÂàóË°®‰∏≠ÁöÑËá™ÂÆö‰πâÁè≠Á∫ß
            return !Array.from(checkboxes).some(cb => cb.value === className);
        });
    
    // ÂêàÂπ∂Â§çÈÄâÊ°ÜÈÄâ‰∏≠ÁöÑÂíåËá™ÂÆö‰πâÁöÑÁè≠Á∫ß
    const allClasses = [...selectedClasses, ...customClasses];
    
    if (allClasses.length === 0) {
        tagsContainer.classList.add('hidden');
        tagsContainer.innerHTML = '';
        updateClassCount();
        return;
    }
    
    tagsContainer.classList.remove('hidden');
    tagsContainer.innerHTML = allClasses.map(className => {
        const isFromCheckbox = selectedClasses.includes(className);
        return `
            <span class="selected-tag" data-class="${className}">
                ${className}
                <span class="remove-tag" onclick="${isFromCheckbox ? `removeClassSelection('${className}')` : 'removeCustomClassTag(this)'}">√ó</span>
            </span>
        `;
    }).join('');
    
    updateClassCount();
}

// ==================== Ê∑ªÂä†Ëá™ÂÆö‰πâÁè≠Á∫ß ====================
function addCustomClass() {
    const input = document.getElementById('customClassInput');
    const className = input.value.trim();
    
    if (!className) {
        alert('‚ö†Ô∏è ËØ∑ËæìÂÖ•Áè≠Á∫ßÂêçÁß∞');
        return;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂú®Â∑≤ÈÄâÂàóË°®‰∏≠
    const existingTags = Array.from(document.querySelectorAll('#selectedClassesTags .selected-tag'))
        .map(tag => tag.textContent.replace('√ó', '').trim());
    
    if (existingTags.includes(className)) {
        alert('‚ö†Ô∏è ËØ•Áè≠Á∫ßÂ∑≤ÁªèÈÄâÊã©');
        input.value = '';
        return;
    }
    
    // Ê∑ªÂä†Âà∞Â∑≤ÈÄâÊ†áÁ≠æ
    const tagsContainer = document.getElementById('selectedClassesTags');
    if (!tagsContainer) return;
    
    tagsContainer.classList.remove('hidden');
    
    const tag = document.createElement('span');
    tag.className = 'selected-tag';
    tag.setAttribute('data-class', className);
    tag.innerHTML = `
        ${className}
        <span class="remove-tag" onclick="removeCustomClassTag(this)">√ó</span>
    `;
    
    tagsContainer.appendChild(tag);
    
    // Êõ¥Êñ∞ËÆ°Êï∞
    updateClassCount();
    
    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    input.value = '';
    
    console.log(`‚úÖ Ê∑ªÂä†Ëá™ÂÆö‰πâÁè≠Á∫ß: ${className}`);
}

// ==================== ÁßªÈô§Ëá™ÂÆö‰πâÁè≠Á∫ßÊ†áÁ≠æ ====================
function removeCustomClassTag(element) {
    const tag = element.parentElement;
    const className = tag.getAttribute('data-class');
    
    // Â¶ÇÊûúÊòØ‰ªéÂõ∫ÂÆöÂàóË°®ÈÄâÁöÑÔºåÂèñÊ∂àÂãæÈÄâ
    const checkbox = Array.from(document.querySelectorAll('#selectClass input[type="checkbox"]'))
        .find(cb => cb.value === className);
    
    if (checkbox) {
        checkbox.checked = false;
    }
    
    // ÁßªÈô§Ê†áÁ≠æ
    tag.remove();
    
    // Êõ¥Êñ∞ËÆ°Êï∞
    updateClassCount();
}

// ==================== Êõ¥Êñ∞Áè≠Á∫ßËÆ°Êï∞ ====================
function updateClassCount() {
    const tagsContainer = document.getElementById('selectedClassesTags');
    const tags = tagsContainer.querySelectorAll('.selected-tag');
    const count = tags.length;
    
    const countSpan = document.getElementById('selectedCount');
    if (countSpan) {
        countSpan.textContent = count;
    }
    
    // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©ÔºåÈöêËóèÊ†áÁ≠æÂÆπÂô®
    if (count === 0) {
        tagsContainer.classList.add('hidden');
    }
}



// ==================== ÁßªÈô§Áè≠Á∫ßÈÄâÊã© ====================
function removeClassSelection(className) {
    const checkboxes = document.querySelectorAll('#selectClass input[type="checkbox"], #classSelection input[type="checkbox"]');
    const checkbox = Array.from(checkboxes).find(cb => cb.value === className);
    
    if (checkbox) {
        checkbox.checked = false;
        updateSelectedClasses();
    }
}

// ==================== ÂºÄÂßãÁ≠æÂà∞ÔºàÊîØÊåÅÂÆöÊó∂ÂèëÂ∏ÉÔºâ====================
async function startCheckIn() {
    try {
        console.log('üöÄ ÂáÜÂ§áÂèëÂ∏ÉÁ≠æÂà∞...');
        
        // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
        const courseName = document.getElementById('courseName').value.trim();
        const courseSession = document.getElementById('courseSession').value.trim();
        const duration = parseInt(document.getElementById('checkInDuration').value);
        
        // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÁè≠Á∫ß

        // üî• ‰ªéÂ§çÈÄâÊ°ÜÂíåËá™ÂÆö‰πâÊ†áÁ≠æËé∑ÂèñÊâÄÊúâÈÄâ‰∏≠ÁöÑÁè≠Á∫ß
        const checkbox2 = document.querySelectorAll('#selectClass input[type="checkbox"]:checked');
        const checkboxClasses = Array.from(checkbox2).map(cb => cb.value);

        // Ëé∑ÂèñÊâÄÊúâÂ∑≤ÈÄâÊ†áÁ≠æÔºàÂåÖÊã¨Ëá™ÂÆö‰πâÁöÑÔºâ
        const tags = document.querySelectorAll('#selectedClassesTags .selected-tag');
        const tagClasses = Array.from(tags).map(tag => tag.getAttribute('data-class'));

        // ÂêàÂπ∂ÂéªÈáç
        const classNames = [...new Set([...checkboxClasses, ...tagClasses])];

        console.log("ÈÄâÊã©ÁöÑÁè≠Á∫ßÊòØÔºö", classNames);




        const selectedClasses = classNames;
        
        // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
        if (!courseName) {
            alert('‚ùå ËØ∑ËæìÂÖ•ËØæÁ®ãÂêçÁß∞');
            return;
        }
        if (!courseSession) {
            alert('‚ùå ËØ∑ËæìÂÖ•ËØæÁ®ãËäÇÊ¨°');
            return;
        }
        if (selectedClasses.length === 0) {
            alert('‚ùå ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Áè≠Á∫ß');
            return;
        }
        if (!duration || duration <= 0) {
            alert('‚ùå ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁ≠æÂà∞Êó∂Èïø');
            return;
        }
        
        // Ëé∑ÂèñÈÄâ‰∏≠Áè≠Á∫ßÁöÑÂ≠¶Áîü
        const selectedStudents = students.filter(s => selectedClasses.includes(s.className));
        if (selectedStudents.length === 0) {
            alert('‚ùå ÊâÄÈÄâÁè≠Á∫ßÊ≤°ÊúâÂ≠¶ÁîüÔºåËØ∑ÂÖàÂØºÂÖ•Â≠¶ÁîüÂêçÂçï');
            return;
        }
        
        // üî• Ê£ÄÊü•ÂèëÂ∏ÉÊó∂Èó¥ÈÄâÊã©
        const publishNow = document.getElementById('publishNow').checked;
        const publishScheduled = document.getElementById('publishScheduled').checked;
        
        let scheduledTime = null;
        let confirmMessage = `üìã Á°ÆËÆ§Á≠æÂà∞‰ø°ÊÅØÔºö\n\nËØæÁ®ãÔºö${courseName}\nËäÇÊ¨°Ôºö${courseSession}\nÁè≠Á∫ßÔºö${selectedClasses.join('„ÄÅ')}\n‰∫∫Êï∞Ôºö${selectedStudents.length}‰∫∫\nÊó∂ÈïøÔºö${duration}ÂàÜÈíü\n`;
        
        if (publishScheduled) {
            // ÂÆöÊó∂ÂèëÂ∏É
            const dateTimeInput = document.getElementById('publishDateTime').value;
            if (!dateTimeInput) {
                alert('‚ùå ËØ∑ÈÄâÊã©ÂèëÂ∏ÉÊó∂Èó¥');
                return;
            }
            
            scheduledTime = new Date(dateTimeInput);
            const now = new Date();
            
            if (scheduledTime <= now) {
                alert('‚ùå ÂèëÂ∏ÉÊó∂Èó¥ÂøÖÈ°ªÊôö‰∫éÂΩìÂâçÊó∂Èó¥');
                return;
            }
            
            const diffMinutes = Math.round((scheduledTime - now) / 60000);
            confirmMessage += `\n‚è∞ ÂèëÂ∏ÉÊñπÂºèÔºöÂÆöÊó∂ÂèëÂ∏É\nüìÖ ÂèëÂ∏ÉÊó∂Èó¥Ôºö${scheduledTime.toLocaleString('zh-CN')}\n‚è±Ô∏è  Ë∑ùÁ¶ªÂèëÂ∏ÉÔºö${diffMinutes} ÂàÜÈíü\n\nÁ≠æÂà∞‰ªªÂä°Â∞ÜÂú®ÊåáÂÆöÊó∂Èó¥Ëá™Âä®ÂºÄÂßãÔºÅ`;
        } else {
            // Á´ãÂç≥ÂèëÂ∏É
            confirmMessage += `\n‚è∞ ÂèëÂ∏ÉÊñπÂºèÔºöÁ´ãÂç≥ÂèëÂ∏É\n\nÁ°ÆÂÆöÁ´ãÂç≥ÂºÄÂßãÁ≠æÂà∞ÂêóÔºü`;
        }
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        console.log('üíæ ÂàõÂª∫Á≠æÂà∞‰ºöËØù...');
        
        // ÂàõÂª∫Á≠æÂà∞‰ºöËØù
        const CheckInSession = AV.Object.extend('CheckInSession');
        const session = new CheckInSession();
        
        session.set('courseName', courseName);
        session.set('courseSession', courseSession);
        session.set('className', selectedClasses.join('„ÄÅ'));
        session.set('classNames', selectedClasses);
        session.set('duration', duration);
        session.set('totalStudents', selectedStudents.length);
        session.set('checkedInCount', 0);
        
        const studentData = selectedStudents.map(s => ({
            className: s.className,
            studentId: s.studentId,
            name: s.name
        }));
        session.set('students', studentData);
        
        if (publishScheduled && scheduledTime) {
            // üî• ÂÆöÊó∂ÂèëÂ∏ÉÔºöËÆæÁΩÆ‰∏∫ scheduled Áä∂ÊÄÅ
            session.set('status', 'scheduled');
            session.set('scheduledTime', scheduledTime);
            session.set('startTime', scheduledTime); // Á≠æÂà∞ÂºÄÂßãÊó∂Èó¥‰∏∫ÂÆöÊó∂Êó∂Èó¥
        } else {
            // Á´ãÂç≥ÂèëÂ∏ÉÔºöËÆæÁΩÆ‰∏∫ active Áä∂ÊÄÅ
            session.set('status', 'active');
            session.set('startTime', new Date());
        }
        
        await session.save();
        console.log('‚úÖ Á≠æÂà∞‰ºöËØùÂ∑≤‰øùÂ≠òÔºåID:', session.id);
        
        if (publishScheduled && scheduledTime) {
            // üî• ÂÆöÊó∂ÂèëÂ∏ÉÔºöÊòæÁ§∫ÂÄíËÆ°Êó∂Á≠âÂæÖÁïåÈù¢
            showScheduledTaskUI(session.id, scheduledTime, courseName, courseSession, selectedClasses, selectedStudents.length, duration);
            
            alert(`‚úÖ Á≠æÂà∞‰ªªÂä°Â∑≤ÂàõÂª∫ÔºÅ\n\nüìö ËØæÁ®ãÔºö${courseName}\nüìñ ËäÇÊ¨°Ôºö${courseSession}\nüë• Áè≠Á∫ßÔºö${selectedClasses.join('„ÄÅ')}\nüéØ ‰∫∫Êï∞Ôºö${selectedStudents.length}‰∫∫\n‚è±Ô∏è  Êó∂ÈïøÔºö${duration}ÂàÜÈíü\n\n‚è∞ Â∞ÜÂú® ${scheduledTime.toLocaleString('zh-CN')} Ëá™Âä®ÂºÄÂßãÔºÅ`);
        } else {
            // Á´ãÂç≥ÂèëÂ∏ÉÔºöÁõ¥Êé•ÂêØÂä®Á≠æÂà∞
            currentCheckInSession = {
                id: session.id,
                courseName: courseName,
                courseSession: courseSession,
                classNames: selectedClasses,
                className: selectedClasses.join('„ÄÅ'),
                duration: duration,
                startTime: new Date(),
                students: studentData
            };
            
            checkedInStudents = [];
            previousUncheckedCount = selectedStudents.length;
            
            // ÊòæÁ§∫Á≠æÂà∞ÁïåÈù¢
            document.getElementById('checkInStatus').classList.remove('hidden');
            
            // Êõ¥Êñ∞ËØæÁ®ã‰ø°ÊÅØ
            const currentCourse = document.getElementById('currentCourse');
            const currentClass = document.getElementById('currentClass');
            if (currentCourse) currentCourse.textContent = `${courseName} - ${courseSession}`;
            if (currentClass) currentClass.textContent = selectedClasses.join('„ÄÅ');
            
            // ÂàùÂßãÂåñÂäüËÉΩ
            updateWordCloud();
            updateProgress();
            updateCheckedInList();
            updateUncheckedList();
            startPolling();
            setupCountdown(duration);
            
            alert(`‚úÖ Á≠æÂà∞Â∑≤ÂºÄÂßãÔºÅ\n\nüìö ËØæÁ®ãÔºö${courseName}\nüìñ ËäÇÊ¨°Ôºö${courseSession}\nüë• Áè≠Á∫ßÔºö${selectedClasses.join('„ÄÅ')}\nüéØ ‰∫∫Êï∞Ôºö${selectedStudents.length}‰∫∫\n‚è±Ô∏è  Êó∂ÈïøÔºö${duration}ÂàÜÈíü\n\nÂ≠¶ÁîüÁé∞Âú®ÂèØ‰ª•ÂºÄÂßãÁ≠æÂà∞‰∫ÜÔºÅ`);
        }
        
        // Ê∏ÖÁ©∫Ë°®Âçï
        document.getElementById('courseName').value = '';
        document.getElementById('courseSession').value = '';
        document.getElementById('checkInDuration').value = '10';
        document.getElementById('customClassInput').value = '';
        
        const checkboxes = document.querySelectorAll('#selectClass input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        const tagsContainer = document.getElementById('selectedClassesTags');
        if (tagsContainer) {
            tagsContainer.innerHTML = '';
            tagsContainer.classList.add('hidden');
        }
        
        updateClassCount();
        
        // ÈáçÁΩÆÂèëÂ∏ÉÊó∂Èó¥ÈÄâÊã©
        document.getElementById('publishNow').checked = true;
        togglePublishTimeInput();
        
    } catch (error) {
        console.error('‚ùå ÂèëÂ∏ÉÁ≠æÂà∞Â§±Ë¥•:', error);
        alert('ÂèëÂ∏ÉÁ≠æÂà∞Â§±Ë¥•Ôºö' + error.message);
    }
}

// ==================== ÊòæÁ§∫ÂÆöÊó∂‰ªªÂä°Á≠âÂæÖÁïåÈù¢ ====================
let scheduledCheckInterval = null;

function showScheduledTaskUI(sessionId, scheduledTime, courseName, courseSession, classNames, studentCount, duration) {
    // ÊòæÁ§∫ÂÆöÊó∂‰ªªÂä°Èù¢Êùø
    const checkInStatus = document.getElementById('checkInStatus');
    checkInStatus.classList.remove('hidden');
    
    // ÂàõÂª∫ÂÆöÊó∂‰ªªÂä°UI
    const currentCourse = document.getElementById('currentCourse');
    const currentClass = document.getElementById('currentClass');
    const countdown = document.getElementById('countdown');
    
    if (currentCourse) currentCourse.textContent = `${courseName} - ${courseSession} „ÄêÂÆöÊó∂‰ªªÂä°„Äë`;
    if (currentClass) currentClass.textContent = classNames.join('„ÄÅ');
    
    // ÈöêËóèÂÖ∂‰ªñÈù¢Êùø
    const wordCloudContainer = document.getElementById('wordCloudContainer');
    if (wordCloudContainer) {
        wordCloudContainer.innerHTML = `
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <div class="text-8xl mb-4 animate-bounce">‚è∞</div>
                    <h2 class="text-3xl font-bold text-blue-600 mb-3">ÂÆöÊó∂Á≠æÂà∞Â∑≤ËÆæÁΩÆ</h2>
                    <p class="text-xl text-gray-700 mb-4">
                        Â∞ÜÂú® <span class="font-bold text-blue-600" id="scheduledTimeDisplay">${scheduledTime.toLocaleString('zh-CN')}</span> ÂºÄÂßã
                    </p>
                    <div class="text-6xl font-bold text-green-600" id="scheduledCountdown">--:--:--</div>
                    <p class="text-sm text-gray-500 mt-4">Á≠æÂà∞Â∞ÜËá™Âä®ÂºÄÂßãÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ</p>
                </div>
            </div>
        `;
    }
    
    // ÂêØÂä®ÂÄíËÆ°Êó∂
    updateScheduledCountdown(scheduledTime, sessionId);
    scheduledCheckInterval = setInterval(() => {
        updateScheduledCountdown(scheduledTime, sessionId);
    }, 1000);
}

function updateScheduledCountdown(scheduledTime, sessionId) {
    const now = new Date();
    const diff = scheduledTime - now;
    
    const countdownElement = document.getElementById('scheduledCountdown');
    const mainCountdown = document.getElementById('countdown');
    
    if (diff <= 0) {
        // Êó∂Èó¥Âà∞ÔºåÂêØÂä®Á≠æÂà∞
        clearInterval(scheduledCheckInterval);
        scheduledCheckInterval = null;
        
        if (countdownElement) {
            countdownElement.textContent = 'üöÄ Ê≠£Âú®ÂêØÂä®...';
        }
        
        // ÊøÄÊ¥ªÁ≠æÂà∞‰ºöËØù
        activateScheduledSession(sessionId);
        return;
    }
    
    // ËÆ°ÁÆóÊó∂ÂàÜÁßí
    const hours = Math.floor(diff / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    
    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (countdownElement) {
        countdownElement.textContent = timeString;
    }
    
    if (mainCountdown) {
        mainCountdown.textContent = `‚è∞ Ë∑ùÁ¶ªÂºÄÂßãÔºö${timeString}`;
        mainCountdown.className = 'text-lg font-bold text-blue-600';
    }
}

// ==================== ÊøÄÊ¥ªÂÆöÊó∂Á≠æÂà∞‰ºöËØù ====================
async function activateScheduledSession(sessionId) {
    try {
        console.log('üöÄ ÊøÄÊ¥ªÂÆöÊó∂Á≠æÂà∞‰ºöËØù:', sessionId);
        
        // Êõ¥Êñ∞‰ºöËØùÁä∂ÊÄÅ‰∏∫ active
        const query = new AV.Query('CheckInSession');
        const session = await query.get(sessionId);
        
        session.set('status', 'active');
        session.set('startTime', new Date()); // Êõ¥Êñ∞ÂÆûÈôÖÂºÄÂßãÊó∂Èó¥
        await session.save();
        
        console.log('‚úÖ ‰ºöËØùÂ∑≤ÊøÄÊ¥ª');
        
        // ÈáçÊñ∞Âä†ËΩΩ‰ºöËØùÔºà‰ΩøÁî®Áé∞ÊúâÁöÑ checkActiveSession ÂáΩÊï∞Ôºâ
        await checkActiveSession();
        
        alert('üéâ Á≠æÂà∞Â∑≤Ëá™Âä®ÂºÄÂßãÔºÅ\n\nÂ≠¶ÁîüÁé∞Âú®ÂèØ‰ª•ÂºÄÂßãÁ≠æÂà∞‰∫Ü„ÄÇ');
        
    } catch (error) {
        console.error('‚ùå ÊøÄÊ¥ªÂÆöÊó∂‰ºöËØùÂ§±Ë¥•:', error);
        alert('ÊøÄÊ¥ªÂÆöÊó∂Á≠æÂà∞Â§±Ë¥•Ôºö' + error.message);
    }
}

        // ==================== Ëá™Âä®Âà∑Êñ∞ÊéßÂà∂ ====================
        let pollingInterval = null;

        function startPolling() {
            // Ê∏ÖÈô§‰πãÂâçÁöÑËΩÆËØ¢
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            // ÊØè3ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
            pollingInterval = setInterval(() => {
                if (currentCheckInSession && currentCheckInSession.id) {
                    refreshCheckInData();
                } else {
                    console.warn('‚ö†Ô∏è Ê≤°ÊúâÊ¥ªÂä®‰ºöËØùÔºåÂÅúÊ≠¢ËΩÆËØ¢');
                    stopPolling();
                }
            }, 3000);

            console.log('üîÑ Ëá™Âä®Âà∑Êñ∞Â∑≤ÂêØÂä®ÔºàÊØè3ÁßíÔºâ');
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('üõë Ëá™Âä®Âà∑Êñ∞Â∑≤ÂÅúÊ≠¢');
            }
        }

// ==================== ÂàùÂßãÂåñÁè≠Á∫ß‰∏ãÊãâÂàóË°® ====================
function initClassSelect() {
    console.log('üîÑ ÂàùÂßãÂåñÂ≠¶ÁîüË°®ÂçïÁè≠Á∫ß‰∏ãÊãâÂàóË°®...');
    
    const classDatalist = document.getElementById('classDatalist');
    if (!classDatalist) {
        console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞Áè≠Á∫ßÂàóË°®ÂÖÉÁ¥† #classDatalist');
        return;
    }
    
    // üî• Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
    classDatalist.innerHTML = '';
    
    // üî• Ê∑ªÂä†Âõ∫ÂÆöÁè≠Á∫ßÈÄâÈ°πÂà∞ datalist
    FIXED_CLASSES.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        classDatalist.appendChild(option);
    });
    
    console.log(`‚úÖ Â∑≤Âä†ËΩΩ ${FIXED_CLASSES.length} ‰∏™Áè≠Á∫ßÂà∞Â≠¶ÁîüË°®ÂçïÔºàÊîØÊåÅÊâãÂä®ËæìÂÖ•Ôºâ`);
}


        // Refresh check-in data - Âà∑Êñ∞Á≠æÂà∞Êï∞ÊçÆ
        // ==================== Âà∑Êñ∞Á≠æÂà∞Êï∞ÊçÆÔºàÂ∏¶‰ºöËØùÊ£ÄÊü•Ôºâ====================
        async function refreshCheckInData() {
            try {
                console.log('üîÑ ÂºÄÂßãÂà∑Êñ∞Êï∞ÊçÆ...');

                // ========== Á¨¨‰∏ÄÊ≠•ÔºöÊ£ÄÊü•‰∫ëÁ´ØÊòØÂê¶ÊúâÊ¥ªÂä®‰ºöËØù ==========
                console.log('üîç Ê£ÄÊü•‰∫ëÁ´ØÊ¥ªÂä®‰ºöËØù...');
                const query = new AV.Query('CheckInSession');
                query.equalTo('status', 'active');
                query.descending('createdAt');
                query.limit(1);
                
                const activeSession = await query.first();

                // Â¶ÇÊûú‰∫ëÁ´ØÊ≤°ÊúâÊ¥ªÂä®‰ºöËØù
                if (!activeSession) {
                    console.log('‚ö†Ô∏è ‰∫ëÁ´ØÊ≤°ÊúâÊ¥ªÂä®ÁöÑÁ≠æÂà∞‰ºöËØù');
                    
                    // Ê∏ÖÁ©∫Êú¨Âú∞‰ºöËØù
                    currentCheckInSession = null;
                    checkedInStudents = [];
                    previousUncheckedCount = 0;
                    
                    // ÂÅúÊ≠¢ËΩÆËØ¢
                    if (typeof stopPolling === 'function') {
                        stopPolling();
                    }
                    
                    // ÂÅúÊ≠¢ÂÄíËÆ°Êó∂
                    if (typeof countdownInterval !== 'undefined' && countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                    
                    // Ê∏ÖÁêÜËØç‰∫ë
                    if (typeof wordCloudChart !== 'undefined' && wordCloudChart) {
                        try {
                            wordCloudChart.dispose();
                            wordCloudChart = null;
                        } catch (err) {
                            console.warn('‚ö†Ô∏è Ê∏ÖÁêÜËØç‰∫ëÂ§±Ë¥•:', err);
                        }
                    }
                    
                    // ÂàùÂßãÂåñÈ°µÈù¢ÔºöÈöêËóèÁ≠æÂà∞Èù¢ÊùøÔºåÊòæÁ§∫ËÆæÁΩÆÈù¢Êùø
                    const setupPanel = document.getElementById('setupPanel');
                    const checkInStatus = document.getElementById('checkInStatus');
                    
                    if (checkInStatus) {
                        checkInStatus.classList.add('hidden');
                        console.log('‚úÖ Â∑≤ÈöêËóèÁ≠æÂà∞Áä∂ÊÄÅÈù¢Êùø');
                    }
                    
                    if (setupPanel) {
                        setupPanel.classList.remove('hidden');
                        console.log('‚úÖ Â∑≤ÊòæÁ§∫ËÆæÁΩÆÈù¢Êùø');
                    }
                    
                    // ÊèêÁ§∫Áî®Êà∑
                    alert('‚ÑπÔ∏è ÂΩìÂâçÊ≤°ÊúâËøõË°å‰∏≠ÁöÑÁ≠æÂà∞‰ºöËØù\n\nÈ°µÈù¢Â∑≤ÂàùÂßãÂåñÔºåÂèØ‰ª•ÂºÄÂßãÊñ∞ÁöÑÁ≠æÂà∞„ÄÇ');
                    console.log('‚úÖ È°µÈù¢Â∑≤ÂàùÂßãÂåñ');
                    return;
                }

                // ========== Á¨¨‰∫åÊ≠•Ôºö‰∫ëÁ´ØÊúâÊ¥ªÂä®‰ºöËØù ==========
                console.log('‚úÖ ÊâæÂà∞Ê¥ªÂä®‰ºöËØù:', activeSession.id);

                // Ê£ÄÊü•Êú¨Âú∞‰ºöËØùÊòØÂê¶‰∏é‰∫ëÁ´Ø‰∏ÄËá¥
                if (currentCheckInSession && currentCheckInSession.id !== activeSession.id) {
                    console.warn('‚ö†Ô∏è Êú¨Âú∞‰ºöËØù‰∏é‰∫ëÁ´Ø‰∏ç‰∏ÄËá¥ÔºåÈáçÊñ∞Âä†ËΩΩ...');
                    
                    // ÈáçÊñ∞Âä†ËΩΩ‰ºöËØùÔºàË∞ÉÁî® checkActiveSessionÔºâ
                    if (typeof checkActiveSession === 'function') {
                        await checkActiveSession();
                        console.log('‚úÖ Â∑≤ÈáçÊñ∞Âä†ËΩΩ‰ºöËØù');
                        return;
                    }
                }

                // Â¶ÇÊûúÊú¨Âú∞Ê≤°Êúâ‰ºöËØùÔºåÂä†ËΩΩ‰∫ëÁ´Ø‰ºöËØù
                if (!currentCheckInSession || !currentCheckInSession.id) {
                    console.log('‚ö†Ô∏è Êú¨Âú∞Ê≤°Êúâ‰ºöËØùÔºåÂä†ËΩΩ‰∫ëÁ´Ø‰ºöËØù...');
                    
                    if (typeof checkActiveSession === 'function') {
                        await checkActiveSession();
                        console.log('‚úÖ Â∑≤Âä†ËΩΩ‰∫ëÁ´Ø‰ºöËØù');
                        return;
                    }
                }

                // ========== Á¨¨‰∏âÊ≠•ÔºöÂà∑Êñ∞Á≠æÂà∞ËÆ∞ÂΩï ==========
                console.log('üîÑ Âà∑Êñ∞Á≠æÂà∞ËÆ∞ÂΩï...');
                
                // ËÆ∞ÂΩïÂà∑Êñ∞ÂâçÁöÑ‰∫∫Êï∞
                const previousCount = checkedInStudents.length;

                // Êü•ËØ¢Á≠æÂà∞ËÆ∞ÂΩï
                const recordQuery = new AV.Query('CheckInRecord');
                recordQuery.equalTo('sessionId', currentCheckInSession.id);
                recordQuery.descending('checkInTime');
                recordQuery.limit(1000);
                
                const records = await recordQuery.find();
                console.log(`‚úÖ Êü•ËØ¢Âà∞ ${records.length} Êù°Á≠æÂà∞ËÆ∞ÂΩï`);

                // ËΩ¨Êç¢‰∏∫ÊôÆÈÄöÂØπË±°Êï∞ÁªÑ
                checkedInStudents = records.map(obj => ({
                    className: obj.get('className'),
                    studentId: obj.get('studentId'),
                    name: obj.get('studentName'),
                    location: obj.get('location'),
                    checkInTime: obj.get('checkInTime')
                }));

                const newCount = checkedInStudents.length;
                const newCheckedIn = newCount - previousCount;

                if (newCheckedIn > 0) {
                    console.log(`‚úÖ Êñ∞Â¢û ${newCheckedIn} ‰∫∫Á≠æÂà∞ÔºåÊÄªËÆ° ${newCount} ‰∫∫`);
                }

                // ========== Á¨¨ÂõõÊ≠•ÔºöÊõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫ ==========
                console.log('üé® Êõ¥Êñ∞ÊòæÁ§∫ÁïåÈù¢...');
                
                // 1. Êõ¥Êñ∞ËØç‰∫ë
                try {
                    if (typeof updateWordCloud === 'function') {
                        updateWordCloud();
                        console.log('‚úÖ ËØç‰∫ëÂ∑≤Êõ¥Êñ∞');
                    }
                } catch (err) {
                    console.error('‚ùå ËØç‰∫ëÊõ¥Êñ∞Â§±Ë¥•:', err);
                }

                // 2. Êõ¥Êñ∞ËøõÂ∫¶Êù°
                try {
                    if (typeof updateProgress === 'function') {
                        updateProgress();
                        console.log('‚úÖ ËøõÂ∫¶Â∑≤Êõ¥Êñ∞');
                    }
                } catch (err) {
                    console.error('‚ùå ËøõÂ∫¶Êõ¥Êñ∞Â§±Ë¥•:', err);
                }

                // 3. Êõ¥Êñ∞Â∑≤Á≠æÂà∞ÂàóË°®
                try {
                    if (typeof updateCheckedInList === 'function') {
                        updateCheckedInList();
                        console.log('‚úÖ Â∑≤Á≠æÂà∞ÂàóË°®Â∑≤Êõ¥Êñ∞');
                    }
                } catch (err) {
                    console.error('‚ùå Â∑≤Á≠æÂà∞ÂàóË°®Êõ¥Êñ∞Â§±Ë¥•:', err);
                }

                // 4. Êõ¥Êñ∞Êú™Á≠æÂà∞ÂàóË°®
                try {
                    if (typeof updateUncheckedList === 'function') {
                        updateUncheckedList();
                        console.log('‚úÖ Êú™Á≠æÂà∞ÂàóË°®Â∑≤Êõ¥Êñ∞');
                    }
                } catch (err) {
                    console.error('‚ùå Êú™Á≠æÂà∞ÂàóË°®Êõ¥Êñ∞Â§±Ë¥•:', err);
                }

                // ========== Á¨¨‰∫îÊ≠•ÔºöÊõ¥Êñ∞‰∫ëÁ´Ø‰ºöËØùÊï∞ÊçÆ ==========
                try {
                    const sessionQuery = new AV.Query('CheckInSession');
                    const session = await sessionQuery.get(currentCheckInSession.id);
                    session.set('checkedInCount', newCount);
                    await session.save();
                    console.log('‚úÖ ‰∫ëÁ´Ø‰ºöËØùÊï∞ÊçÆÂ∑≤Êõ¥Êñ∞');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Êõ¥Êñ∞‰∫ëÁ´Ø‰ºöËØùÂ§±Ë¥•:', error);
                }

                // ========== ÂÆåÊàê ==========
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('‚úÖ Êï∞ÊçÆÂà∑Êñ∞ÂÆåÊàê');
                console.log(`üìä Á≠æÂà∞ÊÉÖÂÜµ: ${newCount}/${currentCheckInSession.students.length} ‰∫∫Â∑≤Á≠æÂà∞`);
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                // ÊòæÁ§∫Âà∑Êñ∞ÊàêÂäüÊèêÁ§∫ÔºàÁü≠ÊöÇÊèêÁ§∫Ôºå‰∏çÊâìÊñ≠Áî®Êà∑Ôºâ
                showNotification(
                    'üîÑ Êï∞ÊçÆÂ∑≤Âà∑Êñ∞',
                    `Â∑≤Á≠æÂà∞ ${newCount}/${currentCheckInSession.students.length} ‰∫∫`
                );

            } catch (error) {
                console.error('‚ùå Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•:', error);
                
                // ËØ¶ÁªÜÁöÑÈîôËØØÊèêÁ§∫
                let errorMessage = 'Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•Ôºö\n\n';
                if (error.code === 101) {
                    errorMessage += '‚ùå Á≠æÂà∞‰ºöËØù‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Âà†Èô§';
                } else if (error.code === 403) {
                    errorMessage += '‚ùå ÊùÉÈôê‰∏çË∂≥ÔºåÊó†Ê≥ïËÆøÈóÆÊï∞ÊçÆ';
                } else if (error.code === 1) {
                    errorMessage += '‚ùå ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú';
                } else {
                    errorMessage += `‚ùå ${error.message || 'Êú™Áü•ÈîôËØØ'}`;
                }
                
                alert(errorMessage);
            }
        }

        // ==================== Êõ¥Êñ∞Â∑≤Á≠æÂà∞ÂàóË°® ====================
        function updateCheckedInList() {
            const container = document.getElementById('checkedInList');
            if (!container) {
                console.warn('‚ö†Ô∏è Êâæ‰∏çÂà∞Â∑≤Á≠æÂà∞ÂàóË°®ÂÆπÂô® (id="checkedInList")');
                return;
            }

            if (!currentCheckInSession || checkedInStudents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">üìù</p>
                        <p class="text-sm">ÊöÇÊó†Á≠æÂà∞ËÆ∞ÂΩï</p>
                    </div>
                `;
                return;
            }

            // ÊåâÁ≠æÂà∞Êó∂Èó¥ÈôçÂ∫èÊéíÂàóÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢Ôºâ
            const sorted = [...checkedInStudents].sort((a, b) => 
                new Date(b.checkInTime) - new Date(a.checkInTime)
            );

            let html = '<div class="space-y-2">';
            
            sorted.forEach((student, index) => {
                const checkInTime = new Date(student.checkInTime);
                const timeStr = checkInTime.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                ${index + 1}
                            </span>
                            <div>
                                <p class="font-bold text-gray-800">${student.name}</p>
                                <p class="text-xs text-gray-600">
                                    ${student.className} | ${student.studentId}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">Á≠æÂà∞Êó∂Èó¥</p>
                            <p class="text-sm font-bold text-green-600">${timeStr}</p>
                            ${student.location ? `<p class="text-xs text-gray-400 mt-1">üìç ${student.location}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            console.log(`‚úÖ Â∑≤Á≠æÂà∞ÂàóË°®Â∑≤Êõ¥Êñ∞ÔºåÊòæÁ§∫ ${sorted.length} ‰∫∫`);
        }


        // ==================== Êõ¥Êñ∞Êú™Á≠æÂà∞ÂàóË°® ====================
        function updateUncheckedList() {
            const container = document.getElementById('uncheckedList');
            if (!container) {
                console.warn('‚ö†Ô∏è Êâæ‰∏çÂà∞Êú™Á≠æÂà∞ÂàóË°®ÂÆπÂô® (id="uncheckedList")');
                return;
            }

            if (!currentCheckInSession || !currentCheckInSession.students) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-4xl mb-2">üë•</p>
                        <p class="text-sm">ÊöÇÊó†Â≠¶Áîü‰ø°ÊÅØ</p>
                    </div>
                `;
                return;
            }

            // Ëé∑ÂèñÊú™Á≠æÂà∞ÁöÑÂ≠¶Áîü
            const checkedInIds = new Set(checkedInStudents.map(s => s.studentId));
            const uncheckedStudents = currentCheckInSession.students.filter(s => 
                !checkedInIds.has(s.studentId)
            );

            if (uncheckedStudents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-green-500">
                        <p class="text-6xl mb-3">üéâ</p>
                        <p class="text-lg font-bold">ÂÖ®ÂëòÂ∑≤Á≠æÂà∞ÔºÅ</p>
                        <p class="text-sm mt-2">Âá∫Âã§Áéá 100%</p>
                    </div>
                `;
                return;
            }

            // ÊåâÂßìÂêçÊéíÂ∫è
            const sorted = [...uncheckedStudents].sort((a, b) => 
                a.name.localeCompare(b.name, 'zh-CN')
            );

            let html = '<div class="space-y-2">';
            
            sorted.forEach((student, index) => {
                html += `
                    <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                ${index + 1}
                            </span>
                            <div>
                                <p class="font-bold text-gray-800">${student.name}</p>
                                <p class="text-xs text-gray-600">
                                    ${student.className} | ${student.studentId}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">
                                Êú™Á≠æÂà∞
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            console.log(`‚úÖ Êú™Á≠æÂà∞ÂàóË°®Â∑≤Êõ¥Êñ∞ÔºåÊòæÁ§∫ ${sorted.length} ‰∫∫`);
        }




        // ==================== ÂÄíËÆ°Êó∂ËØç‰∫ëÊ®°ÂùóÔºàÂÆåÊï¥ÁâàÔºâ====================
        
        let wordCloudChart = null; // EChartsÂÆû‰æã
        let previousUncheckedCount = 0; // Áî®‰∫éÊ£ÄÊµãÂèòÂåñ

        function updateWordCloud() {
            const container = document.getElementById('wordCloudContainer');
            
            if (!container) {
                console.warn('‚ö†Ô∏è ËØç‰∫ëÂÆπÂô®‰∏çÂ≠òÂú®');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÁ≠æÂà∞‰ºöËØù
            if (!currentCheckInSession || !currentCheckInSession.students) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <p class="text-6xl mb-4">üìä</p>
                            <p class="text-lg font-semibold">Êú™ÂºÄÂßãÁ≠æÂà∞</p>
                            <p class="text-sm mt-2">ÂèëÂ∏ÉÁ≠æÂà∞ÂêéÂ∞ÜÊòæÁ§∫ÂæÖÁ≠æÂà∞Â≠¶Áîü</p>
                        </div>
                    </div>
                `;
                
                // ÈáçÁΩÆËøõÂ∫¶ÊòæÁ§∫
                updateProgressBar(0, 0, 0);
                return;
            }

            // Ëé∑ÂèñÊâÄÊúâÂ∫îÁ≠æÂà∞ÁöÑÂ≠¶Áîü
            const allStudents = currentCheckInSession.students || [];
            
            // Ëé∑ÂèñÂ∑≤Á≠æÂà∞ÁöÑÂ≠¶ÁîüIDÂàóË°®
            const checkedInIds = new Set(checkedInStudents.map(s => s.studentId));
            
            // ËøáÊª§Âá∫Êú™Á≠æÂà∞ÁöÑÂ≠¶Áîü
            const uncheckedStudents = allStudents.filter(s => !checkedInIds.has(s.studentId));

            const totalCount = allStudents.length;
            const checkedCount = checkedInStudents.length;
            const uncheckedCount = uncheckedStudents.length;

            console.log(`üìä ËØç‰∫ëÊõ¥Êñ∞: Â∫îÂà∞${totalCount}‰∫∫, Â∑≤Âà∞${checkedCount}‰∫∫, Êú™Âà∞${uncheckedCount}‰∫∫`);

            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            updateProgressBar(totalCount, checkedCount, uncheckedCount);

            // Â¶ÇÊûúÂÖ®ÈÉ®Á≠æÂà∞ÂÆåÊàê
            if (uncheckedCount === 0 && totalCount > 0) {
                showCompletionAnimation(container);
                return;
            }

            // ËΩ¨Êç¢‰∏∫ËØç‰∫ëÊï∞ÊçÆÊ†ºÂºè
            const wordCloudData = uncheckedStudents.map((student, index) => ({
                name: student.name || 'Êú™Áü•',
                value: 10 + Math.random() * 5, // ÈöèÊú∫ÊùÉÈáçÔºåÂ¢ûÂä†ËßÜËßâÂèòÂåñ
                studentId: student.studentId,
                className: student.className,
                index: index
            }));

            // ÂàùÂßãÂåñÊàñËé∑ÂèñÂõæË°®ÂÆû‰æã
            if (!wordCloudChart) {
                wordCloudChart = echarts.init(container);
                
                // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
                window.addEventListener('resize', function() {
                    if (wordCloudChart) {
                        wordCloudChart.resize();
                    }
                });
            }

            // ËÆ°ÁÆóÈ¢úËâ≤ÔºàÊ†πÊçÆÂâ©‰Ωô‰∫∫Êï∞ÊØî‰æãÔºâ
            const remainingRatio = uncheckedCount / totalCount;
            
            // ÈÖçÁΩÆËØç‰∫ëÈÄâÈ°π
            const option = {
                backgroundColor: {
                    type: 'linear',
                    x: 0, y: 0, x2: 1, y2: 1,
                    colorStops: [
                        { offset: 0, color: '#fff5f5' },
                        { offset: 1, color: '#fee2e2' }
                    ]
                },
                title: {
                    text: `ËøòÊúâ ${uncheckedCount} ‰∫∫Êú™Á≠æÂà∞`,
                    subtext: `ÁÇπÂáªÊü•ÁúãÂ≠¶ÁîüËØ¶ÊÉÖ`,
                    left: 'center',
                    top: 15,
                    textStyle: {
                        fontSize: 20,
                        fontWeight: 'bold',
                        color: remainingRatio > 0.5 ? '#f59e0b' : remainingRatio > 0.2 ? '#ef4444' : '#dc2626'
                    },
                    subtextStyle: {
                        fontSize: 12,
                        color: '#9ca3af'
                    }
                },
                tooltip: {
                    show: true,
                    formatter: function(params) {
                        return `
                            <div style="padding: 8px; min-width: 150px;">
                                <div style="font-size:18px; font-weight:bold; color:#dc2626; margin-bottom:8px; border-bottom: 2px solid #dc2626; padding-bottom:4px;">
                                    ${params.data.name}
                                </div>
                                <div style="color:#666; line-height:1.8;">
                                    <div>üìö Áè≠Á∫ß: <strong>${params.data.className}</strong></div>
                                    <div>üéì Â≠¶Âè∑: <strong>${params.data.studentId}</strong></div>
                                    <div style="margin-top:8px; padding:4px 8px; background:#fee2e2; border-radius:4px; color:#dc2626; font-weight:bold; text-align:center;">
                                        ‚ö†Ô∏è Êú™Á≠æÂà∞
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#dc2626',
                    borderWidth: 2,
                    borderRadius: 8,
                    padding: 0,
                    textStyle: {
                        color: '#333'
                    },
                    extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.15);'
                },
                series: [{
                    type: 'wordCloud',
                    shape: 'circle',
                    
                    // ‰ΩçÁΩÆÂíåÂ§ßÂ∞è
                    left: 'center',
                    top: 'center',
                    width: '90%',
                    height: '75%',
                    
                    // ÊñáÂ≠óÂ§ßÂ∞èËåÉÂõ¥ÔºàÊ†πÊçÆÂâ©‰Ωô‰∫∫Êï∞Âä®ÊÄÅË∞ÉÊï¥Ôºâ
                    sizeRange: uncheckedCount > 20 ? [16, 48] : uncheckedCount > 10 ? [20, 55] : [24, 65],
                    
                    // ÊóãËΩ¨ËßíÂ∫¶
                    rotationRange: [-30, 30],
                    rotationStep: 15,
                    
                    // Èó¥Ë∑ù
                    gridSize: 12,
                    
                    drawOutOfBound: false,
                    
                    // Â∏ÉÂ±ÄÂä®Áîª
                    layoutAnimation: true,
                    animationDuration: 1000,
                    animationEasing: 'cubicOut',
                    animationDelay: function(idx) {
                        return idx * 30;
                    },
                    
                    // ÊñáÂ≠óÊ†∑Âºè
                    textStyle: {
                        fontFamily: 'Microsoft YaHei, PingFang SC, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif',
                        fontWeight: 'bold',
                        color: function() {
                            // Ê†πÊçÆÂâ©‰ΩôÊØî‰æãÈÄâÊã©È¢úËâ≤ÊñπÊ°à
                            let colors;
                            if (remainingRatio > 0.5) {
                                // Ââ©‰ΩôË∂ÖËøá50% - Ê©ôËâ≤Á≥ª
                                colors = ['#f97316', '#fb923c', '#fdba74', '#fed7aa', '#ea580c', '#c2410c'];
                            } else if (remainingRatio > 0.2) {
                                // Ââ©‰Ωô20%-50% - Á∫¢Ê©ôËâ≤Á≥ª
                                colors = ['#ef4444', '#f87171', '#fca5a5', '#fb923c', '#dc2626', '#b91c1c'];
                            } else {
                                // Ââ©‰ΩôÂ∞ë‰∫é20% - Ê∑±Á∫¢Ëâ≤Á≥ª
                                colors = ['#dc2626', '#b91c1c', '#991b1b', '#ef4444', '#7f1d1d', '#450a0a'];
                            }
                            return colors[Math.floor(Math.random() * colors.length)];
                        },
                        shadowBlur: 4,
                        shadowColor: 'rgba(220, 38, 38, 0.3)',
                        shadowOffsetX: 1,
                        shadowOffsetY: 1
                    },
                    
                    // ÊÇ¨ÂÅúÊïàÊûú
                    emphasis: {
                        focus: 'self',
                        textStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(220, 38, 38, 0.8)',
                            color: '#dc2626',
                            fontWeight: 'bolder',
                            textBorderColor: '#fff',
                            textBorderWidth: 2
                        }
                    },
                    
                    data: wordCloudData
                }]
            };

            // ËÆæÁΩÆÈÖçÁΩÆÈ°πÂπ∂Ëß¶ÂèëÂä®Áîª
            wordCloudChart.setOption(option, true);

            // Ê£ÄÊµãÊòØÂê¶ÊúâÂ≠¶ÁîüÁ≠æÂà∞ÔºàËØç‰∫ëÂáèÂ∞ëÔºâ
            if (previousUncheckedCount > uncheckedCount && previousUncheckedCount > 0) {
                const newCheckedCount = previousUncheckedCount - uncheckedCount;
                console.log(`‚úÖ ${newCheckedCount} ÂêçÂ≠¶ÁîüÁ≠æÂà∞`);
                playCheckInSound();
                showCheckInNotification(newCheckedCount, checkedCount);
            }

            previousUncheckedCount = uncheckedCount;

            console.log(`‚úÖ ËØç‰∫ëÂ∑≤Êõ¥Êñ∞ÔºåÊòæÁ§∫ ${uncheckedCount} ‰∏™Êú™Á≠æÂà∞Â≠¶Áîü`);
        }

        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
        function updateProgressBar(total, checked, unchecked) {
            const progress = total > 0 ? Math.round((checked / total) * 100) : 0;
            
            // Êõ¥Êñ∞ÂæÖÁ≠æÂà∞‰∫∫Êï∞Ê†áÁ≠æ
            const countElement = document.getElementById('wordCloudCount');
            if (countElement) {
                countElement.textContent = `ÂæÖÁ≠æÂà∞: ${unchecked} ‰∫∫`;
                // Ê†πÊçÆ‰∫∫Êï∞ÂèòÂåñÈ¢úËâ≤
                if (unchecked === 0) {
                    countElement.className = 'text-sm font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full';
                } else if (unchecked < total * 0.2) {
                    countElement.className = 'text-sm font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full';
                } else {
                    countElement.className = 'text-sm font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full';
                }
            }

            // Êõ¥Êñ∞ËøõÂ∫¶ÁôæÂàÜÊØî
            const progressElement = document.getElementById('wordCloudProgress');
            if (progressElement) {
                progressElement.textContent = `${progress}%`;
            }

            // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂÆΩÂ∫¶
            const progressBar = document.getElementById('wordCloudProgressBar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }

            // Êõ¥Êñ∞ËÆ°Êï∞ÊòæÁ§∫
            const checkedCountElement = document.getElementById('checkedCount');
            const uncheckedCountElement = document.getElementById('uncheckedCount');
            if (checkedCountElement) {
                checkedCountElement.textContent = `Â∑≤Á≠æÂà∞: ${checked}`;
            }
            if (uncheckedCountElement) {
                uncheckedCountElement.textContent = `Êú™Á≠æÂà∞: ${unchecked}`;
            }
        }

        // ÊòæÁ§∫ÂÆåÊàêÂä®Áîª
        function showCompletionAnimation(container) {
            // ÈîÄÊØÅÂõæË°®
            if (wordCloudChart) {
                wordCloudChart.dispose();
                wordCloudChart = null;
            }
            
            const total = currentCheckInSession.students.length;
            
            container.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center animate-scale-in">
                        <div class="text-8xl mb-4 animate-bounce" style="animation-duration: 0.6s;">üéâ</div>
                        <h2 class="text-3xl font-bold text-green-600 mb-3 animate-fade-in">ÂÖ®ÂëòÁ≠æÂà∞ÂÆåÊàêÔºÅ</h2>
                        <p class="text-xl text-gray-700 mb-4 animate-fade-in" style="animation-delay: 0.2s;">
                            Â∑≤Á≠æÂà∞ <span class="font-bold text-green-600">${total}</span> / ${total} ‰∫∫
                        </p>
                        <div class="text-6xl animate-fade-in" style="animation-delay: 0.4s;">‚úÖ</div>
                        <p class="text-sm text-gray-500 mt-4 animate-fade-in" style="animation-delay: 0.6s;">
                            Âá∫Âã§Áéá: <span class="font-bold text-green-600">100%</span>
                        </p>
                    </div>
                </div>
                
                <style>
                    @keyframes scale-in {
                        from {
                            transform: scale(0.5);
                            opacity: 0;
                        }
                        to {
                            transform: scale(1);
                            opacity: 1;
                        }
                    }
                    @keyframes fade-in {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    .animate-scale-in {
                        animation: scale-in 0.5s ease-out;
                    }
                    .animate-fade-in {
                        animation: fade-in 0.5s ease-out forwards;
                        opacity: 0;
                    }
                </style>
            `;
            
            // Êí≠ÊîæÂÆåÊàêÈü≥Êïà
            playCompletionSound();
        }

        // Êí≠ÊîæÁ≠æÂà∞ÊèêÁ§∫Èü≥
        function playCheckInSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
                console.log('üîî Êí≠ÊîæÁ≠æÂà∞ÊèêÁ§∫Èü≥');
            } catch (error) {
                console.warn('‚ö†Ô∏è Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', error);
            }
        }

        // Êí≠ÊîæÂÆåÊàêÈü≥Êïà
        function playCompletionSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Êí≠Êîæ‰∏â‰∏™Èü≥Á¨¶
                const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
                
                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    const startTime = audioContext.currentTime + index * 0.15;
                    gainNode.gain.setValueAtTime(0.2, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.3);
                });
                
                console.log('üéµ Êí≠ÊîæÂÆåÊàêÈü≥Êïà');
            } catch (error) {
                console.warn('‚ö†Ô∏è Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', error);
            }
        }

        // ÊòæÁ§∫Á≠æÂà∞ÈÄöÁü•
        function showCheckInNotification(newCount, totalChecked) {
            // ÁßªÈô§ÊóßÈÄöÁü•
            const oldNotification = document.querySelector('.check-in-notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'check-in-notification fixed top-20 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 transform transition-all duration-300';
            notification.style.animation = 'slideInRight 0.3s ease-out';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-3xl animate-bounce">‚úÖ</span>
                    <div>
                        <p class="font-bold text-lg">Êñ∞Á≠æÂà∞ +${newCount}</p>
                        <p class="text-sm opacity-90">ÊÄªËÆ°: ${totalChecked} ‰∫∫Â∑≤Á≠æÂà∞</p>
                    </div>
                </div>
                
                <style>
                    @keyframes slideInRight {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                </style>
            `;
            
            document.body.appendChild(notification);
            
            // 3ÁßíÂêéÁßªÈô§
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            console.log(`üì¢ ÊòæÁ§∫ÈÄöÁü•: +${newCount} ‰∫∫Á≠æÂà∞`);
        }

        // Update progress - Êõ¥Êñ∞Á≠æÂà∞ËøõÂ∫¶
        function updateProgress() {
            if (!currentCheckInSession || !currentCheckInSession.students) {
                return;
            }

            const total = currentCheckInSession.students.length;
            const checked = checkedInStudents.length;
            const unchecked = total - checked;
            const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;

            console.log(`üìä Êõ¥Êñ∞ËøõÂ∫¶: ${checked}/${total} (${percentage}%)`);

            // Êõ¥Êñ∞ËøõÂ∫¶ÊñáÊú¨
            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = `${checked} / ${total} (${percentage}%)`;
            }

            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progressBarFill = document.getElementById('progressBarFill');
            if (progressBarFill) {
                progressBarFill.style.width = `${percentage}%`;
            }

            // Êõ¥Êñ∞ÁªüËÆ°Êï∞Â≠ó
            const checkedCountElement = document.getElementById('checkedCount');
            if (checkedCountElement) {
                checkedCountElement.textContent = checked;
            }

            const uncheckedCountElement = document.getElementById('uncheckedCount');
            if (uncheckedCountElement) {
                uncheckedCountElement.textContent = unchecked;
            }

            // ‚úÖ ÂêåÊó∂Êõ¥Êñ∞ÂàóË°®ÊòæÁ§∫
            updateCheckedInList();
            updateUncheckedList();
        }

        // ==================== ÁªìÊùüÁ≠æÂà∞ÔºàÂ∏¶ÂÖÉÁ¥†Ê£ÄÊü•Ôºâ====================
        async function endCheckIn() {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ¥ªÂä®‰ºöËØù
            if (!currentCheckInSession || !currentCheckInSession.id) {
                alert('‚ùå Ê≤°ÊúâËøõË°å‰∏≠ÁöÑÁ≠æÂà∞');
                return;
            }

            try {
                const total = currentCheckInSession.students ? currentCheckInSession.students.length : 0;
                const checked = checkedInStudents.length;
                const unchecked = total - checked;
                const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;

                // Á°ÆËÆ§ÁªìÊùü
                if (!confirm(`üîö Á°ÆÂÆöË¶ÅÁªìÊùüÁ≠æÂà∞ÂêóÔºü\n\nÂ∫îÂà∞Ôºö${total}‰∫∫\nÂÆûÂà∞Ôºö${checked}‰∫∫\nÁº∫Âã§Ôºö${unchecked}‰∫∫\nÂá∫Âã§ÁéáÔºö${percentage}%\n\nÁªìÊùüÂêéÂ≠¶ÁîüÂ∞ÜÊó†Ê≥ïÁªßÁª≠Á≠æÂà∞ÔºÅ`)) {
                    console.log('‚ùå Áî®Êà∑ÂèñÊ∂àÁªìÊùüÁ≠æÂà∞');
                    return;
                }

                console.log('üõë ÂºÄÂßãÁªìÊùüÁ≠æÂà∞...');

                // ========== Á¨¨‰∏ÄÊ≠•ÔºöÊúÄÂêéÂà∑Êñ∞‰∏ÄÊ¨°Êï∞ÊçÆ ==========
                console.log('üîÑ ÊúÄÂêéÂà∑Êñ∞Êï∞ÊçÆ...');
                try {
                    if (typeof refreshCheckInData === 'function') {
                        await refreshCheckInData();
                        console.log('‚úÖ Êï∞ÊçÆÂà∑Êñ∞ÂÆåÊàê');
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è ÊúÄÂêéÂà∑Êñ∞Â§±Ë¥•:', err);
                }

                // ÈáçÊñ∞ÁªüËÆ°ÔºàÂà∑Êñ∞ÂêéÂèØËÉΩÊúâÊñ∞ÁöÑÁ≠æÂà∞Ôºâ
                const finalChecked = checkedInStudents.length;
                const finalUnchecked = total - finalChecked;
                const finalPercentage = total > 0 ? Math.round((finalChecked / total) * 100) : 0;

                // ========== Á¨¨‰∫åÊ≠•ÔºöÊõ¥Êñ∞‰∫ëÁ´Ø‰ºöËØùÁä∂ÊÄÅ ==========
                console.log('üíæ Êõ¥Êñ∞‰ºöËØùÁä∂ÊÄÅ...');
                try {
                    const query = new AV.Query('CheckInSession');
                    const session = await query.get(currentCheckInSession.id);

                    session.set('status', 'completed');
                    session.set('endTime', new Date());
                    session.set('checkedInCount', finalChecked);
                    session.set('absentCount', finalUnchecked);

                    // ‰øùÂ≠òÂÆåÊï¥Á≠æÂà∞ÁªìÊûú
                    const results = currentCheckInSession.students.map(student => {
                        const checkedIn = checkedInStudents.find(c => c.studentId === student.studentId);
                        return {
                            studentId: student.studentId,
                            name: student.name,
                            className: student.className,
                            status: checkedIn ? 'present' : 'absent',
                            checkInTime: checkedIn ? checkedIn.checkInTime : null,
                            location: checkedIn ? checkedIn.location : null
                        };
                    });
                    session.set('results', results);

                    await session.save();
                    console.log('‚úÖ ‰ºöËØùÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫ completed');

                } catch (error) {
                    console.error('‚ùå Êõ¥Êñ∞‰ºöËØùÂ§±Ë¥•:', error);
                    throw new Error('‰øùÂ≠òÁ≠æÂà∞ÁªìÊûúÂ§±Ë¥•Ôºö' + error.message);
                }

                // ========== Á¨¨‰∏âÊ≠•ÔºöÂÅúÊ≠¢ÊâÄÊúâÂÆöÊó∂Âô® ==========
                console.log('üõë ÂÅúÊ≠¢ÂÆöÊó∂Âô®...');
                
                // ÂÅúÊ≠¢ËΩÆËØ¢
                if (typeof stopPolling === 'function') {
                    stopPolling();
                    console.log('‚úÖ Ëá™Âä®Âà∑Êñ∞Â∑≤ÂÅúÊ≠¢');
                } else if (typeof pollingInterval !== 'undefined' && pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.log('‚úÖ ËΩÆËØ¢Â∑≤ÂÅúÊ≠¢');
                }

                // ÂÅúÊ≠¢ÂÄíËÆ°Êó∂
                if (typeof countdownInterval !== 'undefined' && countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    console.log('‚úÖ ÂÄíËÆ°Êó∂Â∑≤ÂÅúÊ≠¢');
                }

                // ========== Á¨¨ÂõõÊ≠•ÔºöÊòæÁ§∫ÂÆåÊàêÂä®ÁîªÔºàÂèØÈÄâÔºâ==========
                if (finalUnchecked === 0 && total > 0) {
                    console.log('üéâ ÂÖ®ÂëòÁ≠æÂà∞ÂÆåÊàêÔºÅ');
                    try {
                        if (typeof updateWordCloud === 'function') {
                            updateWordCloud();
                        }
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } catch (err) {
                        console.warn('‚ö†Ô∏è ÂÆåÊàêÂä®ÁîªÂ§±Ë¥•:', err);
                    }
                }

                // ========== Á¨¨‰∫îÊ≠•ÔºöÊ∏ÖÁêÜUIÔºàÂ∏¶ÂÖÉÁ¥†Ê£ÄÊü•Ôºâ==========
                console.log('üßπ Ê∏ÖÁêÜUI...');

                // ÈöêËóèÁ≠æÂà∞Áä∂ÊÄÅÈù¢Êùø
                const checkInStatus = document.getElementById('checkInStatus');
                if (checkInStatus) {
                    checkInStatus.classList.add('hidden');
                    console.log('‚úÖ Á≠æÂà∞Áä∂ÊÄÅÈù¢ÊùøÂ∑≤ÈöêËóè');
                } else {
                    console.warn('‚ö†Ô∏è Êâæ‰∏çÂà∞Á≠æÂà∞Áä∂ÊÄÅÈù¢Êùø (id="checkInStatus")');
                }

                // ÊòæÁ§∫ËÆæÁΩÆÈù¢Êùø
                const setupPanel = document.getElementById('setupPanel');
                if (setupPanel) {
                    setupPanel.classList.remove('hidden');
                    console.log('‚úÖ ËÆæÁΩÆÈù¢ÊùøÂ∑≤ÊòæÁ§∫');
                } else {
                    console.warn('‚ö†Ô∏è Êâæ‰∏çÂà∞ËÆæÁΩÆÈù¢Êùø (id="setupPanel")');
                }

                // ========== Á¨¨ÂÖ≠Ê≠•ÔºöÊ∏ÖÁ©∫ÂÖ®Â±ÄÂèòÈáè ==========
                console.log('üßπ Ê∏ÖÁ©∫ÂÖ®Â±ÄÂèòÈáè...');
                currentCheckInSession = null;
                checkedInStudents = [];
                
                if (typeof previousUncheckedCount !== 'undefined') {
                    previousUncheckedCount = 0;
                }

                // ========== Á¨¨‰∏ÉÊ≠•ÔºöÊ∏ÖÁêÜËØç‰∫ë ==========
                console.log('üßπ Ê∏ÖÁêÜËØç‰∫ë...');
                if (typeof wordCloudChart !== 'undefined' && wordCloudChart) {
                    try {
                        wordCloudChart.dispose();
                        wordCloudChart = null;
                        console.log('‚úÖ ËØç‰∫ëÂ∑≤Ê∏ÖÁêÜ');
                    } catch (err) {
                        console.warn('‚ö†Ô∏è Ê∏ÖÁêÜËØç‰∫ëÂ§±Ë¥•:', err);
                    }
                }

                // Ê∏ÖÁ©∫ËØç‰∫ëÂÆπÂô®
                const wordCloudContainer = document.getElementById('wordCloudContainer');
                if (wordCloudContainer) {
                    wordCloudContainer.innerHTML = '';
                    console.log('‚úÖ ËØç‰∫ëÂÆπÂô®Â∑≤Ê∏ÖÁ©∫');
                }

                // ========== Á¨¨ÂÖ´Ê≠•ÔºöÊ∏ÖÁ©∫ÂàóË°®ÊòæÁ§∫ ==========
                console.log('üßπ Ê∏ÖÁ©∫ÂàóË°®...');
                
                const checkedInList = document.getElementById('checkedInList');
                if (checkedInList) {
                    checkedInList.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-4xl mb-2">üìù</p>
                            <p class="text-sm">ÊöÇÊó†Á≠æÂà∞ËÆ∞ÂΩï</p>
                        </div>
                    `;
                }

                const uncheckedList = document.getElementById('uncheckedList');
                if (uncheckedList) {
                    uncheckedList.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-4xl mb-2">üë•</p>
                            <p class="text-sm">ÊöÇÊó†Â≠¶Áîü‰ø°ÊÅØ</p>
                        </div>
                    `;
                }

                // ÈáçÁΩÆËÆ°Êï∞ÊòæÁ§∫
                const checkedCount = document.getElementById('checkedCount');
                if (checkedCount) checkedCount.textContent = '0';

                const uncheckedCount = document.getElementById('uncheckedCount');
                if (uncheckedCount) uncheckedCount.textContent = '0';

                // ÈáçÁΩÆËøõÂ∫¶Êù°
                const progressBarFill = document.getElementById('progressBarFill');
                if (progressBarFill) progressBarFill.style.width = '0%';

                const progressText = document.getElementById('progressText');
                if (progressText) progressText.textContent = '0 / 0 (0%)';

                // ÈáçÁΩÆÂÄíËÆ°Êó∂ÊòæÁ§∫
                const countdown = document.getElementById('countdown');
                if (countdown) {
                    countdown.textContent = '‚è±Ô∏è ÂáÜÂ§á‰∏≠...';
                    countdown.className = 'text-lg font-bold text-green-600';
                }


                // üî• Ê∏ÖÁ©∫Áè≠Á∫ßÈÄâÊã©
                const checkboxes = document.querySelectorAll('#selectClass input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);

                // Ê∏ÖÁ©∫Ëá™ÂÆö‰πâËæìÂÖ•Ê°Ü
                document.getElementById('customClassInput').value = '';

                // Ê∏ÖÁ©∫ÊâÄÊúâÂ∑≤ÈÄâÊ†áÁ≠æ
                const tagsContainer = document.getElementById('selectedClassesTags');
                if (tagsContainer) {
                    tagsContainer.innerHTML = '';
                    tagsContainer.classList.add('hidden');
                }
                updateClassCount();
                updateSelectedClasses();
                // ========== ÂÆåÊàê ==========
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('‚úÖ Á≠æÂà∞Â∑≤ÁªìÊùü');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                // ÊòæÁ§∫ÁªìÊûú
                alert(`‚úÖ Á≠æÂà∞Â∑≤ÁªìÊùüÔºÅ\n\n` +
                    `Â∫îÂà∞Ôºö${total}‰∫∫\n` +
                    `ÂÆûÂà∞Ôºö${finalChecked}‰∫∫\n` +
                    `Áº∫Âã§Ôºö${finalUnchecked}‰∫∫\n` +
                    `Âá∫Âã§ÁéáÔºö${finalPercentage}%\n\n` +
                    `Á≠æÂà∞ÁªìÊûúÂ∑≤‰øùÂ≠òÂà∞‰∫ëÁ´Ø„ÄÇ`);

                // ÊòæÁ§∫ÈÄöÁü•
                if (typeof showNotification === 'function') {
                    showNotification(
                        '‚úÖ Á≠æÂà∞Â∑≤ÁªìÊùü',
                        `Âá∫Âã§Áéá ${finalPercentage}% | ${finalChecked}/${total} ‰∫∫Â∑≤Á≠æÂà∞`
                    );
                }

            } catch (error) {
                console.error('‚ùå ÁªìÊùüÁ≠æÂà∞Â§±Ë¥•:', error);
                
                // ËØ¶ÁªÜÁöÑÈîôËØØÊèêÁ§∫
                let errorMessage = 'ÁªìÊùüÁ≠æÂà∞Â§±Ë¥•Ôºö\n\n';
                if (error.code === 101) {
                    errorMessage += '‚ùå Á≠æÂà∞‰ºöËØù‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Âà†Èô§';
                } else if (error.code === 403) {
                    errorMessage += '‚ùå ÊùÉÈôê‰∏çË∂≥ÔºåÊó†Ê≥ïÊõ¥Êñ∞Êï∞ÊçÆ';
                } else if (error.code === 1) {
                    errorMessage += '‚ùå ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú';
                } else if (error.message) {
                    errorMessage += `‚ùå ${error.message}`;
                } else {
                    errorMessage += '‚ùå Êú™Áü•ÈîôËØØ';
                }
                
                if (error.code) {
                    errorMessage += `\n\nÈîôËØØ‰ª£Á†ÅÔºö${error.code}`;
                }
                
                alert(errorMessage);
            }
        }

        // Export to Excel - Enhanced version  
        async function exportToExcel() {  
            if (!currentCheckInSession || !currentCheckInSession.id) {  
                alert('‚ùå ÂΩìÂâçÊ≤°ÊúâÁ≠æÂà∞‰ªªÂä°');  
                return;  
            }  

            try {  
                // Force refresh data before export  
                await refreshCheckInData();  

                const total = currentCheckInSession.students.length;  
                const checked = checkedInStudents.length;  
                const absent = total - checked;  

                // Main data sheet  
                const data = currentCheckInSession.students.map((s, index) => {  
                    const checkedIn = checkedInStudents.find(c => c.studentId === s.studentId);  
                    return {  
                        'Â∫èÂè∑': index + 1,  
                        'Áè≠Á∫ß': s.className,  
                        'Â≠¶Âè∑': s.studentId,  
                        'ÂßìÂêç': s.name,  
                        'Á≠æÂà∞Áä∂ÊÄÅ': checkedIn ? '‚úì Â∑≤Á≠æÂà∞' : '‚úó Êú™Á≠æÂà∞',  
                        'Á≠æÂà∞Êó∂Èó¥': checkedIn ? new Date(checkedIn.checkInTime).toLocaleString('zh-CN', {  
                            year: 'numeric',  
                            month: '2-digit',  
                            day: '2-digit',  
                            hour: '2-digit',  
                            minute: '2-digit',  
                            second: '2-digit'  
                        }) : '',  
                        'ÂÆö‰Ωç‰ø°ÊÅØ': checkedIn ? checkedIn.location : ''  
                    };  
                });  

                const ws = XLSX.utils.json_to_sheet(data);  
                
                // Set column widths  
                ws['!cols'] = [  
                    { wch: 6 },  // Â∫èÂè∑  
                    { wch: 20 }, // Áè≠Á∫ß  
                    { wch: 12 }, // Â≠¶Âè∑  
                    { wch: 10 }, // ÂßìÂêç  
                    { wch: 12 }, // Á≠æÂà∞Áä∂ÊÄÅ  
                    { wch: 20 }, // Á≠æÂà∞Êó∂Èó¥  
                    { wch: 40 }  // ÂÆö‰Ωç‰ø°ÊÅØ  
                ];  

                const wb = XLSX.utils.book_new();  
                XLSX.utils.book_append_sheet(wb, ws, 'Á≠æÂà∞ËÆ∞ÂΩï');  

                // Summary sheet  
                const summary = [  
                    ['Á≠æÂà∞ÁªüËÆ°Êä•Ë°®'],  
                    [''],  
                    ['ËØæÁ®ãÂêçÁß∞', currentCheckInSession.courseName],  
                    ['ËØæÁ®ãËäÇÊ¨°', currentCheckInSession.courseSession],  
                    ['Áè≠Á∫ß', currentCheckInSession.className],  
                    ['ÂºÄÂßãÊó∂Èó¥', new Date(currentCheckInSession.startTime).toLocaleString('zh-CN')],  
                    ['ÁªìÊùüÊó∂Èó¥', currentCheckInSession.status === 'completed' ? new Date().toLocaleString('zh-CN') : 'ËøõË°å‰∏≠'],  
                    [''],  
                    ['Â∫îÂà∞‰∫∫Êï∞', total],  
                    ['ÂÆûÂà∞‰∫∫Êï∞', checked],  
                    ['Áº∫Âã§‰∫∫Êï∞', absent],  
                    ['Âá∫Âã§Áéá', `${(checked/total*100).toFixed(2)}%`],  
                    [''],  
                    ['ÂØºÂá∫Êó∂Èó¥', new Date().toLocaleString('zh-CN')]  
                ];  
                
                const ws2 = XLSX.utils.aoa_to_sheet(summary);  
                ws2['!cols'] = [{ wch: 15 }, { wch: 30 }];  
                XLSX.utils.book_append_sheet(wb, ws2, 'ÁªüËÆ°ÊëòË¶Å');  

                // Absent students sheet  
                const absentStudents = currentCheckInSession.students.filter(  
                    s => !checkedInStudents.find(c => c.studentId === s.studentId)  
                );  
                
                if (absentStudents.length > 0) {  
                    const absentData = absentStudents.map((s, index) => ({  
                        'Â∫èÂè∑': index + 1,  
                        'Áè≠Á∫ß': s.className,  
                        'Â≠¶Âè∑': s.studentId,  
                        'ÂßìÂêç': s.name  
                    }));  
                    const ws3 = XLSX.utils.json_to_sheet(absentData);  
                    ws3['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 12 }, { wch: 10 }];  
                    XLSX.utils.book_append_sheet(wb, ws3, 'Áº∫Âã§ÂêçÂçï');  
                }  

                // Generate filename  
                const now = new Date();  
                const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;  
                const timeStr = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;  
                const filename = `${currentCheckInSession.courseName}_${dateStr}_${timeStr}.xlsx`;  
                
                XLSX.writeFile(wb, filename);  
                
                alert(`‚úÖ ExcelÂØºÂá∫ÊàêÂäüÔºÅ\n\nÊñá‰ª∂ÂêçÔºö${filename}\n\nÂåÖÂê´ÂÜÖÂÆπÔºö\n‚úì Á≠æÂà∞ËÆ∞ÂΩïÔºàÂÖ®ÈÉ®Â≠¶ÁîüÔºâ\n‚úì ÁªüËÆ°ÊëòË¶Å\n${absentStudents.length > 0 ? '‚úì Áº∫Âã§ÂêçÂçï' : ''}\n\nÂÖ± ${total} ‰∫∫ÔºåÂ∑≤Á≠æÂà∞ ${checked} ‰∫∫`);  
            } catch (error) {  
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);  
                alert('‚ùå ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);  
            }  
        }  

        // View history sessions - ‰øÆÂ§çÁâà
        async function viewHistory() {
            try {
                const query = new AV.Query('CheckInSession');
                query.descending('createdAt');
                query.limit(50);
                const sessions = await query.find();

                if (sessions.length === 0) {
                    alert('ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï');
                    return;
                }

                const historyList = document.getElementById('historyList');
                historyList.innerHTML = sessions.map((session, index) => {
                    const courseName = session.get('courseName') || 'Êú™ÂëΩÂêçËØæÁ®ã';
                    const courseSession = session.get('courseSession') || 'Êú™Áü•ËäÇÊ¨°';
                    const className = session.get('className') || 'Êú™Áü•Áè≠Á∫ß';
                    const startTime = session.get('startTime') || session.createdAt;
                    const status = session.get('status') || 'unknown';
                    const totalStudents = session.get('totalStudents') || 0;
                    const checkedInCount = session.get('checkedInCount') || 0;
                    
                    // È™åËØÅÊï∞ÊçÆÂÆåÊï¥ÊÄß
                    const isValid = courseName !== 'Êú™ÂëΩÂêçËØæÁ®ã' && startTime;
                    
                    // ËÆ°ÁÆóÂá∫Âã§Áéá
                    const attendanceRate = totalStudents > 0 ? (checkedInCount / totalStudents * 100).toFixed(1) : 0;

                    // Ê†ºÂºèÂåñÊó∂Èó¥
                    let formattedTime = 'Invalid Date';
                    try {
                        if (startTime) {
                            formattedTime = new Date(startTime).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    } catch (e) {
                        console.error('Êó∂Èó¥Ê†ºÂºèÂåñÈîôËØØ:', e);
                    }

                    // Â¶ÇÊûúÊòØÊó†ÊïàÊï∞ÊçÆÔºåÊòæÁ§∫Ë≠¶ÂëäÊ†∑Âºè
                    const invalidStyle = !isValid ? 'bg-red-50 border-red-300' : '';
                    const invalidBadge = !isValid ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded ml-2">‚ö†Ô∏è Êï∞ÊçÆÂºÇÂ∏∏</span>' : '';

                    return `
                        <div class="border rounded-lg p-4 hover:bg-gray-50 ${status === 'active' ? 'border-green-500 bg-green-50' : 'border-gray-300'} ${invalidStyle}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-lg">${courseName} - ${courseSession}${invalidBadge}</h3>
                                    <p class="text-gray-600 text-sm">Áè≠Á∫ßÔºö${className}</p>
                                    <p class="text-gray-600 text-sm">Êó∂Èó¥Ôºö${formattedTime}</p>
                                    ${!isValid ? '<p class="text-red-600 text-xs mt-1">‚ö†Ô∏è ËØ•ËÆ∞ÂΩïÂèØËÉΩÊòØÂ≠¶ÁîüËØØÊìç‰ΩúÂàõÂª∫ÔºåÂª∫ËÆÆÂà†Èô§</p>' : ''}
                                </div>
                                <span class="px-3 py-1 rounded text-sm ${status === 'active' ? 'bg-green-600 text-white' : 'bg-gray-500 text-white'}">
                                    ${status === 'active' ? 'ËøõË°å‰∏≠' : 'Â∑≤ÁªìÊùü'}
                                </span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-sm mb-3">
                                <div class="bg-blue-50 p-2 rounded text-center">
                                    <p class="text-gray-600">Â∫îÂà∞</p>
                                    <p class="font-bold text-blue-600">${totalStudents}</p>
                                </div>
                                <div class="bg-green-50 p-2 rounded text-center">
                                    <p class="text-gray-600">ÂÆûÂà∞</p>
                                    <p class="font-bold text-green-600">${checkedInCount}</p>
                                </div>
                                <div class="bg-red-50 p-2 rounded text-center">
                                    <p class="text-gray-600">Áº∫Âã§</p>
                                    <p class="font-bold text-red-600">${totalStudents - checkedInCount}</p>
                                </div>
                                <div class="bg-purple-50 p-2 rounded text-center">
                                    <p class="text-gray-600">Âá∫Âã§Áéá</p>
                                    <p class="font-bold text-purple-600">${attendanceRate}%</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${isValid && status === 'completed' ? `
                                    <button onclick="exportHistorySession('${session.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex-1">
                                        üì• ÂØºÂá∫Excel
                                    </button>
                                ` : ''}
                                <button onclick="deleteHistorySession('${session.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 ${!isValid ? 'flex-1' : ''}">
                                    üóëÔ∏è Âà†Èô§${!isValid ? 'ÂºÇÂ∏∏ËÆ∞ÂΩï' : ''}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïËÆ°Êï∞
                updateHistoryCount();

                document.getElementById('checkInStatus').classList.add('hidden');
                document.getElementById('historyPanel').classList.remove('hidden');
                
                console.log(`‚úÖ ÊòæÁ§∫ ${sessions.length} Êù°ÂéÜÂè≤ËÆ∞ÂΩï`);
                
            } catch (error) {
                console.error('‚ùå Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                alert(`‚ùå Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•Ôºö${error.message}`);
            }
        }
        // Hide history panel  
        function hideHistory() {  
            document.getElementById('historyPanel').classList.add('hidden');  
            if (currentCheckInSession) {  
                document.getElementById('checkInStatus').classList.remove('hidden');  
            }  
        }  

        // Delete history session  
        async function deleteHistorySession(sessionId) {  
            if (!confirm('‚ö†Ô∏è Á°ÆÂÆöÂà†Èô§Ê≠§Á≠æÂà∞ËÆ∞ÂΩïÂêóÔºü\n\nÂà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºåÂåÖÊã¨Ôºö\n‚Ä¢ Á≠æÂà∞‰ºöËØù‰ø°ÊÅØ\n‚Ä¢ ÊâÄÊúâÁ≠æÂà∞ËÆ∞ÂΩï\n\nÂª∫ËÆÆÂÖàÂØºÂá∫ExcelÂÜçÂà†Èô§ÔºÅ')) {  
                return;  
            }  

            try {  
                // Delete check-in records first  
                const recordQuery = new AV.Query('CheckInRecord');  
                recordQuery.equalTo('sessionId', sessionId);  
                recordQuery.limit(1000);  
                const records = await recordQuery.find();  
                
                if (records.length > 0) {  
                    await AV.Object.destroyAll(records);  
                    console.log(`‚úÖ Âà†Èô§‰∫Ü ${records.length} Êù°Á≠æÂà∞ËÆ∞ÂΩï`);  
                }  

                // Delete session  
                const sessionQuery = new AV.Query('CheckInSession');  
                const session = await sessionQuery.get(sessionId);  
                await session.destroy();  

                alert(`‚úÖ Âà†Èô§ÊàêÂäüÔºÅ\n\nÂ∑≤Âà†Èô§Á≠æÂà∞‰ºöËØùÂèäÂÖ∂ ${records.length} Êù°Á≠æÂà∞ËÆ∞ÂΩï`);  
                
                // Refresh history list  
                viewHistory();  
            } catch (error) {  
                console.error('Âà†Èô§Â§±Ë¥•:', error);  
                alert('‚ùå Âà†Èô§Â§±Ë¥•Ôºö' + error.message);  
            }  
        }  

        // Export history session  
        async function exportHistorySession(sessionId) {  
            try {  
                // Get session info  
                const query = new AV.Query('CheckInSession');  
                const session = await query.get(sessionId);  

                const courseName = session.get('courseName');  
                const courseSession = session.get('courseSession');  
                const className = session.get('className');  
                const startTime = session.get('startTime');  
                const endTime = session.get('endTime');  
                const results = session.get('results') || [];  

                if (results.length === 0) {  
                    alert('‚ùå ËØ•Á≠æÂà∞ËÆ∞ÂΩïÊó†ËØ¶ÁªÜÊï∞ÊçÆ');  
                    return;  
                }  

                // Main data sheet  
                const data = results.map((r, index) => ({  
                    'Â∫èÂè∑': index + 1,
                    'Áè≠Á∫ß': r.className,
                    'Â≠¶Âè∑': r.studentId,
                    'ÂßìÂêç': r.name,
                    'Á≠æÂà∞Áä∂ÊÄÅ': r.status === 'present' ? '‚úì Â∑≤Á≠æÂà∞' : '‚úó Êú™Á≠æÂà∞',
                    'Á≠æÂà∞Êó∂Èó¥': r.checkInTime ? new Date(r.checkInTime).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }) : '',
                    'ÂÆö‰Ωç‰ø°ÊÅØ': r.location || ''
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 6 },  // Â∫èÂè∑
                    { wch: 20 }, // Áè≠Á∫ß
                    { wch: 12 }, // Â≠¶Âè∑
                    { wch: 10 }, // ÂßìÂêç
                    { wch: 12 }, // Á≠æÂà∞Áä∂ÊÄÅ
                    { wch: 20 }, // Á≠æÂà∞Êó∂Èó¥
                    { wch: 40 }  // ÂÆö‰Ωç‰ø°ÊÅØ
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Á≠æÂà∞ËÆ∞ÂΩï');

                // Summary sheet
                const totalStudents = results.length;
                const checkedInCount = results.filter(r => r.status === 'present').length;
                const absentCount = totalStudents - checkedInCount;

                const summary = [
                    ['Á≠æÂà∞ÁªüËÆ°Êä•Ë°®'],
                    [''],
                    ['ËØæÁ®ãÂêçÁß∞', courseName],
                    ['ËØæÁ®ãËäÇÊ¨°', courseSession],
                    ['Áè≠Á∫ß', className],
                    ['ÂºÄÂßãÊó∂Èó¥', new Date(startTime).toLocaleString('zh-CN')],
                    ['ÁªìÊùüÊó∂Èó¥', endTime ? new Date(endTime).toLocaleString('zh-CN') : 'Êú™ËÆ∞ÂΩï'],
                    [''],
                    ['Â∫îÂà∞‰∫∫Êï∞', totalStudents],
                    ['ÂÆûÂà∞‰∫∫Êï∞', checkedInCount],
                    ['Áº∫Âã§‰∫∫Êï∞', absentCount],
                    ['Âá∫Âã§Áéá', `${(checkedInCount/totalStudents*100).toFixed(2)}%`],
                    [''],
                    ['ÂØºÂá∫Êó∂Èó¥', new Date().toLocaleString('zh-CN')]
                ];
                
                const ws2 = XLSX.utils.aoa_to_sheet(summary);
                ws2['!cols'] = [{ wch: 15 }, { wch: 30 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'ÁªüËÆ°ÊëòË¶Å');

                // Absent students sheet
                const absentStudents = results.filter(r => r.status === 'absent');
                
                if (absentStudents.length > 0) {
                    const absentData = absentStudents.map((s, index) => ({
                        'Â∫èÂè∑': index + 1,
                        'Áè≠Á∫ß': s.className,
                        'Â≠¶Âè∑': s.studentId,
                        'ÂßìÂêç': s.name
                    }));
                    const ws3 = XLSX.utils.json_to_sheet(absentData);
                    ws3['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 12 }, { wch: 10 }];
                    XLSX.utils.book_append_sheet(wb, ws3, 'Áº∫Âã§ÂêçÂçï');
                }

                // Generate filename
                const now = new Date();
                const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
                const timeStr = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
                const filename = `${courseName}_${dateStr}_${timeStr}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                alert(`‚úÖ ÂéÜÂè≤ËÆ∞ÂΩïÂØºÂá∫ÊàêÂäüÔºÅ\n\nÊñá‰ª∂ÂêçÔºö${filename}\n\nÂåÖÂê´ÂÜÖÂÆπÔºö\n‚úì Á≠æÂà∞ËÆ∞ÂΩïÔºàÂÖ®ÈÉ®Â≠¶ÁîüÔºâ\n‚úì ÁªüËÆ°ÊëòË¶Å\n${absentStudents.length > 0 ? '‚úì Áº∫Âã§ÂêçÂçï' : ''}\n\nÂÖ± ${totalStudents} ‰∫∫ÔºåÂ∑≤Á≠æÂà∞ ${checkedInCount} ‰∫∫`);
            } catch (error) {
                console.error('ÂØºÂá∫ÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                alert('‚ùå ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
            }
        }

        // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïËÆ°Êï∞
        async function updateHistoryCount() {
            try {
                const query = new AV.Query('CheckInSession');
                const count = await query.count();
                const countElement = document.getElementById('historyCount');
                if (countElement) {
                    countElement.textContent = count;
                }
                console.log(`‚úÖ ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè: ${count}`);
            } catch (error) {
                console.error('Ëé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÈáèÂ§±Ë¥•:', error);
            }
        }

        // ==================== Ê£ÄÊü•Ê¥ªÂä®‰ºöËØùÔºàÂÆåÊï¥ÁâàÔºâ====================
// ==================== Ê£ÄÊü•Ê¥ªÂä®‰ºöËØùÔºàÊîØÊåÅÂÆöÊó∂‰ªªÂä°Ôºâ====================
async function checkActiveSession() {
    try {
        console.log('üîçÊ£ÄÊü•Ê¥ªÂä®Á≠æÂà∞‰ºöËØù...');
        
        // üî• Á¨¨‰∏ÄÊ≠•ÔºöÂÖàÊ£ÄÊü•ÊòØÂê¶ÊúâÂÆöÊó∂‰ªªÂä°
        console.log('üîçÊ£ÄÊü•ÂÆöÊó∂‰ªªÂä°...');
        const scheduledQuery = new AV.Query('CheckInSession');
        scheduledQuery.equalTo('status', 'scheduled');
        scheduledQuery.descending('createdAt');
        const scheduledSession = await scheduledQuery.first();
        
        if (scheduledSession) {
            const scheduledTime = scheduledSession.get('scheduledTime');
            const courseName = scheduledSession.get('courseName');
            const courseSession = scheduledSession.get('courseSession');
            const classNames = scheduledSession.get('classNames') || [scheduledSession.get('className')];
            const students = scheduledSession.get('students') || [];
            const duration = scheduledSession.get('duration');
            
            console.log('‚úÖ ÂèëÁé∞ÂÆöÊó∂‰ªªÂä°:', scheduledSession.id);
            console.log('üìÖ ÂèëÂ∏ÉÊó∂Èó¥:', new Date(scheduledTime).toLocaleString('zh-CN'));
            
            // ÊòæÁ§∫ÂÆöÊó∂‰ªªÂä°ÂÄíËÆ°Êó∂ÁïåÈù¢
            showScheduledTaskUI(
                scheduledSession.id,
                new Date(scheduledTime),
                courseName,
                courseSession,
                classNames,
                students.length,
                duration
            );
            return;
        }
        
        // Á¨¨‰∫åÊ≠•ÔºöÊü•ËØ¢Ê¥ªÂä®ÁöÑÁ≠æÂà∞‰ºöËØùÔºàÂéüÊúâÈÄªËæëÔºâ
        const query = new AV.Query('CheckInSession');
        query.equalTo('status', 'active');
        query.descending('createdAt');
        query.limit(1);
        const activeSession = await query.first();

        if (!activeSession) {
            console.log('‚ÑπÔ∏èÊú™ÂèëÁé∞Ê¥ªÂä®ÁöÑÁ≠æÂà∞‰ºöËØù');
            // Á°Æ‰øùÊòæÁ§∫ËÆæÁΩÆÈù¢Êùø
            const setupPanel = document.getElementById('setupPanel');
            const checkInStatus = document.getElementById('checkInStatus');
            if (setupPanel) setupPanel.classList.remove('hidden');
            if (checkInStatus) checkInStatus.classList.add('hidden');
            return;
        }

        console.log('‚úÖÂèëÁé∞Ê¥ªÂä®‰ºöËØù:', activeSession.id);

        // ÊÅ¢Â§ç‰ºöËØù‰ø°ÊÅØ
        const classNames = activeSession.get('classNames') || [activeSession.get('className')];
        const students = activeSession.get('students') || [];

        currentCheckInSession = {
            id: activeSession.id,
            courseName: activeSession.get('courseName') || 'Êú™Áü•ËØæÁ®ã',
            courseSession: activeSession.get('courseSession') || 'Êú™Áü•ËäÇÊ¨°',
            classNames: classNames,
            className: classNames.join('„ÄÅ'),
            duration: activeSession.get('duration') || 30,
            requireLocation: activeSession.get('requireLocation') || false,
            startTime: activeSession.get('startTime') || new Date(),
            status: 'active',
            students: students,
            totalStudents: students.length
        };

        console.log('‚úÖ‰ºöËØù‰ø°ÊÅØÂ∑≤ÊÅ¢Â§ç:', currentCheckInSession);

        // Âä†ËΩΩÁ≠æÂà∞ËÆ∞ÂΩï
        console.log('üì•Âä†ËΩΩÁ≠æÂà∞ËÆ∞ÂΩï...');
        try {
            const recordQuery = new AV.Query('CheckInRecord');
            recordQuery.equalTo('sessionId', activeSession.id);
            recordQuery.descending('checkInTime');
            recordQuery.limit(1000);
            const records = await recordQuery.find();

            console.log(`‚úÖÊâæÂà∞${records.length} Êù°Á≠æÂà∞ËÆ∞ÂΩï`);

            // ËΩ¨Êç¢‰∏∫ÊôÆÈÄöÂØπË±°Êï∞ÁªÑ
            checkedInStudents = records.map(obj => ({
                className: obj.get('className'),
                studentId: obj.get('studentId'),
                name: obj.get('studentName'),
                location: obj.get('location'),
                checkInTime: obj.get('checkInTime')
            }));

            console.log('‚úÖÁ≠æÂà∞ËÆ∞ÂΩïÂ∑≤Âä†ËΩΩ:', checkedInStudents.length, '‰∫∫');
        } catch (recordError) {
            console.error('‚ùåÂä†ËΩΩÁ≠æÂà∞ËÆ∞ÂΩïÂ§±Ë¥•:', recordError);
            checkedInStudents = [];
        }

        // ÊÅ¢Â§çUIÁä∂ÊÄÅ
        console.log('üé®ÊÅ¢Â§çUIÁä∂ÊÄÅ...');
        const setupPanel = document.getElementById('setupPanel');
        const checkInStatus = document.getElementById('checkInStatus');

        if (setupPanel) setupPanel.classList.add('hidden');
        if (checkInStatus) checkInStatus.classList.remove('hidden');

        // Êõ¥Êñ∞ËØæÁ®ã‰ø°ÊÅØÊòæÁ§∫
        const currentCourse = document.getElementById('currentCourse');
        const currentClass = document.getElementById('currentClass');
        
        if (currentCourse) {
            currentCourse.textContent = `${currentCheckInSession.courseName} - ${currentCheckInSession.courseSession}`;
            console.log('‚úÖËØæÁ®ã‰ø°ÊÅØÂ∑≤ÊòæÁ§∫');
        }
        
        if (currentClass) {
            currentClass.textContent = currentCheckInSession.className;
            console.log('‚úÖÁè≠Á∫ß‰ø°ÊÅØÂ∑≤ÊòæÁ§∫');
        }

        // ÂàùÂßãÂåñËØç‰∫ëËÆ°Êï∞Âô®
        if (typeof previousUncheckedCount !== 'undefined') {
            previousUncheckedCount = students.length;
            console.log('‚úÖËØç‰∫ëËÆ°Êï∞Âô®Â∑≤ÂàùÂßãÂåñ:', previousUncheckedCount);
        }

        // ========== ÂàùÂßãÂåñÊâÄÊúâÊòæÁ§∫ÂäüËÉΩ ==========
        console.log('üìäÂàùÂßãÂåñÊòæÁ§∫ÂäüËÉΩ...');

        // 1. Êõ¥Êñ∞ËØç‰∫ë
        try {
            if (typeof updateWordCloud === 'function') {
                updateWordCloud();
                console.log('‚úÖËØç‰∫ëÂ∑≤ÂàùÂßãÂåñ');
            }
        } catch (error) {
            console.error('‚ùåËØç‰∫ëÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }

        // 2. Êõ¥Êñ∞ËøõÂ∫¶Êù°
        try {
            if (typeof updateProgress === 'function') {
                updateProgress();
                console.log('‚úÖËøõÂ∫¶ÊòæÁ§∫Â∑≤ÂàùÂßãÂåñ');
            }
        } catch (error) {
            console.error('‚ùåËøõÂ∫¶ÊòæÁ§∫ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }

        // 3. ‚úÖÊõ¥Êñ∞Â∑≤Á≠æÂà∞ÂàóË°®
        try {
            if (typeof updateCheckedInList === 'function') {
                updateCheckedInList();
                console.log('‚úÖÂ∑≤Á≠æÂà∞ÂàóË°®Â∑≤ÂàùÂßãÂåñ');
            } else {
                console.warn('‚ö†Ô∏èupdateCheckedInList ÂáΩÊï∞‰∏çÂ≠òÂú®');
            }
        } catch (error) {
            console.error('‚ùåÂ∑≤Á≠æÂà∞ÂàóË°®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }

        // 4. ‚úÖÊõ¥Êñ∞Êú™Á≠æÂà∞ÂàóË°®
        try {
            if (typeof updateUncheckedList === 'function') {
                updateUncheckedList();
                console.log('‚úÖÊú™Á≠æÂà∞ÂàóË°®Â∑≤ÂàùÂßãÂåñ');
            } else {
                console.warn('‚ö†Ô∏èupdateUncheckedList ÂáΩÊï∞‰∏çÂ≠òÂú®');
            }
        } catch (error) {
            console.error('‚ùåÊú™Á≠æÂà∞ÂàóË°®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }

        // 5. ÂºÄÂßãÂÆöÊó∂Âà∑Êñ∞
        console.log('üîÑÂêØÂä®Ëá™Âä®Âà∑Êñ∞...');
        if (typeof startPolling === 'function') {
            startPolling();
        } else {
            console.warn('‚ö†Ô∏èstartPolling ÂáΩÊï∞‰∏çÂ≠òÂú®');
        }

        // 6. ÊÅ¢Â§çÂÄíËÆ°Êó∂
        console.log('‚è±Ô∏èÊÅ¢Â§çÂÄíËÆ°Êó∂...');
        try {
            const startTime = new Date(currentCheckInSession.startTime);
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000); // Â∑≤ËøáÁßíÊï∞
            const totalSeconds = currentCheckInSession.duration * 60; // ÊÄªÁßíÊï∞
            const remainingSeconds = Math.max(0, totalSeconds - elapsed); // Ââ©‰ΩôÁßíÊï∞
            const remainingMinutes = Math.ceil(remainingSeconds / 60); // Ââ©‰ΩôÂàÜÈíü

            console.log('‚è±Ô∏èÊó∂Èó¥ËÆ°ÁÆó:', {
                ÂºÄÂßãÊó∂Èó¥: startTime.toLocaleString('zh-CN'),
                ÂΩìÂâçÊó∂Èó¥: now.toLocaleString('zh-CN'),
                Â∑≤ËøáÁßíÊï∞: elapsed,
                Ââ©‰ΩôÁßíÊï∞: remainingSeconds,
                Ââ©‰ΩôÂàÜÈíü: remainingMinutes
            });

            if (remainingSeconds > 0) {
                if (typeof setupCountdown === 'function') {
                    setupCountdown(remainingMinutes);
                    console.log(`‚úÖÂÄíËÆ°Êó∂Â∑≤ÊÅ¢Â§çÔºåÂâ©‰Ωô ${remainingMinutes} ÂàÜÈíü`);
                }
            } else {
                console.warn('‚ö†Ô∏èÁ≠æÂà∞Êó∂Èó¥Â∑≤Âà∞');
                const countdownElement = document.getElementById('countdown');
                if (countdownElement) {
                    countdownElement.textContent = '‚è∞Á≠æÂà∞Êó∂Èó¥Â∑≤Âà∞';
                    countdownElement.className = 'text-red-600 font-bold';
                }
            }
        } catch (error) {
            console.error('‚ùåÂÄíËÆ°Êó∂ÊÅ¢Â§çÂ§±Ë¥•:', error);
        }

        // ÊòæÁ§∫ÊÅ¢Â§çÊàêÂäüÈÄöÁü•
        console.log('‚úÖÁ≠æÂà∞‰ºöËØùÂ∑≤ÊàêÂäüÊÅ¢Â§ç');
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('üìäÂΩìÂâçÁä∂ÊÄÅ:');
        console.log('  ËØæÁ®ã:', currentCheckInSession.courseName);
        console.log('  ËäÇÊ¨°:', currentCheckInSession.courseSession);
        console.log('  Áè≠Á∫ß:', currentCheckInSession.className);
        console.log('  Â∫îÂà∞:', currentCheckInSession.totalStudents, '‰∫∫');
        console.log('  ÂÆûÂà∞:', checkedInStudents.length, '‰∫∫');
        console.log('  Êú™Âà∞:', currentCheckInSession.totalStudents - checkedInStudents.length, '‰∫∫');
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

        // ÊòæÁ§∫ËΩªÊèêÁ§∫Ôºà‰∏çÊâìÊñ≠Áî®Êà∑Ôºâ
        showNotification(
            '‚úÖÁ≠æÂà∞‰ºöËØùÂ∑≤ÊÅ¢Â§ç',
            `${currentCheckInSession.courseName} - Â∑≤Á≠æÂà∞ ${checkedInStudents.length}/${currentCheckInSession.totalStudents} ‰∫∫`
        );

    } catch (error) {
        console.error('‚ùåÊ£ÄÊü•Ê¥ªÂä®‰ºöËØùÂ§±Ë¥•:', error);
        
        // ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
        if (error.code === 101) {
            console.warn('‚ö†Ô∏èCheckInSession Ë°®‰∏çÂ≠òÂú®');
        } else if (error.code === 403) {
            console.error('‚ùåÊùÉÈôê‰∏çË∂≥ÔºåÊó†Ê≥ïÊü•ËØ¢Á≠æÂà∞‰ºöËØù');
        } else if (error.code === 1) {
            console.error('‚ùåÁΩëÁªúËøûÊé•Â§±Ë¥•');
        } else {
            console.error('‚ùåÊú™Áü•ÈîôËØØ:', error.message);
        }

        // Á°Æ‰øùÊòæÁ§∫ËÆæÁΩÆÈù¢ÊùøÔºàÂ§±Ë¥•Êó∂ÁöÑÈªòËÆ§Áä∂ÊÄÅÔºâ
        const setupPanel = document.getElementById('setupPanel');
        const checkInStatus = document.getElementById('checkInStatus');
        if (setupPanel) setupPanel.classList.remove('hidden');
        if (checkInStatus) checkInStatus.classList.add('hidden');
    }
}

        // ==================== ËæÖÂä©ÂáΩÊï∞ÔºöÊòæÁ§∫ÈÄöÁü• ====================
        function showNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-xl">‚úÖ</span>
                    <div>
                        <p class="font-bold">${title}</p>
                        <p class="text-sm opacity-90">${message}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s, transform 0.3s';
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®ÊâßË°å ====================
        window.addEventListener('load', function() {
            console.log('üìÑ È°µÈù¢Â∑≤Âä†ËΩΩ');
            console.log('üîç Ëá™Âä®Ê£ÄÊü•Ê¥ªÂä®‰ºöËØù...');
            
            // Âª∂Ëøü100msÊâßË°åÔºåÁ°Æ‰øùDOMÂÆåÂÖ®Â∞±Áª™
            setTimeout(() => {
                checkActiveSession();
            }, 100);
        });

        // ==================== È°µÈù¢ÂèØËßÅÊó∂Âà∑Êñ∞ ====================
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üëÄ È°µÈù¢Â∑≤ÂèØËßÅ');
                
                // Â¶ÇÊûúÊúâÊ¥ªÂä®‰ºöËØùÔºåÂà∑Êñ∞Êï∞ÊçÆ
                if (currentCheckInSession && currentCheckInSession.id) {
                    console.log('üîÑ Âà∑Êñ∞Á≠æÂà∞Êï∞ÊçÆ...');
                    if (typeof refreshCheckInData === 'function') {
                        refreshCheckInData();
                    }
                }
            }
        });

        // ==================== ÊâãÊú∫Á´ØÂÆö‰ΩçÔºàÁÆÄÊ¥ÅÁâàÔºâ====================
        
        function getLocation() {
            const locationBtn = document.getElementById('locationBtn');
            const locationInput = document.getElementById('location');
            
            locationBtn.disabled = true;
            locationBtn.textContent = 'üîÑ ÂÆö‰Ωç‰∏≠...';
            locationInput.value = 'üìç Ê≠£Âú®Ëé∑ÂèñÊâãÊú∫ÂÆö‰ΩçÔºåËØ∑Á®çÂÄô...';

            // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅÂÆö‰Ωç
            if (!navigator.geolocation) {
                locationInput.value = 'ÊÇ®ÁöÑËÆæÂ§á‰∏çÊîØÊåÅÂÆö‰ΩçÔºàÂèØÁªßÁª≠Á≠æÂà∞Ôºâ';
                locationBtn.disabled = false;
                locationBtn.textContent = '‚ùå ‰∏çÊîØÊåÅÂÆö‰Ωç';
                alert('‚ö†Ô∏è ÊÇ®ÁöÑËÆæÂ§á‰∏çÊîØÊåÅÂÆö‰ΩçÂäüËÉΩ\n\nÊÇ®‰ªçÂèØÁªßÁª≠Á≠æÂà∞');
                return;
            }

            // ‰ΩøÁî®ÊâãÊú∫GPSÂÆö‰Ωç
            navigator.geolocation.getCurrentPosition(
                // ÂÆö‰ΩçÊàêÂäü
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);
                    
                    console.log('‚úÖ ÂÆö‰ΩçÊàêÂäü:', { lat, lng, accuracy });
                    
                    // ÂÖàÊòæÁ§∫Âü∫Á°Ä‰ø°ÊÅØ
                    locationInput.value = `üìç ÂÆö‰ΩçÊàêÂäüÔºÅÁ≤æÂ∫¶¬±${accuracy}Á±≥\nÊ≠£Âú®Ëß£ÊûêÂú∞ÂùÄ...`;
                    
                    // Ëß£ÊûêËØ¶ÁªÜÂú∞ÂùÄ
                    try {
                        const response = await fetch(
                            `https://restapi.amap.com/v3/geocode/regeo?key=b6941653e924ebda799872dd5f5e4f29&location=${lng},${lat}&extensions=all`
                        );
                        const data = await response.json();
                        
                        if (data.status === '1' && data.regeocode) {
                            let address = data.regeocode.formatted_address || 'Êú™Áü•Âú∞ÂùÄ';
                            
                            // Ê∑ªÂä†ÈôÑËøëÂú∞Ê†á
                            if (data.regeocode.pois && data.regeocode.pois.length > 0) {
                                const poi = data.regeocode.pois[0];
                                address += `\nüìç ${poi.name}`;
                            }
                            
                            locationInput.value = `${address}\nÂùêÊ†á: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nÁ≤æÂ∫¶: ¬±${accuracy}Á±≥`;
                            console.log('‚úÖ Âú∞ÂùÄËß£ÊûêÊàêÂäü:', address);
                        } else {
                            // Âú∞ÂùÄËß£ÊûêÂ§±Ë¥•ÔºåÂè™ÊòæÁ§∫ÂùêÊ†á
                            locationInput.value = `ÂùêÊ†á: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nÁ≤æÂ∫¶: ¬±${accuracy}Á±≥`;
                            console.warn('‚ö†Ô∏è Âú∞ÂùÄËß£ÊûêÂ§±Ë¥•Ôºå‰ªÖÊòæÁ§∫ÂùêÊ†á');
                        }
                    } catch (error) {
                        // ÁΩëÁªúÈîôËØØÔºåÂè™ÊòæÁ§∫ÂùêÊ†á
                        console.error('‚ùå Âú∞ÂùÄËß£ÊûêÂá∫Èîô:', error);
                        locationInput.value = `ÂùêÊ†á: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nÁ≤æÂ∫¶: ¬±${accuracy}Á±≥`;
                    }
                    
                    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                    locationBtn.disabled = false;
                    locationBtn.textContent = '‚úÖ ÂÆö‰ΩçÊàêÂäü';
                    locationBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                    locationBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    
                    // ÈúáÂä®ÂèçÈ¶à
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                },
                
                // ÂÆö‰ΩçÂ§±Ë¥•
                (error) => {
                    console.error('‚ùå ÂÆö‰ΩçÂ§±Ë¥•:', error);
                    
                    let errorMsg = '';
                    let suggestion = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'ÂÆö‰ΩçÊùÉÈôêË¢´ÊãíÁªù';
                            suggestion = 'ËØ∑Âú®ÊâãÊú∫ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏ÊµèËßàÂô®‰ΩøÁî®ÂÆö‰Ωç';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'GPS‰ø°Âè∑‰∏çÂèØÁî®';
                            suggestion = 'ËØ∑ÁßªÂä®Âà∞ÂÆ§Â§ñÊàñÁ™óËæπÔºåÁ°Æ‰øùGPSÂ∑≤ÂºÄÂêØ';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'ÂÆö‰ΩçË∂ÖÊó∂';
                            suggestion = 'ËØ∑Á°Æ‰øùGPSÂ∑≤ÂºÄÂêØÔºåÊàñÁßªÂä®Âà∞‰ø°Âè∑ËæÉÂ•ΩÁöÑÂú∞Êñπ';
                            break;
                        default:
                            errorMsg = 'ÂÆö‰ΩçÂ§±Ë¥•';
                            suggestion = 'ËØ∑Ê£ÄÊü•ÂÆö‰ΩçÊùÉÈôêÂíåGPSÊòØÂê¶ÂºÄÂêØ';
                    }
                    
                    locationInput.value = `${errorMsg}ÔºàÂèØÁªßÁª≠Á≠æÂà∞Ôºâ`;
                    
                    locationBtn.disabled = false;
                    locationBtn.textContent = 'üìç ÈáçÊñ∞ÂÆö‰Ωç';
                    locationBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    locationBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
                    
                    // ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
                    alert(`‚ö†Ô∏è ${errorMsg}\n\nüí° ${suggestion}\n\nÊÇ®‰ªçÂèØÁªßÁª≠Á≠æÂà∞ÔºåÁ≥ªÁªüÂ∞ÜËÆ∞ÂΩï"${errorMsg}"`);
                    
                    // ÈúáÂä®ÊèêÁ§∫
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }
                },
                
                // ÂÆö‰ΩçÈÄâÈ°π
                {
                    enableHighAccuracy: true,    // ‰ΩøÁî®GPSÈ´òÁ≤æÂ∫¶
                    timeout: 20000,              // 20ÁßíË∂ÖÊó∂ÔºàÊâãÊú∫GPS‰∏ÄËà¨Â§üÁî®Ôºâ
                    maximumAge: 10000            // ÂÖÅËÆ∏‰ΩøÁî®10ÁßíÂÜÖÁöÑÁºìÂ≠ò
                }
            );
        }



        // Open camera for face recognition (ÁßªÂä®Á´Ø‰ºòÂåñÁâà)
        async function openCamera() {
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üì± ÊâìÂºÄÁõ∏Êú∫ - ÁßªÂä®Á´Ø‰ºòÂåñÁâà');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            
            // 1. Ê£ÄÊü•Ê®°ÂûãÂä†ËΩΩ
            if (!faceModelsLoaded) {
                alert('‰∫∫ËÑ∏ËØÜÂà´Ê®°ÂûãÂä†ËΩΩ‰∏≠ÔºåËØ∑Á®çÂÄô...');
                return;
            }

            // 2. Ê£ÄÊü•‰∫∫ËÑ∏Êï∞ÊçÆ
            if (labeledDescriptors.length === 0) {
                alert('‚ùå Á≥ªÁªü‰∏≠ËøòÊ≤°ÊúâÂ≠¶Áîü‰∫∫ËÑ∏Êï∞ÊçÆÔºÅ\n\nËØ∑ÂÖàÂú®ÊïôÂ∏àÁ´ØÊ∑ªÂä†Â≠¶ÁîüÁÖßÁâá‰ø°ÊÅØ');
                return;
            }

            try {
                recognitionSuccess = false;
                document.getElementById('cameraBtn').disabled = true;
                document.getElementById('cameraBtn').textContent = 'Ê≠£Âú®ÊâìÂºÄÁõ∏Êú∫...';

                // 3. Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
                console.log('Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ...');
                console.log('  User Agent:', navigator.userAgent);
                console.log('  Protocol:', location.protocol);
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÁõ∏Êú∫ÂäüËÉΩ\n\nËØ∑‰ΩøÁî®ÊúÄÊñ∞Áâà Chrome„ÄÅSafari Êàñ Firefox');
                }

                // 4. Ê£ÄÊü• HTTPSÔºàÈáçË¶ÅÔºÅÔºâ
                const isLocalhost = ['localhost', '127.0.0.1', ''].includes(location.hostname);
                if (location.protocol === 'http:' && !isLocalhost) {
                    throw new Error('Áõ∏Êú∫ÂäüËÉΩÈúÄË¶Å HTTPS ËøûÊé•\n\nËØ∑‰ΩøÁî® HTTPS ËÆøÈóÆÈ°µÈù¢');
                }

                // 5. ËØ∑Ê±ÇÁõ∏Êú∫ÊùÉÈôêÔºàÁßªÂä®Á´Ø‰ºòÂåñÁöÑÁ∫¶ÊùüÊù°‰ª∂Ôºâ
                console.log('ËØ∑Ê±ÇÁõ∏Êú∫ÊùÉÈôê...');
                const constraints = {
                    video: {
                        facingMode: 'user', // ÂâçÁΩÆÊëÑÂÉèÂ§¥
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    },
                    audio: false
                };
                
                console.log('Á∫¶ÊùüÊù°‰ª∂:', constraints);
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('‚úÖ Áõ∏Êú∫ÊùÉÈôêÂ∑≤Êéà‰∫à');
                console.log('ËßÜÈ¢ëËΩ®ÈÅì:', videoStream.getVideoTracks().length);

                // 6. ÈÖçÁΩÆ video ÂÖÉÁ¥†ÔºàÁßªÂä®Á´ØÂÖ≥ÈîÆÔºÅÔºâ
                const video = document.getElementById('video');
                const canvas = document.getElementById('faceCanvas');
                
                // üî• ÁßªÂä®Á´ØÂøÖÈ°ªËÆæÁΩÆËøô‰∫õÂ±ûÊÄßÔºÅ
                video.setAttribute('autoplay', '');
                video.setAttribute('playsinline', ''); // iOS Safari ÂøÖÈúÄ
                video.setAttribute('muted', '');
                video.muted = true; // ÈùôÈü≥ÔºàÈÅøÂÖçËá™Âä®Êí≠ÊîæÈôêÂà∂Ôºâ
                
                video.srcObject = videoStream;
                
                // 7. Á≠âÂæÖËßÜÈ¢ëÂä†ËΩΩ
                console.log('Á≠âÂæÖËßÜÈ¢ëÂä†ËΩΩ...');
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        console.log('‚úÖ ËßÜÈ¢ëÂÖÉÊï∞ÊçÆÂ∑≤Âä†ËΩΩ');
                        console.log('ËßÜÈ¢ëÂ∞∫ÂØ∏:', video.videoWidth, 'x', video.videoHeight);
                        resolve();
                    };
                    
                    video.onerror = (e) => {
                        console.error('‚ùå ËßÜÈ¢ëÂä†ËΩΩÈîôËØØ:', e);
                        reject(new Error('ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•'));
                    };
                    
                    // Ë∂ÖÊó∂Â§ÑÁêÜ
                    setTimeout(() => {
                        reject(new Error('ËßÜÈ¢ëÂä†ËΩΩË∂ÖÊó∂'));
                    }, 10000);
                });

                // 8. Êí≠ÊîæËßÜÈ¢ëÔºàÁßªÂä®Á´ØÂèØËÉΩÈúÄË¶ÅÊâãÂä®Êí≠ÊîæÔºâ
                console.log('Êí≠ÊîæËßÜÈ¢ë...');
                try {
                    await video.play();
                    console.log('‚úÖ ËßÜÈ¢ëÊí≠ÊîæÊàêÂäü');
                } catch (playError) {
                    console.warn('Ëá™Âä®Êí≠ÊîæÂ§±Ë¥•ÔºåÂ∞ùËØïÁî®Êà∑‰∫§‰∫íÊí≠Êîæ:', playError);
                    // ÁßªÂä®Á´ØÂèØËÉΩÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÊâçËÉΩÊí≠Êîæ
                    video.play().catch(e => {
                        console.error('Êí≠ÊîæÂ§±Ë¥•:', e);
                    });
                }

                // 9. ÊòæÁ§∫ÁïåÈù¢
                video.classList.remove('hidden');
                canvas.classList.remove('hidden');
                document.getElementById('videoPlaceholder').classList.add('hidden');
                document.getElementById('recognitionStatus').classList.remove('hidden');
                document.getElementById('recognitionStatus').innerHTML = 
                    '<p class="text-blue-800 font-semibold">üîç Ê≠£Âú®ËØÜÂà´‰∫∫ËÑ∏ÔºåËØ∑Ê≠£ÂØπÊëÑÂÉèÂ§¥‰øùÊåÅ2-3Áßí...</p>';

                document.getElementById('cameraBtn').textContent = 'üî¥ ÂÖ≥Èó≠Áõ∏Êú∫';
                document.getElementById('cameraBtn').onclick = stopCamera;
                document.getElementById('cameraBtn').disabled = false;

                // 10. ÂºÄÂßã‰∫∫ËÑ∏Ê£ÄÊµãÔºàÁ°Æ‰øùËßÜÈ¢ëÊ≠£Âú®Êí≠ÊîæÔºâ
                const startDetection = () => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        console.log('‚úÖÂºÄÂßã‰∫∫ËÑ∏Ê£ÄÊµã');
                        initLivenessCheck(); // üî•ÂàùÂßãÂåñÊ¥ª‰ΩìÊ£ÄÊµã
                        faceDetectionRunning = true;
                        detectFaceLoop();
                    } else {
                        console.log('Á≠âÂæÖËßÜÈ¢ëÊï∞ÊçÆ...');
                        setTimeout(startDetection, 100);
                    }
                };
                startDetection();
                
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('‚úÖ Áõ∏Êú∫ÂêØÂä®ÊàêÂäü');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

            } catch (error) {
                console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.error('‚ùå Áõ∏Êú∫ÂêØÂä®Â§±Ë¥•:', error);
                console.error('ÈîôËØØÂêçÁß∞:', error.name);
                console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                // ËØ¶ÁªÜÁöÑÈîôËØØÊèêÁ§∫
                let errorMessage = '‚ùå Êó†Ê≥ïÊâìÂºÄÁõ∏Êú∫\n\n';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'ÂéüÂõ†ÔºöÁõ∏Êú∫ÊùÉÈôêË¢´ÊãíÁªù\n\n';
                    errorMessage += 'üì± Ëß£ÂÜ≥ÊñπÊ≥ïÔºö\n';
                    errorMessage += '1. ÁÇπÂáªÂú∞ÂùÄÊ†èÁöÑ üîí Êàñ ‚ìò ÂõæÊ†á\n';
                    errorMessage += '2. ÊâæÂà∞"Áõ∏Êú∫"ÊùÉÈôê\n';
                    errorMessage += '3. Êîπ‰∏∫"ÂÖÅËÆ∏"\n';
                    errorMessage += '4. Âà∑Êñ∞È°µÈù¢ÈáçËØï\n\n';
                    errorMessage += 'üí° ÊàñÂú®Á≥ªÁªüËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏ÊµèËßàÂô®ËÆøÈóÆÁõ∏Êú∫';
                    
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'ÂéüÂõ†ÔºöÊú™ÊâæÂà∞Áõ∏Êú∫ËÆæÂ§á\n\n';
                    errorMessage += 'üì± ËØ∑Ê£ÄÊü•Ôºö\n';
                    errorMessage += '1. ËÆæÂ§áÊòØÂê¶ÊúâÂâçÁΩÆÊëÑÂÉèÂ§¥\n';
                    errorMessage += '2. ÊëÑÂÉèÂ§¥ÊòØÂê¶Ê≠£Â∏∏Â∑•‰Ωú';
                    
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'ÂéüÂõ†ÔºöÁõ∏Êú∫Ë¢´Âç†Áî®\n\n';
                    errorMessage += 'üì± ËØ∑Â∞ùËØïÔºö\n';
                    errorMessage += '1. ÂÖ≥Èó≠ÂÖ∂‰ªñ‰ΩøÁî®Áõ∏Êú∫ÁöÑÂ∫îÁî®\n';
                    errorMessage += '2. Âà∑Êñ∞È°µÈù¢ÈáçËØï\n';
                    errorMessage += '3. ÈáçÂêØÊµèËßàÂô®';
                    
                } else if (error.name === 'SecurityError' || error.message.includes('HTTPS')) {
                    errorMessage += 'ÂéüÂõ†ÔºöÂÆâÂÖ®ÈôêÂà∂\n\n';
                    errorMessage += 'üì± Áõ∏Êú∫ÂäüËÉΩÈúÄË¶Å HTTPS ËøûÊé•\n\n';
                    errorMessage += 'ÂΩìÂâçËøûÊé•Ôºö' + location.protocol + '\n';
                    errorMessage += 'ËØ∑‰ΩøÁî® HTTPS ËÆøÈóÆÈ°µÈù¢';
                    
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += 'ÂéüÂõ†ÔºöÁõ∏Êú∫‰∏çÊîØÊåÅËØ∑Ê±ÇÁöÑÂèÇÊï∞\n\n';
                    errorMessage += 'üì± ËØ∑Â∞ùËØïÂà∑Êñ∞È°µÈù¢ÈáçËØï';
                    
                } else {
                    errorMessage += 'ÈîôËØØËØ¶ÊÉÖÔºö\n' + error.message + '\n\n';
                    errorMessage += 'üì± ËØ∑Â∞ùËØïÔºö\n';
                    errorMessage += '1. Âà∑Êñ∞È°µÈù¢\n';
                    errorMessage += '2. ÈáçÂêØÊµèËßàÂô®\n';
                    errorMessage += '3. Ê£ÄÊü•Á≥ªÁªüÁõ∏Êú∫ÊùÉÈôê';
                }
                
                // Ê£ÄÊµãÁâπÊÆäÊµèËßàÂô®
                const ua = navigator.userAgent.toLowerCase();
                if (ua.includes('micromessenger')) {
                    errorMessage += '\n\n‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂæÆ‰ø°ÊµèËßàÂô®\n';
                    errorMessage += 'Âª∫ËÆÆÔºöÁÇπÂáªÂè≥‰∏äËßí"..."ÈÄâÊã©"Âú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄ"';
                } else if (ua.includes('qq/') || ua.includes('mqqbrowser')) {
                    errorMessage += '\n\n‚ö†Ô∏è Ê£ÄÊµãÂà∞QQÊµèËßàÂô®\n';
                    errorMessage += 'Âª∫ËÆÆÔºöÁÇπÂáªÂè≥‰∏äËßíÈÄâÊã©"Âú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄ"';
                }
                
                alert(errorMessage);
                
                document.getElementById('cameraBtn').disabled = false;
                document.getElementById('cameraBtn').textContent = 'üì∑ ÊâìÂºÄÁõ∏Êú∫Ôºà‰∫∫ËÑ∏ËØÜÂà´Ôºâ';
            }
        }


// ==================== Ê¥ª‰ΩìÊ£ÄÊµãÂäüËÉΩ ====================

// ÂàùÂßãÂåñÊ¥ª‰ΩìÊ£ÄÊµãÔºàÈöèÊú∫ÈÄâÊã©2‰∏™Âä®‰ΩúÔºâ
function initLivenessCheck() {
    const allActions = ['blink', 'mouth', 'nod'];
    
    const shuffled = allActions.sort(() => Math.random() - 0.5);
    livenessActions = shuffled.slice(0, 2);
    
    livenessProgress = {};
    livenessActions.forEach(action => {
        livenessProgress[action] = { completed: false, count: 0, required: action === 'nod' ? 1 : 2 };
    });
    
    livenessCheckPassed = false;
    
    // ÈáçÁΩÆÊâÄÊúâÊ£ÄÊµãÁä∂ÊÄÅ
    blinkCount = 0;
    lastEyeState = 'open';
    eyeClosedFrames = 0;
    mouthOpenCount = 0;
    lastMouthState = 'closed';
    headPositions = [];
    nodCount = 0;
    
    // üî•ÈáçÁΩÆÂä®ÊÄÅÈòàÂÄºÁõ∏ÂÖ≥ÂèòÈáè
    baselineEAR = null;
    earSamples = [];
    
    console.log('üé≤ Ê¥ª‰ΩìÊ£ÄÊµãÂ∑≤ÂàùÂßãÂåñÔºåÈúÄË¶ÅÂÆåÊàê:', livenessActions);
}

// Áú®ÁúºÊ£ÄÊµã
function detectBlink(landmarks) {
    if (!livenessActions.includes('blink') || livenessProgress['blink'].completed) {
        return false;
    }
    
    function getEAR(eye) {
        const vertical1 = Math.hypot(eye[1].x - eye[5].x, eye[1].y - eye[5].y);
        const vertical2 = Math.hypot(eye[2].x - eye[4].x, eye[2].y - eye[4].y);
        const horizontal = Math.hypot(eye[0].x - eye[3].x, eye[0].y - eye[3].y);
        return (vertical1 + vertical2) / (2.0 * horizontal);
    }
    
    const leftEye = [
        landmarks.getLeftEye()[0], landmarks.getLeftEye()[1], landmarks.getLeftEye()[2],
        landmarks.getLeftEye()[3], landmarks.getLeftEye()[4], landmarks.getLeftEye()[5]
    ];
    
    const rightEye = [
        landmarks.getRightEye()[0], landmarks.getRightEye()[1], landmarks.getRightEye()[2],
        landmarks.getRightEye()[3], landmarks.getRightEye()[4], landmarks.getRightEye()[5]
    ];
    
    const leftEAR = getEAR(leftEye);
    const rightEAR = getEAR(rightEye);
    const avgEAR = (leftEAR + rightEAR) / 2.0;
    
    // üî•Âä®ÊÄÅÂª∫Á´ãÁùÅÁúºÂü∫ÂáÜÂÄºÔºàÈááÈõÜÂâç10Â∏ßÁöÑÂπ≥ÂùáÂÄºÔºâ
    if (earSamples.length < SAMPLE_SIZE) {
        earSamples.push(avgEAR);
        if (earSamples.length === SAMPLE_SIZE) {
            baselineEAR = earSamples.reduce((a, b) => a + b, 0) / SAMPLE_SIZE;
            console.log(`üëÅÔ∏è ÁùÅÁúºÂü∫ÂáÜÂÄºÂ∑≤Âª∫Á´ã: ${baselineEAR.toFixed(3)}`);
        }
        return false;
    }
    
    // üî•Âä®ÊÄÅÈòàÂÄºÔºöÂü∫ÂáÜÂÄºÁöÑ85%ÔºàÂç≥EAR‰∏ãÈôç15%Êó∂Âà§ÂÆö‰∏∫Èó≠ÁúºÔºâ
    const dynamicThreshold = baselineEAR * 0.85;
    const currentState = avgEAR < dynamicThreshold ? 'closed' : 'open';
    
    // Ë∞ÉËØï‰ø°ÊÅØÔºàÊØè10Â∏ßÊâìÂç∞‰∏ÄÊ¨°Ôºâ
    if (Math.random() < 0.1) {
        console.log(`üëÅÔ∏è EAR: ${avgEAR.toFixed(3)} | Âä®ÊÄÅÈòàÂÄº: ${dynamicThreshold.toFixed(3)} | Áä∂ÊÄÅ: ${currentState}`);
    }
    
    if (currentState === 'closed') {
        eyeClosedFrames++;
    } else {
        if (eyeClosedFrames >= 1 && lastEyeState === 'closed') {
            blinkCount++;
            livenessProgress['blink'].count = blinkCount;
            console.log(`‚úÖ Áú®ÁúºÊ£ÄÊµãÊàêÂäüÔºÅÂΩìÂâç: ${blinkCount}/${livenessProgress['blink'].required}`);
            
            if (blinkCount >= livenessProgress['blink'].required) {
                livenessProgress['blink'].completed = true;
                console.log('‚úÖ‚úÖ Áú®Áúº‰ªªÂä°ÂÆåÊàêÔºÅ');
            }
            
            eyeClosedFrames = 0;
            lastEyeState = 'open';
            return true;
        }
        eyeClosedFrames = 0;
        lastEyeState = 'open';
    }
    
    if (eyeClosedFrames >= 1 && lastEyeState === 'open') {
        lastEyeState = 'closed';
        console.log('üëÅÔ∏è Ê£ÄÊµãÂà∞Èó≠Áúº');
    }
    
    return false;
}

// Âº†Âò¥Ê£ÄÊµã
function detectMouthOpen(landmarks) {
    if (!livenessActions.includes('mouth') || livenessProgress['mouth'].completed) {
        return false;
    }
    
    const mouth = landmarks.getMouth();
    
    const vertical1 = Math.hypot(mouth[13].x - mouth[19].x, mouth[13].y - mouth[19].y);
    const vertical2 = Math.hypot(mouth[14].x - mouth[18].x, mouth[14].y - mouth[18].y);
    const vertical3 = Math.hypot(mouth[15].x - mouth[17].x, mouth[15].y - mouth[17].y);
    const horizontal = Math.hypot(mouth[0].x - mouth[6].x, mouth[0].y - mouth[6].y);
    
    const MAR = (vertical1 + vertical2 + vertical3) / (3.0 * horizontal);
    const MAR_THRESHOLD = 0.5;
    const currentState = MAR > MAR_THRESHOLD ? 'open' : 'closed';
    
    if (lastMouthState === 'closed' && currentState === 'open') {
        lastMouthState = 'open';
    } else if (lastMouthState === 'open' && currentState === 'closed') {
        mouthOpenCount++;
        lastMouthState = 'closed';
        livenessProgress['mouth'].count = mouthOpenCount;
        console.log(`üëÑ Âº†Âò¥Ê£ÄÊµã: ${mouthOpenCount}/${livenessProgress['mouth'].required}`);
        
        if (mouthOpenCount >= livenessProgress['mouth'].required) {
            livenessProgress['mouth'].completed = true;
            console.log('‚úÖ Âº†Âò¥Ê£ÄÊµãÂÆåÊàêÔºÅ');
        }
        
        return true;
    }
    
    return false;
}

// ÁÇπÂ§¥Ê£ÄÊµã
function detectNod(detection) {
    if (!livenessActions.includes('nod') || livenessProgress['nod'].completed) {
        return false;
    }
    
    const box = detection.detection.box;
    const currentY = box.y + box.height / 2;
    
    headPositions.push(currentY);
    if (headPositions.length > 30) {
        headPositions.shift();
    }
    
    if (headPositions.length < 30) {
        return false;
    }
    
    const maxY = Math.max(...headPositions);
    const minY = Math.min(...headPositions);
    const movement = maxY - minY;
    
    if (movement > 30) {
        nodCount++;
        headPositions = [];
        livenessProgress['nod'].count = nodCount;
        console.log(`üîΩ ÁÇπÂ§¥Ê£ÄÊµã: ${nodCount}/${livenessProgress['nod'].required}`);
        
        if (nodCount >= livenessProgress['nod'].required) {
            livenessProgress['nod'].completed = true;
            console.log('‚úÖ ÁÇπÂ§¥Ê£ÄÊµãÂÆåÊàêÔºÅ');
        }
        
        return true;
    }
    
    return false;
}

// Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÂä®‰ΩúÈÉΩÂÆåÊàê
function checkLivenessComplete() {
    const allCompleted = livenessActions.every(action => livenessProgress[action].completed);
    if (allCompleted && !livenessCheckPassed) {
        livenessCheckPassed = true;
        console.log('‚úÖ Ê¥ª‰ΩìÊ£ÄÊµãÂÖ®ÈÉ®ÈÄöËøáÔºÅ');
        return true;
    }
    return false;
}

// Ëé∑ÂèñÊ¥ª‰ΩìÊ£ÄÊµãÊèêÁ§∫ÊñáÊú¨
function getLivenessHintHTML() {
    const actionNames = {
        'blink': 'üëÅÔ∏è Áú®Áúº',
        'mouth': 'üëÑ Âº†Âò¥',
        'nod': 'üîΩ ÁÇπÂ§¥'
    };
    
    let html = '<p class="text-blue-600 font-bold text-lg">Ê¥ª‰ΩìÊ£ÄÊµã</p><div class="mt-2 space-y-1">';
    
    livenessActions.forEach(action => {
        const progress = livenessProgress[action];
        const completed = progress.completed;
        const color = completed ? 'text-green-600' : 'text-blue-600';
        const icon = completed ? '‚úÖ' : '‚è≥';
        
        html += `
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <span class="${color} font-semibold">${icon} ${actionNames[action]}</span>
                <span class="${color} font-bold">${progress.count}/${progress.required}</span>
            </div>
        `;
    });
    
    html += '</div><p class="text-gray-600 mt-2 text-xs">üí° Ëá™ÁÑ∂ÂÆåÊàêÂä®‰ΩúÂç≥ÂèØÔºå‰∏çË¶ÅÂàªÊÑèÂø´ÈÄüÊìç‰Ωú</p>';
    
    return html;
}


// ==================== ‰∫∫ËÑ∏Ê£ÄÊµãÂæ™ÁéØÔºàÂ§öÂ∏ßÈ™åËØÅ + ËØÜÂà´ÈîÅÂÆöÔºâ ====================
async function detectFaceLoop() {
    // üî• ‰øÆÂ§ç1ÔºöÂ¶ÇÊûúÂ∑≤ÁªèËØÜÂà´ÊàêÂäüÔºåÁõ¥Êé•ÈÄÄÂá∫Âæ™ÁéØ
    if (recognitionSuccess) {
        console.log('‚úÖ Â∑≤ËØÜÂà´ÊàêÂäüÔºåÂÅúÊ≠¢Ê£ÄÊµã');
        return;
    }

    // Â¶ÇÊûúÊ£ÄÊµãÂ∑≤ÂÅúÊ≠¢ÔºåÈÄÄÂá∫Âæ™ÁéØ
    if (!faceDetectionRunning) {
        console.log('üõë ‰∫∫ËÑ∏Ê£ÄÊµãÂæ™ÁéØÂ∑≤ÂÅúÊ≠¢');
        return;
    }

    const video = document.getElementById('video');
    const canvas = document.getElementById('faceCanvas');
    const statusElement = document.getElementById('recognitionStatus');

    // Ê£ÄÊü•ËßÜÈ¢ëÊµÅÊòØÂê¶ÊúâÊïà
    if (!video || !video.srcObject) {
        console.error('‚ùå ËßÜÈ¢ëÊµÅÊó†ÊïàÔºåÂÅúÊ≠¢Ê£ÄÊµã');
        faceDetectionRunning = false;
        if (statusElement) {
            statusElement.innerHTML = '<p class="text-red-600 font-semibold">‚ùå ÊëÑÂÉèÂ§¥ËøûÊé•Â§±Ë¥•</p>';
        }
        return;
    }

    const ctx = canvas.getContext('2d');

    try {
        // ========== Á¨¨‰∏ÄÊ≠•ÔºöÊ£ÄÊµã‰∫∫ËÑ∏ ==========
        const detections = await faceapi
            .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                inputSize: 416,
                scoreThreshold: 0.5
            }))
            .withFaceLandmarks()
            .withFaceDescriptors();

        // Ê∏ÖÁ©∫ÁîªÂ∏É
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ========== Á¨¨‰∫åÊ≠•ÔºöÂ§ÑÁêÜÊ£ÄÊµãÁªìÊûú ==========
        if (detections.length > 0) {
            // Ë∞ÉÊï¥ Canvas Â∞∫ÂØ∏‰ª•ÂåπÈÖçËßÜÈ¢ë
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            canvas.width = displaySize.width;
            canvas.height = displaySize.height;

            // Ë∞ÉÊï¥Ê£ÄÊµãÁªìÊûúÂ∞∫ÂØ∏
            const resizedDetections = faceapi.resizeResults(detections, displaySize);

            // ÁªòÂà∂Ê£ÄÊµãÊ°ÜÂíåÂÖ≥ÈîÆÁÇπ
            faceapi.draw.drawDetections(canvas, resizedDetections);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);


            // ========== Á¨¨‰∏âÊ≠•ÔºöÊ¥ª‰ΩìÊ£ÄÊµãÔºàÂú®‰∫∫ËÑ∏ËØÜÂà´‰πãÂâçÔºâ==========
            if (!livenessCheckPassed && resizedDetections.length > 0) {
                const firstDetection = resizedDetections[0];
                const landmarks = firstDetection.landmarks;
                
                // ÊâßË°åÂêÑÈ°πÊ£ÄÊµã
                if (livenessActions.includes('blink')) {
                    detectBlink(landmarks);
                }
                if (livenessActions.includes('mouth')) {
                    detectMouthOpen(landmarks);
                }
                if (livenessActions.includes('nod')) {
                    detectNod(firstDetection);
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàê
                checkLivenessComplete();
                
                // Êõ¥Êñ∞ÊèêÁ§∫
                if (statusElement) {
                    statusElement.innerHTML = getLivenessHintHTML();
                }
            }

            // Â¶ÇÊûúÊ¥ª‰ΩìÊ£ÄÊµãÊú™ÈÄöËøáÔºå‰∏çËøõË°å‰∫∫ËÑ∏ËØÜÂà´
            if (!livenessCheckPassed) {
                if (faceDetectionRunning) {
                    requestAnimationFrame(detectFaceLoop);
                }
                return;
            }

            // ========== Á¨¨ÂõõÊ≠•Ôºö‰∫∫ËÑ∏ËØÜÂà´ÂåπÈÖçÔºàÊ¥ª‰ΩìÊ£ÄÊµãÈÄöËøáÂêéÊâçÊâßË°åÔºâ==========

            if (!labeledDescriptors || labeledDescriptors.length === 0) {
                // Ê≤°ÊúâÂä†ËΩΩ‰∫∫ËÑ∏Â∫ì
                if (statusElement) {
                    statusElement.innerHTML =
                        '<p class="text-red-600 font-semibold">‚ùå ‰∫∫ËÑ∏Â∫ìÊú™Âä†ËΩΩÔºåÊó†Ê≥ïËØÜÂà´<br/><small>ËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï</small></p>';
                }
            } else {
                // ‰ΩøÁî®ËæÉ‰ΩéÁöÑÂåπÈÖçÈòàÂÄºÔºåÂÖàËé∑ÂèñÊâÄÊúâÂèØËÉΩÁöÑÂåπÈÖç
                const MATCH_THRESHOLD = 0.50;
                const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, MATCH_THRESHOLD);
                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                // ========== Á¨¨ÂõõÊ≠•ÔºöÂ§ÑÁêÜËØÜÂà´ÁªìÊûú ==========
                let currentBestMatch = null;
                let currentBestConfidence = 0;
                let minDistance = Infinity;

                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    const distance = result.distance;
                    const confidence = (1 - distance) * 100;
                    
                    minDistance = Math.min(minDistance, distance);

                    if (result.label !== 'unknown' && confidence >= MIN_CONFIDENCE * 100) {
                        // Ëß£ÊûêÂ≠¶Áîü‰ø°ÊÅØ
                        const parts = result.label.split('|');
                        const studentId = parts[0] || '';
                        const name = parts[1] || 'Êú™Áü•';
                        const studentClass = parts[2] || '';

                        console.log(`üéØ Ê£ÄÊµãÂà∞: ${name} (${studentId}) | ÁΩÆ‰ø°Â∫¶: ${confidence.toFixed(1)}% | Ë∑ùÁ¶ª: ${distance.toFixed(3)}`);

                        // ËÆ∞ÂΩïÂà∞Â§öÂ∏ßÈ™åËØÅÈòüÂàó
                        if (!currentBestMatch || confidence > currentBestConfidence) {
                            currentBestMatch = {
                                studentId: studentId,
                                name: name,
                                studentClass: studentClass,
                                confidence: confidence,
                                distance: distance,
                                box: box,
                                label: result.label
                            };
                            currentBestConfidence = confidence;
                        }
                    } else if (result.label !== 'unknown') {
                        const parts = result.label.split('|');
                        const name = parts[1] || 'Êú™Áü•';
                        console.log(`‚ö†Ô∏è ‰ΩéÁΩÆ‰ø°Â∫¶: ${name} | ${confidence.toFixed(1)}% (ÈúÄË¶Å ‚â•${MIN_CONFIDENCE * 100}%)`);
                    }
                });

                // ========== Á¨¨‰∫îÊ≠•ÔºöÂ§öÂ∏ßÈ™åËØÅ ==========
                if (currentBestMatch) {
                    // Ê∑ªÂä†Âà∞ÊúÄËøëÂåπÈÖçÈòüÂàó
                    recentMatches.push({
                        studentId: currentBestMatch.studentId,
                        name: currentBestMatch.name,
                        studentClass: currentBestMatch.studentClass,
                        confidence: currentBestMatch.confidence,
                        timestamp: Date.now()
                    });

                    // Âè™‰øùÁïôÊúÄËøëÁöÑÂ∏ßÊï∞
                    if (recentMatches.length > CONSECUTIVE_FRAMES) {
                        recentMatches.shift();
                    }

                    // Ê£ÄÊü•ÊòØÂê¶ËøûÁª≠ÂåπÈÖç
                    if (recentMatches.length >= CONSECUTIVE_FRAMES) {
                        // Ê£ÄÊü•ÊúÄËøëNÂ∏ßÊòØÂê¶ÈÉΩÊòØÂêå‰∏Ä‰∏™‰∫∫
                        const firstMatch = recentMatches[0];
                        const allSamePerson = recentMatches.every(m => 
                            m.studentId === firstMatch.studentId && 
                            m.confidence >= MIN_CONFIDENCE * 100
                        );

                        if (allSamePerson) {
                            // ========== ËøûÁª≠Â∏ßÈ™åËØÅÈÄöËøáÔºÅ==========
                            const avgConfidence = (recentMatches.reduce((sum, m) => sum + m.confidence, 0) / recentMatches.length).toFixed(1);
                            
                            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                            console.log(`‚úÖ ËøûÁª≠ ${CONSECUTIVE_FRAMES} Â∏ßÈ™åËØÅÈÄöËøáÔºÅ`);
                            console.log(`   Â≠¶Áîü: ${firstMatch.name} (${firstMatch.studentId})`);
                            console.log(`   Âπ≥ÂùáÁΩÆ‰ø°Â∫¶: ${avgConfidence}%`);
                            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                            // È™åËØÅÁè≠Á∫ß
                            let isInActiveClass = false;
                            let activeClassNames = [];

                            if (activeSessions.length > 0) {
                                activeSessions.forEach(session => {
                                    const classNames = session.get('classNames') || [session.get('className')];
                                    activeClassNames = activeClassNames.concat(classNames);
                                });
                                isInActiveClass = activeClassNames.includes(firstMatch.studentClass);
                            }

                            if (!isInActiveClass && activeSessions.length > 0) {
                                // ========== ‰∏çÂ±û‰∫éÂΩìÂâçÁ≠æÂà∞Áè≠Á∫ß ==========
                                console.warn(`‚ö†Ô∏è ${firstMatch.name} ‰∏çÂ±û‰∫éÂΩìÂâçÁ≠æÂà∞Áè≠Á∫ß`);

                                // ÁªòÂà∂Ê©ôËâ≤Ë≠¶ÂëäÊ°Ü
                                const drawBox = new faceapi.draw.DrawBox(currentBestMatch.box, {
                                    label: `${firstMatch.name} - ÈùûÂΩìÂâçÁè≠Á∫ß`,
                                    boxColor: '#ff9800',
                                    lineWidth: 3
                                });
                                drawBox.draw(canvas);

                                // ÊòæÁ§∫Ë≠¶ÂëäÊèêÁ§∫
                                if (statusElement) {
                                    statusElement.innerHTML =
                                        `<p class="text-orange-600 font-bold text-lg">
                                            ‚ö†Ô∏è ËØÜÂà´ÊàêÂäüÔºå‰ΩÜ‰∏çÂ±û‰∫éÂΩìÂâçÁ≠æÂà∞Áè≠Á∫ß
                                        </p>
                                        <p class="text-gray-700 mt-2">
                                            ËØÜÂà´ÂßìÂêçÔºö<span class="font-bold">${firstMatch.name}</span><br/>
                                            Â≠¶ÁîüÁè≠Á∫ßÔºö<span class="font-bold text-orange-600">${firstMatch.studentClass}</span><br/>
                                            Âπ≥ÂùáÁΩÆ‰ø°Â∫¶Ôºö<span class="font-bold text-orange-600">${avgConfidence}%</span>
                                        </p>
                                        <p class="text-red-600 mt-2 font-semibold">
                                            ‚ùå ÂΩìÂâçÁ≠æÂà∞Áè≠Á∫ßÔºö${activeClassNames.join('„ÄÅ')}
                                        </p>
                                        <p class="text-gray-600 mt-2 text-sm">
                                            üí° Â¶ÇÊûú‰ø°ÊÅØÊ≠£Á°ÆÔºåËØ∑ËÅîÁ≥ªÊïôÂ∏àÁ°ÆËÆ§Ôºõ<br/>
                                            Â¶ÇÊûúËØÜÂà´ÈîôËØØÔºåËØ∑ÊâãÂä®Â°´ÂÜôÊ≠£Á°Æ‰ø°ÊÅØ
                                        </p>`;
                                }

                                // Ê∏ÖÁ©∫ÂåπÈÖçÈòüÂàóÔºåÁªßÁª≠Ê£ÄÊµã
                                recentMatches = [];

                            } else {
                                // ========== Â±û‰∫éÂΩìÂâçÁ≠æÂà∞Áè≠Á∫ßÔºåËØÜÂà´ÊàêÂäüÔºÅ==========
                                // üî• ‰øÆÂ§ç2ÔºöÁ´ãÂç≥ÂÅúÊ≠¢Ê£ÄÊµã
                                recognitionSuccess = true;
                                faceDetectionRunning = false;

                                // üî•ÈáçÁΩÆÊ¥ª‰ΩìÊ£ÄÊµã
                                livenessCheckPassed = false;
                                livenessActions = [];
                                livenessProgress = {};

                                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                                console.log('‚úÖ ËØÜÂà´ÊàêÂäüÔºÅÂÅúÊ≠¢Ê£ÄÊµãÂæ™ÁéØ');
                                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                                // ÁªòÂà∂ÁªøËâ≤ËØÜÂà´Ê°Ü
                                const drawBox = new faceapi.draw.DrawBox(currentBestMatch.box, {
                                    label: `${firstMatch.name} (${avgConfidence}%)`,
                                    boxColor: '#00ff00',
                                    lineWidth: 4
                                });
                                drawBox.draw(canvas);

                                // Ëá™Âä®Â°´ÂÖÖË°®Âçï
                                const classInput = document.getElementById('stuClass');
                                const idInput = document.getElementById('stuId');
                                const nameInput = document.getElementById('stuName');

                                if (classInput) classInput.value = firstMatch.studentClass;
                                if (idInput) idInput.value = firstMatch.studentId;
                                if (nameInput) nameInput.value = firstMatch.name;

                                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                                if (statusElement) {
                                    statusElement.innerHTML =
                                        `<p class="text-green-600 font-bold text-xl animate-pulse">
                                            ‚úÖ ËØÜÂà´ÊàêÂäüÔºö${firstMatch.name}
                                        </p>
                                        <p class="text-gray-700 mt-2">
                                            üìä Âπ≥ÂùáÁΩÆ‰ø°Â∫¶: <span class="font-bold text-green-600">${avgConfidence}%</span><br/>
                                            üìö Áè≠Á∫ß: ${firstMatch.studentClass}<br/>
                                            ‚úÖ ËøûÁª≠ ${CONSECUTIVE_FRAMES} Â∏ßÈ™åËØÅÈÄöËøá
                                        </p>
                                        <p class="text-blue-600 mt-2 text-sm">
                                            üì∑ Áõ∏Êú∫Â∞ÜÂú® 2 ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
                                        </p>`;
                                }

                                // 2ÁßíÂêéËá™Âä®ÂÖ≥Èó≠Áõ∏Êú∫
                                setTimeout(() => {
                                    console.log('üì∑ 2ÁßíÂêéËá™Âä®ÂÖ≥Èó≠Áõ∏Êú∫...');
                                    stopCamera();
                                    recognitionSuccess = false;  // ÈáçÁΩÆÊ†áÂøó
                                    recentMatches = [];
                                }, 2000);
                                
                                // üî• ‰øÆÂ§ç3ÔºöÁ´ãÂç≥ËøîÂõûÔºå‰∏çÂÜçÊâßË°åÂêéÁª≠‰ª£Á†Å
                                return;
                            }
                        } else {
                            // ‰∏çÊòØÂêå‰∏Ä‰∏™‰∫∫ÔºåÊàñËÄÖÁΩÆ‰ø°Â∫¶‰∏çÁ®≥ÂÆö
                            const uniquePeople = [...new Set(recentMatches.map(m => m.name))];
                            console.log(`‚ö†Ô∏è ÊúÄËøë ${recentMatches.length} Â∏ßÊ£ÄÊµãÂà∞Â§ö‰∫∫: ${uniquePeople.join(', ')}`);
                            
                            // Ê∏ÖÁ©∫ÈòüÂàóÔºåÈáçÊñ∞ÂºÄÂßã
                            recentMatches = [];
                        }
                    }

                    // ========== ÊòæÁ§∫ÂÆûÊó∂ËøõÂ∫¶ ==========
                    if (statusElement) {
                        const progress = recentMatches.length;
                        const needed = CONSECUTIVE_FRAMES;
                        const progressPercent = Math.round((progress / needed) * 100);

                        statusElement.innerHTML =
                            `<p class="text-blue-600 font-bold text-lg">
                                üîç Ê≠£Âú®ËØÜÂà´Ôºö${currentBestMatch.name}
                            </p>
                            <p class="text-gray-700 mt-2">
                                ÂΩìÂâçÁΩÆ‰ø°Â∫¶: <span class="font-bold ${currentBestMatch.confidence >= MIN_CONFIDENCE * 100 ? 'text-green-600' : 'text-orange-600'}">${currentBestMatch.confidence.toFixed(1)}%</span><br/>
                                È™åËØÅËøõÂ∫¶: <span class="font-bold text-blue-600">${progress}/${needed} Â∏ß</span>
                            </p>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                            </div>
                            <p class="text-gray-600 mt-2 text-xs">
                                üí° ‰øùÊåÅÂßøÂäø‰∏çÂä® ${needed - progress} Â∏ß...
                            </p>`;
                    }

                } else {
                    // ÂΩìÂâçÂ∏ßÊ≤°ÊúâÈ´òÁΩÆ‰ø°Â∫¶ÂåπÈÖçÔºåÊ∏ÖÁ©∫ÈòüÂàó
                    if (recentMatches.length > 0) {
                        console.log('‚ö†Ô∏è ÂΩìÂâçÂ∏ßÊó†ÂåπÈÖçÔºåÊ∏ÖÁ©∫È™åËØÅÈòüÂàó');
                        recentMatches = [];
                    }

                    // ÊòæÁ§∫ÂΩìÂâçÁä∂ÊÄÅ
                    if (statusElement) {
                        const confidence = ((1 - minDistance) * 100).toFixed(1);
                        
                        if (minDistance < 0.50) {
                            statusElement.innerHTML =
                                `<p class="text-orange-600 font-semibold text-lg">
                                    ‚ö†Ô∏è Ê£ÄÊµãÂà∞‰∫∫ËÑ∏‰ΩÜÁΩÆ‰ø°Â∫¶‰∏çÁ®≥ÂÆö
                                </p>
                                <p class="text-gray-700 mt-2">
                                    ÂΩìÂâçÁΩÆ‰ø°Â∫¶: <span class="text-orange-600 font-bold">${confidence}%</span><br/>
                                    ÈúÄË¶ÅÁΩÆ‰ø°Â∫¶: <span class="text-green-600 font-bold">‚â• ${MIN_CONFIDENCE * 100}%</span>
                                </p>
                                <p class="text-gray-600 mt-2 text-sm">
                                    üí° Âª∫ËÆÆÔºö<br/>
                                    ‚úì ‰øùÊåÅÂßøÂäø‰∏çÂä®<br/>
                                    ‚úì Ê≠£ÂØπÊëÑÂÉèÂ§¥<br/>
                                    ‚úì Ë∞ÉÊï¥ÂÖâÁ∫ø
                                </p>`;
                        } else if (minDistance < 0.7) {
                            statusElement.innerHTML =
                                `<p class="text-orange-600 font-semibold">
                                    ‚ö†Ô∏è Ê£ÄÊµãÂà∞‰∫∫ËÑ∏‰ΩÜÊú™ÊâæÂà∞ÂåπÈÖç
                                </p>
                                <p class="text-gray-700 mt-2">
                                    Áõ∏‰ººÂ∫¶: <span class="text-red-600 font-bold">${confidence}%</span>ÔºàËøá‰ΩéÔºâ
                                </p>
                                <p class="text-gray-600 mt-2 text-sm">
                                    ‚úì Á°Æ‰øùÂ∑≤ÂΩïÂÖ•ÁÖßÁâá<br/>
                                    ‚úì Ê≠£ÂØπÊëÑÂÉèÂ§¥<br/>
                                    ‚úì ÂÖâÁ∫øÂÖÖË∂≥
                                </p>`;
                        } else {
                            statusElement.innerHTML =
                                `<p class="text-red-600 font-semibold">
                                    ‚ùå Ê£ÄÊµãÂà∞‰∫∫ËÑ∏‰ΩÜÂ∑ÆÂºÇËøáÂ§ß
                                </p>
                                <p class="text-gray-700 mt-2">
                                    Áõ∏‰ººÂ∫¶: <span class="text-red-600 font-bold">${confidence}%</span>
                                </p>
                                <p class="text-gray-600 mt-2 text-sm">
                                    üí° ËØ∑ÊâãÂä®Â°´ÂÜô‰ø°ÊÅØÔºåÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëòÂΩïÂÖ•ÁÖßÁâá
                                </p>`;
                        }
                    }
                }
            }

        } else {
            // ========== Êú™Ê£ÄÊµãÂà∞‰∫∫ËÑ∏ ==========
            if (recentMatches.length > 0) {
                recentMatches = [];
            }

            if (statusElement) {
                statusElement.innerHTML =
                    `<p class="text-blue-600 font-semibold">
                        üîç Êú™Ê£ÄÊµãÂà∞‰∫∫ËÑ∏ÔºåËØ∑Ë∞ÉÊï¥‰ΩçÁΩÆ...
                    </p>
                    <p class="text-gray-600 mt-2 text-sm">
                        ‚úì Èù¢ÈÉ®Ê≠£ÂØπÊëÑÂÉèÂ§¥<br/>
                        ‚úì ‰øùÊåÅÈÄÇÂΩìË∑ùÁ¶ª<br/>
                        ‚úì ÂÖâÁ∫øÂÖÖË∂≥
                    </p>`;
            }
        }

        // ========== Á¨¨ÂÖ≠Ê≠•ÔºöÁªßÁª≠Ê£ÄÊµãÂæ™ÁéØ ==========
        if (faceDetectionRunning) {
            requestAnimationFrame(detectFaceLoop);
        }

    } catch (error) {
        console.error('‚ùå ‰∫∫ËÑ∏Ê£ÄÊµãÈîôËØØ:', error);

        const statusElement = document.getElementById('recognitionStatus');
        if (statusElement) {
            statusElement.innerHTML =
                `<p class="text-red-600 font-semibold">
                    ‚ùå Ê£ÄÊµãÂá∫Èîô: ${error.message}
                    <br/><small>ÁªßÁª≠Â∞ùËØï‰∏≠...</small>
                </p>`;
        }

        if (faceDetectionRunning) {
            requestAnimationFrame(detectFaceLoop);
        }
    }
}


        // Stop camera
        function stopCamera() {
            faceDetectionRunning = false;
            recognitionSuccess = false; // ÈáçÁΩÆËØÜÂà´ÊàêÂäüÊ†áÂøó

            // üî•ÈáçÁΩÆÊ¥ª‰ΩìÊ£ÄÊµã
            livenessCheckPassed = false;
            livenessActions = [];
            livenessProgress = {};
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('faceCanvas');
            const ctx = canvas.getContext('2d');
            
            video.classList.add('hidden');
            canvas.classList.add('hidden');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            
            document.getElementById('cameraBtn').textContent = 'üì∑ ÊâìÂºÄÁõ∏Êú∫Ôºà‰∫∫ËÑ∏ËØÜÂà´Ôºâ';
            document.getElementById('cameraBtn').onclick = openCamera;
        }

        // Submit check-in - ÊîØÊåÅÂ§öÁè≠Á∫ßÁ≠æÂà∞
        // Submit check-in - Â≠¶ÁîüÁ≠æÂà∞Ôºà‰øÆÂ§çÁâàÔºâ
        async function submitCheckIn() {
            const className = document.getElementById('stuClass').value;
            const studentId = document.getElementById('stuId').value;
            const name = document.getElementById('stuName').value;
            const location = document.getElementById('location').value;

            // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
            if (!className || !studentId || !name) {
                alert('‚ùå ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØÔºö\n\n‚úì Áè≠Á∫ß\n‚úì Â≠¶Âè∑\n‚úì ÂßìÂêç');
                return;
            }

            // Â§ÑÁêÜÂÆö‰Ωç‰ø°ÊÅØÔºàÂèØÈÄâÔºâ
            let finalLocation = location;
            if (!location || location.includes('Ê≠£Âú®Ëé∑Âèñ')) {
                finalLocation = 'Êú™Ëé∑ÂèñÂÆö‰Ωç';
                if (!confirm('‚ö†Ô∏è ÊÇ®ËøòÊú™Ëé∑ÂèñÂÆö‰Ωç‰ø°ÊÅØ\n\nÊòØÂê¶ÁªßÁª≠Á≠æÂà∞Ôºü')) {
                    return;
                }
            } else if (location.includes('ÂÆö‰ΩçÂ§±Ë¥•') || location.includes('‰∏çÊîØÊåÅÂÆö‰Ωç')) {
                finalLocation = location;
            }

            try {
                console.log('üîç ÂºÄÂßãÁ≠æÂà∞ÊµÅÁ®ã...');
                console.log('Â≠¶Áîü‰ø°ÊÅØ:', { className, studentId, name });

                // Step 1: Êü•ÊâæËøõË°å‰∏≠ÁöÑÁ≠æÂà∞‰ºöËØù
                const sessionQuery = new AV.Query('CheckInSession');
                sessionQuery.equalTo('status', 'active');
                sessionQuery.descending('createdAt');
                sessionQuery.limit(100); // Ëé∑ÂèñÊõ¥Â§ö‰ºöËØù‰ª•‰æøÂåπÈÖç
                const sessions = await sessionQuery.find();

                console.log(`‚úÖ ÊâæÂà∞ ${sessions.length} ‰∏™Ê¥ªÂä®Á≠æÂà∞‰ºöËØù`);

                // Step 2: Êü•ÊâæÂåÖÂê´ËØ•Áè≠Á∫ßÁöÑÁ≠æÂà∞‰ºöËØù
                let matchedSession = null;
                for (let session of sessions) {
                    const classNames = session.get('classNames') || [session.get('className')];
                    console.log('Ê£ÄÊü•‰ºöËØùÁè≠Á∫ß:', classNames);
                    
                    if (classNames.includes(className)) {
                        matchedSession = session;
                        console.log('‚úÖ ÊâæÂà∞ÂåπÈÖçÁöÑÁ≠æÂà∞‰ºöËØù:', session.id);
                        break;
                    }
                }

                if (!matchedSession) {
                    console.error('‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÁ≠æÂà∞‰ºöËØù');
                    alert(`‚ùå ÂΩìÂâçÊ≤°Êúâ„Äê${className}„ÄëÁöÑÁ≠æÂà∞‰ªªÂä°\n\nÂèØËÉΩÂéüÂõ†Ôºö\n‚úì ÊïôÂ∏àËøòÊú™ÂºÄÂßãÁ≠æÂà∞\n‚úì Á≠æÂà∞Â∑≤ÁªìÊùü\n‚úì Áè≠Á∫ßÂêçÁß∞‰∏çÂåπÈÖç\n\nËØ∑ËÅîÁ≥ªÊïôÂ∏àÁ°ÆËÆ§`);
                    return;
                }

                const sessionId = matchedSession.id;
                const courseName = matchedSession.get('courseName');
                const courseSession = matchedSession.get('courseSession');

                // Step 3: Ê£ÄÊü•ÊòØÂê¶Â∑≤Á≠æÂà∞
                const recordQuery = new AV.Query('CheckInRecord');
                recordQuery.equalTo('sessionId', sessionId);
                recordQuery.equalTo('studentId', studentId);
                const existing = await recordQuery.first();

                if (existing) {
                    const existingTime = existing.get('checkInTime');
                    console.warn('‚ö†Ô∏è Â≠¶ÁîüÂ∑≤Á≠æÂà∞Ëøá');
                    alert(`‚ö†Ô∏è ÊÇ®Â∑≤Á≠æÂà∞ËøáÔºåÊó†ÈúÄÈáçÂ§çÁ≠æÂà∞ÔºÅ\n\nËØæÁ®ãÔºö${courseName}\nÊó∂Èó¥Ôºö${new Date(existingTime).toLocaleString()}`);
                    return;
                }

                // Step 4: ÂàõÂª∫Á≠æÂà∞ËÆ∞ÂΩïÔºà‰ªÖÂàõÂª∫ CheckInRecordÔºå‰∏çÂàõÂª∫ SessionÔºÅÔºâ
                const CheckInRecord = AV.Object.extend('CheckInRecord');
                const record = new CheckInRecord();
                record.set('sessionId', sessionId);
                record.set('className', className);
                record.set('studentId', studentId);
                record.set('studentName', name);
                record.set('location', finalLocation);
                record.set('checkInTime', new Date());
                await record.save();

                console.log('‚úÖ Á≠æÂà∞ËÆ∞ÂΩïÂàõÂª∫ÊàêÂäü:', record.id);

                // ÊàêÂäüÊèêÁ§∫
                alert(`‚úÖ Á≠æÂà∞ÊàêÂäüÔºÅ\n\nËØæÁ®ãÔºö${courseName}\nËäÇÊ¨°Ôºö${courseSession}\nÂßìÂêçÔºö${name}\nÂ≠¶Âè∑Ôºö${studentId}\nÁè≠Á∫ßÔºö${className}\nÊó∂Èó¥Ôºö${new Date().toLocaleString()}\n‰ΩçÁΩÆÔºö${finalLocation}`);

                // Ê∏ÖÁ©∫Ë°®Âçï
                document.getElementById('stuClass').value = '';
                document.getElementById('stuId').value = '';
                document.getElementById('stuName').value = '';
                document.getElementById('location').value = '';
                document.getElementById('recognitionStatus').classList.add('hidden');
                
                // ÂÖ≥Èó≠Áõ∏Êú∫
                if (videoStream) {
                    stopCamera();
                }

            } catch (error) {
                console.error('‚ùå Á≠æÂà∞Â§±Ë¥•:', error);
                
                // ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
                let errorMsg = 'Á≠æÂà∞Â§±Ë¥•';
                let suggestion = '';
                
                if (error.code === 101) {
                    errorMsg = 'Á≠æÂà∞Á≥ªÁªüÂ∞öÊú™ÂàùÂßãÂåñ';
                    suggestion = 'ËØ∑ËÅîÁ≥ªÊïôÂ∏àÁ°ÆËÆ§Á≠æÂà∞ÊòØÂê¶Â∑≤ÂºÄÂßã';
                } else if (error.code === 401 || error.code === 403) {
                    errorMsg = 'ÊùÉÈôêÈ™åËØÅÂ§±Ë¥•';
                    suggestion = 'ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÔºåÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò';
                } else if (error.message.includes('timeout')) {
                    errorMsg = 'ÁΩëÁªúË∂ÖÊó∂';
                    suggestion = 'ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï';
                } else {
                    errorMsg = error.message;
                    suggestion = 'ËØ∑Á®çÂêéÈáçËØï';
                }
                
                alert(`‚ùå ${errorMsg}\n\n${suggestion}\n\nÊäÄÊúØ‰ø°ÊÅØÔºö${error.code || 'Êú™Áü•'}`);
            }
        }


        // ==================== ÂÄíËÆ°Êó∂ÂäüËÉΩ ====================
        let countdownInterval = null;

        function setupCountdown(minutes) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÄíËÆ°Êó∂
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            const countdownElement = document.getElementById('countdown');
            if (!countdownElement) {
                console.warn('‚ö†Ô∏è ÂÄíËÆ°Êó∂ÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                return;
            }

            let remainingSeconds = minutes * 60;

            // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°
            updateCountdownDisplay(remainingSeconds, countdownElement);

            // ÊØèÁßíÊõ¥Êñ∞
            countdownInterval = setInterval(() => {
                remainingSeconds--;

                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    countdownElement.textContent = '‚è∞ Á≠æÂà∞Êó∂Èó¥Â∑≤Âà∞';
                    countdownElement.className = 'text-red-600 font-bold animate-pulse';
                    
                    // Êí≠ÊîæÊèêÁ§∫Èü≥
                    if (typeof playCheckInSound === 'function') {
                        playCheckInSound();
                    }
                    
                    console.log('‚è∞ Á≠æÂà∞Êó∂Èó¥Â∑≤Âà∞');
                    return;
                }

                updateCountdownDisplay(remainingSeconds, countdownElement);
            }, 1000);

            console.log(`‚è±Ô∏è ÂÄíËÆ°Êó∂Â∑≤ËÆæÁΩÆ: ${minutes} ÂàÜÈíü`);
        }

        function updateCountdownDisplay(seconds, element) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timeString = `${minutes}:${secs.toString().padStart(2, '0')}`;
            
            element.textContent = `‚è±Ô∏è Ââ©‰ΩôÊó∂Èó¥: ${timeString}`;
            
            // Ê†πÊçÆÂâ©‰ΩôÊó∂Èó¥ÊîπÂèòÈ¢úËâ≤
            if (seconds <= 60) {
                element.className = 'text-red-600 font-bold animate-pulse';
            } else if (seconds <= 300) {
                element.className = 'text-orange-600 font-bold';
            } else {
                element.className = 'text-green-600 font-bold';
            }
        }


    </script>
</body>
</html>                    