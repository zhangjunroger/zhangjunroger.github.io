
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è€ƒè¯•åº§ä½å®‰æ’ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-blue-50 to-blue-100 min-h-screen p-8">
<div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold text-blue-700 mb-8 text-center">è€ƒè¯•åº§ä½å®‰æ’ç³»ç»Ÿ</h1>

    <!-- å®æ—¶è€ƒè¯•ä¿¡æ¯é¢æ¿ -->
    <div id="examTimePanel" class="hidden bg-white rounded-lg shadow-lg p-6 mb-8 border-l-4 border-blue-500">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">å½“å‰æ—¶é—´</h3>
                <div id="currentTime" class="text-2xl font-mono text-blue-600"></div>
            </div>
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">è€ƒè¯•å€’è®¡æ—¶</h3>
                <div id="countdown" class="text-2xl font-mono text-red-600"></div>
                <div id="examStatus" class="text-sm text-gray-600 mt-1"></div>
            </div>
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">è¯­éŸ³è®¾ç½®</h3>
                <div class="space-y-2">
                    <button id="voiceToggle" onclick="toggleVoice()" class="w-full px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">
                        ğŸ”Š è¯­éŸ³å¼€å¯
                    </button>
                    <select id="voiceSelect" class="w-full p-1 border rounded text-sm" onchange="changeVoice()">
                        <option value="">é€‰æ‹©è¯­éŸ³...</option>
                    </select>
                </div>
            </div>
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">è¯­éŸ³æµ‹è¯•</h3>
                <div class="space-y-2">
                    <button onclick="testVoice()" class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                        ğŸµ æµ‹è¯•è¯­éŸ³
                    </button>
                    <div id="voiceStatus" class="text-xs text-gray-600">è¯­éŸ³æç¤ºå·²å¯ç”¨</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- å·¦ä¾§ï¼šé…ç½®é¢æ¿ -->
        <div class="bg-white rounded-lg shadow p-6 space-y-6">
            <!-- è€ƒè¯•è¯¾ç¨‹é€‰æ‹© -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒè¯•è¯¾ç¨‹</label>
                <select id="courseSelect" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                    <option value="">-- è¯·é€‰æ‹©è¯¾ç¨‹ --</option>
                </select>
            </div>

            <!-- å­¦ç”Ÿç­çº§é€‰æ‹© -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å­¦ç”Ÿç­çº§</label>
                
                <!-- ç¬¬ä¸€ä¸ªç­çº§ -->
                <div class="mb-3">
                    <select id="classSelect1" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                        <option value="">-- è¯·é€‰æ‹©ç¬¬ä¸€ä¸ªç­çº§ --</option>
                    </select>
                    <p class="text-sm text-gray-600 mt-1">ç­çº§1äººæ•°ï¼š<span id="studentCount1">0</span> äºº</p>
                </div>
                
                <!-- ç¬¬äºŒä¸ªç­çº§ï¼ˆå¯é€‰ï¼‰ -->
                <div class="mb-3">
                    <select id="classSelect2" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-purple-400">
                        <option value="">-- ç¬¬äºŒä¸ªç­çº§ï¼ˆå¯é€‰ï¼‰ --</option>
                    </select>
                    <p class="text-sm text-gray-600 mt-1">ç­çº§2äººæ•°ï¼š<span id="studentCount2">0</span> äºº</p>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg text-sm">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-blue-800">æ€»äººæ•°ï¼š<span id="totalStudentCount">0</span> äºº</span>
                        <button onclick="clearClasses()" class="text-blue-600 hover:text-blue-800 text-xs">æ¸…ç©ºé€‰æ‹©</button>
                    </div>
                </div>
            </div>

            <!-- è€ƒåœºé€‰æ‹© -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒåœº</label>
                <select id="roomSelect" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                    <option value="">-- è¯·é€‰æ‹©è€ƒåœº --</option>
                </select>
            </div>

            <!-- å½“å‰è€ƒåœºè¡Œåˆ—æ˜¾ç¤ºå’Œç¼–è¾‘ -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¡Œæ•°</label>
                    <input id="rowInput" type="number" min="1"
                           class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åˆ—æ•°</label>
                    <input id="colInput" type="number" min="1"
                           class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                </div>
            </div>

            <!-- æ˜¾ç¤ºæ–¹å¼ -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">åº§ä½æ˜¾ç¤ºæ–¹å¼</label>
                <div class="space-y-1">
                    <label class="flex items-center">
                        <input type="radio" name="showMode" value="last3" checked class="mr-2">å­¦å·å3ä½
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="showMode" value="last5" class="mr-2">å­¦å·å5ä½
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="showMode" value="name" class="mr-2">å§“å
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="showMode" value="seq" class="mr-2">åºå·
                    </label>
                </div>
            </div>

            <!-- åŒç­çº§æ··åˆé€‰é¡¹ -->
            <div id="mixingOptions" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">åŒç­çº§æ’åº§æ–¹å¼</label>
                <div class="space-y-1">
                    <label class="flex items-center">
                        <input type="radio" name="mixMode" value="random" checked class="mr-2">éšæœºæ··åˆ
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="mixMode" value="alternate" class="mr-2">äº¤æ›¿æ’åˆ—
                        <span class="ml-1 text-xs text-gray-500">(åº§ä½é—´äº¤æ›¿)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="mixMode" value="separate" class="mr-2">å·¦å³åˆ†åŒºæ’åˆ—
                        <span class="ml-1 text-xs text-gray-500">(å·¦è¾¹ç­çº§1ï¼Œå³è¾¹ç­çº§2)</span>
                    </label>
                </div>
            </div>

            <button onclick="generateSeating()"
                    class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                ç”Ÿæˆåº§ä½è¡¨
            </button>

            <!-- å¯¼å‡ºæŒ‰é’® -->
            <div id="exportButtons" class="hidden space-y-2">
                <button onclick="exportToExcel()" 
                        class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    å¯¼å‡ºExcel
                </button>
                <button onclick="printSeating()" 
                        class="w-full py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    æ‰“å°åº§ä½è¡¨
                </button>
            </div>
        </div>

        <!-- å³ä¾§ï¼šé¢„è§ˆ -->
        <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">åº§ä½å®‰æ’é¢„è§ˆ</h2>
            <div id="examInfo" class="mb-4 p-4 bg-gray-50 rounded-lg"></div>
            <div id="seatingChart" class="overflow-auto"></div>
        </div>
    </div>
</div>

<script>
/* ---------- å®Œæ•´é¢„è®¾æ•°æ® ---------- */

// é¢„è®¾è¯¾ç¨‹
const courses = [
    {
        id: 'auto-control',
        name: 'è‡ªåŠ¨æ§åˆ¶åŸç†',
        time: '2025-06-27 13:30-15:05',
        duration: '95åˆ†é’Ÿ'
    }
];

// é¢„è®¾ç­çº§å’Œå®Œæ•´å­¦ç”Ÿä¿¡æ¯
const studentClasses = [
    {
        id: 'ai2023130101',
        name: 'æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2023çº§01ç­',
        students: [
            {id: '230502115', name: 'å­™é›¨ä½³'}, {id: '230502121', name: 'å¢æŸå¦'}, {id: '230503113', name: 'å¼ æ¸…å®‡'},
            {id: '231301101', name: 'å´ç§‰éœ–'}, {id: '231301102', name: 'å´å½­è¿œ'}, {id: '231301103', name: 'ç‹è¯­èª'},
            {id: '231301104', name: 'æ»¡ä¾æ­'}, {id: '231301105', name: 'é»„ä¿ŠèŒ—'}, {id: '231301106', name: 'å¼ ç£Š'},
            {id: '231301107', name: 'è‘›å³»'}, {id: '231301108', name: 'é»„å­æ—'}, {id: '231301109', name: 'æä½³æ¯…'},
            {id: '231301112', name: 'æ®·å´‡èµ«'}, {id: '231301113', name: 'é»„ç…Šå„’'}, {id: '231301114', name: 'é™ˆå»ºè˜'},
            {id: '231301115', name: 'åˆ˜è¿›è¶…'}, {id: '231301116', name: 'é»„æ–‡å‡¯'}, {id: '231301117', name: 'æ¨é”'},
            {id: '231301118', name: 'æ¨ä½³ç¦'}, {id: '231301119', name: 'ç™½ç§‹è'}, {id: '231301120', name: 'å‡Œæ–‡å“'},
            {id: '231301121', name: 'èµµæ¢“æ™—'}, {id: '231301122', name: 'é¢œè¹'}, {id: '231301123', name: 'ç‹æ…§é‘«'},
            {id: '211301301', name: 'å­™åé˜³'}, {id: '211301309', name: 'é™†æ¶›'}, {id: '211301311', name: 'èƒ¡å´‡å‘¨'},
            {id: '221301112', name: 'æ¨å†€é¾™'}, {id: '221301122', name: 'è°­è¥¿æ•'}, {id: '221301202', name: 'é©¬ç¡•'},
            {id: '221301206', name: 'å†¯åš'}, {id: '221301215', name: 'èµµä½³ä¹'}, {id: '221301218', name: 'å¾é“­ç '},
            {id: '221301304', name: 'å¼ é’°çª'}, {id: '221301307', name: 'è«å®‡æ°'}
        ]
    },
    {
        id: 'ai2023130102',
        name: 'æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2023çº§02ç­',
        students: [
            {id: '230501230', name: 'è¢ä½³'}, {id: '231002216', name: 'å¾ç­ èˆ’'}, {id: '231301201', name: 'æè‘‰æ³½'},
            {id: '231301202', name: 'å¼ é¾™å¤'}, {id: '231301203', name: 'é©¬è‚‡åŒ—'}, {id: '231301204', name: 'ç§¦ç¡•'},
            {id: '231301205', name: 'å¯Œé¹åš'}, {id: '231301206', name: 'ç‹æ˜±æ‡¿'}, {id: '231301207', name: 'æå®‡å®¸'},
            {id: '231301208', name: 'è´¾æ˜¥æ—º'}, {id: '231301209', name: 'é™ˆé¹åš'}, {id: '231301210', name: 'é‚µå­æœ—'},
            {id: '231301211', name: 'éƒ‘ä¼˜'}, {id: '231301212', name: 'é™ˆæ¾ç‡š'}, {id: '231301213', name: 'ç¥æ¬£å®'},
            {id: '231301214', name: 'åˆ˜ä¿Šç†™'}, {id: '231301215', name: 'å‘¨é©°ä¼Ÿ'}, {id: '231301217', name: 'èµµä¸€éœ–'},
            {id: '231301218', name: 'æœç¿˜æ¥š'}, {id: '231301219', name: 'æŸ´å°å–†'}, {id: '231301220', name: 'å¼ å‚²é›ª'},
            {id: '231301221', name: 'å•èˆª'}, {id: '231301222', name: 'é‚¬å˜‰èª‰'}, {id: '231301223', name: 'é»„å©·'}
        ]
    },
    {
        id: 'ai2023130103',
        name: 'æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2023çº§03ç­',
        students: [
            {id: '231301301', name: 'åˆ˜å¿—ç¿”'}, {id: '231301302', name: 'æéŸ«ä¸'}, {id: '231301303', name: 'é©¬ä»•åš'},
            {id: '231301304', name: 'å¨„å˜‰'}, {id: '231301305', name: 'é™¶å‰‘å—'}, {id: '231301306', name: 'é¡¾å¿—æˆ'},
            {id: '231301307', name: 'å´å¤§å‘¨'}, {id: '231301308', name: 'æ¢å¤©é˜³'}, {id: '231301309', name: 'ç‹æ™¯çš“'},
            {id: '231301310', name: 'å¼ å¿ æ©'}, {id: '231301311', name: 'å‘å»¶æµ©'}, {id: '231301312', name: 'æ®µå®¶æ˜Œ'},
            {id: '231301313', name: 'å…‹ç„¶Â·å“ˆåˆ«å…‹'}, {id: '231301314', name: 'åŠªåŠ›æ‰æÂ·åŠªåŠ›ä¹°ä¹°æ'}, {id: '231301315', name: 'ç¿Ÿä½³ä¿Š'},
            {id: '231301316', name: 'é˜¿åœæœç“¦æ—¥æ–¯Â·å·´æ‹‰æå°¼äºšå­œ'}, {id: '231301317', name: 'ç‹äº‘è²'}, {id: '231301318', name: 'éš‹æ–°ä»ª'},
            {id: '231301319', name: 'éœæ—æ€¡'}, {id: '231301320', name: 'å§œåœ£æ´'}, {id: '231301321', name: 'ç‹å¦ä¸¹'},
            {id: '231301322', name: 'å®‰å‡¤å¨‡'}, {id: '231301323', name: 'ææ¬£ç‘¶'}
        ]
    },
    {
        id: 'ai2023130301',
        name: 'å·¥ä¸šæ™ºèƒ½2023çº§01ç­',
        students: [
            {id: '221303221', name: 'é™ˆæŸéœ–'}, {id: '231303101', name: 'åŠé¹¤ç«£'}, {id: '231303102', name: 'å´ç•¥é”Ÿ'},
            {id: '231303103', name: 'èµµç¦¹ç¨‹'}, {id: '231303104', name: 'é™ˆé˜³'}, {id: '231303105', name: 'æå“'},
            {id: '231303106', name: 'å®‹æµ·æ¥ '}, {id: '231303107', name: 'å¼ºæ˜±æ™´'}, {id: '231303108', name: 'ç‹ä¸œæ—¶'},
            {id: '231303109', name: 'æå‡¯å¹³'}, {id: '231303111', name: 'å´ä»é£'}, {id: '231303112', name: 'å‘¨å…‹ç†™'},
            {id: '231303113', name: 'èµµå®‡æ™¨'}, {id: '231303114', name: 'æˆ´é™ˆ'}, {id: '231303115', name: 'é™ˆæµåŸ¹'},
            {id: '231303116', name: 'åˆ˜çƒ¨'}, {id: '231303117', name: 'ä¸¥æ¦•è€€'}, {id: '231303118', name: 'å´æ˜Ÿç£Š'},
            {id: '231303119', name: 'æ—å…´ä¸¹'}, {id: '231303120', name: 'è«å­ç…Š'}, {id: '231303121', name: 'ç†Šæµ©ç„¶'},
            {id: '231303122', name: 'é™ˆåšå„’'}, {id: '231303123', name: 'å´é¾™'}, {id: '231303124', name: 'å¼ è¯—èŒ¹'},
            {id: '231303126', name: 'èµµå©‰ä¼Š'}, {id: '231303127', name: 'ç‹ä½³è•Š'}, {id: '231303128', name: 'æˆ¿æ–‡é™'},
            {id: '231303129', name: 'å´æ‰¬ä¿ª'}, {id: '231303130', name: 'å‘åŒçº¢'}, {id: '211303104', name: 'ç‹å®å®‡'},
            {id: '211303109', name: 'åˆ˜å²©æ¾'}, {id: '211303207', name: 'åˆ˜ä¸–åš'}, {id: '211303230', name: 'é™ˆä¸½äº‘'},
            {id: '221303121', name: 'æé«˜å¿—'}, {id: '221303123', name: 'ç§¦ä¸€'}, {id: '221303130', name: 'æ¢…ç‰å…°'},
            {id: '221303203', name: 'å¼ å®‡èˆª'}, {id: '221303217', name: 'ä½•æ³½æ–Œ'}, {id: '221303218', name: 'é›·è€€å¤©'}
        ]
    },    
    {
        id: 'ai2023130302',
        name: 'å·¥ä¸šæ™ºèƒ½2023çº§02ç­',
        students: [
            {id: '211303214', name: 'è‘£å»ºåº'}, {id: '230502223', name: 'ç‹æ–‡é™'}, {id: '230801215', name: 'ç‹æ–‡åš'},
            {id: '231303201', name: 'ç™½å®‡'}, {id: '231303202', name: 'èƒ¡éŸ¶å'}, {id: '231303203', name: 'ç‹æ‰¿è¾‰'},
            {id: '231303204', name: 'è–›åšæ–‡'}, {id: '231303205', name: 'ç‹å¥ç¿”'}, {id: '231303206', name: 'é™ˆè‹±åŒ'},
            {id: '231303207', name: 'è¢ä¾¨äº¨'}, {id: '231303208', name: 'è‘›ä¸–å¤'}, {id: '231303209', name: 'éŸ©ä½³è®¯'},
            {id: '231303210', name: 'ç‹æŸ„ç„¶'}, {id: '231303211', name: 'å¸¸å®å®‰'}, {id: '231303212', name: 'ç‹å½¬'},
            {id: '231303213', name: 'å»–æµ·æ¶›'}, {id: '231303214', name: 'è”¡å¿—é¹'}, {id: '231303215', name: 'é«˜ç„•ä¸œ'},
            {id: '231303216', name: 'é‚±ç›…æ·‡'}, {id: '231303217', name: 'æ±Ÿå°å·'}, {id: '231303218', name: 'å†¯æ„‰'},
            {id: '231303219', name: 'æ±Ÿå®‡èˆª'}, {id: '231303220', name: 'é©¬å¿—å‡Œ'}, {id: '231303221', name: 'ææ‰¬'},
            {id: '231303222', name: 'é™ˆè‚¸'}, {id: '231303223', name: 'æå¼€å³°'}, {id: '231303224', name: 'é²å…´è¶…'},
            {id: '231303225', name: 'ä¾¯ç‰æ¶µ'}, {id: '231303226', name: 'æåŠ²æŸ“'}, {id: '231303227', name: 'åˆ˜æ½‡é›¯'},
            {id: '231303229', name: 'è£´æ‚¦ç„¶'}, {id: '231303230', name: 'å‘é¹é“®'}
        ]
    }   
];

// é¢„è®¾è€ƒåœº
const rooms = [
    {id: 'B104', name: 'æ•™å­¦æ¥¼B104', rows: 8, cols: 5},
    {id: 'B105', name: 'æ•™å­¦æ¥¼B105', rows: 7, cols: 5},
    {id: 'B106', name: 'æ•™å­¦æ¥¼B106', rows: 7, cols: 5},
    {id: 'B109', name: 'æ•™å­¦æ¥¼B109', rows: 12, cols: 6}    
];

let currentStudents1 = [];
let currentStudents2 = [];
let currentSeating = null;

// æ—¶é—´å’Œè¯­éŸ³ç›¸å…³å˜é‡
let examTimer = null;
let voiceEnabled = true;
let voiceAlerts = [30, 20, 10, 5]; // æé†’æ—¶é—´ç‚¹ï¼ˆåˆ†é’Ÿï¼‰
let alertedTimes = new Set(); // å·²æé†’çš„æ—¶é—´ç‚¹
let availableVoices = [];
let selectedVoice = null;

/* ---------- åˆå§‹åŒ– ---------- */
function init() {
    refreshCourseSelect();
    refreshClassSelect();
    refreshRoomSelect();
    startRealTimeClock();
    loadVoices();
}

// åŠ è½½å¯ç”¨è¯­éŸ³
function loadVoices() {
    if ('speechSynthesis' in window) {
        // ç­‰å¾…è¯­éŸ³åŠ è½½å®Œæˆ
        const loadVoicesTimer = setInterval(() => {
            availableVoices = speechSynthesis.getVoices();
            if (availableVoices.length > 0) {
                clearInterval(loadVoicesTimer);
                populateVoiceSelect();
            }
        }, 100);
        
        // ç›‘å¬è¯­éŸ³å˜åŒ–äº‹ä»¶
        speechSynthesis.onvoiceschanged = () => {
            availableVoices = speechSynthesis.getVoices();
            populateVoiceSelect();
        };
    }
}

// å¡«å……è¯­éŸ³é€‰æ‹©æ¡†
function populateVoiceSelect() {
    const voiceSelect = document.getElementById('voiceSelect');
    voiceSelect.innerHTML = '<option value="">é€‰æ‹©è¯­éŸ³...</option>';
    
    // ä¼˜å…ˆæ˜¾ç¤ºä¸­æ–‡è¯­éŸ³
    const chineseVoices = availableVoices.filter(voice => 
        voice.lang.includes('zh') || voice.lang.includes('CN')
    );
    
    const otherVoices = availableVoices.filter(voice => 
        !voice.lang.includes('zh') && !voice.lang.includes('CN')
    );
    
    // æ·»åŠ ä¸­æ–‡è¯­éŸ³
    if (chineseVoices.length > 0) {
        const chineseGroup = document.createElement('optgroup');
        chineseGroup.label = 'ä¸­æ–‡è¯­éŸ³';
        chineseVoices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${voice.name} (${voice.lang})`;
            if (voice.default) option.textContent += ' [é»˜è®¤]';
            chineseGroup.appendChild(option);
        });
        voiceSelect.appendChild(chineseGroup);
        
        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªä¸­æ–‡è¯­éŸ³
        selectedVoice = chineseVoices[0];
        voiceSelect.value = '0';
    }
    
    // æ·»åŠ å…¶ä»–è¯­éŸ³
    if (otherVoices.length > 0) {
        const otherGroup = document.createElement('optgroup');
        otherGroup.label = 'å…¶ä»–è¯­éŸ³';
        otherVoices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.value = chineseVoices.length + index;
            option.textContent = `${voice.name} (${voice.lang})`;
            if (voice.default && !selectedVoice) option.textContent += ' [é»˜è®¤]';
            otherGroup.appendChild(option);
        });
        voiceSelect.appendChild(otherGroup);
        
        // å¦‚æœæ²¡æœ‰ä¸­æ–‡è¯­éŸ³ï¼Œé€‰æ‹©é»˜è®¤è¯­éŸ³
        if (!selectedVoice) {
            const defaultVoice = otherVoices.find(voice => voice.default) || otherVoices[0];
            selectedVoice = defaultVoice;
            voiceSelect.value = chineseVoices.length + otherVoices.indexOf(defaultVoice);
        }
    }
}

// æ›´æ”¹è¯­éŸ³
function changeVoice() {
    const voiceSelect = document.getElementById('voiceSelect');
    const voiceIndex = parseInt(voiceSelect.value);
    
    if (!isNaN(voiceIndex) && voiceIndex >= 0 && voiceIndex < availableVoices.length) {
        selectedVoice = availableVoices[voiceIndex];
        console.log('é€‰æ‹©è¯­éŸ³:', selectedVoice.name);
    }
}

// æµ‹è¯•è¯­éŸ³
function testVoice() {
    if (!selectedVoice) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯­éŸ³');
        return;
    }
    
    const testText = 'è¿™æ˜¯è¯­éŸ³æµ‹è¯•ï¼Œè·ç¦»è‡ªåŠ¨æ§åˆ¶åŸç†è€ƒè¯•ç»“æŸè¿˜æœ‰30åˆ†é’Ÿ';
    const utterance = new SpeechSynthesisUtterance(testText);
    utterance.voice = selectedVoice;
    utterance.rate = 0.8;
    utterance.pitch = 1;
    utterance.volume = 1;
    
    speechSynthesis.speak(utterance);
}

init();

/* ---------- å®æ—¶æ—¶é’Ÿå’Œè€ƒè¯•å€’è®¡æ—¶ ---------- */
function startRealTimeClock() {
    setInterval(updateClock, 1000);
    updateClock();
}

function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    document.getElementById('currentTime').textContent = timeString;
    
    // æ›´æ–°è€ƒè¯•å€’è®¡æ—¶
    if (currentSeating && currentSeating.course) {
        updateExamCountdown(now);
    }
}

function updateExamCountdown(now) {
    const course = currentSeating.course;
    const examTime = parseExamTime(course.time);
    
    if (!examTime) return;
    
    const timeDiff = examTime.getTime() - now.getTime();
    const countdownEl = document.getElementById('countdown');
    const statusEl = document.getElementById('examStatus');
    
    if (timeDiff > 0) {
        // è€ƒè¯•è¿˜æœªå¼€å§‹
        const hours = Math.floor(timeDiff / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
        
        countdownEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        statusEl.textContent = 'è·ç¦»è€ƒè¯•å¼€å§‹';
        countdownEl.className = 'text-2xl font-mono text-orange-600';
    } else {
        // è€ƒè¯•å·²å¼€å§‹æˆ–ç»“æŸ
        const examDuration = parseInt(course.duration);
        const examEndTime = new Date(examTime.getTime() + examDuration * 60 * 1000);
        const endTimeDiff = examEndTime.getTime() - now.getTime();
        
        if (endTimeDiff > 0) {
            // è€ƒè¯•è¿›è¡Œä¸­
            const minutes = Math.floor(endTimeDiff / (1000 * 60));
            const seconds = Math.floor((endTimeDiff % (1000 * 60)) / 1000);
            
            countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            statusEl.textContent = 'è·ç¦»è€ƒè¯•ç»“æŸ';
            countdownEl.className = 'text-2xl font-mono text-red-600';
            
            // æ£€æŸ¥è¯­éŸ³æé†’
            checkVoiceAlerts(minutes, course.name);
        } else {
            // è€ƒè¯•å·²ç»“æŸ
            countdownEl.textContent = '00:00';
            statusEl.textContent = 'è€ƒè¯•å·²ç»“æŸ';
            countdownEl.className = 'text-2xl font-mono text-gray-500';
        }
    }
}

function parseExamTime(timeString) {
    // è§£ææ—¶é—´æ ¼å¼ï¼š2025-01-20 14:00-15:35
    const match = timeString.match(/(\d{4}-\d{2}-\d{2})\s+(\d{2}):(\d{2})-/);
    if (match) {
        const [, date, hour, minute] = match;
        return new Date(`${date}T${hour}:${minute}:00`);
    }
    return null;
}

function checkVoiceAlerts(remainingMinutes, courseName) {
    for (const alertTime of voiceAlerts) {
        if (remainingMinutes === alertTime && !alertedTimes.has(alertTime) && voiceEnabled) {
            speakAlert(courseName, alertTime);
            alertedTimes.add(alertTime);
        }
    }
}

function speakAlert(courseName, minutes) {
    if ('speechSynthesis' in window && selectedVoice) {
        const utterance = new SpeechSynthesisUtterance(
            `è·ç¦»${courseName}è€ƒè¯•ç»“æŸè¿˜æœ‰${minutes}åˆ†é’Ÿ`
        );
        utterance.voice = selectedVoice;
        utterance.rate = 0.8;
        utterance.pitch = 1;
        utterance.volume = 1;
        speechSynthesis.speak(utterance);
    }
}

function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    const button = document.getElementById('voiceToggle');
    const status = document.getElementById('voiceStatus');
    
    if (voiceEnabled) {
        button.textContent = 'ğŸ”Š è¯­éŸ³å¼€å¯';
        button.className = 'w-full px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm';
        status.textContent = 'è¯­éŸ³æç¤ºå·²å¯ç”¨';
    } else {
        button.textContent = 'ğŸ”‡ è¯­éŸ³å…³é—­';
        button.className = 'w-full px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm';
        status.textContent = 'è¯­éŸ³æç¤ºå·²å…³é—­';
    }
}

/* ---------- è¯¾ç¨‹ç®¡ç† ---------- */
function refreshCourseSelect() {
    const sel = document.getElementById('courseSelect');
    sel.innerHTML = '<option value="">-- è¯·é€‰æ‹©è¯¾ç¨‹ --</option>';
    courses.forEach(c => {
        sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });
}

/* ---------- ç­çº§ç®¡ç† ---------- */
function refreshClassSelect() {
    const sel1 = document.getElementById('classSelect1');
    const sel2 = document.getElementById('classSelect2');
    
    const options = '<option value="">-- è¯·é€‰æ‹©ç­çº§ --</option>' + 
        studentClasses.map(c => `<option value="${c.id}">${c.name} (${c.students.length}äºº)</option>`).join('');
    
    sel1.innerHTML = options.replace('-- è¯·é€‰æ‹©ç­çº§ --', '-- è¯·é€‰æ‹©ç¬¬ä¸€ä¸ªç­çº§ --');
    sel2.innerHTML = options.replace('-- è¯·é€‰æ‹©ç­çº§ --', '-- ç¬¬äºŒä¸ªç­çº§ï¼ˆå¯é€‰ï¼‰ --');
}

// ç­çº§1é€‰æ‹©äº‹ä»¶
document.getElementById('classSelect1').addEventListener('change', function(e) {
    const classData = studentClasses.find(c => c.id === e.target.value);
    if (classData) {
        currentStudents1 = [...classData.students];
        document.getElementById('studentCount1').textContent = currentStudents1.length;
    } else {
        currentStudents1 = [];
        document.getElementById('studentCount1').textContent = '0';
    }
    updateTotalCount();
    updateMixingOptions();
});

// ç­çº§2é€‰æ‹©äº‹ä»¶
document.getElementById('classSelect2').addEventListener('change', function(e) {
    const classData = studentClasses.find(c => c.id === e.target.value);
    if (classData) {
        currentStudents2 = [...classData.students];
        document.getElementById('studentCount2').textContent = currentStudents2.length;
    } else {
        currentStudents2 = [];
        document.getElementById('studentCount2').textContent = '0';
    }
    updateTotalCount();
    updateMixingOptions();
});

function updateTotalCount() {
    const total = currentStudents1.length + currentStudents2.length;
    document.getElementById('totalStudentCount').textContent = total;
}

function updateMixingOptions() {
    const mixingOptions = document.getElementById('mixingOptions');
    if (currentStudents2.length > 0) {
        mixingOptions.classList.remove('hidden');
    } else {
        mixingOptions.classList.add('hidden');
    }
}

function clearClasses() {
    document.getElementById('classSelect1').value = '';
    document.getElementById('classSelect2').value = '';
    currentStudents1 = [];
    currentStudents2 = [];
    document.getElementById('studentCount1').textContent = '0';
    document.getElementById('studentCount2').textContent = '0';
    updateTotalCount();
    updateMixingOptions();
}

/* ---------- è€ƒåœºç®¡ç† ---------- */
function refreshRoomSelect() {
    const sel = document.getElementById('roomSelect');
    sel.innerHTML = '<option value="">-- è¯·é€‰æ‹©è€ƒåœº --</option>';
    rooms.forEach(r => {
        sel.innerHTML += `<option value="${r.id}">${r.name} (${r.rows}Ã—${r.cols}=${r.rows*r.cols}åº§)</option>`;
    });
}

document.getElementById('roomSelect').addEventListener('change', function(e) {
    const room = rooms.find(r => r.id === e.target.value);
    if (room) {
        document.getElementById('rowInput').value = room.rows;
        document.getElementById('colInput').value = room.cols;
    } else {
        document.getElementById('rowInput').value = '';
        document.getElementById('colInput').value = '';
    }
});

/* ---------- ç”Ÿæˆåº§ä½ ---------- */
function generateSeating() {
    const courseId = document.getElementById('courseSelect').value;
    const classId1 = document.getElementById('classSelect1').value;
    const classId2 = document.getElementById('classSelect2').value;
    const roomId = document.getElementById('roomSelect').value;
    
    if (!courseId) {
        alert('è¯·é€‰æ‹©è€ƒè¯•è¯¾ç¨‹');
        return;
    }
    if (!classId1) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­çº§');
        return;
    }
    if (!roomId) {
        alert('è¯·é€‰æ‹©è€ƒåœº');
        return;
    }
    
    const rows = parseInt(document.getElementById('rowInput').value);
    const cols = parseInt(document.getElementById('colInput').value);
    
    if (!rows || !cols) {
        alert('è¯·è®¾ç½®è¡Œåˆ—æ•°');
        return;
    }
    
    const totalSeats = rows * cols;
    const totalStudents = currentStudents1.length + currentStudents2.length;
    
    if (totalStudents > totalSeats) {
        alert(`å­¦ç”Ÿäººæ•°(${totalStudents})è¶…è¿‡åº§ä½æ•°(${totalSeats})ï¼è¯·é€‰æ‹©æ›´å¤§çš„è€ƒåœºæˆ–è°ƒæ•´åº§ä½å¸ƒå±€ã€‚`);
        return;
    }
    
    // ç”Ÿæˆåº§ä½çŸ©é˜µ
    let matrix = [];
    const mixMode = document.querySelector('input[name="mixMode"]:checked')?.value || 'random';
    
    if (currentStudents2.length > 0) {
        // åŒç­çº§æ¨¡å¼
        matrix = generateTwoClassSeating(currentStudents1, currentStudents2, rows, cols, mixMode);
    } else {
        // å•ç­çº§æ¨¡å¼
        matrix = generateSingleClassSeating(currentStudents1, rows, cols);
    }
    
    // è·å–ç›¸å…³ä¿¡æ¯
    const course = courses.find(c => c.id === courseId);
    const studentClass1 = studentClasses.find(c => c.id === classId1);
    const studentClass2 = classId2 ? studentClasses.find(c => c.id === classId2) : null;
    const room = rooms.find(r => r.id === roomId);
    const showMode = document.querySelector('input[name="showMode"]:checked').value;
    
    // ä¿å­˜å½“å‰æ’åº§æ•°æ®
    currentSeating = {
        course: course,
        class1: studentClass1,
        class2: studentClass2,
        room: room,
        matrix: matrix,
        showMode: showMode,
        mixMode: mixMode
    };
    
    // æ˜¾ç¤ºè€ƒè¯•ä¿¡æ¯é¢æ¿
    document.getElementById('examTimePanel').classList.remove('hidden');
    
    // é‡ç½®è¯­éŸ³æé†’çŠ¶æ€
    alertedTimes.clear();
    
    // æ˜¾ç¤ºè€ƒè¯•ä¿¡æ¯
    displayExamInfo(course, studentClass1, studentClass2, room);
    
    // æ¸²æŸ“åº§ä½è¡¨
    renderSeatingChart(matrix, showMode);
    
    // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
    document.getElementById('exportButtons').classList.remove('hidden');
}

function generateSingleClassSeating(students, rows, cols) {
    const allStudents = [...students].map(s => ({...s, classIndex: 1}));
    
    // éšæœºæ‰“ä¹±
    for (let i = allStudents.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allStudents[i], allStudents[j]] = [allStudents[j], allStudents[i]];
    }
    
    // ç”Ÿæˆåº§ä½çŸ©é˜µ
    const matrix = [];
    let studentIndex = 0;
    
    for (let r = 0; r < rows; r++) {
        const row = [];
        for (let c = 0; c < cols; c++) {
            if (studentIndex < allStudents.length) {
                row.push(allStudents[studentIndex++]);
            } else {
                row.push(null);
            }
        }
        matrix.push(row);
    }
    
    return matrix;
}

function generateTwoClassSeating(students1, students2, rows, cols, mixMode) {
    const matrix = [];
    
    // åˆå§‹åŒ–ç©ºçŸ©é˜µ
    for (let r = 0; r < rows; r++) {
        const row = [];
        for (let c = 0; c < cols; c++) {
            row.push(null);
        }
        matrix.push(row);
    }
    
    // ä¸ºå­¦ç”Ÿæ·»åŠ ç­çº§æ ‡è¯†
    const marked1 = students1.map(s => ({...s, classIndex: 1}));
    const marked2 = students2.map(s => ({...s, classIndex: 2}));
    
    let allStudents = [];
    
    switch(mixMode) {
        case 'random':
            // éšæœºæ··åˆ
            allStudents = [...marked1, ...marked2];
            for (let i = allStudents.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allStudents[i], allStudents[j]] = [allStudents[j], allStudents[i]];
            }
            
            // å¡«å……åº§ä½
            let studentIndex = 0;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (studentIndex < allStudents.length) {
                        matrix[r][c] = allStudents[studentIndex++];
                    }
                }
            }
            break;
            
        case 'alternate':
            // ä¿®å¤äº¤æ›¿æ’åˆ—é€»è¾‘ - çœŸæ­£çš„åº§ä½é—´äº¤æ›¿
            const shuffled1 = [...marked1];
            const shuffled2 = [...marked2];
            
            // éšæœºæ‰“ä¹±å„è‡ªç­çº§
            for (let i = shuffled1.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled1[i], shuffled1[j]] = [shuffled1[j], shuffled1[i]];
            }
            
            for (let i = shuffled2.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled2[i], shuffled2[j]] = [shuffled2[j], shuffled2[i]];
            }
            
            let index1 = 0, index2 = 0;
            let useClass1 = true; // äº¤æ›¿æ ‡å¿—
            
            // æŒ‰åº§ä½ä½ç½®äº¤æ›¿åˆ†é…
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (useClass1 && index1 < shuffled1.length) {
                        matrix[r][c] = shuffled1[index1++];
                    } else if (!useClass1 && index2 < shuffled2.length) {
                        matrix[r][c] = shuffled2[index2++];
                    } else if (index1 < shuffled1.length) {
                        matrix[r][c] = shuffled1[index1++];
                    } else if (index2 < shuffled2.length) {
                        matrix[r][c] = shuffled2[index2++];
                    }
                    useClass1 = !useClass1; // åˆ‡æ¢ç­çº§
                }
            }
            break;
            
        case 'separate':
            // å·¦å³åˆ†åŒºæ’åˆ—
            const leftCols = Math.ceil(cols / 2); // å·¦è¾¹åˆ—æ•°
            const rightCols = cols - leftCols;    // å³è¾¹åˆ—æ•°
            
            // éšæœºæ‰“ä¹±å„è‡ªç­çº§
            const shuffled1_sep = [...marked1];
            const shuffled2_sep = [...marked2];
            
            for (let i = shuffled1_sep.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled1_sep[i], shuffled1_sep[j]] = [shuffled1_sep[j], shuffled1_sep[i]];
            }
            
            for (let i = shuffled2_sep.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled2_sep[i], shuffled2_sep[j]] = [shuffled2_sep[j], shuffled2_sep[i]];
            }
            
            // å¡«å……å·¦è¾¹åŒºåŸŸï¼ˆç­çº§1ï¼‰
            let index1_sep = 0;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < leftCols; c++) {
                    if (index1_sep < shuffled1_sep.length) {
                        matrix[r][c] = shuffled1_sep[index1_sep++];
                    }
                }
            }
            
            // å¡«å……å³è¾¹åŒºåŸŸï¼ˆç­çº§2ï¼‰
            let index2_sep = 0;
            for (let r = 0; r < rows; r++) {
                for (let c = leftCols; c < cols; c++) {
                    if (index2_sep < shuffled2_sep.length) {
                        matrix[r][c] = shuffled2_sep[index2_sep++];
                    }
                }
            }
            break;
    }
    
    return matrix;
}

function displayExamInfo(course, studentClass1, studentClass2, room) {
    const totalSeats = room.rows * room.cols;
    const totalStudents = currentStudents1.length + currentStudents2.length;
    const emptySeats = totalSeats - totalStudents;
    
    let classInfo = `<div><strong>å‚è€ƒç­çº§ï¼š</strong>${studentClass1.name} (${currentStudents1.length}äºº)`;
    if (studentClass2) {
        classInfo += ` + ${studentClass2.name} (${currentStudents2.length}äºº)`;
    }
    classInfo += '</div>';
    
    document.getElementById('examInfo').innerHTML = `
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div><strong>è€ƒè¯•è¯¾ç¨‹ï¼š</strong>${course.name}</div>
            ${classInfo}
            <div><strong>è€ƒè¯•æ—¶é—´ï¼š</strong>${course.time}</div>
            <div><strong>è€ƒè¯•æ—¶é•¿ï¼š</strong>${course.duration}</div>
            <div><strong>è€ƒåœºï¼š</strong>${room.name}</div>
            <div><strong>åº§ä½å¸ƒå±€ï¼š</strong>${room.rows}è¡ŒÃ—${room.cols}åˆ—</div>
            <div><strong>æ€»åº§ä½æ•°ï¼š</strong>${totalSeats} ä¸ª</div>
            <div><strong>å‚è€ƒäººæ•°ï¼š</strong>${totalStudents} äºº</div>
            <div class="col-span-2"><strong>ç©ºä½™åº§ä½ï¼š</strong>${emptySeats} ä¸ª <span class="text-gray-500">(åº§ä½åˆ©ç”¨ç‡ï¼š${(totalStudents/totalSeats*100).toFixed(1)}%)</span></div>
        </div>
    `;
}

function renderSeatingChart(matrix, showMode) {
    let html = '<div class="text-center mb-4">';
    html += '<h3 class="text-lg font-semibold mb-2">åº§ä½å®‰æ’å›¾</h3>';
    html += '<div class="text-sm text-gray-600 mb-4">è®²å°æ–¹å‘ â†‘</div>';
    
    // å¦‚æœæ˜¯å·¦å³åˆ†åŒºæ¨¡å¼ï¼Œæ˜¾ç¤ºåˆ†åŒºæ ‡è¯†
    if (currentSeating && currentSeating.mixMode === 'separate' && currentSeating.class2) {
        const leftCols = Math.ceil(matrix[0].length / 2);
        html += '<div class="flex justify-center gap-8 mb-2 text-sm">';
        html += `<div class="flex items-center gap-1"><div class="w-4 h-4 bg-green-100 border border-gray-400"></div><span>å·¦åŒºï¼š${currentSeating.class1.name}</span></div>`;
        html += `<div class="flex items-center gap-1"><div class="w-4 h-4 bg-purple-100 border border-gray-400"></div><span>å³åŒºï¼š${currentSeating.class2.name}</span></div>`;
        html += '</div>';
    }
    
    html += '</div>';
    
    html += '<table class="mx-auto border-collapse seat-table">';
    
    // æ·»åŠ åˆ—å·
    html += '<tr><th class="seat-header"></th>';
    for (let c = 0; c < matrix[0].length; c++) {
        html += `<th class="seat-header">${c + 1}</th>`;
    }
    html += '</tr>';
    
    // æ·»åŠ åº§ä½
    matrix.forEach((row, r) => {
        html += '<tr>';
        html += `<th class="seat-header">${r + 1}</th>`;
        row.forEach((student, c) => {
            if (student) {
                let display = '';
                switch(showMode) {
                    case 'last3':
                        display = student.id.slice(-3);
                        break;
                    case 'last5':
                        display = student.id.slice(-5);
                        break;
                    case 'name':
                        display = student.name;
                        break;
                    case 'seq':
                        display = (r * matrix[0].length + c + 1).toString().padStart(3, '0');
                        break;
                }
                
                // æ ¹æ®ç­çº§è®¾ç½®ä¸åŒèƒŒæ™¯è‰²
                let bgColor = 'seat-class1';
                let classLabel = 'ç­çº§1';
                
                if (student.classIndex === 2) {
                    bgColor = 'seat-class2';
                    classLabel = 'ç­çº§2';
                }
                
                html += `<td class="seat-cell ${bgColor}" 
                         title="åº§ä½ï¼š${r + 1}-${c + 1}&#10;å­¦å·ï¼š${student.id}&#10;å§“åï¼š${student.name}&#10;ç­çº§ï¼š${classLabel}">${display}</td>`;
            } else {
                html += '<td class="seat-cell seat-empty"></td>';
            }
        });
        html += '</tr>';
    });
    html += '</table>';
    
    // æ·»åŠ è¯´æ˜
    html += '<div class="mt-4 text-center text-sm text-gray-600">';
    html += '<div class="inline-flex items-center gap-4">';
    html += '<div class="flex items-center gap-1"><div class="legend-box seat-class1"></div><span>ç­çº§1å­¦ç”Ÿ</span></div>';
    if (currentStudents2.length > 0) {
        html += '<div class="flex items-center gap-1"><div class="legend-box seat-class2"></div><span>ç­çº§2å­¦ç”Ÿ</span></div>';
    }
    html += '<div class="flex items-center gap-1"><div class="legend-box seat-empty"></div><span>ç©ºä½™åº§ä½</span></div>';
    html += '</div>';
    html += '<div class="mt-2">é¼ æ ‡æ‚¬åœåœ¨åº§ä½ä¸Šå¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>';
    html += '</div>';
    
    document.getElementById('seatingChart').innerHTML = html;
}

/* ---------- å¯¼å‡ºåŠŸèƒ½ ---------- */
function exportToExcel() {
    if (!currentSeating) return;
    
    // åˆ›å»ºå¯¼å‡ºæ•°æ®
    const data = [
        [`${currentSeating.course.name} åº§ä½å®‰æ’è¡¨`]
    ];
    
    let classInfo = `ç­çº§ï¼š${currentSeating.class1.name}`;
    if (currentSeating.class2) {
        classInfo += ` + ${currentSeating.class2.name}`;
    }
    data.push([classInfo]);
    
    data.push([`è€ƒè¯•æ—¶é—´ï¼š${currentSeating.course.time}`]);
    data.push([`è€ƒåœºï¼š${currentSeating.room.name}`]);
    data.push([`åº§ä½å¸ƒå±€ï¼š${currentSeating.room.rows}è¡ŒÃ—${currentSeating.room.cols}åˆ—`]);
    data.push([]);
    data.push(['åº§ä½å·', 'å­¦å·', 'å§“å', 'ç­çº§', 'æ˜¾ç¤ºå†…å®¹']);
    
    currentSeating.matrix.forEach((row, r) => {
        row.forEach((student, c) => {
            if (student) {
                let display = '';
                switch(currentSeating.showMode) {
                    case 'last3': display = student.id.slice(-3); break;
                    case 'last5': display = student.id.slice(-5); break;
                    case 'name': display = student.name; break;
                    case 'seq': display = (r * currentSeating.matrix[0].length + c + 1).toString(); break;
                }
                
                const className = student.classIndex === 1 ? currentSeating.class1.name : currentSeating.class2?.name || '';
                
                data.push([
                    `${r + 1}-${c + 1}`,
                    student.id,
                    student.name,
                    className,
                    display
                ]);
            }
        });
    });
    
    // åˆ›å»ºå¹¶ä¸‹è½½CSVæ–‡ä»¶
    const csvContent = data.map(row => row.join(',')).join('\n');
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    
    let fileName = `${currentSeating.course.name}_${currentSeating.class1.name}`;
    if (currentSeating.class2) {
        fileName += `+${currentSeating.class2.name}`;
    }
    fileName += `_åº§ä½è¡¨_${new Date().toLocaleDateString()}.csv`;
    
    link.download = fileName;
    link.click();
}

function printSeating() {
    const printWindow = window.open('', '_blank');
    const printContent = document.getElementById('seatingChart').innerHTML;
    const examInfo = document.getElementById('examInfo').innerHTML;
    
    printWindow.document.write(`
        <html>
        <head>
            <title>åº§ä½å®‰æ’è¡¨</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .seat-table { border-collapse: collapse; margin: 0 auto; }
                .seat-header { 
                    padding: 6px 8px; 
                    text-align: center; 
                    font-size: 12px; 
                    color: #666;
                    border: none;
                    width: 50px;
                }
                .seat-cell { 
                    border: 2px solid #333; 
                    padding: 12px 8px; 
                    text-align: center; 
                    font-weight: bold;
                    font-size: 14px;
                    width: 70px;
                    height: 50px;
                    vertical-align: middle;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                }
                .seat-class1 { background-color: #dcfce7; }
                .seat-class2 { background-color: #e9d5ff; }
                .seat-empty { background-color: #f9fafb; }
                .exam-info { margin-bottom: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; }
                .exam-info div { margin: 5px 0; }
                @page { margin: 1cm; }
            </style>
        </head>
        <body>
            <div class="exam-info">${examInfo}</div>
            ${printContent}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>

<style>
/* è‡ªå®šä¹‰åº§ä½è¡¨æ ·å¼ */
.seat-table {
    border-collapse: collapse;
    margin: 0 auto;
}

.seat-header {
    padding: 6px 8px;
    text-align: center;
    font-size: 12px;
    color: #666;
    border: none;
    width: 50px;
}

.seat-cell {
    border: 2px solid #374151;
    padding: 12px 8px;
    text-align: center;
    font-weight: bold;
    font-size: 14px;
    width: 70px;
    height: 50px;
    vertical-align: middle;
    cursor: pointer;
    transition: all 0.2s ease;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.2;
}

.seat-class1 {
    background-color: #dcfce7;
}

.seat-class1:hover {
    background-color: #bbf7d0;
    transform: scale(1.05);
}

.seat-class2 {
    background-color: #e9d5ff;
}

.seat-class2:hover {
    background-color: #ddd6fe;
    transform: scale(1.05);
}

.seat-empty {
    background-color: #f9fafb;
}

.legend-box {
    width: 16px;
    height: 16px;
    border: 1px solid #374151;
}

@media print {
    body {
        background: white;
    }
    .grid {
        display: block;
    }
    .lg\\:col-span-2 {
        width: 100%;
    }
    .no-print {
        display: none !important;
    }
    .seat-cell {
        page-break-inside: avoid;
    }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .seat-cell {
        width: 60px;
        height: 45px;
        padding: 8px 4px;
        font-size: 12px;
    }
    
    .seat-header {
        font-size: 10px;
        width: 40px;
    }
}
</style>
</body>
</html>
