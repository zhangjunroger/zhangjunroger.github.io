<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç­¾åˆ°ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <!-- Face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* è§†é¢‘å’Œcanvas å®¹å™¨*/
        .video-container {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }

        /* è§†é¢‘å…ƒç´ */
        #video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        /* Canvas å åŠ å±‚*/
        #faceCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* å…è®¸ç‚¹å‡»ç©¿é€*/
        }

        /* éšè—ç±»*/
        .hidden {
            display: none !important;
        }

        /* å½“å‰ç­¾åˆ°ä¿¡æ¯å¡ç‰‡åŠ¨ç”»*/
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .session-card {
            animation: slideDown 0.5s ease-out;
        }

        /* å€’è®¡æ—¶é—ªçƒ*/
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .countdown-urgent {
            animation: pulse 1s ease-in-out infinite;
        }

        /* åŠ è½½åŠ¨ç”»*/
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* è¿›åº¦æ¡åŠ¨ç”»*/
        .progress-bar {
            transition: width 0.5s ease-out;
        }

        /* æŒ‰é’®ç¦ç”¨çŠ¶æ€*/
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-4xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-center text-indigo-600">
                ğŸ“å­¦ç”Ÿç­¾åˆ°ç³»ç»Ÿ
            </h1>
            <p class="text-center text-gray-600 mt-2">äººè„¸è¯†åˆ«+ å®šä½ç­¾åˆ°</p>
        </div>
        <!-- å½“å‰ç­¾åˆ°ä¿¡æ¯-->
        <div id="currentSessionContainer" class="mb-6">
            <!-- åŠ è½½ä¸­-->
            <div id="sessionLoading" class="bg-white rounded-lg shadow-lg p-8">
                <div class="flex flex-col items-center justify-center">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-gray-600">æ­£åœ¨åŠ è½½ç­¾åˆ°ä¿¡æ¯...</p>
                </div>
            </div>
            <!-- æ— ç­¾åˆ°ä»»åŠ¡-->
            <div id="noSession" class="hidden bg-white rounded-lg shadow-lg p-8">
                <div class="text-center">
                    <p class="text-6xl mb-4">ğŸ“š</p>
                    <p class="text-xl font-bold text-gray-700 mb-2">å½“å‰æš‚æ— ç­¾åˆ°ä»»åŠ¡</p>
                    <p class="text-gray-500">ç­‰å¾…æ•™å¸ˆå‘èµ·ç­¾åˆ°...</p>
                    <button onclick="manualRefreshSessions()"
                        class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                        ğŸ”„åˆ·æ–°
                    </button>
                </div>
            </div>
            <!-- ç­¾åˆ°ä»»åŠ¡åˆ—è¡¨-->
            <div id="sessionList" class="hidden space-y-4">
                <!-- ç­¾åˆ°å¡ç‰‡å°†åŠ¨æ€æ’å…¥è¿™é‡Œ-->
            </div>
        </div>
        <!-- ç­¾åˆ°æ“ä½œåŒº-->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“ç­¾åˆ°æ“ä½œ</h2>
            <!-- äººè„¸è¯†åˆ«-->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3 text-gray-700">ğŸ“·äººè„¸è¯†åˆ«</h3>
                <!-- è§†é¢‘å®¹å™¨-->
                <div class="video-container flex justify-center items-center">
                    <video id="video" autoplay playsinline muted
                        class="hidden mx-auto block w-full max-w-2xl rounded-lg shadow-lg"></video>
                    <canvas id="faceCanvas" class="hidden"></canvas>
                </div>
                <!-- å ä½ç¬¦-->
                <div id="videoPlaceholder" class="bg-gray-200 rounded-lg p-8 text-center mb-4">
                    <p class="text-gray-600 text-lg">ğŸ“·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ç›¸æœº</p>
                    <p class="text-gray-500 text-sm mt-2">ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«æ‚¨çš„èº«ä»½</p>
                </div>
                <!-- è¯†åˆ«çŠ¶æ€-->
                <div id="recognitionStatus" class="hidden mb-4 p-4 bg-blue-50 rounded-lg text-center">
                    <p class="text-blue-800 font-semibold">ğŸ”æ­£åœ¨è¯†åˆ«...</p>
                </div>
                <!-- ç›¸æœºæŒ‰é’®-->
                <button onclick="openCamera()" id="cameraBtn"
                    class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold text-lg">
                    ğŸ“·æ‰“å¼€ç›¸æœºï¼ˆäººè„¸è¯†åˆ«ï¼‰
                </button>
            </div>
            <!-- å®šä½è·å–-->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3 text-gray-700">ğŸ“è·å–å®šä½</h3>
                <button onclick="getLocation()" id="locationBtn"
                    class="w-full bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition font-semibold">
                    ğŸ“è·å–å½“å‰ä½ç½®
                </button>
                <input type="text" id="location" placeholder="å®šä½ä¿¡æ¯å°†è‡ªåŠ¨æ˜¾ç¤ºåœ¨è¿™é‡Œ"
                    class="mt-3 w-full border rounded-lg px-4 py-3 bg-gray-50" readonly>
            </div>
            <!-- å­¦ç”Ÿä¿¡æ¯-->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3 text-gray-700">ğŸ‘¤å­¦ç”Ÿä¿¡æ¯</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="stuClass" placeholder="ç­çº§ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰" class="border rounded-lg px-4 py-3" readonly>
                    <input type="text" id="stuId" placeholder="å­¦å·ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰" class="border rounded-lg px-4 py-3" readonly>
                    <input type="text" id="stuName" placeholder="å§“åï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰" class="border rounded-lg px-4 py-3" readonly>
                </div>
            </div>
            <!-- æäº¤æŒ‰é’®-->
            <button onclick="submitCheckIn()"
                class="w-full bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 transition font-bold text-xl shadow-lg">
                âœ…æäº¤ç­¾åˆ°
            </button>
            <!-- æç¤ºä¿¡æ¯-->
            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-yellow-800 font-bold mb-2">ğŸ’¡ç­¾åˆ°æç¤ºï¼š</p>
                <ul class="text-sm text-yellow-800 list-disc ml-5 space-y-1">
                    <li>äººè„¸è¯†åˆ«éœ€è¦æ­£å¯¹æ‘„åƒå¤´ï¼Œä¿æŒå…‰çº¿å……è¶³</li>
                    <li>å¦‚è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™ä¿¡æ¯åæäº¤</li>
                    <li>å®šä½åŠŸèƒ½ä¸ºå¯é€‰é¡¹ï¼Œå®šä½å¤±è´¥ä¸å½±å“ç­¾åˆ°</li>
                    <li>è¯·ç¡®ä¿åœ¨ç­¾åˆ°æ—¶é—´èŒƒå›´å†…æäº¤</li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        // ==================== LeanCloud åˆå§‹åŒ–====================  
        AV.init({
            appId: "i1PwXfBx9ZVMkIYzZdUUiysn-gzGzoHsz",
            appKey: "gFXLEuRbVBEVBZiLiZrknLxE",
            serverURL: "https://i1pwxfbx.lc-cn-n1-shared.com"
        });
        // ==================== å…¨å±€å˜é‡====================  
        let students = [];
        let faceModelsLoaded = false;
        let videoStream = null;
        let faceDetectionRunning = false;
        let labeledDescriptors = [];
        let recognitionSuccess = false;
        let activeSessions = [];
        // ğŸ”¥ æ–°å¢ï¼šå€’è®¡æ—¶å®šæ—¶å™¨ç®¡ç†  
        let countdownTimers = [];
        // ğŸ”¥ æ–°å¢ï¼šå¤šå¸§éªŒè¯æœºåˆ¶  
        let recentMatches = [];
        const CONSECUTIVE_FRAMES = 3;
        const MIN_CONFIDENCE = 0.5;
        // ğŸ”¥ æ–°å¢ï¼šå®šä½æ•°æ®å…¨å±€å˜é‡  
        window.locationData = null;

        // ğŸ”¥æ´»ä½“æ£€æµ‹ç›¸å…³å˜é‡
        let livenessActions = [];          // éœ€è¦å®Œæˆçš„åŠ¨ä½œ['blink', 'mouth', 'nod']
        let livenessProgress = {};         // å„åŠ¨ä½œå®Œæˆæƒ…å†µ
        let livenessCheckPassed = false;   // æ´»ä½“æ£€æµ‹æ˜¯å¦å…¨éƒ¨é€šè¿‡

        // çœ¨çœ¼æ£€æµ‹
        let blinkCount = 0;
        let lastEyeState = 'open';
        let eyeClosedFrames = 0;

        // çœ¨çœ¼æ£€æµ‹ï¼ˆåŠ¨æ€é˜ˆå€¼ç‰ˆï¼‰
        let baselineEAR = null;        // ççœ¼åŸºå‡†å€¼
        let earSamples = [];           // EARé‡‡æ ·å€¼
        const SAMPLE_SIZE = 10;        // é‡‡æ ·æ•°é‡

        // å¼ å˜´æ£€æµ‹
        let mouthOpenCount = 0;
        let lastMouthState = 'closed';

        // ç‚¹å¤´æ£€æµ‹
        let headPositions = [];
        let nodCount = 0;

        // ==================== é¡µé¢åŠ è½½åˆå§‹åŒ–====================  
        window.onload = async function () {
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸš€å­¦ç”Ÿç«¯ç³»ç»Ÿåˆå§‹åŒ–...');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            // åŠ è½½äººè„¸è¯†åˆ«æ¨¡å‹  
            await loadFaceModels();
            // åŠ è½½å­¦ç”Ÿæ•°æ®  
            await loadStudentsFromCloud();
            // ğŸ”¥ åªåœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨ä¸€æ¬¡  
            await refreshSessions();
            // ğŸ”¥ å–æ¶ˆè‡ªåŠ¨åˆ·æ–°ï¼ˆè¿™æ˜¯å…³é”®ä¿®æ”¹ï¼ï¼‰  
            // sessionRefreshInterval = setInterval(refreshSessions, 10000); // åˆ é™¤è¿™è¡Œ  
            console.log('âœ…å­¦ç”Ÿç«¯åˆå§‹åŒ–å®Œæˆ');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
        };

        // ==================== åŠ è½½äººè„¸è¯†åˆ«æ¨¡å‹====================  
        async function loadFaceModels() {
            try {
                console.log('ğŸ“¥å¼€å§‹åŠ è½½äººè„¸è¯†åˆ«æ¨¡å‹...');
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                faceModelsLoaded = true;
                console.log('âœ…äººè„¸è¯†åˆ«æ¨¡å‹åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('âŒæ¨¡å‹åŠ è½½å¤±è´¥:', error);
                alert('äººè„¸è¯†åˆ«æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // ==================== åŠ è½½å­¦ç”Ÿæ•°æ®====================  
        async function loadStudentsFromCloud() {
            try {
                console.log('ğŸ“¥æ­£åœ¨ä»äº‘ç«¯åŠ è½½å­¦ç”Ÿæ•°æ®...');
                const query = new AV.Query('Student');
                query.limit(1000);
                const results = await query.find();
                students = results.map(obj => ({
                    className: obj.get('className'),
                    studentId: obj.get('studentId'),
                    name: obj.get('name'),
                    photoUrl: obj.get('photoUrl'),
                    faceDescriptor: obj.get('faceDescriptor')
                }));
                updateLabeledDescriptors();
                console.log(`âœ…ä»äº‘ç«¯åŠ è½½äº†${students.length} ä¸ªå­¦ç”Ÿ`);
            } catch (error) {
                console.error('âŒåŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);
            }
        }

        // ==================== æ›´æ–°äººè„¸æè¿°ç¬¦====================  
        function updateLabeledDescriptors() {
            labeledDescriptors = students
                .filter(s => s.faceDescriptor && s.faceDescriptor.length > 0)
                .map(s => new faceapi.LabeledFaceDescriptors(
                    `${s.studentId}|${s.name}|${s.className}`,
                    [new Float32Array(s.faceDescriptor)]
                ));
            console.log(`âœ…å·²åŠ è½½${labeledDescriptors.length} ä¸ªå­¦ç”Ÿçš„äººè„¸æ•°æ®`);
        }

        // ==================== æ‰‹åŠ¨åˆ·æ–°ç­¾åˆ°ä»»åŠ¡ï¼ˆæ–°å¢å‡½æ•°ï¼‰====================  
        async function manualRefreshSessions() {
            const refreshButtons = document.querySelectorAll('button[onclick="manualRefreshSessions()"]');

            // é˜²æ­¢é‡å¤ç‚¹å‡»  
            refreshButtons.forEach(btn => {
                if (btn.disabled) return;
                btn.disabled = true;
                btn.textContent = 'â³ åˆ·æ–°ä¸­...';
            });
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°ç­¾åˆ°ä»»åŠ¡');
            try {
                await refreshSessions();
                // åˆ·æ–°æˆåŠŸæç¤º  
                refreshButtons.forEach(btn => {
                    btn.textContent = 'âœ… åˆ·æ–°æˆåŠŸ';
                });
                // éœ‡åŠ¨åé¦ˆ  
                if (navigator.vibrate) {
                    navigator.vibrate(100);
                }
                // 2ç§’åæ¢å¤æŒ‰é’®  
                setTimeout(() => {
                    refreshButtons.forEach(btn => {
                        btn.textContent = 'ğŸ”„ åˆ·æ–°';
                        btn.disabled = false;
                    });
                }, 2000);
                console.log('âœ… åˆ·æ–°æˆåŠŸ');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
            } catch (error) {
                console.error('âŒ åˆ·æ–°å¤±è´¥:', error);
                refreshButtons.forEach(btn => {
                    btn.textContent = 'âŒ åˆ·æ–°å¤±è´¥';
                });
                setTimeout(() => {
                    refreshButtons.forEach(btn => {
                        btn.textContent = 'ğŸ”„ åˆ·æ–°';
                        btn.disabled = false;
                    });
                }, 2000);
                alert('åˆ·æ–°å¤±è´¥ï¼š' + error.message);
            }
        }

        // ==================== åˆ·æ–°ç­¾åˆ°ä»»åŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼‰====================  
        async function refreshSessions() {
            try {
                console.log('ğŸ”„åˆ·æ–°ç­¾åˆ°ä»»åŠ¡...');
                const sessionLoading = document.getElementById('sessionLoading');
                const noSession = document.getElementById('noSession');
                const sessionList = document.getElementById('sessionList');
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»  
                sessionLoading.classList.remove('hidden');
                noSession.classList.add('hidden');
                sessionList.classList.add('hidden');
                // ğŸ”¥ åªæŸ¥è¯¢ä¸€æ¬¡æ•°æ®  
                const query = new AV.Query('CheckInSession');
                query.equalTo('status', 'active');
                query.descending('startTime');
                query.limit(10);
                const sessions = await query.find();
                activeSessions = sessions;
                console.log(`âœ…æ‰¾åˆ°${sessions.length} ä¸ªæ´»åŠ¨ç­¾åˆ°`);
                // éšè—åŠ è½½åŠ¨ç”»  
                sessionLoading.classList.add('hidden');
                if (sessions.length === 0) {
                    // æ— ç­¾åˆ°ä»»åŠ¡  
                    noSession.classList.remove('hidden');
                } else {
                    // æ˜¾ç¤ºç­¾åˆ°ä»»åŠ¡  
                    sessionList.classList.remove('hidden');
                    renderSessions(sessions);
                }
            } catch (error) {
                console.error('âŒåˆ·æ–°ç­¾åˆ°ä»»åŠ¡å¤±è´¥:', error);
                const sessionLoading = document.getElementById('sessionLoading');
                sessionLoading.innerHTML =
                    '<p class="text-red-600 font-semibold">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
            }
        }

        // ==================== æ¸²æŸ“ç­¾åˆ°ä»»åŠ¡å¡ç‰‡====================  
        function renderSessions(sessions) {
            const sessionList = document.getElementById('sessionList');
            let html = '';
            sessions.forEach((session, index) => {
                const courseName = session.get('courseName') || 'æœªå‘½åè¯¾ç¨‹';
                const courseSession = session.get('courseSession') || 'æœªçŸ¥èŠ‚æ¬¡';
                const className = session.get('className') || 'æœªçŸ¥ç­çº§';
                const classNames = session.get('classNames') || [className];
                const startTime = session.get('startTime');
                const duration = session.get('duration') || 30;
                const totalStudents = session.get('totalStudents') || 0;
                const checkedInCount = session.get('checkedInCount') || 0;
                const sessionId = session.id;
                // è®¡ç®—å‰©ä½™æ—¶é—´  
                const now = new Date();
                const start = new Date(startTime);
                const elapsed = Math.floor((now - start) / 1000);
                const totalSeconds = duration * 60;
                const remainingSeconds = Math.max(0, totalSeconds - elapsed);
                const remainingMinutes = Math.floor(remainingSeconds / 60);
                const remainingSecs = remainingSeconds % 60;
                const timeString = `${remainingMinutes}:${remainingSecs.toString().padStart(2, '0')}`;
                const timeClass = remainingSeconds <= 60 ? 'text-red-600 countdown-urgent' :
                    remainingSeconds <= 300 ? 'text-orange-600' : 'text-green-600';
                const progress = totalStudents > 0 ? Math.round((checkedInCount / totalStudents) * 100) : 0;
                html += `  
<div class="session-card bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg shadow-lg p-6 text-white" data-session-id="${sessionId}">  
<div class="flex justify-between items-start mb-4">  
<div class="flex-1">  
<h3 class="text-2xl font-bold mb-2">ğŸ“š${courseName}</h3>  
<p class="text-lg opacity-90">ğŸ“–${courseSession}</p>  
<p class="text-sm opacity-80 mt-1">ğŸ‘¥ç­çº§ï¼š${classNames.join('ã€')}</p>  
</div>  
<div class="text-right">  
<div class="bg-white bg-opacity-20 rounded-lg px-4 py-2">  
<p class="text-xs opacity-80">å‰©ä½™æ—¶é—´</p>  
<p class="text-2xl font-bold ${timeClass}" id="countdown-${sessionId}">${timeString}</p>  
</div>  
</div>  
</div>  
<!-- ç­¾åˆ°è¿›åº¦-->  
<div class="bg-white bg-opacity-20 rounded-lg p-4 mb-4">  
<div class="flex justify-between text-sm mb-2">  
<span>ç­¾åˆ°è¿›åº¦</span>  
<span class="font-bold" id="progress-text-${sessionId}">${checkedInCount} / ${totalStudents} (${progress}%)</span>  
</div>  
<div class="w-full bg-white bg-opacity-30 rounded-full h-3 overflow-hidden">  
<div class="bg-green-400 h-full rounded-full progress-bar" id="progress-bar-${sessionId}" style="width: ${progress}%"></div>  
</div>  
</div>  
<!-- å¼€å§‹æ—¶é—´-->  
<div class="flex items-center text-sm opacity-80">  
<span>ğŸ•å¼€å§‹æ—¶é—´ï¼š${new Date(startTime).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</span>  
</div>  
</div>  
`;
            });
            sessionList.innerHTML = html;
            // å¯åŠ¨å€’è®¡æ—¶æ›´æ–°  
            startCountdownTimers();
        }

        // ==================== å€’è®¡æ—¶å®šæ—¶å™¨ï¼ˆä¼˜åŒ–ç‰ˆï¼‰====================  
        function startCountdownTimers() {
            // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ¸…ç†æ‰€æœ‰æ—§çš„å®šæ—¶å™¨  
            console.log('ğŸ”„ æ¸…ç†æ—§çš„å€’è®¡æ—¶å®šæ—¶å™¨...');
            countdownTimers.forEach(timer => clearInterval(timer));
            countdownTimers = [];
            activeSessions.forEach(session => {
                const sessionId = session.id;
                const startTime = session.get('startTime');
                const duration = session.get('duration') || 30;
                const countdownElement = document.getElementById(`countdown-${sessionId}`);
                if (!countdownElement) return;
                const updateCountdown = () => {
                    const now = new Date();
                    const start = new Date(startTime);
                    const elapsed = Math.floor((now - start) / 1000);
                    const totalSeconds = duration * 60;
                    const remainingSeconds = Math.max(0, totalSeconds - elapsed);
                    const remainingMinutes = Math.floor(remainingSeconds / 60);
                    const remainingSecs = remainingSeconds % 60;
                    const timeString = `${remainingMinutes}:${remainingSecs.toString().padStart(2, '0')}`;
                    countdownElement.textContent = timeString;
                    // æ›´æ–°é¢œè‰²  
                    countdownElement.className = '';
                    countdownElement.classList.add('text-2xl', 'font-bold');
                    if (remainingSeconds <= 60) {
                        countdownElement.classList.add('text-red-600', 'countdown-urgent');
                    } else if (remainingSeconds <= 300) {
                        countdownElement.classList.add('text-orange-600');
                    } else {
                        countdownElement.classList.add('text-green-600');
                    }
                    // ğŸ”¥ ä¼˜åŒ–ï¼šå¦‚æœæ—¶é—´åˆ°äº†ï¼Œæ¸…ç†å®šæ—¶å™¨  
                    if (remainingSeconds === 0) {
                        clearInterval(timer);
                        const index = countdownTimers.indexOf(timer);
                        if (index > -1) {
                            countdownTimers.splice(index, 1);
                        }
                    }
                };
                // ç«‹å³æ›´æ–°ä¸€æ¬¡  
                updateCountdown();
                // ğŸ”¥ æ¯ç§’æ›´æ–°ï¼Œå¹¶ä¿å­˜å®šæ—¶å™¨å¼•ç”¨  
                const timer = setInterval(updateCountdown, 1000);
                countdownTimers.push(timer);
                console.log(`âœ… ä¸ºç­¾åˆ°ä»»åŠ¡ ${sessionId} åˆ›å»ºå€’è®¡æ—¶å®šæ—¶å™¨`);
            });
        }

// ==================== å®šä½åŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆï¼‰====================  
function getLocation() {
    const locationBtn = document.getElementById('locationBtn');
    const locationInput = document.getElementById('location');
    locationBtn.disabled = true;
    locationBtn.textContent = 'ğŸ”„å®šä½ä¸­...';
    locationInput.value = 'ğŸ“æ­£åœ¨è·å–æ‰‹æœºå®šä½ï¼Œè¯·ç¨å€™...';
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ“å¼€å§‹è·å–å®šä½');
    if (!navigator.geolocation) {
        console.error('âŒè®¾å¤‡ä¸æ”¯æŒå®šä½');
        locationInput.value = 'æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒå®šä½ï¼ˆå¯ç»§ç»­ç­¾åˆ°ï¼‰';
        locationBtn.disabled = false;
        locationBtn.textContent = 'âŒä¸æ”¯æŒå®šä½';
        alert('âš ï¸æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒå®šä½åŠŸèƒ½\n\næ‚¨ä»å¯ç»§ç»­ç­¾åˆ°');
        return;
    }
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = Math.round(position.coords.accuracy);
            console.log('âœ…GPSå®šä½æˆåŠŸ:', {
                çº¬åº¦: lat,
                ç»åº¦: lng,
                ç²¾åº¦: accuracy + 'ç±³'
            });
            locationInput.value = `ğŸ“GPSå®šä½æˆåŠŸï¼ç²¾åº¦Â±${accuracy}ç±³\næ­£åœ¨è§£æåœ°å€...`;
            // ğŸ”¥ è°ƒç”¨é«˜å¾·åœ°å›¾APIè¿›è¡Œé€†åœ°ç†ç¼–ç   
            try {
                console.log('ğŸ—ºï¸ å¼€å§‹è°ƒç”¨é«˜å¾·åœ°å›¾API...');
                const AMAP_KEY = 'c476073c665a756538af618d0007ab72';
                const response = await fetch(
                    `https://restapi.amap.com/v3/geocode/regeo?key=${AMAP_KEY}&location=${lng},${lat}&extensions=all&output=json`,
                    {
                        method: 'GET',
                        mode: 'cors'
                    }
                );
                const data = await response.json();
                console.log('ğŸ—ºï¸ é«˜å¾·APIå“åº”:', data);
                if (data.status === '1' && data.regeocode) {
                    // ========== è§£æåœ°å€ä¿¡æ¯ ==========  
                    const addressComponent = data.regeocode.addressComponent;
                    const formattedAddress = data.regeocode.formatted_address || '';
                    // æå–è¯¦ç»†ä¿¡æ¯  
                    const province = addressComponent.province || '';
                    const city = addressComponent.city || addressComponent.province || '';
                    const district = addressComponent.district || '';
                    const township = addressComponent.township || '';
                    const street = addressComponent.streetNumber?.street || '';
                    const streetNumber = addressComponent.streetNumber?.number || '';
                    // è·å–é™„è¿‘POIï¼ˆå…´è¶£ç‚¹ï¼‰  
                    let poiName = '';
                    let poiType = '';
                    let poiDistance = '';
                    if (data.regeocode.pois && data.regeocode.pois.length > 0) {
                        const nearestPOI = data.regeocode.pois[0];
                        poiName = nearestPOI.name || '';
                        poiType = nearestPOI.type || '';
                        poiDistance = nearestPOI.distance ? `çº¦${nearestPOI.distance}ç±³` : '';
                    }
                    // ğŸ”¥ å°†è¯¦ç»†ä¿¡æ¯å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼ˆæ–¹ä¾¿æäº¤æ—¶ä½¿ç”¨ï¼‰  
                    window.locationData = {
                        latitude: lat,
                        longitude: lng,
                        accuracy: accuracy,
                        province: province,
                        city: city,
                        district: district,
                        township: township,
                        street: street,
                        streetNumber: streetNumber,
                        formattedAddress: formattedAddress,
                        poiName: poiName,
                        poiType: poiType,
                        poiDistance: poiDistance,
                        rawData: data.regeocode
                    };
                    
                    // ğŸ”¥ğŸ”¥ æ„å»ºæ˜¾ç¤ºæ–‡æœ¬ï¼ˆåªæ˜¾ç¤ºåœ°å€ï¼Œä¸æ˜¾ç¤ºåæ ‡ï¼‰ğŸ”¥ğŸ”¥
                    let displayText = '';

                    // ä¼˜å…ˆæ˜¾ç¤ºPOIåç§°ï¼ˆå¦‚ï¼šæ²ˆé˜³å·¥ä¸šå¤§å­¦æ•™å­¦æ¥¼Aåº§ï¼‰
                    if (poiName) {
                        displayText = `ğŸ“ ${poiName}`;
                        // å¦‚æœPOIè·ç¦»è¾ƒè¿‘ï¼ˆå°äº50ç±³ï¼‰ï¼Œè¯´æ˜å°±åœ¨è¿™ä¸ªä½ç½®
                        if (poiDistance && parseInt(poiDistance) < 50) {
                            displayText += `\nğŸ¢ ${formattedAddress}`;
                        } else if (poiDistance) {
                            displayText += ` (${poiDistance})`;
                            displayText += `\nğŸ¢ ${formattedAddress}`;
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰POIï¼Œæ˜¾ç¤ºè¯¦ç»†åœ°å€
                        displayText = `ğŸ“ ${formattedAddress}`;
                    }

                    // æ˜¾ç¤ºç²¾åº¦ä¿¡æ¯
                    displayText += `\nğŸ“Š å®šä½ç²¾åº¦ï¼šÂ±${accuracy}ç±³`;

                    locationInput.value = displayText;
                    
                    console.log('âœ… åœ°å€è§£ææˆåŠŸ');
                    console.log('è¯¦ç»†åœ°å€:', formattedAddress);
                    console.log('é™„è¿‘POI:', poiName);
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
                } else {
                    // APIè°ƒç”¨å¤±è´¥ï¼Œåªæ˜¾ç¤ºæç¤º  
                    console.warn('âš ï¸ é«˜å¾·APIè¿”å›é”™è¯¯:', data.info);
                    window.locationData = {
                        latitude: lat,
                        longitude: lng,
                        accuracy: accuracy,
                        formattedAddress: `å®šä½æˆåŠŸï¼Œåœ°å€è§£æå¤±è´¥`,
                        province: '',
                        city: '',
                        district: ''
                    };
                    locationInput.value =
                        `âš ï¸ åœ°å€è§£æå¤±è´¥\n` +
                        `ğŸ“Š å®šä½ç²¾åº¦: Â±${accuracy}ç±³\n` +
                        `ğŸ’¡ ${data.info || 'è¯·ç¨åé‡è¯•'}`;
                }
            } catch (error) {
                console.error('âŒ åœ°å€è§£æå¤±è´¥:', error);
                // è§£æå¤±è´¥ï¼Œåªä¿å­˜æç¤º  
                window.locationData = {
                    latitude: lat,
                    longitude: lng,
                    accuracy: accuracy,
                    formattedAddress: `å®šä½æˆåŠŸï¼Œåœ°å€è§£æå¤±è´¥`,
                    province: '',
                    city: '',
                    district: ''
                };
                locationInput.value =
                    `âš ï¸ åœ°å€è§£ææœåŠ¡æš‚æ—¶ä¸å¯ç”¨\n` +
                    `ğŸ“Š å®šä½ç²¾åº¦: Â±${accuracy}ç±³\n` +
                    `ğŸ’¡ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•`;
            }
            // æ›´æ–°æŒ‰é’®çŠ¶æ€  
            locationBtn.disabled = false;
            locationBtn.textContent = 'âœ…å®šä½æˆåŠŸ';
            locationBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            locationBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            // éœ‡åŠ¨åé¦ˆ  
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
        },
        (error) => {
            console.error('âŒå®šä½å¤±è´¥:', error);
            let errorMsg = '';
            let suggestion = '';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'å®šä½æƒé™è¢«æ‹’ç»';
                    suggestion = 'è¯·åœ¨æ‰‹æœºè®¾ç½®ä¸­å…è®¸æµè§ˆå™¨ä½¿ç”¨å®šä½';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'GPSä¿¡å·ä¸å¯ç”¨';
                    suggestion = 'è¯·ç§»åŠ¨åˆ°å®¤å¤–æˆ–çª—è¾¹ï¼Œç¡®ä¿GPSå·²å¼€å¯';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'å®šä½è¶…æ—¶';
                    suggestion = 'è¯·ç¡®ä¿GPSå·²å¼€å¯ï¼Œæˆ–ç§»åŠ¨åˆ°ä¿¡å·è¾ƒå¥½çš„åœ°æ–¹';
                    break;
                default:
                    errorMsg = 'å®šä½å¤±è´¥';
                    suggestion = 'è¯·æ£€æŸ¥å®šä½æƒé™å’ŒGPSæ˜¯å¦å¼€å¯';
            }
            window.locationData = {
                latitude: 0,
                longitude: 0,
                accuracy: 0,
                formattedAddress: errorMsg,
                province: '',
                city: '',
                district: ''
            };
            locationInput.value = `âŒ ${errorMsg}ï¼ˆå¯ç»§ç»­ç­¾åˆ°ï¼‰`;
            locationBtn.disabled = false;
            locationBtn.textContent = 'ğŸ“é‡æ–°å®šä½';
            alert(`âš ï¸${errorMsg}\n\nğŸ’¡${suggestion}\n\næ‚¨ä»å¯ç»§ç»­ç­¾åˆ°ï¼Œç³»ç»Ÿå°†è®°å½•"${errorMsg}"`);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 30000,
            maximumAge: 0
        }
    );
}

        // Open camera for face recognition (ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆ)  
        async function openCamera() {
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“± æ‰“å¼€ç›¸æœº - ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆ');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            // 1. æ£€æŸ¥æ¨¡å‹åŠ è½½
            if (!faceModelsLoaded) {
                alert('äººè„¸è¯†åˆ«æ¨¡å‹åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            // 2. æ£€æŸ¥äººè„¸æ•°æ®
            if (labeledDescriptors.length === 0) {
                alert('âŒ ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰å­¦ç”Ÿäººè„¸æ•°æ®ï¼\n\nè¯·å…ˆåœ¨æ•™å¸ˆç«¯æ·»åŠ å­¦ç”Ÿç…§ç‰‡ä¿¡æ¯');
                return;
            }

            try {
                recognitionSuccess = false;
                document.getElementById('cameraBtn').disabled = true;
                document.getElementById('cameraBtn').textContent = 'æ­£åœ¨æ‰“å¼€ç›¸æœº...';

                // 3. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                console.log('æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ...');
                console.log('  User Agent:', navigator.userAgent);
                console.log('  Protocol:', location.protocol);
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç›¸æœºåŠŸèƒ½\n\nè¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Safari æˆ– Firefox');
                }

                // 4. æ£€æŸ¥ HTTPSï¼ˆé‡è¦ï¼ï¼‰
                const isLocalhost = ['localhost', '127.0.0.1', ''].includes(location.hostname);
                if (location.protocol === 'http:' && !isLocalhost) {
                    throw new Error('ç›¸æœºåŠŸèƒ½éœ€è¦ HTTPS è¿æ¥\n\nè¯·ä½¿ç”¨ HTTPS è®¿é—®é¡µé¢');
                }

                // 5. è¯·æ±‚ç›¸æœºæƒé™ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–çš„çº¦æŸæ¡ä»¶ï¼‰
                console.log('è¯·æ±‚ç›¸æœºæƒé™...');
                const constraints = {
                    video: {
                        facingMode: 'user', // å‰ç½®æ‘„åƒå¤´
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    },
                    audio: false
                };
                
                console.log('çº¦æŸæ¡ä»¶:', constraints);
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('âœ… ç›¸æœºæƒé™å·²æˆäºˆ');
                console.log('è§†é¢‘è½¨é“:', videoStream.getVideoTracks().length);

                // 6. é…ç½® video å…ƒç´ ï¼ˆç§»åŠ¨ç«¯å…³é”®ï¼ï¼‰
                const video = document.getElementById('video');
                const canvas = document.getElementById('faceCanvas');
                
                // ğŸ”¥ ç§»åŠ¨ç«¯å¿…é¡»è®¾ç½®è¿™äº›å±æ€§ï¼
                video.setAttribute('autoplay', '');
                video.setAttribute('playsinline', ''); // iOS Safari å¿…éœ€
                video.setAttribute('muted', '');
                video.muted = true; // é™éŸ³ï¼ˆé¿å…è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
                
                video.srcObject = videoStream;
                
                // 7. ç­‰å¾…è§†é¢‘åŠ è½½
                console.log('ç­‰å¾…è§†é¢‘åŠ è½½...');
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        console.log('âœ… è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½');
                        console.log('è§†é¢‘å°ºå¯¸:', video.videoWidth, 'x', video.videoHeight);
                        resolve();
                    };
                    
                    video.onerror = (e) => {
                        console.error('âŒ è§†é¢‘åŠ è½½é”™è¯¯:', e);
                        reject(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));
                    };
                    
                    // è¶…æ—¶å¤„ç†
                    setTimeout(() => {
                        reject(new Error('è§†é¢‘åŠ è½½è¶…æ—¶'));
                    }, 10000);
                });

                // 8. æ’­æ”¾è§†é¢‘ï¼ˆç§»åŠ¨ç«¯å¯èƒ½éœ€è¦æ‰‹åŠ¨æ’­æ”¾ï¼‰
                console.log('æ’­æ”¾è§†é¢‘...');
                try {
                    await video.play();
                    console.log('âœ… è§†é¢‘æ’­æ”¾æˆåŠŸ');
                } catch (playError) {
                    console.warn('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œå°è¯•ç”¨æˆ·äº¤äº’æ’­æ”¾:', playError);
                    // ç§»åŠ¨ç«¯å¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾
                    video.play().catch(e => {
                        console.error('æ’­æ”¾å¤±è´¥:', e);
                    });
                }

                // 9. æ˜¾ç¤ºç•Œé¢
                video.classList.remove('hidden');
                canvas.classList.remove('hidden');
                document.getElementById('videoPlaceholder').classList.add('hidden');
                document.getElementById('recognitionStatus').classList.remove('hidden');
                document.getElementById('recognitionStatus').innerHTML = 
                    '<p class="text-blue-800 font-semibold">ğŸ” æ­£åœ¨è¯†åˆ«äººè„¸ï¼Œè¯·æ­£å¯¹æ‘„åƒå¤´ä¿æŒ2-3ç§’...</p>';

                document.getElementById('cameraBtn').textContent = 'ğŸ”´ å…³é—­ç›¸æœº';
                document.getElementById('cameraBtn').onclick = stopCamera;
                document.getElementById('cameraBtn').disabled = false;

                // 10. å¼€å§‹äººè„¸æ£€æµ‹ï¼ˆç¡®ä¿è§†é¢‘æ­£åœ¨æ’­æ”¾ï¼‰
                const startDetection = () => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        console.log('âœ…å¼€å§‹äººè„¸æ£€æµ‹');
                        initLivenessCheck(); // ğŸ”¥åˆå§‹åŒ–æ´»ä½“æ£€æµ‹
                        faceDetectionRunning = true;
                        detectFaceLoop();
                    } else {
                        console.log('ç­‰å¾…è§†é¢‘æ•°æ®...');
                        setTimeout(startDetection, 100);
                    }
                };
                startDetection();
                
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('âœ… ç›¸æœºå¯åŠ¨æˆåŠŸ');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            } catch (error) {
                console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.error('âŒ ç›¸æœºå¯åŠ¨å¤±è´¥:', error);
                console.error('é”™è¯¯åç§°:', error.name);
                console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                
                // è¯¦ç»†çš„é”™è¯¯æç¤º
                let errorMessage = 'âŒ æ— æ³•æ‰“å¼€ç›¸æœº\n\n';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'åŸå› ï¼šç›¸æœºæƒé™è¢«æ‹’ç»\n\n';
                    errorMessage += 'ğŸ“± è§£å†³æ–¹æ³•ï¼š\n';
                    errorMessage += '1. ç‚¹å‡»åœ°å€æ çš„ ğŸ”’ æˆ– â“˜ å›¾æ ‡\n';
                    errorMessage += '2. æ‰¾åˆ°"ç›¸æœº"æƒé™\n';
                    errorMessage += '3. æ”¹ä¸º"å…è®¸"\n';
                    errorMessage += '4. åˆ·æ–°é¡µé¢é‡è¯•\n\n';
                    errorMessage += 'ğŸ’¡ æˆ–åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸æµè§ˆå™¨è®¿é—®ç›¸æœº';
                    
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'åŸå› ï¼šæœªæ‰¾åˆ°ç›¸æœºè®¾å¤‡\n\n';
                    errorMessage += 'ğŸ“± è¯·æ£€æŸ¥ï¼š\n';
                    errorMessage += '1. è®¾å¤‡æ˜¯å¦æœ‰å‰ç½®æ‘„åƒå¤´\n';
                    errorMessage += '2. æ‘„åƒå¤´æ˜¯å¦æ­£å¸¸å·¥ä½œ';
                    
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'åŸå› ï¼šç›¸æœºè¢«å ç”¨\n\n';
                    errorMessage += 'ğŸ“± è¯·å°è¯•ï¼š\n';
                    errorMessage += '1. å…³é—­å…¶ä»–ä½¿ç”¨ç›¸æœºçš„åº”ç”¨\n';
                    errorMessage += '2. åˆ·æ–°é¡µé¢é‡è¯•\n';
                    errorMessage += '3. é‡å¯æµè§ˆå™¨';
                    
                } else if (error.name === 'SecurityError' || error.message.includes('HTTPS')) {
                    errorMessage += 'åŸå› ï¼šå®‰å…¨é™åˆ¶\n\n';
                    errorMessage += 'ğŸ“± ç›¸æœºåŠŸèƒ½éœ€è¦ HTTPS è¿æ¥\n\n';
                    errorMessage += 'å½“å‰è¿æ¥ï¼š' + location.protocol + '\n';
                    errorMessage += 'è¯·ä½¿ç”¨ HTTPS è®¿é—®é¡µé¢';
                    
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += 'åŸå› ï¼šç›¸æœºä¸æ”¯æŒè¯·æ±‚çš„å‚æ•°\n\n';
                    errorMessage += 'ğŸ“± è¯·å°è¯•åˆ·æ–°é¡µé¢é‡è¯•';
                    
                } else {
                    errorMessage += 'é”™è¯¯è¯¦æƒ…ï¼š\n' + error.message + '\n\n';
                    errorMessage += 'ğŸ“± è¯·å°è¯•ï¼š\n';
                    errorMessage += '1. åˆ·æ–°é¡µé¢\n';
                    errorMessage += '2. é‡å¯æµè§ˆå™¨\n';
                    errorMessage += '3. æ£€æŸ¥ç³»ç»Ÿç›¸æœºæƒé™';
                }
                
                // æ£€æµ‹ç‰¹æ®Šæµè§ˆå™¨
                const ua = navigator.userAgent.toLowerCase();
                if (ua.includes('micromessenger')) {
                    errorMessage += '\n\nâš ï¸ æ£€æµ‹åˆ°å¾®ä¿¡æµè§ˆå™¨\n';
                    errorMessage += 'å»ºè®®ï¼šç‚¹å‡»å³ä¸Šè§’"..."é€‰æ‹©"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€"';
                } else if (ua.includes('qq/') || ua.includes('mqqbrowser')) {
                    errorMessage += '\n\nâš ï¸ æ£€æµ‹åˆ°QQæµè§ˆå™¨\n';
                    errorMessage += 'å»ºè®®ï¼šç‚¹å‡»å³ä¸Šè§’é€‰æ‹©"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€"';
                }
                
                alert(errorMessage);
                
                document.getElementById('cameraBtn').disabled = false;
                document.getElementById('cameraBtn').textContent = 'ğŸ“· æ‰“å¼€ç›¸æœºï¼ˆäººè„¸è¯†åˆ«ï¼‰';
            }
        }


// ==================== æ´»ä½“æ£€æµ‹åŠŸèƒ½ ====================

// åˆå§‹åŒ–æ´»ä½“æ£€æµ‹ï¼ˆéšæœºé€‰æ‹©2ä¸ªåŠ¨ä½œï¼‰
function initLivenessCheck() {
    const allActions = ['blink', 'mouth', 'nod'];
    
    const shuffled = allActions.sort(() => Math.random() - 0.5);
    livenessActions = shuffled.slice(0, 2);
    
    livenessProgress = {};
    livenessActions.forEach(action => {
        livenessProgress[action] = { completed: false, count: 0, required: action === 'nod' ? 1 : 2 };
    });
    
    livenessCheckPassed = false;
    
    // é‡ç½®æ‰€æœ‰æ£€æµ‹çŠ¶æ€
    blinkCount = 0;
    lastEyeState = 'open';
    eyeClosedFrames = 0;
    mouthOpenCount = 0;
    lastMouthState = 'closed';
    headPositions = [];
    nodCount = 0;
    
    // ğŸ”¥é‡ç½®åŠ¨æ€é˜ˆå€¼ç›¸å…³å˜é‡
    baselineEAR = null;
    earSamples = [];
    
    console.log('ğŸ² æ´»ä½“æ£€æµ‹å·²åˆå§‹åŒ–ï¼Œéœ€è¦å®Œæˆ:', livenessActions);
}

// çœ¨çœ¼æ£€æµ‹
function detectBlink(landmarks) {
    if (!livenessActions.includes('blink') || livenessProgress['blink'].completed) {
        return false;
    }
    
    function getEAR(eye) {
        const vertical1 = Math.hypot(eye[1].x - eye[5].x, eye[1].y - eye[5].y);
        const vertical2 = Math.hypot(eye[2].x - eye[4].x, eye[2].y - eye[4].y);
        const horizontal = Math.hypot(eye[0].x - eye[3].x, eye[0].y - eye[3].y);
        return (vertical1 + vertical2) / (2.0 * horizontal);
    }
    
    const leftEye = [
        landmarks.getLeftEye()[0], landmarks.getLeftEye()[1], landmarks.getLeftEye()[2],
        landmarks.getLeftEye()[3], landmarks.getLeftEye()[4], landmarks.getLeftEye()[5]
    ];
    
    const rightEye = [
        landmarks.getRightEye()[0], landmarks.getRightEye()[1], landmarks.getRightEye()[2],
        landmarks.getRightEye()[3], landmarks.getRightEye()[4], landmarks.getRightEye()[5]
    ];
    
    const leftEAR = getEAR(leftEye);
    const rightEAR = getEAR(rightEye);
    const avgEAR = (leftEAR + rightEAR) / 2.0;
    
    // ğŸ”¥åŠ¨æ€å»ºç«‹ççœ¼åŸºå‡†å€¼ï¼ˆé‡‡é›†å‰10å¸§çš„å¹³å‡å€¼ï¼‰
    if (earSamples.length < SAMPLE_SIZE) {
        earSamples.push(avgEAR);
        if (earSamples.length === SAMPLE_SIZE) {
            baselineEAR = earSamples.reduce((a, b) => a + b, 0) / SAMPLE_SIZE;
            console.log(`ğŸ‘ï¸ ççœ¼åŸºå‡†å€¼å·²å»ºç«‹: ${baselineEAR.toFixed(3)}`);
        }
        return false;
    }
    
    // ğŸ”¥åŠ¨æ€é˜ˆå€¼ï¼šåŸºå‡†å€¼çš„85%ï¼ˆå³EARä¸‹é™15%æ—¶åˆ¤å®šä¸ºé—­çœ¼ï¼‰
    const dynamicThreshold = baselineEAR * 0.85;
    const currentState = avgEAR < dynamicThreshold ? 'closed' : 'open';
    
    // è°ƒè¯•ä¿¡æ¯ï¼ˆæ¯10å¸§æ‰“å°ä¸€æ¬¡ï¼‰
    if (Math.random() < 0.1) {
        console.log(`ğŸ‘ï¸ EAR: ${avgEAR.toFixed(3)} | åŠ¨æ€é˜ˆå€¼: ${dynamicThreshold.toFixed(3)} | çŠ¶æ€: ${currentState}`);
    }
    
    if (currentState === 'closed') {
        eyeClosedFrames++;
    } else {
        if (eyeClosedFrames >= 1 && lastEyeState === 'closed') {
            blinkCount++;
            livenessProgress['blink'].count = blinkCount;
            console.log(`âœ… çœ¨çœ¼æ£€æµ‹æˆåŠŸï¼å½“å‰: ${blinkCount}/${livenessProgress['blink'].required}`);
            
            if (blinkCount >= livenessProgress['blink'].required) {
                livenessProgress['blink'].completed = true;
                console.log('âœ…âœ… çœ¨çœ¼ä»»åŠ¡å®Œæˆï¼');
            }
            
            eyeClosedFrames = 0;
            lastEyeState = 'open';
            return true;
        }
        eyeClosedFrames = 0;
        lastEyeState = 'open';
    }
    
    if (eyeClosedFrames >= 1 && lastEyeState === 'open') {
        lastEyeState = 'closed';
        console.log('ğŸ‘ï¸ æ£€æµ‹åˆ°é—­çœ¼');
    }
    
    return false;
}

// å¼ å˜´æ£€æµ‹
function detectMouthOpen(landmarks) {
    if (!livenessActions.includes('mouth') || livenessProgress['mouth'].completed) {
        return false;
    }
    
    const mouth = landmarks.getMouth();
    
    const vertical1 = Math.hypot(mouth[13].x - mouth[19].x, mouth[13].y - mouth[19].y);
    const vertical2 = Math.hypot(mouth[14].x - mouth[18].x, mouth[14].y - mouth[18].y);
    const vertical3 = Math.hypot(mouth[15].x - mouth[17].x, mouth[15].y - mouth[17].y);
    const horizontal = Math.hypot(mouth[0].x - mouth[6].x, mouth[0].y - mouth[6].y);
    
    const MAR = (vertical1 + vertical2 + vertical3) / (3.0 * horizontal);
    const MAR_THRESHOLD = 0.5;
    const currentState = MAR > MAR_THRESHOLD ? 'open' : 'closed';
    
    if (lastMouthState === 'closed' && currentState === 'open') {
        lastMouthState = 'open';
    } else if (lastMouthState === 'open' && currentState === 'closed') {
        mouthOpenCount++;
        lastMouthState = 'closed';
        livenessProgress['mouth'].count = mouthOpenCount;
        console.log(`ğŸ‘„ å¼ å˜´æ£€æµ‹: ${mouthOpenCount}/${livenessProgress['mouth'].required}`);
        
        if (mouthOpenCount >= livenessProgress['mouth'].required) {
            livenessProgress['mouth'].completed = true;
            console.log('âœ… å¼ å˜´æ£€æµ‹å®Œæˆï¼');
        }
        
        return true;
    }
    
    return false;
}

// ç‚¹å¤´æ£€æµ‹
function detectNod(detection) {
    if (!livenessActions.includes('nod') || livenessProgress['nod'].completed) {
        return false;
    }
    
    const box = detection.detection.box;
    const currentY = box.y + box.height / 2;
    
    headPositions.push(currentY);
    if (headPositions.length > 30) {
        headPositions.shift();
    }
    
    if (headPositions.length < 30) {
        return false;
    }
    
    const maxY = Math.max(...headPositions);
    const minY = Math.min(...headPositions);
    const movement = maxY - minY;
    
    if (movement > 30) {
        nodCount++;
        headPositions = [];
        livenessProgress['nod'].count = nodCount;
        console.log(`ğŸ”½ ç‚¹å¤´æ£€æµ‹: ${nodCount}/${livenessProgress['nod'].required}`);
        
        if (nodCount >= livenessProgress['nod'].required) {
            livenessProgress['nod'].completed = true;
            console.log('âœ… ç‚¹å¤´æ£€æµ‹å®Œæˆï¼');
        }
        
        return true;
    }
    
    return false;
}

// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åŠ¨ä½œéƒ½å®Œæˆ
function checkLivenessComplete() {
    const allCompleted = livenessActions.every(action => livenessProgress[action].completed);
    if (allCompleted && !livenessCheckPassed) {
        livenessCheckPassed = true;
        console.log('âœ… æ´»ä½“æ£€æµ‹å…¨éƒ¨é€šè¿‡ï¼');
        return true;
    }
    return false;
}

// è·å–æ´»ä½“æ£€æµ‹æç¤ºæ–‡æœ¬
function getLivenessHintHTML() {
    const actionNames = {
        'blink': 'ğŸ‘ï¸ çœ¨çœ¼',
        'mouth': 'ğŸ‘„ å¼ å˜´',
        'nod': 'ğŸ”½ ç‚¹å¤´'
    };
    
    let html = '<p class="text-blue-600 font-bold text-lg">æ´»ä½“æ£€æµ‹</p><div class="mt-2 space-y-1">';
    
    livenessActions.forEach(action => {
        const progress = livenessProgress[action];
        const completed = progress.completed;
        const color = completed ? 'text-green-600' : 'text-blue-600';
        const icon = completed ? 'âœ…' : 'â³';
        
        html += `
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <span class="${color} font-semibold">${icon} ${actionNames[action]}</span>
                <span class="${color} font-bold">${progress.count}/${progress.required}</span>
            </div>
        `;
    });
    
    html += '</div><p class="text-gray-600 mt-2 text-xs">ğŸ’¡ è‡ªç„¶å®ŒæˆåŠ¨ä½œå³å¯ï¼Œä¸è¦åˆ»æ„å¿«é€Ÿæ“ä½œ</p>';
    
    return html;
}


// ==================== äººè„¸æ£€æµ‹å¾ªç¯ï¼ˆå¤šå¸§éªŒè¯ + è¯†åˆ«é”å®šï¼‰ ====================
async function detectFaceLoop() {
    // ğŸ”¥ ä¿®å¤1ï¼šå¦‚æœå·²ç»è¯†åˆ«æˆåŠŸï¼Œç›´æ¥é€€å‡ºå¾ªç¯
    if (recognitionSuccess) {
        console.log('âœ… å·²è¯†åˆ«æˆåŠŸï¼Œåœæ­¢æ£€æµ‹');
        return;
    }

    // å¦‚æœæ£€æµ‹å·²åœæ­¢ï¼Œé€€å‡ºå¾ªç¯
    if (!faceDetectionRunning) {
        console.log('ğŸ›‘ äººè„¸æ£€æµ‹å¾ªç¯å·²åœæ­¢');
        return;
    }

    const video = document.getElementById('video');
    const canvas = document.getElementById('faceCanvas');
    const statusElement = document.getElementById('recognitionStatus');

    // æ£€æŸ¥è§†é¢‘æµæ˜¯å¦æœ‰æ•ˆ
    if (!video || !video.srcObject) {
        console.error('âŒ è§†é¢‘æµæ— æ•ˆï¼Œåœæ­¢æ£€æµ‹');
        faceDetectionRunning = false;
        if (statusElement) {
            statusElement.innerHTML = '<p class="text-red-600 font-semibold">âŒ æ‘„åƒå¤´è¿æ¥å¤±è´¥</p>';
        }
        return;
    }

    const ctx = canvas.getContext('2d');

    try {
        // ========== ç¬¬ä¸€æ­¥ï¼šæ£€æµ‹äººè„¸ ==========
        const detections = await faceapi
            .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                inputSize: 416,
                scoreThreshold: 0.5
            }))
            .withFaceLandmarks()
            .withFaceDescriptors();

        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ========== ç¬¬äºŒæ­¥ï¼šå¤„ç†æ£€æµ‹ç»“æœ ==========
        if (detections.length > 0) {
            // è°ƒæ•´ Canvas å°ºå¯¸ä»¥åŒ¹é…è§†é¢‘
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            canvas.width = displaySize.width;
            canvas.height = displaySize.height;

            // è°ƒæ•´æ£€æµ‹ç»“æœå°ºå¯¸
            const resizedDetections = faceapi.resizeResults(detections, displaySize);

            // ç»˜åˆ¶æ£€æµ‹æ¡†å’Œå…³é”®ç‚¹
            faceapi.draw.drawDetections(canvas, resizedDetections);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);


            // ========== ç¬¬ä¸‰æ­¥ï¼šæ´»ä½“æ£€æµ‹ï¼ˆåœ¨äººè„¸è¯†åˆ«ä¹‹å‰ï¼‰==========
            if (!livenessCheckPassed && resizedDetections.length > 0) {
                const firstDetection = resizedDetections[0];
                const landmarks = firstDetection.landmarks;
                
                // æ‰§è¡Œå„é¡¹æ£€æµ‹
                if (livenessActions.includes('blink')) {
                    detectBlink(landmarks);
                }
                if (livenessActions.includes('mouth')) {
                    detectMouthOpen(landmarks);
                }
                if (livenessActions.includes('nod')) {
                    detectNod(firstDetection);
                }
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                checkLivenessComplete();
                
                // æ›´æ–°æç¤º
                if (statusElement) {
                    statusElement.innerHTML = getLivenessHintHTML();
                }
            }

            // å¦‚æœæ´»ä½“æ£€æµ‹æœªé€šè¿‡ï¼Œä¸è¿›è¡Œäººè„¸è¯†åˆ«
            if (!livenessCheckPassed) {
                if (faceDetectionRunning) {
                    requestAnimationFrame(detectFaceLoop);
                }
                return;
            }

            // ========== ç¬¬å››æ­¥ï¼šäººè„¸è¯†åˆ«åŒ¹é…ï¼ˆæ´»ä½“æ£€æµ‹é€šè¿‡åæ‰æ‰§è¡Œï¼‰==========

            if (!labeledDescriptors || labeledDescriptors.length === 0) {
                // æ²¡æœ‰åŠ è½½äººè„¸åº“
                if (statusElement) {
                    statusElement.innerHTML =
                        '<p class="text-red-600 font-semibold">âŒ äººè„¸åº“æœªåŠ è½½ï¼Œæ— æ³•è¯†åˆ«<br/><small>è¯·åˆ·æ–°é¡µé¢é‡è¯•</small></p>';
                }
            } else {
                // ä½¿ç”¨è¾ƒä½çš„åŒ¹é…é˜ˆå€¼ï¼Œå…ˆè·å–æ‰€æœ‰å¯èƒ½çš„åŒ¹é…
                const MATCH_THRESHOLD = 0.50;
                const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, MATCH_THRESHOLD);
                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                // ========== ç¬¬å››æ­¥ï¼šå¤„ç†è¯†åˆ«ç»“æœ ==========
                let currentBestMatch = null;
                let currentBestConfidence = 0;
                let minDistance = Infinity;

                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    const distance = result.distance;
                    const confidence = (1 - distance) * 100;
                    
                    minDistance = Math.min(minDistance, distance);

                    if (result.label !== 'unknown' && confidence >= MIN_CONFIDENCE * 100) {
                        // è§£æå­¦ç”Ÿä¿¡æ¯
                        const parts = result.label.split('|');
                        const studentId = parts[0] || '';
                        const name = parts[1] || 'æœªçŸ¥';
                        const studentClass = parts[2] || '';

                        console.log(`ğŸ¯ æ£€æµ‹åˆ°: ${name} (${studentId}) | ç½®ä¿¡åº¦: ${confidence.toFixed(1)}% | è·ç¦»: ${distance.toFixed(3)}`);

                        // è®°å½•åˆ°å¤šå¸§éªŒè¯é˜Ÿåˆ—
                        if (!currentBestMatch || confidence > currentBestConfidence) {
                            currentBestMatch = {
                                studentId: studentId,
                                name: name,
                                studentClass: studentClass,
                                confidence: confidence,
                                distance: distance,
                                box: box,
                                label: result.label
                            };
                            currentBestConfidence = confidence;
                        }
                    } else if (result.label !== 'unknown') {
                        const parts = result.label.split('|');
                        const name = parts[1] || 'æœªçŸ¥';
                        console.log(`âš ï¸ ä½ç½®ä¿¡åº¦: ${name} | ${confidence.toFixed(1)}% (éœ€è¦ â‰¥${MIN_CONFIDENCE * 100}%)`);
                    }
                });

                // ========== ç¬¬äº”æ­¥ï¼šå¤šå¸§éªŒè¯ ==========
                if (currentBestMatch) {
                    // æ·»åŠ åˆ°æœ€è¿‘åŒ¹é…é˜Ÿåˆ—
                    recentMatches.push({
                        studentId: currentBestMatch.studentId,
                        name: currentBestMatch.name,
                        studentClass: currentBestMatch.studentClass,
                        confidence: currentBestMatch.confidence,
                        timestamp: Date.now()
                    });

                    // åªä¿ç•™æœ€è¿‘çš„å¸§æ•°
                    if (recentMatches.length > CONSECUTIVE_FRAMES) {
                        recentMatches.shift();
                    }

                    // æ£€æŸ¥æ˜¯å¦è¿ç»­åŒ¹é…
                    if (recentMatches.length >= CONSECUTIVE_FRAMES) {
                        // æ£€æŸ¥æœ€è¿‘Nå¸§æ˜¯å¦éƒ½æ˜¯åŒä¸€ä¸ªäºº
                        const firstMatch = recentMatches[0];
                        const allSamePerson = recentMatches.every(m => 
                            m.studentId === firstMatch.studentId && 
                            m.confidence >= MIN_CONFIDENCE * 100
                        );

                        if (allSamePerson) {
                            // ========== è¿ç»­å¸§éªŒè¯é€šè¿‡ï¼==========
                            const avgConfidence = (recentMatches.reduce((sum, m) => sum + m.confidence, 0) / recentMatches.length).toFixed(1);
                            
                            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                            console.log(`âœ… è¿ç»­ ${CONSECUTIVE_FRAMES} å¸§éªŒè¯é€šè¿‡ï¼`);
                            console.log(`   å­¦ç”Ÿ: ${firstMatch.name} (${firstMatch.studentId})`);
                            console.log(`   å¹³å‡ç½®ä¿¡åº¦: ${avgConfidence}%`);
                            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                            // éªŒè¯ç­çº§
                            let isInActiveClass = false;
                            let activeClassNames = [];

                            if (activeSessions.length > 0) {
                                activeSessions.forEach(session => {
                                    const classNames = session.get('classNames') || [session.get('className')];
                                    activeClassNames = activeClassNames.concat(classNames);
                                });
                                isInActiveClass = activeClassNames.includes(firstMatch.studentClass);
                            }

                            if (!isInActiveClass && activeSessions.length > 0) {
                                // ========== ä¸å±äºå½“å‰ç­¾åˆ°ç­çº§ ==========
                                console.warn(`âš ï¸ ${firstMatch.name} ä¸å±äºå½“å‰ç­¾åˆ°ç­çº§`);

                                // ç»˜åˆ¶æ©™è‰²è­¦å‘Šæ¡†
                                const drawBox = new faceapi.draw.DrawBox(currentBestMatch.box, {
                                    label: `${firstMatch.name} - éå½“å‰ç­çº§`,
                                    boxColor: '#ff9800',
                                    lineWidth: 3
                                });
                                drawBox.draw(canvas);

                                // æ˜¾ç¤ºè­¦å‘Šæç¤º
                                if (statusElement) {
                                    statusElement.innerHTML =
                                        `<p class="text-orange-600 font-bold text-lg">
                                            âš ï¸ è¯†åˆ«æˆåŠŸï¼Œä½†ä¸å±äºå½“å‰ç­¾åˆ°ç­çº§
                                        </p>
                                        <p class="text-gray-700 mt-2">
                                            è¯†åˆ«å§“åï¼š<span class="font-bold">${firstMatch.name}</span><br/>
                                            å­¦ç”Ÿç­çº§ï¼š<span class="font-bold text-orange-600">${firstMatch.studentClass}</span><br/>
                                            å¹³å‡ç½®ä¿¡åº¦ï¼š<span class="font-bold text-orange-600">${avgConfidence}%</span>
                                        </p>
                                        <p class="text-red-600 mt-2 font-semibold">
                                            âŒ å½“å‰ç­¾åˆ°ç­çº§ï¼š${activeClassNames.join('ã€')}
                                        </p>
                                        <p class="text-gray-600 mt-2 text-sm">
                                            ğŸ’¡ å¦‚æœä¿¡æ¯æ­£ç¡®ï¼Œè¯·è”ç³»æ•™å¸ˆç¡®è®¤ï¼›<br/>
                                            å¦‚æœè¯†åˆ«é”™è¯¯ï¼Œè¯·æ‰‹åŠ¨å¡«å†™æ­£ç¡®ä¿¡æ¯
                                        </p>`;
                                }

                                // æ¸…ç©ºåŒ¹é…é˜Ÿåˆ—ï¼Œç»§ç»­æ£€æµ‹
                                recentMatches = [];

                            } else {
                                // ========== å±äºå½“å‰ç­¾åˆ°ç­çº§ï¼Œè¯†åˆ«æˆåŠŸï¼==========
                                // ğŸ”¥ ä¿®å¤2ï¼šç«‹å³åœæ­¢æ£€æµ‹
                                recognitionSuccess = true;
                                faceDetectionRunning = false;

                                // ğŸ”¥é‡ç½®æ´»ä½“æ£€æµ‹
                                livenessCheckPassed = false;
                                livenessActions = [];
                                livenessProgress = {};

                                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                                console.log('âœ… è¯†åˆ«æˆåŠŸï¼åœæ­¢æ£€æµ‹å¾ªç¯');
                                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                                // ç»˜åˆ¶ç»¿è‰²è¯†åˆ«æ¡†
                                const drawBox = new faceapi.draw.DrawBox(currentBestMatch.box, {
                                    label: `${firstMatch.name} (${avgConfidence}%)`,
                                    boxColor: '#00ff00',
                                    lineWidth: 4
                                });
                                drawBox.draw(canvas);

                                // è‡ªåŠ¨å¡«å……è¡¨å•
                                const classInput = document.getElementById('stuClass');
                                const idInput = document.getElementById('stuId');
                                const nameInput = document.getElementById('stuName');

                                if (classInput) classInput.value = firstMatch.studentClass;
                                if (idInput) idInput.value = firstMatch.studentId;
                                if (nameInput) nameInput.value = firstMatch.name;

                                // æ˜¾ç¤ºæˆåŠŸæç¤º
                                if (statusElement) {
                                    statusElement.innerHTML =
                                        `<p class="text-green-600 font-bold text-xl animate-pulse">
                                            âœ… è¯†åˆ«æˆåŠŸï¼š${firstMatch.name}
                                        </p>
                                        <p class="text-gray-700 mt-2">
                                            ğŸ“Š å¹³å‡ç½®ä¿¡åº¦: <span class="font-bold text-green-600">${avgConfidence}%</span><br/>
                                            ğŸ“š ç­çº§: ${firstMatch.studentClass}<br/>
                                            âœ… è¿ç»­ ${CONSECUTIVE_FRAMES} å¸§éªŒè¯é€šè¿‡
                                        </p>
                                        <p class="text-blue-600 mt-2 text-sm">
                                            ğŸ“· ç›¸æœºå°†åœ¨ 2 ç§’åè‡ªåŠ¨å…³é—­
                                        </p>`;
                                }

                                // 2ç§’åè‡ªåŠ¨å…³é—­ç›¸æœº
                                setTimeout(() => {
                                    console.log('ğŸ“· 2ç§’åè‡ªåŠ¨å…³é—­ç›¸æœº...');
                                    stopCamera();
                                    recognitionSuccess = false;  // é‡ç½®æ ‡å¿—
                                    recentMatches = [];
                                }, 2000);
                                
                                // ğŸ”¥ ä¿®å¤3ï¼šç«‹å³è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­ä»£ç 
                                return;
                            }
                        } else {
                            // ä¸æ˜¯åŒä¸€ä¸ªäººï¼Œæˆ–è€…ç½®ä¿¡åº¦ä¸ç¨³å®š
                            const uniquePeople = [...new Set(recentMatches.map(m => m.name))];
                            console.log(`âš ï¸ æœ€è¿‘ ${recentMatches.length} å¸§æ£€æµ‹åˆ°å¤šäºº: ${uniquePeople.join(', ')}`);
                            
                            // æ¸…ç©ºé˜Ÿåˆ—ï¼Œé‡æ–°å¼€å§‹
                            recentMatches = [];
                        }
                    }

                    // ========== æ˜¾ç¤ºå®æ—¶è¿›åº¦ ==========
                    if (statusElement) {
                        const progress = recentMatches.length;
                        const needed = CONSECUTIVE_FRAMES;
                        const progressPercent = Math.round((progress / needed) * 100);

                        statusElement.innerHTML =
                            `<p class="text-blue-600 font-bold text-lg">
                                ğŸ” æ­£åœ¨è¯†åˆ«ï¼š${currentBestMatch.name}
                            </p>
                            <p class="text-gray-700 mt-2">
                                å½“å‰ç½®ä¿¡åº¦: <span class="font-bold ${currentBestMatch.confidence >= MIN_CONFIDENCE * 100 ? 'text-green-600' : 'text-orange-600'}">${currentBestMatch.confidence.toFixed(1)}%</span><br/>
                                éªŒè¯è¿›åº¦: <span class="font-bold text-blue-600">${progress}/${needed} å¸§</span>
                            </p>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                            </div>
                            <p class="text-gray-600 mt-2 text-xs">
                                ğŸ’¡ ä¿æŒå§¿åŠ¿ä¸åŠ¨ ${needed - progress} å¸§...
                            </p>`;
                    }

                } else {
                    // å½“å‰å¸§æ²¡æœ‰é«˜ç½®ä¿¡åº¦åŒ¹é…ï¼Œæ¸…ç©ºé˜Ÿåˆ—
                    if (recentMatches.length > 0) {
                        console.log('âš ï¸ å½“å‰å¸§æ— åŒ¹é…ï¼Œæ¸…ç©ºéªŒè¯é˜Ÿåˆ—');
                        recentMatches = [];
                    }

                    // æ˜¾ç¤ºå½“å‰çŠ¶æ€
                    if (statusElement) {
                        const confidence = ((1 - minDistance) * 100).toFixed(1);
                        
                        if (minDistance < 0.50) {
                            statusElement.innerHTML =
                                `<p class="text-orange-600 font-semibold text-lg">
                                    âš ï¸ æ£€æµ‹åˆ°äººè„¸ä½†ç½®ä¿¡åº¦ä¸ç¨³å®š
                                </p>
                                <p class="text-gray-700 mt-2">
                                    å½“å‰ç½®ä¿¡åº¦: <span class="text-orange-600 font-bold">${confidence}%</span><br/>
                                    éœ€è¦ç½®ä¿¡åº¦: <span class="text-green-600 font-bold">â‰¥ ${MIN_CONFIDENCE * 100}%</span>
                                </p>
                                <p class="text-gray-600 mt-2 text-sm">
                                    ğŸ’¡ å»ºè®®ï¼š<br/>
                                    âœ“ ä¿æŒå§¿åŠ¿ä¸åŠ¨<br/>
                                    âœ“ æ­£å¯¹æ‘„åƒå¤´<br/>
                                    âœ“ è°ƒæ•´å…‰çº¿
                                </p>`;
                        } else if (minDistance < 0.7) {
                            statusElement.innerHTML =
                                `<p class="text-orange-600 font-semibold">
                                    âš ï¸ æ£€æµ‹åˆ°äººè„¸ä½†æœªæ‰¾åˆ°åŒ¹é…
                                </p>
                                <p class="text-gray-700 mt-2">
                                    ç›¸ä¼¼åº¦: <span class="text-red-600 font-bold">${confidence}%</span>ï¼ˆè¿‡ä½ï¼‰
                                </p>
                                <p class="text-gray-600 mt-2 text-sm">
                                    âœ“ ç¡®ä¿å·²å½•å…¥ç…§ç‰‡<br/>
                                    âœ“ æ­£å¯¹æ‘„åƒå¤´<br/>
                                    âœ“ å…‰çº¿å……è¶³
                                </p>`;
                        } else {
                            statusElement.innerHTML =
                                `<p class="text-red-600 font-semibold">
                                    âŒ æ£€æµ‹åˆ°äººè„¸ä½†å·®å¼‚è¿‡å¤§
                                </p>
                                <p class="text-gray-700 mt-2">
                                    ç›¸ä¼¼åº¦: <span class="text-red-600 font-bold">${confidence}%</span>
                                </p>
                                <p class="text-gray-600 mt-2 text-sm">
                                    ğŸ’¡ è¯·æ‰‹åŠ¨å¡«å†™ä¿¡æ¯ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜å½•å…¥ç…§ç‰‡
                                </p>`;
                        }
                    }
                }
            }

        } else {
            // ========== æœªæ£€æµ‹åˆ°äººè„¸ ==========
            if (recentMatches.length > 0) {
                recentMatches = [];
            }

            if (statusElement) {
                statusElement.innerHTML =
                    `<p class="text-blue-600 font-semibold">
                        ğŸ” æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·è°ƒæ•´ä½ç½®...
                    </p>
                    <p class="text-gray-600 mt-2 text-sm">
                        âœ“ é¢éƒ¨æ­£å¯¹æ‘„åƒå¤´<br/>
                        âœ“ ä¿æŒé€‚å½“è·ç¦»<br/>
                        âœ“ å…‰çº¿å……è¶³
                    </p>`;
            }
        }

        // ========== ç¬¬å…­æ­¥ï¼šç»§ç»­æ£€æµ‹å¾ªç¯ ==========
        if (faceDetectionRunning) {
            requestAnimationFrame(detectFaceLoop);
        }

    } catch (error) {
        console.error('âŒ äººè„¸æ£€æµ‹é”™è¯¯:', error);

        const statusElement = document.getElementById('recognitionStatus');
        if (statusElement) {
            statusElement.innerHTML =
                `<p class="text-red-600 font-semibold">
                    âŒ æ£€æµ‹å‡ºé”™: ${error.message}
                    <br/><small>ç»§ç»­å°è¯•ä¸­...</small>
                </p>`;
        }

        if (faceDetectionRunning) {
            requestAnimationFrame(detectFaceLoop);
        }
    }
}


        // Stop camera
        function stopCamera() {
            faceDetectionRunning = false;
            recognitionSuccess = false; // é‡ç½®è¯†åˆ«æˆåŠŸæ ‡å¿—

            // ğŸ”¥é‡ç½®æ´»ä½“æ£€æµ‹
            livenessCheckPassed = false;
            livenessActions = [];
            livenessProgress = {};
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('faceCanvas');
            const ctx = canvas.getContext('2d');
            
            video.classList.add('hidden');
            canvas.classList.add('hidden');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            
            document.getElementById('cameraBtn').textContent = 'ğŸ“· æ‰“å¼€ç›¸æœºï¼ˆäººè„¸è¯†åˆ«ï¼‰';
            document.getElementById('cameraBtn').onclick = openCamera;
        }


        // ==================== æäº¤ç­¾åˆ°ï¼ˆä¿å­˜è¯¦ç»†åœ°å€ï¼‰====================  
        async function submitCheckIn() {
            const stuClass = document.getElementById('stuClass').value.trim();
            const stuId = document.getElementById('stuId').value.trim();
            const stuName = document.getElementById('stuName').value.trim();
            const location = document.getElementById('location').value.trim();
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“æäº¤ç­¾åˆ°');
            console.log('ç­çº§:', stuClass);
            console.log('å­¦å·:', stuId);
            console.log('å§“å:', stuName);
            console.log('å®šä½:', location || 'æœªè·å–');
            if (!stuClass || !stuId || !stuName) {
                alert('âŒè¯·å¡«å†™å®Œæ•´ä¿¡æ¯\n\nç­çº§ã€å­¦å·ã€å§“åä¸ºå¿…å¡«é¡¹');
                return;
            }
            if (activeSessions.length === 0) {
                alert('âŒå½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„ç­¾åˆ°ä»»åŠ¡');
                return;
            }
            let matchedSession = null;
            for (const session of activeSessions) {
                const classNames = session.get('classNames') || [session.get('className')];
                if (classNames.includes(stuClass)) {
                    matchedSession = session;
                    break;
                }
            }
            if (!matchedSession) {
                const allClasses = activeSessions.map(s =>
                    (s.get('classNames') || [s.get('className')]).join('ã€')
                ).join('\n');
                alert(`âŒæ‚¨çš„ç­çº§"${stuClass}"å½“å‰æ²¡æœ‰ç­¾åˆ°ä»»åŠ¡\n\næ­£åœ¨ç­¾åˆ°çš„ç­çº§ï¼š\n${allClasses}`);
                return;
            }
            const courseName = matchedSession.get('courseName');
            const courseSession = matchedSession.get('courseSession');
            // ğŸ”¥ è·å–è¯¦ç»†åœ°å€ä¿¡æ¯  
            const locationData = window.locationData || {
                latitude: 0,
                longitude: 0,
                accuracy: 0,
                formattedAddress: location || 'æœªè·å–å®šä½',
                province: '',
                city: '',
                district: ''
            };
            // æ„å»ºç¡®è®¤ä¿¡æ¯  
            let confirmMessage = `ç¡®è®¤ç­¾åˆ°ä¿¡æ¯ï¼š\n\n`;
            confirmMessage += `è¯¾ç¨‹ï¼š${courseName}\n`;
            confirmMessage += `èŠ‚æ¬¡ï¼š${courseSession}\n`;
            confirmMessage += `ç­çº§ï¼š${stuClass}\n`;
            confirmMessage += `å­¦å·ï¼š${stuId}\n`;
            confirmMessage += `å§“åï¼š${stuName}\n`;
            confirmMessage += `\nğŸ“ å®šä½ä¿¡æ¯ï¼š\n`;
            if (locationData.formattedAddress) {
                confirmMessage += `åœ°å€ï¼š${locationData.formattedAddress}\n`;
            }
            if (locationData.poiName) {
                confirmMessage += `é™„è¿‘ï¼š${locationData.poiName}\n`;
            }
            if (locationData.accuracy > 0) {
                confirmMessage += `ç²¾åº¦ï¼šÂ±${locationData.accuracy}ç±³\n`;
            }
            confirmMessage += `\nç¡®è®¤æäº¤ï¼Ÿ`;
            if (!confirm(confirmMessage)) {
                return;
            }
            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç»ç­¾åˆ°  
                const checkQuery = new AV.Query('CheckInRecord');
                checkQuery.equalTo('sessionId', matchedSession.id);
                checkQuery.equalTo('studentId', stuId);
                const existingRecord = await checkQuery.first();
                if (existingRecord) {
                    const existingTime = existingRecord.get('checkInTime');
                    alert(`âš ï¸æ‚¨å·²ç»ç­¾åˆ°è¿‡äº†ï¼\n\nç­¾åˆ°æ—¶é—´ï¼š${new Date(existingTime).toLocaleString('zh-CN')}`);
                    return;
                }
                // ğŸ”¥ åˆ›å»ºç­¾åˆ°è®°å½•ï¼ˆåŒ…å«è¯¦ç»†åœ°å€ä¿¡æ¯ï¼‰  
                const CheckInRecord = AV.Object.extend('CheckInRecord');
                const record = new CheckInRecord();
                // åŸºæœ¬ä¿¡æ¯  
                record.set('sessionId', matchedSession.id);
                record.set('courseName', courseName);
                record.set('courseSession', courseSession);
                record.set('className', stuClass);
                record.set('studentId', stuId);
                record.set('studentName', stuName);
                record.set('checkInTime', new Date());
                record.set('method', recognitionSuccess ? 'face' : 'manual');
                // ğŸ”¥ è¯¦ç»†å®šä½ä¿¡æ¯  
                record.set('latitude', locationData.latitude || 0);
                record.set('longitude', locationData.longitude || 0);
                record.set('accuracy', locationData.accuracy || 0);
                record.set('formattedAddress', locationData.formattedAddress || 'æœªè·å–å®šä½');
                record.set('province', locationData.province || '');
                record.set('city', locationData.city || '');
                record.set('district', locationData.district || '');
                record.set('township', locationData.township || '');
                record.set('street', locationData.street || '');
                record.set('streetNumber', locationData.streetNumber || '');
                record.set('poiName', locationData.poiName || '');
                record.set('poiType', locationData.poiType || '');
                record.set('poiDistance', locationData.poiDistance || '');
                // åŸå§‹locationå­—æ®µï¼ˆå…¼å®¹æ€§ï¼‰
                record.set('location', locationData.formattedAddress || location || 'æœªè·å–å®šä½');
                await record.save();
                console.log('âœ…ç­¾åˆ°è®°å½•å·²ä¿å­˜');
                console.log('è¯¦ç»†åœ°å€:', locationData.formattedAddress);
                // æ›´æ–°ç­¾åˆ°äººæ•°
                const currentCount = matchedSession.get('checkedInCount') || 0;
                matchedSession.set('checkedInCount', currentCount + 1);
                await matchedSession.save();
                // ğŸ”¥ é‡æ–°åŠ è½½ç­¾åˆ°ä»»åŠ¡ï¼ˆæ›´æ–°ç•Œé¢ï¼‰
                await refreshSessions();
                console.log('âœ…ç­¾åˆ°æˆåŠŸï¼');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
                // æ„å»ºæˆåŠŸæ¶ˆæ¯
                let successMessage = `âœ…ç­¾åˆ°æˆåŠŸï¼\n\n`;
                successMessage += `è¯¾ç¨‹ï¼š${courseName}\n`;
                successMessage += `èŠ‚æ¬¡ï¼š${courseSession}\n`;
                successMessage += `å§“åï¼š${stuName}\n`;
                successMessage += `æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\n`;
                if (locationData.formattedAddress && locationData.formattedAddress !== 'æœªè·å–å®šä½') {
                    successMessage += `\nğŸ“ç­¾åˆ°åœ°ç‚¹ï¼š\n${locationData.formattedAddress}`;
                    if (locationData.poiName) {
                        successMessage += `\né™„è¿‘ï¼š${locationData.poiName}`;
                    }
                }
                alert(successMessage);
                // æ¸…ç©ºè¡¨å•
                document.getElementById('stuClass').value = '';
                document.getElementById('stuId').value = '';
                document.getElementById('stuName').value = '';
                document.getElementById('location').value = '';
                // é‡ç½®å®šä½æŒ‰é’®
                const locationBtn = document.getElementById('locationBtn');
                locationBtn.disabled = false;
                locationBtn.textContent = 'ğŸ“è·å–å½“å‰ä½ç½®';
                locationBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                locationBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
                // æ¸…ç©ºå…¨å±€å®šä½æ•°æ®
                window.locationData = null;
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
            } catch (error) {
                console.error('âŒç­¾åˆ°å¤±è´¥:', error);
                alert('âŒç­¾åˆ°å¤±è´¥ï¼š' + error.message + '\n\nè¯·ç¨åé‡è¯•æˆ–è”ç³»æ•™å¸ˆ');
            }
        }

        // ==================== é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº====================
        window.addEventListener('beforeunload', function () {
            console.log('ğŸ§¹æ¸…ç†é¡µé¢èµ„æº...');
            // åœæ­¢ç›¸æœº
            if (videoStream) {
                stopCamera();
            }
            // ğŸ”¥ æ¸…ç†æ‰€æœ‰å€’è®¡æ—¶å®šæ—¶å™¨
            countdownTimers.forEach(timer => clearInterval(timer));
            countdownTimers = [];
            console.log('âœ…å·²æ¸…ç†æ‰€æœ‰å€’è®¡æ—¶å®šæ—¶å™¨');
        });
    </script>
</body>

</html>