<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœ¬ç§‘æ¯•ä¸šè®¾è®¡æˆç»©å½•å…¥ç³»ç»Ÿ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- LeanCloud SDK -->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>

<style>
.fade-in { animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* åŠ è½½åŠ¨ç”»æ ·å¼ */
.loading { 
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body class="bg-gray-100 min-h-screen">
<!-- ç™»å½•é¡µé¢ -->
<div id="loginPage" class="min-h-screen flex items-center justify-center">
<div class="bg-white p-8 rounded-lg shadow-md w-96">
<h1 class="text-2xl font-bold text-center mb-6 text-blue-600">æ™ºç§‘â€”æ¯•ä¸šè®¾è®¡æˆç»©å½•å…¥ç³»ç»Ÿ</h1>

<form id="loginForm">
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">ç­”è¾©ç»„</label>
<select id="groupSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
<option value="">è¯·é€‰æ‹©ç­”è¾©ç»„</option>
<option value="group1">ç¬¬ä¸€ç­”è¾©ç»„</option>
<option value="group2">ç¬¬äºŒç­”è¾©ç»„</option>
<option value="group3">ç¬¬ä¸‰ç­”è¾©ç»„</option>
<option value="admin">ç®¡ç†å‘˜</option>
</select>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
<input type="text" id="username" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
<input type="password" id="password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="è¯·è¾“å…¥å¯†ç ">
</div>
<button type="submit" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition duration-200 flex items-center justify-center">
<span id="loginBtnText">ç™»å½•</span>
<div id="loginLoading" class="loading ml-2 hidden"></div>
</button>
</form>
<div class="mt-4 text-sm text-gray-600 bg-gray-50 p-3 rounded">
<p class="font-semibold mb-2">æµ‹è¯•è´¦å·ï¼š</p>
<div class="space-y-1">
<p><strong>ç®¡ç†å‘˜ï¼š</strong> ç”¨æˆ·å: admin, å¯†ç : ******</p>
<p><strong>ç­”è¾©ç§˜ä¹¦ï¼š</strong> ç”¨æˆ·å: expert1, å¯†ç : 123456</p>
<p><strong>ä¸“å®¶ï¼š</strong> ç”¨æˆ·å: expert2~expert5, å¯†ç : 123456</p>
</div>
<button id="initDataBtn" class="mt-3 text-xs bg-green-100 text-green-600 px-2 py-1 rounded hover:bg-green-200" hidden>åˆå§‹åŒ–äº‘ç«¯æ•°æ®</button>
</div>
</div>
</div>

<!-- ä¸»ç³»ç»Ÿé¡µé¢ -->
<div id="mainPage" class="hidden">
<!-- å¯¼èˆªæ  -->
<nav class="bg-blue-600 text-white p-4">
<div class="container mx-auto flex justify-between items-center">
<h1 class="text-xl font-bold">æ¯•ä¸šè®¾è®¡æˆç»©å½•å…¥ç³»ç»Ÿ</h1>
<div class="flex items-center space-x-4">
<span id="userInfo"></span>
<span id="permissionInfo" class="text-sm bg-blue-700 px-2 py-1 rounded"></span>
<button id="logoutBtn" class="bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">é€€å‡º</button>
</div>
</div>
</nav>

<!-- ä¸»å†…å®¹ -->
<div class="container mx-auto p-4">
<!-- ç®¡ç†å‘˜ç­”è¾©ç»„é€‰æ‹© -->
<div id="adminGroupSelector" class="bg-white p-4 rounded-lg shadow-md mb-6 hidden">
<div class="flex items-center space-x-4">
<label class="text-sm font-medium text-gray-700">é€‰æ‹©ç­”è¾©ç»„ï¼š</label>
<select id="adminGroupSelect" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
<option value="group1">ç¬¬ä¸€ç­”è¾©ç»„</option>
<option value="group2">ç¬¬äºŒç­”è¾©ç»„</option>
<option value="group3">ç¬¬ä¸‰ç­”è¾©ç»„</option>
</select>
<button id="switchGroupBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">åˆ‡æ¢</button>
</div>
</div>

<!-- æ“ä½œæŒ‰é’®åŒº -->
<div class="bg-white p-4 rounded-lg shadow-md mb-6">
<div class="flex flex-wrap gap-4">
<input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
<button id="importBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition duration-200">
ğŸ“ å¯¼å…¥ Excel æ–‡ä»¶
</button>
<button id="exportBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition duration-200">
ğŸ“Š å¯¼å‡ºæˆç»©è¡¨
</button>
<button id="refreshBtn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition duration-200 flex items-center">
<span>ğŸ”„ åˆ·æ–°æ•°æ®</span>
<div id="refreshLoading" class="loading ml-2 hidden"></div>
</button>
</div>
</div>

<!-- æˆç»©è¡¨æ ¼ -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
<div class="overflow-x-auto">
<table class="w-full table-auto">
<thead class="bg-gray-50">
<tr>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¦å·</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è®ºæ–‡é¢˜ç›®</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¼€é¢˜æˆç»©</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æŒ‡å¯¼æ•™å¸ˆæˆç»©</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¯„é˜…æ•™å¸ˆæˆç»©</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸“å®¶ 1</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸“å®¶ 2</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸“å®¶ 3</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸“å®¶ 4</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸“å®¶ 5</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç­”è¾©æˆç»©</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¯•ä¸šè®¾è®¡æˆç»©</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æˆç»©ç­‰çº§</th>
</tr>
</thead>
<tbody id="gradeTableBody" class="bg-white divide-y divide-gray-200">
<!-- åŠ¨æ€ç”Ÿæˆ -->
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- æˆç»©å½•å…¥æ¨¡æ€æ¡† -->
<div id="gradeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
<div class="bg-white p-6 rounded-lg shadow-xl w-96">
<h3 id="modalTitle" class="text-lg font-medium text-gray-900 mb-4">å½•å…¥æˆç»©</h3>
<div id="modalContent">
<!-- åŠ¨æ€ç”Ÿæˆ -->
</div>
<div class="mt-6 flex justify-end space-x-3">
<button id="cancelModal" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 border border-gray-300 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
<button id="saveGrade" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 flex items-center">
<span id="saveBtnText">ä¿å­˜</span>
<div id="saveLoading" class="loading ml-2 hidden"></div>
</button>
</div>
</div>
</div>

<script>
// ==================== LeanCloud é…ç½® ====================
// è¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ LeanCloud åº”ç”¨é…ç½®
const LEANCLOUD_CONFIG = {
appId: 'Gi7s7RAi1epWNVtj0X9EAqxe-gzGzoHsz', // æ›¿æ¢ä¸ºæ‚¨çš„åº”ç”¨ ID
appKey: 'wMXylXbeOH82GkuprhkdAon4', // æ›¿æ¢ä¸ºæ‚¨çš„åº”ç”¨ Key
serverURL: 'https://avoscloud.com' // æ›¿æ¢ä¸ºæ‚¨çš„æœåŠ¡å™¨åœ°å€
};

// åˆå§‹åŒ– LeanCloud
AV.init(LEANCLOUD_CONFIG);

// ==================== å…¨å±€å˜é‡ ====================
let currentUser = null;
let currentGroup = null;
let studentsData = [];
let usersData = {};
let isGroupLeader = false;
let isAdmin = false;
let currentEditType = 'expert'; // 'expert' | 'proposal' | 'supervisor' | 'reviewer'
let currentEditIndex = -1;
let currentStudentIndex = -1;

// ==================== LeanCloud æ•°æ®æ“ä½œå‡½æ•° ====================

// ä¿å­˜æ•°æ®åˆ°äº‘ç«¯
async function saveToCloud(key, data) {
    const ConfigObject = AV.Object.extend('GradeConfig');
    const query = new AV.Query('GradeConfig');
    query.equalTo('key', key);
    
    try {
        const existing = await query.first();
        if (existing) {
            existing.set('data', data);
            await existing.save();
        } else {
            const configObject = new ConfigObject();
            configObject.set('key', key);
            configObject.set('data', data);
            await configObject.save();
        }
    } catch (error) {
        console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
        throw error;
    }
}

// ä»äº‘ç«¯è·å–æ•°æ®
async function getFromCloud(key) {
    const query = new AV.Query('GradeConfig');
    query.equalTo('key', key);
    
    try {
        const result = await query.first();
        return result ? result.get('data') : null;
    } catch (error) {
        console.error('è·å–æ•°æ®å¤±è´¥:', error);
        throw error;
    }
}

// åˆå§‹åŒ–äº‘ç«¯æ•°æ®
async function initCloudData() {
    try {
        showLoading('initDataBtn');
        
        // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
        const users = {
            admin: {
                admin: { password: 'admin123', name: 'ç³»ç»Ÿç®¡ç†å‘˜', isAdmin: true }
            },
            group1: {
                expert1: { password: '123456', name: 'ä¸“å®¶ 1ï¼ˆç­”è¾©ç§˜ä¹¦ï¼‰', isLeader: true },
                expert2: { password: '123456', name: 'ä¸“å®¶ 2', isLeader: false },
                expert3: { password: '123456', name: 'ä¸“å®¶ 3', isLeader: false },
                expert4: { password: '123456', name: 'ä¸“å®¶ 4', isLeader: false },
                expert5: { password: '123456', name: 'ä¸“å®¶ 5', isLeader: false }
            },
            group2: {
                expert1: { password: '123456', name: 'ä¸“å®¶ 1ï¼ˆç­”è¾©ç§˜ä¹¦ï¼‰', isLeader: true },
                expert2: { password: '123456', name: 'ä¸“å®¶ 2', isLeader: false },
                expert3: { password: '123456', name: 'ä¸“å®¶ 3', isLeader: false },
                expert4: { password: '123456', name: 'ä¸“å®¶ 4', isLeader: false },
                expert5: { password: '123456', name: 'ä¸“å®¶ 5', isLeader: false }
            },
            group3: {
                expert1: { password: '123456', name: 'ä¸“å®¶ 1ï¼ˆç­”è¾©ç§˜ä¹¦ï¼‰', isLeader: true },
                expert2: { password: '123456', name: 'ä¸“å®¶ 2', isLeader: false },
                expert3: { password: '123456', name: 'ä¸“å®¶ 3', isLeader: false },
                expert4: { password: '123456', name: 'ä¸“å®¶ 4', isLeader: false },
                expert5: { password: '123456', name: 'ä¸“å®¶ 5', isLeader: false }
            }
        };

        // ä¿å­˜ç”¨æˆ·æ•°æ®åˆ°äº‘ç«¯
        await saveToCloud('users', users);

        // åˆå§‹åŒ–å„ç»„å­¦ç”Ÿæ•°æ®ï¼ˆç©ºæ•°æ®ï¼Œç”¨å¯¹è±¡åŒ…è£¹æ•°ç»„ï¼‰
        for (let group of ['group1', 'group2', 'group3']) {
            await saveToCloud(`students_${group}`, {list: []});
        }

        alert('äº‘ç«¯æ•°æ®åˆå§‹åŒ–æˆåŠŸï¼');
    } catch (error) {
        console.error('åˆå§‹åŒ–æ•°æ®å¤±è´¥:', error);
        alert('åˆå§‹åŒ–æ•°æ®å¤±è´¥ï¼š' + error.message);
    } finally {
        hideLoading('initDataBtn');
    }
}

// ==================== åŠ è½½çŠ¶æ€å‡½æ•° ====================

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading(elementId) {
    const element = document.getElementById(elementId);
    if (elementId === 'loginBtn') {
        document.getElementById('loginBtnText').textContent = 'ç™»å½•ä¸­...';
        document.getElementById('loginLoading').classList.remove('hidden');
    } else if (elementId === 'refreshBtn') {
        document.getElementById('refreshLoading').classList.remove('hidden');
    } else if (elementId === 'saveGrade') {
        document.getElementById('saveBtnText').textContent = 'ä¿å­˜ä¸­...';
        document.getElementById('saveLoading').classList.remove('hidden');
    } else if (elementId === 'initDataBtn') {
        element.textContent = 'åˆå§‹åŒ–ä¸­...';
        element.disabled = true;
    }
}

// éšè—åŠ è½½çŠ¶æ€
function hideLoading(elementId) {
    const element = document.getElementById(elementId);
    if (elementId === 'loginBtn') {
        document.getElementById('loginBtnText').textContent = 'ç™»å½•';
        document.getElementById('loginLoading').classList.add('hidden');
    } else if (elementId === 'refreshBtn') {
        document.getElementById('refreshLoading').classList.add('hidden');
    } else if (elementId === 'saveGrade') {
        document.getElementById('saveBtnText').textContent = 'ä¿å­˜';
        document.getElementById('saveLoading').classList.add('hidden');
    } else if (elementId === 'initDataBtn') {
        element.textContent = 'åˆå§‹åŒ–äº‘ç«¯æ•°æ®';
        element.disabled = false;
    }
}

// ==================== ç³»ç»Ÿåˆå§‹åŒ– ====================

// åˆå§‹åŒ–ç³»ç»Ÿ
function initSystem() {
    // ç»‘å®šäº‹ä»¶
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    document.getElementById('importBtn').addEventListener('click', () => document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', handleFileImport);
    document.getElementById('exportBtn').addEventListener('click', exportToExcel);
    document.getElementById('refreshBtn').addEventListener('click', loadGradeData);
    document.getElementById('cancelModal').addEventListener('click', closeModal);
    document.getElementById('saveGrade').addEventListener('click', saveGrade);
    document.getElementById('switchGroupBtn').addEventListener('click', switchGroup);
    document.getElementById('initDataBtn').addEventListener('click', initCloudData);
}

// ==================== ç™»å½•å’Œæƒé™ç®¡ç† ====================

// ç™»å½•å¤„ç†
async function handleLogin(e) {
    e.preventDefault();
    
    const group = document.getElementById('groupSelect').value;
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (!group || !username || !password) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }
    
    try {
        showLoading('loginBtn');
        
        // ä»äº‘ç«¯è·å–ç”¨æˆ·æ•°æ®
        usersData = await getFromCloud('users');
        
        if (!usersData) {
            alert('ç³»ç»Ÿæ•°æ®æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆç‚¹å‡»"åˆå§‹åŒ–äº‘ç«¯æ•°æ®"æŒ‰é’®');
            return;
        }
        
        if (usersData[group] && usersData[group][username] && usersData[group][username].password === password) {
            currentUser = username;
            currentGroup = group;
            isGroupLeader = usersData[group][username].isLeader || false;
            isAdmin = usersData[group][username].isAdmin || false;
            
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            
            // è®¾ç½®ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            let groupName = '';
            if (isAdmin) {
                groupName = 'ç³»ç»Ÿç®¡ç†å‘˜';
                document.getElementById('adminGroupSelector').classList.remove('hidden');
                currentGroup = 'group1'; // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ç­”è¾©ç»„
            } else {
                groupName = group === 'group1' ? 'ç¬¬ä¸€ç­”è¾©ç»„' : group === 'group2' ? 'ç¬¬äºŒç­”è¾©ç»„' : 'ç¬¬ä¸‰ç­”è¾©ç»„';
            }
            
            document.getElementById('userInfo').textContent = `${usersData[group][username].name} (${groupName})`;
            
            // è®¾ç½®æƒé™ä¿¡æ¯æ˜¾ç¤º
            let permissionText = '';
            if (isAdmin) {
                permissionText = 'ç®¡ç†å‘˜æƒé™';
            } else if (isGroupLeader) {
                permissionText = 'ç­”è¾©ç§˜ä¹¦æƒé™';
            } else {
                permissionText = 'ä¸“å®¶æƒé™';
            }
            document.getElementById('permissionInfo').textContent = permissionText;
            
            await loadGradeData();
        } else {
            alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼');
        }
    } catch (error) {
        console.error('ç™»å½•å¤±è´¥:', error);
        alert('ç™»å½•å¤±è´¥ï¼š' + error.message);
    } finally {
        hideLoading('loginBtn');
    }
}

// åˆ‡æ¢ç­”è¾©ç»„ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
async function switchGroup() {
    if (!isAdmin) return;
    const selectedGroup = document.getElementById('adminGroupSelect').value;
    currentGroup = selectedGroup;
    await loadGradeData();
}

// é€€å‡ºç™»å½•
function handleLogout() {
    currentUser = null;
    currentGroup = null;
    isGroupLeader = false;
    isAdmin = false;
    studentsData = [];
    usersData = {};
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('mainPage').classList.add('hidden');
    document.getElementById('adminGroupSelector').classList.add('hidden');
    document.getElementById('loginForm').reset();
}

// ==================== æ•°æ®åŠ è½½å’Œä¿å­˜ ====================

// åŠ è½½æˆç»©æ•°æ®
async function loadGradeData() {
    try {
        showLoading('refreshBtn');
        const key = `students_${currentGroup}`;
        const obj = await getFromCloud(key);
        // é‡è¦ï¼šç¡®ä¿è§£åŒ…æ•°ç»„ï¼Œé˜²æ­¢ forEach é”™è¯¯
        studentsData = (obj && Array.isArray(obj.list)) ? obj.list : [];
        renderGradeTable();
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        alert('åŠ è½½æ•°æ®å¤±è´¥ï¼š' + error.message);
    } finally {
        hideLoading('refreshBtn');
    }
}

// ä¿å­˜å­¦ç”Ÿæ•°æ®åˆ°äº‘ç«¯
async function saveStudentsData() {
    try {
        const key = `students_${currentGroup}`;
        await saveToCloud(key, {list: studentsData}); // ç”¨å¯¹è±¡åŒ…è£¹æ•°ç»„
    } catch (error) {
        console.error('ä¿å­˜å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);
        throw error;
    }
}

// ==================== æˆç»©è®¡ç®—å’Œæ¸²æŸ“ ====================

// è®¡ç®—æˆç»©ç­‰çº§
function getGradeLevel(score) {
    const numScore = parseFloat(score);
    if (numScore >= 90) return 'ä¼˜';
    if (numScore >= 80) return 'è‰¯';
    if (numScore >= 70) return 'ä¸­';
    if (numScore >= 60) return 'åŠæ ¼';
    return 'ä¸åŠæ ¼';
}

// è·å–ç­‰çº§å¯¹åº”çš„æ ·å¼ç±»
function getGradeLevelClass(level) {
    switch(level) {
        case 'ä¼˜': return 'text-red-600 font-bold';
        case 'è‰¯': return 'text-green-600 font-semibold';
        case 'ä¸­': return 'text-blue-600';
        case 'åŠæ ¼': return 'text-yellow-600';
        case 'ä¸åŠæ ¼': return 'text-gray-500';
        default: return 'text-gray-500';
    }
}

// æ¸²æŸ“æˆç»©è¡¨æ ¼
function renderGradeTable() {
    const tbody = document.getElementById('gradeTableBody');
    tbody.innerHTML = '';
    
    studentsData.forEach((student, index) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        // è®¡ç®—ç­”è¾©æˆç»©å’Œæ€»æˆç»©
        const expertGrades = student.expertGrades || [0, 0, 0, 0, 0];
        const validGrades = expertGrades.filter(g => g > 0);
        const defenseGrade = validGrades.length > 0 ? (validGrades.reduce((a, b) => a + b, 0) / validGrades.length).toFixed(1) : 0;
        const totalGrade = (
            student.proposalGrade * 0.1 +
            student.supervisorGrade * 0.3 +
            student.reviewerGrade * 0.2 +
            parseFloat(defenseGrade) * 0.4
        ).toFixed(1);
        
        // è®¡ç®—æˆç»©ç­‰çº§
        const gradeLevel = getGradeLevel(totalGrade);
        const levelClass = getGradeLevelClass(gradeLevel);
        
        // åˆ¤æ–­æ˜¯å¦å¯ä»¥ç¼–è¾‘åŸºç¡€æˆç»©ï¼ˆç»„é•¿æˆ–ç®¡ç†å‘˜æƒé™ï¼‰
        const canEditBasicGrades = isGroupLeader || isAdmin;
        
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${student.studentId}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${student.name}</td>
            <td class="px-4 py-3 text-sm text-gray-900 max-w-xs truncate" title="${student.title}">${student.title}</td>
            <td class="px-4 py-3 text-sm">
                ${canEditBasicGrades ?
                    `<button onclick="openBasicGradeModal(${index}, 'proposal')" 
                    class="w-16 px-2 py-1 text-center border rounded bg-yellow-100 border-yellow-300 hover:bg-yellow-200">
                        ${student.proposalGrade}
                    </button>` :
                    `<span class="text-gray-900">${student.proposalGrade}</span>`
                }
            </td>
            <td class="px-4 py-3 text-sm">
                ${canEditBasicGrades ?
                    `<button onclick="openBasicGradeModal(${index}, 'supervisor')" 
                    class="w-16 px-2 py-1 text-center border rounded bg-yellow-100 border-yellow-300 hover:bg-yellow-200">
                        ${student.supervisorGrade}
                    </button>` :
                    `<span class="text-gray-900">${student.supervisorGrade}</span>`
                }
            </td>
            <td class="px-4 py-3 text-sm">
                ${canEditBasicGrades ?
                    `<button onclick="openBasicGradeModal(${index}, 'reviewer')" 
                    class="w-16 px-2 py-1 text-center border rounded bg-yellow-100 border-yellow-300 hover:bg-yellow-200">
                        ${student.reviewerGrade}
                    </button>` :
                    `<span class="text-gray-900">${student.reviewerGrade}</span>`
                }
            </td>
            ${expertGrades.map((grade, i) => `
                <td class="px-4 py-3 text-sm">
                    <button onclick="openExpertGradeModal(${index}, ${i})" 
                    class="w-16 px-2 py-1 text-center border rounded ${grade > 0 ? 'bg-green-100 border-green-300' : 'bg-gray-100 border-gray-300'} hover:bg-blue-100">
                        ${grade || '-'}
                    </button>
                </td>
            `).join('')}
            <td class="px-4 py-3 text-sm font-medium text-blue-600">${defenseGrade}</td>
            <td class="px-4 py-3 text-sm font-bold text-green-600">${totalGrade}</td>
            <td class="px-4 py-3 text-sm ${levelClass}">${gradeLevel}</td>
        `;
        
        tbody.appendChild(row);
    });
}

// ==================== æˆç»©å½•å…¥æ¨¡æ€æ¡† ====================

// æ‰“å¼€åŸºç¡€æˆç»©å½•å…¥æ¨¡æ€æ¡†ï¼ˆå¼€é¢˜ã€æŒ‡å¯¼æ•™å¸ˆã€è¯„é˜…æ•™å¸ˆæˆç»©ï¼‰
function openBasicGradeModal(studentIndex, gradeType) {
    const student = studentsData[studentIndex];
    currentEditType = gradeType;
    currentStudentIndex = studentIndex;
    
    const gradeTypeNames = {
        'proposal': 'å¼€é¢˜æˆç»©',
        'supervisor': 'æŒ‡å¯¼æ•™å¸ˆæˆç»©',
        'reviewer': 'è¯„é˜…æ•™å¸ˆæˆç»©'
    };
    
    const currentGrade = gradeType === 'proposal' ? student.proposalGrade :
                        gradeType === 'supervisor' ? student.supervisorGrade :
                        student.reviewerGrade;
    
    const modal = document.getElementById('gradeModal');
    const title = document.getElementById('modalTitle');
    const content = document.getElementById('modalContent');
    
    title.textContent = `ä¿®æ”¹${gradeTypeNames[gradeType]}`;
    content.innerHTML = `
        <div class="mb-4">
            <p class="text-sm text-gray-600">å­¦å·ï¼š${student.studentId}</p>
            <p class="text-sm text-gray-600">å§“åï¼š${student.name}</p>
            <p class="text-sm text-gray-600">æˆç»©ç±»å‹ï¼š${gradeTypeNames[gradeType]}</p>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">${gradeTypeNames[gradeType]}ï¼ˆ0-100 åˆ†ï¼‰</label>
            <input type="number" id="gradeInput" min="0" max="100" 
            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" 
            value="${currentGrade}" placeholder="è¯·è¾“å…¥æˆç»©">
        </div>
    `;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('gradeInput').focus();
}

// æ‰“å¼€ä¸“å®¶ç­”è¾©æˆç»©å½•å…¥æ¨¡æ€æ¡†
function openExpertGradeModal(studentIndex, expertIndex) {
    const student = studentsData[studentIndex];
    const expertNumber = expertIndex + 1;
    const currentExpertIndex = parseInt(currentUser.replace('expert', '')) - 1;
    
    // æ£€æŸ¥æƒé™ï¼šåªèƒ½å½•å…¥è‡ªå·±çš„æˆç»©ï¼Œæˆ–è€…ç»„é•¿/ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹æ‰€æœ‰æˆç»©
    if (!isGroupLeader && !isAdmin && expertIndex !== currentExpertIndex) {
        alert('æ‚¨åªèƒ½å½•å…¥è‡ªå·±çš„ç­”è¾©æˆç»©');
        return;
    }
    
    currentEditType = 'expert';
    currentStudentIndex = studentIndex;
    currentEditIndex = expertIndex;
    
    const modal = document.getElementById('gradeModal');
    const title = document.getElementById('modalTitle');
    const content = document.getElementById('modalContent');
    
    title.textContent = 'å½•å…¥ç­”è¾©æˆç»©';
    content.innerHTML = `
        <div class="mb-4">
            <p class="text-sm text-gray-600">å­¦å·ï¼š${student.studentId}</p>
            <p class="text-sm text-gray-600">å§“åï¼š${student.name}</p>
            <p class="text-sm text-gray-600">ä¸“å®¶ï¼šä¸“å®¶${expertNumber}</p>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">ç­”è¾©æˆç»©ï¼ˆ0-100 åˆ†ï¼‰</label>
            <input type="number" id="gradeInput" min="0" max="100" 
            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" 
            value="${student.expertGrades[expertIndex] || ''}" placeholder="è¯·è¾“å…¥æˆç»©">
        </div>
    `;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('gradeInput').focus();
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal() {
    const modal = document.getElementById('gradeModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// ä¿å­˜æˆç»©
async function saveGrade() {
    const grade = parseFloat(document.getElementById('gradeInput').value);
    
    if (isNaN(grade) || grade < 0 || grade > 100) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æˆç»©ï¼ˆ0-100 åˆ†ï¼‰');
        return;
    }
    
    try {
        showLoading('saveGrade');
        
        if (currentEditType === 'expert') {
            studentsData[currentStudentIndex].expertGrades[currentEditIndex] = grade;
        } else if (currentEditType === 'proposal') {
            studentsData[currentStudentIndex].proposalGrade = grade;
        } else if (currentEditType === 'supervisor') {
            studentsData[currentStudentIndex].supervisorGrade = grade;
        } else if (currentEditType === 'reviewer') {
            studentsData[currentStudentIndex].reviewerGrade = grade;
        }
        
        // ä¿å­˜åˆ°äº‘ç«¯
        await saveStudentsData();
        
        renderGradeTable();
        closeModal();
        alert('æˆç»©ä¿å­˜æˆåŠŸï¼');
    } catch (error) {
        console.error('ä¿å­˜æˆç»©å¤±è´¥:', error);
        alert('ä¿å­˜æˆç»©å¤±è´¥ï¼š' + error.message);
    } finally {
        hideLoading('saveGrade');
    }
}

// ==================== æ–‡ä»¶å¯¼å…¥å¯¼å‡º ====================

// å¤„ç†æ–‡ä»¶å¯¼å…¥
async function handleFileImport(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            // è½¬æ¢æ•°æ®æ ¼å¼
            const importedData = jsonData.map(row => ({
                studentId: row['å­¦å·'] || row['StudentId'] || '',
                name: row['å§“å'] || row['Name'] || '',
                title: row['è®ºæ–‡é¢˜ç›®'] || row['Title'] || '',
                proposalGrade: parseFloat(row['å¼€é¢˜æˆç»©'] || row['ProposalGrade'] || 0),
                supervisorGrade: parseFloat(row['æŒ‡å¯¼æ•™å¸ˆæˆç»©'] || row['SupervisorGrade'] || 0),
                reviewerGrade: parseFloat(row['è¯„é˜…æ•™å¸ˆæˆç»©'] || row['ReviewerGrade'] || 0),
                expertGrades: [0, 0, 0, 0, 0]
            }));
            
            if (importedData.length > 0) {
                studentsData = importedData;
                await saveStudentsData();
                renderGradeTable();
                alert(`æˆåŠŸå¯¼å…¥ ${importedData.length} æ¡å­¦ç”Ÿè®°å½•ï¼`);
            } else {
                alert('æœªèƒ½è¯»å–åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥ Excel æ–‡ä»¶æ ¼å¼');
            }
        } catch (err) {
            alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶æ ¼å¼æ­£ç¡®');
            console.error(err);
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// å¯¼å‡ºåˆ° Excel
function exportToExcel() {
    if (studentsData.length === 0) {
        alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
        return;
    }
    
    const exportData = studentsData.map(student => {
        const expertGrades = student.expertGrades || [0, 0, 0, 0, 0];
        const validGrades = expertGrades.filter(g => g > 0);
        const defenseGrade = validGrades.length > 0 ? (validGrades.reduce((a, b) => a + b, 0) / validGrades.length).toFixed(1) : 0;
        const totalGrade = (
            student.proposalGrade * 0.1 +
            student.supervisorGrade * 0.3 +
            student.reviewerGrade * 0.2 +
            parseFloat(defenseGrade) * 0.4
        ).toFixed(1);
        const gradeLevel = getGradeLevel(totalGrade);
        
        return {
            'å­¦å·': student.studentId,
            'å§“å': student.name,
            'è®ºæ–‡é¢˜ç›®': student.title,
            'å¼€é¢˜æˆç»©': student.proposalGrade,
            'æŒ‡å¯¼æ•™å¸ˆæˆç»©': student.supervisorGrade,
            'è¯„é˜…æ•™å¸ˆæˆç»©': student.reviewerGrade,
            'ç­”è¾©ä¸“å®¶ 1 æˆç»©': expertGrades[0] || '',
            'ç­”è¾©ä¸“å®¶ 2 æˆç»©': expertGrades[1] || '',
            'ç­”è¾©ä¸“å®¶ 3 æˆç»©': expertGrades[2] || '',
            'ç­”è¾©ä¸“å®¶ 4 æˆç»©': expertGrades[3] || '',
            'ç­”è¾©ä¸“å®¶ 5 æˆç»©': expertGrades[4] || '',
            'ç­”è¾©æˆç»©': defenseGrade,
            'æ¯•ä¸šè®¾è®¡æˆç»©': totalGrade,
            'æˆç»©ç­‰çº§': gradeLevel
        };
    });
    
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'æˆç»©è¡¨');
    
    const groupName = currentGroup === 'group1' ? 'ç¬¬ä¸€ç­”è¾©ç»„' : currentGroup === 'group2' ? 'ç¬¬äºŒç­”è¾©ç»„' : 'ç¬¬ä¸‰ç­”è¾©ç»„';
    const fileName = `${groupName}_æ¯•ä¸šè®¾è®¡æˆç»©_${new Date().toISOString().split('T')[0]}.xlsx`;
    
    XLSX.writeFile(wb, fileName);
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initSystem);
</script>
</body>
</html>