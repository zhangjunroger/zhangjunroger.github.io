
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è€ƒè¯•åº§ä½å®‰æ’ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
</head>
<body class="bg-gradient-to-r from-blue-50 to-blue-100 min-h-screen p-8">
<div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold text-blue-700 mb-8 text-center">è€ƒè¯•åº§ä½å®‰æ’ç³»ç»Ÿ</h1>

    <!-- æ•°æ®ç®¡ç†æŒ‰é’® -->
    <div class="mb-6 text-center">
        <button onclick="openDataManager()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">
            ğŸ“Š æ•°æ®ç®¡ç†
        </button>
        <span id="cloudStatus" class="ml-4 text-sm text-gray-600">äº‘ç«¯è¿æ¥æ£€æµ‹ä¸­...</span>
    </div>

    <!-- æ•°æ®ç®¡ç†å¼¹çª— -->
    <div id="dataManagerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">æ•°æ®ç®¡ç†</h2>
                        <button onclick="closeDataManager()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>

                    <!-- ç®¡ç†æ ‡ç­¾é¡µ -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-8">
                            <button onclick="switchTab('courses')" id="tab-courses" class="tab-button active">è¯¾ç¨‹ç®¡ç†</button>
                            <button onclick="switchTab('classes')" id="tab-classes" class="tab-button">ç­çº§ç®¡ç†</button>
                            <button onclick="switchTab('rooms')" id="tab-rooms" class="tab-button">è€ƒåœºç®¡ç†</button>
                        </nav>
                    </div>

                    <!-- è¯¾ç¨‹ç®¡ç† -->
                    <div id="courses-panel" class="tab-panel">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">è¯¾ç¨‹åˆ—è¡¨</h3>
                            <button onclick="showAddCourseForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                + æ·»åŠ è¯¾ç¨‹
                            </button>
                        </div>

                        <!-- æ·»åŠ è¯¾ç¨‹è¡¨å• -->
                        <div id="addCourseForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-medium mb-3">æ·»åŠ æ–°è¯¾ç¨‹</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯¾ç¨‹ID</label>
                                    <input id="courseId" type="text" class="w-full p-2 border rounded-lg" placeholder="å¦‚: math-101">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯¾ç¨‹åç§°</label>
                                    <input id="courseName" type="text" class="w-full p-2 border rounded-lg" placeholder="å¦‚: é«˜ç­‰æ•°å­¦">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒè¯•æ—¶é—´</label>
                                    <input id="courseTime" type="text" class="w-full p-2 border rounded-lg" placeholder="å¦‚: 2025-01-20 14:00-15:35">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒè¯•æ—¶é•¿</label>
                                    <input id="courseDuration" type="text" class="w-full p-2 border rounded-lg" placeholder="å¦‚: 95åˆ†é’Ÿ">
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button onclick="saveCourse()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ä¿å­˜</button>
                                <button onclick="cancelAddCourse()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">å–æ¶ˆ</button>
                            </div>
                        </div>

                        <!-- è¯¾ç¨‹åˆ—è¡¨ -->
                        <div id="coursesList" class="space-y-2"></div>
                    </div>

                    <!-- ç­çº§ç®¡ç† -->
                    <div id="classes-panel" class="tab-panel hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">ç­çº§åˆ—è¡¨</h3>
                            <button onclick="showAddClassForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                + æ·»åŠ ç­çº§
                            </button>
                        </div>

                        <!-- æ·»åŠ ç­çº§è¡¨å• -->
                        <div id="addClassForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-medium mb-3">æ·»åŠ æ–°ç­çº§</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç­çº§ID</label>
                                    <input id="classId" type="text" class="w-full p-2 border rounded-lg" placeholder="å¦‚: ai2023130101">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç­çº§åç§°</label>
                                    <input id="className" type="text" class="w-full p-2 border rounded-lg" placeholder="å¦‚: æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2023çº§01ç­">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">å­¦ç”Ÿä¿¡æ¯</label>
                                <textarea id="classStudents" rows="8" class="w-full p-2 border rounded-lg" 
                                    placeholder="æ¯è¡Œä¸€ä¸ªå­¦ç”Ÿï¼Œæ ¼å¼ï¼šå­¦å· å§“å&#10;å¦‚ï¼š&#10;202301001 å¼ ä¸‰&#10;202301002 æå››"></textarea>
                                <p class="text-sm text-gray-600 mt-1">æ ¼å¼ï¼šå­¦å· å§“åï¼ˆæ¯è¡Œä¸€ä¸ªå­¦ç”Ÿï¼‰</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveClass()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ä¿å­˜</button>
                                <button onclick="cancelAddClass()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">å–æ¶ˆ</button>
                            </div>
                        </div>

                        <!-- ç­çº§åˆ—è¡¨ -->
                        <div id="classesList" class="space-y-2"></div>
                    </div>

                    <!-- è€ƒåœºç®¡ç† -->
                    <div id="rooms-panel" class="tab-panel hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">è€ƒåœºåˆ—è¡¨</h3>
                            <button onclick="showAddRoomForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                + æ·»åŠ è€ƒåœº
                            </button>
                        </div>

                        <!-- æ·»åŠ è€ƒåœºè¡¨å• -->
                        <div id="addRoomForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-medium mb-3">æ·»åŠ æ–°è€ƒåœº</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒåœºID</label>
                                    <input id="roomId" type="text" class="w-full p-2 border rounded-lg" placeholder="å¦‚: A101">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒåœºåç§°</label>
                                    <input id="roomName" type="text" class="w-full p-2 border rounded-lg" placeholder="å¦‚: æ•™å­¦æ¥¼A101">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è¡Œæ•°</label>
                                    <input id="roomRows" type="number" min="1" class="w-full p-2 border rounded-lg" placeholder="å¦‚: 8">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">åˆ—æ•°</label>
                                    <input id="roomCols" type="number" min="1" class="w-full p-2 border rounded-lg" placeholder="å¦‚: 5">
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button onclick="saveRoom()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ä¿å­˜</button>
                                <button onclick="cancelAddRoom()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">å–æ¶ˆ</button>
                            </div>
                        </div>

                        <!-- è€ƒåœºåˆ—è¡¨ -->
                        <div id="roomsList" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å®æ—¶è€ƒè¯•ä¿¡æ¯é¢æ¿ -->
    <div id="examTimePanel" class="hidden bg-white rounded-lg shadow-lg p-6 mb-8 border-l-4 border-blue-500">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">å½“å‰æ—¶é—´</h3>
                <div id="currentTime" class="text-2xl font-mono text-blue-600"></div>
            </div>
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">è€ƒè¯•å€’è®¡æ—¶</h3>
                <div id="countdown" class="text-2xl font-mono text-red-600"></div>
                <div id="examStatus" class="text-sm text-gray-600 mt-1"></div>
            </div>
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">è¯­éŸ³è®¾ç½®</h3>
                <div class="space-y-2">
                    <button id="voiceToggle" onclick="toggleVoice()" class="w-full px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">
                        ğŸ”Š è¯­éŸ³å¼€å¯
                    </button>
                    <select id="voiceSelect" class="w-full p-1 border rounded text-sm" onchange="changeVoice()">
                        <option value="">é€‰æ‹©è¯­éŸ³...</option>
                    </select>
                </div>
            </div>
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">è¯­éŸ³æµ‹è¯•</h3>
                <div class="space-y-2">
                    <button onclick="testVoice()" class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                        ğŸµ æµ‹è¯•è¯­éŸ³
                    </button>
                    <div id="voiceStatus" class="text-xs text-gray-600">è¯­éŸ³æç¤ºå·²å¯ç”¨</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- å·¦ä¾§ï¼šé…ç½®é¢æ¿ -->
        <div class="bg-white rounded-lg shadow p-6 space-y-6">
            <!-- è€ƒè¯•è¯¾ç¨‹é€‰æ‹© -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒè¯•è¯¾ç¨‹</label>
                <select id="courseSelect" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                    <option value="">-- è¯·é€‰æ‹©è¯¾ç¨‹ --</option>
                </select>
            </div>

            <!-- å­¦ç”Ÿç­çº§é€‰æ‹© -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å­¦ç”Ÿç­çº§</label>
                
                <!-- ç¬¬ä¸€ä¸ªç­çº§ -->
                <div class="mb-3">
                    <select id="classSelect1" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                        <option value="">-- è¯·é€‰æ‹©ç¬¬ä¸€ä¸ªç­çº§ --</option>
                    </select>
                    <p class="text-sm text-gray-600 mt-1">ç­çº§1äººæ•°ï¼š<span id="studentCount1">0</span> äºº</p>
                </div>
                
                <!-- ç¬¬äºŒä¸ªç­çº§ï¼ˆå¯é€‰ï¼‰ -->
                <div class="mb-3">
                    <select id="classSelect2" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-purple-400">
                        <option value="">-- ç¬¬äºŒä¸ªç­çº§ï¼ˆå¯é€‰ï¼‰ --</option>
                    </select>
                    <p class="text-sm text-gray-600 mt-1">ç­çº§2äººæ•°ï¼š<span id="studentCount2">0</span> äºº</p>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg text-sm">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-blue-800">æ€»äººæ•°ï¼š<span id="totalStudentCount">0</span> äºº</span>
                        <button onclick="clearClasses()" class="text-blue-600 hover:text-blue-800 text-xs">æ¸…ç©ºé€‰æ‹©</button>
                    </div>
                </div>
            </div>

            <!-- è€ƒåœºé€‰æ‹© -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒåœº</label>
                <select id="roomSelect" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                    <option value="">-- è¯·é€‰æ‹©è€ƒåœº --</option>
                </select>
            </div>

            <!-- å½“å‰è€ƒåœºè¡Œåˆ—æ˜¾ç¤ºå’Œç¼–è¾‘ -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¡Œæ•°</label>
                    <input id="rowInput" type="number" min="1"
                           class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åˆ—æ•°</label>
                    <input id="colInput" type="number" min="1"
                           class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400">
                </div>
            </div>

            <!-- æ˜¾ç¤ºæ–¹å¼ -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">åº§ä½æ˜¾ç¤ºæ–¹å¼</label>
                <div class="space-y-1">
                    <label class="flex items-center">
                        <input type="radio" name="showMode" value="last3" checked class="mr-2">å­¦å·å3ä½
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="showMode" value="last5" class="mr-2">å­¦å·å5ä½
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="showMode" value="name" class="mr-2">å§“å
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="showMode" value="seq" class="mr-2">åºå·
                    </label>
                </div>
            </div>

<!-- åŒç­çº§æ··åˆé€‰é¡¹ -->
<div id="mixingOptions" class="hidden">
    <label class="block text-sm font-medium text-gray-700 mb-1">åŒç­çº§æ’åº§æ–¹å¼</label>
    <div class="space-y-1">
        <label class="flex items-center">
            <input type="radio" name="mixMode" value="random" checked class="mr-2">éšæœºæ··åˆ
            <span class="ml-1 text-xs text-gray-500">(ä¸¤ç­å­¦ç”Ÿå®Œå…¨éšæœºæ’åˆ—)</span>
        </label>
        <label class="flex items-center">
            <input type="radio" name="mixMode" value="alternate" class="mr-2">äº¤æ›¿æ’åˆ—
            <span class="ml-1 text-xs text-gray-500">(åº§ä½é—´äº¤æ›¿ï¼Œæ¯æ¬¡éšæœºé¡ºåº)</span>
        </label>
        <label class="flex items-center">
            <input type="radio" name="mixMode" value="separate" class="mr-2">å·¦å³åˆ†åŒºæ’åˆ—
            <span class="ml-1 text-xs text-gray-500">(å·¦è¾¹ç­çº§1ï¼Œå³è¾¹ç­çº§2ï¼ŒåŒºå†…éšæœº)</span>
        </label>
    </div>
</div>

            <button onclick="generateSeating()"
                    class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                ç”Ÿæˆåº§ä½è¡¨
            </button>

            <!-- å¯¼å‡ºæŒ‰é’® -->
            <div id="exportButtons" class="hidden space-y-2">
                <button onclick="exportToExcel()" 
                        class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    å¯¼å‡ºExcel
                </button>
                <button onclick="printSeating()" 
                        class="w-full py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    æ‰“å°åº§ä½è¡¨
                </button>
            </div>
        </div>

        <!-- å³ä¾§ï¼šé¢„è§ˆ -->
        <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">åº§ä½å®‰æ’é¢„è§ˆ</h2>
            <div id="examInfo" class="mb-4 p-4 bg-gray-50 rounded-lg"></div>
            <div id="seatingChart" class="overflow-auto"></div>
        </div>
    </div>
</div>

<script>
/* ---------- LeanCloud é…ç½® ---------- */
// è¯·æ›¿æ¢ä¸ºæ‚¨çš„ LeanCloud åº”ç”¨ä¿¡æ¯
const APP_ID = 'Gi7s7RAi1epWNVtj0X9EAqxe-gzGzoHsz'; // æ›¿æ¢ä¸ºæ‚¨çš„ App ID
const APP_KEY = 'wMXylXbeOH82GkuprhkdAon4'; // æ›¿æ¢ä¸ºæ‚¨çš„ App Key
const SERVER_URL = 'https://avoscloud.com'; // æ›¿æ¢ä¸ºæ‚¨çš„æœåŠ¡å™¨åœ°å€

let isCloudConnected = false;

// åˆå§‹åŒ– LeanCloud
function initLeanCloud() {
    try {
        if (APP_ID === 'YOUR_APP_ID') {
            // å¦‚æœæ²¡æœ‰é…ç½®LeanCloudï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼
            isCloudConnected = false;
            document.getElementById('cloudStatus').textContent = 'ğŸ’¾ æœ¬åœ°æ¨¡å¼ï¼ˆæœªé…ç½®äº‘ç«¯ï¼‰';
            document.getElementById('cloudStatus').className = 'ml-4 text-sm text-gray-600';
            return;
        }
        
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURL: SERVER_URL
        });
        isCloudConnected = true;
        document.getElementById('cloudStatus').textContent = 'â˜ï¸ äº‘ç«¯å·²è¿æ¥';
        document.getElementById('cloudStatus').className = 'ml-4 text-sm text-green-600';
        console.log('LeanCloud åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
        isCloudConnected = false;
        document.getElementById('cloudStatus').textContent = 'âš ï¸ äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®';
        document.getElementById('cloudStatus').className = 'ml-4 text-sm text-orange-600';
        console.error('LeanCloud åˆå§‹åŒ–å¤±è´¥:', error);
    }
}

/* ---------- å®Œæ•´é¢„è®¾æ•°æ® ---------- */
const defaultCourses = [
    {
        id: 'auto-control',
        name: 'è‡ªåŠ¨æ§åˆ¶åŸç†',
        time: '2025-06-27 13:30-15:05',
        duration: '95åˆ†é’Ÿ'
    }
];

const defaultStudentClasses = [
    {
        id: 'ai2023130101',
        name: 'æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2023çº§01ç­',
        students: [
            {id: '230502115', name: 'å­™é›¨ä½³'}, {id: '230502121', name: 'å¢æŸå¦'}, {id: '230503113', name: 'å¼ æ¸…å®‡'},
            {id: '231301101', name: 'å´ç§‰éœ–'}, {id: '231301102', name: 'å´å½­è¿œ'}, {id: '231301103', name: 'ç‹è¯­èª'},
            {id: '231301104', name: 'æ»¡ä¾æ­'}, {id: '231301105', name: 'é»„ä¿ŠèŒ—'}, {id: '231301106', name: 'å¼ ç£Š'},
            {id: '231301107', name: 'è‘›å³»'}, {id: '231301108', name: 'é»„å­æ—'}, {id: '231301109', name: 'æä½³æ¯…'},
            {id: '231301112', name: 'æ®·å´‡èµ«'}, {id: '231301113', name: 'é»„ç…Šå„’'}, {id: '231301114', name: 'é™ˆå»ºè˜'},
            {id: '231301115', name: 'åˆ˜è¿›è¶…'}, {id: '231301116', name: 'é»„æ–‡å‡¯'}, {id: '231301117', name: 'æ¨é”'},
            {id: '231301118', name: 'æ¨ä½³ç¦'}, {id: '231301119', name: 'ç™½ç§‹è'}, {id: '231301120', name: 'å‡Œæ–‡å“'},
            {id: '231301121', name: 'èµµæ¢“æ™—'}, {id: '231301122', name: 'é¢œè¹'}, {id: '231301123', name: 'ç‹æ…§é‘«'},
            {id: '211301301', name: 'å­™åé˜³'}, {id: '211301309', name: 'é™†æ¶›'}, {id: '211301311', name: 'èƒ¡å´‡å‘¨'},
            {id: '221301112', name: 'æ¨å†€é¾™'}, {id: '221301122', name: 'è°­è¥¿æ•'}, {id: '221301202', name: 'é©¬ç¡•'},
            {id: '221301206', name: 'å†¯åš'}, {id: '221301215', name: 'èµµä½³ä¹'}, {id: '221301218', name: 'å¾é“­ç '},
            {id: '221301304', name: 'å¼ é’°çª'}, {id: '221301307', name: 'è«å®‡æ°'}
        ]
    },
    {
        id: 'ai2023130102',
        name: 'æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2023çº§02ç­',
        students: [
            {id: '230501230', name: 'è¢ä½³'}, {id: '231002216', name: 'å¾ç­ èˆ’'}, {id: '231301201', name: 'æè‘‰æ³½'},
            {id: '231301202', name: 'å¼ é¾™å¤'}, {id: '231301203', name: 'é©¬è‚‡åŒ—'}, {id: '231301204', name: 'ç§¦ç¡•'},
            {id: '231301205', name: 'å¯Œé¹åš'}, {id: '231301206', name: 'ç‹æ˜±æ‡¿'}, {id: '231301207', name: 'æå®‡å®¸'},
            {id: '231301208', name: 'è´¾æ˜¥æ—º'}, {id: '231301209', name: 'é™ˆé¹åš'}, {id: '231301210', name: 'é‚µå­æœ—'},
            {id: '231301211', name: 'éƒ‘ä¼˜'}, {id: '231301212', name: 'é™ˆæ¾ç‡š'}, {id: '231301213', name: 'ç¥æ¬£å®'},
            {id: '231301214', name: 'åˆ˜ä¿Šç†™'}, {id: '231301215', name: 'å‘¨é©°ä¼Ÿ'}, {id: '231301217', name: 'èµµä¸€éœ–'},
            {id: '231301218', name: 'æœç¿˜æ¥š'}, {id: '231301219', name: 'æŸ´å°å–†'}, {id: '231301220', name: 'å¼ å‚²é›ª'},
            {id: '231301221', name: 'å•èˆª'}, {id: '231301222', name: 'é‚¬å˜‰èª‰'}, {id: '231301223', name: 'é»„å©·'}
        ]
    },
    {
        id: 'ai2023130103',
        name: 'æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯2023çº§03ç­',
        students: [
            {id: '231301301', name: 'åˆ˜å¿—ç¿”'}, {id: '231301302', name: 'æéŸ«ä¸'}, {id: '231301303', name: 'é©¬ä»•åš'},
            {id: '231301304', name: 'å¨„å˜‰'}, {id: '231301305', name: 'é™¶å‰‘å—'}, {id: '231301306', name: 'é¡¾å¿—æˆ'},
            {id: '231301307', name: 'å´å¤§å‘¨'}, {id: '231301308', name: 'æ¢å¤©é˜³'}, {id: '231301309', name: 'ç‹æ™¯çš“'},
            {id: '231301310', name: 'å¼ å¿ æ©'}, {id: '231301311', name: 'å‘å»¶æµ©'}, {id: '231301312', name: 'æ®µå®¶æ˜Œ'},
            {id: '231301313', name: 'å…‹ç„¶Â·å“ˆåˆ«å…‹'}, {id: '231301314', name: 'åŠªåŠ›æ‰æÂ·åŠªåŠ›ä¹°ä¹°æ'}, {id: '231301315', name: 'ç¿Ÿä½³ä¿Š'},
            {id: '231301316', name: 'é˜¿åœæœç“¦æ—¥æ–¯Â·å·´æ‹‰æå°¼äºšå­œ'}, {id: '231301317', name: 'ç‹äº‘è²'}, {id: '231301318', name: 'éš‹æ–°ä»ª'},
            {id: '231301319', name: 'éœæ—æ€¡'}, {id: '231301320', name: 'å§œåœ£æ´'}, {id: '231301321', name: 'ç‹å¦ä¸¹'},
            {id: '231301322', name: 'å®‰å‡¤å¨‡'}, {id: '231301323', name: 'ææ¬£ç‘¶'}
        ]
    },
    {
        id: 'ai2023130301',
        name: 'å·¥ä¸šæ™ºèƒ½2023çº§01ç­',
        students: [
            {id: '221303221', name: 'é™ˆæŸéœ–'}, {id: '231303101', name: 'åŠé¹¤ç«£'}, {id: '231303102', name: 'å´ç•¥é”Ÿ'},
            {id: '231303103', name: 'èµµç¦¹ç¨‹'}, {id: '231303104', name: 'é™ˆé˜³'}, {id: '231303105', name: 'æå“'},
            {id: '231303106', name: 'å®‹æµ·æ¥ '}, {id: '231303107', name: 'å¼ºæ˜±æ™´'}, {id: '231303108', name: 'ç‹ä¸œæ—¶'},
            {id: '231303109', name: 'æå‡¯å¹³'}, {id: '231303111', name: 'å´ä»é£'}, {id: '231303112', name: 'å‘¨å…‹ç†™'},
            {id: '231303113', name: 'èµµå®‡æ™¨'}, {id: '231303114', name: 'æˆ´é™ˆ'}, {id: '231303115', name: 'é™ˆæµåŸ¹'},
            {id: '231303116', name: 'åˆ˜çƒ¨'}, {id: '231303117', name: 'ä¸¥æ¦•è€€'}, {id: '231303118', name: 'å´æ˜Ÿç£Š'},
            {id: '231303119', name: 'æ—å…´ä¸¹'}, {id: '231303120', name: 'è«å­ç…Š'}, {id: '231303121', name: 'ç†Šæµ©ç„¶'},
            {id: '231303122', name: 'é™ˆåšå„’'}, {id: '231303123', name: 'å´é¾™'}, {id: '231303124', name: 'å¼ è¯—èŒ¹'},
            {id: '231303126', name: 'èµµå©‰ä¼Š'}, {id: '231303127', name: 'ç‹ä½³è•Š'}, {id: '231303128', name: 'æˆ¿æ–‡é™'},
            {id: '231303129', name: 'å´æ‰¬ä¿ª'}, {id: '231303130', name: 'å‘åŒçº¢'}, {id: '211303104', name: 'ç‹å®å®‡'},
            {id: '211303109', name: 'åˆ˜å²©æ¾'}, {id: '211303207', name: 'åˆ˜ä¸–åš'}, {id: '211303230', name: 'é™ˆä¸½äº‘'},
            {id: '221303121', name: 'æé«˜å¿—'}, {id: '221303123', name: 'ç§¦ä¸€'}, {id: '221303130', name: 'æ¢…ç‰å…°'},
            {id: '221303203', name: 'å¼ å®‡èˆª'}, {id: '221303217', name: 'ä½•æ³½æ–Œ'}, {id: '221303218', name: 'é›·è€€å¤©'}
        ]
    },    
    {
        id: 'ai2023130302',
        name: 'å·¥ä¸šæ™ºèƒ½2023çº§02ç­',
        students: [
            {id: '211303214', name: 'è‘£å»ºåº'}, {id: '230502223', name: 'ç‹æ–‡é™'}, {id: '230801215', name: 'ç‹æ–‡åš'},
            {id: '231303201', name: 'ç™½å®‡'}, {id: '231303202', name: 'èƒ¡éŸ¶å'}, {id: '231303203', name: 'ç‹æ‰¿è¾‰'},
            {id: '231303204', name: 'è–›åšæ–‡'}, {id: '231303205', name: 'ç‹å¥ç¿”'}, {id: '231303206', name: 'é™ˆè‹±åŒ'},
            {id: '231303207', name: 'è¢ä¾¨äº¨'}, {id: '231303208', name: 'è‘›ä¸–å¤'}, {id: '231303209', name: 'éŸ©ä½³è®¯'},
            {id: '231303210', name: 'ç‹æŸ„ç„¶'}, {id: '231303211', name: 'å¸¸å®å®‰'}, {id: '231303212', name: 'ç‹å½¬'},
            {id: '231303213', name: 'å»–æµ·æ¶›'}, {id: '231303214', name: 'è”¡å¿—é¹'}, {id: '231303215', name: 'é«˜ç„•ä¸œ'},
            {id: '231303216', name: 'é‚±ç›…æ·‡'}, {id: '231303217', name: 'æ±Ÿå°å·'}, {id: '231303218', name: 'å†¯æ„‰'},
            {id: '231303219', name: 'æ±Ÿå®‡èˆª'}, {id: '231303220', name: 'é©¬å¿—å‡Œ'}, {id: '231303221', name: 'ææ‰¬'},
            {id: '231303222', name: 'é™ˆè‚¸'}, {id: '231303223', name: 'æå¼€å³°'}, {id: '231303224', name: 'é²å…´è¶…'},
            {id: '231303225', name: 'ä¾¯ç‰æ¶µ'}, {id: '231303226', name: 'æåŠ²æŸ“'}, {id: '231303227', name: 'åˆ˜æ½‡é›¯'},
            {id: '231303229', name: 'è£´æ‚¦ç„¶'}, {id: '231303230', name: 'å‘é¹é“®'}
        ]
    }   
];

const defaultRooms = [
    {id: 'B104', name: 'æ•™å­¦æ¥¼B104', rows: 8, cols: 5},
    {id: 'B105', name: 'æ•™å­¦æ¥¼B105', rows: 7, cols: 5},
    {id: 'B106', name: 'æ•™å­¦æ¥¼B106', rows: 7, cols: 5},
    {id: 'B109', name: 'æ•™å­¦æ¥¼B109', rows: 12, cols: 6}    
];

/* ---------- æ•°æ®æ¨¡å‹ ---------- */
let courses = [];
let studentClasses = [];
let rooms = [];

let currentStudents1 = [];
let currentStudents2 = [];
let currentSeating = null;

// æ—¶é—´å’Œè¯­éŸ³ç›¸å…³å˜é‡
let examTimer = null;
let voiceEnabled = true;
let voiceAlerts = [30, 20, 10, 5];
let alertedTimes = new Set();
let availableVoices = [];
let selectedVoice = null;

/* ---------- åˆå§‹åŒ– ---------- */
async function init() {
    try {
        // åˆå§‹åŒ– LeanCloud
        initLeanCloud();
        
        if (isCloudConnected) {
            // å°è¯•ä»äº‘ç«¯åŠ è½½æ•°æ®
            await loadCoursesFromCloud();
            await loadClassesFromCloud();
            await loadRoomsFromCloud();
        } else {
            // ä½¿ç”¨é»˜è®¤æ•°æ®
            loadDefaultData();
        }
        
        // åˆå§‹åŒ–ç•Œé¢
        refreshCourseSelect();
        refreshClassSelect();
        refreshRoomSelect();
        startRealTimeClock();
        loadVoices();
        
        console.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        // å¦‚æœäº‘ç«¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
        loadDefaultData();
        refreshCourseSelect();
        refreshClassSelect();
        refreshRoomSelect();
        startRealTimeClock();
        loadVoices();
    }
}

/* ---------- LeanCloud æ•°æ®æ“ä½œ ---------- */

// åŠ è½½è¯¾ç¨‹æ•°æ®
async function loadCoursesFromCloud() {
    if (!isCloudConnected) {
        loadDefaultData();
        return;
    }
    
    try {
        const Course = AV.Object.extend('Course');
        const query = new AV.Query(Course);
        const results = await query.find();
        
        courses = results.map(course => ({
            id: course.get('courseId'),
            name: course.get('name'),
            time: course.get('time'),
            duration: course.get('duration'),
            objectId: course.id
        }));
        
        // å¦‚æœäº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
        if (courses.length === 0) {
            courses = [...defaultCourses];
        }
        
        console.log('è¯¾ç¨‹æ•°æ®åŠ è½½å®Œæˆ:', courses.length);
    } catch (error) {
        console.error('åŠ è½½è¯¾ç¨‹æ•°æ®å¤±è´¥:', error);
        courses = [...defaultCourses];
    }
}

// åŠ è½½ç­çº§æ•°æ®
async function loadClassesFromCloud() {
    if (!isCloudConnected) {
        return;
    }
    
    try {
        const StudentClass = AV.Object.extend('StudentClass');
        const query = new AV.Query(StudentClass);
        const results = await query.find();
        
        studentClasses = results.map(cls => ({
            id: cls.get('classId'),
            name: cls.get('name'),
            students: cls.get('students') || [],
            objectId: cls.id
        }));
        
        // å¦‚æœäº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
        if (studentClasses.length === 0) {
            studentClasses = [...defaultStudentClasses];
        }
        
        console.log('ç­çº§æ•°æ®åŠ è½½å®Œæˆ:', studentClasses.length);
    } catch (error) {
        console.error('åŠ è½½ç­çº§æ•°æ®å¤±è´¥:', error);
        studentClasses = [...defaultStudentClasses];
    }
}

// åŠ è½½è€ƒåœºæ•°æ®
async function loadRoomsFromCloud() {
    if (!isCloudConnected) {
        return;
    }
    
    try {
        const Room = AV.Object.extend('Room');
        const query = new AV.Query(Room);
        const results = await query.find();
        
        rooms = results.map(room => ({
            id: room.get('roomId'),
            name: room.get('name'),
            rows: room.get('rows'),
            cols: room.get('cols'),
            objectId: room.id
        }));
        
        // å¦‚æœäº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
        if (rooms.length === 0) {
            rooms = [...defaultRooms];
        }
        
        console.log('è€ƒåœºæ•°æ®åŠ è½½å®Œæˆ:', rooms.length);
    } catch (error) {
        console.error('åŠ è½½è€ƒåœºæ•°æ®å¤±è´¥:', error);
        rooms = [...defaultRooms];
    }
}

// åŠ è½½é»˜è®¤æ•°æ®
function loadDefaultData() {
    courses = [...defaultCourses];
    studentClasses = [...defaultStudentClasses];
    rooms = [...defaultRooms];
    console.log('ä½¿ç”¨é»˜è®¤æ•°æ®');
}

// ä¿å­˜è¯¾ç¨‹åˆ°äº‘ç«¯
async function saveCourseToCloud(courseData) {
    if (!isCloudConnected) {
        console.log('äº‘ç«¯æœªè¿æ¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');
        return courseData;
    }
    
    try {
        const Course = AV.Object.extend('Course');
        const course = new Course();
        
        course.set('courseId', courseData.id);
        course.set('name', courseData.name);
        course.set('time', courseData.time);
        course.set('duration', courseData.duration);
        
        const savedCourse = await course.save();
        courseData.objectId = savedCourse.id;
        
        console.log('è¯¾ç¨‹ä¿å­˜æˆåŠŸ:', courseData);
        return courseData;
    } catch (error) {
        console.error('ä¿å­˜è¯¾ç¨‹å¤±è´¥:', error);
        alert('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');
        return courseData;
    }
}

// ä¿å­˜ç­çº§åˆ°äº‘ç«¯
async function saveClassToCloud(classData) {
    if (!isCloudConnected) {
        console.log('äº‘ç«¯æœªè¿æ¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');
        return classData;
    }
    
    try {
        const StudentClass = AV.Object.extend('StudentClass');
        const studentClass = new StudentClass();
        
        studentClass.set('classId', classData.id);
        studentClass.set('name', classData.name);
        studentClass.set('students', classData.students);
        
        const savedClass = await studentClass.save();
        classData.objectId = savedClass.id;
        
        console.log('ç­çº§ä¿å­˜æˆåŠŸ:', classData);
        return classData;
    } catch (error) {
        console.error('ä¿å­˜ç­çº§å¤±è´¥:', error);
        alert('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');
        return classData;
    }
}

// ä¿å­˜è€ƒåœºåˆ°äº‘ç«¯
async function saveRoomToCloud(roomData) {
    if (!isCloudConnected) {
        console.log('äº‘ç«¯æœªè¿æ¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');
        return roomData;
    }
    
    try {
        const Room = AV.Object.extend('Room');
        const room = new Room();
        
        room.set('roomId', roomData.id);
        room.set('name', roomData.name);
        room.set('rows', roomData.rows);
        room.set('cols', roomData.cols);
        
        const savedRoom = await room.save();
        roomData.objectId = savedRoom.id;
        
        console.log('è€ƒåœºä¿å­˜æˆåŠŸ:', roomData);
        return roomData;
    } catch (error) {
        console.error('ä¿å­˜è€ƒåœºå¤±è´¥:', error);
        alert('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');
        return roomData;
    }
}

// åˆ é™¤æ•°æ®
async function deleteFromCloud(className, objectId) {
    if (!isCloudConnected || !objectId) {
        console.log('äº‘ç«¯æœªè¿æ¥æˆ–æ— objectIdï¼Œä»…ä»æœ¬åœ°åˆ é™¤');
        return;
    }
    
    try {
        const DataClass = AV.Object.extend(className);
        const object = AV.Object.createWithoutData(className, objectId);
        await object.destroy();
        console.log('åˆ é™¤æˆåŠŸ:', className, objectId);
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('ä»äº‘ç«¯åˆ é™¤å¤±è´¥');
    }
}

/* ---------- æ•°æ®ç®¡ç†ç•Œé¢ ---------- */

// æ‰“å¼€æ•°æ®ç®¡ç†å¼¹çª—
function openDataManager() {
    document.getElementById('dataManagerModal').classList.remove('hidden');
    loadDataManagerContent();
}

// å…³é—­æ•°æ®ç®¡ç†å¼¹çª—
function closeDataManager() {
    document.getElementById('dataManagerModal').classList.add('hidden');
}

// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(tabName) {
    // éšè—æ‰€æœ‰é¢æ¿
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.add('hidden');
    });
    
    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // æ˜¾ç¤ºé€‰ä¸­çš„é¢æ¿
    document.getElementById(`${tabName}-panel`).classList.remove('hidden');
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // åŠ è½½å¯¹åº”æ•°æ®
    loadDataManagerContent(tabName);
}

// åŠ è½½æ•°æ®ç®¡ç†å†…å®¹
function loadDataManagerContent(activeTab = 'courses') {
    if (activeTab === 'courses') {
        loadCoursesManager();
    } else if (activeTab === 'classes') {
        loadClassesManager();
    } else if (activeTab === 'rooms') {
        loadRoomsManager();
    }
}

// åŠ è½½è¯¾ç¨‹ç®¡ç†å†…å®¹
function loadCoursesManager() {
    const container = document.getElementById('coursesList');
    if (!container) return;
    
    container.innerHTML = '';
    
    courses.forEach(course => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-3 bg-white border rounded-lg';
        item.innerHTML = `
            <div class="flex-1">
                <div class="font-medium">${course.name}</div>
                <div class="text-sm text-gray-600">ID: ${course.id} | æ—¶é—´: ${course.time} | æ—¶é•¿: ${course.duration}</div>
            </div>
            <div class="flex gap-2">
                <button onclick="editCourse('${course.id}')" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">ç¼–è¾‘</button>
                <button onclick="deleteCourse('${course.id}')" class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600">åˆ é™¤</button>
            </div>
        `;
        container.appendChild(item);
    });
    
    if (courses.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— è¯¾ç¨‹æ•°æ®</div>';
    }
}

// åŠ è½½ç­çº§ç®¡ç†å†…å®¹
function loadClassesManager() {
    const container = document.getElementById('classesList');
    if (!container) return;
    
    container.innerHTML = '';
    
    studentClasses.forEach(cls => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-3 bg-white border rounded-lg';
        item.innerHTML = `
            <div class="flex-1">
                <div class="font-medium">${cls.name}</div>
                <div class="text-sm text-gray-600">ID: ${cls.id} | å­¦ç”Ÿäººæ•°: ${cls.students.length}äºº</div>
            </div>
            <div class="flex gap-2">
                <button onclick="viewStudents('${cls.id}')" class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">æŸ¥çœ‹å­¦ç”Ÿ</button>
                <button onclick="editClass('${cls.id}')" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">ç¼–è¾‘</button>
                <button onclick="deleteClass('${cls.id}')" class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600">åˆ é™¤</button>
            </div>
        `;
        container.appendChild(item);
    });
    
    if (studentClasses.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— ç­çº§æ•°æ®</div>';
    }
}

// åŠ è½½è€ƒåœºç®¡ç†å†…å®¹
function loadRoomsManager() {
    const container = document.getElementById('roomsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    rooms.forEach(room => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-3 bg-white border rounded-lg';
        item.innerHTML = `
            <div class="flex-1">
                <div class="font-medium">${room.name}</div>
                <div class="text-sm text-gray-600">ID: ${room.id} | å¸ƒå±€: ${room.rows}è¡ŒÃ—${room.cols}åˆ— | æ€»åº§ä½: ${room.rows * room.cols}ä¸ª</div>
            </div>
            <div class="flex gap-2">
                <button onclick="editRoom('${room.id}')" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">ç¼–è¾‘</button>
                <button onclick="deleteRoom('${room.id}')" class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600">åˆ é™¤</button>
            </div>
        `;
        container.appendChild(item);
    });
    
    if (rooms.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— è€ƒåœºæ•°æ®</div>';
    }
}

/* ---------- è¯¾ç¨‹ç®¡ç†åŠŸèƒ½ ---------- */

// æ˜¾ç¤ºæ·»åŠ è¯¾ç¨‹è¡¨å•
function showAddCourseForm() {
    document.getElementById('addCourseForm').classList.remove('hidden');
    // æ¸…ç©ºè¡¨å•
    document.getElementById('courseId').value = '';
    document.getElementById('courseName').value = '';
    document.getElementById('courseTime').value = '';
    document.getElementById('courseDuration').value = '';
}

// å–æ¶ˆæ·»åŠ è¯¾ç¨‹
function cancelAddCourse() {
    document.getElementById('addCourseForm').classList.add('hidden');
    // æ¢å¤ä¿å­˜æŒ‰é’®
    const saveBtn = document.querySelector('#addCourseForm button[onclick*="Course"]');
    if (saveBtn) {
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.onclick = saveCourse;
    }
}

// ä¿å­˜è¯¾ç¨‹
async function saveCourse() {
    const id = document.getElementById('courseId').value.trim();
    const name = document.getElementById('courseName').value.trim();
    const time = document.getElementById('courseTime').value.trim();
    const duration = document.getElementById('courseDuration').value.trim();
    
    if (!id || !name || !time || !duration) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
    }
    
    // æ£€æŸ¥IDæ˜¯å¦é‡å¤
    if (courses.find(c => c.id === id)) {
        alert('è¯¾ç¨‹IDå·²å­˜åœ¨');
        return;
    }
    
    const courseData = { id, name, time, duration };
    
    try {
        // ä¿å­˜åˆ°äº‘ç«¯
        const savedCourse = await saveCourseToCloud(courseData);
        
        // æ·»åŠ åˆ°æœ¬åœ°
        courses.push(savedCourse);
        
        // åˆ·æ–°ç•Œé¢
        refreshCourseSelect();
        loadCoursesManager();
        cancelAddCourse();
        
        alert('è¯¾ç¨‹æ·»åŠ æˆåŠŸ');
    } catch (error) {
        console.error('ä¿å­˜è¯¾ç¨‹å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥');
    }
}

// ç¼–è¾‘è¯¾ç¨‹
function editCourse(courseId) {
    const course = courses.find(c => c.id === courseId);
    if (!course) return;
    
    // å¡«å……è¡¨å•
    document.getElementById('courseId').value = course.id;
    document.getElementById('courseName').value = course.name;
    document.getElementById('courseTime').value = course.time;
    document.getElementById('courseDuration').value = course.duration;
    
    // æ˜¾ç¤ºè¡¨å•
    showAddCourseForm();
    
    // ä¿®æ”¹ä¿å­˜æŒ‰é’®åŠŸèƒ½
    const saveBtn = document.querySelector('#addCourseForm button[onclick="saveCourse()"]');
    saveBtn.textContent = 'æ›´æ–°';
    saveBtn.onclick = () => updateCourse(courseId);
}

// æ›´æ–°è¯¾ç¨‹
async function updateCourse(originalId) {
    const id = document.getElementById('courseId').value.trim();
    const name = document.getElementById('courseName').value.trim();
    const time = document.getElementById('courseTime').value.trim();
    const duration = document.getElementById('courseDuration').value.trim();
    
    if (!id || !name || !time || !duration) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
    }
    
    const courseIndex = courses.findIndex(c => c.id === originalId);
    if (courseIndex === -1) return;
    
    const updatedCourse = { ...courses[courseIndex], id, name, time, duration };
    
    try {
        // å¦‚æœæœ‰äº‘ç«¯æ•°æ®ï¼Œæ›´æ–°äº‘ç«¯
        if (isCloudConnected && updatedCourse.objectId) {
            const Course = AV.Object.extend('Course');
            const course = AV.Object.createWithoutData('Course', updatedCourse.objectId);
            course.set('courseId', id);
            course.set('name', name);
            course.set('time', time);
            course.set('duration', duration);
            await course.save();
        }
        
        // æ›´æ–°æœ¬åœ°
        courses[courseIndex] = updatedCourse;
        
        // åˆ·æ–°ç•Œé¢
        refreshCourseSelect();
        loadCoursesManager();
        cancelAddCourse();
        
        alert('è¯¾ç¨‹æ›´æ–°æˆåŠŸ');
    } catch (error) {
        console.error('æ›´æ–°è¯¾ç¨‹å¤±è´¥:', error);
        alert('æ›´æ–°å¤±è´¥');
    }
}

// åˆ é™¤è¯¾ç¨‹
async function deleteCourse(courseId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯¾ç¨‹å—ï¼Ÿ')) {
        return;
    }
    
    const courseIndex = courses.findIndex(c => c.id === courseId);
    if (courseIndex === -1) return;
    
    const course = courses[courseIndex];
    
    try {
        // ä»äº‘ç«¯åˆ é™¤
        if (course.objectId) {
            await deleteFromCloud('Course', course.objectId);
        }
        
        // ä»æœ¬åœ°åˆ é™¤
        courses.splice(courseIndex, 1);
        
        // åˆ·æ–°ç•Œé¢
        refreshCourseSelect();
        loadCoursesManager();
        
        alert('è¯¾ç¨‹åˆ é™¤æˆåŠŸ');
    } catch (error) {
        console.error('åˆ é™¤è¯¾ç¨‹å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥');
    }
}

/* ---------- ç­çº§ç®¡ç†åŠŸèƒ½ ---------- */

// æ˜¾ç¤ºæ·»åŠ ç­çº§è¡¨å•
function showAddClassForm() {
    document.getElementById('addClassForm').classList.remove('hidden');
    // æ¸…ç©ºè¡¨å•
    document.getElementById('classId').value = '';
    document.getElementById('className').value = '';
    document.getElementById('classStudents').value = '';
}

// å–æ¶ˆæ·»åŠ ç­çº§
function cancelAddClass() {
    document.getElementById('addClassForm').classList.add('hidden');
    // æ¢å¤ä¿å­˜æŒ‰é’®
    const saveBtn = document.querySelector('#addClassForm button[onclick*="Class"]');
    if (saveBtn) {
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.onclick = saveClass;
    }
}

// ä¿å­˜ç­çº§ï¼ˆä¹Ÿéœ€è¦ç›¸åŒçš„ä¿®æ”¹ï¼‰
async function saveClass() {
    const id = document.getElementById('classId').value.trim();
    const name = document.getElementById('className').value.trim();
    const studentsText = document.getElementById('classStudents').value.trim();
    
    if (!id || !name || !studentsText) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
    }
    
    // æ£€æŸ¥IDæ˜¯å¦é‡å¤
    if (studentClasses.find(c => c.id === id)) {
        alert('ç­çº§IDå·²å­˜åœ¨');
        return;
    }
    
    // è§£æå­¦ç”Ÿä¿¡æ¯
    const students = [];
    const lines = studentsText.split('\n');
    
    for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        
        // ç”¨ç©ºæ ¼åˆ†å‰²ï¼Œæ”¯æŒå¤šä¸ªç©ºæ ¼ï¼Œå¹¶ä¸”æ”¯æŒå§“åä¸­æœ‰ç©ºæ ¼
        const parts = line.split(/\s+/);
        if (parts.length < 2) {
            alert(`æ ¼å¼é”™è¯¯ï¼š${line}\nè¯·ä½¿ç”¨æ ¼å¼ï¼šå­¦å· å§“å`);
            return;
        }
        
        const studentId = parts[0].trim();
        const studentName = parts.slice(1).join(' ').trim(); // å°†ç¬¬äºŒä¸ªåŠä¹‹åçš„éƒ¨åˆ†ç”¨ç©ºæ ¼è¿æ¥ä½œä¸ºå§“å
        
        if (!studentId || !studentName) {
            alert(`å­¦å·æˆ–å§“åä¸èƒ½ä¸ºç©ºï¼š${line}`);
            return;
        }
        
        students.push({ id: studentId, name: studentName });
    }
    
    if (students.length === 0) {
        alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå­¦ç”Ÿ');
        return;
    }
    
    const classData = { id, name, students };
    
    try {
        // ä¿å­˜åˆ°äº‘ç«¯
        const savedClass = await saveClassToCloud(classData);
        
        // æ·»åŠ åˆ°æœ¬åœ°
        studentClasses.push(savedClass);
        
        // åˆ·æ–°ç•Œé¢
        refreshClassSelect();
        loadClassesManager();
        cancelAddClass();
        
        alert(`ç­çº§æ·»åŠ æˆåŠŸï¼Œå…±${students.length}åå­¦ç”Ÿ`);
    } catch (error) {
        console.error('ä¿å­˜ç­çº§å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥');
    }
}

// æŸ¥çœ‹å­¦ç”Ÿ
function viewStudents(classId) {
    const cls = studentClasses.find(c => c.id === classId);
    if (!cls) return;
    
    // å…ˆæ£€æŸ¥å®é™…å­¦ç”Ÿæ•°é‡
    console.log(`ç­çº§ ${cls.name} å®é™…å­¦ç”Ÿæ•°é‡ï¼š`, cls.students.length);
    
    // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿ
    let studentsHtml = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">ç­çº§ï¼š${cls.name}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="overflow-y-auto max-h-96 border rounded p-3">
                    <div class="space-y-1">
    `;
    
    // æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿ
    cls.students.forEach((student, index) => {
        studentsHtml += `
            <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded">
                <span>${index + 1}. ${student.name}</span>
                <span class="text-gray-600 text-sm">${student.id}</span>
            </div>
        `;
    });
    
    studentsHtml += `
                    </div>
                </div>
                <div class="mt-4 text-center text-gray-600">
                    æ€»è®¡ ${cls.students.length} åå­¦ç”Ÿ
                </div>
                <button onclick="this.closest('.fixed').remove()" 
                    class="mt-4 w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    å…³é—­
                </button>
            </div>
        </div>
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    const modalDiv = document.createElement('div');
    modalDiv.innerHTML = studentsHtml;
    document.body.appendChild(modalDiv.firstElementChild);
}


// ç¼–è¾‘ç­çº§
function editClass(classId) {
    const cls = studentClasses.find(c => c.id === classId);
    if (!cls) return;
    
    // å¡«å……è¡¨å•
    document.getElementById('classId').value = cls.id;
    document.getElementById('className').value = cls.name;
    
    // æ ¼å¼åŒ–å­¦ç”Ÿä¿¡æ¯ - æ”¹ä¸ºç©ºæ ¼åˆ†éš”
    const studentsText = cls.students.map(s => `${s.id} ${s.name}`).join('\n');
    document.getElementById('classStudents').value = studentsText;
    
    // æ˜¾ç¤ºè¡¨å•
    showAddClassForm();
    
    // ä¿®æ”¹ä¿å­˜æŒ‰é’®åŠŸèƒ½
    const saveBtn = document.querySelector('#addClassForm button[onclick="saveClass()"]');
    saveBtn.textContent = 'æ›´æ–°';
    saveBtn.onclick = () => updateClass(classId);
}

// æ›´æ–°ç­çº§
async function updateClass(originalId) {
    const id = document.getElementById('classId').value.trim();
    const name = document.getElementById('className').value.trim();
    const studentsText = document.getElementById('classStudents').value.trim();
    
    if (!id || !name || !studentsText) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
    }
    
    // è§£æå­¦ç”Ÿä¿¡æ¯
    const students = [];
    const lines = studentsText.split('\n');
    
    for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        
        // ç”¨ç©ºæ ¼åˆ†å‰²ï¼Œæ”¯æŒå¤šä¸ªç©ºæ ¼ï¼Œå¹¶ä¸”æ”¯æŒå§“åä¸­æœ‰ç©ºæ ¼
        const parts = line.split(/\s+/);
        if (parts.length < 2) {
            alert(`æ ¼å¼é”™è¯¯ï¼š${line}\nè¯·ä½¿ç”¨æ ¼å¼ï¼šå­¦å· å§“å`);
            return;
        }
        
        const studentId = parts[0].trim();
        const studentName = parts.slice(1).join(' ').trim(); // å°†ç¬¬äºŒä¸ªåŠä¹‹åçš„éƒ¨åˆ†ç”¨ç©ºæ ¼è¿æ¥ä½œä¸ºå§“å
        
        if (!studentId || !studentName) {
            alert(`å­¦å·æˆ–å§“åä¸èƒ½ä¸ºç©ºï¼š${line}`);
            return;
        }
        
        students.push({ id: studentId, name: studentName });
    }
    
    if (students.length === 0) {
        alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå­¦ç”Ÿ');
        return;
    }
    
    const classIndex = studentClasses.findIndex(c => c.id === originalId);
    if (classIndex === -1) return;
    
    const updatedClass = { ...studentClasses[classIndex], id, name, students };
    
    try {
        // å¦‚æœæœ‰äº‘ç«¯æ•°æ®ï¼Œæ›´æ–°äº‘ç«¯
        if (isCloudConnected && updatedClass.objectId) {
            const StudentClass = AV.Object.extend('StudentClass');
            const cls = AV.Object.createWithoutData('StudentClass', updatedClass.objectId);
            cls.set('classId', id);
            cls.set('name', name);
            cls.set('students', students);
            await cls.save();
        }
        
        // æ›´æ–°æœ¬åœ°
        studentClasses[classIndex] = updatedClass;
        
        // åˆ·æ–°ç•Œé¢
        refreshClassSelect();
        loadClassesManager();
        cancelAddClass();
        
        alert('ç­çº§æ›´æ–°æˆåŠŸ');
    } catch (error) {
        console.error('æ›´æ–°ç­çº§å¤±è´¥:', error);
        alert('æ›´æ–°å¤±è´¥');
    }
}

// åˆ é™¤ç­çº§
async function deleteClass(classId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç­çº§å—ï¼Ÿ')) {
        return;
    }
    
    const classIndex = studentClasses.findIndex(c => c.id === classId);
    if (classIndex === -1) return;
    
    const cls = studentClasses[classIndex];
    
    try {
        // ä»äº‘ç«¯åˆ é™¤
        if (cls.objectId) {
            await deleteFromCloud('StudentClass', cls.objectId);
        }
        
        // ä»æœ¬åœ°åˆ é™¤
        studentClasses.splice(classIndex, 1);
        
        // åˆ·æ–°ç•Œé¢
        refreshClassSelect();
        loadClassesManager();
        
        alert('ç­çº§åˆ é™¤æˆåŠŸ');
    } catch (error) {
        console.error('åˆ é™¤ç­çº§å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥');
    }
}

/* ---------- è€ƒåœºç®¡ç†åŠŸèƒ½ ---------- */

// æ˜¾ç¤ºæ·»åŠ è€ƒåœºè¡¨å•
function showAddRoomForm() {
    document.getElementById('addRoomForm').classList.remove('hidden');
    // æ¸…ç©ºè¡¨å•
    document.getElementById('roomId').value = '';
    document.getElementById('roomName').value = '';
    document.getElementById('roomRows').value = '';
    document.getElementById('roomCols').value = '';
}

// å–æ¶ˆæ·»åŠ è€ƒåœº
function cancelAddRoom() {
    document.getElementById('addRoomForm').classList.add('hidden');
    // æ¢å¤ä¿å­˜æŒ‰é’®
    const saveBtn = document.querySelector('#addRoomForm button[onclick*="Room"]');
    if (saveBtn) {
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.onclick = saveRoom;
    }
}

// ä¿å­˜è€ƒåœº
async function saveRoom() {
    const id = document.getElementById('roomId').value.trim();
    const name = document.getElementById('roomName').value.trim();
    const rows = parseInt(document.getElementById('roomRows').value);
    const cols = parseInt(document.getElementById('roomCols').value);
    
    if (!id || !name || !rows || !cols) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
    }
    
    if (rows < 1 || cols < 1) {
        alert('è¡Œæ•°å’Œåˆ—æ•°å¿…é¡»å¤§äº0');
        return;
    }
    
    // æ£€æŸ¥IDæ˜¯å¦é‡å¤
    if (rooms.find(r => r.id === id)) {
        alert('è€ƒåœºIDå·²å­˜åœ¨');
        return;
    }
    
    const roomData = { id, name, rows, cols };
    
    try {
        // ä¿å­˜åˆ°äº‘ç«¯
        const savedRoom = await saveRoomToCloud(roomData);
        
        // æ·»åŠ åˆ°æœ¬åœ°
        rooms.push(savedRoom);
        
        // åˆ·æ–°ç•Œé¢
        refreshRoomSelect();
        loadRoomsManager();
        cancelAddRoom();
        
        alert('è€ƒåœºæ·»åŠ æˆåŠŸ');
    } catch (error) {
        console.error('ä¿å­˜è€ƒåœºå¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥');
    }
}

// ç¼–è¾‘è€ƒåœº
function editRoom(roomId) {
    const room = rooms.find(r => r.id === roomId);
    if (!room) return;
    
    // å¡«å……è¡¨å•
    document.getElementById('roomId').value = room.id;
    document.getElementById('roomName').value = room.name;
    document.getElementById('roomRows').value = room.rows;
    document.getElementById('roomCols').value = room.cols;
    
    // æ˜¾ç¤ºè¡¨å•
    showAddRoomForm();
    
    // ä¿®æ”¹ä¿å­˜æŒ‰é’®åŠŸèƒ½
    const saveBtn = document.querySelector('#addRoomForm button[onclick="saveRoom()"]');
    saveBtn.textContent = 'æ›´æ–°';
    saveBtn.onclick = () => updateRoom(roomId);
}

// æ›´æ–°è€ƒåœº
async function updateRoom(originalId) {
    const id = document.getElementById('roomId').value.trim();
    const name = document.getElementById('roomName').value.trim();
    const rows = parseInt(document.getElementById('roomRows').value);
    const cols = parseInt(document.getElementById('roomCols').value);
    
    if (!id || !name || !rows || !cols) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
    }
    
    if (rows < 1 || cols < 1) {
        alert('è¡Œæ•°å’Œåˆ—æ•°å¿…é¡»å¤§äº0');
        return;
    }
    
    const roomIndex = rooms.findIndex(r => r.id === originalId);
    if (roomIndex === -1) return;
    
    const updatedRoom = { ...rooms[roomIndex], id, name, rows, cols };
    
    try {
        // å¦‚æœæœ‰äº‘ç«¯æ•°æ®ï¼Œæ›´æ–°äº‘ç«¯
        if (isCloudConnected && updatedRoom.objectId) {
            const Room = AV.Object.extend('Room');
            const room = AV.Object.createWithoutData('Room', updatedRoom.objectId);
            room.set('roomId', id);
            room.set('name', name);
            room.set('rows', rows);
            room.set('cols', cols);
            await room.save();
        }
        
        // æ›´æ–°æœ¬åœ°
        rooms[roomIndex] = updatedRoom;
        
        // åˆ·æ–°ç•Œé¢
        refreshRoomSelect();
        loadRoomsManager();
        cancelAddRoom();
        
        alert('è€ƒåœºæ›´æ–°æˆåŠŸ');
    } catch (error) {
        console.error('æ›´æ–°è€ƒåœºå¤±è´¥:', error);
        alert('æ›´æ–°å¤±è´¥');
    }
}

// åˆ é™¤è€ƒåœº
async function deleteRoom(roomId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè€ƒåœºå—ï¼Ÿ')) {
        return;
    }
    
    const roomIndex = rooms.findIndex(r => r.id === roomId);
    if (roomIndex === -1) return;
    
    const room = rooms[roomIndex];
    
    try {
        // ä»äº‘ç«¯åˆ é™¤
        if (room.objectId) {
            await deleteFromCloud('Room', room.objectId);
        }
        
        // ä»æœ¬åœ°åˆ é™¤
        rooms.splice(roomIndex, 1);
        
        // åˆ·æ–°ç•Œé¢
        refreshRoomSelect();
        loadRoomsManager();
        
        alert('è€ƒåœºåˆ é™¤æˆåŠŸ');
    } catch (error) {
        console.error('åˆ é™¤è€ƒåœºå¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥');
    }
}

/* ---------- ç•Œé¢åˆ·æ–°å‡½æ•° ---------- */

// åˆ·æ–°è¯¾ç¨‹é€‰æ‹©æ¡†
function refreshCourseSelect() {
    const select = document.getElementById('courseSelect');
    select.innerHTML = '<option value="">-- è¯·é€‰æ‹©è¯¾ç¨‹ --</option>';
    
    courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course.id;
        option.textContent = course.name;
        select.appendChild(option);
    });
    
    // ç»‘å®šå˜åŒ–äº‹ä»¶
    select.onchange = onCourseChange;
}

// åˆ·æ–°ç­çº§é€‰æ‹©æ¡†
function refreshClassSelect() {
    const select1 = document.getElementById('classSelect1');
    const select2 = document.getElementById('classSelect2');
    
    // æ¸…ç©ºé€‰æ‹©æ¡†
    select1.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç¬¬ä¸€ä¸ªç­çº§ --</option>';
    select2.innerHTML = '<option value="">-- ç¬¬äºŒä¸ªç­çº§ï¼ˆå¯é€‰ï¼‰ --</option>';
    
    // æ·»åŠ ç­çº§é€‰é¡¹
    studentClasses.forEach(cls => {
        const option1 = document.createElement('option');
        option1.value = cls.id;
        option1.textContent = cls.name;
        select1.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = cls.id;
        option2.textContent = cls.name;
        select2.appendChild(option2);
    });
    
    // ç»‘å®šå˜åŒ–äº‹ä»¶
    select1.onchange = onClassChange;
    select2.onchange = onClassChange;
}

// åˆ·æ–°è€ƒåœºé€‰æ‹©æ¡†
function refreshRoomSelect() {
    const select = document.getElementById('roomSelect');
    select.innerHTML = '<option value="">-- è¯·é€‰æ‹©è€ƒåœº --</option>';
    
    rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.id;
        option.textContent = `${room.name} (${room.rows}Ã—${room.cols})`;
        select.appendChild(option);
    });
    
    // ç»‘å®šå˜åŒ–äº‹ä»¶
    select.onchange = onRoomChange;
}

/* ---------- äº‹ä»¶å¤„ç†å‡½æ•° ---------- */

// è¯¾ç¨‹é€‰æ‹©å˜åŒ–
function onCourseChange() {
    const courseId = document.getElementById('courseSelect').value;
    const course = courses.find(c => c.id === courseId);
    
    if (course) {
        // æ˜¾ç¤ºå®æ—¶è€ƒè¯•ä¿¡æ¯é¢æ¿
        document.getElementById('examTimePanel').classList.remove('hidden');
        
        // è§£æè€ƒè¯•æ—¶é—´
        if (course.time) {
            const timeMatch = course.time.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2})-(\d{2}:\d{2})/);
            if (timeMatch) {
                const startTime = new Date(timeMatch[1]);
                const endTimeStr = timeMatch[2];
                const [endHour, endMinute] = endTimeStr.split(':');
                const endTime = new Date(startTime);
                endTime.setHours(parseInt(endHour), parseInt(endMinute));
                
                // å¼€å§‹å€’è®¡æ—¶
                startExamCountdown(startTime, endTime, course);
            }
        }
    } else {
        // éšè—å®æ—¶è€ƒè¯•ä¿¡æ¯é¢æ¿
        document.getElementById('examTimePanel').classList.add('hidden');
        stopExamCountdown();
    }
}

// ç­çº§é€‰æ‹©å˜åŒ–
function onClassChange() {
    const classId1 = document.getElementById('classSelect1').value;
    const classId2 = document.getElementById('classSelect2').value;
    
    // æ›´æ–°ç­çº§1å­¦ç”Ÿæ•°æ®
    if (classId1) {
        const class1 = studentClasses.find(c => c.id === classId1);
        currentStudents1 = class1 ? class1.students : [];
        document.getElementById('studentCount1').textContent = currentStudents1.length;
    } else {
        currentStudents1 = [];
        document.getElementById('studentCount1').textContent = '0';
    }
    
    // æ›´æ–°ç­çº§2å­¦ç”Ÿæ•°æ®
    if (classId2) {
        const class2 = studentClasses.find(c => c.id === classId2);
        currentStudents2 = class2 ? class2.students : [];
        document.getElementById('studentCount2').textContent = currentStudents2.length;
    } else {
        currentStudents2 = [];
        document.getElementById('studentCount2').textContent = '0';
    }
    
    // æ›´æ–°æ€»äººæ•°
    const totalCount = currentStudents1.length + currentStudents2.length;
    document.getElementById('totalStudentCount').textContent = totalCount;
    
    // æ˜¾ç¤º/éšè—æ··åˆé€‰é¡¹
    const mixingOptions = document.getElementById('mixingOptions');
    if (currentStudents1.length > 0 && currentStudents2.length > 0) {
        mixingOptions.classList.remove('hidden');
    } else {
        mixingOptions.classList.add('hidden');
    }
}

// è€ƒåœºé€‰æ‹©å˜åŒ–
function onRoomChange() {
    const roomId = document.getElementById('roomSelect').value;
    const room = rooms.find(r => r.id === roomId);
    
    if (room) {
        document.getElementById('rowInput').value = room.rows;
        document.getElementById('colInput').value = room.cols;
    } else {
        document.getElementById('rowInput').value = '';
        document.getElementById('colInput').value = '';
    }
}

// æ¸…ç©ºç­çº§é€‰æ‹©
function clearClasses() {
    document.getElementById('classSelect1').value = '';
    document.getElementById('classSelect2').value = '';
    onClassChange();
}

/* ---------- è¯­éŸ³åŠŸèƒ½ ---------- */

// åŠ è½½å¯ç”¨è¯­éŸ³
function loadVoices() {
    if ('speechSynthesis' in window) {
        // ç­‰å¾…è¯­éŸ³åŠ è½½å®Œæˆ
        const loadVoicesTimer = setInterval(() => {
            availableVoices = speechSynthesis.getVoices();
            if (availableVoices.length > 0) {
                clearInterval(loadVoicesTimer);
                populateVoiceSelect();
            }
        }, 100);
        
        // ç›‘å¬è¯­éŸ³å˜åŒ–äº‹ä»¶
        speechSynthesis.onvoiceschanged = () => {
            availableVoices = speechSynthesis.getVoices();
            populateVoiceSelect();
        };
    }
}

// å¡«å……è¯­éŸ³é€‰æ‹©æ¡†
function populateVoiceSelect() {
    const voiceSelect = document.getElementById('voiceSelect');
    voiceSelect.innerHTML = '<option value="">é€‰æ‹©è¯­éŸ³...</option>';
    
    // ä¼˜å…ˆæ˜¾ç¤ºä¸­æ–‡è¯­éŸ³
    const chineseVoices = availableVoices.filter(voice => 
        voice.lang.includes('zh') || voice.lang.includes('CN')
    );
    
    const otherVoices = availableVoices.filter(voice => 
        !voice.lang.includes('zh') && !voice.lang.includes('CN')
    );
    
    // æ·»åŠ ä¸­æ–‡è¯­éŸ³
    if (chineseVoices.length > 0) {
        const chineseGroup = document.createElement('optgroup');
        chineseGroup.label = 'ä¸­æ–‡è¯­éŸ³';
        chineseVoices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.value = availableVoices.indexOf(voice);
            option.textContent = `${voice.name} (${voice.lang})`;
            if (voice.default) option.textContent += ' [é»˜è®¤]';
            chineseGroup.appendChild(option);
        });
        voiceSelect.appendChild(chineseGroup);
        
        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªä¸­æ–‡è¯­éŸ³
        if (!selectedVoice) {
            selectedVoice = chineseVoices[0];
            voiceSelect.value = availableVoices.indexOf(selectedVoice);
        }
    }
    
    // æ·»åŠ å…¶ä»–è¯­éŸ³
    if (otherVoices.length > 0) {
        const otherGroup = document.createElement('optgroup');
        otherGroup.label = 'å…¶ä»–è¯­éŸ³';
        otherVoices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.value = availableVoices.indexOf(voice);
            option.textContent = `${voice.name} (${voice.lang})`;
            if (voice.default) option.textContent += ' [é»˜è®¤]';
            otherGroup.appendChild(option);
        });
        voiceSelect.appendChild(otherGroup);
    }
}

// åˆ‡æ¢è¯­éŸ³å¼€å…³
function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    const button = document.getElementById('voiceToggle');
    const status = document.getElementById('voiceStatus');
    
    if (voiceEnabled) {
        button.textContent = 'ğŸ”Š è¯­éŸ³å¼€å¯';
        button.className = 'w-full px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm';
        status.textContent = 'è¯­éŸ³æç¤ºå·²å¯ç”¨';
    } else {
        button.textContent = 'ğŸ”‡ è¯­éŸ³å…³é—­';
        button.className = 'w-full px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm';
        status.textContent = 'è¯­éŸ³æç¤ºå·²ç¦ç”¨';
    }
}

// æ”¹å˜è¯­éŸ³
function changeVoice() {
    const voiceSelect = document.getElementById('voiceSelect');
    const voiceIndex = parseInt(voiceSelect.value);
    
    if (!isNaN(voiceIndex) && voiceIndex < availableVoices.length) {
        selectedVoice = availableVoices[voiceIndex];
        console.log('é€‰æ‹©è¯­éŸ³:', selectedVoice.name);
    }
}

// æµ‹è¯•è¯­éŸ³
function testVoice() {
    speakText('è¯­éŸ³æµ‹è¯•æˆåŠŸï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸');
}

// è¯­éŸ³æ’­æŠ¥
function speakText(text) {
    if (!voiceEnabled || !('speechSynthesis' in window)) {
        return;
    }
    
    // åœæ­¢å½“å‰è¯­éŸ³
    speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(text);
    
    // è®¾ç½®è¯­éŸ³å‚æ•°
    if (selectedVoice) {
        utterance.voice = selectedVoice;
    }
    utterance.lang = 'zh-CN';
    utterance.rate = 0.9;
    utterance.pitch = 1;
    utterance.volume = 1;
    
    // æ’­æŠ¥
    speechSynthesis.speak(utterance);
}

/* ---------- å®æ—¶æ—¶é’Ÿå’Œå€’è®¡æ—¶ ---------- */

// å¼€å§‹å®æ—¶æ—¶é’Ÿ
function startRealTimeClock() {
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
}

// æ›´æ–°å½“å‰æ—¶é—´
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}

// å¼€å§‹è€ƒè¯•å€’è®¡æ—¶
function startExamCountdown(startTime, endTime, course) {
    stopExamCountdown();
    
    examTimer = setInterval(() => {
        const now = new Date();
        const countdownElement = document.getElementById('countdown');
        const statusElement = document.getElementById('examStatus');
        
        if (now < startTime) {
            // è€ƒè¯•æœªå¼€å§‹
            const timeLeft = startTime - now;
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            countdownElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            countdownElement.className = 'text-2xl font-mono text-blue-600';
            statusElement.textContent = 'è·ç¦»è€ƒè¯•å¼€å§‹';
            
        } else if (now >= startTime && now <= endTime) {
            // è€ƒè¯•è¿›è¡Œä¸­
            const timeLeft = endTime - now;
            const minutes = Math.floor(timeLeft / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // æ ¹æ®å‰©ä½™æ—¶é—´æ”¹å˜é¢œè‰²
            if (minutes <= 5) {
                countdownElement.className = 'text-2xl font-mono text-red-600 animate-pulse';
            } else if (minutes <= 10) {
                countdownElement.className = 'text-2xl font-mono text-orange-600';
            } else {
                countdownElement.className = 'text-2xl font-mono text-green-600';
            }
            
            statusElement.textContent = 'è€ƒè¯•å‰©ä½™æ—¶é—´';
            
            // è¯­éŸ³æé†’
            if (voiceAlerts.includes(minutes) && !alertedTimes.has(minutes)) {
                alertedTimes.add(minutes);
                speakText(`è·ç¦»è€ƒè¯•ç»“æŸè¿˜æœ‰${minutes}åˆ†é’Ÿ`);
            }
            
        } else {
            // è€ƒè¯•ç»“æŸ
            countdownElement.textContent = '00:00';
            countdownElement.className = 'text-2xl font-mono text-red-600';
            statusElement.textContent = 'è€ƒè¯•å·²ç»“æŸ';
            
            if (!alertedTimes.has('end')) {
                alertedTimes.add('end');
                speakText('è€ƒè¯•æ—¶é—´åˆ°ï¼Œè¯·åœæ­¢ç­”é¢˜');
            }
        }
    }, 1000);
}

// åœæ­¢è€ƒè¯•å€’è®¡æ—¶
function stopExamCountdown() {
    if (examTimer) {
        clearInterval(examTimer);
        examTimer = null;
    }
    alertedTimes.clear();
}

/* ---------- åº§ä½å®‰æ’æ ¸å¿ƒåŠŸèƒ½ ---------- */

// ç”Ÿæˆåº§ä½è¡¨
function generateSeating() {
    // éªŒè¯è¾“å…¥
    const courseId = document.getElementById('courseSelect').value;
    const roomId = document.getElementById('roomSelect').value;
    const rows = parseInt(document.getElementById('rowInput').value);
    const cols = parseInt(document.getElementById('colInput').value);
    
    if (!courseId) {
        alert('è¯·é€‰æ‹©è€ƒè¯•è¯¾ç¨‹');
        return;
    }
    
    if (!roomId) {
        alert('è¯·é€‰æ‹©è€ƒåœº');
        return;
    }
    
    if (!rows || !cols || rows < 1 || cols < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è¡Œæ•°å’Œåˆ—æ•°');
        return;
    }
    
    const totalStudents = currentStudents1.length + currentStudents2.length;
    const totalSeats = rows * cols;
    
    if (totalStudents === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­çº§');
        return;
    }
    
    if (totalStudents > totalSeats) {
        alert(`å­¦ç”Ÿæ€»æ•°(${totalStudents})è¶…è¿‡åº§ä½æ•°(${totalSeats})ï¼Œè¯·è°ƒæ•´è€ƒåœºæˆ–ç­çº§`);
        return;
    }
    
    // ç”Ÿæˆåº§ä½å®‰æ’
    const allStudents = combineStudents();
    const seatingArrangement = arrangeSeats(allStudents, rows, cols);
    
    // æ˜¾ç¤ºåº§ä½è¡¨
    displaySeatingChart(seatingArrangement, rows, cols);
    
    // æ˜¾ç¤ºè€ƒè¯•ä¿¡æ¯
    displayExamInfo(courseId, roomId, totalStudents, totalSeats);
    
    // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
    document.getElementById('exportButtons').classList.remove('hidden');
    
    // ä¿å­˜å½“å‰åº§ä½å®‰æ’
    currentSeating = {
        course: courses.find(c => c.id === courseId),
        room: rooms.find(r => r.id === roomId),
        arrangement: seatingArrangement,
        rows: rows,
        cols: cols,
        students: allStudents
    };
}

// åˆå¹¶å­¦ç”Ÿæ•°æ®
function combineStudents() {
    let allStudents = [];
    
    if (currentStudents2.length === 0) {
        // åªæœ‰ä¸€ä¸ªç­çº§
        allStudents = [...currentStudents1];
        shuffleArray(allStudents); // å•ç­çº§ä¹Ÿéšæœºæ’åˆ—
    } else {
        // ä¸¤ä¸ªç­çº§æ··åˆ
        const mixMode = document.querySelector('input[name="mixMode"]:checked').value;
        
        switch (mixMode) {
            case 'random':
                // éšæœºæ··åˆ
                allStudents = [...currentStudents1, ...currentStudents2];
                shuffleArray(allStudents);
                break;
                
            case 'alternate':
                // äº¤æ›¿æ’åˆ— - å…ˆéšæœºæ‰“ä¹±å„è‡ªç­çº§ï¼Œå†äº¤æ›¿
                const shuffledClass1 = [...currentStudents1];
                const shuffledClass2 = [...currentStudents2];
                shuffleArray(shuffledClass1);
                shuffleArray(shuffledClass2);
                
                const maxLength = Math.max(shuffledClass1.length, shuffledClass2.length);
                for (let i = 0; i < maxLength; i++) {
                    if (i < shuffledClass1.length) {
                        allStudents.push({ ...shuffledClass1[i], className: 'ç­çº§1' });
                    }
                    if (i < shuffledClass2.length) {
                        allStudents.push({ ...shuffledClass2[i], className: 'ç­çº§2' });
                    }
                }
                break;
                
            case 'separate':
                // åˆ†åŒºæ’åˆ— - å„ç­çº§å†…éƒ¨éšæœºï¼Œä½†ä¿æŒåˆ†åŒº
                const shuffledClass1Separate = [...currentStudents1];
                const shuffledClass2Separate = [...currentStudents2];
                shuffleArray(shuffledClass1Separate);
                shuffleArray(shuffledClass2Separate);
                
                allStudents = [
                    ...shuffledClass1Separate.map(s => ({ ...s, className: 'ç­çº§1' })),
                    ...shuffledClass2Separate.map(s => ({ ...s, className: 'ç­çº§2' }))
                ];
                break;
        }
    }
    
    return allStudents;
}

// æ‰“ä¹±æ•°ç»„
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// å®‰æ’åº§ä½
function arrangeSeats(students, rows, cols) {
    const arrangement = [];
    
    // åˆå§‹åŒ–åº§ä½è¡¨
    for (let i = 0; i < rows; i++) {
        arrangement[i] = [];
        for (let j = 0; j < cols; j++) {
            arrangement[i][j] = null;
        }
    }
    
    const mixMode = document.querySelector('input[name="mixMode"]:checked').value;
    
    if (mixMode === 'separate' && currentStudents1.length > 0 && currentStudents2.length > 0) {
        // å·¦å³åˆ†åŒºæ’åˆ—ï¼šå·¦è¾¹æ”¾ç­çº§1ï¼Œå³è¾¹æ”¾ç­çº§2
        const class1Students = students.filter(s => s.className === 'ç­çº§1');
        const class2Students = students.filter(s => s.className === 'ç­çº§2');
        
        const midCol = Math.ceil(cols / 2);
        let class1Index = 0;
        let class2Index = 0;
        
        // å¡«å……åº§ä½
        for (let i = 0; i < rows; i++) {
            // å·¦åŠéƒ¨åˆ†æ”¾ç­çº§1
            for (let j = 0; j < midCol && class1Index < class1Students.length; j++) {
                arrangement[i][j] = {
                    ...class1Students[class1Index],
                    row: i + 1,
                    col: j + 1,
                    seatNumber: i * cols + j + 1
                };
                class1Index++;
            }
            
            // å³åŠéƒ¨åˆ†æ”¾ç­çº§2
            for (let j = midCol; j < cols && class2Index < class2Students.length; j++) {
                arrangement[i][j] = {
                    ...class2Students[class2Index],
                    row: i + 1,
                    col: j + 1,
                    seatNumber: i * cols + j + 1
                };
                class2Index++;
            }
        }
        
        // å¦‚æœè¿˜æœ‰å­¦ç”Ÿæ²¡å®‰æ’ï¼Œç»§ç»­å¡«å……ç©ºä½
        const remainingStudents = [
            ...class1Students.slice(class1Index),
            ...class2Students.slice(class2Index)
        ];
        
        let remainingIndex = 0;
        for (let i = 0; i < rows && remainingIndex < remainingStudents.length; i++) {
            for (let j = 0; j < cols && remainingIndex < remainingStudents.length; j++) {
                if (arrangement[i][j] === null) {
                    arrangement[i][j] = {
                        ...remainingStudents[remainingIndex],
                        row: i + 1,
                        col: j + 1,
                        seatNumber: i * cols + j + 1
                    };
                    remainingIndex++;
                }
            }
        }
    } else {
        // æ™®é€šæ’åˆ—æ–¹å¼ï¼ˆéšæœºæ··åˆå’Œäº¤æ›¿æ’åˆ—ï¼‰
        let studentIndex = 0;
        for (let i = 0; i < rows && studentIndex < students.length; i++) {
            for (let j = 0; j < cols && studentIndex < students.length; j++) {
                arrangement[i][j] = {
                    ...students[studentIndex],
                    row: i + 1,
                    col: j + 1,
                    seatNumber: i * cols + j + 1
                };
                studentIndex++;
            }
        }
    }
    
    return arrangement;
}


// æ˜¾ç¤ºåº§ä½è¡¨
function displaySeatingChart(arrangement, rows, cols) {
    const container = document.getElementById('seatingChart');
    const showMode = document.querySelector('input[name="showMode"]:checked').value;
    
    let html = '<div class="seating-container">';
    
    // è®²å°
    html += '<div class="mb-4 text-center"><div class="bg-gray-800 text-white py-2 px-8 rounded-lg inline-block font-semibold">è®²å°</div></div>';
    
    // åº§ä½è¡¨
    html += '<div class="grid gap-2" style="grid-template-columns: repeat(' + cols + ', 1fr);">';
    
    for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
            const seat = arrangement[i][j];
            
            if (seat) {
                let displayText = '';
                let bgColor = 'bg-blue-100 border-blue-300';
                let textColor = 'text-blue-800';
                
                // æ ¹æ®æ˜¾ç¤ºæ¨¡å¼è®¾ç½®æ–‡æœ¬
                switch (showMode) {
                    case 'last3':
                        displayText = seat.id.slice(-3);
                        break;
                    case 'last5':
                        displayText = seat.id.slice(-5);
                        break;
                    case 'name':
                        displayText = seat.name;
                        break;
                    case 'seq':
                        displayText = seat.seatNumber;
                        break;
                }
                
                // æ ¹æ®ç­çº§è®¾ç½®é¢œè‰²
                if (seat.className === 'ç­çº§1') {
                    bgColor = 'bg-blue-100 border-blue-300';
                    textColor = 'text-blue-800';
                } else if (seat.className === 'ç­çº§2') {
                    bgColor = 'bg-purple-100 border-purple-300';
                    textColor = 'text-purple-800';
                }
                
                html += `<div class="seat ${bgColor} ${textColor} border-2 rounded-lg p-3 text-center font-medium text-sm min-h-16 flex items-center justify-center hover:shadow-md transition-shadow cursor-pointer" 
                         title="åº§ä½${seat.seatNumber}: ${seat.name} (${seat.id})">
                         ${displayText}
                         </div>`;
            } else {
                html += '<div class="seat bg-gray-100 border-2 border-gray-300 rounded-lg p-3 text-center text-gray-400 min-h-16 flex items-center justify-center">ç©º</div>';
            }
        }
    }
    
    html += '</div></div>';
    
    container.innerHTML = html;
}

// æ˜¾ç¤ºè€ƒè¯•ä¿¡æ¯
function displayExamInfo(courseId, roomId, totalStudents, totalSeats) {
    const course = courses.find(c => c.id === courseId);
    const room = rooms.find(r => r.id === roomId);
    
    const infoContainer = document.getElementById('examInfo');
    infoContainer.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h3 class="font-semibold text-gray-800 mb-2">è€ƒè¯•ä¿¡æ¯</h3>
                <p><span class="font-medium">è¯¾ç¨‹ï¼š</span>${course.name}</p>
                <p><span class="font-medium">æ—¶é—´ï¼š</span>${course.time}</p>
                <p><span class="font-medium">æ—¶é•¿ï¼š</span>${course.duration}</p>
            </div>
            <div>
                <h3 class="font-semibold text-gray-800 mb-2">è€ƒåœºä¿¡æ¯</h3>
                <p><span class="font-medium">è€ƒåœºï¼š</span>${room.name}</p>
                <p><span class="font-medium">å¸ƒå±€ï¼š</span>${room.rows}è¡Œ Ã— ${room.cols}åˆ—</p>
                <p><span class="font-medium">äººæ•°ï¼š</span>${totalStudents}/${totalSeats}</p>
            </div>
        </div>
    `;
}

/* ---------- å¯¼å‡ºå’Œæ‰“å°åŠŸèƒ½ ---------- */

// å¯¼å‡ºåˆ°Excel
function exportToExcel() {
    if (!currentSeating) {
        alert('è¯·å…ˆç”Ÿæˆåº§ä½è¡¨');
        return;
    }
    
    // åˆ›å»ºå·¥ä½œç°¿
    const wb = {
        SheetNames: ['åº§ä½è¡¨'],
        Sheets: {}
    };
    
    // åˆ›å»ºåº§ä½è¡¨æ•°æ®
    const wsData = [];
    
    // æ·»åŠ æ ‡é¢˜
    wsData.push([`${currentSeating.course.name} - ${currentSeating.room.name}`]);
    wsData.push([`è€ƒè¯•æ—¶é—´ï¼š${currentSeating.course.time}`]);
    wsData.push([`è€ƒè¯•æ—¶é•¿ï¼š${currentSeating.course.duration}`]);
    wsData.push([]);
    
    // æ·»åŠ åº§ä½è¡¨
    wsData.push(['åº§ä½å·', 'å­¦å·', 'å§“å', 'è¡Œ', 'åˆ—']);
    
    currentSeating.students.forEach((student, index) => {
        if (student) {
            const seatInfo = currentSeating.arrangement.flat().find(seat => seat && seat.id === student.id);
            if (seatInfo) {
                wsData.push([
                    seatInfo.seatNumber,
                    seatInfo.id,
                    seatInfo.name,
                    seatInfo.row,
                    seatInfo.col
                ]);
            }
        }
    });
    
    // åˆ›å»ºå·¥ä½œè¡¨
    wb.Sheets['åº§ä½è¡¨'] = XLSX.utils.aoa_to_sheet(wsData);
    
    // å¯¼å‡ºæ–‡ä»¶
    const filename = `${currentSeating.course.name}_${currentSeating.room.id}_åº§ä½è¡¨.xlsx`;
    
    try {
        XLSX.writeFile(wb, filename);
        alert('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
    } catch (error) {
        console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
        
        // å¦‚æœXLSXåº“æœªåŠ è½½ï¼Œä½¿ç”¨CSVæ ¼å¼å¯¼å‡º
        exportToCSV();
    }
}

// å¯¼å‡ºåˆ°CSV
function exportToCSV() {
    if (!currentSeating) {
        alert('è¯·å…ˆç”Ÿæˆåº§ä½è¡¨');
        return;
    }
    
    let csvContent = '';
    
    // æ·»åŠ æ ‡é¢˜ä¿¡æ¯
    csvContent += `${currentSeating.course.name} - ${currentSeating.room.name}\n`;
    csvContent += `è€ƒè¯•æ—¶é—´ï¼š${currentSeating.course.time}\n`;
    csvContent += `è€ƒè¯•æ—¶é•¿ï¼š${currentSeating.course.duration}\n\n`;
    
    // æ·»åŠ è¡¨å¤´
    csvContent += 'åº§ä½å·,å­¦å·,å§“å,è¡Œ,åˆ—\n';
    
    // æ·»åŠ å­¦ç”Ÿæ•°æ®
    currentSeating.students.forEach(student => {
        if (student) {
            const seatInfo = currentSeating.arrangement.flat().find(seat => seat && seat.id === student.id);
            if (seatInfo) {
                csvContent += `${seatInfo.seatNumber},${seatInfo.id},${seatInfo.name},${seatInfo.row},${seatInfo.col}\n`;
            }
        }
    });
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${currentSeating.course.name}_${currentSeating.room.id}_åº§ä½è¡¨.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('CSVæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
    } else {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶ä¸‹è½½åŠŸèƒ½');
    }
}

// æ‰“å°åº§ä½è¡¨
function printSeating() {
    if (!currentSeating) {
        alert('è¯·å…ˆç”Ÿæˆåº§ä½è¡¨');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    const showMode = document.querySelector('input[name="showMode"]:checked').value;
    
    let printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>åº§ä½è¡¨ - ${currentSeating.course.name}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .info { margin-bottom: 20px; }
                .seating-grid { 
                    display: grid; 
                    grid-template-columns: repeat(${currentSeating.cols}, 1fr); 
                    gap: 5px; 
                    max-width: 800px; 
                    margin: 0 auto; 
                }
                .seat { 
                    border: 2px solid #ccc; 
                    padding: 10px; 
                    text-align: center; 
                    font-weight: bold; 
                    min-height: 40px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 12px;
                }
                .seat.occupied { background-color: #e3f2fd; border-color: #2196f3; }
                .seat.empty { background-color: #f5f5f5; color: #999; }
                .podium { 
                    text-align: center; 
                    background-color: #333; 
                    color: white; 
                    padding: 10px; 
                    margin-bottom: 20px; 
                    font-weight: bold; 
                }
                @media print {
                    body { margin: 0; }
                    .seating-grid { max-width: 100%; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${currentSeating.course.name}</h1>
                <h2>${currentSeating.room.name}</h2>
            </div>
            
            <div class="info">
                <p><strong>è€ƒè¯•æ—¶é—´ï¼š</strong>${currentSeating.course.time}</p>
                <p><strong>è€ƒè¯•æ—¶é•¿ï¼š</strong>${currentSeating.course.duration}</p>
                <p><strong>è€ƒåœºå¸ƒå±€ï¼š</strong>${currentSeating.rows}è¡Œ Ã— ${currentSeating.cols}åˆ—</p>
                <p><strong>å‚è€ƒäººæ•°ï¼š</strong>${currentSeating.students.length}äºº</p>
            </div>
            
            <div class="podium">è®²å°</div>
            
            <div class="seating-grid">
    `;
    
    // ç”Ÿæˆåº§ä½è¡¨
    for (let i = 0; i < currentSeating.rows; i++) {
        for (let j = 0; j < currentSeating.cols; j++) {
            const seat = currentSeating.arrangement[i][j];
            
            if (seat) {
                let displayText = '';
                switch (showMode) {
                    case 'last3':
                        displayText = seat.id.slice(-3);
                        break;
                    case 'last5':
                        displayText = seat.id.slice(-5);
                        break;
                    case 'name':
                        displayText = seat.name;
                        break;
                    case 'seq':
                        displayText = seat.seatNumber;
                        break;
                }
                
                printContent += `<div class="seat occupied" title="${seat.name} (${seat.id})">${displayText}</div>`;
            } else {
                printContent += '<div class="seat empty">ç©º</div>';
            }
        }
    }
    
    printContent += `
            </div>
            
            <div style="margin-top: 30px; font-size: 12px; color: #666;">
                <p>ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</p>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // ç­‰å¾…å†…å®¹åŠ è½½å®Œæˆåæ‰“å°
    printWindow.onload = function() {
        printWindow.print();
    };
}

/* ---------- CSSæ ·å¼ ---------- */

// æ·»åŠ è‡ªå®šä¹‰æ ·å¼
const style = document.createElement('style');
style.textContent = `
    .tab-button {
        padding: 0.5rem 1rem;
        border-bottom: 2px solid transparent;
        font-medium: 500;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tab-button:hover {
        color: #374151;
        border-bottom-color: #d1d5db;
    }
    
    .tab-button.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
    }
    
    .seating-container {
        padding: 20px;
        background: #f9fafb;
        border-radius: 8px;
    }
    
    .seat:hover {
        transform: translateY(-1px);
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .animate-pulse {
        animation: pulse 1s infinite;
    }
`;
document.head.appendChild(style);

/* ---------- åˆå§‹åŒ– ---------- */

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    init();
});

// ä¸ºäº†å…¼å®¹æ²¡æœ‰XLSXåº“çš„æƒ…å†µï¼Œå°è¯•åŠ è½½Excelå¯¼å‡ºåº“
function loadXLSXLibrary() {
    if (typeof XLSX === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = function() {
            console.log('XLSXåº“åŠ è½½æˆåŠŸ');
        };
        script.onerror = function() {
            console.log('XLSXåº“åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨CSVå¯¼å‡º');
        };
        document.head.appendChild(script);
    }
}

// åŠ è½½Excelåº“
loadXLSXLibrary();

</script>
</body>
</html>